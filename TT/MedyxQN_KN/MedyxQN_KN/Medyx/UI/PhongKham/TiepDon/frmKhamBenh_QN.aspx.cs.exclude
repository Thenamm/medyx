using System;
using System.Collections.Generic;
using System.Configuration;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using HTC.Business.CategoryList;
using HTC.Business.PhongKham;
using HTC.Business.NoiTru;
using HTC.Common.Web;
using Telerik.Web.UI;
using CrystalDecisions.CrystalReports.Engine;
using System.Data;
using iTextSharp.text.pdf;
using iTextSharp.text;
using System.IO;
using System.Data.SqlClient;
using System.Web.Script.Serialization;
using System.Text.RegularExpressions;
using System.Net;
using System.Globalization;
using System.Text;
using Microsoft.ApplicationBlocks.Data;
using System.Activities.Statements;
using Newtonsoft.Json;
using DonThuocDT;

public partial class UI_PhongKham_KhamBenh_frmKhamBenh_QN : WebBase
{
    #region PAGE PARAM REQUEST
    private const string ViewState_PACSPOST = "PACSPOST";
    public DataTable _PACSPOST
    {
        get
        {
            if (ViewState[ViewState_PACSPOST] == null)
            {
                ViewState[ViewState_PACSPOST] = GetPort1("PostOrder");
            }
            return (DataTable)ViewState[ViewState_PACSPOST];
        }
        set
        {
            ViewState[ViewState_PACSPOST] = value;
        }
    }

    private const string ViewState_MaBN = "MaBN";


    private const string ViewState_NoiTT = "NoiTT";

    public string _NoiTT
    {
        get
        {
            return (string)ViewState[ViewState_NoiTT];
        }

        set
        {
            ViewState[ViewState_NoiTT] = value;
        }

    }
    private const string ViewState_MaDT = "MaDT";

    public string _MaDT
    {
        get
        {
            return (string)_ThongtinBN.KhamBenh.MaDT;
        }

        //set
        //{
        //    ViewState[ViewState_MaDT] = value;
        //}

    }

    private const string ViewState_MaKhoa = "MaKhoa";

    public string _MaKhoa
    {
        get
        {
            if (ViewState[ViewState_MaKhoa] == null)
                ViewState[ViewState_MaKhoa] = "";

            return (string)ViewState[ViewState_MaKhoa];
        }

        set
        {
            ViewState[ViewState_MaKhoa] = value;
        }

    }
    public string _MaBN
    {
        get
        {
            if (ViewState[ViewState_MaBN] == null)
                ViewState[ViewState_MaBN] = "";
            return (string)ViewState[ViewState_MaBN];
        }

        set
        {
            ViewState[ViewState_MaBN] = value;
        }

    }
    private const string ViewState_NgayDK = "NgayDK";

    public string _NgayDK
    {
        get
        {
            return (string)ViewState[ViewState_NgayDK];
        }

        set
        {
            ViewState[ViewState_NgayDK] = value;
        }

    }
    private const string ViewState_MaSoKham = "MaSoKham";

    public string _MaSoKham
    {
        get
        {
            if (ViewState[ViewState_MaSoKham] == null)
                ViewState[ViewState_MaSoKham] = "";

            return (string)ViewState[ViewState_MaSoKham];
        }

        set
        {
            ViewState[ViewState_MaSoKham] = value;
        }

    }
    private const string ViewState_STT = "STT";

    public int _STT
    {
        get
        {
            if (ViewState[ViewState_STT] == null)
                ViewState[ViewState_STT] = 1;
            return (int)ViewState[ViewState_STT];
        }

        set
        {
            ViewState[ViewState_STT] = value;
        }

    }
    private const string ViewState_LoaiKQCN = "LoaiKQCN";

    public byte _LoaiKQCN
    {
        get
        {
            if (ViewState[ViewState_LoaiKQCN] == null)
            {
                if (Request["LoaiKQCN"] == null)
                    Response.Redirect("~/Default.aspx");
                else
                    ViewState[ViewState_LoaiKQCN] = Convert.ToByte(Request["LoaiKQCN"].ToString());
            }

            return (byte)ViewState[ViewState_LoaiKQCN];
        }

        set
        {
            ViewState[ViewState_LoaiKQCN] = value;
        }

    }

    private const string viewState_LoaiPhieu = "LoaiPhieu";
    public byte _LoaiPhieu
    {
        get
        {
            if (ViewState[viewState_LoaiPhieu] == null)
                if (Request["LoaiPhieu"] == null)
                    Response.Redirect("~/Default.aspx");
                else
                    ViewState[viewState_LoaiPhieu] = byte.Parse(Request["LoaiPhieu"].ToString());
            return (byte)ViewState[viewState_LoaiPhieu];
        }

        set
        {
            ViewState[viewState_LoaiPhieu] = value;
        }
    }
    private const string viewState_CapCuu = "CapCuu";
    public bool _CapCuu
    {
        get
        {

            return false;
        }

        set
        {
            ViewState[viewState_CapCuu] = value;
        }
    }
    #endregion
    private const string ViewState_PubsMaDV = "PubsMaDV";

    public string _PubsMaDV
    {
        get
        {
            if (ViewState[ViewState_PubsMaDV] == null)
                ViewState[ViewState_PubsMaDV] = "";

            return (string)ViewState[ViewState_PubsMaDV];
        }

        set
        {
            ViewState[ViewState_PubsMaDV] = value;
        }

    }
    private const string ViewState_ThongtinBN = "ThongtinBN";
    public ThongtinBN _ThongtinBN
    {
        get
        {
            return (ThongtinBN)ViewState[ViewState_ThongtinBN];
        }

        set
        {
            ViewState[ViewState_ThongtinBN] = value;
        }
    }
    private const string ViewState_KhamBenh_Noi = "KhamBenh_Noi";
    private const string ViewState_PhacDoDT = "PhacDoDT";
    public PhacDoDT _PhacDoDT
    {
        get
        {

            return (PhacDoDT)ViewState[ViewState_PhacDoDT];
        }

        set
        {
            ViewState[ViewState_PhacDoDT] = value;
        }
    }

    public KhamBenh_Noi _KhamBenh_Noi
    {
        get
        {

            return (KhamBenh_Noi)ViewState[ViewState_KhamBenh_Noi];
        }

        set
        {
            ViewState[ViewState_KhamBenh_Noi] = value;
        }
    }
    private const string ViewState_KhamBenh_KeNgoaiList = "KhamBenh_KeNgoaiList";
    public KhamBenh_KeNgoaiList _KhamBenh_KeNgoaiList
    {
        get
        {

            return (KhamBenh_KeNgoaiList)ViewState[ViewState_KhamBenh_KeNgoaiList];
        }

        set
        {
            ViewState[ViewState_KhamBenh_KeNgoaiList] = value;
        }
    }
    //private const string ViewState_KhamBenh_KB = "KhamBenh_KB";
    //public KhamBenh_C _KhamBenh_KB
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_KhamBenh_KB] == null)
    //        {
    //            if (_MaBN == "")
    //            {


    //                if ( _ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0)
    //                    ViewState[ViewState_KhamBenh_KB] = KhamBenh_C.NewKhamBenh_C();

    //            }
    //            else
    //                ViewState[ViewState_KhamBenh_KB] =  _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(X => X.STT == _STT);
    //        }
    //        return (KhamBenh_C)ViewState[ViewState_KhamBenh_KB];
    //    }

    //    set
    //    {
    //        ViewState[ViewState_KhamBenh_KB] = value;
    //    }
    //}
    //private const string ViewState_KhamBenh_XN_GetsList = "KhamBenh_XN_GetsList";
    //public KhamBenh_XN_GetsList  _ThongtinBN.KhamBenh.KhamBenh_XN_GetsList;
    //{
    //    get
    //    {
    //        return (KhamBenh_XN_GetsList) _ThongtinBN.KhamBenh.KhamBenh_XN_GetsList;

    //      //  return (KhamBenh_XN_GetsList)ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_XN_GetsList];
    //    }

    //    set
    //    {
    //       // ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_XN_GetsList] = value;
    //    }
    //}

    private const string ViewState_KhamBenh_GETsMABNListInfo = "KhamBenh_GETsMABNListInfo";
    public KhamBenh_GETsMABNListInfo _KhamBenh_GETsMABNListInfo
    {
        get
        {

            return (KhamBenh_GETsMABNListInfo)ViewState[ViewState_KhamBenh_GETsMABNListInfo];
        }

        set
        {
            ViewState[ViewState_KhamBenh_GETsMABNListInfo] = value;
        }
    }

    private const string ViewState_ThongKe_BenhNhan_NgoaiTruListInfo = "ThongKe_BenhNhan_NgoaiTruListInfo";
    public ThongKe_BenhNhan_NgoaiTruListInfo _ThongKe_BenhNhan_NgoaiTruListInfo
    {
        get
        {
            return (ThongKe_BenhNhan_NgoaiTruListInfo)ViewState[ViewState_ThongKe_BenhNhan_NgoaiTruListInfo];
        }

        set
        {
            ViewState[ViewState_ThongKe_BenhNhan_NgoaiTruListInfo] = value;
        }
    }

    //private const string ViewState_KhamBenh_GetsDichVuList = "KhamBenh_GetsDichVuList";
    //public KhamBenh_GetsDichVuList _KhamBenh_GetsDichVuList
    //{
    //    get
    //    {

    //        return (KhamBenh_GetsDichVuList)ViewState[ViewState_KhamBenh_GetsDichVuList];
    //    }

    //    set
    //    {
    //        ViewState[ViewState_KhamBenh_GetsDichVuList] = value;
    //    }
    //}
    #region Khám bệnh Thuốc Sử Dụng

    //private const string ViewState _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList = "KhamBenh_ThuocSDList";
    // public KhamBenh_ThuocSDList  _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList;
    //{
    //    get
    //    {
    //        //if (ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList] == null)
    //        //{
    //        //    LoadDetails_KhamBenh_ThuocSuDung();
    //        //}

    //        return (KhamBenh_ThuocSDList) _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList;
    //    }
    //    set
    //    {
    //    }
    //    //set
    //    //{
    //    //    ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList] = value;
    //    //}

    //}

    //private const string ViewState_KhamBenh_ThuocSD = "KhamBenh_ThuocSD";
    //public KhamBenh_ThuocSD _KhamBenh_ThuocSD
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_KhamBenh_ThuocSD] != null)
    //        {
    //            return (KhamBenh_ThuocSD)ViewState[ViewState_KhamBenh_ThuocSD];
    //        }

    //        return null;
    //    }

    //    set
    //    {
    //        ViewState[ViewState_KhamBenh_ThuocSD] = value;
    //    }

    //}
    #endregion

    #region Khám bệnh Thuốc Thang
    //private const string ViewState _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList = "ViewState _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList";
    //public KhamBenh_ThuocSD_DYList  _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList;
    //{
    //    get
    //    {

    //        return (KhamBenh_ThuocSD_DYList) _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList;
    //        // return (KhamBenh_ThuocSD_DYList)ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList];
    //    }
    //    set
    //    {
    //    }
    //    //set
    //    //{
    //    //    ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList] = value;
    //    //}

    //}

    private const string ViewState_KhamBenh_ThuocSD_DY = "ViewState_KhamBenh_ThuocSD_DY";
    public KhamBenh_ThuocSD_DY _KhamBenh_ThuocSD_DY
    {
        get
        {
            //if (ViewState[ViewState_KhamBenh_ThuocSD_DY] == null)
            //    ViewState[ViewState_KhamBenh_ThuocSD_DY] = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();


            return (KhamBenh_ThuocSD_DY)ViewState[ViewState_KhamBenh_ThuocSD_DY];
        }

        set
        {
            ViewState[ViewState_KhamBenh_ThuocSD_DY] = value;
        }

    }



    #endregion

    //#region Khám bệnh XN.TT.XQ.TDCN

    ////private const string ViewState_KhamBenh_C = "KhamBenh_C";
    ////public KhamBenh_C _KhamBenh_C
    ////{
    ////    get
    ////    {
    ////        if (ViewState[ViewState_KhamBenh_C] == null)
    ////        {
    ////            LoadDetails_KhamBenh_XNTT();
    ////        }

    ////        return (KhamBenh_C)ViewState[ViewState_KhamBenh_C];
    ////    }

    ////    set
    ////    {
    ////        ViewState[ViewState_KhamBenh_C] = value;
    ////    }

    ////}

    //private const string ViewState _ThongtinBN.KhamBenh.KhamBenh_C_List = "ViewState _ThongtinBN.KhamBenh.KhamBenh_C_List";
    //public KhamBenh_C_List  _ThongtinBN.KhamBenh.KhamBenh_C_List;
    ////{
    ////    get
    ////    {
    ////        if (ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_C_List] == null)
    ////        {
    ////            LoadDetails_KhamBenh_XNTT();
    ////        }
    ////        return (KhamBenh_C_List) _ThongtinBN.KhamBenh.KhamBenh_C_List;

    ////        return (KhamBenh_C_List)ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_C_List];
    ////    }
    ////    set
    ////    {
    ////    }
    ////    set
    ////    {
    ////        ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_C_List] = value;
    ////    }

    ////}
    //#endregion

    //#region Khám bệnh VTTH

    //private const string ViewState _ThongtinBN.KhamBenh.KhamBenh_VTTHList = "KhamBenh_VTTHList";
    //public KhamBenh_VTTHList  _ThongtinBN.KhamBenh.KhamBenh_VTTHList;
    ////{
    ////    get
    ////    {
    ////        //if (ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_VTTHList] == null)
    ////        //{
    ////        //    LoadDetails_KhamBenh_VTTH();
    ////        //}
    ////        return (KhamBenh_VTTHList) _ThongtinBN.KhamBenh.KhamBenh_VTTHList;

    ////        //return (KhamBenh_VTTHList)ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_VTTHList];
    ////    }
    ////    set
    ////    {
    ////    }
    ////    //set
    ////    //{
    ////    //    ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_VTTHList] = value;
    ////    //}

    ////}
    //#endregion

    //#region Khám bệnh Hóa Chất

    //private const string ViewState _ThongtinBN.KhamBenh.KhamBenh_HoaChatList = "KhamBenh_HoaChatList";
    //public KhamBenh_HoaChatList  _ThongtinBN.KhamBenh.KhamBenh_HoaChatList;
    ////{
    ////    get
    ////    {
    ////        //if (ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_HoaChatList] == null)
    ////        //{
    ////        //    LoadDetails_KhamBenh_HoaChat();
    ////        //}
    ////        return (KhamBenh_HoaChatList) _ThongtinBN.KhamBenh.KhamBenh_HoaChatList;

    ////        //return (KhamBenh_HoaChatList)ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_HoaChatList];
    ////    }
    ////    set
    ////    {
    ////    }
    ////    //set
    ////    //{
    ////    //    ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_HoaChatList] = value;
    ////    //}

    ////}
    //#endregion

    //#region Khám bệnh Máu

    //private const string ViewState _ThongtinBN.KhamBenh.KhamBenh_MauList = "KhamBenh_MauList";
    //public KhamBenh_MauList  _ThongtinBN.KhamBenh.KhamBenh_MauList;
    ////{
    ////    get
    ////    {
    ////        //if (ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_MauList] == null)
    ////        //{
    ////        //    LoadDetails_KhamBenh_Mau();
    ////        //}
    ////        return (KhamBenh_MauList) _ThongtinBN.KhamBenh.KhamBenh_MauList;

    ////        //  return (KhamBenh_MauList)ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_MauList];
    ////    }
    ////    set
    ////    {
    ////    }
    ////    //set
    ////    //{
    ////    //    ViewState[ViewState _ThongtinBN.KhamBenh.KhamBenh_MauList] = value;
    ////    //}

    ////}
    //#endregion


    #region indextem
    private const string ViewState_MaSoKhamT = "MaSoKhamT";

    public string _MaSoKhamT
    {
        get
        {
            if (ViewState[ViewState_MaSoKhamT] == null)
                ViewState[ViewState_MaSoKhamT] = "";

            return (string)ViewState[ViewState_MaSoKhamT];
        }

        set
        {
            ViewState[ViewState_MaSoKhamT] = value;
        }

    }
    private const string ViewState_STTT = "STTT";

    public int _STTT
    {
        get
        {
            if (ViewState[ViewState_STTT] == null)
                ViewState[ViewState_STTT] = 1;
            return (int)ViewState[ViewState_STTT];
        }

        set
        {
            ViewState[ViewState_STTT] = value;
        }

    }
    #endregion

    //#region index
    //private const string ViewState_ReportData1 = "ReportData1";

    //public DataSet ReportData1
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_ReportData1] != null)
    //        {
    //            return (DataSet)ViewState[ViewState_ReportData1];
    //        }

    //        return null;
    //    }

    //    set
    //    {
    //        ViewState[ViewState_ReportData1] = value;
    //    }
    //}
    //private const string ViewState_ReportData2 = "ReportData2";

    //public DataSet ReportData2
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_ReportData2] != null)
    //        {
    //            return (DataSet)ViewState[ViewState_ReportData2];
    //        }

    //        return null;
    //    }

    //    set
    //    {
    //        ViewState[ViewState_ReportData2] = value;
    //    }
    //}

    //private const string ViewState_ReportData3 = "ReportData3";

    //public DataSet ReportData3
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_ReportData3] != null)
    //        {
    //            return (DataSet)ViewState[ViewState_ReportData3];
    //        }

    //        return null;
    //    }

    //    set
    //    {
    //        ViewState[ViewState_ReportData3] = value;
    //    }
    //}

    //private const string ViewState_ReportData4 = "ReportData4";

    //public DataSet ReportData4
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_ReportData4] != null)
    //        {
    //            return (DataSet)ViewState[ViewState_ReportData4];
    //        }

    //        return null;
    //    }

    //    set
    //    {
    //        ViewState[ViewState_ReportData4] = value;
    //    }
    //}
    //private const string ViewState_ReportData5 = "ReportData5";

    //public DataSet ReportData5
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_ReportData5] != null)
    //        {
    //            return (DataSet)ViewState[ViewState_ReportData5];
    //        }

    //        return null;
    //    }

    //    set
    //    {
    //        ViewState[ViewState_ReportData5] = value;
    //    }
    //}
    //private const string ViewState_ReportData6 = "ReportData6";

    //public DataSet ReportData6
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_ReportData6] != null)
    //        {
    //            return (DataSet)ViewState[ViewState_ReportData6];
    //        }

    //        return null;
    //    }

    //    set
    //    {
    //        ViewState[ViewState_ReportData6] = value;
    //    }
    //}
    //private const string ViewState_ReportData8 = "ReportData8";

    //public DataSet ReportData8
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_ReportData8] != null)
    //        {
    //            return (DataSet)ViewState[ViewState_ReportData8];
    //        }

    //        return null;
    //    }

    //    set
    //    {
    //        ViewState[ViewState_ReportData8] = value;
    //    }
    //}
    //#endregion
    #region 0. thongtinbn
    private void LoadDetails_ThongTin(Boolean _load = true)
    {

        if (_load == true)
        {
            KhamBenh_C _KhamBenh_KB = null;

            if (_ThongtinBN != null)
            {
                txtMaQL.Text = _ThongtinBN.MaBN;
                dtNgaySinh.Text = _ThongtinBN.NgaySinh;
                txtHoTen.Text = _ThongtinBN.Hoten;
                if (_ThongtinBN.GT == true)
                {
                    lblGioitinh.Items[0].Selected = true;
                    lblGioitinh.Items[1].Selected = false;
                }
                else
                {
                    lblGioitinh.Items[1].Selected = true;
                    lblGioitinh.Items[0].Selected = false;
                }

                txtSoThe.Text = _ThongtinBN.Sothe;
                dtBHYTDN.Text = _ThongtinBN.GiaTriDN;
                txtDiaChi.Text = _ThongtinBN.DiaChiC;
                txtDienThoai.Text = _ThongtinBN.DienThoai;
                txtTuoi.Text = _ThongtinBN.Tuoi.ToString();
                txtBenhNGT.Text = _ThongtinBN.KhamBenh.maicdngt + "-" + _ThongtinBN.KhamBenh.tenbenhngt;

                txtNgheNghiep.Text = _ThongtinBN.TenNN;
                txtDoiTuong.Text = _ThongtinBN.TenDT;
                txtTenBVBD.Text = _ThongtinBN.KhamBenh.mabhxh + "-" + _ThongtinBN.KhamBenh.tenbv;

                if (_KhamBenh_KB == null && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                    _KhamBenh_KB = _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(X => X.STT == _STT);



            }

            if (_KhamBenh_KB != null)
            {
                cboHuongDT.SelectedValue = _KhamBenh_KB.MaHuongDT;
                cboKhoaNV.SelectedValue = _KhamBenh_KB.MakhoaVV;
                dtNgayHen.Text = _KhamBenh_KB.ngayhen;
                // cboChuyenKhoa.SelectedValue = _KhamBenh_KB.Machuyenkhoa;
                if (_KhamBenh_KB.BSKham == "")
                {
                    _KhamBenh_KB.BSKham = Pub_sNguoiSD;
                    _KhamBenh_KB.tenbs = Pub_sTenNguoiSD;

                }
                lblngaydk.Text = _KhamBenh_KB.NgayLap;

                if (_KhamBenh_KB.BSKham != "")
                {
                    //RadComboBoxItem selectedItem = new RadComboBoxItem();

                    //selectedItem.Text = _KhamBenh_KB.tenbs;
                    //selectedItem.Value = _KhamBenh_KB.BSKham;
                    //cboNhanVien.Items.Add(selectedItem);
                    //selectedItem.Selected = true;
                    //selectedItem.DataBind();
                    //cboNhanVien.DataBind();
                    cboNhanVien.Text = _KhamBenh_KB.tenbs;
                    cboNhanVien.SelectedValue = _KhamBenh_KB.BSKham;
                    txtMaNV.Text = _KhamBenh_KB.BSKham;
                }
                if (_KhamBenh_KB.maicdKem != "")
                {
                    //RadComboBoxItem selectedItem = new RadComboBoxItem();

                    //selectedItem.Text = _KhamBenh_KB.maicdKem;
                    //selectedItem.Value = _KhamBenh_KB.MabenhKem;
                    //cboChanDoanKem.Items.Add(selectedItem);
                    //selectedItem.Selected = true;
                    //selectedItem.DataBind();
                    //cboChanDoanKem.DataBind();
                    cboChanDoanKem.Text = _KhamBenh_KB.maicdKem;
                    cboChanDoanKem.SelectedValue = _KhamBenh_KB.MabenhKem;
                }
                txtChanDoanKem.Text = _KhamBenh_KB.tenbenhKem;
                //if (_KhamBenh_KB.maicdKem2 != "")
                //{
                //    //RadComboBoxItem selectedItem = new RadComboBoxItem();

                //    //selectedItem.Text = _KhamBenh_KB.maicdKem2;
                //    //selectedItem.Value = _KhamBenh_KB.MabenhKem2;
                //    //cboChanDoanKem2.Items.Add(selectedItem);
                //    //selectedItem.Selected = true;
                //    //selectedItem.DataBind();
                //    //cboChanDoanKem2.DataBind();
                //    cboChanDoanKem2.Text = _KhamBenh_KB.maicdKem2;
                //    cboChanDoanKem2.SelectedValue = _KhamBenh_KB.MabenhKem2;
                //}
                //txtChanDoanKem2.Text = _KhamBenh_KB.tenbenhKem2;
                //if (_KhamBenh_KB.maicdKem3 != "")
                //{
                //    //RadComboBoxItem selectedItem = new RadComboBoxItem();

                //    //selectedItem.Text = _KhamBenh_KB.maicdKem3;
                //    //selectedItem.Value = _KhamBenh_KB.MabenhKem3;
                //    //cboChanDoanKem3.Items.Add(selectedItem);
                //    //selectedItem.Selected = true;
                //    //selectedItem.DataBind();
                //    //cboChanDoanKem3.DataBind();
                //    cboChanDoanKem3.Text = _KhamBenh_KB.maicdKem3;
                //    cboChanDoanKem3.SelectedValue = _KhamBenh_KB.MabenhKem3;
                //}
                //txtChanDoanKem3.Text = _KhamBenh_KB.tenbenhKem3;
                if (_KhamBenh_KB.maicd != "")
                {
                    //RadComboBoxItem selectedItem = new RadComboBoxItem();

                    //selectedItem.Text = _KhamBenh_KB.maicd;
                    //selectedItem.Value = _KhamBenh_KB.Mabenh;
                    //cboChanDoan.Items.Add(selectedItem);
                    //selectedItem.Selected = true;
                    //selectedItem.DataBind();
                    //cboChanDoan.DataBind();
                    cboChanDoan.Text = _KhamBenh_KB.maicd;
                    cboChanDoan.SelectedValue = _KhamBenh_KB.Mabenh;
                }
                txtChanDoan.Text = _KhamBenh_KB.tenbenh;
            }

            _KhamBenh_Noi = KhamBenh_Noi.GetKhamBenh_Noi(_MaSoKham, _STT);
            if (_KhamBenh_Noi.MaSoKham == "")
            {
                _KhamBenh_Noi = KhamBenh_Noi.NewKhamBenh_Noi();
                _KhamBenh_Noi.MaSoKham = _MaSoKham;
                _KhamBenh_Noi.STT = (_STT == 0 ? 1 : _STT);

                _KhamBenh_Noi.MaDV = _KhamBenh_KB.MaDV;
            }

            if (_KhamBenh_Noi != null)
            {
                txtMach.Text = _KhamBenh_Noi.Mach;
                txtHuyetap.Text = _KhamBenh_Noi.ApHuyet;
                txtNhietdo.Text = _KhamBenh_Noi.NhietDo;
                txtNhiptho.Text = _KhamBenh_Noi.NhipTho;
                chkRubella.Checked = _KhamBenh_Noi.Rubella;
                chkUonVan.Checked = _KhamBenh_Noi.UonVan;
                chkTiemChungKhac.Checked = _KhamBenh_Noi.TiemChungKhac;

                txtTiensubenh.Text = _ThongtinBN.TienSu;
                txtDiungthuoc.Text = _ThongtinBN.TienSuThuoc;
                txtTiensugiadinh.Text = _ThongtinBN.TienSuGiaDinh;
                cboNhomMau.SelectedValue = _ThongtinBN.NhomMau;
                txtMach.Text = _KhamBenh_Noi.Mach;
                txtHuyetap.Text = _KhamBenh_Noi.ApHuyet;

                txtNhietdo.Text = _KhamBenh_Noi.NhietDo;
                txtNhiptho.Text = _KhamBenh_Noi.NhipTho;
                txtChieuCao.Text = _KhamBenh_Noi.ChieuCao;
                txtCanNang.Text = _KhamBenh_Noi.CanNang;
                txtLoidan.Text = _KhamBenh_Noi.DieuTri;
                txtbenhly.Text = _KhamBenh_Noi.BenhSu;
                txtlydo.Text = _KhamBenh_Noi.LyDoKham;
                txtToanthan.Text = _KhamBenh_Noi.ToanThan;
                txtHohap.Text = _KhamBenh_Noi.HoHap;
                if (txtCanNang.Text != "" && txtChieuCao.Text != "" && txtChieuCao.Text != "0")
                    txtBMI.Text = (decimal.Parse(txtCanNang.Text) * 10000 / (decimal.Parse(txtChieuCao.Text) * decimal.Parse(txtChieuCao.Text))).ToString("###.##");
                if (txtHuyetap.Text != "")
                {
                    int i = txtHuyetap.Text.LastIndexOf("/");
                    if (i > 0)
                    {
                        txtHuyetapmin.Text = _KhamBenh_Noi.ApHuyet.Substring(0, i);
                        txtHuyetapmax.Text = _KhamBenh_Noi.ApHuyet.Substring(i + 1);
                    }
                }
                txtTieuHoa.Text = _KhamBenh_Noi.TieuHoa;
                txtCoxuongkhop.Text = _KhamBenh_Noi.XuongKhop;
                txtThan.Text = _KhamBenh_Noi.ThanTNieuSDuc;
                txttuanhoan.Text = _KhamBenh_Noi.TuanHoan;
                txtrhm.Text = _KhamBenh_Noi.RangHamMat;
                txttmh.Text = _KhamBenh_Noi.TaiMuiHong;
                txtmat.Text = _KhamBenh_Noi.Mat;
                txtthankinh.Text = _KhamBenh_Noi.ThanKinh;
                txtkhac.Text = _KhamBenh_Noi.BenhLyKhac;
                txtXutri.Text = _KhamBenh_Noi.HuongDT;
                txtnoitiet.Text = _KhamBenh_Noi.Noitiet;
                if (_KhamBenh_Noi.MaBV != "")
                {
                    //RadComboBoxItem selectedItemc = new RadComboBoxItem();

                    //selectedItemc.Text = _KhamBenh_Noi.TenBV;
                    //selectedItemc.Value = _KhamBenh_Noi.MaBV;
                    //cboBVChuyen.Items.Add(selectedItemc);
                    //selectedItemc.Selected = true;
                    //selectedItemc.DataBind();
                    //cboBVChuyen.DataBind();
                    cboBVChuyen.Text = _KhamBenh_Noi.TenBV;
                    cboBVChuyen.SelectedValue = _KhamBenh_Noi.MaBV;

                }

            }
        }
        KiemTraHDT();
        cboChanDoan.Focus();

    }
    private void LoadDetails_ThongTinTT(Boolean _load = true)
    {
        switch (CurrentTabIndex)
        {

            case 1:
                {
                    txtMaBNDV.Text = txtMaQL.Text;
                    txtHoTenDV.Text = txtHoTen.Text;
                    if (lblGioitinh.Items[0].Selected == true)
                        optGTDV.Items[0].Selected = true;
                    else
                        optGTDV.Items[1].Selected = true;
                    txtTuoiDV.Text = txtTuoi.Text;
                    break;
                }
            case 2:
                {
                    txtMaBNT.Text = txtMaQL.Text;
                    dtNgaySinhT.Text = dtNgaySinh.Text;
                    txtHoTenT.Text = txtHoTen.Text;
                    if (lblGioitinh.Items[0].Selected == true)
                        optGTT.Items[0].Selected = true;
                    else
                        optGTT.Items[1].Selected = true;
                    txtTuoiT.Text = txtTuoi.Text;
                    break;
                }
            case 3:
                {
                    txtMaBNLS.Text = txtMaQL.Text;
                    dtNgaySinhLS.Text = dtNgaySinh.Text;
                    txtHoTenLS.Text = txtHoTen.Text;
                    if (lblGioitinh.Items[0].Selected == true)
                        optGTLS.Items[0].Selected = true;
                    else
                        optGTLS.Items[1].Selected = true;
                    txtTuoiLS.Text = txtTuoi.Text;
                    break;
                }


            case 4:
                {
                    txtMaBNDT.Text = txtMaQL.Text;
                    dtNgaySinhDT.Text = dtNgaySinh.Text;
                    txtHoTenDT.Text = txtHoTen.Text;
                    if (lblGioitinh.Items[0].Selected == true)
                        optGTDT.Items[0].Selected = true;
                    else
                        optGTDT.Items[1].Selected = true;
                    txtTuoiDT.Text = txtTuoi.Text;
                    break;
                }
            case 5:
                {
                    txtMaBNKQ.Text = txtMaQL.Text;
                    dtNgaySinhKQ.Text = dtNgaySinh.Text;
                    txtHoTenKQ.Text = txtHoTen.Text;
                    if (lblGioitinh.Items[0].Selected == true)
                        optGTKQ.Items[0].Selected = true;
                    else
                        optGTKQ.Items[1].Selected = true;
                    txtTuoiKQ.Text = txtTuoi.Text;
                    break;
                }
            case 6:
                {
                    txtMaBNKN.Text = txtMaQL.Text;
                    dtNgaySinhKN.Text = dtNgaySinh.Text;
                    txtHoTenKN.Text = txtHoTen.Text;
                    if (lblGioitinh.Items[0].Selected == true)
                        optGTKN.Items[0].Selected = true;
                    else
                        optGTKN.Items[1].Selected = true;
                    txtTuoiKN.Text = txtTuoi.Text;
                    break;
                }
                //case 7:
                //    {
                //        txtMaBNVT.Text = txtMaQL.Text;
                //        dtNgaySinhVT.Text = dtNgaySinh.Text;
                //        txtHoTenVT.Text = txtHoTen.Text;
                //        if (lblGioitinh.Items[0].Selected == true)
                //            optGTVT.Items[0].Selected = true;
                //        else
                //            optGTVT.Items[1].Selected = true;
                //        txtTuoiVT.Text = txtTuoi.Text;
                //        break;
                //    }
        }
    }
    #endregion


    #region 1.1 Khám bệnh Thuốc Tây Y
    private KhamBenh_ThuocSD Supports_KhamBenh_ThuocSD(string _mathuoc, DMThuocKhoa _DMThuoc_Gia)
    {
        KhamBenh_ThuocSD _KhamBenh_ThuocSD = KhamBenh_ThuocSD.NewKhamBenh_ThuocSD();

        _KhamBenh_ThuocSD.BHTinhtien = _DMThuoc_Gia.DTBH;

        _KhamBenh_ThuocSD.MaBN = _MaBN;
        _KhamBenh_ThuocSD.Makhoa = _MaKhoa;
        _KhamBenh_ThuocSD.NgayDK = _NgayDK;
        _KhamBenh_ThuocSD.NoiTTBH = _NoiTT;
        _KhamBenh_ThuocSD.NoiTTTT = _NoiTT;
        _KhamBenh_ThuocSD.MaDT = _ThongtinBN.KhamBenh.MaDT;
        _KhamBenh_ThuocSD.CK = "0";
        _KhamBenh_ThuocSD.MaMay = Pub_sMaMay;
        _KhamBenh_ThuocSD.NguoiLap = Pub_sNguoiSD; _KhamBenh_ThuocSD.NguoiSD = Pub_sNguoiSD;
        if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
        {
            _KhamBenh_ThuocSD.BSChiDinh = cboNhanVien.SelectedValue;
            _KhamBenh_ThuocSD.tenbschidinh = cboNhanVien.Text;

        }
        _KhamBenh_ThuocSD.DonGiaBH = _DMThuoc_Gia.DonGiaBH == "" ? "0" : _DMThuoc_Gia.DonGiaBH;
        _KhamBenh_ThuocSD.DongiaTT = _DMThuoc_Gia.DonGiaTT == "" ? "0" : _DMThuoc_Gia.DonGiaTT;
        if (_DMThuoc_Gia.adphongmo > 1)
            _KhamBenh_ThuocSD.BHTinhtien = false;
        else if (_DMThuoc_Gia.adphongmo == 2)
            _KhamBenh_ThuocSD.BHTinhtien = false;

        if (_DMThuoc_Gia.ADChenhLech == true)
            _KhamBenh_ThuocSD.GiaChenhLech = _DMThuoc_Gia.GiaChenhlech == "" ? "0" : _DMThuoc_Gia.GiaChenhlech;
        else
            _KhamBenh_ThuocSD.GiaChenhLech = "0";

        _KhamBenh_ThuocSD.Mathuoc = _DMThuoc_Gia.MaThuoc;
        _KhamBenh_ThuocSD.TenTM = _DMThuoc_Gia.TenTM;
        _KhamBenh_ThuocSD.LieuDung = _DMThuoc_Gia.LieuDung;
        _KhamBenh_ThuocSD.CachDung = _DMThuoc_Gia.CachDung;
        _KhamBenh_ThuocSD.TONCK = decimal.Parse(_DMThuoc_Gia.TonCK == "" ? "0" : _DMThuoc_Gia.TonCK);
        _KhamBenh_ThuocSD.TONCKDT = decimal.Parse(_DMThuoc_Gia.TonCKDT == "" ? "0" : _DMThuoc_Gia.TonCKDT);

        _KhamBenh_ThuocSD.MaSoKham = _MaSoKham;

        _KhamBenh_ThuocSD.MaBN = _MaBN;
        _KhamBenh_ThuocSD.Tinhtien = false;

        return _KhamBenh_ThuocSD;
    }

    private void LoadDetails_KhamBenh_ThuocSuDung(Boolean _load = true, Boolean _goi = false, string _masokham = "", Boolean kott = false)
    {
        KhamBenh _KhamBenh = _ThongtinBN.KhamBenh;
        if (_masokham != "")
        {
            //foreach (KhamBenh_ThuocSD kbt in  _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
            //{
            //    if (kbt.DATT == 0)
            //         _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.RemoveTo(kbt, _ThongtinBN.KhamBenh);
            //}
            try
            {
                foreach (KhamBenh_ThuocSD kbt in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
                {
                    if (kbt.DATT != 0)
                    {
                        ShowMessage("Thuốc đã thanh toán không thể nhập được");
                        return;
                    }
                }
                if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count > 0)
                    _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Clear();
            }
            catch (Exception ex)
            { }
            DMThuocKhoaList _bagl = DMThuocKhoaList.FindDMThuocKhoaMaSoKhamTY(_MaKhoa, _ThongtinBN.KhamBenh.MaDT, _masokham, _LoaiPhieu);

            foreach (DMThuocKhoa tmp4 in _bagl)
            {
                KhamBenh_ThuocSD _bat = Supports_KhamBenh_ThuocSD(tmp4.MaThuoc, tmp4);
                _bat.SLMua = tmp4.SoLuong.ToString();
                _bat.SLKeDon = tmp4.SoLuong.ToString();
                _bat.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;


                if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count == 0)
                    _bat.STT = 1;
                else
                    _bat.STT = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList[_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count - 1].STT + 1;

                _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.AssignTo(_bat, _ThongtinBN.KhamBenh);


            }
            _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();

        }
        else if (_goi == true)
        {
            //foreach (KhamBenh_ThuocSD kbt in  _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
            //{
            //    if (kbt.DATT == 0)
            //         _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.RemoveTo(kbt, _ThongtinBN.KhamBenh);
            //}
            foreach (KhamBenh_ThuocSD kbt in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
            {
                if (kbt.DATT != 0)
                {
                    ShowMessage("Thuốc đã thanh toán không thể nhập được");
                    return;
                }
            }
            _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Clear();
            DMThuocKhoaList _bagl = DMThuocKhoaList.FindDMThuocKhoaBThuoc(_MaKhoa, _ThongtinBN.KhamBenh.MaDT, 3, cboGoiTY.SelectedValue);

            foreach (DMThuocKhoa tmp4 in _bagl)
            {
                KhamBenh_ThuocSD _bat = Supports_KhamBenh_ThuocSD(tmp4.MaThuoc, tmp4);
                if (kott == true)
                {
                    _bat.DonGiaBH = "0";
                    _bat.DongiaTT = "0";
                    _bat.GiaChenhLech = "0";
                }
                _bat.SLMua = tmp4.SoLuong.ToString();
                _bat.SLKeDon = tmp4.SoLuong.ToString();
                _bat.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;

                if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count == 0)
                    _bat.STT = 1;
                else
                    _bat.STT = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList[_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count - 1].STT + 1;

                _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.AssignTo(_bat, _ThongtinBN.KhamBenh);


            }
            _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();

        }

        else if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList == null)

            _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList;


        if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList != null)
        {
            grdThuoc.DataSource = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList;

            try
            {
                grdThuoc.DataBind();
            }
            catch (Exception ex)
            { }

        }
        if (_load == true && _goi == false && _masokham == "")
        {

            if (cboNhapHoTroDY.Items.Count == 0)
            {
                cboNhapHoTroDY.EnableAutomaticLoadOnDemand = true;
                cboNhapHoTroDY.DataBind();
            }
            if (cboGoiDY.Items.Count == 0)
            {
                cboGoiDY.EnableAutomaticLoadOnDemand = true;
                cboGoiDY.DataBind();
            }
        }

    }
    #endregion

    #region 2. Khám bệnh Thuốc Thang -  Thuốc Đông Y
    private KhamBenh_ThuocSD_DY_C Supports_KhamBenh_ThuocSD_DY(string _mathuoc, DMThuocKhoa _DMThuoc_Gia)
    {
        KhamBenh_ThuocSD_DY_C _KhamBenh_ThuocSD = KhamBenh_ThuocSD_DY_C.NewKhamBenh_ThuocSD_DY_C();
        _KhamBenh_ThuocSD.BHTinhtien = _DMThuoc_Gia.DTBH;
        _KhamBenh_ThuocSD.CK = 0;
        _KhamBenh_ThuocSD.DongiaBH = _DMThuoc_Gia.DonGiaBH == "" ? "0" : _DMThuoc_Gia.DonGiaBH;
        _KhamBenh_ThuocSD.DongiaTT = _DMThuoc_Gia.DonGiaTT == "" ? "0" : _DMThuoc_Gia.DonGiaTT;
        _KhamBenh_ThuocSD.QuyDoi = _DMThuoc_Gia.quydoi;
        _KhamBenh_ThuocSD.MaMay = Pub_sMaMay;
        _KhamBenh_ThuocSD.NguoiSD = Pub_sNguoiSD;
        if (_DMThuoc_Gia.adphongmo > 1)
            _KhamBenh_ThuocSD.BHTinhtien = false;
        else if (_DMThuoc_Gia.adphongmo == 2)
            _KhamBenh_ThuocSD.BHTinhtien = false;

        if (_DMThuoc_Gia.ADChenhLech == true)
            _KhamBenh_ThuocSD.GiaChenhLech = _DMThuoc_Gia.GiaChenhlech == "" ? "0" : _DMThuoc_Gia.GiaChenhlech;
        else
            _KhamBenh_ThuocSD.GiaChenhLech = "0";

        _KhamBenh_ThuocSD.Mathuoc = _DMThuoc_Gia.MaThuoc;
        _KhamBenh_ThuocSD.TenTM = _DMThuoc_Gia.TenTM;
        _KhamBenh_ThuocSD.TONCK = decimal.Parse(_DMThuoc_Gia.TonCK == "" ? "0" : _DMThuoc_Gia.TonCK);
        _KhamBenh_ThuocSD.TONCKDT = decimal.Parse(_DMThuoc_Gia.TonCKDT == "" ? "0" : _DMThuoc_Gia.TonCKDT);

        _KhamBenh_ThuocSD.MaSoKham = _MaSoKham;
        _KhamBenh_ThuocSD.Tinhtien = false;

        return _KhamBenh_ThuocSD;
    }

    private void Supports_KhamBenh_ThuocSD_DY()
    {
        KhamBenh_ThuocSD_DY _KhamBenh_ThuocSD_DYTT = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
        KhamBenh_ThuocSD_DY_CList _KhamBenh_ThuocSD_DY_CList = _KhamBenh_ThuocSD_DYTT.KhamBenh_ThuocSD_DY_Cs;
        _KhamBenh_ThuocSD_DYTT.MaKhoa = _MaKhoa;
        _KhamBenh_ThuocSD_DYTT.MaBN = _MaBN;
        _KhamBenh_ThuocSD_DYTT.NoiTTBH = _NoiTT;
        _KhamBenh_ThuocSD_DYTT.NoiTTTT = _NoiTT;
        _KhamBenh_ThuocSD_DYTT.MaDT = "00001";
        _KhamBenh_ThuocSD_DYTT.Tinhtien = true;
        _KhamBenh_ThuocSD_DYTT.SLMua = txtSLThangTT.Text;
        _KhamBenh_ThuocSD_DYTT.SLThang = txtSLThangTT.Text;
        _KhamBenh_ThuocSD_DYTT.LieuDung = txtLieuDungDY.Text;
        _KhamBenh_ThuocSD_DYTT.CachDung = txtLuuY.Text;
        _KhamBenh_ThuocSD_DYTT.MaMay = Pub_sMaMay;
        _KhamBenh_ThuocSD_DYTT.NguoiLap = Pub_sNguoiSD;
        if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
        {
            _KhamBenh_ThuocSD_DYTT.BSChiDinh = cboNhanVien.SelectedValue;
            _KhamBenh_ThuocSD_DYTT.TenBSChidinh = cboNhanVien.Text;

        }
        _KhamBenh_ThuocSD_DYTT.NgayDK = _NgayDK;
        if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count == 0)
            _KhamBenh_ThuocSD_DYTT.STT = 1;
        else
            _KhamBenh_ThuocSD_DYTT.STT = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList[_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count - 1].STT + 1;


        _KhamBenh_ThuocSD_DYTT.MaBN = _MaBN;
        if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
        {
            _KhamBenh_ThuocSD_DYTT.BSChiDinh = cboNhanVien.SelectedValue;
            _KhamBenh_ThuocSD_DYTT.TenBSChidinh = cboNhanVien.Text;

        }
        foreach (KhamBenh_ThuocSD_DY_C tmp4 in _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs)
        {

            KhamBenh_ThuocSD_DY_C _KhamBenh_ThuocSD_DY_C = KhamBenh_ThuocSD_DY_C.NewKhamBenh_ThuocSD_DY_C();

            _KhamBenh_ThuocSD_DY_C.BHTinhtien = false;



            _KhamBenh_ThuocSD_DY_C.CK = 0;

            _KhamBenh_ThuocSD_DY_C.DongiaBH = tmp4.DongiaBH;
            _KhamBenh_ThuocSD_DY_C.DongiaTT = tmp4.DongiaTT;


            _KhamBenh_ThuocSD_DY_C.GiaChenhLech = "0";

            _KhamBenh_ThuocSD_DY_C.Mathuoc = tmp4.Mathuoc;
            _KhamBenh_ThuocSD_DY_C.TenTM = tmp4.TenTM;
            _KhamBenh_ThuocSD_DY_C.QuyDoi = tmp4.QuyDoi;
            _KhamBenh_ThuocSD_DY_C.SoLuongD = tmp4.SoLuongD;
            _KhamBenh_ThuocSD_DY_C.SLKeDon = tmp4.SLKeDon;
            _KhamBenh_ThuocSD_DY_C.SLMua = tmp4.SLMua;
            _KhamBenh_ThuocSD_DY_C.MaSoKham = _MaSoKham;
            _KhamBenh_ThuocSD_DY_C.Tinhtien = false;

            if (_KhamBenh_ThuocSD_DY_CList.Count == 0)
                _KhamBenh_ThuocSD_DY_C.STTThuoc = 1;
            else
                _KhamBenh_ThuocSD_DY_C.STTThuoc = _KhamBenh_ThuocSD_DY_CList[_KhamBenh_ThuocSD_DY_CList.Count - 1].STTThuoc + 1;

            _KhamBenh_ThuocSD_DY_CList.AssignTo(_KhamBenh_ThuocSD_DY_C);


        }
        _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.NewTo(_KhamBenh_ThuocSD_DYTT);


    }


    private void LoadDetails_KhamBenh_ThuocThangList(Boolean _load = true, Boolean _goi = false)
    {

        if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count > 0)
        {
            grdDanhSachDY.DataSource = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList;

            try
            {
                grdDanhSachDY.DataBind();
            }
            catch (Exception ex)
            { }
            grdDanhSachDY.Visible = true;
        }
        else
            grdDanhSachDY.Visible = false;
        if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count == 0)
        {
            _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
            _KhamBenh_ThuocSD_DY.MaDT = _ThongtinBN.KhamBenh.MaDT;
        }
        else if (_KhamBenh_ThuocSD_DY == null)
            _KhamBenh_ThuocSD_DY = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList[0];

        LoadDetails_KhamBenh_ThuocThang(false, false);

        if (_load == true && _goi == false)
        {
            if (cboNhapHoTroDY.Items.Count == 0)
            {
                cboNhapHoTroDY.EnableAutomaticLoadOnDemand = true;
                cboNhapHoTroDY.DataBind();
            }
            if (cboGoiDY.Items.Count == 0)
            {
                cboGoiDY.EnableAutomaticLoadOnDemand = true;
                cboGoiDY.DataBind();
            }
        }

    }
    private void LoadDetails_KhamBenh_ThuocThang(Boolean _load = true, Boolean _goi = false, string _masokham = "", byte _stt = 0)
    {
        if (_goi == true)
        {
            _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
            KhamBenh_ThuocSD_DY_CList _KhamBenh_ThuocSD_DY_CList = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
            DMThuocKhoaList _bagl = DMThuocKhoaList.FindDMThuocKhoaBThuoc(_MaKhoa, _ThongtinBN.KhamBenh.MaDT, 3, cboGoiDY.SelectedValue);
            _KhamBenh_ThuocSD_DY.MaKhoa = _MaKhoa;
            _KhamBenh_ThuocSD_DY.MaBN = _MaBN;
            _KhamBenh_ThuocSD_DY.NoiTTBH = _NoiTT;
            _KhamBenh_ThuocSD_DY.NoiTTTT = _NoiTT;
            _KhamBenh_ThuocSD_DY.MaDT = _ThongtinBN.KhamBenh.MaDT;
            _KhamBenh_ThuocSD_DY.MaDT = _ThongtinBN.KhamBenh.MaDT;
            _KhamBenh_ThuocSD_DY.NgayDK = _NgayDK;
            _KhamBenh_ThuocSD_DY.MaSoKham = _MaSoKham;
            if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
            {
                _KhamBenh_ThuocSD_DY.BSChiDinh = cboNhanVien.SelectedValue;
                _KhamBenh_ThuocSD_DY.TenBSChidinh = cboNhanVien.Text;

            }
            _KhamBenh_ThuocSD_DY.MaBN = _MaBN;

            if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count == 0)
                _KhamBenh_ThuocSD_DY.STT = 1;
            else
                _KhamBenh_ThuocSD_DY.STT = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList[_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count - 1].STT + 1;

            foreach (DMThuocKhoa tmp4 in _bagl)
            {
                Boolean addthuoc = true;
                foreach (KhamBenh_ThuocSD_DY_C bac in _KhamBenh_ThuocSD_DY_CList)
                {
                    if (tmp4.MaThuoc == bac.Mathuoc)
                    {


                        addthuoc = false;
                    }
                }
                if (addthuoc == true)
                {
                    KhamBenh_ThuocSD_DY_C _bat = Supports_KhamBenh_ThuocSD_DY(tmp4.MaThuoc, tmp4);
                    _bat.SLMua = tmp4.SoLuong.ToString();
                    _bat.SLKeDon = tmp4.SoLuong.ToString();
                    _bat.SoLuongD = (tmp4.SoLuong * tmp4.quydoi).ToString();
                    _bat.STT = _KhamBenh_ThuocSD_DY.STT;
                    _bat.MaSoKham = _KhamBenh_ThuocSD_DY.MaSoKham;


                    if (_KhamBenh_ThuocSD_DY_CList.Count == 0)
                        _bat.STTThuoc = 1;
                    else
                        _bat.STTThuoc = _KhamBenh_ThuocSD_DY_CList[_KhamBenh_ThuocSD_DY_CList.Count - 1].STTThuoc + 1;

                    _KhamBenh_ThuocSD_DY_CList.AssignTo(_bat);
                }

            }
            _KhamBenh_ThuocSD_DY.TinhLaiDon();
            txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
            txtTT.Value = (_KhamBenh_ThuocSD_DY.SLMua == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua)).ToString("###,###");
            txtDonThang.Text = txtTT.Value;

            _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.NewTo(_KhamBenh_ThuocSD_DY);
            _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();
        }
        else if (_masokham != "")
        {
            foreach (KhamBenh_ThuocSD_DY kbt in _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList)
            {
                if (kbt.DATT != 0)
                {
                    ShowMessage("Thuốc đã thanh toán không thể nhập được");
                    return;
                }
            }
            _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
            KhamBenh_ThuocSD_DY_CList _KhamBenh_ThuocSD_DY_CList = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
            DMThuocKhoaList _bagl = DMThuocKhoaList.FindDMThuocKhoaMaSoKhamDY(_MaKhoa, _ThongtinBN.KhamBenh.MaDT, _masokham, _LoaiPhieu, _stt.ToString());
            _KhamBenh_ThuocSD_DY.MaSoKham = _MaSoKham;

            _KhamBenh_ThuocSD_DY.MaDT = _ThongtinBN.KhamBenh.MaDT;
            _KhamBenh_ThuocSD_DY.MaKhoa = _MaKhoa;
            _KhamBenh_ThuocSD_DY.MaBN = _MaBN;
            _KhamBenh_ThuocSD_DY.NoiTTBH = _NoiTT;
            _KhamBenh_ThuocSD_DY.NoiTTTT = _NoiTT;
            _KhamBenh_ThuocSD_DY.MaDT = _ThongtinBN.KhamBenh.MaDT;
            if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count == 0)
                _KhamBenh_ThuocSD_DY.STT = 1;
            else
                _KhamBenh_ThuocSD_DY.STT = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList[_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count - 1].STT + 1;


            _KhamBenh_ThuocSD_DY.NgayDK = _NgayDK;
            if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
            {
                _KhamBenh_ThuocSD_DY.BSChiDinh = cboNhanVien.SelectedValue;
                _KhamBenh_ThuocSD_DY.TenBSChidinh = cboNhanVien.Text;

            }

            _KhamBenh_ThuocSD_DY.MaBN = _MaBN;
            foreach (DMThuocKhoa tmp4 in _bagl)
            {
                Boolean addthuoc = true;
                foreach (KhamBenh_ThuocSD_DY_C bac in _KhamBenh_ThuocSD_DY_CList)
                {
                    if (tmp4.MaThuoc == bac.Mathuoc)
                    {


                        addthuoc = false;
                    }
                }
                if (addthuoc == true)
                {
                    KhamBenh_ThuocSD_DY_C _bat = Supports_KhamBenh_ThuocSD_DY(tmp4.MaThuoc, tmp4);
                    _bat.SLMua = tmp4.SoLuong.ToString();
                    _bat.SLKeDon = tmp4.SoLuong.ToString();
                    _bat.SoLuongD = (tmp4.SoLuong * tmp4.quydoi).ToString();
                    _bat.STT = _KhamBenh_ThuocSD_DY.STT;
                    _bat.MaSoKham = _KhamBenh_ThuocSD_DY.MaSoKham;


                    if (_KhamBenh_ThuocSD_DY_CList.Count == 0)
                        _bat.STTThuoc = 1;
                    else
                        _bat.STTThuoc = _KhamBenh_ThuocSD_DY_CList[_KhamBenh_ThuocSD_DY_CList.Count - 1].STTThuoc + 1;

                    _KhamBenh_ThuocSD_DY_CList.AssignTo(_bat);
                }

            }
            _KhamBenh_ThuocSD_DY.TinhLaiDon();
            txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
            txtTT.Value = (_KhamBenh_ThuocSD_DY.SLMua == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua)).ToString("###,###");
            txtDonThang.Text = txtTT.Value;
            _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.NewTo(_KhamBenh_ThuocSD_DY);

            _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();
        }
        else if (_load == true)
        {
            _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
            _KhamBenh_ThuocSD_DY.MaDT = _ThongtinBN.KhamBenh.MaDT;
        }
        if (_KhamBenh_ThuocSD_DY == null)
        {
            _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
            _KhamBenh_ThuocSD_DY.MaDT = _ThongtinBN.KhamBenh.MaDT;
        }
        else if (_KhamBenh_ThuocSD_DY.MaDT == "")
        {
            _KhamBenh_ThuocSD_DY.MaDT = _ThongtinBN.KhamBenh.MaDT;
        }
        if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "0" || _KhamBenh_ThuocSD_DY.MaDT.Substring(0, 1) == "0")
        {
            Label5.Visible = false;
            txtSLThangTT.Visible = false;
        }
        txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
        txtTT.Value = (_KhamBenh_ThuocSD_DY.SLMua == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua)).ToString("###,###");
        txtDonThang.Text = txtTT.Value;
        txtSLThang.Text = _KhamBenh_ThuocSD_DY.SLThang;

        if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "0")
            txtLieuDungDY.Text = _KhamBenh_ThuocSD_DY.IsNew == true && _KhamBenh_ThuocSD_DY.LieuDung == "" ? "Ngày uống 1 thang mỗi thang sắc kỹ 3 lần uống sau ăn" : _KhamBenh_ThuocSD_DY.LieuDung;
        else
            txtLieuDungDY.Text = _KhamBenh_ThuocSD_DY.IsNew == true && _KhamBenh_ThuocSD_DY.LieuDung == "" ? "Hai ngày uống 1 thang mỗi thang sắc kỹ 3 lần uống sau ăn" : _KhamBenh_ThuocSD_DY.LieuDung;

        if (_KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs != null)
        {
            grdThuocDY.DataSource = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
            if (_KhamBenh_ThuocSD_DY.DATT != 0)
            {
                grdThuocDY.MasterTableView.GetColumn("Edit").Display = false;
                grdThuocDY.MasterTableView.GetColumn("Delete").Display = false;
                grdThuocDY.MasterTableView.IsItemInserted = false;
            }
            else
            {
                grdThuocDY.MasterTableView.GetColumn("Edit").Display = true;
                grdThuocDY.MasterTableView.GetColumn("Delete").Display = true;
                grdThuocDY.MasterTableView.IsItemInserted = true;
            }
            try
            {
                grdThuocDY.DataBind();
            }
            catch (Exception ex)
            { }

        }

    }

    #endregion
    //#region 3.1 Khám bệnh VTTH
    //private KhamBenh_VTTH Supports_KhamBenh_VTTH(string _mavt, DMVTYTKhoa _DMVTYT_Gia)
    //{
    //    KhamBenh_VTTH _KhamBenh_VTTH = KhamBenh_VTTH.NewKhamBenh_VTTH();


    //    _KhamBenh_VTTH.BHTinhtien = _DMVTYT_Gia.DTBH;

    //    _KhamBenh_VTTH.MaBN = _MaBN;
    //    _KhamBenh_VTTH.Makhoa = _MaKhoa;
    //    _KhamBenh_VTTH.MaDT = _ThongtinBN.KhamBenh.MaDT;

    //    _KhamBenh_VTTH.NgayDK = _NgayDK;
    //    _KhamBenh_VTTH.TToanSau = true; _KhamBenh_VTTH.dadung = true;
    //    if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
    //    {
    //        _KhamBenh_VTTH.BSChiDinh = cboNhanVien.SelectedValue;
    //        _KhamBenh_VTTH.tenbschidinh = cboNhanVien.Text;

    //    }

    //    _KhamBenh_VTTH.CK = "0";

    //    _KhamBenh_VTTH.DonGiaBH = _DMVTYT_Gia.DonGiaBH == "" ? "0" : _DMVTYT_Gia.DonGiaBH;
    //    _KhamBenh_VTTH.DongiaTT = _DMVTYT_Gia.DonGiaTT == "" ? "0" : _DMVTYT_Gia.DonGiaTT;
    //    if (_DMVTYT_Gia.adphongmo > 1)
    //        _KhamBenh_VTTH.BHTinhtien = false;
    //    else if (_DMVTYT_Gia.adphongmo == 2)
    //        _KhamBenh_VTTH.BHTinhtien = false;

    //    if (_DMVTYT_Gia.ADChenhLech == true)
    //        _KhamBenh_VTTH.GiaChenhLech = _DMVTYT_Gia.GiaChenhlech == "" ? "0" : _DMVTYT_Gia.GiaChenhlech;
    //    else
    //        _KhamBenh_VTTH.GiaChenhLech = "0";

    //    _KhamBenh_VTTH.MaVT = _DMVTYT_Gia.MaVT;
    //    _KhamBenh_VTTH.TenTM = _DMVTYT_Gia.TenTM;


    //    _KhamBenh_VTTH.MaSoKham = _MaKhoa;

    //    _KhamBenh_VTTH.MaBN = _MaBN;
    //    _KhamBenh_VTTH.Tinhtien = false;
    //    return _KhamBenh_VTTH;

    //}

    //private void LoadDetails_KhamBenh_VTTH(Boolean _load = true, Boolean _goi = false)
    //{


    //    if (_ThongtinBN.KhamBenh.KhamBenh_VTTHList != null)
    //    {
    //        grdVTTH.DataSource = _ThongtinBN.KhamBenh.KhamBenh_VTTHList;

    //        try
    //        {
    //            grdVTTH.DataBind();
    //        }
    //        catch (Exception ex)
    //        { }

    //    }

    //}

    //#endregion

    #region 1.2. Khám bệnh XN.TT.XQ.TDCN
    private KhamBenh_C Supports_KhamBenh_C(string madv, DMDichVu_Gia_DT _DMDichVu_Gia)
    {
        KhamBenh_C _KhamBenh_C = KhamBenh_C.NewKhamBenh_C();

        _KhamBenh_C.BHTinhtien = _DMDichVu_Gia.DTBH;

        _KhamBenh_C.MaBN = _MaBN;
        _KhamBenh_C.makhoacd = _MaKhoa;
        _KhamBenh_C.maicd = cboChanDoan.Text;
        _KhamBenh_C.Mabenh = cboChanDoan.SelectedValue;
        _KhamBenh_C.tenbenh = txtChanDoan.Text;
        _KhamBenh_C.MaMay = Pub_sMaMay;
        _KhamBenh_C.NguoiLap = Pub_sNguoiSD; _KhamBenh_C.NguoiSD = Pub_sNguoiSD;
        _KhamBenh_C.maicdKem = cboChanDoanKem.Text;
        _KhamBenh_C.MabenhKem = cboChanDoanKem.SelectedValue;
        _KhamBenh_C.tenbenhKem = txtChanDoanKem.Text;
        //_KhamBenh_C.maicdKem2 = cboChanDoanKem2.Text;
        //_KhamBenh_C.MabenhKem2 = cboChanDoanKem2.SelectedValue;
        //_KhamBenh_C.tenbenhKem2 = txtChanDoanKem2.Text;
        //_KhamBenh_C.maicdKem3 = cboChanDoanKem3.Text;
        //_KhamBenh_C.MabenhKem3 = cboChanDoanKem3.SelectedValue;
        //_KhamBenh_C.tenbenhKem3 = txtChanDoanKem3.Text;
        _KhamBenh_C.NgayDK = _NgayDK;

        _KhamBenh_C.MaDT = _ThongtinBN.KhamBenh.MaDT;
        _KhamBenh_C.CK = "0";
        if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
        {
            _KhamBenh_C.bschidinh = cboNhanVien.SelectedValue;
            _KhamBenh_C.tenbschidinh = cboNhanVien.Text;

        }
        _KhamBenh_C.DonGiaBH = _DMDichVu_Gia.Dongia == "" ? "0" : _DMDichVu_Gia.Dongia;
        //_KhamBenh_C.DongiaTT = _DMDichVu_Gia.dongiatt == "" ? "0" : _DMDichVu_Gia.dongiatt;
        // _KhamBenh_C.NoiTTBH = _NoiTT;
        //_KhamBenh_C.NoiTTTT = _NoiTT;
        if (_NoiTT == "087" && (_DMDichVu_Gia.dongiaclc == "" || _DMDichVu_Gia.dongiaclc == "0"))
        {
            _KhamBenh_C.DongiaTT = _DMDichVu_Gia.dongiadv == "" ? "0" : _DMDichVu_Gia.dongiadv;
            _KhamBenh_C.NoiTTBH = "085";
            _KhamBenh_C.NoiTTTT = "085";
        }
        else if (_NoiTT == "085" && (_DMDichVu_Gia.dongiadv == "" || _DMDichVu_Gia.dongiadv == "0"))
        {
            _KhamBenh_C.DongiaTT = _DMDichVu_Gia.dongiaclc == "" ? "0" : _DMDichVu_Gia.dongiaclc;
            _KhamBenh_C.NoiTTBH = "087";
            _KhamBenh_C.NoiTTTT = "087";
        }
        else
        {
            _KhamBenh_C.DongiaTT = _DMDichVu_Gia.dongiatt == "" ? "0" : _DMDichVu_Gia.dongiatt;
            _KhamBenh_C.NoiTTBH = _NoiTT;
            _KhamBenh_C.NoiTTTT = _NoiTT;
        }
        if (_KhamBenh_C.NoiTTTT == "087")
        {
            _KhamBenh_C.Makhoa = _DMDichVu_Gia.makhoa087;
            _KhamBenh_C.tenkhoa = _DMDichVu_Gia.tenkhoa087;
        }
        else if (_KhamBenh_C.NoiTTTT == "093")
        {
            _KhamBenh_C.Makhoa = _DMDichVu_Gia.makhoaNG;
            _KhamBenh_C.tenkhoa = _DMDichVu_Gia.tenkhoaNG;
        }
        else
        {
            _KhamBenh_C.Makhoa = _DMDichVu_Gia.makhoa;
            _KhamBenh_C.tenkhoa = _DMDichVu_Gia.tenkhoa;
        }
        if (_KhamBenh_C.Makhoa == "")
            _KhamBenh_C.Makhoa = _MaKhoa;

        if (_DMDichVu_Gia.ADPhongMo > 1)
            _KhamBenh_C.BHTinhtien = false;
        else if (_DMDichVu_Gia.ADPhongMo == 2)
            _KhamBenh_C.BHTinhtien = false;

        if (_DMDichVu_Gia.ADChenhlech == true)
            _KhamBenh_C.GiaChenhLech = _DMDichVu_Gia.GiaChenhlenh == "" ? "0" : _DMDichVu_Gia.GiaChenhlenh;
        else
            _KhamBenh_C.GiaChenhLech = "0";

        _KhamBenh_C.MaDV = _DMDichVu_Gia.MaDV;
        _KhamBenh_C.TenTM = _DMDichVu_Gia.TenDV;

        _KhamBenh_C.MaSoKham = _MaSoKham;

        _KhamBenh_C.MaBN = _MaBN;
        _KhamBenh_C.Tinhtien = false;

        return _KhamBenh_C;
    }
    private void LoadDetails_KhamBenh_XNTT(Boolean _load = true, Boolean _insert = false)
    {

        if (_ThongtinBN.KhamBenh.KhamBenh_C_List != null)
        {
            grdXNTT.DataSource = _ThongtinBN.KhamBenh.KhamBenh_C_List;

            try
            {
                if (_insert == true)
                    grdXNTT.MasterTableView.IsItemInserted = true;
                grdXNTT.DataBind();
            }
            catch (Exception ex)
            { }

        }

    }
    private void LoadDetails_KetQua(Boolean _load = true)
    {
        if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 1)
        {
            if (_ThongtinBN.KhamBenh.KhamBenh_XN_GetsList == null)
            {
                KhamBenh_XN_GetsList _KhamBenh_XN_GetsList = KhamBenh_XN_GetsList.GetAllGetsDichVu(_ThongtinBN.KhamBenh.MaSoKham, 1, DateTime.Parse(_ThongtinBN.KhamBenh.NgayDK), _LoaiPhieu, "", 0);
                _ThongtinBN.KhamBenh.KhamBenh_XN_GetsList = _KhamBenh_XN_GetsList;
            }
            else if (_ThongtinBN.KhamBenh.KhamBenh_XN_GetsList.Count == 0)
            {
                KhamBenh_XN_GetsList _KhamBenh_XN_GetsList = KhamBenh_XN_GetsList.GetAllGetsDichVu(_ThongtinBN.KhamBenh.MaSoKham, 1, DateTime.Parse(_ThongtinBN.KhamBenh.NgayDK), _LoaiPhieu, "", 0);
                _ThongtinBN.KhamBenh.KhamBenh_XN_GetsList = _KhamBenh_XN_GetsList;
            }
        }
        grdKQXN.DataSource = _ThongtinBN.KhamBenh.KhamBenh_XN_GetsList;
        grdKQXN.Visible = true;
        try
        {
            grdKQXN.DataBind();
        }
        catch (Exception ex)
        { }
        MergeRows(grdKQXN, "STT");
        MergeRows(grdKQXN, "TenDV");


    }

    #endregion


    #region 4. Quá trình điều trị

    private void LoadDetails_DieuTri(Boolean _load = true)
    {
        if (_KhamBenh_GETsMABNListInfo == null && string.IsNullOrEmpty(_MaBN))
            _KhamBenh_GETsMABNListInfo = KhamBenh_GETsMABNListInfo.NewList();
        else if (_KhamBenh_GETsMABNListInfo == null && !string.IsNullOrEmpty(_MaBN))

            _KhamBenh_GETsMABNListInfo = KhamBenh_GETsMABNListInfo.GetAllKhamBenh_GETsMABNInfoTT(_MaBN, _LoaiPhieu, "");
        if (_KhamBenh_GETsMABNListInfo != null)
            if (_KhamBenh_GETsMABNListInfo != null)
            {
                grdDSDieuTri.DataSource = _KhamBenh_GETsMABNListInfo;
                try
                {
                    grdDSDieuTri.DataBind();
                }
                catch (Exception ex)
                { }
                if (_KhamBenh_GETsMABNListInfo.Count > 0)
                {
                    KhamBenh_GetsDichVuList _KhamBenh_GetsDichVuList = KhamBenh_GetsDichVuList.GetAllGetsDichVu(_KhamBenh_GETsMABNListInfo[0].MaSoKham, byte.Parse("0"), 0, "");
                    if (_KhamBenh_GetsDichVuList != null)
                    {
                        grdChiTietDichVu.DataSource = _KhamBenh_GetsDichVuList;

                        try
                        {
                            grdChiTietDichVu.DataBind();
                        }
                        catch (Exception ex)
                        { }

                    }


                }
            }
    }
    #endregion
    #region 7. kê ngoài

    private void LoadDetails_KeNgoai(Boolean _load = true)
    {
        if (_KhamBenh_KeNgoaiList == null && _ThongtinBN.KhamBenh.MaSoKham == "")
            _KhamBenh_KeNgoaiList = KhamBenh_KeNgoaiList.NewList();
        else if (_KhamBenh_KeNgoaiList == null && _ThongtinBN.KhamBenh.MaSoKham != "")
            _KhamBenh_KeNgoaiList = KhamBenh_KeNgoaiList.GetAllKhamBenh_KeNgoai(_ThongtinBN.KhamBenh.MaSoKham);
        if (_KhamBenh_KeNgoaiList != null)
        {
            grdKeNgoai.DataSource = _KhamBenh_KeNgoaiList;

            try
            {
                grdKeNgoai.DataBind();
            }
            catch (Exception ex)
            { }

        }
    }
    #endregion

    #region khoa cls

    private void LoadDetails_KhamBenh_Khoa(Boolean _load = true)
    {
        if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count == 0 && _ThongKe_BenhNhan_NgoaiTruListInfo == null && _ThongtinBN.MaBN != "")
        {
            _ThongKe_BenhNhan_NgoaiTruListInfo = ThongKe_BenhNhan_NgoaiTruListInfo.GetThongKe_BenhNhan_NgoaiTru_Info(DateTime.Now, DateTime.Now, "All", 10, _NoiTT);

            grdKhoa.DataSource = _ThongKe_BenhNhan_NgoaiTruListInfo;
            grdKhoa.DataBind();
            grdKhoa.Visible = true;

        }
    }
    #endregion
    #region Tab hiện tại

    private const string ViewState_CurrentTab = "CurrentTab";
    public int CurrentTabIndex
    {
        get
        {
            if (ViewState[ViewState_CurrentTab] == null)
            {
                ViewState[ViewState_CurrentTab] = 0;

                return (int)ViewState[ViewState_CurrentTab];
            }
            else
                return (int)ViewState[ViewState_CurrentTab];
        }

        set
        {
            ViewState[ViewState_CurrentTab] = value;
        }
    }
    #endregion
    protected void Page_Load(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
            if ((String.IsNullOrEmpty(Request["MaSoKham"]) || String.IsNullOrEmpty(Request["MaBN"])) && Request["CapCuu"] == null)
            {
                Response.Redirect("~/UI/PhongKham/KhamBenh/frmDSBNKhamBenh.aspx?noitt=" + _NoiTT + "&loaiphieu=" + _LoaiPhieu + "&LoaiKQCN=" + _LoaiKQCN + "&capcuu=" + _CapCuu);

            }
            else
            {

                if (Request["CapCuu"] != null && !String.IsNullOrEmpty(Request["CapCuu"]))
                {
                    _CapCuu = Request["CapCuu"].ToString() == "True" ? true : false;

                }
                else
                    _CapCuu = false;
                if (Request["MaSoKham"] != null)
                    _MaSoKham = Request["MaSoKham"];
                if (Request["NoiTT"] != null)
                    _NoiTT = Request["NoiTT"];
                if (Request["MaBN"] != null)
                    _MaBN = Request["MaBN"];
                if (Request["NgayDK"] != null)
                    _NgayDK = Request["NgayDK"].ToString();
                CurrentTabIndex = 0;
                RadTabStrip1.SelectedIndex = CurrentTabIndex;
                RadMultiPage1.SelectedIndex = CurrentTabIndex;
                txtindextab.Value = CurrentTabIndex.ToString();
                if (!String.IsNullOrEmpty(Request["STT"]))
                {
                    _STT = Byte.Parse(Request["STT"]);
                }

                LoadData();
                SetData();
                SetObject();

            }


        }

        //if (!(CheckReportViewerReload(ReportData3) || CheckReportViewerReload(ReportData4) || CheckReportViewerReload(ReportData1) || CheckReportViewerReload(ReportData2) || CheckReportViewerReload(ReportData5)))
        //{
        //    ReportData3 = null; //HTCReportViewer3.Dispose();// HTCReportViewer3 = null;
        //    ReportData4 = null; //HTCReportViewer4.Dispose(); //HTCReportViewer4 = null;
        //    ReportData5 = null; //HTCReportViewer5.Dispose(); //HTCReportViewer5 = null;
        //    ReportData6 = null; //HTCReportViewer6.Dispose(); //HTCReportViewer6 = null;
        //    ReportData8 = null; //HTCReportViewer8.Dispose(); //HTCReportViewer8 = null;
        //    ReportData1 = null; //HTCReportViewer1.Dispose(); //HTCReportViewer1 = null;
        //    ReportData2 = null; //HTCReportViewer2.Dispose(); //HTCReportViewer2 = null;

        //}
        //else
        //    //PrintData(false);

    }
    private void SetObject()
    {
        //if (Cache[odsVTTH.CacheKeyDependency] == null)
        //    Cache[odsVTTH.CacheKeyDependency] =  _ThongtinBN.KhamBenh.MaDT;
        //else if (Cache[odsVTTH.CacheKeyDependency].ToString() !=  _ThongtinBN.KhamBenh.MaDT)
        //    Cache[odsVTTH.CacheKeyDependency] =  _ThongtinBN.KhamBenh.MaDT;

        //if (Cache[odsChePhamMau.CacheKeyDependency] == null)
        //    Cache[odsChePhamMau.CacheKeyDependency] =  _ThongtinBN.KhamBenh.MaDT;
        //else if (Cache[odsChePhamMau.CacheKeyDependency].ToString() !=  _ThongtinBN.KhamBenh.MaDT)
        //    Cache[odsChePhamMau.CacheKeyDependency] =  _ThongtinBN.KhamBenh.MaDT;

        //if (Cache[odsHoaChat.CacheKeyDependency] == null)
        //    Cache[odsHoaChat.CacheKeyDependency] =  _ThongtinBN.KhamBenh.MaDT;
        //else if (Cache[odsHoaChat.CacheKeyDependency].ToString() !=  _ThongtinBN.KhamBenh.MaDT)
        //    Cache[odsHoaChat.CacheKeyDependency] =  _ThongtinBN.KhamBenh.MaDT;

        //if (Cache[odsThuoc.CacheKeyDependency] == null)
        //    Cache[odsThuoc.CacheKeyDependency] =  _ThongtinBN.KhamBenh.MaDT;
        //else if (Cache[odsThuoc.CacheKeyDependency].ToString() !=  _ThongtinBN.KhamBenh.MaDT)
        //    Cache[odsThuoc.CacheKeyDependency] =  _ThongtinBN.KhamBenh.MaDT;

        //if (Cache[odsThuocDY.CacheKeyDependency] == null)
        //    Cache[odsThuocDY.CacheKeyDependency] =  _ThongtinBN.KhamBenh.MaDT;
        //else if (Cache[odsThuocDY.CacheKeyDependency].ToString() !=  _ThongtinBN.KhamBenh.MaDT)
        //    Cache[odsThuocDY.CacheKeyDependency] =  _ThongtinBN.KhamBenh.MaDT;

        //if (Cache[odsDichVu.CacheKeyDependency] == null)
        //    Cache[odsDichVu.CacheKeyDependency] =  _ThongtinBN.KhamBenh.MaDT;
        //else if (Cache[odsDichVu.CacheKeyDependency].ToString() !=  _ThongtinBN.KhamBenh.MaDT)
        //    Cache[odsDichVu.CacheKeyDependency] =  _ThongtinBN.KhamBenh.MaDT;
        //if (CurrentTabIndex == 1)
        //{
        //    if (Cache[ObjectDanhMucBT.CacheKeyDependency] == null)
        //        Cache[ObjectDanhMucBT.CacheKeyDependency] = (cboNhanVien.SelectedValue == "" ? "000000" : cboNhanVien.SelectedValue) + "1";
        //    else if (Cache[ObjectDanhMucBT.CacheKeyDependency].ToString() != (cboNhanVien.SelectedValue == "" ? "000000" : cboNhanVien.SelectedValue) + "1")
        //        Cache[ObjectDanhMucBT.CacheKeyDependency] = (cboNhanVien.SelectedValue == "" ? "000000" : cboNhanVien.SelectedValue) + "1";
        //}
        //else if (CurrentTabIndex == 2)
        //{
        //    if (Cache[ObjectDanhMucBT.CacheKeyDependency] == null)
        //        Cache[ObjectDanhMucBT.CacheKeyDependency] = (cboNhanVien.SelectedValue == "" ? "000000" : cboNhanVien.SelectedValue) + "0";
        //    else if (Cache[ObjectDanhMucBT.CacheKeyDependency].ToString() != (cboNhanVien.SelectedValue == "" ? "000000" : cboNhanVien.SelectedValue) + "0")
        //        Cache[ObjectDanhMucBT.CacheKeyDependency] = (cboNhanVien.SelectedValue == "" ? "000000" : cboNhanVien.SelectedValue) + "0";
        //}
    }
    private void SetData()
    {
        ShowHideThuocThang();
        if (pub_bQadmin == false)
        {
            grdThuoc.MasterTableView.GetColumn("Huy").Display = false;
            grdThuocDY.MasterTableView.GetColumn("Huy").Display = false;

            grdXNTT.MasterTableView.GetColumn("Huy").Display = false;

        }

        txtMaQL.Enabled = false;
        dtNgaySinh.Enabled = false;
        txtHoTen.Enabled = false;

        lblGioitinh.Enabled = false;

        txtDoiTuong.Enabled = false;
        txtDiaChi.Enabled = false;
        txtTuoi.Enabled = false;
        // txtNgheNghiep.Enabled = false;

        if (pub_bQadmin == false)
        {
            grdThuoc.MasterTableView.GetColumn("Huy").Display = false;
            grdThuocDY.MasterTableView.GetColumn("Huy").Display = false;
            grdDanhSachDY.MasterTableView.GetColumn("Huy").Display = false;

            grdXNTT.MasterTableView.GetColumn("Huy").Display = false;

        }
        if (Pub_bQuyenForm < HTC.ShareVariables.KieuFormChiTiet.fDelete)
        {
            grdThuocDY.MasterTableView.GetColumn("Delete").Display = false;
            grdDanhSachDY.MasterTableView.GetColumn("Delete").Display = false;
            grdThuoc.MasterTableView.GetColumn("Delete").Display = false;

            grdXNTT.MasterTableView.GetColumn("Delete").Display = false;

        }

        if (cboHuongDT.SelectedValue == "00003" && HTC.ShareVariables.pub_spC == "HU" && pub_bQadmin == true)
            cboHuongDT.Enabled = false;

        if (Pub_bQuyenForm < HTC.ShareVariables.KieuFormChiTiet.fThem)
        {
            baraction.FindItemByValue("cmdPrintThuoc").Enabled = false;
            baraction.FindItemByValue("cmdPrintCD").Enabled = false;
            baraction.FindItemByValue("cmdSave").Enabled = false;
        }
        if (Pub_bQuyenForm < HTC.ShareVariables.KieuFormChiTiet.fSua)
        {
            if (cboHuongDT.SelectedValue != "")
            {
                baraction.FindItemByValue("cmdPrintThuoc").Enabled = false;
                baraction.FindItemByValue("cmdPrintCD").Enabled = false;
                baraction.FindItemByValue("cmdSave").Enabled = false;
            }
        }


    }
    private void ShowHideThuocThang()
    {
        if (_CapCuu == false)
        {
            RadTabStrip1.Tabs[2].Visible = true;
            baraction.FindItemByValue("cmdAddThuocDY").Visible = true;
        }
        else
        {
            RadTabStrip1.Tabs[2].Visible = false;
            baraction.FindItemByValue("cmdAddThuocDY").Visible = false;
        }
    }

    private void LoadDetails(Boolean _load = true, int selectedTabIndex = 0, Boolean goi = false, Boolean kott = false)
    {

        if (selectedTabIndex >= 0)
        {
            CurrentTabIndex = selectedTabIndex;
            txtindextab.Value = CurrentTabIndex.ToString();
            RadTab selectedTab = RadTabStrip1.Tabs[selectedTabIndex];
            if (selectedTab != null)
            {
                switch (selectedTabIndex)
                {
                    case 0:
                        LoadDetails_ThongTin(_load);
                        break;
                    case 1:
                        //widChiTiet.OpenerElementID = cmdNhapHoTroTY.ClientID;
                        LoadDetails_ThongTinTT(_load);
                        LoadDetails_KhamBenh_XNTT(_load);
                        txtTongTien.Text = _ThongtinBN.KhamBenh.TongThanhToan.ToString("###,###");
                        txtTienThuoc.Text = (_ThongtinBN.KhamBenh.TongThuocTY + _ThongtinBN.KhamBenh.TongThuocDY).ToString("###,###");
                        txtTienXN.Text = _ThongtinBN.KhamBenh.TongDV.ToString("###,###");
                        if (HTC.ShareVariables.pub_spC == "QN")
                        {
                            LoadDetails_KhamBenh_Khoa(_load);
                        }
                        break;
                    case 2:
                        //widChiTiet.OpenerElementID = cmdNhapHoTroTY.ClientID;
                        LoadDetails_ThongTinTT(_load);
                        LoadDetails_KhamBenh_ThuocSuDung(_load, goi, "", true);

                        txtTongTienT.Text = _ThongtinBN.KhamBenh.TongThanhToan.ToString("###,###");
                        txtTienThuocT.Text = (_ThongtinBN.KhamBenh.TongThuocTY + _ThongtinBN.KhamBenh.TongThuocDY).ToString("###,###");
                        txtTienXNT.Text = _ThongtinBN.KhamBenh.TongDV.ToString("###,###");
                        break;
                    case 3:
                        // widChiTiet.OpenerElementID = cmdChitietDY.ClientID;
                        LoadDetails_ThongTinTT(_load);
                        LoadDetails_KhamBenh_ThuocThangList(_load, goi);
                        break;
                    case 4:
                        LoadDetails_ThongTinTT(_load);
                        LoadDetails_DieuTri(_load);
                        break;
                    case 5:
                        LoadDetails_ThongTinTT(_load);
                        LoadDetails_KetQua(_load);
                        break;

                    case 6:
                        LoadDetails_ThongTinTT(_load);
                        LoadDetails_KeNgoai(_load);
                        break;
                        //case 7:
                        //    LoadDetails_ThongTinTT(_load);
                        //    LoadDetails_KhamBenh_VTTH(_load);
                        //    break;
                }

            }
        }
    }

    private void LoadData()
    {

        if (!string.IsNullOrEmpty(_MaBN) && !string.IsNullOrEmpty(_MaSoKham))
        {
            _ThongtinBN = ThongtinBN.GetThongtinBN(_MaBN, DateTime.Parse(_NgayDK), _LoaiPhieu, _MaSoKham, _STT, _LoaiKQCN);

            _ThongtinBN.KhamBenh.loai = _LoaiPhieu;
            KhamBenh_C _KhamBenh_KB = _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(X => X.STT == _STT);
            if (_NoiTT != "085" && _KhamBenh_KB.NoiTTTT == "085")
            {
                CloseWindow(); //Response.Redirect("~/UI/PhongKham/KhamBenh/frmDSBNKhamBenh.aspx?NoiTT=" + _NoiTT + "&loaiphieu=" + _LoaiPhieu + "&LoaiKQCN=" + _LoaiKQCN + "&capcuu=" + _CapCuu, false);
                return;
            }
            // neu kham co huong roi thi co ket qua hoac ko
            if ((_KhamBenh_KB.MaHuongDT != "" && _LoaiKQCN == 0) || (_KhamBenh_KB.MaHuongDT == "" && _LoaiKQCN == 1))
            {
                CloseWindow();// Response.Redirect("~/UI/PhongKham/KhamBenh/frmDSBNKhamBenh.aspx?NoiTT=" + _NoiTT + "&loaiphieu=" + _LoaiPhieu + "&LoaiKQCN=" + _LoaiKQCN + "&capcuu=" + _CapCuu, false);
                return;
            }
            if (_NoiTT == "" || _NoiTT == null)
                _NoiTT = _KhamBenh_KB.NoiTTTT != "" ? _KhamBenh_KB.NoiTTTT : (_KhamBenh_KB.NoiTTBH != "" ? _KhamBenh_KB.NoiTTBH : "085");
            _MaKhoa = _KhamBenh_KB.Makhoa;
            LoadDetails(true, CurrentTabIndex);
        }

    }
    //protected void btnSearch_Click(object sender, EventArgs e)
    //{
    //}
    protected void baraction_ButtonClick(object sender, RadToolBarEventArgs e)
    {

        if (((RadToolBarButton)e.Item).CommandName.Equals("cmdSave", StringComparison.InvariantCultureIgnoreCase))
        {
            if (UpdateDataSave())
                CloseWindow();
            //  Response.Redirect("~/UI/PhongKham/KhamBenh/frmDSBNKhamBenh.aspx?noitt=" + _NoiTT + "&loaiphieu=" + _LoaiPhieu + "&LoaiKQCN=" + _LoaiKQCN + "&capcuu=" + _CapCuu, false);
        }

        else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdExit", StringComparison.InvariantCultureIgnoreCase))
        {
            Response.Redirect("~/UI/PhongKham/KhamBenh/frmDSBNKhamBenh.aspx?noitt=" + _NoiTT + "&loaiphieu=" + _LoaiPhieu + "&LoaiKQCN=" + _LoaiKQCN + "&capcuu=" + _CapCuu, false);
        }
        else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdAddKe", StringComparison.InvariantCultureIgnoreCase))
        {
            CurrentTabIndex = 6;
            RadTabStrip1.SelectedIndex = CurrentTabIndex;
            RadMultiPage1.SelectedIndex = CurrentTabIndex;
            txtindextab.Value = CurrentTabIndex.ToString();
            LoadDetails(false, CurrentTabIndex, false);

            grdKeNgoai.MasterTableView.IsItemInserted = true;
            grdKeNgoai.DataBind();
        }
        else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdTuongTac", StringComparison.InvariantCultureIgnoreCase))
        {

            KiemTraTuongTac();
        }
        else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdPrintThuoc", StringComparison.InvariantCultureIgnoreCase))
        {
            if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count == 0)
            {
                if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList != null)
                {
                    if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count == 0)
                    {
                        if (_KhamBenh_KeNgoaiList != null)
                        {
                            if (_KhamBenh_KeNgoaiList.Count == 0)
                            {
                                ShowMessage("Chưa nhập thuốc của bệnh nhân");
                                return;
                            }
                        }
                    }
                }

            }
            if (UpdateDataSave())
            {
                //baraction.FindItemByValue("cmdAddVTTH").Visible = false;
                //baraction.FindItemByValue("cmdAddHoaChat").Visible = false;
                //baraction.FindItemByValue("cmdAddMau").Visible = false;
                //baraction.FindItemByValue("cmdAddThuoc").Visible = false;
                //baraction.FindItemByValue("cmdAddXN").Visible = false;
                //baraction.FindItemByValue("cmdSave").Visible = false;
                //baraction.FindItemByValue("cmdPrint").Visible = false;
                PrintData(true, "Thuoc");
                if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) != "0" && HTC.ShareVariables.pub_spC == "HU" && cboHuongDT.SelectedValue != "")
                    PrintVPThanhToanBH();
                // PrintPhieu();
            }
        }
        else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdPrintCD", StringComparison.InvariantCultureIgnoreCase))
        {
            if (UpdateDataSave())
            {
                //baraction.FindItemByValue("cmdAddVTTH").Visible = false;
                //baraction.FindItemByValue("cmdAddHoaChat").Visible = false;
                //baraction.FindItemByValue("cmdAddMau").Visible = false;
                //baraction.FindItemByValue("cmdAddThuoc").Visible = false;
                //baraction.FindItemByValue("cmdAddXN").Visible = false;
                //baraction.FindItemByValue("cmdSave").Visible = false;
                //baraction.FindItemByValue("cmdPrint").Visible = false;
                PrintData(true, "CD");
                if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) != "0" && HTC.ShareVariables.pub_spC == "HU" && cboHuongDT.SelectedValue != "")
                    PrintVPThanhToanBH();
                // PrintPhieu();
            }
        }
        else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdPrintToDieuTri", StringComparison.InvariantCultureIgnoreCase))
        {
            if (UpdateDataSave())
            {
                PrintVPThanhToanBH(true, "ToDieuTri");
            }
        }
        else if (((RadToolBarButton)e.Item).CommandName.Equals("exitcmdPrint", StringComparison.InvariantCultureIgnoreCase))
        {
            //ReportData3 = null;
            //HTCReportViewer1.UnLoadReport();
        }
        else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdAddXN", StringComparison.InvariantCultureIgnoreCase))
        {
            CurrentTabIndex = 1;
            _PubsMaDV = " and isnull(b.machungloai,'')='00002'";
            RadTabStrip1.SelectedIndex = CurrentTabIndex;
            RadMultiPage1.SelectedIndex = CurrentTabIndex;
            txtindextab.Value = CurrentTabIndex.ToString();
            LoadDetails(false, CurrentTabIndex, false);

            grdXNTT.MasterTableView.IsItemInserted = true;
            GridEditableItem editItem = grdXNTT.MasterTableView.GetInsertItem();
            if (editItem != null)
            {
                RadComboBox combo = (RadComboBox)editItem.FindControl("cboMaDichVu");
                if (combo != null)
                {
                    //combo.EnableLoadOnDemand = false;
                    //combo.EnableAutomaticLoadOnDemand = false;
                    combo.EnableLoadOnDemand = true;
                    combo.EnableAutomaticLoadOnDemand = true;
                }
                RadComboBox combote = (RadComboBox)editItem.FindControl("cboDichVu");
                if (combote != null)
                {
                    combote.EnableLoadOnDemand = true;
                    combote.EnableAutomaticLoadOnDemand = true;
                }
            }

            grdXNTT.DataBind();
        }
        else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdAddTT", StringComparison.InvariantCultureIgnoreCase))
        {
            CurrentTabIndex = 1;
            _PubsMaDV = " and isnull(b.machungloai,'')='00004'";
            RadTabStrip1.SelectedIndex = CurrentTabIndex;
            RadMultiPage1.SelectedIndex = CurrentTabIndex;
            txtindextab.Value = CurrentTabIndex.ToString();
            LoadDetails(false, CurrentTabIndex, false);

            grdXNTT.MasterTableView.IsItemInserted = true;
            GridEditableItem editItem = grdXNTT.MasterTableView.GetInsertItem();
            if (editItem != null)
            {
                RadComboBox combo = (RadComboBox)editItem.FindControl("cboMaDichVu");
                if (combo != null)
                {
                    combo.EnableLoadOnDemand = false;
                    combo.EnableAutomaticLoadOnDemand = false;
                }
                RadComboBox combote = (RadComboBox)editItem.FindControl("cboDichVu");
                if (combote != null)
                {
                    combote.EnableLoadOnDemand = true;
                    combote.EnableAutomaticLoadOnDemand = true;
                }
            }

            grdXNTT.DataBind();
        }
        else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdAddCD", StringComparison.InvariantCultureIgnoreCase))
        {
            CurrentTabIndex = 1;
            _PubsMaDV = " and isnull(b.machungloai,'')='00003'";
            RadTabStrip1.SelectedIndex = CurrentTabIndex;
            RadMultiPage1.SelectedIndex = CurrentTabIndex;
            txtindextab.Value = CurrentTabIndex.ToString();
            LoadDetails(false, CurrentTabIndex, false);

            grdXNTT.MasterTableView.IsItemInserted = true;
            GridEditableItem editItem = grdXNTT.MasterTableView.GetInsertItem();
            if (editItem != null)
            {
                RadComboBox combo = (RadComboBox)editItem.FindControl("cboMaDichVu");
                if (combo != null)
                {
                    combo.EnableLoadOnDemand = false;
                    combo.EnableAutomaticLoadOnDemand = false;
                }
                RadComboBox combote = (RadComboBox)editItem.FindControl("cboDichVu");
                if (combote != null)
                {
                    combote.EnableLoadOnDemand = true;
                    combote.EnableAutomaticLoadOnDemand = true;
                }
            }

            grdXNTT.DataBind();
        }
        else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdAddDV", StringComparison.InvariantCultureIgnoreCase))
        {
            CurrentTabIndex = 1;
            _PubsMaDV = " and not (isnull(b.machungloai,'')='00004' or isnull(b.machungloai,'')='00002' or isnull(b.machungloai,'')='00003')";
            RadTabStrip1.SelectedIndex = CurrentTabIndex;
            RadMultiPage1.SelectedIndex = CurrentTabIndex;
            txtindextab.Value = CurrentTabIndex.ToString();
            LoadDetails(false, CurrentTabIndex, false);

            grdXNTT.MasterTableView.IsItemInserted = true;
            GridEditableItem editItem = grdXNTT.MasterTableView.GetInsertItem();
            if (editItem != null)
            {
                RadComboBox combo = (RadComboBox)editItem.FindControl("cboMaDichVu");
                if (combo != null)
                {
                    combo.EnableLoadOnDemand = false;
                    combo.EnableAutomaticLoadOnDemand = false;
                }
                RadComboBox combote = (RadComboBox)editItem.FindControl("cboDichVu");
                if (combote != null)
                {
                    combote.EnableLoadOnDemand = true;
                    combote.EnableAutomaticLoadOnDemand = true;
                }
            }

            grdXNTT.DataBind();
        }
        else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdAddThuoc", StringComparison.InvariantCultureIgnoreCase))
        {

            CurrentTabIndex = 2;
            RadTabStrip1.SelectedIndex = CurrentTabIndex;
            RadMultiPage1.SelectedIndex = CurrentTabIndex;
            txtindextab.Value = CurrentTabIndex.ToString();
            LoadDetails(false, CurrentTabIndex, false);


            grdThuoc.MasterTableView.IsItemInserted = true;
            grdThuoc.DataBind();
        }
        //else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdAddVTTH", StringComparison.InvariantCultureIgnoreCase))
        //{

        //    CurrentTabIndex = 7;
        //    RadTabStrip1.SelectedIndex = CurrentTabIndex;
        //    RadMultiPage1.SelectedIndex = CurrentTabIndex;
        //    txtindextab.Value = CurrentTabIndex.ToString();
        //    LoadDetails(false, CurrentTabIndex, false);


        //    grdVTTH.MasterTableView.IsItemInserted = true;
        //    grdVTTH.DataBind();
        //}
        else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdAddThuocDY", StringComparison.InvariantCultureIgnoreCase))
        {
            if (_KhamBenh_ThuocSD_DY != null)
            {
                if (_KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs.Count > 0 && _KhamBenh_ThuocSD_DY.DATT == 0)
                {
                    _KhamBenh_ThuocSD_DY.SLMua = txtSLThang.Text;
                    _KhamBenh_ThuocSD_DY.SLThang = txtSLThang.Text;
                    _KhamBenh_ThuocSD_DY.LieuDung = txtLieuDungDY.Text;
                    _KhamBenh_ThuocSD_DY.CachDung = txtLuuY.Text;

                    _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.UpdatedTo(_KhamBenh_ThuocSD_DY);
                }
            }
            CurrentTabIndex = 3;
            RadTabStrip1.SelectedIndex = CurrentTabIndex;
            RadMultiPage1.SelectedIndex = CurrentTabIndex;
            txtindextab.Value = CurrentTabIndex.ToString();
            _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
            _KhamBenh_ThuocSD_DY.MaDT = _ThongtinBN.KhamBenh.MaDT;
            LoadDetails(false, CurrentTabIndex, false);

            grdThuocDY.MasterTableView.IsItemInserted = true;
            grdThuocDY.DataBind();
        }
        else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdUpLoad", StringComparison.InvariantCultureIgnoreCase))
        {
            if (fuFileUploader.Visible == true)
            {
                UploadFile();
                fuFileUploader.Visible = false;
            }
            else
                fuFileUploader.Visible = true;
        }

        else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdXemFile", StringComparison.InvariantCultureIgnoreCase))
        {
            Context.Response.Write("<script> language='javascript'>window.open('frmKhamBenh_File.aspx?maba=" + _ThongtinBN.KhamBenh.MaSoKham + "','_newtab');</script>");
        }
    }
    private void UploadFile()
    {
        //try
        //{
        if (fuFileUploader.PostedFile != null && fuFileUploader.PostedFile.ContentLength > 4)
        {
            string fileName = Path.GetFileName(fuFileUploader.PostedFile.FileName);
            string fileExtension = Path.GetExtension(fuFileUploader.PostedFile.FileName);

            //first check if "uploads" folder exist or not, if not create it
            string fileSavePath;//= Server.MapPath("tem");
            //if (!Directory.Exists(fileSavePath))
            //    Directory.CreateDirectory(fileSavePath);
            //    fileSavePath = Server.MapPath("~\\tem\\" + DateTime.Now.Year.ToString("####") + DateTime.Now.Month.ToString());
            // fileSavePath = Server.MapPath("c:\\tem\\" + DateTime.Now.Year.ToString("####") + DateTime.Now.Month.ToString());
            fileSavePath = ThamSo.GetThamSo().thumucluuanh + "\\" + DateTime.Now.Year.ToString() + DateTime.Now.Month.ToString() + "\\PK";
            //if (!Directory.Exists(fileSavePath))
            //    Directory.CreateDirectory(fileSavePath);
            if (!Directory.Exists(fileSavePath))
                Directory.CreateDirectory(fileSavePath);
            //after checking or creating folder it's time to save the file
            //fileSavePath = fileSavePath + "//" + fileName;
            fileSavePath = fileSavePath + "\\" + _ThongtinBN.KhamBenh.MaSoKham + fileName;
            fuFileUploader.PostedFile.SaveAs(fileSavePath);
            // ShowMessage(fileSavePath);
            HTC.Business.NoiTru.BenhAn_File file = HTC.Business.NoiTru.BenhAn_File.NewBenhAn_File();
            // file.DangFile = fileName.LastIndexOf(".doc")>0 ?"word":(fileName.LastIndexOf(".xls")>0?"excel"));
            file.DuongDan = fileName;
            file.DuongDanDD = fileSavePath;
            file.MaBA = _ThongtinBN.KhamBenh.MaSoKham;
            file.STT = 0;
            file.STTKhoa = 0;
            file.MaBN = _MaBN;
            file.MaMay = Pub_sMaMay;
            file.NguoiLap = Pub_sNguoiSD;
            file.ApplyEdit();
            file.Save();
        }
        // }
        //catch (Exception ex)
        //{
        //    ShowMessage ("Không upload file được");
        //}

    }
    protected Boolean UpdateDataSave()
    {
        if (baraction.FindItemByValue("cmdPrintThuoc").Enabled == false || baraction.FindItemByValue("cmdPrintThuoc").Visible == false)
            return true;
        if (CheckFormData() == false)
            return false;
        if (UpdateKhamBenh() == false) return false;
        if (_IsBVYHocCoTruyen == true)
            if (txtSLThangTT.Text != "" && txtSLThangTT.Text != "0")
            {
                Supports_KhamBenh_ThuocSD_DY();

            }

        if (HTC.ShareVariables.pub_spC == "QN")
        {
            foreach (KhamBenh_ThuocSD_DY kb in _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList)
            {
                if (kb.Huy == false && kb.DATT == 0 && kb.Huy == false)
                {
                    foreach (KhamBenh_ThuocSD_DY_C kbc in kb.KhamBenh_ThuocSD_DY_Cs)
                    {
                        if (kbc.Huy == false && (decimal.Parse(kbc.SLMua) * decimal.Parse(kb.SLMua) > kbc.TONCK || decimal.Parse(kbc.SLMua) * decimal.Parse(kb.SLMua) > kbc.TONCKDT))
                        {
                            ShowMessage("Thuốc " + kbc.TenTM + " đã hết tồn");
                            return false;
                        }
                    }
                }
            }
        }
        if (_ThongtinBN.KhamBenh.IsDirty == true)
        {
            _ThongtinBN.KhamBenh.MaMay = Pub_sMaMay;
            _ThongtinBN.KhamBenh.NguoiSD = Pub_sNguoiSD;
        }
        _ThongtinBN.KhamBenh.ApplyEdit(); _ThongtinBN.KhamBenh.ApplyEdit();
        _ThongtinBN.KhamBenh.Save();
        string mss = "";
        try
        {
            //lay danh sach chi dinh
            DataTable dt = GetPACS_Send(_ThongtinBN.KhamBenh.MaSoKham);
            mss += "lay danh sach chi dinh/";
            if (dt != null && dt.Rows.Count > 0)
            {
                mss += "co danh sach chi dinh: " + dt.Rows.Count + "/";
                string sttlist = "";
                for (int i = 0; i < dt.Rows.Count; i++)
                {
                    DateTime d;
                    if (DateTime.TryParse(dt.Rows[i]["NgayDK"].ToString(), out d))
                    {
                        mss += "/NgayDK try parse ";
                        string SoPhieuYeuCau = _ThongtinBN.KhamBenh.MaSoKham + dt.Rows[i]["STT"].ToString();
                        mss += "/NgayDK: " + d.ToString("dd/MM/yyyy");
                        PACSOrder send = sp_PACS_Order(SoPhieuYeuCau, d, d);
                        if (send != null && send.MaSoKham != null && send.MaSoKham.Length > 0)
                        {
                            mss += "/send != null ";
                            if (_PACSPOST.Rows.Count > 0)
                            {
                                string port = _PACSPOST.Rows[0]["port"].ToString();
                                string username = _PACSPOST.Rows[0]["username"].ToString();
                                string password = _PACSPOST.Rows[0]["password"].ToString();
                                //tao ban tin OMI^023^OMI_O23
                                MSH mSH = new MSH();
                                mSH.MSH_7 = d.ToString("yyyyMMddHHmmss");
                                PID pID = new PID();
                                pID.PID_3 = _ThongtinBN.KhamBenh.MaSoKham + "-" + dt.Rows[i]["STT"].ToString() + "^" + _ThongtinBN.KhamBenh.MaBN;
                                pID.PID_5 = _ThongtinBN.Hoten;
                                pID.PID_7 = DateTime.Parse(_ThongtinBN.NgaySinh).ToString("yyyymmdd");
                                pID.PID_8 = (lblGioitinh.Items[0].Selected == true ? " M" : "F");
                                pID.PID_11 = txtDiaChi.Text;
                                pID.PID_13 = "^" + _ThongtinBN.DienThoai;
                                PV1 pV1 = new PV1();
                                pV1.PV1_2 = "O";
                                pV1.PV1_32 = send.sophong;
                                pV1.PV1_33 = send.sogiuong;
                                pV1.PV1_39 = dt.Rows[i]["MaKhoaCD"].ToString() + "^" + dt.Rows[i]["tenkhoa"].ToString();
                                IN1 iN1 = new IN1();
                                if (_ThongtinBN.MaDT.StartsWith("1"))
                                {
                                    iN1.IN1_2 = send.sothebhyt;
                                    iN1.IN1_3 = "BHYT";
                                }
                                ORC oRC = new ORC();
                                oRC.ORC_1 = "NW";
                                oRC.ORC_2 = send.MaSo;
                                oRC.ORC_31 = dt.Rows[i]["MaKhoaTH"].ToString();
                                oRC.ORC_32 = dt.Rows[i]["TenKhoaTH"].ToString();
                                oRC.ORC_5 = "CM";
                                oRC.ORC_15 = DateTime.Now.ToString("yyyyMMddHHmmss");
                                oRC.ORC_27 = d.ToString("yyyyMMddHHmmss");
                                oRC.ORC_29 = "O";
                                OBR oBR = new OBR();
                                oBR.OBR_2 = send.MaSo;
                                oBR.OBR_31 = dt.Rows[i]["MaKhoaTH"].ToString();
                                oBR.OBR_32 = dt.Rows[i]["TenKhoaTH"].ToString();
                                oBR.OBR_41 = send.MADICHVU;
                                oBR.OBR_42 = send.tendv;
                                oBR.OBR_13 = send.ChanDoan;
                                //WriteLog("Pub_sNguoiSD: " + Pub_sNguoiSD);
                                oBR.OBR_161 = Pub_sNguoiSD;
                                oBR.OBR_162 = Pub_sTenNguoiSD;
                                oBR.OBR_18 = dt.Rows[i]["MaKhoaCD"].ToString();
                                oBR.OBR_20 = dt.Rows[i]["MaKhoaTH"].ToString();
                                oBR.OBR_24 = send.MaNhomDichVu;
                                string sends = mSH.GetString() + "\r" + pID.GetString() + "\r" + pV1.GetString() + "\r" + iN1.GetString() + "\r" + oRC.GetString() + "\r" + oBR.GetString();
                                mss += "/sends: sends";
                                mes mes = new mes();
                                mes.message = sends;
                                string xau = PostOrder(port, username, password, mes);
                                mss += "/xau: " + xau;
                                sttlist += dt.Rows[i]["STT"].ToString() + ",";
                                //_BenhAn_C.dalaymau = true;
                                //_BenhAn_C_List.UpdatedTo(_BenhAn_C);
                                //_BenhAn_C_List.ApplyEdit();
                                //_BenhAn_C_List.Save();
                            }
                            mss += "/PostOrder";
                        }
                    }
                }
                if (sttlist.Length > 0)
                {
                    sttlist = sttlist.Substring(0, sttlist.Length - 1);
                    mss += "/spKhamBenh_C_GetPACS_Send_Update: masokham: " + _ThongtinBN.KhamBenh.MaSoKham + " sttlist: " + sttlist;
                    spKhamBenh_C_GetPACS_Send_Update(_ThongtinBN.KhamBenh.MaSoKham, sttlist);
                    mss += "/update xong!";
                }
            }
        }
        catch (Exception ex)
        {
            WriteLog("day chi dinh sang PACS loi: " + mss + " " + ex.ToString());
        }
        //chi dinh huy
        try
        {
            //lay danh sach chi dinh
            DataTable dt = GetPACS_SendHuy(_ThongtinBN.KhamBenh.MaSoKham);
            mss += "lay danh sach chi dinh/";
            if (dt != null && dt.Rows.Count > 0)
            {
                DataTable _PACSPOSTHuy = GetPort1("PostOrderHuy");
                mss += "co danh sach chi dinh: " + dt.Rows.Count + "/";
                //string sttlist = "";
                for (int i = 0; i < dt.Rows.Count; i++)
                {
                    DateTime d;
                    if (DateTime.TryParse(dt.Rows[i]["NgayDK"].ToString(), out d))
                    {
                        mss += "/NgayDK try parse ";
                        string SoPhieuYeuCau = _ThongtinBN.KhamBenh.MaSoKham + dt.Rows[i]["STT"].ToString();
                        mss += "/NgayDK: " + d.ToString("dd/MM/yyyy");
                        PACSOrder send = sp_PACS_OrderHuy(SoPhieuYeuCau, d, d);
                        if (send != null && send.MaSoKham != null && send.MaSoKham.Length > 0)
                        {
                            mss += "/send != null ";
                            if (_PACSPOSTHuy.Rows.Count > 0)
                            {
                                string port = _PACSPOSTHuy.Rows[0]["port"].ToString();
                                string username = _PACSPOSTHuy.Rows[0]["username"].ToString();
                                string password = _PACSPOSTHuy.Rows[0]["password"].ToString();
                                //tao ban tin OMI^023^OMI_O23
                                MSH mSH = new MSH();
                                mSH.MSH_7 = d.ToString("yyyyMMddHHmmss");
                                PID pID = new PID();
                                pID.PID_3 = _ThongtinBN.KhamBenh.MaSoKham + "-" + dt.Rows[i]["STT"].ToString() + "^" + _ThongtinBN.KhamBenh.MaBN;
                                pID.PID_5 = _ThongtinBN.Hoten;
                                pID.PID_7 = DateTime.Parse(_ThongtinBN.NgaySinh).ToString("yyyymmdd");
                                pID.PID_8 = (lblGioitinh.Items[0].Selected == true ? " M" : "F");
                                pID.PID_11 = txtDiaChi.Text;
                                pID.PID_13 = "^" + _ThongtinBN.DienThoai;
                                PV1 pV1 = new PV1();
                                pV1.PV1_2 = "O";
                                pV1.PV1_32 = send.sophong;
                                pV1.PV1_33 = send.sogiuong;
                                pV1.PV1_39 = dt.Rows[i]["MaKhoaCD"].ToString() + "^" + dt.Rows[i]["tenkhoa"].ToString();
                                IN1 iN1 = new IN1();
                                if (_ThongtinBN.MaDT.StartsWith("1"))
                                {
                                    iN1.IN1_2 = send.sothebhyt;
                                    iN1.IN1_3 = "BHYT";
                                }
                                ORC oRC = new ORC();
                                oRC.ORC_1 = "CA";
                                oRC.ORC_2 = send.MaSo;
                                oRC.ORC_31 = dt.Rows[i]["MaKhoaTH"].ToString();
                                oRC.ORC_32 = dt.Rows[i]["TenKhoaTH"].ToString();
                                oRC.ORC_5 = "CA";
                                oRC.ORC_15 = DateTime.Now.ToString("yyyyMMddHHmmss");
                                oRC.ORC_27 = d.ToString("yyyyMMddHHmmss");
                                oRC.ORC_29 = "O";
                                OBR oBR = new OBR();
                                oBR.OBR_2 = send.MaSo;
                                oBR.OBR_31 = dt.Rows[i]["MaKhoaTH"].ToString();
                                oBR.OBR_32 = dt.Rows[i]["TenKhoaTH"].ToString();
                                oBR.OBR_41 = send.MADICHVU;
                                oBR.OBR_42 = send.tendv;
                                oBR.OBR_13 = send.ChanDoan;
                                //WriteLog("Pub_sNguoiSD: "+ Pub_sNguoiSD);
                                oBR.OBR_161 = Pub_sNguoiSD;
                                oBR.OBR_162 = Pub_sTenNguoiSD;
                                oBR.OBR_18 = dt.Rows[i]["MaKhoaCD"].ToString();
                                oBR.OBR_20 = dt.Rows[i]["MaKhoaTH"].ToString();
                                oBR.OBR_24 = send.MaNhomDichVu;
                                //string sends = mSH.GetString() + pID.GetString() + pV1.GetString() + iN1.GetString() + oRC.GetString() + oBR.GetString();
                                string sends = mSH.GetString() + "\r" + pID.GetString() + "\r" + pV1.GetString() + "\r" + iN1.GetString() + "\r" + oRC.GetString() + "\r" + oBR.GetString();
                                mss += "/sends: sends";
                                mes mes = new mes();
                                mes.message = sends;
                                string xau = PostOrder(port, username, password, mes);
                                mss += "/xau: " + xau;
                            }
                            mss += "/PostOrder";
                        }
                    }
                }
                //if (sttlist.Length > 0)
                //{
                //    sttlist = sttlist.Substring(0, sttlist.Length - 1);
                //    mss += "/spKhamBenh_C_GetPACS_Send_Update: masokham: " + _ThongtinBN.KhamBenh.MaSoKham + " sttlist: " + sttlist;
                //    spKhamBenh_C_GetPACS_Send_Update(_ThongtinBN.KhamBenh.MaSoKham, sttlist);
                //    mss += "/update xong!";
                //}
            }
        }
        catch (Exception ex)
        {
            WriteLog("day chi dinh huy sang PACS loi: " + mss + " " + ex.ToString());
        }
        _KhamBenh_Noi.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
        _KhamBenh_Noi.MaMay = Pub_sMaMay;
        _KhamBenh_Noi.NguoiSD = Pub_sNguoiSD;
        _KhamBenh_Noi.ApplyEdit(); _ThongtinBN.KhamBenh.ApplyEdit();
        _KhamBenh_Noi.Save();
        txtupdate.Value = "1";
        if (_KhamBenh_KeNgoaiList != null)
        {
            if (_KhamBenh_KeNgoaiList.Count > 0)
                if (_KhamBenh_KeNgoaiList[0].MaSoKham == "")
                    foreach (KhamBenh_KeNgoai kb in _KhamBenh_KeNgoaiList)
                    {
                        kb.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                        kb.MaBN = _ThongtinBN.MaBN;

                    }
            _KhamBenh_KeNgoaiList.ApplyEdit(); _ThongtinBN.KhamBenh.ApplyEdit();
            _KhamBenh_KeNgoaiList.Save();
        }
        return true;
    }
    protected void RadTabStrip1_TabClick(object sender, RadTabStripEventArgs e)
    {
        CurrentTabIndex = RadTabStrip1.SelectedIndex;
        RadMultiPage1.SelectedIndex = CurrentTabIndex;
        txtindextab.Value = CurrentTabIndex.ToString();
        LoadDetails(false, CurrentTabIndex, false);


        switch (CurrentTabIndex)
        {

            case 1:
                {
                    if ((txtChanDoan.Text == "") || cboNhanVien.SelectedValue == "")
                    {
                        ShowMessage("Chưa có bác sỹ chỉ định hoặc chẩn đoán");
                    }
                    grdXNTT.MasterTableView.IsItemInserted = true;
                    GridEditableItem editItem = grdXNTT.MasterTableView.GetInsertItem();
                    if (editItem != null)
                    {
                        RadComboBox combo = (RadComboBox)editItem.FindControl("cboMaDichVu");
                        if (combo != null)
                        {
                            combo.EnableLoadOnDemand = false;
                            combo.EnableAutomaticLoadOnDemand = false;
                        }
                        RadComboBox combote = (RadComboBox)editItem.FindControl("cboDichVu");
                        if (combote != null)
                        {
                            combote.EnableLoadOnDemand = true;
                            combote.EnableAutomaticLoadOnDemand = true;
                        }
                    }

                    grdXNTT.DataBind();


                    break;
                }
            case 2:
                {
                    if ((txtChanDoan.Text == "") || cboNhanVien.SelectedValue == "")
                    {
                        ShowMessage("Chưa có bác sỹ chỉ định hoặc chẩn đoán");
                    }
                    grdThuoc.MasterTableView.IsItemInserted = true;
                    grdThuoc.DataBind();

                    break;
                }
            //case 7:
            //    {
            //        if ((txtChanDoan.Text == "") || cboNhanVien.SelectedValue == "")
            //        {
            //            ShowMessage("Chưa có bác sỹ chỉ định hoặc chẩn đoán");
            //        }
            //        grdVTTH.MasterTableView.IsItemInserted = true;
            //        grdVTTH.DataBind();

            //        break;
            //    }
            case 3:
                {
                    if ((txtChanDoan.Text == "") || cboNhanVien.SelectedValue == "")
                    {
                        ShowMessage("Chưa có bác sỹ chỉ định hoặc chẩn đoán");
                    }
                    grdThuocDY.MasterTableView.IsItemInserted = true;
                    grdThuocDY.DataBind();
                    break;
                }
            case 6:
                {
                    grdKeNgoai.MasterTableView.IsItemInserted = true;
                    grdKeNgoai.DataBind();
                    break;
                }
        }
    }

    protected void grdDichVu_NeedDataSource(object sender, GridNeedDataSourceEventArgs e)
    {

        grdXNTT.DataSource = null;
        grdThuocDY.DataSource = null;
        grdThuoc.DataSource = null;
        // grdVTTH.DataSource = null;
        grdDanhSachDY.DataSource = null;
        grdKQXN.DataSource = null;
        grdDSDieuTri.DataSource = null;
        grdChiTietDichVu.DataSource = null;


        switch (CurrentTabIndex)
        {
            case 1: //xn
                {

                    grdXNTT.DataSource = _ThongtinBN.KhamBenh.KhamBenh_C_List;

                    break;

                }
            case 2: //thuoc
                {
                    grdThuoc.DataSource = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList;


                    break;

                }
            //case 7: //vtth
            //    {
            //        grdVTTH.DataSource = _ThongtinBN.KhamBenh.KhamBenh_VTTHList;


            //        break;

            //    }
            case 3: //thuoc dy
                {

                    grdDanhSachDY.DataSource = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList;

                    if (_KhamBenh_ThuocSD_DY != null)
                    {
                        grdThuocDY.DataSource = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
                    }

                    break;
                }
            case 5: //ket qua
                {

                    grdKQXN.DataSource = _ThongtinBN.KhamBenh.KhamBenh_XN_GetsList;

                    break;
                }
        }

    }


    private bool CheckFormData()
    {
        if (txtMach.Text != "")
        {
            try
            {

                if (byte.Parse(txtMach.Text) > byte.Parse("200"))
                {
                    ShowMessage("Định dạng mạch sai (0-200)");
                    return false;

                }

            }
            catch (Exception ex)
            {
                ShowMessage("Định dạng mạch sai (0-200)" + ex.Message);
                return false;
                //throw;
            }
        }
        if (txtCanNang.Text != "")
        {
            try
            {

                if (int.Parse(txtCanNang.Text) > int.Parse("400"))
                {
                    ShowMessage("Định dạng cân nặng sai");
                    return false;

                }

            }
            catch (Exception ex)
            {
                ShowMessage("Định dạng cân nặng sai" + ex.Message);
                return false;
                //throw;
            }
        }
        if (txtNhiptho.Text != "")
        {
            try
            {

                if (byte.Parse(txtNhiptho.Text) > byte.Parse("50"))
                {
                    ShowMessage("Định dạng nhịp thở sai(0-50)");
                    return false;

                }

            }
            catch (Exception ex)
            {
                ShowMessage("Định dạng nhịp thở sai(0-50)" + ex.Message);
                return false;
                //throw;
            }
        }
        if (txtNhietdo.Text != "")
        {
            try
            {

                if (decimal.Parse(txtNhietdo.Text) > int.Parse("45") || decimal.Parse(txtNhietdo.Text) < int.Parse("35"))
                {
                    ShowMessage("Định dạng nhiệt độ sai(35-45)");
                    return false;

                }

            }
            catch (Exception ex)
            {
                ShowMessage("Định dạng nhiệt độ sai(35-45)" + ex.Message);
                return false;
                //throw;
            }
        }
        if (txtChieuCao.Text != "")
        {
            try
            {

                if (int.Parse(txtChieuCao.Text) > int.Parse("250") || int.Parse(txtChieuCao.Text) < int.Parse("0"))
                {
                    ShowMessage("Định dạng chiều cao sai");
                    return false;

                }

            }
            catch (Exception ex)
            {
                ShowMessage("Định dạng chiều cao sai" + ex.Message);
                return false;
                //throw;
            }
        }
        if (txtHuyetapmin.Text == "" && txtHuyetapmax.Text == "")
            txtHuyetap.Text = "";
        else if (txtHuyetapmin.Text == "" || txtHuyetapmax.Text == "")
        {
            ShowMessage("Chưa nhập huyết áp");
            return false;
        }
        else
            txtHuyetap.Text = txtHuyetapmin.Text + "/" + txtHuyetapmax.Text;
        if (txtHuyetap.Text != "")
        {
            try
            {
                int i = txtHuyetap.Text.LastIndexOf("/");
                if (i < 2)
                {
                    ShowMessage("Định dạng huyết áp sai(19-300)");
                    return false;
                }

                string t = txtHuyetap.Text.Substring(0, i);

                if (int.Parse(t) < int.Parse("20"))
                {
                    ShowMessage("Định dạng huyết áp sai(19-300)");
                    return false;

                }
                t = txtHuyetap.Text.Substring(i + 1);

                if (int.Parse(t) > int.Parse("300"))
                {
                    ShowMessage("Định dạng huyết áp sai(19-300)");
                    return false;

                }
            }
            catch (Exception ex)
            {
                ShowMessage("Định dạng huyết áp sai(19-300)" + ex.Message);
                return false;
                //throw;
            }
        }

        if (cboNhanVien.SelectedValue == null || cboNhanVien.SelectedValue == "")
        {
            ShowMessage("Chưa nhập bác sỹ điều trị!");
            return false;
        }
        if (txtChanDoan.Text == "")
        {

            ShowMessage("Chưa nhập chẩn đoán điều trị!");
            return false;

        }
        if (txtChanDoan.Text == "")
        {
            if (cboHuongDT.SelectedValue != "00005")
            {
                ShowMessage("Chưa nhập chẩn đoán điều trị!");
                return false;
            }
        }
        if (cboChanDoan.SelectedValue == "")
        {
            if (cboHuongDT.SelectedValue != "" && cboHuongDT.SelectedValue != "00005")
            {
                ShowMessage("Chưa nhập chẩn đoán điều trị!");
                return false;
            }
        }
        if (cboChanDoan.SelectedValue == "" && (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 1 || _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count >= 1) && _ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "1")
        {
            ShowMessage("Chưa nhập mã chẩn đoán điều trị!");
            return false;
        }
        if (cboChanDoan.SelectedValue == "" && (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 1 || _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count >= 1))
        {
            ShowMessage("Chưa nhập mã chẩn đoán điều trị!");
            return false;
        }
        if (cboChanDoan.SelectedValue == "00006" && HTC.ShareVariables.pub_spC == "YH" && _ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "1")
        {
            if (_ThongtinBN.KhamBenh.KhamBenh_C_List[0].DaTTBH != 0)
            {
                ShowMessage("Bệnh nhân đã thanh toán dịch vụ không thể cho vào viện");
                return false;
            }
        }
        if ((cboHuongDT.SelectedValue == "00005" || cboHuongDT.SelectedValue == "00006") && cboKhoaNV.SelectedValue == "")
        {
            ShowMessage("Chưa nhập khoa, phòng");
            return false;
        }
        try
        {

        }
        catch (Exception ex)
        {
            ShowMessage("'Đến ngày' phải là kiểu ngày tháng!");
            return false;
        }





        return true;
    }

    public void comboDataBoundKeNgoai(object sender, RadComboBoxItemEventArgs e)
    {


        DMThuoc_Ke dataItem = e.Item.DataItem as DMThuoc_Ke;

        if (dataItem == null)
            e.Item.Attributes["TenDVT"] = "";
        else
            e.Item.Attributes["TenDVT"] = dataItem.tendvt.ToString();



    }

    public void comboDataBound(object sender, RadComboBoxItemEventArgs e)
    {
        RadGrid grid = null;
        try
        {
            grid = (RadGrid)(((RadComboBox)sender).Parent.Parent.Parent.Parent.Parent.Parent);
        }
        catch
        {
            grid = (RadGrid)(((RadComboBox)sender).Parent.Parent.Parent.Parent.Parent);

        }
        if (grid.Equals(grdThuoc) || grid.Equals(grdThuocDY))
        {
            DMThuocKhoa dataItem = e.Item.DataItem as DMThuocKhoa;

            if (dataItem == null)
                e.Item.Attributes["tendvt"] = "";
            else
                e.Item.Attributes["tendvt"] = dataItem.TenDVT.ToString();

            if (dataItem == null)
                e.Item.Attributes["DongiaTT"] = "";
            else
                e.Item.Attributes["DongiaTT"] = dataItem.DonGiaD.ToString();

            if (dataItem == null)
                e.Item.Attributes["DongiaBH"] = "";
            else
                e.Item.Attributes["DongiaBH"] = dataItem.DonGiaBHD.ToString();
            if (dataItem == null)
                e.Item.Attributes["BHTinhTien"] = "";
            else
                e.Item.Attributes["BHTinhTien"] = dataItem.DTBH.ToString();


        }
        else if (grid.Equals(grdXNTT))
        {
            DMDichVu_Gia_DT dataItem = e.Item.DataItem as DMDichVu_Gia_DT;


            if (dataItem == null)
                e.Item.Attributes["DongiaTT"] = "";
            else
                e.Item.Attributes["DongiaTT"] = dataItem.dongiatt.ToString();


            if (dataItem == null)
                e.Item.Attributes["DongiaBH"] = "";
            else
                e.Item.Attributes["DongiaBH"] = dataItem.Dongia.ToString();
            if (dataItem == null)
                e.Item.Attributes["DongiaBH"] = "";
            else
                e.Item.Attributes["DongiaCL"] = dataItem.GiaChenhlenh.ToString();
            if (dataItem == null)
                e.Item.Attributes["BHTinhTien"] = "";
            else
                e.Item.Attributes["BHTinhTien"] = dataItem.DTBH.ToString();
            if (dataItem == null)
                e.Item.Attributes["NhapSL"] = "";
            else
                e.Item.Attributes["NhapSL"] = dataItem.nhapsl.ToString();
            //CheckBox chkBox = (CheckBox)e.Item.FindControl("chkChon");
            //chkBox.Attributes.Add("onclick", "clicked_chkBox('" + dataItem.MaDV + "')");
        }


    }


    private bool UpdateKhamBenh()
    {

        if (!CheckFormData()) return false;
        else
        {
            if (_ThongtinBN != null)
            {
                _ThongtinBN.TienSuThuoc = _ThongtinBN.TienSuThuoc == txtDiungthuoc.Text ? _ThongtinBN.TienSuThuoc : txtDiungthuoc.Text;
                _ThongtinBN.TienSu = _ThongtinBN.TienSu == txtTiensubenh.Text ? _ThongtinBN.TienSu : txtTiensubenh.Text;
                _ThongtinBN.TienSuGiaDinh = _ThongtinBN.TienSuGiaDinh == txtTiensugiadinh.Text ? _ThongtinBN.TienSuGiaDinh : txtTiensugiadinh.Text;

            }
            string sql = " update thongtinbn set   TienSu = N'" + _ThongtinBN.TienSu + "', TienSugiadinh = N'" + _ThongtinBN.TienSuGiaDinh + "', NhomMau= '" + cboNhomMau.SelectedValue + "'";
            sql = sql + "  ,TienSuThuoc =N'" + txtDiungthuoc.Text + "' where mabn ='" + _MaBN + "'";

            HTC.Business.DataProvider.Instance().ExcSQL(sql);
            //KhamBenh_Noi _KhamBenh_Noi;
            KhamBenh_C _KhamBenh_KB = _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(X => X.STT == _STT);

            //if (_KhamBenh_KB.KhamBenh_NoiList.Count > 0)
            //    _KhamBenh_Noi = _KhamBenh_Noi;
            //else
            //    _KhamBenh_Noi = _KhamBenh_KB.KhamBenh_NoiList.NewTo();

            if (_KhamBenh_KB != null && HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ ")
            {
                if (_KhamBenh_KB.MaHuongDT == "00006" && pub_bQadmin == false)
                {
                    ShowMessage("Bệnh nhân đã vào viện!Không thể sửa , xóa dịch vụ");
                    return false;
                }
                if ((cboHuongDT.SelectedValue == "00007" || cboHuongDT.SelectedValue == "00017") && cboBVChuyen.SelectedValue == "")
                {
                    ShowMessage("Chưa nhập bệnh viện chuyển đi");
                    return false;
                }
            }
            if (_KhamBenh_Noi != null)
            {
                if (_KhamBenh_Noi.NgayKham == "")
                    _KhamBenh_Noi.NgayKham = DateTime.Now.ToString();
                _KhamBenh_Noi.MaDV = _KhamBenh_KB.MaDV;
                _KhamBenh_Noi.STT = _KhamBenh_KB.STT;

                _KhamBenh_Noi.Rubella = chkRubella.Checked;
                _KhamBenh_Noi.UonVan = chkUonVan.Checked;
                _KhamBenh_Noi.TiemChungKhac = chkTiemChungKhac.Checked;
                _KhamBenh_Noi.Mach = txtMach.Text;
                _KhamBenh_Noi.ApHuyet = txtHuyetap.Text;
                _KhamBenh_Noi.NhietDo = txtNhietdo.Text;
                _KhamBenh_Noi.NhipTho = txtNhiptho.Text;
                _KhamBenh_Noi.ChieuCao = txtChieuCao.Text;
                _KhamBenh_Noi.CanNang = txtCanNang.Text;
                _KhamBenh_Noi.HuongDT = txtLoidan.Text;
                _KhamBenh_Noi.MaMay = Pub_sMaMay;
                _KhamBenh_Noi.NguoiSD = Pub_sNguoiSD;
                _KhamBenh_Noi.DieuTri = txtLoidan.Text;
                _KhamBenh_Noi.BenhSu = txtbenhly.Text;
                _KhamBenh_Noi.LyDoKham = txtlydo.Text;
                _KhamBenh_Noi.ToanThan = txtToanthan.Text;
                _KhamBenh_Noi.HoHap = txtHohap.Text;
                _KhamBenh_Noi.TieuHoa = txtTieuHoa.Text;
                _KhamBenh_Noi.XuongKhop = txtCoxuongkhop.Text;
                _KhamBenh_Noi.ThanTNieuSDuc = txtThan.Text;
                _KhamBenh_Noi.TuanHoan = txttuanhoan.Text;
                _KhamBenh_Noi.RangHamMat = txtrhm.Text;
                _KhamBenh_Noi.TaiMuiHong = txttmh.Text;
                _KhamBenh_Noi.Mat = txtmat.Text;
                _KhamBenh_Noi.ThanKinh = txtthankinh.Text;
                _KhamBenh_Noi.BenhLyKhac = txtkhac.Text;
                _KhamBenh_Noi.HuongDT = txtXutri.Text;
                _KhamBenh_Noi.Noitiet = txtnoitiet.Text;
                _KhamBenh_Noi.BSKHAM = cboNhanVien.SelectedValue;
                if (_KhamBenh_Noi.TenBenh == "")
                {
                    _KhamBenh_Noi.Mabenh = cboChanDoan.SelectedValue == "" ? cboChanDoan.Text : cboChanDoan.SelectedValue;
                    _KhamBenh_Noi.TenBenh = txtChanDoan.Text;
                    _KhamBenh_Noi.MaBenhKem = cboChanDoanKem.SelectedValue == "" ? cboChanDoanKem.Text : cboChanDoanKem.SelectedValue;
                    _KhamBenh_Noi.TenBenhKem = txtChanDoanKem.Text;
                }
            }

            //if ((_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count > 0 ) && (cboHuongDT.SelectedValue == null || cboHuongDT.SelectedValue == ""))
            //    cboHuongDT.SelectedValue = "00001";

            if (cboHuongDT.SelectedValue != null && cboHuongDT.SelectedValue != "")
                _KhamBenh_KB.MaHuongDT = cboHuongDT.SelectedValue;
            //_KhamBenh_KB.Machuyenkhoa = cboChuyenKhoa.SelectedValue;
            switch (cboHuongDT.SelectedValue)
            {
                case "00002":// dieu tri theo hen
                    {
                        _KhamBenh_KB.ngayhen = dtNgayHen.Text;
                        break;
                    }
                case "00007":
                case "00017":
                case "00107":
                case "10007":
                case "20007":
                case "30007":
                case "40007": // chuyen vien
                    {
                        _KhamBenh_Noi.MaBV = cboBVChuyen.SelectedValue;
                        break;
                    }
                case "00005": // chuyen phong
                    {
                        _KhamBenh_KB.Makhoa = cboKhoaNV.SelectedValue;
                        break;
                    }
                case "00006": // nhap vien
                case "00003": // dieu tri ngoai tru
                    {
                        _KhamBenh_KB.MakhoaVV = cboKhoaNV.SelectedValue;
                        _KhamBenh_KB.MakhoaChoVV = _MaKhoa;
                        _KhamBenh_KB.NgayGioVV = DateTime.Now.ToString();

                        break;
                    }

            }
            if (_KhamBenh_KB.SoTT != 0)
            {
                _KhamBenh_KB.SoTTCu = _KhamBenh_KB.SoTT;
                _KhamBenh_KB.SoTT = 0;
            }
            _KhamBenh_KB.MaBS = _KhamBenh_KB.MaBS == "" ? cboNhanVien.SelectedValue : _KhamBenh_KB.MaBS;
            _KhamBenh_KB.bschidinh = _KhamBenh_KB.BSKham;

            _KhamBenh_KB.Mabenh = cboChanDoan.SelectedValue == "" ? cboChanDoan.Text : cboChanDoan.SelectedValue;
            _KhamBenh_KB.tenbenh = txtChanDoan.Text;
            _KhamBenh_KB.MabenhKem = cboChanDoanKem.SelectedValue == "" ? cboChanDoanKem.Text : cboChanDoanKem.SelectedValue;
            _KhamBenh_KB.tenbenhKem = txtChanDoanKem.Text;
            _KhamBenh_KB.MabenhKem = cboChanDoanKem.SelectedValue == "" ? cboChanDoanKem.Text : cboChanDoanKem.SelectedValue;
            _KhamBenh_KB.tenbenhKem = txtChanDoanKem.Text;
            //_KhamBenh_KB.MabenhKem2 = cboChanDoanKem2.SelectedValue == "" ? cboChanDoanKem2.Text : cboChanDoanKem2.SelectedValue;
            //_KhamBenh_KB.tenbenhKem2 = txtChanDoanKem2.Text;
            //_KhamBenh_KB.MabenhKem3 = cboChanDoanKem3.SelectedValue == "" ? cboChanDoanKem3.Text : cboChanDoanKem3.SelectedValue;
            //_KhamBenh_KB.tenbenhKem3 = txtChanDoanKem3.Text;
            //_KhamBenh_KB.maicdKem2 = cboChanDoanKem2.Text;
            //_KhamBenh_KB.maicdKem3 = cboChanDoanKem3.Text;
            if (_KhamBenh_KB.NgayGioKham == "")
                _KhamBenh_KB.NgayGioKham = DateTime.Now.ToString();

            if (_KhamBenh_KB.NgayKT == "" && _KhamBenh_KB.MaHuongDT != "")
                _KhamBenh_KB.NgayKT = DateTime.Now.ToString();

            _KhamBenh_KB.BSKham = cboNhanVien.SelectedValue;
            _KhamBenh_KB.Sophong = _KhamBenh_KB.Sophong == "" ? _KhamBenh_KB.Makhoa : _KhamBenh_KB.Sophong;

            if (_KhamBenh_Noi.IsNew == true)
            {
                _KhamBenh_Noi.MaMay = Pub_sMaMay;
                _KhamBenh_Noi.NguoiSD = Pub_sNguoiSD;
                //  _KhamBenh_KB.KhamBenh_NoiList.NewTo(_KhamBenh_Noi);
            }
            else if (_KhamBenh_Noi.IsDirty == true)
            {
                _KhamBenh_Noi.MaMay = Pub_sMaMay;
                _KhamBenh_Noi.NguoiSD = Pub_sNguoiSD;
                //  _KhamBenh_KB.KhamBenh_NoiList.UpdatedTo(_KhamBenh_Noi);

            }
            if (_KhamBenh_KB.IsNew == true)
            {
                _KhamBenh_KB.MaMay = Pub_sMaMay;
                _KhamBenh_KB.NguoiSD = Pub_sNguoiSD;
                _ThongtinBN.KhamBenh.KhamBenh_C_List.NewTo(_KhamBenh_KB);

            }
            else if (_KhamBenh_KB.IsDirty == true)
            {
                _KhamBenh_KB.MaMay = Pub_sMaMay;
                _KhamBenh_KB.NguoiSD = Pub_sNguoiSD;
                _ThongtinBN.KhamBenh.KhamBenh_C_List.UpdatedTo(_KhamBenh_KB);

            }

            foreach (KhamBenh_C _KhamBenh_C in _ThongtinBN.KhamBenh.KhamBenh_C_List)
            {
                if (_KhamBenh_C.tenbenh == "")
                {
                    _KhamBenh_C.maicd = cboChanDoan.Text;
                    _KhamBenh_C.Mabenh = cboChanDoan.SelectedValue;
                    _KhamBenh_C.tenbenh = txtChanDoan.Text;

                    _KhamBenh_C.maicdKem = cboChanDoanKem.Text;
                    _KhamBenh_C.MabenhKem = cboChanDoanKem.SelectedValue;
                    _KhamBenh_C.tenbenhKem = txtChanDoanKem.Text;
                    //_KhamBenh_C.maicdKem2 = cboChanDoanKem2.Text;
                    //_KhamBenh_C.MabenhKem2 = cboChanDoanKem2.SelectedValue;
                    //_KhamBenh_C.tenbenhKem2 = txtChanDoanKem2.Text;
                    //_KhamBenh_C.maicdKem3 = cboChanDoanKem3.Text;
                    //_KhamBenh_C.MabenhKem3 = cboChanDoanKem3.SelectedValue;
                    //_KhamBenh_C.tenbenhKem3 = txtChanDoanKem3.Text;
                }
            }
        }
        return true;
    }
    private bool UpdateDataThuoc(GridEditableItem editedItem, FormAction action)
    {
        string maThuoc = string.Empty;

        try
        {
            KhamBenh_ThuocSD _KhamBenh_ThuocSD;
            if (action == FormAction.INSERT)
                _KhamBenh_ThuocSD = KhamBenh_ThuocSD.NewKhamBenh_ThuocSD();
            else
            {
                int STT = int.Parse(editedItem.GetDataKeyValue("STT").ToString());

                _KhamBenh_ThuocSD = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.FirstOrDefault(X => X.STT == STT);
            }
            if (action != FormAction.DELETE)
            {
                _KhamBenh_ThuocSD.MaSoKham = _MaSoKham;
                _KhamBenh_ThuocSD.Makhoa = _MaKhoa;
                _KhamBenh_ThuocSD.MaBN = _MaBN;


                if (!CheckFormData()) return false;
                else
                {

                    string soLuong = ((RadNumericTextBox)editedItem["SoLuongD"].FindControl("tbSoLuong")).Text;
                    string sothuoc = ((TextBox)editedItem["sothuoc"].Controls[0]).Text;
                    string lieuluong = ((TextBox)editedItem["lieuluong"].Controls[0]).Text;

                    string cachDungTT = ((TextBox)editedItem["CachDungTT"].Controls[0]).Text;
                    string duongdung = ((TextBox)editedItem["duongdung"].Controls[0]).Text;
                    string dvt = ((TextBox)editedItem["dvt"].Controls[0]).Text;

                    //string LieuDung = ((RadComboBox )editedItem["LieuDung"].FindControl ("cboLieuDung")).Text ;
                    //string cachDung = ((RadComboBox)editedItem["CachDung"].FindControl("cboCachDung")).Text;
                    Boolean tinhtien = ((CheckBox)editedItem["TinhTien"].Controls[0]).Checked;
                    Boolean dadung = ((CheckBox)editedItem["DaDung"].Controls[0]).Checked;

                    if (soLuong == "" || soLuong == null || soLuong == "0")
                    {
                        ShowMessage("Chưa nhập số lượng");
                        ((RadNumericTextBox)editedItem["SoLuongD"].FindControl("tbSoLuong")).Focus();
                        return false;
                    };


                    if (decimal.Parse(soLuong) < 0)
                    {
                        ShowMessage("Số lượng định dạng sai");
                        ((RadNumericTextBox)editedItem["SoLuongD"].FindControl("tbSoLuong")).Focus();

                        return false;
                    };
                    if (action != FormAction.DELETE)
                    {
                        _KhamBenh_ThuocSD.NgayDK = _NgayDK;

                        _KhamBenh_ThuocSD.NguoiSD = Pub_sNguoiSD;
                        _KhamBenh_ThuocSD.dadung = dadung;

                        ////   =============================================

                        _KhamBenh_ThuocSD.SLKeDon = (decimal.Parse(soLuong) / _KhamBenh_ThuocSD.QuyDoi).ToString();
                        _KhamBenh_ThuocSD.SLMua = _KhamBenh_ThuocSD.SLKeDon;
                        _KhamBenh_ThuocSD.SoLuongD = soLuong;
                        _KhamBenh_ThuocSD.Tinhtien = tinhtien;
                        if (action == FormAction.EDIT)
                        {
                            if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) != "0" && decimal.Parse(soLuong) + decimal.Parse(_KhamBenh_ThuocSD.SLMua) > 0)
                            {
                                DMThuocKhoaList list = null;
                                maThuoc = _KhamBenh_ThuocSD.Mathuoc;
                                DMThuocKhoa _DMThuocKhoa = null;
                                if (list == null)
                                    list = DMThuocKhoaList.FindDMThuocKhoaMa(_MaKhoa, _ThongtinBN.KhamBenh.MaDT, maThuoc, _LoaiPhieu);
                                if (list == null)
                                    return false;
                                if (_DMThuocKhoa == null)
                                    _DMThuocKhoa = list.FirstOrDefault(X => X.MaThuoc == maThuoc);
                                if (_DMThuocKhoa == null)
                                    return false;

                                //if (_DMThuocKhoa.Nguongnhap > 0 && HTC.ShareVariables.pub_spC == "QN")
                                //{
                                //    if (soLuong != "")
                                //    {
                                //        if (decimal.Parse(soLuong) > _DMThuocKhoa.Nguongnhap)
                                //        {
                                //            ShowMessage("Số lượng nhập vượt quá ngưỡng nhập");
                                //            return false;
                                //        }
                                //    }
                                //}

                                if (_DMThuocKhoa.TonCK == "" || _DMThuocKhoa.TonCK == "0")
                                {
                                    ShowMessage("Thuốc " + _DMThuocKhoa.TenTM + " hết tồn");
                                    return false;
                                }
                                else if (decimal.Parse(_DMThuocKhoa.TonCK) < decimal.Parse(soLuong) - decimal.Parse(_KhamBenh_ThuocSD.SLMua))
                                {
                                    ShowMessage("Thuốc " + _KhamBenh_ThuocSD.TenTM + " hết tồn");
                                    return false;

                                }
                                else if (decimal.Parse(_DMThuocKhoa.TonCKDT) < decimal.Parse(soLuong) - decimal.Parse(_KhamBenh_ThuocSD.SLMua))
                                {
                                    ShowMessage("Thuốc " + _KhamBenh_ThuocSD.TenTM + " hết tồn");
                                    return false;

                                }
                                else
                                {
                                    _KhamBenh_ThuocSD.TONCKDT = decimal.Parse(_DMThuocKhoa.TonCKDT) - decimal.Parse(soLuong) + decimal.Parse(_KhamBenh_ThuocSD.SLMua);
                                };

                            }
                        }
                        if (action == FormAction.INSERT)
                        {
                            RadComboBox cboThuoc = editedItem["MaThuoc"].FindControl("cboThuoc") as RadComboBox;
                            if (cboThuoc != null)
                            {
                                maThuoc = cboThuoc.SelectedValue;
                            }
                            DMThuocKhoaList list = null;

                            DMThuocKhoa _DMThuocKhoa = null;
                            if (maThuoc == "" || maThuoc == null)
                            {

                                if (cboThuoc.Text != "")
                                {
                                    list = DMThuocKhoaList.FindDMThuocKhoaTen(_MaKhoa, _ThongtinBN.KhamBenh.MaDT, cboThuoc.Text, _LoaiPhieu);
                                    if (list.Count > 0)
                                    {
                                        _DMThuocKhoa = list[0];
                                        maThuoc = _DMThuocKhoa.MaThuoc;
                                    }
                                    else
                                    {
                                        ShowMessage("Chưa nhập tên thuốc");
                                        cboThuoc.Focus();
                                        return false;
                                    }

                                }
                                else
                                {
                                    ShowMessage("Chưa nhập tên thuốc");
                                    cboThuoc.Focus();
                                    return false;
                                }
                            };
                            // DMThuocKhoaList list = odsThuoc.Select() as DMThuocKhoaList;
                            if (list == null)
                                list = DMThuocKhoaList.FindDMThuocKhoaMa(_MaKhoa, _ThongtinBN.KhamBenh.MaDT, maThuoc, _LoaiPhieu);
                            if (list == null)
                                return false;
                            if (_DMThuocKhoa == null)
                                _DMThuocKhoa = list.FirstOrDefault(X => X.MaThuoc == maThuoc);
                            if (_DMThuocKhoa == null)
                                return false;
                            if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) != "0")
                            {

                                if (_DMThuocKhoa.TonCK == "" || _DMThuocKhoa.TonCK == "0")
                                {
                                    ShowMessage("Thuốc hết tồn");
                                    return false;
                                }
                                else if (decimal.Parse(_DMThuocKhoa.TonCK) < decimal.Parse(soLuong))
                                {
                                    ShowMessage("Thuốc hết tồn");
                                    return false;

                                };
                                //if (_DMThuocKhoa.Nguongnhap > 0 && HTC.ShareVariables.pub_spC == "QN")
                                //{
                                //    if (soLuong.ToString() != "")
                                //    {
                                //        if (decimal.Parse(soLuong.ToString()) > _DMThuocKhoa.Nguongnhap)
                                //        {
                                //            ShowMessage("Số lượng nhập vượt quá ngưỡng nhập");
                                //            return false;
                                //        }
                                //    }
                                //}
                            }

                            foreach (KhamBenh_ThuocSD bac in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
                            {
                                if (maThuoc == bac.Mathuoc)
                                {
                                    ShowMessage("Đã tồn tại thuốc này");

                                }
                            }
                            _KhamBenh_ThuocSD.QuyDoi = _DMThuocKhoa.quydoi;
                            _KhamBenh_ThuocSD.SLKeDon = (_DMThuocKhoa.quydoi * decimal.Parse(soLuong)).ToString();
                            _KhamBenh_ThuocSD.SLMua = _KhamBenh_ThuocSD.SLKeDon;
                            _KhamBenh_ThuocSD.SoLuongD = soLuong;
                            _KhamBenh_ThuocSD.BHTinhtien = _DMThuocKhoa.DTBH;
                            _KhamBenh_ThuocSD.CK = "0";
                            _KhamBenh_ThuocSD.DonGiaBH = (string.IsNullOrEmpty(_DMThuocKhoa.DonGiaBH) ? "0" : _DMThuocKhoa.DonGiaBH);
                            _KhamBenh_ThuocSD.DongiaTT = (string.IsNullOrEmpty(_DMThuocKhoa.DonGiaTT) ? "0" : _DMThuocKhoa.DonGiaTT);
                            _KhamBenh_ThuocSD.NoiTTBH = _NoiTT;
                            _KhamBenh_ThuocSD.NoiTTTT = _NoiTT;
                            _KhamBenh_ThuocSD.MaDT = _ThongtinBN.KhamBenh.MaDT;
                            if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
                            {
                                _KhamBenh_ThuocSD.BSChiDinh = cboNhanVien.SelectedValue;
                                _KhamBenh_ThuocSD.tenbschidinh = cboNhanVien.Text;

                            }

                            if (_DMThuocKhoa.adphongmo > 1)
                            {
                                // _KhamBenh_ThuocSD.TinhNgoai = True
                                _KhamBenh_ThuocSD.BHTinhtien = false;
                            }
                            else if (_DMThuocKhoa.adphongmo == 2)
                            {
                                //_KhamBenh_ThuocSD.TinhNgoai = True
                                _KhamBenh_ThuocSD.BHTinhtien = false;
                            }
                            if (_DMThuocKhoa.ADChenhLech == true)
                            {
                                _KhamBenh_ThuocSD.GiaChenhLech = (string.IsNullOrEmpty(_DMThuocKhoa.GiaChenhlech) ? "0" : _DMThuocKhoa.GiaChenhlech);
                            }
                            else
                            {
                                _KhamBenh_ThuocSD.GiaChenhLech = "0";
                            }
                            _KhamBenh_ThuocSD.Mathuoc = maThuoc;

                            _KhamBenh_ThuocSD.TenTM = _DMThuocKhoa.TenTM;
                            _KhamBenh_ThuocSD.tendvt = _DMThuocKhoa.TenDVT;

                            _KhamBenh_ThuocSD.TONCK = decimal.Parse(_DMThuocKhoa.TonCK == "" ? "0" : _DMThuocKhoa.TonCK);
                            _KhamBenh_ThuocSD.TONCKDT = decimal.Parse(_DMThuocKhoa.TonCKDT == "" ? "0" : _DMThuocKhoa.TonCKDT);

                        }
                        ///''''''''''''''''''''''
                        _KhamBenh_ThuocSD.MaSoKham = _MaSoKham;
                        _KhamBenh_ThuocSD.MaBN = _MaBN;
                        if (sothuoc != "" && lieuluong != "")
                        {
                            DMThuoc _dm = DMThuoc.GetDMThuoc(_KhamBenh_ThuocSD.Mathuoc);
                            _KhamBenh_ThuocSD.LieuDung = "Mỗi lần uống " + sothuoc + " " + _dm.tendvt2 + ",ngày uống " + lieuluong + " lần,";
                            if (duongdung != "" && dvt != "")
                                _KhamBenh_ThuocSD.LieuDung = "Mỗi lần " + duongdung + " " + sothuoc + " " + dvt + ",ngày " + duongdung + lieuluong + " lần,";

                            if (_dm.MaDVT == "00005")
                                _KhamBenh_ThuocSD.LieuDung = "Bôi " + sothuoc + " " + _dm.tendvt2 + "/lần" + "," + lieuluong + "lần/ngày";
                            else if (_dm.MaDVT2 == "00052" || _dm.MaDVT == "00061" || _dm.MaThuoc == "02849" || _dm.MaThuoc == "03010" || _dm.MaThuoc == "02936" || _dm.MaThuoc == "02930" || _dm.MaThuoc == "03011" || _dm.MaThuoc == "03048")
                                _KhamBenh_ThuocSD.LieuDung = "Tiêm " + sothuoc + " " + _dm.tendvt2 + "/lần" + "," + lieuluong + "lần/ngày";
                            else if (_dm.MaThuoc == "01913")
                                _KhamBenh_ThuocSD.LieuDung = "Mỗi lần uống " + sothuoc + " viên,ngày uống " + lieuluong + " lần,";
                            else if (_dm.MaDVT == "01883" || _dm.MaThuoc == "02001" || _dm.MaThuoc == "01882" || _dm.MaThuoc == "02000" || _dm.MaThuoc == "01820")
                                _KhamBenh_ThuocSD.LieuDung = "Đặt " + sothuoc + " " + _dm.tendvt2 + "/lần" + "," + lieuluong + "lần/ngày";
                            else if (_dm.MaThuoc == "00897")
                                _KhamBenh_ThuocSD.LieuDung = "Dán " + sothuoc + " " + _dm.tendvt2 + "/lần" + "," + lieuluong + "lần/ngày dán vùng đau";
                            else if (_dm.MaThuoc == "00921")
                                _KhamBenh_ThuocSD.LieuDung = "Ngâm " + sothuoc + " " + _dm.tendvt2 + "/lần" + "," + lieuluong + "lần/ngày ngâm lúc 20 giờ";
                            _dm = null;
                        }
                        //_KhamBenh_ThuocSD.LieuDung = (LieuDung == "" ? _KhamBenh_ThuocSD.LieuDung : LieuDung + "");

                        //_KhamBenh_ThuocSD.CachDung = (cachDung == "" ? _KhamBenh_ThuocSD.CachDung : cachDung + "");
                        _KhamBenh_ThuocSD.CachDung = cachDungTT;
                        _KhamBenh_ThuocSD.cachdungtt = cachDungTT;
                        _KhamBenh_ThuocSD.sothuoc = sothuoc;
                        _KhamBenh_ThuocSD.lieuluong = lieuluong;
                        _KhamBenh_ThuocSD.duongdung = duongdung;
                        _KhamBenh_ThuocSD.dvt = dvt;
                        if (action == FormAction.INSERT)
                        {
                            if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count == 0)
                            {
                                _KhamBenh_ThuocSD.STT = 1;
                            }
                            else
                            {
                                _KhamBenh_ThuocSD.STT = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList[_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count - 1].STT + 1;
                            }
                        }

                    }
                }
            }
            if (action == FormAction.EDIT)
            {
                _KhamBenh_ThuocSD.MaMay = Pub_sMaMay;
                _KhamBenh_ThuocSD.NguoiSD = Pub_sNguoiSD;
                _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.UpdatedTo(_KhamBenh_ThuocSD);
                // _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.ApplyEdit();     
                // _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Save();
            }
            else if (action == FormAction.INSERT)
            {
                _KhamBenh_ThuocSD.MaMay = Pub_sMaMay;
                _KhamBenh_ThuocSD.NguoiLap = Pub_sNguoiSD; _KhamBenh_ThuocSD.NguoiSD = Pub_sNguoiSD;
                _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.AssignTo(_KhamBenh_ThuocSD, _ThongtinBN.KhamBenh);
                // _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.ApplyEdit();     
                // _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Save();

            }
            else if (action == FormAction.DELETE)
            {
                _KhamBenh_ThuocSD.MaMay = Pub_sMaMay;
                _KhamBenh_ThuocSD.NguoiSD = Pub_sNguoiSD;
                _KhamBenh_ThuocSD.SLMua = "0";
                _KhamBenh_ThuocSD.SLKeDon = "0";
                try
                {
                    _KhamBenh_ThuocSD.NguoiHuy = Pub_sNguoiSD; _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.RemoveTo(_KhamBenh_ThuocSD, _ThongtinBN.KhamBenh);
                }
                catch
                {
                    _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.UpdatedTo(_KhamBenh_ThuocSD, _ThongtinBN.KhamBenh);

                }
                // _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.ApplyEdit();     
                // _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Save();
            }
            _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();
            grdThuoc.EditIndexes.Clear();
            grdThuoc.MasterTableView.IsItemInserted = true;

            grdThuoc.MasterTableView.Rebind();





        }
        catch (Exception ex)
        {
            ShowMessage("Không lưu được dữ liệu" + ex.Message);

            //throw;
        }

        return true;
    }

    private bool UpdateDataXN(GridEditableItem editedItem, FormAction action, string madv = "", DMDichVu_Gia_DT _DMDV_Gia = null)
    {
        string MaDV = string.Empty;

        try
        {
            KhamBenh_C _KhamBenh_C;
            RadComboBox combo = null;

            if (action == FormAction.INSERT)
                _KhamBenh_C = KhamBenh_C.NewKhamBenh_C();
            else
            {
                int STT = int.Parse(editedItem.GetDataKeyValue("STT").ToString());

                _KhamBenh_C = _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(X => X.STT == STT);
                if (_KhamBenh_C.MaHuongDT != "")
                {
                    ShowMessage("Không được phép sửa dịch vụ vì đã thực hiện");
                    return false;
                }
            }
            if (action != FormAction.DELETE)
            {
                _KhamBenh_C.MaSoKham = _MaSoKham;
                _KhamBenh_C.makhoacd = _MaKhoa;
                _KhamBenh_C.MaBN = _MaBN;

                _KhamBenh_C.maicd = cboChanDoan.Text;
                _KhamBenh_C.Mabenh = cboChanDoan.SelectedValue;
                _KhamBenh_C.tenbenh = txtChanDoan.Text;

                _KhamBenh_C.maicdKem = cboChanDoanKem.Text;
                _KhamBenh_C.MabenhKem = cboChanDoanKem.SelectedValue;
                _KhamBenh_C.tenbenhKem = txtChanDoanKem.Text;

                //_KhamBenh_C.maicdKem2 = cboChanDoanKem2.Text;
                //_KhamBenh_C.MabenhKem2 = cboChanDoanKem2.SelectedValue;
                //_KhamBenh_C.tenbenhKem2 = txtChanDoanKem2.Text;

                //_KhamBenh_C.maicdKem3 = cboChanDoanKem3.Text;
                //_KhamBenh_C.MabenhKem3 = cboChanDoanKem3.SelectedValue;
                //_KhamBenh_C.tenbenhKem3 = txtChanDoanKem3.Text;

                if (!CheckFormData()) return false;
                else
                {
                    string soLuong = "";
                    Boolean tinhtien = false;
                    string ghichu = "";
                    if (editedItem != null)
                    {
                        if (editedItem["SoLuong"].FindControl("tbSoLuong") == null)
                            return false;
                        soLuong = ((RadNumericTextBox)editedItem["SoLuong"].FindControl("tbSoLuong")).Text;
                        tinhtien = ((CheckBox)editedItem["TinhTien"].Controls[0]).Checked;
                        combo = ((RadComboBox)editedItem["MaKhoa"].FindControl("cboKhoa"));

                        ghichu = ((TextBox)editedItem["GhiChu"].FindControl("tbGhiChu")).Text;
                    }
                    if (madv == "" || madv == null)
                    {
                        RadComboBox cboThuoc = editedItem["MaDV"].FindControl("cboDichVu") as RadComboBox;
                        if (cboThuoc != null)
                        {
                            madv = cboThuoc.SelectedValue;
                            if (madv == "")
                            {
                                RadComboBox cboMaThuoc = editedItem["MaDV"].FindControl("cboMaDichVu") as RadComboBox;
                                if (cboMaThuoc != null)
                                {
                                    madv = cboMaThuoc.SelectedValue;
                                }
                            }
                            if (madv != "" && soLuong == "")
                                return false;
                            else if (madv == "" && soLuong == "")
                            {
                                ShowMessage("Chưa nhập tên dịch vụ");

                                return false;
                            }
                        }
                    }

                    if (soLuong == "")
                        soLuong = "1";
                    if (decimal.Parse(soLuong) <= 0)
                    {
                        ShowMessage("Số lượng định dạng sai");
                        ((RadNumericTextBox)editedItem["SoLuong"].FindControl("tbSoLuong")).Focus();

                        return false;
                    };
                    if (action != FormAction.DELETE)
                    {

                        _KhamBenh_C.Mabenh = cboChanDoan.SelectedValue;
                        _KhamBenh_C.tenbenh = txtChanDoan.Text;

                        _KhamBenh_C.SoLuong = soLuong;
                        _KhamBenh_C.slmua = _KhamBenh_C.SoLuong;
                        _KhamBenh_C.Tinhtien = tinhtien;
                        _KhamBenh_C.Ghichu = ghichu;
                        _KhamBenh_C.NguoiSD = Pub_sNguoiSD;

                        ////   =============================================
                        if (action == FormAction.INSERT)
                        {

                            if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
                            {
                                _KhamBenh_C.bschidinh = cboNhanVien.SelectedValue;
                                _KhamBenh_C.tenbschidinh = cboNhanVien.Text;

                            }

                            _KhamBenh_C.Sophong = _KhamBenh_C.Mabs3;
                            //if (editedItem != null)
                            //{
                            //    RadComboBox cboThuoc = editedItem["MaDV"].FindControl("cboDichVu") as RadComboBox;
                            //    if (cboThuoc != null)
                            //    {
                            //        MaDV = cboThuoc.SelectedValue;
                            //    }
                            //}
                            //else
                            MaDV = madv;
                            if (MaDV == "" || MaDV == null)
                            {
                                ShowMessage("Chưa nhập tên dịch vụ");

                                return false;
                            };
                            DMDichVu_Gia_DT _DMDichVu_Gia;
                            if (_DMDV_Gia == null)
                            {
                                // DMDichVu_Gia_DTList list = odsDichVu.Select() as DMDichVu_Gia_DTList;
                                DMDichVu_Gia_DTList list = DMDichVu_Gia_DTList.FindDMDichVu_Gia_DTByMa(MaDV, _ThongtinBN.KhamBenh.MaDT, _NoiTT);

                                if (list == null)
                                    return false;
                                _DMDichVu_Gia = list.FirstOrDefault(X => X.MaDV == MaDV);

                            }
                            else

                                _DMDichVu_Gia = _DMDV_Gia;
                            if (_DMDichVu_Gia == null)
                                return false;
                            //  _KhamBenh_C.Makhoa = _DMDichVu_Gia.makhoa;
                            foreach (KhamBenh_C bac in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                            {
                                if (MaDV == bac.MaDV)
                                {
                                    ShowMessage("Đã tồn tại dịch vụ này");

                                }
                            }
                            _KhamBenh_C.BHTinhtien = _DMDichVu_Gia.DTBH;
                            _KhamBenh_C.CK = "0";
                            _KhamBenh_C.DonGiaBH = (string.IsNullOrEmpty(_DMDichVu_Gia.Dongia) ? "0" : _DMDichVu_Gia.Dongia);
                            //_KhamBenh_C.DongiaTT = (string.IsNullOrEmpty(_DMDichVu_Gia.dongiatt) ? "0" : _DMDichVu_Gia.dongiatt);
                            //_KhamBenh_C.NoiTTBH = _NoiTT;
                            //_KhamBenh_C.NoiTTTT = _NoiTT;
                            _KhamBenh_C.Tinhtien = tinhtien;

                            if (_NoiTT == "087" && (_DMDichVu_Gia.dongiaclc == "" || _DMDichVu_Gia.dongiaclc == "0"))
                            {
                                _KhamBenh_C.DongiaTT = _DMDichVu_Gia.dongiadv == "" ? "0" : _DMDichVu_Gia.dongiadv;
                                _KhamBenh_C.NoiTTBH = "085";
                                _KhamBenh_C.NoiTTTT = "085";
                            }
                            else if (_NoiTT == "085" && (_DMDichVu_Gia.dongiadv == "" || _DMDichVu_Gia.dongiadv == "0"))
                            {
                                _KhamBenh_C.DongiaTT = _DMDichVu_Gia.dongiaclc == "" ? "0" : _DMDichVu_Gia.dongiaclc;
                                _KhamBenh_C.NoiTTBH = "087";
                                _KhamBenh_C.NoiTTTT = "087";
                            }
                            else if (_NoiTT == "087")
                            {
                                _KhamBenh_C.DongiaTT = _DMDichVu_Gia.dongiaclc == "" ? "0" : _DMDichVu_Gia.dongiaclc;
                                _KhamBenh_C.NoiTTBH = _NoiTT;
                                _KhamBenh_C.NoiTTTT = _NoiTT;
                            }
                            else
                            {
                                _KhamBenh_C.DongiaTT = _DMDichVu_Gia.dongiatt == "" ? "0" : _DMDichVu_Gia.dongiatt;
                                _KhamBenh_C.NoiTTBH = _NoiTT;
                                _KhamBenh_C.NoiTTTT = _NoiTT;
                            }
                            if (_KhamBenh_C.NoiTTTT == "087")
                            {
                                _KhamBenh_C.Makhoa = _DMDichVu_Gia.makhoa087;
                                _KhamBenh_C.tenkhoa = _DMDichVu_Gia.tenkhoa087;
                            }
                            else if (_KhamBenh_C.NoiTTTT == "093")
                            {
                                _KhamBenh_C.Makhoa = _DMDichVu_Gia.makhoaNG;
                                _KhamBenh_C.tenkhoa = _DMDichVu_Gia.tenkhoaNG;
                            }
                            else
                            {
                                _KhamBenh_C.Makhoa = _DMDichVu_Gia.makhoa;
                                _KhamBenh_C.tenkhoa = _DMDichVu_Gia.tenkhoa;
                            }
                            if (_KhamBenh_C.Makhoa == "")
                                _KhamBenh_C.Makhoa = _MaKhoa;
                            if (combo != null)
                                if (combo.SelectedValue != "")
                                {
                                    _KhamBenh_C.Makhoa = combo.SelectedValue;
                                    _KhamBenh_C.tenkhoa = combo.Text;
                                }
                            _KhamBenh_C.MaDT = _ThongtinBN.KhamBenh.MaDT;

                            if (_DMDichVu_Gia.ADPhongMo > 1)
                            {
                                // _KhamBenh_C.TinhNgoai = True
                                _KhamBenh_C.BHTinhtien = false;
                            }
                            else if (_DMDichVu_Gia.ADPhongMo == 2)
                            {
                                //_KhamBenh_C.TinhNgoai = True
                                _KhamBenh_C.BHTinhtien = false;
                            }
                            if (_DMDichVu_Gia.ADChenhlech == true)
                            {
                                _KhamBenh_C.GiaChenhLech = (string.IsNullOrEmpty(_DMDichVu_Gia.GiaChenhlenh) ? "0" : _DMDichVu_Gia.GiaChenhlenh);
                            }
                            else
                            {
                                _KhamBenh_C.GiaChenhLech = "0";
                            }
                            _KhamBenh_C.MaDV = MaDV;

                            _KhamBenh_C.TenTM = _DMDichVu_Gia.TenDV;
                            ///''''''''''''''''''''''
                            _KhamBenh_C.MaSoKham = _MaSoKham;
                            _KhamBenh_C.MaBN = _MaBN;

                            if (action == FormAction.INSERT)
                            {
                                if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0)
                                {
                                    _KhamBenh_C.STT = 1;
                                }
                                else
                                {
                                    _KhamBenh_C.STT = _ThongtinBN.KhamBenh.KhamBenh_C_List[_ThongtinBN.KhamBenh.KhamBenh_C_List.Count - 1].STT + 1;
                                }
                            }
                        }
                    }
                }
            }

            if (action == FormAction.EDIT)
            {
                _KhamBenh_C.MaMay = Pub_sMaMay;
                _KhamBenh_C.NguoiSD = Pub_sNguoiSD;
                _ThongtinBN.KhamBenh.KhamBenh_C_List.UpdatedTo(_KhamBenh_C, _ThongtinBN.KhamBenh);
                // _ThongtinBN.KhamBenh.KhamBenh_C_List.ApplyEdit();     
                // _ThongtinBN.KhamBenh.KhamBenh_C_List.Save();
            }
            else if (action == FormAction.INSERT)
            {
                _KhamBenh_C.MaMay = Pub_sMaMay;
                _KhamBenh_C.NguoiLap = Pub_sNguoiSD; _KhamBenh_C.NguoiSD = Pub_sNguoiSD;
                _ThongtinBN.KhamBenh.KhamBenh_C_List.AssignTo(_KhamBenh_C, _ThongtinBN.KhamBenh);
                // _ThongtinBN.KhamBenh.KhamBenh_C_List.ApplyEdit();     
                // _ThongtinBN.KhamBenh.KhamBenh_C_List.Save();

                if (HTC.ShareVariables.pub_spC == "YH")
                {
                    try
                    {
                        string ty = cboGoiTY.SelectedValue;
                        cboGoiTY.SelectedValue = _KhamBenh_C.MaDV;
                        LoadDetails(true, 2, true, true);
                        cboGoiTY.SelectedValue = ty;
                    }
                    catch (Exception)
                    {
                    }
                }

            }
            else if (action == FormAction.DELETE)
            {
                _KhamBenh_C.MaMay = Pub_sMaMay;
                _KhamBenh_C.NguoiSD = Pub_sNguoiSD;
                _KhamBenh_C.slmua = "0";
                _KhamBenh_C.SoLuong = "0"; _KhamBenh_C.Huy = true;
                _KhamBenh_C.NguoiHuy = Pub_sNguoiSD;
                _ThongtinBN.KhamBenh.KhamBenh_C_List.RemoveTo(_KhamBenh_C, _ThongtinBN.KhamBenh);
                // _ThongtinBN.KhamBenh.KhamBenh_C_List.ApplyEdit();     
                // _ThongtinBN.KhamBenh.KhamBenh_C_List.Save();
            }




        }
        catch (Exception ex)
        {
            ShowMessage("Không lưu được dữ liệu" + ex.Message);

            //throw;
        }

        return true;
    }
    private bool UpdateDataThuocDY(GridEditableItem editedItem, FormAction action, string grid = "")
    {
        string maThuoc = string.Empty;

        try
        {
            KhamBenh_ThuocSD_DY_C _KhamBenh_ThuocSD_DY_C = null; ;
            KhamBenh_ThuocSD_DY_CList _KhamBenh_ThuocSD_DY_CList;
            _KhamBenh_ThuocSD_DY_CList = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
            if (_KhamBenh_ThuocSD_DY.DATT != 0)
            {
                ShowMessage("Đã thanh toán đơn thuốc này");
                return false;
            }
            if (action == FormAction.INSERT)
                _KhamBenh_ThuocSD_DY_C = KhamBenh_ThuocSD_DY_C.NewKhamBenh_ThuocSD_DY_C();
            else if (action == FormAction.DELETE)
            {
                if (grid == "grdDanhSachDY")
                {
                    int STT = int.Parse(editedItem.GetDataKeyValue("STT").ToString());
                    _KhamBenh_ThuocSD_DY = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.FirstOrDefault(X => X.STT == STT);
                    try
                    {
                        _KhamBenh_ThuocSD_DY.NguoiSD = Pub_sNguoiSD;
                        _KhamBenh_ThuocSD_DY.MaMay = Pub_sMaMay;
                        _KhamBenh_ThuocSD_DY.NguoiHuy = Pub_sNguoiSD;
                        _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.RemoveTo(_KhamBenh_ThuocSD_DY, _ThongtinBN.KhamBenh);
                    }
                    catch
                    {
                        _KhamBenh_ThuocSD_DY.SLMua = "0";
                        _KhamBenh_ThuocSD_DY.SLThang = "0";
                        _KhamBenh_ThuocSD_DY.NguoiSD = Pub_sNguoiSD;
                        _KhamBenh_ThuocSD_DY.MaMay = Pub_sMaMay;
                        _KhamBenh_ThuocSD_DY.NguoiHuy = Pub_sNguoiSD;
                        _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.UpdatedTo(_KhamBenh_ThuocSD_DY, _ThongtinBN.KhamBenh);

                    }
                    _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();
                    return true;
                }
                else
                {
                    int STT = int.Parse(editedItem.GetDataKeyValue("STTThuoc").ToString());

                    _KhamBenh_ThuocSD_DY_C = _KhamBenh_ThuocSD_DY_CList.FirstOrDefault(X => X.STTThuoc == STT);
                }
            }
            else if (editedItem != null)
            {
                int STT = int.Parse(editedItem.GetDataKeyValue("STTThuoc").ToString());

                _KhamBenh_ThuocSD_DY_C = _KhamBenh_ThuocSD_DY_CList.FirstOrDefault(X => X.STTThuoc == STT);
            }
            else
                _KhamBenh_ThuocSD_DY_C = KhamBenh_ThuocSD_DY_C.NewKhamBenh_ThuocSD_DY_C();

            if (action != FormAction.DELETE)
            {

                _KhamBenh_ThuocSD_DY.MaSoKham = _MaSoKham;
                _KhamBenh_ThuocSD_DY.MaKhoa = _MaKhoa;
                _KhamBenh_ThuocSD_DY.MaBN = _MaBN;
                if (txtSLThang.Text == "")
                    txtSLThang.Text = "1";
                if (_KhamBenh_ThuocSD_DY.DATT != 0)
                {
                    ShowMessage("Đã thanh toán thuốc đông y ");
                    return false;
                }
                _KhamBenh_ThuocSD_DY.SLThang = txtSLThang.Text;
                _KhamBenh_ThuocSD_DY.SLMua = txtSLThang.Text;
                _KhamBenh_ThuocSD_DY.NgayDK = _ThongtinBN.KhamBenh.NgayDK;

                if (action == FormAction.INSERT && _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs.Count == 0)
                {
                    _KhamBenh_ThuocSD_DY.NoiTTBH = _NoiTT;
                    _KhamBenh_ThuocSD_DY.NoiTTTT = _NoiTT;
                    _KhamBenh_ThuocSD_DY.MaDT = _ThongtinBN.KhamBenh.MaDT;
                    _KhamBenh_ThuocSD_DY.Sac = false;
                }
                if (!CheckFormData()) return false;
                else
                {

                    string lieuDung = txtLieuDungDY.Text;
                    string mathuoc = string.Empty;


                    if (action != FormAction.DELETE)
                    {

                        _KhamBenh_ThuocSD_DY.LieuDung = _KhamBenh_ThuocSD_DY.LieuDung != lieuDung ? lieuDung : _KhamBenh_ThuocSD_DY.LieuDung;
                        _KhamBenh_ThuocSD_DY.CachDung = _KhamBenh_ThuocSD_DY.CachDung != txtLuuY.Text ? txtLuuY.Text : _KhamBenh_ThuocSD_DY.CachDung;

                        _KhamBenh_ThuocSD_DY.MaMay = Pub_sMaMay;
                        _KhamBenh_ThuocSD_DY.NguoiSD = Pub_sNguoiSD;
                        if (action == FormAction.INSERT && _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs.Count > 0)
                            _KhamBenh_ThuocSD_DY.NguoiLap = Pub_sNguoiSD;
                        ////   =============================================
                        if (editedItem != null)
                        {

                            if (action != FormAction.INSERT)
                            {
                                string soLuong = ((RadNumericTextBox)editedItem["SoLuongD"].FindControl("tbSoLuong")).Text;
                                if (soLuong == "" || soLuong == null || soLuong == "0")
                                {
                                    ShowMessage("Chưa nhập số lượng");
                                    ((RadNumericTextBox)editedItem["SoLuongD"].FindControl("tbSoLuong")).Focus();
                                    return false;
                                };
                                if (decimal.Parse(soLuong) < 0)
                                {
                                    ShowMessage("Số lượng định dạng sai");
                                    ((RadNumericTextBox)editedItem["SoLuongD"].FindControl("tbSoLuong")).Focus();

                                    return false;
                                };

                                DMThuocKhoaList list = null;
                                maThuoc = _KhamBenh_ThuocSD_DY_C.Mathuoc;
                                DMThuocKhoa _DMThuocKhoa = null;
                                if (list == null)
                                    list = DMThuocKhoaList.FindDMThuocKhoaMaDY(_MaKhoa, _MaDT, mathuoc, _LoaiPhieu);
                                if (list == null)
                                    return false;
                                if (_DMThuocKhoa == null)
                                    _DMThuocKhoa = list.FirstOrDefault(X => X.MaThuoc == maThuoc);
                                if (_DMThuocKhoa == null)
                                    return false;

                                //if (_DMThuocKhoa.Nguongnhap > 0 && HTC.ShareVariables.pub_spC == "QN")
                                //{
                                //    if (soLuong != "")
                                //    {
                                //        if (decimal.Parse(soLuong) > _DMThuocKhoa.Nguongnhap)
                                //        {
                                //            ShowMessage("Số lượng nhập vượt quá ngưỡng nhập");
                                //            return false;
                                //        }
                                //    }
                                //}

                                if (_DMThuocKhoa.TonCK == "" || _DMThuocKhoa.TonCK == "0")
                                {
                                    ShowMessage("Thuốc " + _DMThuocKhoa.TenTM + " hết tồn");
                                    return false;
                                }
                                else if (decimal.Parse(_DMThuocKhoa.TonCK) < (decimal.Parse(soLuong) - decimal.Parse(_KhamBenh_ThuocSD_DY_C.SLMua)) * decimal.Parse(txtSLThang.Text))
                                {
                                    ShowMessage("Thuốc " + _KhamBenh_ThuocSD_DY_C.TenTM + " hết tồn");
                                    return false;

                                }
                                else if (decimal.Parse(_DMThuocKhoa.TonCKDT) < (decimal.Parse(soLuong) - decimal.Parse(_KhamBenh_ThuocSD_DY_C.SLMua)) * decimal.Parse(txtSLThang.Text))
                                {
                                    ShowMessage("Thuốc " + _KhamBenh_ThuocSD_DY_C.TenTM + " hết tồn");
                                    return false;

                                }
                                else
                                {
                                    _KhamBenh_ThuocSD_DY_C.TONCKDT = decimal.Parse(_DMThuocKhoa.TonCKDT) - (decimal.Parse(soLuong) - decimal.Parse(_KhamBenh_ThuocSD_DY_C.SLMua)) * decimal.Parse(txtSLThang.Text);
                                };

                                _KhamBenh_ThuocSD_DY_C.SLKeDon = (_KhamBenh_ThuocSD_DY_C.QuyDoi * decimal.Parse(soLuong)).ToString();
                                _KhamBenh_ThuocSD_DY_C.SLMua = _KhamBenh_ThuocSD_DY_C.SLKeDon;
                                _KhamBenh_ThuocSD_DY_C.SoLuongD = soLuong;
                            }
                            else if (action == FormAction.INSERT)
                            {
                                RadComboBox cboThuoc = editedItem["MaThuoc"].FindControl("cboThuoc") as RadComboBox;
                                if (cboThuoc != null)
                                {
                                    mathuoc = cboThuoc.SelectedValue;
                                }
                                DMThuocKhoaList list = null;

                                DMThuocKhoa _DMThuocKhoa = null;
                                string madt = "";
                                if (txtSLThangTT.Text != "")
                                    madt = "00001";
                                else
                                    madt = _ThongtinBN.KhamBenh.MaDT;
                                if (mathuoc == "" || mathuoc == null)
                                {
                                    if (cboThuoc.Text == "")
                                    {
                                        txtSLThang.Focus();
                                        return false;
                                    }
                                    else
                                    {
                                        list = DMThuocKhoaList.FindDMThuocKhoaTenDY(_MaKhoa, madt, cboThuoc.Text, _LoaiPhieu);

                                        if (list.Count > 0)
                                        {
                                            _DMThuocKhoa = list[0];
                                            mathuoc = _DMThuocKhoa.MaThuoc;
                                        }
                                        if (mathuoc == "")
                                        {
                                            txtSLThang.Focus();
                                            return false;
                                        }
                                    }

                                };
                                foreach (KhamBenh_ThuocSD_DY_C bac in _KhamBenh_ThuocSD_DY_CList)
                                {
                                    if (mathuoc == bac.Mathuoc)
                                    {
                                        ShowMessage("Đã tồn tại thuốc này");

                                        cboThuoc.Focus();
                                        return false;
                                    }
                                }
                                string soLuong = ((RadNumericTextBox)editedItem["SoLuongD"].FindControl("tbSoLuong")).Text;
                                if (soLuong == "" || soLuong == null || soLuong == "0")
                                {
                                    ShowMessage("Chưa nhập số lượng");
                                    ((RadNumericTextBox)editedItem["SoLuongD"].FindControl("tbSoLuong")).Focus();
                                    return false;
                                };
                                if (decimal.Parse(soLuong) < 0)
                                {
                                    ShowMessage("Số lượng định dạng sai");
                                    ((RadNumericTextBox)editedItem["SoLuongD"].FindControl("tbSoLuong")).Focus();

                                    return false;
                                };
                                //DMThuocKhoaList list = odsThuocDY.Select() as DMThuocKhoaList;



                                if (list == null)
                                    list = DMThuocKhoaList.FindDMThuocKhoaMaDY(_MaKhoa, madt, mathuoc, _LoaiPhieu);

                                if (list == null)
                                    return false;
                                if (_DMThuocKhoa == null)
                                    _DMThuocKhoa = list.FirstOrDefault(X => X.MaThuoc == mathuoc);
                                if (_DMThuocKhoa == null)
                                    return false;
                                _KhamBenh_ThuocSD_DY_C.TenTM = _DMThuocKhoa.TenTM;
                                //if (_DMThuocKhoa.Nguongnhap > 0 && HTC.ShareVariables.pub_spC == "QN")
                                //{
                                //    if (soLuong != "")
                                //    {
                                //        if (decimal.Parse(soLuong) > _DMThuocKhoa.Nguongnhap)
                                //        {
                                //            ShowMessage("Số lượng nhập vượt quá ngưỡng nhập");
                                //            return false;
                                //        }
                                //    }
                                //}
                                if (_DMThuocKhoa.TonCK == "" || _DMThuocKhoa.TonCK == "0")
                                {
                                    ShowMessage("Thuốc " + _DMThuocKhoa.TenTM + " hết tồn");
                                    return false;
                                }
                                else if (decimal.Parse(_DMThuocKhoa.TonCK) < (decimal.Parse(soLuong)) * decimal.Parse(txtSLThang.Text))
                                {
                                    ShowMessage("Thuốc " + _KhamBenh_ThuocSD_DY_C.TenTM + " hết tồn");
                                    return false;

                                }
                                else if (decimal.Parse(_DMThuocKhoa.TonCKDT) < (decimal.Parse(soLuong)) * decimal.Parse(txtSLThang.Text))
                                {
                                    ShowMessage("Thuốc " + _KhamBenh_ThuocSD_DY_C.TenTM + " hết tồn");
                                    return false;

                                }
                                //else if (decimal.Parse(_DMThuocKhoa.TonCKDT) - _DMThuocKhoa.Nguong - (decimal.Parse(soLuong)) * decimal.Parse(txtSLThang.Text) < 0 && HTC.ShareVariables.pub_spC == "QN" && _NoiTT == "085" && _DMThuocKhoa.Nguong > 0)
                                //{
                                //    ShowMessage("Thuốc " + _KhamBenh_ThuocSD_DY_C.TenTM + " đã gần hết tồn");

                                //}
                                _KhamBenh_ThuocSD_DY_C.QuyDoi = _DMThuocKhoa.quydoi;
                                _KhamBenh_ThuocSD_DY_C.SLKeDon = (decimal.Parse(soLuong) / _DMThuocKhoa.quydoi).ToString();
                                _KhamBenh_ThuocSD_DY_C.SLMua = _KhamBenh_ThuocSD_DY_C.SLKeDon;
                                _KhamBenh_ThuocSD_DY_C.SoLuongD = soLuong;

                                _KhamBenh_ThuocSD_DY_C.BHTinhtien = _DMThuocKhoa.DTBH;
                                _KhamBenh_ThuocSD_DY_C.QuyDoi = _DMThuocKhoa.quydoi;
                                _KhamBenh_ThuocSD_DY_C.DongiaBH = (string.IsNullOrEmpty(_DMThuocKhoa.DonGiaBH) ? "0" : _DMThuocKhoa.DonGiaBH);
                                _KhamBenh_ThuocSD_DY_C.DongiaTT = (string.IsNullOrEmpty(_DMThuocKhoa.DonGiaTT) ? "0" : _DMThuocKhoa.DonGiaTT);

                                if (_DMThuocKhoa.adphongmo > 1)
                                {
                                    // _KhamBenh_ThuocSD.TinhNgoai = True
                                    _KhamBenh_ThuocSD_DY_C.BHTinhtien = false;
                                }
                                else if (_DMThuocKhoa.adphongmo == 2)
                                {
                                    //_KhamBenh_ThuocSD.TinhNgoai = True
                                    _KhamBenh_ThuocSD_DY_C.BHTinhtien = false;
                                }
                                if (_DMThuocKhoa.ADChenhLech == true)
                                {
                                    _KhamBenh_ThuocSD_DY_C.GiaChenhLech = (string.IsNullOrEmpty(_DMThuocKhoa.GiaChenhlech) ? "0" : _DMThuocKhoa.GiaChenhlech);
                                }
                                else
                                {
                                    _KhamBenh_ThuocSD_DY_C.GiaChenhLech = "0";
                                }
                                _KhamBenh_ThuocSD_DY_C.Mathuoc = mathuoc;


                                _KhamBenh_ThuocSD_DY_C.TenDVT = _DMThuocKhoa.TenDVT;
                                _KhamBenh_ThuocSD_DY_C.TinhNgoai = (_DMThuocKhoa.ApdungGoi == true ? false : true);

                                _KhamBenh_ThuocSD_DY_C.MaMay = Pub_sMaMay;
                                _KhamBenh_ThuocSD_DY_C.NguoiSD = Pub_sNguoiSD;
                                _KhamBenh_ThuocSD_DY_C.TONCK = decimal.Parse(_DMThuocKhoa.TonCK == "" ? "0" : _DMThuocKhoa.TonCK);
                                _KhamBenh_ThuocSD_DY_C.TONCKDT = decimal.Parse(_DMThuocKhoa.TonCKDT == "" ? "0" : _DMThuocKhoa.TonCKDT);
                                if (action == FormAction.INSERT)
                                {
                                    if (_KhamBenh_ThuocSD_DY_CList.Count == 0)
                                    {
                                        _KhamBenh_ThuocSD_DY_C.STTThuoc = 1;
                                    }
                                    else
                                    {
                                        _KhamBenh_ThuocSD_DY_C.STTThuoc = _KhamBenh_ThuocSD_DY_CList[_KhamBenh_ThuocSD_DY_CList.Count - 1].STTThuoc + 1;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            if (action == FormAction.EDIT)
            {
                if (editedItem != null)

                    _KhamBenh_ThuocSD_DY_CList.UpdatedTo(_KhamBenh_ThuocSD_DY_C);
                //_KhamBenh_ThuocSD_DY.ApplyEdit();     

                //_KhamBenh_ThuocSD_DY.Save();
            }
            else if (action == FormAction.INSERT)
            {
                if (editedItem != null)
                    _KhamBenh_ThuocSD_DY_CList.AssignTo(_KhamBenh_ThuocSD_DY_C);
                //_KhamBenh_ThuocSD_DY.ApplyEdit();     
                //_KhamBenh_ThuocSD_DY.Save();

            }
            else if (action == FormAction.DELETE)
            {
                if (editedItem != null)
                {
                    _KhamBenh_ThuocSD_DY_C.MaMay = Pub_sMaMay;
                    _KhamBenh_ThuocSD_DY_C.NguoiSD = Pub_sNguoiSD;

                    _KhamBenh_ThuocSD_DY_CList.RemoveTo(_KhamBenh_ThuocSD_DY_C);
                }
            }
            if (_KhamBenh_ThuocSD_DY_CList.Count == 1 && action == FormAction.INSERT)
            {
                _KhamBenh_ThuocSD_DY_C.MaMay = Pub_sMaMay;
                _KhamBenh_ThuocSD_DY_C.NguoiSD = Pub_sNguoiSD;
                if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
                {
                    _KhamBenh_ThuocSD_DY.BSChiDinh = _KhamBenh_ThuocSD_DY.BSChiDinh != cboNhanVien.SelectedValue ? cboNhanVien.SelectedValue : _KhamBenh_ThuocSD_DY.BSChiDinh;
                    _KhamBenh_ThuocSD_DY.TenBSChidinh = _KhamBenh_ThuocSD_DY.BSChiDinh != cboNhanVien.SelectedValue ? cboNhanVien.Text : _KhamBenh_ThuocSD_DY.TenBSChidinh;

                }
                _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.NewTo(_KhamBenh_ThuocSD_DY);
            }
            else
            {
                _KhamBenh_ThuocSD_DY_C.MaMay = Pub_sMaMay;
                _KhamBenh_ThuocSD_DY_C.NguoiSD = Pub_sNguoiSD;
                _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.UpdatedTo(_KhamBenh_ThuocSD_DY);
            }

            _KhamBenh_ThuocSD_DY.TinhLaiDon();
            txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
            txtTT.Value = (_KhamBenh_ThuocSD_DY.SLMua == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua)).ToString("###,###");
            txtDonThang.Text = txtTT.Value;
            grdThuocDY.EditIndexes.Clear();
            grdThuocDY.MasterTableView.Rebind();




        }
        catch (Exception ex)
        {
            ShowMessage("Không lưu được dữ liệu" + ex.Message);

            //throw;
        }

        return true;
    }

    //private bool UpdateDataVTTH(GridEditableItem editedItem, FormAction action)
    //{
    //    string MaVT = string.Empty;

    //    try
    //    {
    //        KhamBenh_VTTH _KhamBenh_VTTH;
    //        if (action == FormAction.INSERT)
    //            _KhamBenh_VTTH = KhamBenh_VTTH.NewKhamBenh_VTTH();
    //        else
    //        {
    //            int STT = int.Parse(editedItem.GetDataKeyValue("STT").ToString());

    //            _KhamBenh_VTTH = _ThongtinBN.KhamBenh.KhamBenh_VTTHList.FirstOrDefault(X => X.STT == STT);
    //        }
    //        if (action != FormAction.DELETE)
    //        {
    //            _KhamBenh_VTTH.MaSoKham = _MaSoKham;
    //            _KhamBenh_VTTH.Makhoa = _MaKhoa;
    //            _KhamBenh_VTTH.MaBN = _MaBN;
    //            _KhamBenh_VTTH.TToanSau = true; _KhamBenh_VTTH.dadung = true;



    //            if (!CheckFormData()) return false;
    //            else
    //            {

    //                if (editedItem["SLKeDon"].FindControl("tbSoLuong") == null)
    //                    return false;
    //                string soLuong = ((RadNumericTextBox)editedItem["SLKeDon"].FindControl("tbSoLuong")).Text;
    //                Boolean tinhtien = ((CheckBox)editedItem["TinhTien"].FindControl("chkTT")).Checked;
    //                Boolean ktinhtien = false;//((CheckBox)editedItem["KTinhTien"].FindControl("chkKTT")).Checked;
    //                if (soLuong == "" || soLuong == null || soLuong == "0")
    //                {
    //                    ShowMessage("Chưa nhập số lượng");
    //                    ((RadNumericTextBox)editedItem["SLKeDon"].FindControl("tbSoLuong")).Focus();
    //                    return false;
    //                };

    //                if (decimal.Parse(soLuong) < 0)
    //                {
    //                    ShowMessage("Số lượng định dạng sai");
    //                    ((RadNumericTextBox)editedItem["SLKeDon"].FindControl("tbSoLuong")).Focus();

    //                    return false;
    //                };


    //                if (action != FormAction.DELETE)
    //                {
    //                    _KhamBenh_VTTH.NgayDK = _NgayDK;


    //                    //_KhamBenh_VTTH.SLKeDon = soLuong;
    //                    //_KhamBenh_VTTH.SLMua = _KhamBenh_VTTH.SLKeDon;
    //                    _KhamBenh_VTTH.Tinhtien = tinhtien;

    //                    _KhamBenh_VTTH.NguoiSD = Pub_sNguoiSD;
    //                    if (ktinhtien == true)
    //                    {
    //                        _KhamBenh_VTTH.DonGiaBH = "0";
    //                        _KhamBenh_VTTH.DongiaTT = "0";
    //                    }
    //                    else if ((_KhamBenh_VTTH.DongiaTT == "" || _KhamBenh_VTTH.DongiaTT == "0") && action == FormAction.EDIT)
    //                    {
    //                        DMVTYTKhoaList list = DMVTYTKhoaList.FindDMVTYTKhoaMa("011", _ThongtinBN.KhamBenh.MaDT, _KhamBenh_VTTH.MaVT, 3) as DMVTYTKhoaList;

    //                        if (list == null)
    //                            return false;
    //                        DMVTYTKhoa _DMVTYTKhoa = list.FirstOrDefault(X => X.MaVT == _KhamBenh_VTTH.MaVT);
    //                        if (_DMVTYTKhoa == null)
    //                            return false;
    //                        _KhamBenh_VTTH.BHTinhtien = _DMVTYTKhoa.DTBH;
    //                        _KhamBenh_VTTH.DonGiaBH = (string.IsNullOrEmpty(_DMVTYTKhoa.DonGiaBH) ? "0" : _DMVTYTKhoa.DonGiaBH);
    //                        _KhamBenh_VTTH.DongiaTT = (string.IsNullOrEmpty(_DMVTYTKhoa.DonGiaTT) ? "0" : _DMVTYTKhoa.DonGiaTT);

    //                    }
    //                    if (action == FormAction.EDIT)
    //                    {
    //                        _KhamBenh_VTTH.SLKeDon = (decimal.Parse(soLuong) / _KhamBenh_VTTH.QuyDoi).ToString();
    //                        _KhamBenh_VTTH.SLMua = _KhamBenh_VTTH.SLKeDon;
    //                        _KhamBenh_VTTH.SoLuongD = soLuong;
    //                    }
    //                    ////   ============================================
    //                    if (action == FormAction.INSERT)
    //                    {
    //                        RadComboBox cboThuoc = editedItem["MaVT"].FindControl("cboVTTH") as RadComboBox;
    //                        if (cboThuoc != null)
    //                        {
    //                            MaVT = cboThuoc.SelectedValue;
    //                        }
    //                        if (MaVT == "" || MaVT == null)
    //                            return false;
    //                        // DMVTYTKhoaList list = odsVTTH.Select() as DMVTYTKhoaList;
    //                        DMVTYTKhoaList list = DMVTYTKhoaList.FindDMVTYTKhoaMa(_MaKhoa, _ThongtinBN.KhamBenh.MaDT, MaVT, 3) as DMVTYTKhoaList;

    //                        if (list == null)
    //                            return false;
    //                        DMVTYTKhoa _DMVTYTKhoa = list.FirstOrDefault(X => X.MaVT == MaVT);
    //                        if (_DMVTYTKhoa == null)
    //                            return false;
    //                        //-----
    //                        if (_DMVTYTKhoa.TonCK == "" || _DMVTYTKhoa.TonCK == "0")
    //                        {
    //                            ShowMessage("Vật tư " + _DMVTYTKhoa.TenTM + " hết tồn");
    //                            return false;
    //                        }
    //                        else if (decimal.Parse(_DMVTYTKhoa.TonCK) < decimal.Parse(soLuong))
    //                        {
    //                            ShowMessage("Vật tư " + _KhamBenh_VTTH.TenTM + " hết tồn");
    //                            return false;

    //                        }
    //                        else if (decimal.Parse(_DMVTYTKhoa.TonCKDT) < decimal.Parse(soLuong))
    //                        {
    //                            ShowMessage("Vật tư " + _KhamBenh_VTTH.TenTM + " hết tồn");
    //                            return false;

    //                        }
    //                        else
    //                        {
    //                            _KhamBenh_VTTH.TONCKDT = decimal.Parse(_DMVTYTKhoa.TonCKDT) - decimal.Parse(soLuong);
    //                            _KhamBenh_VTTH.TONCK = decimal.Parse(_DMVTYTKhoa.TonCK == "" ? "0" : _DMVTYTKhoa.TonCK) - decimal.Parse(soLuong);


    //                        };
    //                        //  --------------
    //                        _KhamBenh_VTTH.BHTinhtien = _DMVTYTKhoa.DTBH;
    //                        _KhamBenh_VTTH.CK = "0";
    //                        _KhamBenh_VTTH.DonGiaBH = (string.IsNullOrEmpty(_DMVTYTKhoa.DonGiaBH) ? "0" : _DMVTYTKhoa.DonGiaBH);
    //                        _KhamBenh_VTTH.DongiaTT = (string.IsNullOrEmpty(_DMVTYTKhoa.DonGiaTT) ? "0" : _DMVTYTKhoa.DonGiaTT);
    //                        _KhamBenh_VTTH.NoiTTBH = _NoiTT;
    //                        _KhamBenh_VTTH.NoiTTTT = _NoiTT;
    //                        _KhamBenh_VTTH.MaDT = _ThongtinBN.KhamBenh.MaDT;
    //                        if (ktinhtien == true)
    //                        {
    //                            _KhamBenh_VTTH.DonGiaBH = "0";
    //                            _KhamBenh_VTTH.DongiaTT = "0";
    //                        }
    //                        if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
    //                        {
    //                            _KhamBenh_VTTH.BSChiDinh = cboNhanVien.SelectedValue;
    //                            _KhamBenh_VTTH.tenbschidinh = cboNhanVien.Text;

    //                        }
    //                        if (_DMVTYTKhoa.adphongmo > 1)
    //                        {
    //                            // _KhamBenh_VTTH.TinhNgoai = True
    //                            _KhamBenh_VTTH.BHTinhtien = false;
    //                        }
    //                        else if (_DMVTYTKhoa.adphongmo == 2)
    //                        {
    //                            //_KhamBenh_VTTH.TinhNgoai = True
    //                            _KhamBenh_VTTH.BHTinhtien = false;
    //                        }
    //                        if (_DMVTYTKhoa.ADChenhLech == true)
    //                        {
    //                            _KhamBenh_VTTH.GiaChenhLech = (string.IsNullOrEmpty(_DMVTYTKhoa.GiaChenhlech) ? "0" : _DMVTYTKhoa.GiaChenhlech);
    //                        }
    //                        else
    //                        {
    //                            _KhamBenh_VTTH.GiaChenhLech = "0";
    //                        }
    //                        _KhamBenh_VTTH.MaVT = MaVT;

    //                        _KhamBenh_VTTH.TenTM = _DMVTYTKhoa.TenTM;
    //                        _KhamBenh_VTTH.tendvt = _DMVTYTKhoa.TenDVT;
    //                        _KhamBenh_VTTH.Tinhtien = tinhtien;
    //                        ///''''''''''''''''''''''
    //                        _KhamBenh_VTTH.MaSoKham = _MaKhoa;
    //                        _KhamBenh_VTTH.MaBN = _MaBN;
    //                        _KhamBenh_VTTH.QuyDoi = _DMVTYTKhoa.quydoi;
    //                        _KhamBenh_VTTH.SLKeDon = (decimal.Parse(soLuong) / _KhamBenh_VTTH.QuyDoi).ToString();
    //                        _KhamBenh_VTTH.SLMua = _KhamBenh_VTTH.SLKeDon;
    //                        _KhamBenh_VTTH.SoLuongD = soLuong;
    //                        if (action == FormAction.INSERT)
    //                        {
    //                            if (_ThongtinBN.KhamBenh.KhamBenh_VTTHList.Count == 0)
    //                            {
    //                                _KhamBenh_VTTH.STT = 1;
    //                            }
    //                            else
    //                            {
    //                                _KhamBenh_VTTH.STT = _ThongtinBN.KhamBenh.KhamBenh_VTTHList[_ThongtinBN.KhamBenh.KhamBenh_VTTHList.Count - 1].STT + 1;
    //                            }
    //                        }
    //                    }
    //                }
    //            }
    //        }
    //        if (action == FormAction.EDIT)
    //        {
    //            _KhamBenh_VTTH.MaMay = Pub_sMaMay;
    //            _KhamBenh_VTTH.NguoiSD = Pub_sNguoiSD;
    //            _ThongtinBN.KhamBenh.KhamBenh_VTTHList.UpdatedTo(_KhamBenh_VTTH, _ThongtinBN.KhamBenh);
    //            //_ThongtinBN.KhamBenh.KhamBenh_VTTHList.ApplyEdit();     
    //            //_ThongtinBN.KhamBenh.KhamBenh_VTTHList.Save();
    //        }
    //        else if (action == FormAction.INSERT)
    //        {
    //            _KhamBenh_VTTH.MaMay = Pub_sMaMay;
    //            _KhamBenh_VTTH.NguoiLap = Pub_sNguoiSD; _KhamBenh_VTTH.NguoiSD = Pub_sNguoiSD;

    //            _ThongtinBN.KhamBenh.KhamBenh_VTTHList.AssignTo(_KhamBenh_VTTH, _ThongtinBN.KhamBenh);
    //            //_ThongtinBN.KhamBenh.KhamBenh_VTTHList.ApplyEdit();     
    //            //_ThongtinBN.KhamBenh.KhamBenh_VTTHList.Save();

    //        }
    //        else if (action == FormAction.DELETE)
    //        {
    //            _KhamBenh_VTTH.MaMay = Pub_sMaMay;
    //            _KhamBenh_VTTH.NguoiSD = Pub_sNguoiSD;
    //            _KhamBenh_VTTH.NguoiHuy = Pub_sNguoiSD; _ThongtinBN.KhamBenh.KhamBenh_VTTHList.RemoveTo(_KhamBenh_VTTH, _ThongtinBN.KhamBenh);
    //            //_ThongtinBN.KhamBenh.KhamBenh_VTTHList.ApplyEdit();     
    //            //_ThongtinBN.KhamBenh.KhamBenh_VTTHList.Save();
    //        }
    //        _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();
    //        grdVTTH.EditIndexes.Clear();
    //        grdVTTH.MasterTableView.Rebind();
    //        grdVTTH.Rebind();




    //    }
    //    catch (Exception ex)
    //    {
    //        ShowMessage("Không lưu được dữ liệu" + ex.Message);

    //        //throw;
    //    }

    //    return true;

    //}


    private void PrintData(Boolean _load = true, string _in = "")
    {
        try
        {
            String sPath;
            String ngay = DateTime.Now.Day <= 9 ? "0" + DateTime.Now.Day.ToString() : DateTime.Now.Day.ToString();
            String thang = DateTime.Now.Month <= 9 ? "0" + DateTime.Now.Month.ToString() : DateTime.Now.Month.ToString();
            KhamBenh_C _KhamBenh_KB = _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(X => X.STT == _STT);
            if (_in == "CD")
            {
                if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                {
                    Boolean _print = false;
                    foreach (KhamBenh_C _kbc in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                    {
                        if (_kbc.DaTT == 0 && _kbc.STT != 1)
                        {
                            _print = true;
                            break; // TODO: might not be correct. Was : Exit For
                        }
                    }
                    if (_print == true)
                    {
                        DataSet ReportData1 = new DataSet();
                        ReportData1 = HTC.Business.DataProvider.Instance().RptGetKhambenh_ChiDinhBS(false, _ThongtinBN.KhamBenh.MaSoKham, byte.Parse("0"), _LoaiPhieu, " and isnull(a.datt,0) =0 and isnull(a.mahuongdt,'')='' AND isnull(b.malh,'')  not in ('00003','00030')");//and isnull(b.malh,'') not in ('00080','00091')
                        if (ReportData1.Tables[0].Rows.Count > 0)
                        {
                            if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) != "0" && HTC.ShareVariables.pub_spC == "HU")
                                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuTA4_RPT.rpt";
                            else if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "0")
                                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuTDG_RPT.rpt";
                            else if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) != "1")
                            {
                                //  if (_NoiTT == "085" & HTC.ShareVariables.pub_spC == "YH")
                                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuTDG_rpt.rpt";
                                //else
                                //    sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuDG.rpt";
                            }
                            else
                                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuT_rpt.rpt";
                            ReportDocument rpt = new ReportDocument();
                            FormulaFieldDefinitions Myformulas;
                            rpt.Load(Server.MapPath(sPath));
                            Myformulas = rpt.DataDefinition.FormulaFields;
                            Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                            Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                            if (_NoiTT == "087")
                            {
                                Myformulas["khoakb"].Text = "'" + HTC.ShareVariables.pub_sTenPK + "'";
                            }
                            else if (_KhamBenh_KB.Makhoa.Substring(0, 3) != "011")
                            {
                                Myformulas["khoakb"].Text = "'" + _KhamBenh_KB.tenkhoa + "'";
                            }
                            Myformulas["noidk"].Text = "'" + _ThongtinBN.KhamBenh.mabhxh + "-" + _ThongtinBN.KhamBenh.tenbv + "'";
                            if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "0")
                            {
                                Myformulas["nguoilap"].Text = "'Họ và tên bác sỹ'";
                            }
                            Myformulas["mabn"].Text = "'*" + _ThongtinBN.MaBN + "*'";
                            Myformulas["NGAYDK"].Text = "'" + _ThongtinBN.KhamBenh.NgayDK + "'";
                            Myformulas["hoten"].Text = "'" + txtHoTen.Text.Replace("'", "''") + "'";
                            // Myformulas["masokham"].Text = "'" &  _ThongtinBN.KhamBenh.MaSoKham & "'"
                            Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text.Replace("'", "''") + "'";
                            Myformulas["BacSy"].Text = "'BS:" + cboNhanVien.Text + "'";
                            Myformulas["tennguoiyc"].Text = "'BS:" + cboNhanVien.Text + "'";
                            Myformulas["doituong"].Text = "'" + txtDoiTuong.Text + "'";
                            Myformulas["sothe"].Text = "'" + txtSoThe.Text + "'";
                            Myformulas["tungay"].Text = "'" + _ThongtinBN.GiaTriTN + "'";
                            Myformulas["denngay"].Text = "'" + _ThongtinBN.GiaTriDN + "'";
                            Myformulas["Gt"].Text = "'" + (lblGioitinh.Items[0].Selected == true ? " Nam" : "Nữ") + "'";
                            //if ( _ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                            //{
                            //    Myformulas["ChandoanBD"].Text = "'" +_KhamBenh_Noi.MaICD + "-" +_KhamBenh_Noi.TenBenh + "-" +  _ThongtinBN.KhamBenh.Ghichu + "'";
                            //    Myformulas["ChanDoan"].Text = "'" + _KhamBenh_KB.maicd + "-" + _KhamBenh_KB.tenbenh + "-" +  _ThongtinBN.KhamBenh.Ghichu + "'";
                            //}
                            Myformulas["ChandoanBD"].Text = "'" + _KhamBenh_KB.tenbenh + "'";
                            Myformulas["ChanDoan"].Text = "'" + _KhamBenh_KB.tenbenh + "'";
                            // Myformulas["ChanDoankem"].Text = "'" + _KhamBenh_KB.maicdKem + "-" + _KhamBenh_KB.tenbenhKem + "," + _KhamBenh_KB.maicdKem2 + "-" + _KhamBenh_KB.tenbenhKem2 + "," + _KhamBenh_KB.maicdKem3 + "-" + _KhamBenh_KB.tenbenhKem3 + "'";
                            //Myformulas["ChanDoankem"].Text = "'" + _KhamBenh_KB.maicdKem + "-" + _KhamBenh_KB.tenbenhKem + "," + _KhamBenh_KB.maicdKem2 + "-" + _KhamBenh_KB.tenbenhKem2 + "," + _KhamBenh_KB.maicdKem3 + "-" + _KhamBenh_KB.tenbenhKem3 + "'";
                            Myformulas["ChanDoankem"].Text = "'" + _KhamBenh_KB.maicdKem + "-" + _KhamBenh_KB.tenbenhKem + "'";
                            Myformulas["khoa"].Text = "'" + _KhamBenh_KB.tenkhoa + "'";
                            Myformulas["bn"].Text = "'" + _ThongtinBN.MaBN + "'";
                            Myformulas["Tuoi"].Text = "'" + _ThongtinBN.NgaySinh.Substring(6, 4) + "'";
                            Myformulas["Ngayin"].Text = "'Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                            Myformulas["TenBC"].Text = "'" + ("Chỉ định dịch vụ").ToUpper() + "'";
                            rpt.SetDataSource(ReportData1);
                            PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer1.LoadReport(rpt, true, false);
                        }
                        ReportData1 = null;
                        //    //
                        //    // giai phau benh
                        //    if (_load == true)
                        //        ReportData2 = HTC.Business.DataProvider.Instance().RptGetKhambenh_ChiDinhBS(false,  _ThongtinBN.KhamBenh.MaSoKham, byte.Parse("0"), _LoaiPhieu, " and isnull(a.datttt,0) =0 and isnull(a.mahuongdt,'')='' and isnull(a.dattbh,0) =0 and isnull(b.malh,'') in ('00080')  and a.bschidinh ='" + cboNhanVien.SelectedValue + "'");
                        //    if (ReportData2.Tables[0].Rows.Count > 0)
                        //    {
                        //        sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crPhieuXNGP.rpt";
                        //        ReportDocument rpt = new ReportDocument();
                        //        FormulaFieldDefinitions Myformulas;
                        //        rpt.Load(Server.MapPath(sPath));
                        //        Myformulas = rpt.DataDefinition.FormulaFields;
                        //        Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                        //        Myformulas["tendvcq"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                        //        Myformulas["khoa"].Text = "'" + _KhamBenh_KB.tenkhoa + "'";
                        //        Myformulas["SOVAOVIEN"].Text = "'*" + _ThongtinBN.MaBN + "*'";
                        //        Myformulas["masokham"].Text = "'*" +  _ThongtinBN.KhamBenh.MaSoKham + "*'";
                        //        // Myformulas["NGAYDK"].Text = "'" & Strings.Mid( _ThongtinBN.KhamBenh.NgayDK, 3, 2) & "/" & Strings.Mid( _ThongtinBN.KhamBenh.NgayDK, 1, 2) & "/" & Strings.Mid( _ThongtinBN.KhamBenh.NgayDK, 7, 3) & "'"
                        //        Myformulas["hoten"].Text = "'" + txtHoTen.Text.Replace ("'","''") + "'";
                        //        // Myformulas["masokham"].Text = "'" &  _ThongtinBN.KhamBenh.MaSoKham & "'"
                        //               Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text.Replace("'","''") + "'";
                        //        Myformulas["BacSiDT"].Text = "'BS:" + cboNhanVien.Text + "'";
                        //        Myformulas["ChuanDoan"].Text = "'" + ((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text + "," + (cboChanDoanKem.Text != "" ? cboChanDoanKem.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem.Text + "," + (cboChanDoanKem2.Text != "" ? cboChanDoanKem2.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem2.Text + "," + (cboChanDoanKem3.Text != "" ? cboChanDoanKem3.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem3.Text) + "'";
                        //        Myformulas["Tuoi"].Text = "'" + txtTuoi.Text + "'";
                        //        Myformulas["Gt"].Text = "'" + (lblGioitinh.Items[0].Selected == true ? " Nam" : "Nữ") + "'";
                        //        Myformulas["SoTheBHYT"].Text = "'" + (txtSoThe.Text).ToUpper() + "'";
                        //        Myformulas["Ngaybc"].Text = "'Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                        //        rpt.SetDataSource(ReportData2);
                        //        PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer2.LoadReport(rpt, true, false);
                        //    }
                        //    // te bao
                        //    if (_load == true)
                        //        ReportData3 = HTC.Business.DataProvider.Instance().RptGetKhambenh_ChiDinhBS(false,  _ThongtinBN.KhamBenh.MaSoKham, byte.Parse("0"), _LoaiPhieu, " and isnull(a.datttt,0) =0 and isnull(a.mahuongdt,'')='' and isnull(a.dattbh,0) =0 and isnull(b.malh,'') in ('00091')  and a.bschidinh ='" + cboNhanVien.SelectedValue + "'");
                        //    if (ReportData3.Tables[0].Rows.Count > 0)
                        //    {
                        //        sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crPhieuXNTB.rpt";
                        //        ReportDocument rpt = new ReportDocument();
                        //        FormulaFieldDefinitions Myformulas;
                        //        rpt.Load(Server.MapPath(sPath));
                        //        Myformulas = rpt.DataDefinition.FormulaFields;
                        //        Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                        //        Myformulas["tendvcq"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                        //        Myformulas["khoa"].Text = "'" + _KhamBenh_KB.tenkhoa + "'";
                        //        Myformulas["SOVAOVIEN"].Text = "'*" + _ThongtinBN.MaBN + "*'";
                        //        Myformulas["masokham"].Text = "'*" +  _ThongtinBN.KhamBenh.MaSoKham + "*'";
                        //        // Myformulas["NGAYDK"].Text = "'" & Strings.Mid( _ThongtinBN.KhamBenh.NgayDK, 3, 2) & "/" & Strings.Mid( _ThongtinBN.KhamBenh.NgayDK, 1, 2) & "/" & Strings.Mid( _ThongtinBN.KhamBenh.NgayDK, 7, 3) & "'"
                        //        Myformulas["hoten"].Text = "'" + txtHoTen.Text.Replace ("'","''") + "'";
                        //        // Myformulas["masokham"].Text = "'" &  _ThongtinBN.KhamBenh.MaSoKham & "'"
                        //               Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text.Replace("'","''") + "'";
                        //        Myformulas["BacSiDT"].Text = "'BS:" + cboNhanVien.Text + "'";
                        //        Myformulas["ChuanDoan"].Text = "'" + ((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text + "," + (cboChanDoanKem.Text != "" ? cboChanDoanKem.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem.Text + "," + (cboChanDoanKem2.Text != "" ? cboChanDoanKem2.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem2.Text + "," + (cboChanDoanKem3.Text != "" ? cboChanDoanKem3.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem3.Text) + "'";
                        //        Myformulas["Tuoi"].Text = "'" + txtTuoi.Text + "'";
                        //        Myformulas["Gt"].Text = "'" + (lblGioitinh.Items[0].Selected == true ? " Nam" : "Nữ") + "'";
                        //        Myformulas["SoTheBHYT"].Text = "'" + (txtSoThe.Text).ToUpper() + "'";
                        //        Myformulas["Ngaybc"].Text = "'Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                        //        rpt.SetDataSource(ReportData3);
                        //        PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer3.LoadReport(rpt, true, false);
                        //    }
                    }
                }
            }
            else
            {
                DataSet ReportData6 = new DataSet();
                DataSet ReportData8 = new DataSet();
                DataSet ReportData4 = new DataSet();
                DataSet ReportData5 = new DataSet();
                // dy
                if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count > 0)
                {
                    Boolean _print = false;
                    foreach (KhamBenh_ThuocSD_DY _kbc in _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList)
                    {
                        if (_kbc.DATT == 0)
                        {
                            _print = true;
                            break; // TODO: might not be correct. Was : Exit For
                        }
                    }
                    if (_print == true || HTC.ShareVariables.pub_spC == "HU")
                    {
                        if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "0")
                            ReportData6 = HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc_DY(_ThongtinBN.KhamBenh.MaSoKham, " and  left(k.madt,1)='0' and isnull(dattbh,0) = 0  and isnull(datttt,0) = 0 and isnull(slthang,0) <> 0 and k.bschidinh ='" + cboNhanVien.SelectedValue + "'", false);
                        else if (HTC.ShareVariables.pub_spC == "HU")
                            ReportData6 = HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc_DY(_ThongtinBN.KhamBenh.MaSoKham, " and  left(k.slmua,1) - isnull(k.sltra,0) >0  and  left(k.madt,1) <>'0' and isnull(slthang,0) <> 0 and k.bschidinh ='" + cboNhanVien.SelectedValue + "'", false);
                        else
                            ReportData6 = HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc_DY(_ThongtinBN.KhamBenh.MaSoKham, " and  left(k.madt,1) <>'0' and isnull(dattbh,0) = 0  and isnull(datttt,0) = 0 and isnull(slthang,0) <> 0 and k.bschidinh ='" + cboNhanVien.SelectedValue + "'", false);
                        if (ReportData6.Tables[0].Rows.Count > 0)
                        {
                            //thuoc gay nghien
                            String mapl = "00002";
                            //bool contains = ReportData6.Tables[0].AsEnumerable().Any(row => mapl == row.Field<String>("mapl"));
                            DataTable tblgaynghien = ReportData6.Tables[0].AsEnumerable()
                             .Where(r => r.Field<string>("mapl") == mapl)
                             .CopyToDataTable();
                            if (tblgaynghien != null && tblgaynghien.Rows.Count > 0)
                            {
                                GuiDonThuoc(tblgaynghien, "n");
                            }
                            //thuoc huong than
                            mapl = "00003";
                            DataTable tblhuongthan = ReportData6.Tables[0].AsEnumerable()
                             .Where(r => r.Field<string>("mapl") == mapl)
                             .CopyToDataTable();
                            if (tblhuongthan != null && tblhuongthan.Rows.Count > 0)
                            {
                                GuiDonThuoc(tblhuongthan, "h");
                            }
                            //thuoc thuong
                            DataTable tblthuong = ReportData6.Tables[0].AsEnumerable()
                             .Where(r => (r.Field<string>("mapl") != "00002") && (r.Field<string>("mapl") != "00003"))
                             .CopyToDataTable();
                            if (tblthuong != null && tblthuong.Rows.Count > 0)
                            {
                                GuiDonThuoc(tblhuongthan, "c");
                            }
                            //reports
                            if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) != "1")
                                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRKhamBenh_DonThuoc_DYA5.rpt";
                            else
                                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRKhamBenh_DonThuoc_DYBHA5.rpt";
                            ReportDocument rpt = new ReportDocument();
                            FormulaFieldDefinitions Myformulas;
                            rpt.Load(Server.MapPath(sPath));
                            Myformulas = rpt.DataDefinition.FormulaFields;
                            Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                            Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                            Myformulas["DiaChiBV"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV + "'";
                            //Myformulas["NgayBC"].Text = "'" & Strings.Format(htc.ShareVariables .NgayLV , "dd/MM/yyyy") & "'"
                            Myformulas["NgayBC"].Text = "'" + "Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                            Myformulas["TenBN"].Text = "'" + txtHoTen.Text + "'";
                            Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text.Replace("'", "''") + "'";
                            Myformulas["mabn"].Text = "'*" + _ThongtinBN.MaBN + "*'";
                            Myformulas["SoTheBHYT"].Text = "'" + txtSoThe.Text + "'";
                            // Myformulas["HuongDan"].Text = "'" + txtLieuDungDY.Text + "'";
                            Myformulas["BacSy"].Text = "'BS:" + cboNhanVien.Text + "'";
                            //   Myformulas["ChuanDoan"].Text = "'" + ((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text + "," + (cboChanDoanKem.Text != "" ? cboChanDoanKem.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem.Text + "," + (cboChanDoanKem2.Text != "" ? cboChanDoanKem2.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem2.Text + "," + (cboChanDoanKem3.Text != "" ? cboChanDoanKem3.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem3.Text) + "'";
                            Myformulas["ChuanDoan"].Text = "'" + ((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text + "," + (cboChanDoanKem.Text != "" ? cboChanDoanKem.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem.Text + "," + (cboChanDoanKem2.Text != "" ? cboChanDoanKem2.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem2.Text + "," + (cboChanDoanKem3.Text != "" ? cboChanDoanKem3.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem3.Text) + "'";
                            Myformulas["Tuoi"].Text = "'" + txtTuoi.Text + "'";
                            Myformulas["GioiTinh"].Text = "'" + (lblGioitinh.Items[0].Selected == true ? " Nam" : "Nữ") + "'";
                            Myformulas["SoTheBHYT"].Text = "'" + (txtSoThe.Text).ToUpper() + "'";
                            Myformulas["TenDT"].Text = "'" + txtDoiTuong.Text + "'";
                            Myformulas["BSDanDo"].Text = "'" + txtLoidan.Text.Replace("\r\n", "|||||").Replace("\r", "|||||") + "'";
                            rpt.SetDataSource(ReportData6);
                            PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer6.LoadReport(rpt, true, false);
                        }
                    }
                    if ((txtSLThangTT.Text != "" && txtSLThangTT.Text != "0") && _ThongtinBN.KhamBenh.MaDT.Substring(0, 1) != "0")
                    {
                        if ((txtSLThangTT.Text != "" && txtSLThangTT.Text != "0") && HTC.ShareVariables.pub_spC != "HU")
                            ReportData4 = HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc_DY(_ThongtinBN.KhamBenh.MaSoKham, " and  left(k.madt,1)='0' and isnull(dattbh,0) = 0  and isnull(datttt,0) = 0 and isnull(slthang,0) <> 0 and K.bschidinh ='" + cboNhanVien.SelectedValue + "'", false);
                        else if (HTC.ShareVariables.pub_spC == "HU")
                            ReportData4 = HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc_DY(_ThongtinBN.KhamBenh.MaSoKham, " and isnull(slthang,0) <> 0 and K.bschidinh ='" + cboNhanVien.SelectedValue + "'", false);

                        if (ReportData4.Tables[0].Rows.Count > 0)
                        {
                            //thuoc gay nghien
                            String mapl = "00002";
                            //bool contains = ReportData6.Tables[0].AsEnumerable().Any(row => mapl == row.Field<String>("mapl"));
                            DataTable tblgaynghien = ReportData4.Tables[0].AsEnumerable()
                             .Where(r => r.Field<string>("mapl") == mapl)
                             .CopyToDataTable();
                            if (tblgaynghien != null && tblgaynghien.Rows.Count > 0)
                            {
                                GuiDonThuoc(tblgaynghien, "n");
                            }
                            //thuoc huong than
                            mapl = "00003";
                            DataTable tblhuongthan = ReportData4.Tables[0].AsEnumerable()
                             .Where(r => r.Field<string>("mapl") == mapl)
                             .CopyToDataTable();
                            if (tblhuongthan != null && tblhuongthan.Rows.Count > 0)
                            {
                                GuiDonThuoc(tblhuongthan, "h");
                            }
                            //thuoc thuong
                            DataTable tblthuong = ReportData4.Tables[0].AsEnumerable()
                             .Where(r => (r.Field<string>("mapl") != "00002") && (r.Field<string>("mapl") != "00003"))
                             .CopyToDataTable();
                            if (tblthuong != null && tblthuong.Rows.Count > 0)
                            {
                                GuiDonThuoc(tblhuongthan, "c");
                            }
                            //reports
                            if (HTC.ShareVariables.pub_spC != "HU")
                                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRKhamBenh_DonThuoc_DYA5.rpt";
                            else
                                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRKhamBenh_DonThuoc_DYA5H.rpt";

                            ReportDocument rpt = new ReportDocument();
                            FormulaFieldDefinitions Myformulas;

                            rpt.Load(Server.MapPath(sPath));
                            Myformulas = rpt.DataDefinition.FormulaFields;
                            if (HTC.ShareVariables.pub_spC == "HU")
                            {
                                Myformulas["DienBien"].Text = "'" + txtbenhly.Text.Replace("'", "''") + txtXutri.Text.Replace("'", "''") + "'";
                                Myformulas["DieuTri"].Text = "'" + txtLoidan.Text.Replace("'", "''") + "'";
                            }
                            Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                            Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                            Myformulas["DiaChiBV"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV + "'";
                            //Myformulas["NgayBC"].Text = "'" & Strings.Format(htc.ShareVariables .NgayLV , "dd/MM/yyyy") & "'"
                            Myformulas["NgayBC"].Text = "'" + "Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                            Myformulas["TenBN"].Text = "'" + txtHoTen.Text + "'";
                            Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text.Replace("'", "''") + "'";
                            Myformulas["mabn"].Text = "'*" + _ThongtinBN.MaBN + "*'";
                            //  Myformulas["HuongDan"].Text = "'" + txtLieuDungDY.Text + "'";

                            Myformulas["SoTheBHYT"].Text = "'" + txtSoThe.Text + "'";


                            Myformulas["BacSy"].Text = "'BS:" + cboNhanVien.Text + "'";
                            //  Myformulas["ChuanDoan"].Text = "'" + ((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text + "," + (cboChanDoanKem.Text != "" ? cboChanDoanKem.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem.Text + "," + (cboChanDoanKem2.Text != "" ? cboChanDoanKem2.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem2.Text + "," + (cboChanDoanKem3.Text != "" ? cboChanDoanKem3.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem3.Text) + "'";
                            Myformulas["ChuanDoan"].Text = "'" + ((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text + "," + (cboChanDoanKem.Text != "" ? cboChanDoanKem.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem.Text + "," + (cboChanDoanKem2.Text != "" ? cboChanDoanKem2.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem2.Text + "," + (cboChanDoanKem3.Text != "" ? cboChanDoanKem3.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem3.Text) + "'";

                            Myformulas["Tuoi"].Text = "'" + txtTuoi.Text + "'";
                            Myformulas["GioiTinh"].Text = "'" + (lblGioitinh.Items[0].Selected == true ? " Nam" : "Nữ") + "'";
                            Myformulas["SoTheBHYT"].Text = "'" + (txtSoThe.Text).ToUpper() + "'";

                            Myformulas["TenDT"].Text = "'" + txtDoiTuong.Text + "'";

                            Myformulas["BSDanDo"].Text = "'" + txtLoidan.Text.Replace("\r\n", "|||||").Replace("\r", "|||||") + "'";

                            rpt.SetDataSource(ReportData4);

                            PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer4.LoadReport(rpt, true, false);
                        }

                    }
                }
                // ty
                if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count > 0)
                {
                    Boolean _print = false;
                    foreach (KhamBenh_ThuocSD _kbc in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
                    {
                        if (_kbc.DATT == 0)
                        {
                            _print = true;
                            break; // TODO: might not be correct. Was : Exit For
                        }
                    }
                    if (_print == true || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN")
                    {
                        if (_print == true)
                        {
                            ReportData5 = (HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc(_ThongtinBN.KhamBenh.MaSoKham, " and isnull(slkedon,0) <> 0 and a.bschidinh ='" + cboNhanVien.SelectedValue + "'", false));
                            if (ReportData5.Tables[0].Rows.Count > 0)
                            {
                                //thuoc gay nghien
                                String mapl = "00002";
                                //bool contains = ReportData6.Tables[0].AsEnumerable().Any(row => mapl == row.Field<String>("mapl"));
                                DataTable tblgaynghien = ReportData5.Tables[0].AsEnumerable()
                                 .Where(r => r.Field<string>("mapl") == mapl)
                                 .CopyToDataTable();
                                if (tblgaynghien != null && tblgaynghien.Rows.Count > 0)
                                {
                                    GuiDonThuoc(tblgaynghien, "n");
                                }
                                //thuoc huong than
                                mapl = "00003";
                                DataTable tblhuongthan = ReportData5.Tables[0].AsEnumerable()
                                 .Where(r => r.Field<string>("mapl") == mapl)
                                 .CopyToDataTable();
                                if (tblhuongthan != null && tblhuongthan.Rows.Count > 0)
                                {
                                    GuiDonThuoc(tblhuongthan, "h");
                                }
                                //thuoc thuong
                                DataTable tblthuong = ReportData5.Tables[0].AsEnumerable()
                                 .Where(r => (r.Field<string>("mapl") != "00002") && (r.Field<string>("mapl") != "00003"))
                                 .CopyToDataTable();
                                if (tblthuong != null && tblthuong.Rows.Count > 0)
                                {
                                    GuiDonThuoc(tblhuongthan, "c");
                                }
                                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRKhamBenh_DonThuocA5.rpt";
                                ReportDocument rptdv = new ReportDocument();
                                FormulaFieldDefinitions Myformulas;
                                rptdv.Load(Server.MapPath(sPath));
                                Myformulas = rptdv.DataDefinition.FormulaFields;
                                Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                                Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                                Myformulas["DiaChiBV"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV + "'";
                                //Myformulas["NgayBC"].Text = "'" & Strings.Format(htc.ShareVariables .NgayLV , "dd/MM/yyyy") & "'"
                                Myformulas["NgayBC"].Text = "'" + "Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                                Myformulas["TenBN"].Text = "'" + txtHoTen.Text + "'";
                                Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text.Replace("'", "''") + "'";
                                // Myformulas["dienbienbenh"].Text = "'" + (string.IsNullOrEmpty(txtHuyetap.Text) ? "" : "HA : " + txtHuyetap.Text) + ((string.IsNullOrEmpty(txtHohap.Text) ? "" : " Hô hấp : " + txtHohap.Text) + (string.IsNullOrEmpty(txtTieuHoa.Text) ? "" : " Tiêu hóa : " + txtTieuHoa.Text) + (string.IsNullOrEmpty(txtThan.Text) ? "" : " Thận, tiết niệu : " + txtThan.Text) + (string.IsNullOrEmpty(txtthankinh.Text) ? "" : " Thần kinh : " + txtthankinh.Text) + (string.IsNullOrEmpty(txtBenhDanh.Text) ? "" : " Tuần hoàn : " + txtBenhDanh.Text) + (string.IsNullOrEmpty(txtCoxuongkhop.Text) ? "" : " CXK :" + txtCoxuongkhop.Text) + (string.IsNullOrEmpty(txttmh.Text) ? "" : " TMH : " + txttmh.Text) + (string.IsNullOrEmpty(txtrhm.Text) ? "" : " RHM : " + txtrhm.Text) + (string.IsNullOrEmpty(txtmat.Text) ? "" : " Mắt : " + txtmat.Text) + (string.IsNullOrEmpty(txtnoitiet.Text) ? "" : " Nôi tiết " + txtnoitiet.Text) + (string.IsNullOrEmpty(txtkhac.Text) ? "" : " Bệnh khác : " + txtkhac.Text)).Replace("\r", "") + "'";
                                // Myformulas["dienbienbenh"].Text = "'" + (string.IsNullOrEmpty(txtHuyetap.Text) ? "" : "HA : " + txtHuyetap.Text) + ((string.IsNullOrEmpty(txtThan.Text) ? "" : " Văn chẩn : " + txtThan.Text) + (string.IsNullOrEmpty(txtthankinh.Text) ? "" : " Vọng chẩn : " + txtthankinh.Text) + (string.IsNullOrEmpty(txtnoitiet.Text) ? "" : " Vấn chẩn " + txtnoitiet.Text) + (string.IsNullOrEmpty(txtkhac.Text) ? "" : " Thiết chẩn : " + txtkhac.Text) + (string.IsNullOrEmpty(txtBenhDanh.Text) ? "" : " Tuần hoàn : " + txtBenhDanh.Text) + (string.IsNullOrEmpty(txttmh.Text) ? "" : " RHM-TMH : " + txttmh.Text) + (string.IsNullOrEmpty(txtmat.Text) ? "" : " Mắt : " + txtmat.Text)).Replace("\r", "") + "'";
                                Myformulas["dienbienbenh"].Text = "'" + (string.IsNullOrEmpty(txtMach.Text) ? "" : " Mạch : " + txtMach.Text) + (string.IsNullOrEmpty(txtHuyetap.Text) ? "" : "HA : " + txtHuyetap.Text) + "'"; //+ (string.IsNullOrEmpty(txtthankinh.Text) ? "" : " Vọng chẩn : " + txtthankinh.Text) + (string.IsNullOrEmpty(txtnoitiet.Text) ? "" : " Vấn chẩn " + txtnoitiet.Text) + (string.IsNullOrEmpty(txtkhac.Text) ? "" : " Thiết chẩn : " + txtkhac.Text) + (string.IsNullOrEmpty(txtBenhDanh.Text) ? "" : " Tuần hoàn : " + txtBenhDanh.Text) + (string.IsNullOrEmpty(txttmh.Text) ? "" : " RHM-TMH : " + txttmh.Text) + (string.IsNullOrEmpty(txtmat.Text) ? "" : " Mắt : " + txtmat.Text)).Replace("\r", "") + "'";
                                Myformulas["dieutri"].Text = "'" + txtXutri.Text + "'";
                                Myformulas["mabn"].Text = "'*" + _ThongtinBN.MaBN + "*'";
                                Myformulas["SoTheBHYT"].Text = "'" + txtSoThe.Text + "'";
                                Myformulas["TenDT"].Text = "'" + txtDoiTuong.Text + "'";
                                Myformulas["Tuoi"].Text = "'" + txtTuoi.Text + "'";
                                Myformulas["GioiTinh"].Text = "'" + (lblGioitinh.Items[0].Selected == true ? " Nam" : "Nữ") + "'";
                                Myformulas["BacSy"].Text = "'BS:" + cboNhanVien.Text + "'";
                                //   Myformulas["ChuanDoan"].Text = "'" + ((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text + "," + (cboChanDoanKem.Text != "" ? cboChanDoanKem.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem.Text + "," + (cboChanDoanKem2.Text != "" ? cboChanDoanKem2.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem2.Text + "," + (cboChanDoanKem3.Text != "" ? cboChanDoanKem3.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem3.Text) + "'";
                                Myformulas["ChuanDoan"].Text = "'" + ((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text + "," + (cboChanDoanKem.Text != "" ? cboChanDoanKem.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem.Text + "," + (cboChanDoanKem2.Text != "" ? cboChanDoanKem2.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem2.Text + "," + (cboChanDoanKem3.Text != "" ? cboChanDoanKem3.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem3.Text) + "'";
                                Myformulas["khoa"].Text = "'" + _KhamBenh_KB.tenkhoa + "'";
                                //  Myformulas["bsdando"].Text = "'" & CmbLoiDan.Text & "'"
                                Myformulas["BSDanDo"].Text = "'" + txtLoidan.Text.Replace("\r\n", "|||||").Replace("\r", "|||||") + "'";
                                //and a.stt in (" + IIf(Len(stts) > 0, Strings.Right(stts, Len(stts) - 1), "") + ")", 0))
                                rptdv.SetDataSource(ReportData5);
                                //rptdv.PrintToPrinter(1, false, 0, 0);
                                PrintExport(rptdv); rptdv.Dispose(); rptdv = null;//HTCReportViewer5.LoadReport(rptdv, true, false);
                            }
                        }
                        //reports
                        if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "1")
                        {
                            if (HTC.ShareVariables.pub_spC == "HU")
                                ReportData8 = (HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc(_ThongtinBN.KhamBenh.MaSoKham, " and isnull(bhtinhtien,0) = 1 and isnull(tinhtien,0)= 0  and isnull(slkedon,0) - isnull(sltra,0) > 0 and a.bschidinh ='" + cboNhanVien.SelectedValue + "'", false));
                            else
                                ReportData8 = (HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc(_ThongtinBN.KhamBenh.MaSoKham, " and isnull(bhtinhtien,0) = 1 and isnull(tinhtien,0)= 0 and isnull(a.dattbh,0) = 0 and isnull(slkedon,0) <> 0 and a.bschidinh ='" + cboNhanVien.SelectedValue + "'", false));
                            if (ReportData8.Tables[0].Rows.Count > 0)
                            {
                                //thuoc gay nghien
                                String mapl = "00002";
                                //bool contains = ReportData6.Tables[0].AsEnumerable().Any(row => mapl == row.Field<String>("mapl"));
                                DataTable tblgaynghien = ReportData8.Tables[0].AsEnumerable()
                                 .Where(r => r.Field<string>("mapl") == mapl)
                                 .CopyToDataTable();
                                if (tblgaynghien != null && tblgaynghien.Rows.Count > 0)
                                {
                                    GuiDonThuoc(tblgaynghien, "n");
                                }
                                //thuoc huong than
                                mapl = "00003";
                                DataTable tblhuongthan = ReportData8.Tables[0].AsEnumerable()
                                 .Where(r => r.Field<string>("mapl") == mapl)
                                 .CopyToDataTable();
                                if (tblhuongthan != null && tblhuongthan.Rows.Count > 0)
                                {
                                    GuiDonThuoc(tblhuongthan, "h");
                                }
                                //thuoc thuong
                                DataTable tblthuong = ReportData8.Tables[0].AsEnumerable()
                                 .Where(r => (r.Field<string>("mapl") != "00002") && (r.Field<string>("mapl") != "00003"))
                                 .CopyToDataTable();
                                if (tblthuong != null && tblthuong.Rows.Count > 0)
                                {
                                    GuiDonThuoc(tblhuongthan, "c");
                                }
                                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRKhamBenh_DonThuocBHA5.rpt";
                                ReportDocument rpt = new ReportDocument();
                                FormulaFieldDefinitions Myformulas;
                                rpt.Load(Server.MapPath(sPath));
                                Myformulas = rpt.DataDefinition.FormulaFields;
                                Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                                Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                                Myformulas["DiaChiBV"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV + "'";
                                //Myformulas["NgayBC"].Text = "'" & Strings.Format(htc.ShareVariables .NgayLV , "dd/MM/yyyy") & "'"
                                Myformulas["NgayBC"].Text = "'" + "Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                                Myformulas["TenBN"].Text = "'" + txtHoTen.Text + "'";
                                Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text.Replace("'", "''") + "'";
                                Myformulas["mabn"].Text = "'*" + _ThongtinBN.MaBN + "*'";
                                Myformulas["tungay"].Text = "'" + _ThongtinBN.GiaTriTN + "'";
                                Myformulas["noidk"].Text = "'" + _ThongtinBN.KhamBenh.mabhxh + "-" + _ThongtinBN.KhamBenh.tenbv + "'";
                                Myformulas["khoa"].Text = "'" + _KhamBenh_KB.tenkhoa + "'";
                                Myformulas["denngay"].Text = "'" + _ThongtinBN.GiaTriDN + "'";
                                Myformulas["BacSy"].Text = "'BS:" + cboNhanVien.Text + "'";
                                // Myformulas["ChuanDoan"].Text = "'" + ((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text) + "'";
                                Myformulas["ChuanDoan"].Text = "'" + ((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text + "," + (cboChanDoanKem.Text != "" ? cboChanDoanKem.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem.Text + "," + (cboChanDoanKem2.Text != "" ? cboChanDoanKem2.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem2.Text + "," + (cboChanDoanKem3.Text != "" ? cboChanDoanKem3.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem3.Text) + "'";
                                //  Myformulas["ChuanDoankem"].Text = "'" + _KhamBenh_KB.maicdKem + "-" + _KhamBenh_KB.tenbenhKem + "," + _KhamBenh_KB.maicdKem2 + "-" + _KhamBenh_KB.tenbenhKem2 + "," + _KhamBenh_KB.maicdKem3 + "-" + _KhamBenh_KB.tenbenhKem3 + "'";
                                //Myformulas["ChanDoankem"].Text = "'" + _KhamBenh_KB.maicdKem + "-" + _KhamBenh_KB.tenbenhKem + "," + _KhamBenh_KB.maicdKem2 + "-" + _KhamBenh_KB.tenbenhKem2 + "," + _KhamBenh_KB.maicdKem3 + "-" + _KhamBenh_KB.tenbenhKem3 + "'";
                                Myformulas["ChanDoankem"].Text = "'" + _KhamBenh_KB.maicdKem + "-" + _KhamBenh_KB.tenbenhKem + "'";
                                Myformulas["Tuoi"].Text = "'" + txtTuoi.Text + "'";
                                Myformulas["GioiTinh"].Text = "'" + (lblGioitinh.Items[0].Selected == true ? " Nam" : "Nữ") + "'";
                                Myformulas["SoTheBHYT"].Text = "'" + (txtSoThe.Text).ToUpper() + "'";
                                Myformulas["TenDT"].Text = "'" + txtDoiTuong.Text + "'";
                                Myformulas["BSDanDo"].Text = "'" + txtLoidan.Text.Replace("\r\n", "|||||").Replace("\r", "|||||") + "'";
                                rpt.SetDataSource(ReportData8);
                                PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer8.LoadReport(rpt, true, false);
                            }
                        }
                    }
                }
                ReportData5 = null;
                ReportData6 = null;
                ReportData4 = null;
                ReportData8 = null;
            }
            if (_KhamBenh_KeNgoaiList != null)
            {
                PrintKeNgoai();
            }
        }
        catch (Exception ex)
        {
            ShowMessage("Không in được báo cáo" + ex.Message);
            //throw;
        }
    }
    private void PrintPhieu(Boolean _load = true)
    {

        try
        {
            String sPath;
            ReportDocument rpt = new ReportDocument();
            String ngay = DateTime.Now.Day <= 9 ? "0" + DateTime.Now.Day.ToString() : DateTime.Now.Day.ToString();
            String thang = DateTime.Now.Month <= 9 ? "0" + DateTime.Now.Month.ToString() : DateTime.Now.Month.ToString();
            KhamBenh_C _KhamBenh_KB = _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(X => X.STT == _STT);
            UpdateKhamBenh();
            switch (cboHuongDT.SelectedValue)
            {
                case "00006":
                    {
                        // nhap vien
                        sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crPhieuKhamBenhVaoVienPK.rpt";
                        rpt.Load(Server.MapPath(sPath));
                        FormulaFieldDefinitions Myformulas = rpt.DataDefinition.FormulaFields;

                        Myformulas["hoten"].Text = "'" + txtHoTen.Text.Replace("'", "''") + "'";
                        // Myformulas["SoBHYT"].Text = "'" & UCase(TXTSothe.Text) & "'"
                        // Myformulas["NgayNhan"].Text = "'" & System.DateTime.Now.ToString("dd/MM/yyyy") & "'"
                        Myformulas["Tuoi"].Text = "'" + txtTuoi.Text + "'";
                        Myformulas["GT"].Text = "'" + (lblGioitinh.Items[0].Selected == true ? " Nam" : "Nữ") + "'";

                        Myformulas["ngaysinh"].Text = "'" + dtNgaySinh.Text + "'";

                        Myformulas["buongkb"].Text = "'" + _KhamBenh_KB.tenkhoa + "'";
                        Myformulas["NgheNghiep"].Text = "'" + _ThongtinBN.TenNN + "'";
                        Myformulas["Dantoc"].Text = "'" + DMDantoc.GetDMDantoc(_ThongtinBN.madantoc).TenDanToc + "'";
                        Myformulas["NgoaiKieu"].Text = "'" + DMQuocGia.GetDMQuocGia(_ThongtinBN.MaQG).TenQG + "'";
                        Myformulas["Diachi"].Text = "'" + (_ThongtinBN.DiaChi + "-" + _ThongtinBN.TenPXa).Replace("'", "''") + "'";
                        Myformulas["TenDoiTuong"].Text = "'" + txtDoiTuong.Text + "'";
                        Myformulas["daidien"].Text = "'" + _ThongtinBN.BaoTin + "'";
                        Myformulas["dienthoai"].Text = "'" + _ThongtinBN.DienThoai + "'";
                        Myformulas["mabn"].Text = "'" + _ThongtinBN.MaBN + "'";
                        Myformulas["Huyen"].Text = "'" + _ThongtinBN.TenQH.Replace("'", "''") + "'";
                        Myformulas["Thanhpho"].Text = "'" + _ThongtinBN.TenTinh + "'";
                        // Myformulas["DenNgay"].Text = "'" & IIf(dtPickerBHYTDN.Text = "", "", (dtPickerBHYTDN.Value.Day) & "  tháng  " & dtPickerBHYTDN.Value.Month & "  năm  " & dtPickerBHYTDN.Value.Year) & "'" 'dtPickerBHYTDN.Text & "'"
                        if (HTC.ShareVariables.pub_spC == "QN")
                            Myformulas["NoiLamViec"].Text = "'" + _ThongtinBN.NoiLamViec + "'";
                        if (!string.IsNullOrEmpty(dtBHYTDN.Text))
                        {
                            Myformulas["DenNgay"].Text = "'" + DateTime.Parse(dtBHYTDN.Text).Day.ToString() + "  tháng  " + DateTime.Parse(dtBHYTDN.Text).Month.ToString() + "  năm  " + DateTime.Parse(dtBHYTDN.Text).Year.ToString() + "'";
                            Myformulas["TuNgay"].Text = "'" + _ThongtinBN.KhamBenh.GiaTriTN.Substring(0, 2) + "  tháng  " + _ThongtinBN.KhamBenh.GiaTriTN.Substring(4, 2) + "  năm  " + _ThongtinBN.KhamBenh.GiaTriTN.Substring(6, 4) + "'";
                        }
                        Myformulas["SoThe"].Text = "'" + txtSoThe.Text + "'";
                        Myformulas["VaoVien"].Text = "'" + DateTime.Now.ToString("dd/MM/yyyy") + "'";
                        Myformulas["ChanDoanngt"].Text = "'" + txtBenhNGT.Text + "'";

                        //   Myformulas["ChuanDoan"].Text = "'" + ((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text + "," + (cboChanDoanKem.Text != "" ? cboChanDoanKem.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem.Text + "," + (cboChanDoanKem2.Text != "" ? cboChanDoanKem2.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem2.Text + "," + (cboChanDoanKem3.Text != "" ? cboChanDoanKem3.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem3.Text) + "'";
                        Myformulas["ChuanDoan"].Text = "'" + ((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text + "," + (cboChanDoanKem2.Text != "" ? cboChanDoanKem2.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem2.Text + "," + (cboChanDoanKem3.Text != "" ? cboChanDoanKem3.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem3.Text) + "'";
                        //+ "," + (cboChanDoanKem.Text != "" ? cboChanDoanKem.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem.Text
                        Myformulas["Ngaykham"].Text = "'" + DateTime.Now.Hour.ToString() + "  giờ  " + DateTime.Now.Minute.ToString() + "  phút  " + ", Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                        Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                        Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                        Myformulas["tiensubt"].Text = "'" + _ThongtinBN.TienSu + "'";
                        Myformulas["tiensugd"].Text = "'" + _ThongtinBN.TienSuGiaDinh + "'";
                        Myformulas["mach"].Text = "'" + txtMach.Text + "'";
                        Myformulas["bacsy"].Text = "'" + cboNhanVien.Text + "'";
                        Myformulas["nhietdo"].Text = "'" + txtNhietdo.Text + "'";
                        Myformulas["nhiptho"].Text = "'" + txtNhiptho.Text + "'";
                        Myformulas["cannang"].Text = "'" + txtCanNang.Text + "'";
                        Myformulas["chieucao"].Text = "'" + txtChieuCao.Text + "'";
                        Myformulas["huyetap"].Text = "'" + txtHuyetap.Text + "'";
                        Myformulas["khoadt"].Text = "'" + cboKhoaNV.Text + "'";
                        Myformulas["dieutri"].Text = "'" + _KhamBenh_Noi.LyDoKham + "'";
                        Myformulas["benhsu"].Text = "'" + _KhamBenh_Noi.BenhSu + "'";
                        Myformulas["toanthan"].Text = "'" + _KhamBenh_Noi.ToanThan + "'";
                        Myformulas["coquan"].Text = "'" + ((txtHohap.Text == "" ? "" : "Hô hấp :" + txtHohap.Text) + (txtTieuHoa.Text == "" ? "" : "- Tiêu hóa :" + txtTieuHoa.Text) + (txtCoxuongkhop.Text == "" ? "" : "-CXK :" + txtCoxuongkhop.Text) + (txtThan.Text == "" ? "" : "-Thận : " + txtThan.Text) + (txttuanhoan.Text == "" ? "" : "-Tuần hoàn :" + txttuanhoan.Text) + (txtrhm.Text == "" ? "" : "-RHM :" + txtrhm.Text) + (txttmh.Text == "" ? "" : "-TMH : " + txttmh.Text) + (txtmat.Text == "" ? "" : "-Mắt :" + txtmat.Text) + (txtthankinh.Text == "" ? "" : "- Thần kinh :" + txtthankinh.Text) + (txtnoitiet.Text == "" ? "" : "-Nội tiết :" + txtnoitiet.Text) + (txtkhac.Text == "" ? "" : "- Khác : " + txtkhac.Text)).Replace("\r", "") + "'";
                        Myformulas["xutri"].Text = "'" + txtXutri.Text + "'";
                        int i = 0;
                        //string thuocs = "";
                        //foreach (KhamBenh_ThuocSD _kbc in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
                        //{
                        //    thuocs = thuocs + _kbc.TenTM + " : " + _kbc.SLKeDon + " " + _kbc.tendvt + " - ";
                        //}


                        //foreach (KhamBenh_C _kbc in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                        //{
                        //    thuocs = thuocs + _kbc.TenTM;
                        //}

                        // Myformulas["thuocs"].Text = "'" + thuocs + "'";
                        PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer6.LoadReport(rpt, true, false);
                        if (HTC.ShareVariables.pub_spC == "PS")
                        {
                            ReportDocument rptp = new ReportDocument();
                            FormulaFieldDefinitions Myformulasp;
                            sPath = Request.ApplicationPath + "/UI/NoiTru/Reports/CRGiayVaoVien.rpt";
                            rptp.Load(Server.MapPath(sPath));
                            Myformulasp = rptp.DataDefinition.FormulaFields;
                            Myformulasp["mabn"].Text = "'" + _ThongtinBN.MaBN + "'";
                            Myformulasp["hoten"].Text = "'" + _ThongtinBN.Hoten.ToUpper() + "'";
                            Myformulasp["Tuoi"].Text = "'" + dtNgaySinh.Text.Substring(6, 4) + "'";
                            Myformulasp["GT"].Text = "'" + (_ThongtinBN.GT == false ? "Nữ" : "Nam") + "'";


                            Myformulasp["khoadt"].Text = "'" + cboKhoaNV.Text + "'";
                            Myformulasp["TenBV"].Text = "'" + (HTC.ShareVariables.pub_sTenBV) + "'";
                            Myformulasp["Tendvcq"].Text = "'" + (HTC.ShareVariables.pub_sTenDVChuQuan) + "'";
                            // Myformulasp["lienhe"].Text = "'" + txtBaoTin.Text + "-" + txtdienthoai.Text + "'";
                            Myformulasp["quan"].Text = "'" + _ThongtinBN.TenQH + "'";
                            Myformulasp["tinh"].Text = "'" + _ThongtinBN.TenTinh + "'";
                            Myformulasp["NgheNghiep"].Text = "'" + _ThongtinBN.TenNN + "'";
                            Myformulasp["NgayBC"].Text = "'" + "Ngày " + ngay + "  tháng  " + thang + "  năm  " + DateTime.Now.Year.ToString() + "'";
                            Myformulasp["diachi"].Text = "'" + txtDiaChi.Text + "'";
                            // Myformulas["noigioithieu"].Text = "'" + cboNoiGT.SelectedItem.Text + "'";
                            Myformulasp["bacsy"].Text = "'" + cboNhanVien.Text + "'";
                            Myformulasp["ngayvv"].Text = "' ...... giờ ....... phút ngày " + DateTime.Now.Day + " tháng " + DateTime.Now.Month + " năm " + DateTime.Now.Year + "'";
                            Myformulasp["chandoan"].Text = "'" + (((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text) + "-" + (cboChanDoanKem.Text != "" ? cboChanDoanKem.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem.Text) + "'";

                            PrintExport(rptp); rptp.Dispose(); rptp = null;//HTCReportViewer2.LoadReport(rptp, true, false);
                        }
                        if (HTC.ShareVariables.pub_spC == "QN" && HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN Y DƯỢC CỔ TRUYỀN")
                        {
                            // nhap vien
                            ReportDocument rptvv = new ReportDocument();
                            sPath = Request.ApplicationPath + "/UI/NoiTru/Reports/crHoSoBenhAnYHCTT1.rpt";
                            rptvv.Load(Server.MapPath(sPath));
                            FormulaFieldDefinitions Myformulasvv = rptvv.DataDefinition.FormulaFields;

                            Myformulasvv["hoten"].Text = "'" + txtHoTen.Text.Replace("'", "''") + "'";

                            Myformulasvv["Tuoi"].Text = "'" + txtTuoi.Text + "'";
                            Myformulasvv["GT"].Text = "'" + (lblGioitinh.Items[0].Selected == true ? " Nam" : "Nữ") + "'";

                            Myformulasvv["ngaysinh"].Text = "'" + dtNgaySinh.Text + "'";

                            Myformulasvv["buongkb"].Text = "'" + _KhamBenh_KB.tenkhoa + "'";
                            Myformulasvv["NgheNghiep"].Text = "'" + _ThongtinBN.TenNN + "'";
                            Myformulasvv["Dantoc"].Text = "'" + DMDantoc.GetDMDantoc(_ThongtinBN.madantoc).TenDanToc + "'";
                            Myformulasvv["NgoaiKieu"].Text = "'" + DMQuocGia.GetDMQuocGia(_ThongtinBN.MaQG).TenQG + "'";
                            Myformulasvv["Diachi"].Text = "'" + (_ThongtinBN.DiaChi + "-" + _ThongtinBN.TenPXa).Replace("'", "''") + "'";
                            Myformulasvv["TenDoiTuong"].Text = "'" + txtDoiTuong.Text + "'";
                            Myformulasvv["daidien"].Text = "'" + _ThongtinBN.BaoTin + "'";
                            Myformulasvv["dienthoai"].Text = "'" + _ThongtinBN.DienThoai + "'";
                            Myformulasvv["Huyen"].Text = "'" + _ThongtinBN.TenQH.Replace("'", "''") + "'";
                            Myformulasvv["Thanhpho"].Text = "'" + _ThongtinBN.TenTinh + "'";
                            Myformulasvv["bacsy"].Text = "'" + cboNhanVien.Text + "'";
                            Myformulasvv["NoiLamViec"].Text = "'" + _ThongtinBN.NoiLamViec + "'";
                            if (!string.IsNullOrEmpty(dtBHYTDN.Text))
                            {
                                Myformulasvv["DenNgay"].Text = "'" + DateTime.Parse(dtBHYTDN.Text).Day.ToString() + "  tháng  " + DateTime.Parse(dtBHYTDN.Text).Month.ToString() + "  năm  " + DateTime.Parse(dtBHYTDN.Text).Year.ToString() + "'";
                            }
                            Myformulasvv["SoThe"].Text = "'" + txtSoThe.Text + "'";
                            Myformulasvv["VaoVien"].Text = "'" + DateTime.Now.ToString("dd/MM/yyyy HH:mm") + "'";
                            Myformulasvv["ChanDoanngt"].Text = "'" + txtBenhNGT.Text + "'";
                            Myformulasvv["MaBN"].Text = "'" + _ThongtinBN.MaBN + "'";
                            //   Myformulasvv["ChuanDoan"].Text = "'" + ((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text + "," + (cboChanDoanKem.Text != "" ? cboChanDoanKem.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem.Text + "," + (cboChanDoanKem2.Text != "" ? cboChanDoanKem2.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem2.Text + "," + (cboChanDoanKem3.Text != "" ? cboChanDoanKem3.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem3.Text) + "'";
                            Myformulasvv["ChuanDoan"].Text = "'" + ((cboChanDoan.Text != "" ? cboChanDoan.Text.Substring(0, 3) : "") + "-" + txtChanDoan.Text + "," + (cboChanDoanKem2.Text != "" ? cboChanDoanKem2.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem2.Text + "," + (cboChanDoanKem3.Text != "" ? cboChanDoanKem3.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem3.Text) + "'";
                            Myformulasvv["ChuanDoanKem"].Text = "'" + (cboChanDoanKem.Text != "" ? cboChanDoanKem.Text.Substring(0, 3) : "") + "-" + txtChanDoanKem.Text + "'";

                            Myformulasvv["Ngaykham"].Text = "'" + DateTime.Now.Hour.ToString() + "  giờ  " + DateTime.Now.Minute.ToString() + "  phút  " + ", Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                            Myformulasvv["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                            Myformulasvv["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                            //Myformulasvv["tiensubt"].Text = "'" + _ThongtinBN.TienSu + "'";
                            //Myformulasvv["tiensugd"].Text = "'" + _ThongtinBN.TienSuGiaDinh + "'";
                            //Myformulasvv["mach"].Text = "'" + txtMach.Text + "'";
                            //Myformulasvv["nhietdo"].Text = "'" + txtNhietdo.Text + "'";
                            //Myformulasvv["nhiptho"].Text = "'" + txtNhiptho.Text + "'";
                            //Myformulasvv["cannang"].Text = "'" + txtCanNang.Text + "'";
                            //Myformulasvv["chieucao"].Text = "'" + txtChieuCao.Text + "'";
                            //Myformulasvv["huyetap"].Text = "'" + txtHuyetap.Text + "'";
                            Myformulasvv["khoadt"].Text = "'" + cboKhoaNV.Text + "'";
                            //Myformulasvv["dieutri"].Text = "'" + _KhamBenh_Noi.DieuTri + "'";
                            //Myformulasvv["benhsu"].Text = "'" + _KhamBenh_Noi.BenhSu + "'";
                            //Myformulasvv["toanthan"].Text = "'" + _KhamBenh_Noi.ToanThan + "'";
                            //Myformulasvv["thuocs"].Text = "'" + thuocs + "'";
                            PrintExport(rptvv); rptvv.Dispose(); rptvv = null;
                        }
                        break;
                    }
                case "00007":
                case "00017":
                    {
                        // chuyen vien
                        sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crGiayChuyenTuyen_Rpt.rpt";
                        rpt.Load(Server.MapPath(sPath));
                        FormulaFieldDefinitions Myformulas = rpt.DataDefinition.FormulaFields;

                        Myformulas["hoten"].Text = "'" + txtHoTen.Text.Replace("'", "''") + "'";
                        //// Myformulas["SoBHYT"].Text = "'" & UCase(TXTSothe.Text) & "'"
                        //// Myformulas["NgayNhan"].Text = "'" & System.DateTime.Now.ToString("dd/MM/yyyy") & "'"
                        Myformulas["GT"].Text = "'" + (lblGioitinh.Items[0].Selected == true ? " Nam" : "Nữ") + "'";
                        Myformulas["Tuoi"].Text = "'" + dtNgaySinh.Text.Substring(6, 4) + "'";
                        //Myformulas["ngaysinh"].Text = "'" + dtNgaySinh.Text + "'";

                        Myformulas["NgheNghiep"].Text = "'" + _ThongtinBN.TenNN + "'";
                        Myformulas["Dantoc"].Text = "'" + DMDantoc.GetDMDantoc(_ThongtinBN.madantoc).TenDanToc + "'";
                        Myformulas["QuocTich"].Text = "'" + DMQuocGia.GetDMQuocGia(_ThongtinBN.MaQG).TenQG + "'";
                        Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text.Replace("'", "''") + "'";
                        Myformulas["TenDoiTuong"].Text = "'" + txtDoiTuong.Text + "'";
                        Myformulas["noichuyen"].Text = "'" + cboBVChuyen.Text + "'";
                        if (HTC.ShareVariables.pub_sTenBVBHXH != "")
                            Myformulas["noichuyen1"].Text = "'" + HTC.ShareVariables.pub_sTenBV.Substring(0, 1) + HTC.ShareVariables.pub_sTenBV.Substring(1).ToLower() + "'";
                        else
                            Myformulas["noichuyen1"].Text = "'" + HTC.ShareVariables.pub_sTenBVBHXH + "'";

                        //Myformulas["Huyen"].Text = "'" + DMQuanHuyen.GetDMQuanHuyen(_ThongtinBN.MaHuyen).TenQH + "'";
                        //Myformulas["Thanhpho"].Text = "'" + DMTinh.GetDMTinh(_ThongtinBN.MaTinh).TenTinh + "'";
                        //// Myformulas["DenNgay"].Text = "'" & IIf(dtPickerBHYTDN.Text = "", "", (dtPickerBHYTDN.Value.Day) & "  tháng  " & dtPickerBHYTDN.Value.Month & "  năm  " & dtPickerBHYTDN.Value.Year) & "'" 'dtPickerBHYTDN.Text & "'"
                        //if (!string.IsNullOrEmpty(dtBHYTDN.Text))
                        //{
                        //    Myformulas["DenNgay"].Text = "'" + " đến " + _ThongtinBN.GiaTriDN + "'";
                        //}
                        if (cboHuongDT.SelectedValue == "00017")
                        {
                            Myformulas["giadinh"].Text = "1";
                        }
                        Myformulas["TuNgay"].Text = "'" + _ThongtinBN.KhamBenh.GiaTriTN + "'";
                        Myformulas["DenNgay"].Text = "'" + _ThongtinBN.KhamBenh.GiatriDN + "'";
                        Myformulas["SoThe"].Text = "'" + txtSoThe.Text + "'";
                        Myformulas["VaoVien"].Text = "'" + DateTime.Now.ToString("dd/MM/yyyy") + "'";
                        //Myformulas["ChanDoanngt"].Text = "'" & txtMaICDNGT.Text + "-" + txtTenBenhNGT.Text & "'"
                        Myformulas["ChanDoan"].Text = "'" + cboChanDoan.Text + "-" + txtChanDoan.Text + "'";
                        Myformulas["ChanDoanVV"].Text = "'" + cboChanDoan.Text + "-" + txtChanDoan.Text + "'";
                        Myformulas["bacsy"].Text = "'" + cboNhanVien.Text + "'";
                        //   Myformulas["DenNgay"].Text = "'" + DateTime.Now.ToString("dd/MM/yyyy") + "'";
                        Myformulas["ChuyenTuyen"].Text = "'-Chuyển tuyến hồi :" + DateTime.Now.Hour.ToString() + "  giờ  " + DateTime.Now.Minute.ToString() + "  phút  " + ", Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                        Myformulas["phuongphap"].Text = "'" + txtXutri.Text + "'";
                        Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                        Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                        //int i = 0;
                        //string thuocs = "";
                        //string xns = "";
                        string kqcls = "";
                        Myformulas["dieutri"].Text = "'" + txtbenhly.Text + "'";
                        Myformulas["DAUHIEU"].Text = "'" + txtlydo.Text + "'";
                        //foreach (KhamBenh_ThuocSD _kbc in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
                        //{
                        //    thuocs = thuocs + _kbc.TenTM + " : " + _kbc.SLKeDon + " " + _kbc.tendvt + " - ";
                        //}


                        //foreach (KhamBenh_C _kbc in _ThongtinBN.KhamBenh.KhamBenh_C_List )
                        //{
                        //    kqcls = kqcls + _ThongtinBN.KhamBenh.KhamBenh_XN_GetsList;
                        //}
                        foreach (KhamBenh_C _kbc in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                        {
                            if (_kbc.KQ != "" && (_kbc.malh == "00028" || _kbc.malh == "00014"))
                                kqcls = _kbc.KQ;
                        }
                        Myformulas["kqcls"].Text = "'" + kqcls + "'";
                        //  Myformulas["thuocs"].Text = "'" + thuocs + "'";
                        Myformulas["phuongphap"].Text = "'" + txtXutri.Text + "'";
                        Myformulas["huongdt"].Text = "'" + txtLoidan.Text + "'";
                        Myformulas["ToanThan"].Text = "'" + txtToanthan.Text + "'";
                        PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer6.LoadReport(rpt, true, false);
                        break;
                    }
                case "00002":
                    {
                        // hen

                        sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRGiayHenPK.rpt";
                        rpt.Load(Server.MapPath(sPath));
                        FormulaFieldDefinitions Myformulas = rpt.DataDefinition.FormulaFields;

                        Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                        Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                        Myformulas["hoten"].Text = "'" + txtHoTen.Text.Replace("'", "''") + "'";
                        Myformulas["Tuoi"].Text = "'" + _ThongtinBN.NgaySinh.Substring(6, 4) + "'";
                        Myformulas["NgaySinh"].Text = "'" + _ThongtinBN.NgaySinh + "'";
                        Myformulas["SoThe"].Text = "'" + txtSoThe.Text + "'";
                        Myformulas["MABN"].Text = "'" + _ThongtinBN.MaBN + "'";

                        Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text.Replace("'", "''") + "'";
                        Myformulas["GT"].Text = "'" + (lblGioitinh.Items[0].Selected == true ? " Nam" : "Nữ") + "'";
                        Myformulas["ChanDoan"].Text = "'" + txtChanDoan.Text + "'";
                        Myformulas["mabenh"].Text = "'" + cboChanDoan.Text + "'";
                        Myformulas["ChanDoanngt"].Text = "'" + txtBenhNGT.Text + "'";
                        // Myformulas["ChanDoanKem"].Text = "'" + txtChanDoanKem.Text + "'";
                        Myformulas["SoThe"].Text = "'" + txtSoThe.Text + "'";
                        Myformulas["mabenhngt"].Text = "'" + _ThongtinBN.KhamBenh.maicdngt + "'";
                        Myformulas["noidk"].Text = "'" + _ThongtinBN.KhamBenh.mabhxh + "-" + _ThongtinBN.KhamBenh.tenbv + "'";
                        Myformulas["noigt"].Text = "'" + _ThongtinBN.KhamBenh.MABHXHGT + "-" + _ThongtinBN.KhamBenh.TenBVGT + "'";
                        //Myformulas["ChanDoanKem"].Text = "'" + txtChanDoanKem.Text + "'";
                        Myformulas["ChanDoanKem"].Text = "'" + txtChanDoanKem.Text + "-" + txtChanDoanKem2.Text + "-" + txtChanDoanKem3.Text + "'";

                        Myformulas["HanSDTu"].Text = "'" + _ThongtinBN.KhamBenh.GiaTriTN + "'";
                        Myformulas["HanSDDen"].Text = "'" + _ThongtinBN.KhamBenh.GiatriDN + "'";
                        if (!string.IsNullOrEmpty(_ThongtinBN.KhamBenh.NgayGT))
                        {
                            //  Myformulas["vaovien"].Text = "' " + DateTime.Parse( _ThongtinBN.KhamBenh.NgayGT).Day + " tháng " + DateTime.Parse( _ThongtinBN.KhamBenh.NgayGT).Month + " năm " + DateTime.Parse( _ThongtinBN.KhamBenh.NgayGT).Year + "'";
                            Myformulas["vaovien"].Text = "'" + _ThongtinBN.KhamBenh.NgayGT + "'";
                        }
                        else
                        {
                            //   Myformulas["vaovien"].Text = "' " + "    tháng " + "   năm " + "'";
                            Myformulas["vaovien"].Text = "'" + _ThongtinBN.KhamBenh.NgayDK + "'";

                        }
                        if (_LoaiKQCN == 0)
                            Myformulas["RaVien"].Text = "'" + DateTime.Now.ToString("dd/MM/yyyy") + "'";
                        else
                            Myformulas["RaVien"].Text = "'" + _KhamBenh_KB.NgayKT + "'";
                        if (dtNgayHen.Text != "")
                            Myformulas["NgayHen"].Text = "'" + DateTime.Parse(dtNgayHen.Text).Day + " tháng " + DateTime.Parse(dtNgayHen.Text).Month + " năm " + DateTime.Parse(dtNgayHen.Text).Year + "'";
                        else
                            Myformulas["NgayHen"].Text = "'ngày  " + "    tháng " + "   năm " + "'";
                        //   Myformulas["RaVien"].Text = "'" + DateTime.Parse(dtNgayHen.Text).Day + " tháng " + DateTime.Parse(dtNgayHen.Text).Month + " năm " + DateTime.Parse(dtNgayHen.Text).Year + "'";

                        Myformulas["NgayBC"].Text = "'Ngày " + DateTime.Now.Day.ToString() + " tháng " + DateTime.Now.Month + " năm " + DateTime.Now.Year + "'";


                        PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer7.LoadReport(rpt, true, false);
                        break;
                    }
            }
        }
        catch (Exception ex)
        {
            ShowMessage("Không in được báo cáo" + ex.Message);

            //throw;
        }
    }
    private void PrintKeNgoai(Boolean _load = true)
    {
        try
        {
            ReportDocument rpt = new ReportDocument();
            DataSet ReportData = new DataSet();
            String sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRKhamBenh_DonThuoc_TPCN.rpt";
            rpt.Load(Server.MapPath(sPath));
            FormulaFieldDefinitions Myformulas = rpt.DataDefinition.FormulaFields;

            Myformulas = rpt.DataDefinition.FormulaFields;
            Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
            Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
            Myformulas["DiaChiBV"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV + "'";
            if (HTC.ShareVariables.pub_spC == "YH")
                Myformulas["NgayBC"].Text = "'" + "Hà nội, ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
            else
                Myformulas["NgayBC"].Text = "'" + "Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";

            Myformulas["TenBN"].Text = "'" + txtHoTen.Text + "'";
            Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text.Replace("'", "''") + "'";
            Myformulas["mabn"].Text = "'" + _ThongtinBN.MaBN + "'";


            Myformulas["ChuanDoan"].Text = "'" + txtChanDoan.Text + "'";
            Myformulas["BacSy"].Text = "'BS: " + cboNhanVien.Text + "'";
            Myformulas["gioitinh"].Text = "'" + (_ThongtinBN.GT == true ? "Nam" : "Nữ") + "'";

            Myformulas["Tuoi"].Text = "'" + _ThongtinBN.Tuoi + "'";
            if (_load == true)
                ReportData = (HTC.Business.DataProvider.Instance().crKhamBenh_KeNgoai(_ThongtinBN.KhamBenh.MaSoKham, " and a.bschidinh ='" + cboNhanVien.SelectedValue + "'", false));
            rpt.SetDataSource(ReportData);

            PrintExport(rpt); rpt.Dispose(); rpt = null; //HTCReportViewer1.LoadReport(rpt,true,false);


        }
        catch (Exception ex)
        {
            ShowMessage("Không in được đơn thuốc");
        }
    }
    private void PrintVPThanhToanBH(Boolean _load = true, string dk = "")
    {
        try
        {
            String sPath;
            String ngay = DateTime.Now.Day <= 9 ? "0" + DateTime.Now.Day.ToString() : DateTime.Now.Day.ToString();
            String thang = DateTime.Now.Month <= 9 ? "0" + DateTime.Now.Month.ToString() : DateTime.Now.Month.ToString();
            ReportDocument rpt = new ReportDocument();
            FormulaFieldDefinitions Myformulas;
            DataSet ReportData3 = new DataSet();
            DataSet ReportData4 = new DataSet();
            if (dk == "ToDieuTri")
            {
                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crBCPhatThuoc_HPBN.rpt";
                rpt.Load(Server.MapPath(sPath));
            }
            else
            {
                if ((_ThongtinBN.MaDT.Substring(0, 1) != "0"))
                {
                    sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRInphoithanhtoan_BHNTMA4.rpt";
                    rpt.Load(Server.MapPath(sPath));
                    Myformulas = rpt.DataDefinition.FormulaFields;
                    Myformulas["dungtuyen"].Text = "'" + (_ThongtinBN.MaDT.Substring(4, 1) == "8" ? "" : "X") + "'";
                    Myformulas["traituyen"].Text = "'" + (_ThongtinBN.MaDT.Substring(4, 1) != "8" ? "" : "X") + "'";
                    Myformulas["MaBVThe"].Text = "'" + _ThongtinBN.KhamBenh.mabhxh + "'";
                    Myformulas["benhvienden"].Text = "'" + _ThongtinBN.KhamBenh.MABHXHGT + "-" + _ThongtinBN.KhamBenh.TenBVGT + "'";

                    //Myformulas["daidien"].Text = "'" + nguoidaidien + "'";
                    if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                    {
                        Myformulas["maChuanDoan"].Text = "'" + _ThongtinBN.KhamBenh.KhamBenh_C_List[0].maicd + "'";
                    }
                    Myformulas["Tuoi"].Text = "'" + _ThongtinBN.NgaySinh.Substring(6, 4) + "'";
                    if (!string.IsNullOrEmpty(_ThongtinBN.KhamBenh.NgayQT) && !string.IsNullOrEmpty(_ThongtinBN.KhamBenh.NgayDK))
                    {
                        Myformulas["ngaydt"].Text = (DateTime.Parse(_ThongtinBN.KhamBenh.NgayDK) - DateTime.Parse(_ThongtinBN.KhamBenh.NgayQT)).Days.ToString();
                    }
                    if (!string.IsNullOrEmpty(_ThongtinBN.KhamBenh.NgayDK))
                        Myformulas["vaovien"].Text = "'" + DateTime.Parse(_ThongtinBN.KhamBenh.NgayDK).Day.ToString() + "/ " + DateTime.Parse(_ThongtinBN.KhamBenh.NgayDK).Month.ToString() + "/ " + DateTime.Parse(_ThongtinBN.KhamBenh.NgayDK).Year.ToString() + "'";
                    if (!string.IsNullOrEmpty(_ThongtinBN.KhamBenh.NgayQT))
                        Myformulas["ravien"].Text = "'" + DateTime.Parse(_ThongtinBN.KhamBenh.NgayQT).Day.ToString() + "/ " + DateTime.Parse(_ThongtinBN.KhamBenh.NgayQT).Month.ToString() + "/ " + DateTime.Parse(_ThongtinBN.KhamBenh.NgayQT).Year.ToString() + "'";
                    else
                        Myformulas["ravien"].Text = "'" + DateTime.Now.Day.ToString() + "/ " + DateTime.Now.Month.ToString() + "/ " + DateTime.Now.Year.ToString() + "'";

                    Myformulas["TenBV"].Text = "'" + (HTC.ShareVariables.pub_sTenBV) + "'";
                    Myformulas["SophieuTTRV"].Text = "'" + _ThongtinBN.KhamBenh.sophieuttrv + "'";
                    Myformulas["sobenhan"].Text = "'" + _ThongtinBN.MaBN + "'";
                    Myformulas["hoten"].Text = "'" + (txtHoTen.Text).ToUpper() + "'";
                    Myformulas["bh"].Text = "'" + txtSoThe.Text + "'";
                    Myformulas["NguongCPBNtra"].Text = "'" + _ThongtinBN.KhamBenh.sotienbhtra + "'";
                    Myformulas["PhantramBHTra"].Text = "'" + _ThongtinBN.KhamBenh.bhtra + "'";
                    Myformulas["NoiDKBD"].Text = "'" + txtTenBVBD.Text.Replace("'", "''") + "'";
                    //Myformulas["nvketoan"].Text = "'" + (Pub_sTenNguoiSD).ToUpper() + "'";
                    Myformulas["NgayQT"].Text = "'" + DateTime.Now.ToString("dd/MM/yyyy") + "'";
                    Myformulas["Tennv"].Text = "'" + (Pub_sTenNguoiSD).ToUpper() + "'";

                    Myformulas["Denngay"].Text = "'" + _ThongtinBN.KhamBenh.GiatriDN + "'";
                    Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text.Replace("'", "''") + "'";
                    Myformulas["NGAYDK"].Text = "'" + _ThongtinBN.KhamBenh.NgayDK + "'";
                    if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                    {
                        Myformulas["ChanDoan"].Text = "'" + _ThongtinBN.KhamBenh.KhamBenh_C_List[0].maicd + "-" + _ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbenh + "'";
                        Myformulas["khoa"].Text = "'" + (_ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenkhoa).ToUpper() + "'";
                    }
                    Myformulas["GT"].Text = "'" + (lblGioitinh.Items[0].Selected == true ? "Nam" : "Nữ") + "'";
                    Myformulas["Ngayin"].Text = "'Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";

                    //Myformulas["nvketoan"].Text = "'" + (Pub_sTenNguoiSD).ToUpper() + "'";
                }

            }
            if (!string.IsNullOrEmpty(dk))
            {

                ReportData3 = HTC.Business.DataProvider.Instance().RptGetInphoihoadonthanhtoan_BHNT(false, _ThongtinBN.KhamBenh.MaSoKham, 0, _LoaiPhieu, "");


            }
            else
            {
                ReportData3 = HTC.Business.DataProvider.Instance().RptGetInphoihoadonthanhtoan_BHNT(false, _ThongtinBN.KhamBenh.MaSoKham, 0, _LoaiPhieu, "");

            }
            if (dk == "ToDieuTri")
            {
                ReportData3.DataSetName = "CRBKSDThuocVTTHchoBN_RPT";
                if (ReportData3.Tables.Count > 0)
                {
                    ReportData3.Tables[0].TableName = "CRBKSDThuocVTTHchoBN_RPT";
                }
            }
            rpt.SetDataSource(ReportData3);
            PrintExport(rpt); rpt.Dispose(); rpt = null;//  PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer3.LoadReport(rpt, true, false);
            ReportData3 = null;
            ReportData4 = null;
        }
        catch (Exception ex)
        {
            ShowMessage("Không in được báo cáo" + ex.Message);

            //throw;
        }
    }

    private bool ValidateForm(GridEditableItem editedItem)
    {
        return true;
    }

    protected void odsThuoc_VT_HC_M_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {
        SetObject();
        if (CurrentTabIndex == 1 && HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ ")
            e.InputParameters["maKhoa"] = _MaKhoa;
        else
            e.InputParameters["maKhoa"] = "011";
        e.InputParameters["maDT"] = _MaDT;

    }
    protected void odsDichVu_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {
        SetObject();
        e.InputParameters["DK"] = _PubsMaDV;
        if (CurrentTabIndex == 5)
            e.InputParameters["maDT"] = "00006";
        else
            e.InputParameters["maDT"] = _MaDT;
    }

    protected void cboGoi_SelectedIndexChanged(object sender, RadComboBoxSelectedIndexChangedEventArgs e)
    {
        if (cboGoiDY.SelectedValue != "" && cboGoiDY.SelectedValue != null && CurrentTabIndex == 3)
            LoadDetails_KhamBenh_ThuocThang(true, true);
        else if (cboGoiTY.SelectedValue != "" && cboGoiTY.SelectedValue != null && CurrentTabIndex == 2)
            LoadDetails(true, CurrentTabIndex, true);


    }
    protected void cboBenhVien_ItemDataBound(object sender, RadComboBoxItemEventArgs e)
    {
        DMBenhVien dataItem = e.Item.DataItem as DMBenhVien;

        if (dataItem == null)
            e.Item.Attributes["TenBV"] = "";
        else
            e.Item.Attributes["TenBV"] = dataItem.TenBV.ToString();
    }
    protected void ObjectDanhMucBT_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {
        if (CurrentTabIndex == 2)

            e.InputParameters["_loai"] = byte.Parse("1");
        else
            e.InputParameters["_loai"] = byte.Parse("0");

        e.InputParameters["mabs"] = cboNhanVien.SelectedValue == null ? "000000" : cboNhanVien.SelectedValue;


    }
    protected void odsNhapHoTroDY_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {
        if (_MaBN != "")

            e.InputParameters["masokham"] = _MaBN;
        else
            e.InputParameters["masokham"] = "0000000000";

    }
    protected void odsNhapHoTro_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {

        e.InputParameters["loai"] = _LoaiPhieu;
        if (_MaBN != "")
            e.InputParameters["mabn"] = _MaBN;
        else
            e.InputParameters["mabn"] = "0000000000";
        if (_MaBN == "")
            e.InputParameters["dk"] = " and 1>2";
        else
            e.InputParameters["dk"] = " and isnull(TongThuocTY,0) <>0";


    }
    protected void cboBenh_ItemDataBound(object sender, RadComboBoxItemEventArgs e)
    {
        DMBenhTat dataItem = e.Item.DataItem as DMBenhTat;
        if (dataItem == null)
            e.Item.Attributes["MaICD"] = "";
        else
            e.Item.Attributes["MaICD"] = dataItem.MaICD.ToString();

        if (dataItem == null)
            e.Item.Attributes["TenBenh"] = "";
        else
            e.Item.Attributes["TenBenh"] = dataItem.TenBenh.ToString();
    }
    protected void grdDichVu_ItemDataBound(object sender, GridItemEventArgs e)
    {
        if (e.Item.IsInEditMode && e.Item is GridEditableItem)
        {
            //  GridBoundColumn colre = e.Item.OwnerTableView.GetColumn("SoLuongYC") as GridBoundColumn;
            //  colre.ReadOnly = true;
            GridEditableItem item = e.Item as GridEditableItem;
            InitTabIndexForRadGrid(((RadGrid)sender), item, 4);

            //if (!(e.Item is IGridInsertItem))
            //{

            //    if (sender.Equals(grdThuoc) || sender.Equals(grdThuocDY))
            //    {
            //        RadComboBox combo = (RadComboBox)item["LieuDung"].FindControl("cboLieuDung");

            //        combo.Text = item["LieuDung"].Text;
            //        combo.SelectedValue = item["LieuDung"].Text;
            //        RadComboBox comboc = (RadComboBox)item["CachDung"].FindControl("cboCachDung");

            //        comboc.Text = item["CachDung"].Text;
            //        comboc.SelectedValue = item["CachDung"].Text;
            //    }
            //}

            //if (!(e.Item is IGridInsertItem))
            //{

            //    if (sender.Equals(grdThuoc) || sender.Equals(grdThuocDY))
            //    {
            //        RadComboBox combo = (RadComboBox)item["MaThuoc"].FindControl("cboThuoc");
            //        RadComboBoxItem selectedItem = new RadComboBoxItem();

            //        selectedItem.Text = item.GetDataKeyValue("TenTM").ToString();
            //        selectedItem.Value = item.GetDataKeyValue("MaThuoc").ToString();
            //        combo.Items.Add(selectedItem);
            //        selectedItem.Selected = true;
            //        selectedItem.DataBind();
            //        combo.DataBind();
            //    }


            //    else if (sender.Equals(grdXNTT))
            //    {

            //        RadComboBox comboMa = (RadComboBox)item["MaDVXN"].FindControl("cboMaDichVu");
            //        RadComboBoxItem selectedItemMa = new RadComboBoxItem();

            //        selectedItemMa.Text = item.GetDataKeyValue("MaDV").ToString();
            //        selectedItemMa.Value = item.GetDataKeyValue("MaDV").ToString();
            //        comboMa.Items.Add(selectedItemMa);
            //        selectedItemMa.Selected = true;
            //        selectedItemMa.DataBind();
            //        comboMa.DataBind();

            //        RadComboBox combo = (RadComboBox)item["MaDV"].FindControl("cboDichVu");
            //        RadComboBoxItem selectedItem = new RadComboBoxItem();

            //        selectedItem.Text = item.GetDataKeyValue("TenTM").ToString();
            //        selectedItem.Value = item.GetDataKeyValue("MaDV").ToString();
            //        combo.Items.Add(selectedItem);
            //        selectedItem.Selected = true;
            //        selectedItem.DataBind();
            //        combo.DataBind();
            //    }

            //}

            if (item.ItemIndex != -1)
            {

                if (sender.Equals(grdThuoc) || sender.Equals(grdThuocDY))

                    item["MaThuoc"].Enabled = false;
                else if (sender.Equals(grdXNTT))
                {
                    item["MaDV"].Enabled = false;
                    item["MaDVXN"].Enabled = false;
                }

                RadNumericTextBox dataField = (RadNumericTextBox)item.FindControl("tbSoLuong");

                dataField.Focus();

            }
            else
            {

                if (sender.Equals(grdThuoc))
                {
                    if (grdThuoc.EditItems.Count > 0)
                        e.Item.FireCommandEvent(RadGrid.CancelCommandName, string.Empty);
                    else
                    {

                        item["MaThuoc"].Enabled = true;

                        ((RadComboBox)item["MaThuoc"].FindControl("cboThuoc")).Focus();

                    }
                }
                else if (sender.Equals(grdThuocDY))
                {
                    if (grdThuocDY.EditItems.Count > 0)
                        e.Item.FireCommandEvent(RadGrid.CancelCommandName, string.Empty);
                    else
                    {

                        item["MaThuoc"].Enabled = true;

                        ((RadComboBox)item["MaThuoc"].FindControl("cboThuoc")).Focus();
                    }
                }
                else if (sender.Equals(grdXNTT))
                {
                    if (grdXNTT.EditItems.Count > 0)
                        e.Item.FireCommandEvent(RadGrid.CancelCommandName, string.Empty);
                    else
                    {

                        item["MaDVXN"].Enabled = true;

                        ((RadComboBox)item["MaDVXN"].FindControl("cboMaDichVu")).Focus();

                    }
                }


            }
        }
    }
    protected void grdKetQua_ItemCommand(object sender, GridCommandEventArgs e)
    {
        if (e.CommandName == "Edit")
        {

            //GridEditableItem _editedItem = e.Item as GridEditableItem;

            //if (_editedItem != null)
            //{
            //    string _STT = _editedItem.GetDataKeyValue("STT").ToString();
            //    OpenWindow("frmXetNghiem.aspx?LoaiPhieu=4&LoaiKQCN=1&capcuu=false&duyet=1&loaikq=5&maba=" + _MaSoKham + "&ngayDK=" + _NgayDK + "&MaBN=" + _MaBN + "&STT=" + _STT.ToString());

            //}
            //e.Canceled = true;
            string mss = "";
            try
            {
                GridEditableItem _editedItem = e.Item as GridEditableItem;
                if (_editedItem != null)
                {
                    //string _STT = _editedItem.GetDataKeyValue("STT").ToString();
                    //string MaSoKham = (_editedItem.GetDataKeyValue("MaSoKham")).ToString();
                    string _STT = _editedItem.GetDataKeyValue("STT").ToString();
                    mss += "STT: " + _STT;
                    //WriteLog(mss);
                    string MaSoKham = (_editedItem.GetDataKeyValue("MaSoKham")).ToString();
                    mss += "MaSoKham: " + MaSoKham;

                    string madv = _editedItem.GetDataKeyValue("MADV").ToString();
                    mss += "madv: " + madv;
                    //WriteLog(mss);
                    if (madv.Substring(0, 2) == "CT" || madv.Substring(0, 2) == "NS" || madv.Substring(0, 2) == "SA" || madv.Substring(0, 2) == "XQ" || madv.Substring(0, 2) == "MR" || madv.Substring(0, 4) == "TNXQ")
                    {
                        //get port de xem anh PACS loai="View"
                        string port = GetPort2("View");
                        mss += "port: " + port;
                        //so phieu yeu cau trong bang kham benh = masokham-stt 
                        //string token = GetToken(_STT.ToString(), _MaSoKham); 
                        //string token = MaSoKham + _STT.ToString();
                        string token = GetIDPACS(_MaSoKham + _STT.ToString());
                        mss += "token: " + token;
                        //Response.Write("<script>window.open('" + port + "portal?urltoken=" + token + "','_blank');</script>"); 
                        //if (token.Length > 0)
                        //Response.Write("<script>window.open('" + port + "/accessionnumber=" + token + "&winpass=true','_blank');</script>");

                        Response.Write("<script>window.open('" + port + "/viewImgsH?ris_exam_id=" + token + "&service_id=" + token + "','_blank');</script>");
                    }
                    else
                    {
                        OpenWindow("frmXetNghiem.aspx?LoaiPhieu=4&LoaiKQCN=1&capcuu=false&duyet=1&loaikq=5&maba=" + MaSoKham + "&ngayDK=" + _NgayDK + "&MaBN=" + _MaBN + "&STT=" + _STT.ToString());
                    }
                }
                e.Canceled = true;
            }
            catch (Exception ex)
            {
                ShowMessage(mss + ex.ToString());
            }
        }
    }
    protected void grdDichVu_ItemCommand(object sender, GridCommandEventArgs e)
    {
        //if (e.CommandName == "PerformInsert" && ((RadGrid)sender).ID == "grdXNTT")
        //{
        //    GridEditableItem editedItem = grdXNTT.MasterTableView.GetInsertItem();
        //    if (UpdateData(editedItem, FormAction.INSERT) == true)
        //    {
        //        ShowMessage(MessageType.SUCCESS, FormAction.INSERT);
        //    }
        //}
        //else
        if (e.CommandName == "PerformInsert" && sender.Equals(grdXNTT))
        {
            if (txtmadv.Value != "")
            {
                GridEditableItem editedItem = grdXNTT.MasterTableView.GetInsertItem();
                AddXN(editedItem);
                txtmadv.Value = "";
                e.Canceled = true;
            }

        }
        else if (e.CommandName == "Edit" && sender.Equals(grdDanhSachDY))
        {

            GridEditableItem _editedItem = e.Item as GridEditableItem;

            if (_editedItem != null)
            {
                Byte _SoTT = Byte.Parse(_editedItem.GetDataKeyValue("STT").ToString());
                _KhamBenh_ThuocSD_DY = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.FirstOrDefault(X => X.STT == _SoTT);
                LoadDetails_KhamBenh_ThuocThang(false, false);
            }
            e.Canceled = true;
        }
        else if (e.CommandName == "Edit" && sender.Equals(grdXNTT))
        {

            GridEditableItem _editedItem = e.Item as GridEditableItem;

            if (_editedItem != null)
            {
                Byte _SoTT = Byte.Parse(_editedItem.GetDataKeyValue("STT").ToString());
                if (_SoTT == _STT)
                {
                    _editedItem.Edit = false;
                    e.Canceled = true;
                }
                if (_editedItem["DaTT"].Text != "0")
                {
                    _editedItem.Edit = false;
                    e.Canceled = true;
                }
                if (_editedItem["MaHuongDT"].Text != "" && _editedItem["MaHuongDT"].Text != "&nbsp;")
                {
                    _editedItem.Edit = false;
                    e.Canceled = true;
                }
                //ShowMessage(_editedItem.GetDataKeyValue("MaDV").ToString());
                //if (_editedItem["NhapSL"].Text == "False" && sender.Equals(grdXNTT))
                //{
                //   // ((RadNumericTextBox)_editedItem["SoLuong"].FindControl("tbSoLuong")).Enabled = false;

                //}
            }
        }

        else if (e.CommandName == "Edit" && (!sender.Equals(grdThuocDY)))
        {

            GridEditableItem _editedItem = e.Item as GridEditableItem;

            if (_editedItem != null)
            {

                if (_editedItem["DaTT"].Text != "0")
                {
                    _editedItem.Edit = false;
                    e.Canceled = true;
                }

            }

        }
    }

    protected Boolean UpdateData(GridEditableItem editedItem, FormAction _action, string grid = "")
    {
        if (baraction.FindItemByValue("cmdPrintThuoc").Enabled == false || baraction.FindItemByValue("cmdPrintThuoc").Visible == false)
            return true;
        if (CheckFormData() == false)
            return false;
        switch (CurrentTabIndex)
        {
            case 1:
                {

                    if (UpdateDataXN(editedItem, _action) == false)
                        return false;

                    break;
                }
            case 2:
                {

                    if (UpdateDataThuoc(editedItem, _action) == false)
                        return false;

                    break;
                }
            case 3:
                {
                    if (UpdateDataThuocDY(editedItem, _action, grid) == false)
                        return false;
                    break;
                }
                //case 7:
                //    {

                //        if (UpdateDataVTTH(editedItem, _action) == false)
                //            return false;

                //        break;
                //    }

        }
        tinhlaihd();
        txtmadv.Value = "";
        return true;
    }
    private void tinhlaihd()
    {
        _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();
        txtTongTien.Text = _ThongtinBN.KhamBenh.TongThanhToan.ToString("###,###");
        txtTienThuoc.Text = (_ThongtinBN.KhamBenh.TongThuocTY + _ThongtinBN.KhamBenh.TongThuocDY).ToString("###,###");
        txtTienXN.Text = _ThongtinBN.KhamBenh.TongDV.ToString("###,###");
        txtTongTienT.Text = _ThongtinBN.KhamBenh.TongThanhToan.ToString("###,###");
        txtTienThuocT.Text = (_ThongtinBN.KhamBenh.TongThuocTY + _ThongtinBN.KhamBenh.TongThuocDY).ToString("###,###");
        txtTienXNT.Text = _ThongtinBN.KhamBenh.TongDV.ToString("###,###");

    }

    protected void grdDichVu_UpdateCommand(object sender, GridCommandEventArgs e)
    {
        try
        {
            GridEditableItem editedItem = e.Item as GridEditableItem;
            string id = ((RadGrid)sender).ID;
            if (editedItem != null)
            {
                if (UpdateData(editedItem, FormAction.EDIT, id) == true)
                {
                    ShowMessage(MessageType.SUCCESS, FormAction.EDIT);
                }
            }

        }
        catch (Exception ex)
        {
            //  ShowMessage("Không thực hiện được dữ liệu" + ex.Message);
            ShowMessage(MessageType.ERROR, FormAction.EDIT);
        }

        // e.Canceled = true;
    }
    protected void grdDichVu_InsertCommand(object sender, GridCommandEventArgs e)
    {
        try
        {

            GridEditableItem editedItem = null;
            if (CurrentTabIndex == 3)
                editedItem = grdThuocDY.MasterTableView.GetInsertItem();

            else if (sender.Equals(grdThuoc))
                editedItem = grdThuoc.MasterTableView.GetInsertItem();
            //else if (sender.Equals(grdVTTH))
            //    editedItem = grdVTTH.MasterTableView.GetInsertItem();
            else if (sender.Equals(grdXNTT) && txtmadv.Value == "")
                editedItem = grdXNTT.MasterTableView.GetInsertItem();

            string id = ((RadGrid)sender).ID;
            if (editedItem != null && ((txtmadv.Value == "" && CurrentTabIndex == 1) || CurrentTabIndex != 1))
            {
                if (UpdateData(editedItem, FormAction.INSERT, id) == true)
                {
                    if (sender.Equals(grdXNTT) && txtmadv.Value == "")
                    {
                        grdXNTT.DataBind();
                        grdXNTT.MasterTableView.IsItemInserted = true;
                    }
                    ShowMessage(MessageType.SUCCESS, FormAction.INSERT);
                }
                else if (sender.Equals(grdXNTT) && txtmadv.Value == "")
                {


                    ((RadNumericTextBox)editedItem["SoLuong"].FindControl("tbSoLuong")).Focus();

                }
            }

            txtmadv.Value = "";

        }
        catch (Exception ex)
        {
            //throw;
        }
        e.Canceled = true;
    }
    protected void grdThuoc_InsertCommand(object sender, GridCommandEventArgs e)
    {
        try
        {


            GridEditableItem editedItem = null;
            editedItem = grdThuoc.MasterTableView.GetInsertItem();
            string id = "grdThuoc";
            if (editedItem != null)
            {
                if (UpdateData(editedItem, FormAction.INSERT, id) == true)
                {
                    ShowMessage(MessageType.SUCCESS, FormAction.INSERT);
                }
            }


        }
        catch (Exception ex)
        {
            //throw;
        }
        e.Canceled = true;
    }

    protected void grdDichVu_DeleteCommand(object sender, GridCommandEventArgs e)
    {
        try
        {
            Boolean _dele = true;

            GridEditableItem editedItem = e.Item as GridEditableItem;
            string id = ((RadGrid)sender).ID;

            switch (CurrentTabIndex)
            {
                case 2:
                case 1:
                    {

                        if ((editedItem["DaTT"].Text != "0" && editedItem["DaTT"].Text != ""))
                        {
                            ShowMessage("Chỉ định này đã thanh toán không thể xóa được");
                            _dele = false;
                        }
                        if (id.IndexOf("grdXNTT") >= 0)
                        {
                            if (editedItem["MaHuongDT"].Text != "" && editedItem["MaHuongDT"].Text != "&nbsp;")
                            {
                                ShowMessage("Chỉ định này đã thực hiện không thể xóa được");
                                _dele = false;
                            }
                        }
                        break;
                    }
                case 3:
                    {
                        if (id.IndexOf("grdDanhSachDY") >= 0)
                        {
                            int STT = int.Parse(editedItem.GetDataKeyValue("STT").ToString());
                            _KhamBenh_ThuocSD_DY = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.FirstOrDefault(X => X.STT == STT);
                            if (_KhamBenh_ThuocSD_DY == null)
                                return;

                            if (_KhamBenh_ThuocSD_DY.DATT != 0)
                            {
                                ShowMessage("Chỉ định này đã thanh toán không thể xóa được");
                                _dele = false;
                                e.Canceled = true;
                                return;
                            }
                            if (_KhamBenh_ThuocSD_DY.Phat == true)
                            {
                                ShowMessage("Chỉ định này đã phát không thể xóa được");
                                _dele = false;
                                e.Canceled = true;
                                return;
                            }
                            _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.RemoveTo(_KhamBenh_ThuocSD_DY, _ThongtinBN.KhamBenh);
                            // _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();
                            tinhlaihd();
                            grdDanhSachDY.DataBind();
                            _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
                            _KhamBenh_ThuocSD_DY.MaDT = _ThongtinBN.KhamBenh.MaDT;
                            grdThuocDY.MasterTableView.IsItemInserted = true;
                            grdThuocDY.EditIndexes.Clear();
                            grdThuocDY.MasterTableView.Rebind();
                            return;
                        }
                        else
                        {
                            if (_KhamBenh_ThuocSD_DY.DATT != 0 && pub_bQadmin == false)
                            {
                                ShowMessage("Chỉ định này đã thanh toán không thể xóa được");
                                _dele = false;
                            }
                            if (_KhamBenh_ThuocSD_DY.Phat == true && pub_bQadmin == false)
                            {
                                ShowMessage("Chỉ định này đã phát không thể xóa được");
                                _dele = false;
                            }
                        }
                        break;
                    }


            }

            if (_dele == true)
            {
                if (UpdateData(editedItem, FormAction.DELETE, id) == true)
                {
                    ShowMessage(MessageType.SUCCESS, FormAction.DELETE);
                }
            }
            else
            {
                e.Canceled = true;
            }

        }
        catch (Exception ex)
        {
            //throw;
        }
    }
    protected void grdDSDieuTri_NeedDataSource(object sender, GridNeedDataSourceEventArgs e)
    {
        grdDSDieuTri.DataSource = _KhamBenh_GETsMABNListInfo;


    }
    //protected void grdChiTietDichVu_NeedDataSource(object sender, GridNeedDataSourceEventArgs e)
    //{

    //    grdChiTietDichVu.DataSource = _KhamBenh_GetsDichVuList;
    //}
    protected void grdDSDieuTri_ItemCommand(object sender, GridCommandEventArgs e)
    {
        if (e.CommandName == "Edit")
        {
            GridDataItem editedItem = e.Item as GridDataItem;

            string _Masokham = editedItem.GetDataKeyValue("MaSoKham").ToString();

            KhamBenh_GetsDichVuList _KhamBenh_GetsDichVuList = KhamBenh_GetsDichVuList.GetAllGetsDichVu(_Masokham, byte.Parse("0"), 0, "");
            if (_KhamBenh_GetsDichVuList != null)
            {
                if (_KhamBenh_GetsDichVuList.Count > 0)
                {

                    KhamBenh_XN_GetsList _KhamBenh_XN_GetsList = KhamBenh_XN_GetsList.GetAllGetsDichVu(_KhamBenh_GetsDichVuList[0].MaSoKham, 1, DateTime.Parse(_KhamBenh_GetsDichVuList[0].NGAYYC), _LoaiPhieu, "", 0);
                    _ThongtinBN.KhamBenh.KhamBenh_XN_GetsList = _KhamBenh_XN_GetsList;
                }
                grdChiTietDichVu.DataSource = _KhamBenh_GetsDichVuList;

                try
                {
                    grdChiTietDichVu.DataBind();
                }
                catch (Exception ex)
                { }

            }



        }

    }


    protected void AddXN(GridEditableItem item)
    {

        //IEnumerable<RadComboBoxItem> checkedItems = from checkedItem in cbodichvu.Items.ToList()
        //                                                 where ((CheckBox )checkedItem.FindControl("chkChon")).Checked  == true
        //                                                 select checkedItem;
        if (CheckFormData() == false)
            return;
        string madv = txtmadv.Value;
        madv = madv.Substring(0, madv.Length - 1);
        string madvct = "";
        while (madv != "")
        {
            if (madv.IndexOf(",") == -1)
            {
                madvct = madv; ;
                madv = "";
            }
            else
            {
                madvct = madv.Substring(0, madv.IndexOf(","));
                madv = madv.Substring(madv.IndexOf(",") + 1);
            }
            if (madvct == "")
                return;
            // DMDichVu_Gia_DTList listt = odsDichVu.Select() as DMDichVu_Gia_DTList;
            DMDichVu_Gia_DTList listt = DMDichVu_Gia_DTList.FindDMDichVu_Gia_DTByMa(madvct, _ThongtinBN.KhamBenh.MaDT, _NoiTT);
            if (listt == null)
                return;
            DMDichVu_Gia_DT _DMDichVu_Giat = listt.FirstOrDefault(X => X.MaDV == madvct);

            if (_DMDichVu_Giat == null)
                return;
            foreach (KhamBenh_C bac in _ThongtinBN.KhamBenh.KhamBenh_C_List)
            {
                if (madvct == bac.MaDV)
                {
                    ShowMessage("Đã tồn tại dịch vụ này");

                }
            }

            if (_DMDichVu_Giat.nhapsl == false)
            {
                UpdateDataXN(item, FormAction.INSERT, madvct, _DMDichVu_Giat);

            }
            else if (_DMDichVu_Giat.nhapsl == true && _DMDichVu_Giat.dongiatt != "")
            {
                UpdateDataXN(item, FormAction.INSERT, madvct, _DMDichVu_Giat);

            }
            else if (_DMDichVu_Giat.dongiatt == "" || _DMDichVu_Giat.dongiatt == "0")
            {
                DMDichVu_Gia_Goi_DTList _DMDichVu_Gia_Goi_DTList = DMDichVu_Gia_Goi_DTList.FindDMDichVu_Gia_Goi_DTByMa(madvct, _ThongtinBN.KhamBenh.MaDT);
                if (_DMDichVu_Gia_Goi_DTList.Count > 0)
                {
                    foreach (DMDichVu_Gia_DT _DMDichVu_Gia in _DMDichVu_Gia_Goi_DTList)
                    {
                        KhamBenh_C _KhamBenh_C = Supports_KhamBenh_C(_DMDichVu_Gia.MaDV, _DMDichVu_Gia);
                        _KhamBenh_C.slmua = "1";
                        _KhamBenh_C.SoLuong = "1";
                        if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0)
                            _KhamBenh_C.STT = 1;
                        else
                            _KhamBenh_C.STT = _ThongtinBN.KhamBenh.KhamBenh_C_List[_ThongtinBN.KhamBenh.KhamBenh_C_List.Count - 1].STT + 1;



                        _ThongtinBN.KhamBenh.KhamBenh_C_List.AssignTo(_KhamBenh_C, _ThongtinBN.KhamBenh);
                    }

                }

            }

        }
        // _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();
        tinhlaihd();

        grdXNTT.EditIndexes.Clear();
        grdXNTT.MasterTableView.Rebind();
        grdXNTT.Rebind();
    }
    protected void cboHuongDT_SelectedIndexChanged(object sender, EventArgs e)
    {
        KiemTraHDT();
        cboHuongDT.Focus();
    }
    protected void txtMaNV_TextChanged(object sender, EventArgs e)
    {
        if (txtMaNV.Text != "")
        {
            //cboNhanVien.ClearSelection();
            //cboNhanVien.DataBind();
            RadComboBoxItem selectedItem = new RadComboBoxItem();
            DMNhanVienList _DMNhanVienList = DMNhanVienList.FindDMNhanVienByMa(txtMaNV.Text.Trim());
            if (_DMNhanVienList.Count > 0)
            {
                cboNhanVien.Text = _DMNhanVienList[0].HoTen;
                cboNhanVien.SelectedValue = _DMNhanVienList[0].MaNV;
                //selectedItem.Text = _DMNhanVienList[0].HoTen;
                //selectedItem.Value = _DMNhanVienList[0].MaNV;
                //cboNhanVien.Items.Add(selectedItem);
                //selectedItem.Selected = true;
                //selectedItem.DataBind();
                //cboNhanVien.DataBind();

            }
        }
    }
    protected void txtmaql_TextChanged(object sender, EventArgs e)
    {
        if (txtMaQL.Text != "" && _MaBN == "")
        {

            ThongtinBN _obttbn = ThongtinBN.GetThongtinBN(txtMaQL.Text, DateTime.Now, _LoaiPhieu);
            if (_obttbn != null && _obttbn.MaBN != "")
            {
                _ThongtinBN = _obttbn;

                _MaBN = _ThongtinBN.MaBN;
                LoadData();
            }
        }

    }

    protected void cboNhapHoTroDY_SelectedIndexChanged(object sender, RadComboBoxSelectedIndexChangedEventArgs e)
    {

        if (cboNhapHoTroDY.SelectedValue.IndexOf("/") > 0)
        {
            _MaSoKhamT = cboNhapHoTroDY.SelectedValue.Substring(0, cboNhapHoTroDY.SelectedValue.IndexOf("/"));

            _STTT = int.Parse(cboNhapHoTroDY.SelectedValue.Substring(cboNhapHoTroDY.SelectedValue.IndexOf("/") + 1));
        }
        LoadDetails_KhamBenh_ThuocThang(false, false, _MaSoKhamT, byte.Parse(_STTT.ToString()));
    }
    protected void cboNhapHoTroTY_SelectedIndexChanged(object sender, RadComboBoxSelectedIndexChangedEventArgs e)
    {
        LoadDetails_KhamBenh_ThuocSuDung(false, false, cboNhapHoTroTY.SelectedValue);
        _MaSoKhamT = cboNhapHoTroTY.SelectedValue; cboNhapHoTroDY.Focus();
    }
    //protected void grdwidChiTiet_NeedDataSource(object sender, GridNeedDataSourceEventArgs e)
    //{
    //    if (CurrentTabIndex == 1)
    //    {
    //        grdwidChiTiet.DataSource = KhamBenh_ThuocSD_DY.GetKhamBenh_ThuocSD_DY(_MaSoKhamT, _STTT);

    //    }
    //    else
    //        grdwidChiTiet.DataSource = KhamBenh_ThuocSDList.GetAllKhamBenh_ThuocSD(_MaSoKhamT);
    //}
    protected void txtSLThang_TextChanged(object sender, EventArgs e)
    {
        if (_KhamBenh_ThuocSD_DY == null)
            return;
        if (_KhamBenh_ThuocSD_DY.DATT != 0)
        {
            ShowMessage("Đã thanh toán đơn thuốc này");
            return;
        }
        _KhamBenh_ThuocSD_DY.SLThang = txtSLThang.Text;
        _KhamBenh_ThuocSD_DY.SLMua = txtSLThang.Text;
        if (_KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs.Count > 0)
        {
            _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.UpdatedTo(_KhamBenh_ThuocSD_DY);


            _KhamBenh_ThuocSD_DY.TinhLaiDon();

            txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
            txtTT.Value = (_KhamBenh_ThuocSD_DY.SLMua == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua)).ToString("###,###");
            txtDonThang.Text = txtTT.Value;
            tinhlaihd();
        }
    }


    private void KiemTraHDT()
    {
        cboBVChuyen.Visible = false;
        lblHuongDT.Visible = false;
        cboKhoaNV.Visible = false;
        dtNgayHen.Visible = false;
        duantest.ColSpan = 3;
        KhamBenh_C _KhamBenh_KB = _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(X => X.STT == _STT);
        lblHuongDT.Text = "Ngày hẹn";
        dtNgayHen.Visible = true;
        duantest.ColSpan = 1;
        lblHuongDT.Visible = true;
        if (_KhamBenh_KB != null && dtNgayHen.Text == "")
            dtNgayHen.Text = _KhamBenh_KB.ngayhen;
        switch (cboHuongDT.SelectedValue)
        {
            case "00002":// dieu tri theo hen
                {
                    lblHuongDT.Text = "Ngày hẹn";
                    dtNgayHen.Visible = true;
                    duantest.ColSpan = 1;
                    lblHuongDT.Visible = true;
                    if (_KhamBenh_KB != null)
                        dtNgayHen.Text = _KhamBenh_KB.ngayhen;
                    break;
                }
            case "00007":
            case "00017":
            case "00107":
            case "10007":
            case "20007":
            case "30007":
            case "40007": // chuyen vien
                {
                    lblHuongDT.Text = "Bệnh viện";
                    cboBVChuyen.Visible = true;
                    if (dtNgayHen.Text == "")
                        dtNgayHen.Text = DateTime.Now.ToString("dd/MM/yyyy");
                    if (_KhamBenh_Noi.MaBV != "")
                    {
                        RadComboBoxItem selectedItemc = new RadComboBoxItem();

                        selectedItemc.Text = _KhamBenh_Noi.TenBV;
                        selectedItemc.Value = _KhamBenh_Noi.MaBV;
                        cboBVChuyen.Items.Add(selectedItemc);
                        selectedItemc.Selected = true;
                        selectedItemc.DataBind();
                        cboBVChuyen.DataBind();

                    }

                    lblHuongDT.Visible = true;
                    break;
                }
            case "00005":// chuyen phong
                {
                    lblHuongDT.Text = "Khoa";
                    cboKhoaNV.Visible = true;
                    cboKhoaNV.DataSourceID = "odskhoaBN";
                    cboKhoaNV.DataBind();
                    if (_KhamBenh_KB != null)
                    {
                        if (_KhamBenh_KB.Makhoa != "")
                        {
                            RadComboBoxItem selectedItemc = new RadComboBoxItem();

                            selectedItemc.Text = _KhamBenh_KB.tenkhoa;
                            selectedItemc.Value = _KhamBenh_KB.Makhoa;
                            cboKhoaNV.Items.Add(selectedItemc);
                            selectedItemc.Selected = true;
                            selectedItemc.DataBind();
                            cboKhoaNV.DataBind();

                        }
                    }
                    break;
                }
            case "00006": // nhap vien
                {
                    lblHuongDT.Text = "Khoa";
                    cboKhoaNV.Visible = true;
                    cboKhoaNV.DataSourceID = "odskhoaNV";
                    cboKhoaNV.DataBind();
                    if (dtNgayHen.Text == "")
                        dtNgayHen.Text = DateTime.Now.ToString("dd/MM/yyyy");
                    if (_KhamBenh_KB != null)
                    {
                        if (_KhamBenh_KB.MakhoaVV != "")
                        {
                            RadComboBoxItem selectedItemc = new RadComboBoxItem();

                            selectedItemc.Text = DMKhoa.GetDMKhoa(_KhamBenh_KB.MakhoaVV).TenKhoa;
                            selectedItemc.Value = _KhamBenh_KB.MakhoaVV;
                            cboKhoaNV.Items.Add(selectedItemc);
                            selectedItemc.Selected = true;
                            selectedItemc.DataBind();
                            cboKhoaNV.DataBind();

                        }
                    }
                    lblHuongDT.Visible = true;
                    break;
                }
            case "00003": // dieu tri ngoai tru
                {
                    lblHuongDT.Text = "Khoa";
                    cboKhoaNV.Visible = true;
                    cboKhoaNV.DataSourceID = "odskhoaBN";
                    cboKhoaNV.DataBind();
                    if (dtNgayHen.Text == "")
                        dtNgayHen.Text = DateTime.Now.AddDays(30).ToString("dd/MM/yyyy");
                    if (_KhamBenh_KB != null)
                    {
                        if (_KhamBenh_KB.MakhoaVV != "")
                        {
                            RadComboBoxItem selectedItemc = new RadComboBoxItem();

                            selectedItemc.Text = DMKhoa.GetDMKhoa(_KhamBenh_KB.MakhoaVV).TenKhoa;
                            selectedItemc.Value = _KhamBenh_KB.MakhoaVV;
                            cboKhoaNV.Items.Add(selectedItemc);
                            selectedItemc.Selected = true;
                            selectedItemc.DataBind();
                            cboKhoaNV.DataBind();

                        }
                    }
                    lblHuongDT.Visible = true;
                    break;
                }
            default:
                {
                    lblHuongDT.Text = "Ngày hẹn";
                    dtNgayHen.Visible = true;
                    duantest.ColSpan = 1;
                    lblHuongDT.Visible = true;
                    if (_KhamBenh_KB != null && dtNgayHen.Text == "")
                        dtNgayHen.Text = _KhamBenh_KB.ngayhen;
                    break;
                }
        }
    }
    private void PrintDbf(string spath)
    {
        //string name = Server.MapPath("PDF/mitesh.pdf");
        //ProcessStartInfo newProcess = new ProcessStartInfo(pdfPath, dfArguments);

        //newProcess.CreateNoWindow = true;
        //newProcess.RedirectStandardOutput = true;
        //newProcess.UseShellExecute = false;

        //Process pdfProcess = new Process();
        //pdfProcess.StartInfo = newProcess;
        //pdfProcess.StartInfo.WindowStyle = ProcessWindowStyle.Hidden;
        //pdfProcess.Start();
        //pdfProcess.WaitForExit();
        //                        Dim s As System.IO.MemoryStream = rptSummary.ExportToStream(ExportFormatType.PortableDocFormat)

        //Tha Above statement gives an error in VS2005. It compalins that there is an implicit conversion from stream to memorystream and will not let you do that.

        //myMemstream = oRpt.ExportToStream (ExportFormatType.PortableDocFormat); 
        //                         rpt.ExportToHttpResponse(CrystalDecisions.Shared.ExportFormatType.PortableDocFormat, Response, false,""); // 

        // IO.MemoryStream mem = (IO.MemoryStream)crd.ExportToStream(CrystalDecisions.Shared.ExportFormatType.PortableDocFormat);
        //Response.Clear();
        //Response.Buffer = true;
        //Response.ContentType = "application/pdf";
        //Response.BinaryWrite(mem.ToArray());
        //oStream = (MemoryStream)crReport.ExportToStream(ExportFormatType.Excel);

        //Response.ContentType = "application/vnd.ms-excel";
        //MemoryStream memStream = new MemoryStream();
        //PdfWriter wri = PdfWriter.GetInstance(doc, memStream);
        //doc.Open();

        //PdfContentByte cb = writer.DirectContent;

        //PdfImportedPage page;

        //for (int i = 1; i < pdfr.NumberOfPages + 1; i++)
        //{
        //    page = writer.GetImportedPage(pdfr, i);
        //    cb.AddTemplate(page, PageSize.LETTER.Width / pdfr.GetPageSize(i).Width, 0, 0, PageSize.LETTER.Height / pdfr.GetPageSize(i).Height, 0, 0);
        //    doc.NewPage();
        //}

        //// place A
        //doc.Close();
        //Open exsisting pdf


        Document document = new Document(PageSize.LETTER);
        PdfReader reader = new PdfReader(HttpContext.Current.Server.MapPath(spath));

        //Getting a instance of new pdf wrtiter
        PdfWriter writer = PdfWriter.GetInstance(document, new FileStream(HttpContext.Current.Server.MapPath("Print.pdf"), FileMode.Create));

        document.Open();

        PdfContentByte cb = writer.DirectContent;

        int i = 0;
        int p = 0;
        int n = reader.NumberOfPages;
        Rectangle psize = reader.GetPageSize(1);
        float width = psize.Width;
        float height = psize.Height;

        //Add Page to new document

        while (i < n)
        {
            document.NewPage();
            p++;
            i++;
            PdfImportedPage page1 = writer.GetImportedPage(reader, i);
            cb.AddTemplate(page1, 0, 0);

        }

        //Attach javascript to the document

        PdfAction jAction = PdfAction.JavaScript("this.print(true);\r", writer);
        writer.AddJavaScript(jAction);
        document.Close();
        //redirect other 
        Response.Redirect("Print.pdf");
        //Attach pdf to the iframe

        // frmPrint.Attributes["src"] = "Print.pdf";
        /*
         var notUriPath = Server.MapPath("~/" + filePathName);

    var doc = new Document();
    var reader = new PdfReader(notUriPath);
    using (var memoryStream = new MemoryStream())
    {
        var writer = PdfWriter.GetInstance(doc, memoryStream);
        doc.Open();

        // this action leads directly to printer dialogue
        var jAction = PdfAction.JavaScript("this.print(true);\r", writer);
        writer.AddJavaScript(jAction);

        var cb = writer.DirectContent;
        doc.AddDocListener(writer);

        for (var p = 1; p <= reader.NumberOfPages; p++)
        {
            doc.SetPageSize(reader.GetPageSize(p));
            doc.NewPage();
            var page = writer.GetImportedPage(reader, p);
            var rot = reader.GetPageRotation(p);
            if (rot == 90 || rot == 270)
                cb.AddTemplate(page, 0, -1.0F, 1.0F, 0, 0, reader.GetPageSizeWithRotation(p).Height);
            else
                cb.AddTemplate(page, 1.0F, 0, 0, 1.0F, 0, 0);
        }

        reader.Close();
        doc.Close();
        File.WriteAllBytes(notUriPath, memoryStream.ToArray());
    }

    theIframeForPrint.Attributes.Add("src", fullFilePath);
}*/

    }
    protected void grdXNTT_ItemCreated(object sender, GridItemEventArgs e)
    {

        if (e.Item is GridEditableItem && e.Item.IsInEditMode)
        {

            GridEditableItem editItem = (GridEditableItem)e.Item;
            if (editItem.ItemIndex != -1)
            {
                return;
            }
            if (editItem != null)
            {
                RadComboBox combo = ((RadComboBox)editItem.FindControl("cboMaDichVu"));

                if (HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ ")
                {
                    combo.OnClientItemsRequesting = "OnClientItemsRequesting";
                    combo.DataTextField = "MaDD";
                    combo.Filter = RadComboBoxFilter.Contains;
                    combo.EnableAutomaticLoadOnDemand = true;
                    combo.EnableLoadOnDemand = true;
                    //combo.OnClientFocus = "OnClientFocus";
                }
                else if (HTC.ShareVariables.pub_spC == "HU")
                {
                    combo.Filter = RadComboBoxFilter.Contains;
                    combo.DataTextField = "TenDD";
                    combo.EnableAutomaticLoadOnDemand = false;
                    combo.EnableLoadOnDemand = true;
                    //combo.OnClientFocus = "OnClientFocus";
                }
                else
                {
                    combo.Filter = RadComboBoxFilter.StartsWith;
                    combo.OnClientItemsRequesting = "OnClientItemsRequesting";
                    combo.EnableAutomaticLoadOnDemand = true;
                    combo.EnableLoadOnDemand = true;
                    //combo.OnClientFocus = "OnClientFocus";
                }
                combo.Focus();
            }
        }

    }
    protected void cmdInPhieu_Click(object sender, EventArgs e)
    {
        if (UpdateDataSave())
        {
            PrintPhieu();
        }
        if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count == 0 && cboHuongDT.SelectedValue != "" && HTC.ShareVariables.pub_spC == "HU")
            PrintVPThanhToanBH();
    }
    protected void cmdViewPD(object sender, EventArgs e)
    {
        PhacDoDTList _PhacDoDTList = PhacDoDTList.GetAllPhacDoDT(pub_bQadmin, cboChanDoan.SelectedValue, "", "", "");
        if (_PhacDoDTList != null)
            if (_PhacDoDTList.Count > 0)
                Context.Response.Write("<script> language='javascript'>window.open('frmPhacDoDT.aspx?loai=1&MaPD=" + _PhacDoDTList[0].MaPD + "','_newtab');</script>");
    }
    protected void grdKeNgoai_DeletedCommand(object sender, GridCommandEventArgs e)
    {
        try
        {
            GridEditableItem editedItem = e.Item as GridEditableItem;
            if (CheckFormData() == true)
            {
                UpdateDataKeNgoai(editedItem, FormAction.DELETE);
                grdKeNgoai.MasterTableView.Rebind();
                grdKeNgoai.Rebind();

            }
            else
                e.Canceled = true;
            //grdKeNgoai.EditIndexes.Clear();
            //grdKeNgoai.MasterTableView.PerformInsert(editedItem,true);

        }
        catch (System.IO.IOException ex)
        {
            e.Canceled = true;
            HandleException(ex, FormAction.DELETE);
            ShowMessage(MessageType.ERROR, FormAction.DELETE);
        }
    }



    protected void grdKeNgoai_UpdateCommand(object sender, GridCommandEventArgs e)
    {


        try
        {
            GridEditableItem editedItem = e.Item as GridEditableItem;

            if (CheckFormData() == true)
            {
                UpdateDataKeNgoai(editedItem, FormAction.EDIT);
                grdKeNgoai.EditIndexes.Clear();
                grdKeNgoai.MasterTableView.Rebind();
                grdKeNgoai.Rebind();
            }
            else
                e.Canceled = true;

        }
        catch (System.IO.IOException ex)
        {
            e.Canceled = true;


            ShowMessage(MessageType.ERROR, FormAction.EDIT);
        }
    }

    protected void grdKeNgoai_InsertCommand(object sender, GridCommandEventArgs e)
    {
        try
        {
            GridEditableItem editedItem = grdKeNgoai.MasterTableView.GetInsertItem();
            if (CheckFormData() == true)
            {

                UpdateDataKeNgoai(editedItem, FormAction.INSERT);
                grdKeNgoai.MasterTableView.Rebind();
                grdKeNgoai.Rebind();
            }
            else
                e.Canceled = true;
            //grdKeNgoai.EditIndexes.Clear();
            //grdKeNgoai.MasterTableView.PerformInsert(editedItem,true);

        }
        catch (System.IO.IOException ex)
        {
            e.Canceled = true;
            HandleException(ex, FormAction.INSERT);
            ShowMessage(MessageType.ERROR, FormAction.INSERT);
        }


    }
    protected void grdKeNgoai_ItemDataBound(object sender, GridItemEventArgs e)
    {
        if (e.Item is GridEditableItem && e.Item.IsInEditMode)
        {
            GridEditableItem form = (GridEditableItem)e.Item;

            InitTabIndexForRadGrid(((RadGrid)sender), form, 4);

            if (form.ItemIndex != -1)
            {
                form["MaKe"].Enabled = false;
                RadNumericTextBox dataField = (RadNumericTextBox)form.FindControl("tbSoLuong");
                dataField.Focus();
            }

            else
            {
                if (grdKeNgoai.EditItems.Count > 0)
                    e.Item.FireCommandEvent(RadGrid.CancelCommandName, string.Empty);
                else
                {
                    form["MaKe"].Enabled = true;
                    ((RadComboBox)form["MaKe"].FindControl("cboDichVu")).Focus();
                }
                form["MaKe"].Enabled = true;

            }

        }
    }

    protected void grdKeNgoai_NeedDataSource(object sender, GridNeedDataSourceEventArgs e)
    {

        grdKeNgoai.DataSource = _KhamBenh_KeNgoaiList;

    }
    protected Boolean UpdateDataKeNgoai(GridEditableItem editedItem, FormAction _action)
    {
        if (baraction.FindItemByValue("cmdSave").Enabled == false || baraction.FindItemByValue("cmdSave").Visible == false)
            return true;

        if (editedItem != null)
        {
            KhamBenh_KeNgoai _KhamBenh_KeNgoai;
            string MaKe = "";

            if (_action != FormAction.DELETE)
            {

                if (editedItem.FindControl("tbSoLuong") == null)
                    return false;

                RadNumericTextBox txtsoluong = (RadNumericTextBox)editedItem.FindControl("tbSoLuong");
                TextBox txtlieudung = (TextBox)editedItem["LieuDung"].Controls[0];
                TextBox txtcachdung = ((TextBox)editedItem["CachDung"].Controls[0]);

                if (_action == FormAction.INSERT)
                {
                    RadComboBox _dmthuoccb = (RadComboBox)editedItem.FindControl("cboDichVu");
                    MaKe = _dmthuoccb.SelectedValue;
                    DMThuoc_KeList list = DMThuoc_KeList.FindDMThuoc_KeMa(MaKe);

                    if (list == null)
                        return false;
                    DMThuoc_Ke _dmthuoc = list.FirstOrDefault(X => X.MaKe == MaKe);
                    if (_dmthuoc.Nguong < decimal.Parse(txtsoluong.Text == "" ? "0" : txtsoluong.Text))
                    {
                        ShowMessage("Thuốc này không còn tồn");
                        return false;
                    }
                    _KhamBenh_KeNgoai = KhamBenh_KeNgoai.NewKhamBenh_KeNgoai();
                    _KhamBenh_KeNgoai.MaKe = MaKe;

                    _KhamBenh_KeNgoai.SLKeDon = txtsoluong.Text == "" ? "0" : txtsoluong.Text;
                    _KhamBenh_KeNgoai.SLMua = _KhamBenh_KeNgoai.SLKeDon;
                    _KhamBenh_KeNgoai.TenTM = _dmthuoc.TenTMHL;
                    _KhamBenh_KeNgoai.TenDVT = _dmthuoc.tendvt;
                    _KhamBenh_KeNgoai.ChanDoan = txtChanDoan.Text;
                    _KhamBenh_KeNgoai.LieuDung = txtlieudung.Text;
                    _KhamBenh_KeNgoai.CachDung = txtcachdung.Text;

                    _KhamBenh_KeNgoai.BSChiDinh = cboNhanVien.SelectedValue;
                    _KhamBenh_KeNgoai.NgayDK = _ThongtinBN.KhamBenh.NgayDK;
                    _KhamBenh_KeNgoai.MaBN = _ThongtinBN.MaBN;
                    _KhamBenh_KeNgoai.MaKhoa = _MaKhoa;
                    _KhamBenh_KeNgoai.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                    _KhamBenh_KeNgoai.MaMay = Pub_sMaMay;
                    _KhamBenh_KeNgoai.NguoiSD = Pub_sNguoiSD;
                    if (_KhamBenh_KeNgoaiList.Count == 0)
                    {
                        _KhamBenh_KeNgoai.STT = 1;
                        _KhamBenh_KeNgoai.OrderNumber = 1;
                    }
                    else
                    {
                        _KhamBenh_KeNgoai.STT = _KhamBenh_KeNgoaiList[_KhamBenh_KeNgoaiList.Count - 1].STT + 1;
                        _KhamBenh_KeNgoai.OrderNumber = _KhamBenh_KeNgoaiList[_KhamBenh_KeNgoaiList.Count - 1].OrderNumber + 1;
                    }

                    if (_KhamBenh_KeNgoai.IsNew == true)
                        _KhamBenh_KeNgoai.NguoiLap = Pub_sNguoiSD;
                    _KhamBenh_KeNgoai.MaMay = Pub_sMaMay;
                    _KhamBenh_KeNgoai.NguoiSD = Pub_sNguoiSD;
                    _KhamBenh_KeNgoaiList.NewTo(_KhamBenh_KeNgoai);


                }
                else if ((_action == FormAction.EDIT))
                {

                    _KhamBenh_KeNgoai = _KhamBenh_KeNgoaiList[int.Parse(editedItem.GetDataKeyValue("OrderNumber").ToString()) - 1];
                    _KhamBenh_KeNgoai.SLKeDon = txtsoluong.Text == "" ? "0" : txtsoluong.Text;
                    _KhamBenh_KeNgoai.SLMua = _KhamBenh_KeNgoai.SLKeDon;
                    _KhamBenh_KeNgoai.MaMay = Pub_sMaMay;
                    _KhamBenh_KeNgoai.NguoiSD = Pub_sNguoiSD;
                    _KhamBenh_KeNgoai.LieuDung = txtlieudung.Text;
                    _KhamBenh_KeNgoai.CachDung = txtcachdung.Text;
                    _KhamBenh_KeNgoaiList.UpdatedTo(_KhamBenh_KeNgoai);

                }

            }
            else
            {
                _KhamBenh_KeNgoai = _KhamBenh_KeNgoaiList[int.Parse(editedItem.GetDataKeyValue("OrderNumber").ToString()) - 1];
                _KhamBenh_KeNgoai.MaMay = Pub_sMaMay;
                _KhamBenh_KeNgoai.NguoiSD = Pub_sNguoiSD;
                _KhamBenh_KeNgoaiList.RemoveTo(_KhamBenh_KeNgoai);

                grdKeNgoai.MasterTableView.IsItemInserted = true;
                grdKeNgoai.MasterTableView.Rebind();
                grdKeNgoai.Rebind();
            }
        }

        return true;
    }
    protected void odsKhoa_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {
        e.InputParameters["account"] = Pub_sAccount;
    }
    protected void grdKhoa_NeedDataSource(object sender, GridNeedDataSourceEventArgs e)
    {
        if (_ThongKe_BenhNhan_NgoaiTruListInfo != null)
            grdKhoa.DataSource = _ThongKe_BenhNhan_NgoaiTruListInfo;
    }

    protected void KiemTraTuongTac()
    {
        int k = 0;
        if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count > 0)
        {
            foreach (KhamBenh_ThuocSD t in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
            {
                //DMTuongTacs tts = DMTuongTacs.DMThuocFind(t.TenGoc);
                //if (tts.Count > 0)
                //{
                //    for (int j = k + 1; j <= _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count - 1; j++)
                //    {
                //        KhamBenh_ThuocSD ba = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList[j];
                //        if (ba.Mathuoc != t.Mathuoc)
                //        {
                //            foreach (DMTuongTac tt in tts)
                //            {
                //                if (tt.TenGoc1 == ba.TenGoc || tt.TenGoc2 == ba.TenGoc || tt.TenGoc3 == ba.TenGoc)
                //                {
                //                    ShowMessage("Thuốc " + t.TenTM + "-" + t.TenGoc + " kết hợp" + ba.TenTM + "-" + ba.TenGoc + " sẽ " + tt.MoTa);
                //                    return;
                //                }
                //            }
                //        }
                //    }
                //}
                k++;
            }
            ShowMessage("Không có tương tác thuốc xảy ra");
        }
        k = 0;
        if (_KhamBenh_ThuocSD_DY != null)
            if (_KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs.Count > 1)
            {
                foreach (KhamBenh_ThuocSD_DY_C t in _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs)
                {
                    //DMTuongTacs tts = DMTuongTacs.DMThuocFind(t.TenGoc);
                    //if (tts.Count > 0)
                    //{
                    //    for (int j = k + 1; j <= _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs.Count - 1; j++)
                    //    {
                    //        KhamBenh_ThuocSD_DY_C ba = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs[j];
                    //        if (ba.Mathuoc != t.Mathuoc)
                    //        {
                    //            foreach (DMTuongTac tt in tts)
                    //            {
                    //                if (tt.TenGoc1 == ba.TenGoc || tt.TenGoc2 == ba.TenGoc || tt.TenGoc3 == ba.TenGoc)
                    //                {
                    //                    ShowMessage("Thuốc " + t.TenTM + "-" + t.TenGoc + " kết hợp" + ba.TenTM + "-" + ba.TenGoc + " sẽ " + tt.MoTa);
                    //                    return;
                    //                }
                    //            }
                    //        }
                    //    }
                    //}
                    k++;
                }
                ShowMessage("Không có tương tác thuốc xảy ra");
            }
    }
    public DataTable GetDTAccount(string Account, int lan = 0)
    {
        DataTable dr = new DataTable();
        if (lan < 3)
        {
            string tenStore = "spAccount_GetDTDT";
            string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=6000; pooling=true; Max Pool Size=6000;Timeout=6000;MultipleActiveResultSets=True";
            using (SqlConnection Conection = new SqlConnection(StrConection))
            {
                Conection.Open();
                using (SqlCommand Command = new SqlCommand(tenStore, Conection))
                {
                    Command.CommandType = CommandType.StoredProcedure;
                    Command.Parameters.Add(new SqlParameter("@Account", Account));
                    SqlDataAdapter dp = new SqlDataAdapter(Command);
                    dp.Fill(dr);
                }
                if (dr.Rows.Count > 0 && dr.Rows[0][0].ToString().Length > 0)
                    return dr;
                else
                    return GetDTAccount(Account, lan + 1);
            }
        }
        else
            return dr;
    }
    //ham lay url cua API lien thong DTDT
    public DataTable GetPort(string loai)
    {
        DataTable dr = new DataTable();
        string tenStore = "PACS_Port_Get";
        string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
        using (SqlConnection Conection = new SqlConnection(StrConection))
        {
            Conection.Open();
            using (SqlCommand Command = new SqlCommand(tenStore, Conection))
            {
                Command.CommandType = CommandType.StoredProcedure;
                Command.Parameters.Add(new SqlParameter("@Loai", loai));
                SqlDataAdapter dp = new SqlDataAdapter(Command);
                dp.Fill(dr);
            }
            //if (dr.Rows.Count > 0)
            return dr;
            //else
            //    return "";
        }
    }
    //ham lay ma don thuoc dien tu
    public static string GetMaxID()
    {
        string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
        DataSet ds = SqlHelper.ExecuteDataset(StrConection, "KhamBenh_ThuocSD_MaxIDDTDT");
        if (ds != null)
        {
            return ds.Tables[0].Rows[0][0].ToString();
        }
        else
        {
            return "";
        }
    }
    //ham ghi log
    public static void WriteLog(string log)
    {
        string logname = "DTDT_Log_" + DateTime.Now.ToString("ddMMyyyy") + ".txt";
        //string fileName = HttpContext.Current.Request.MapPath("MyLogs.txt");
        string fileName = HttpContext.Current.Request.MapPath(logname);
        if (!File.Exists(fileName))
        {
            using (StreamWriter sw = File.CreateText(fileName))
            {
                sw.WriteLine(DateTime.Now.ToString() + " " + log);
                sw.Close();
            }
        }
        else
        {
            using (StreamWriter sw = File.AppendText(fileName))
            {
                sw.WriteLine(DateTime.Now.ToString() + " " + log);
                sw.Close();
            }
        }
    }
    //ham check don thuoc da gui hay chua
    public bool CheckDT(string masokham, string ngaydk, string sttin, string dk)
    {
        bool kq = false;
        DataTable dr = new DataTable();
        string tenStore = "spKhamBenh_ThuocSD_CheckLT";
        string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
        using (SqlConnection Conection = new SqlConnection(StrConection))
        {
            Conection.Open();
            using (SqlCommand Command = new SqlCommand(tenStore, Conection))
            {
                Command.CommandType = CommandType.StoredProcedure;
                Command.Parameters.Add(new SqlParameter("@MaSoKham", masokham));
                Command.Parameters.Add(new SqlParameter("@NgayDk", ngaydk));
                Command.Parameters.Add(new SqlParameter("@sttin", sttin));
                Command.Parameters.Add(new SqlParameter("@DK", dk));
                SqlDataAdapter dp = new SqlDataAdapter(Command);
                dp.Fill(dr);
            }
            if (dr.Rows.Count > 0)
                kq = true;
        }
        return kq;
    }
    //ham gui don thuoc
    public void GuiDonThuoc(DataTable don, string maloaidt )
    {
        string mss = "";
        try
        {
            WriteLog("bat dau gui don thuoc" + _MaSoKham + " ngaydk: " + _NgayDK);
            //lay ma lien thong don thuoc cua bac si
            //neu bs khong co ma lien thong thi khong duoc gui
            DataTable dtAC = dtAC = GetDTAccount(Pub_sAccount);
            if (dtAC.Rows.Count > 0)
            {
                DTDTAPI rf = new DTDTAPI();
                string malienthongbs = dtAC.Rows[0][0].ToString();
                string passBS = dtAC.Rows[0][1].ToString();
                string portdnkcb = "";
                string username = "";
                string pass = "";
                string token = "";
                string loaitoken = "DTDT";
                DataTable dt = GetPort(loaitoken);
                if (dt.Rows.Count > 0)
                {
                    portdnkcb = dt.Rows[0][0].ToString();
                    username = dt.Rows[0][1].ToString();
                    pass = dt.Rows[0][2].ToString();
                }
                if (token != null && token.Length > 0)
                {
                   
                        token = rf.dangnhapBS(portdnkcb, malienthongbs, passBS, username);
                }
            // WriteLog("token" + token);
                KhamBenh_Noi kbn = KhamBenh_Noi.GetKhamBenh_Noi(_MaSoKham, _STT);                
                string sttin = "";
                string ngaydk = "";
                for (int i = 0; i < dt.Rows.Count; i++)
                {
                   
                    sttin += dt.Rows[i]["STT"].ToString() + ",";
                    ngaydk = dt.Rows[i]["NgayDK"].ToString();
                }
                if (sttin.Length > 0)
                    sttin = sttin.Remove(sttin.Length - 1);
                mss += " / STT in: " + sttin;
                if (CheckDT(_MaSoKham, ngaydk, sttin, "") == false)
                {
                    donthuoc donthuoc = new donthuoc();
                    donthuoc.loai_don_thuoc = maloaidt;
                    //ma don thuoc = ma cs kcb + so tu sinh
                    //donthuoc.ma_don_thuoc = "45923" + "0000005";
                    donthuoc.ma_don_thuoc = GetMaxID();
                    donthuoc.ho_ten_benh_nhan = _ThongtinBN.Hoten;
                    donthuoc.ma_dinh_danh_y_te = _ThongtinBN.Sothe;
                    donthuoc.ma_dinh_danh_cong_dan = _ThongtinBN.SoCMT;
                    donthuoc.ngay_sinh_benh_nhan = _ThongtinBN.NgaySinh;
                    donthuoc.can_nang = decimal.Parse(kbn.CanNang);
                    donthuoc.gioi_tinh = _ThongtinBN.GT == true ? "Nam" : "Nữ";
                    donthuoc.ma_so_the_bao_hiem_y_te = _ThongtinBN.mabhxh;
                    donthuoc.thong_tin_nguoi_giam_ho = _ThongtinBN.BaoTin;
                    donthuoc.dia_chi = _ThongtinBN.DiaChi;
                    //List<string> cd = new List<string>();
                    //if (!string.IsNullOrEmpty(_ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbenh))
                    //    cd.Add(_ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbenh);
                    //if (!string.IsNullOrEmpty(_ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbenhKem))
                    //    cd.Add(_ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbenhKem);
                    //if (!string.IsNullOrEmpty(_ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbenhKem2))
                    //    cd.Add(_ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbenhKem2);
                    //if (!string.IsNullOrEmpty(_ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbenhKem3))
                    //    cd.Add(_ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbenhKem3);
                    List<chandoan> cd = new List<chandoan>();
                    chandoan cdc = new chandoan();
                    cdc.ma_chan_doan = _KhamBenh_Noi.MaICDKem;
                    cdc.ten_chan_doan =_KhamBenh_Noi.TenBenh;
                    cdc.ket_luan = _KhamBenh_Noi.TenBenh;
                    cd.Add(cdc);
                    donthuoc.chan_doan = cd;

                    donthuoc.luu_y = "";
                    donthuoc.hinh_thuc_dieu_tri = "ngoaitru";
                    List<dot_dung_thuoc> ddt = new List<dot_dung_thuoc>();
                    dot_dung_thuoc ddtc = new dot_dung_thuoc();
                    ddtc.dot = 0 ;
                    ddtc.tu_ngay = _ThongtinBN.NguoiLap;
                    ddtc.den_ngay = _ThongtinBN.NgayLap;
                    ddtc.so_thang_thuoc = 0 ;
                    ddt.Add(ddtc);
                    donthuoc.dot_dung_thuoc = ddt;
                    List<thongtindonthuoc> ttdt = new List<thongtindonthuoc>();
 
                    for (int i = 0; i < dt.Rows.Count; i++)
                    {
                        thongtindonthuoc t = new thongtindonthuoc();
                        t.biet_duoc = dt.Rows[i]["TENGOC"].ToString();
                        t.ten_thuoc = dt.Rows[i]["TENTM"].ToString();
                        t.don_vi_tinh = dt.Rows[i]["TENDVT"].ToString();
                        t.so_luong = decimal.Parse(string.IsNullOrEmpty(dt.Rows[i]["SLmua"].ToString()) ? "0" : dt.Rows[i]["SLmua"].ToString());
                        t.cach_dung = dt.Rows[i]["CachDung"].ToString();
                        ttdt.Add(t);
                        
                    }
                    donthuoc.thong_tin_don_thuoc = ttdt;

                    donthuoc.loi_dan = kbn.DieuTri;
                    donthuoc.so_dien_thoai_nguoi_kham_benh = _ThongtinBN.DienThoai;
                    DateTime d;
                    int ngayhen = 0;
                    if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0 && _ThongtinBN.KhamBenh.KhamBenh_C_List[0] != null && DateTime.TryParse(_ThongtinBN.KhamBenh.KhamBenh_C_List[0].ngayhen, out d))
                        ngayhen = int.Parse((d - DateTime.Parse(_ThongtinBN.KhamBenh.KhamBenh_C_List[0].NgayDK)).TotalDays.ToString());
                    donthuoc.ngay_tai_kham = ngayhen;
                    donthuoc.ngay_gio_ke_don = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    donthuoc.signature = "";
                    //donthuoc.hinh_thuc_dieu_tri = "ngoaitru";
                    //donthuoc.thong_tin_don_thuoc = ttdt;
                   // donthuoc.loi_dan = kbn.DieuTri;
                    //donthuoc.so_dien_thoai_nguoi_kham_benh = _ThongtinBN.DienThoai;
                    //DateTime d;
                    //int ngayhen = 0;
                    //if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0 && _ThongtinBN.KhamBenh.KhamBenh_C_List[0] != null && DateTime.TryParse(_ThongtinBN.KhamBenh.KhamBenh_C_List[0].ngayhen, out d))
                    //    ngayhen = int.Parse((d - DateTime.Parse(_ThongtinBN.KhamBenh.KhamBenh_C_List[0].NgayDK)).TotalDays.ToString());
                    //donthuoc.ngay_tai_kham = ngayhen;
                    var serializer = new JavaScriptSerializer();
                    string serializedResult = serializer.Serialize(donthuoc);
                    mss += " / " + serializedResult;
                    string result = rf.Gui_don_thuoc(portdnkcb, token, donthuoc);

                    WriteLog("result" + result);
                    mss += " / " + result;
                    //gui thanh cong ket qua tra ve
                    //{"success":"Gửi đơn thuốc thành công"}
                    if (result == "{\"success\":\"Gửi đơn thuốc thành công\"}")
                    {
                        //string sql = "Update khambenh_thuocSD set SoDTDT ='" + donthuoc.ma_don_thuoc + "' where and isnull(huy,0)=0 and masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and sott in(" + sttin + ") and datediff(d,ngaydk,'" + ngaydk + "')=0";
                        string sql = "Update khambenh_thuocSD set SoDTDT ='" + donthuoc.ma_don_thuoc + "' where and isnull(huy,0)=0 and masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and sott in(" + sttin + ") and datediff(d,ngaydk,'" + ngaydk + "')=0";
                        WriteLog("sql" + sql);
                        HTC.Business.DataProvider.Instance().ExcSQL(sql);
                    }
                }
                else
                {
                    WriteLog("da lien thong don thuoc: masokham:" + _MaSoKham + " ngaydk: " + ngaydk + " sttin: " + sttin);
                }
            }
        }
        catch (Exception ex)
        {
            WriteLog("Loi: " + mss + " " + ex.ToString());
        }
    }
    #region object RESTful
    //object phan API đăng nhập lấy phiên làm việc
    //object gui username, pass
    [Serializable()]
    public class dangnhapbacsi
    {
        private string Ma_lien_thong_bac_si = string.Empty;
        public string ma_lien_thong_bac_si
        {
            get
            {
                return Ma_lien_thong_bac_si;
            }
            set
            {
                Ma_lien_thong_bac_si = value;
            }
        }
        private string Ma_lien_thong_co_so_kham_chua_benh = string.Empty;
        public string ma_lien_thong_co_so_kham_chua_benh
        {
            get
            {
                return Ma_lien_thong_co_so_kham_chua_benh;
            }
            set
            {
                Ma_lien_thong_co_so_kham_chua_benh = value;
            }
        }
        private string Password = string.Empty;
        public string password
        {
            get
            {
                return Password;
            }
            set
            {
                Password = value;
            }
        }
    }
    [Serializable()]
    public class dangnhapcosokhamchuabenh
    {
        private string Ma_lien_thong_co_so_kham_chua_benh = string.Empty;
        public string ma_lien_thong_co_so_kham_chua_benh
        {
            get
            {
                return Ma_lien_thong_co_so_kham_chua_benh;
            }
            set
            {
                Ma_lien_thong_co_so_kham_chua_benh = value;
            }
        }
        private string Password = string.Empty;
        public string password
        {
            get
            {
                return Password;
            }
            set
            {
                Password = value;
            }
        }
    }
    //object lay token tra ve
    [Serializable()]
    public class dangnhapbacsi_return_data
    {
        private string Token = string.Empty;
        public string token
        {
            get
            {
                return Token;
            }
            set
            {
                Token = value;
            }
        }
        private string Token_type = string.Empty;
        public string token_type
        {
            get
            {
                return Token_type;
            }
            set
            {
                Token_type = value;
            }
        }
    }
    //object phan Tạo đơn thuốc từ cơ sở khám chữa bệnh
    [Serializable()]
    public class donthuoc
    {
        private string Loai_don_thuoc = string.Empty;
        public string loai_don_thuoc
        {
            get
            {
                return Loai_don_thuoc;
            }
            set
            {
                Loai_don_thuoc = value;
            }
        }
        private string Ma_don_thuoc = string.Empty;
        public string ma_don_thuoc
        {
            get
            {
                return Ma_don_thuoc;
            }
            set
            {
                Ma_don_thuoc = value;
            }
        }
        private string Ho_ten_benh_nhan = string.Empty;
        public string ho_ten_benh_nhan
        {
            get
            {
                return Ho_ten_benh_nhan;
            }
            set
            {
                Ho_ten_benh_nhan = value;
            }
        }
        private string Ma_dinh_danh_y_te = string.Empty;
        public string ma_dinh_danh_y_te
        {
            get
            {
                return Ma_dinh_danh_y_te;
            }
            set
            {
                Ma_dinh_danh_y_te = value;
            }
        }
        private string Ma_dinh_danh_cong_dan = string.Empty;
        public string ma_dinh_danh_cong_dan
        {
            get
            {
                return Ma_dinh_danh_cong_dan;
            }
            set
            {
                Ma_dinh_danh_cong_dan = value;
            }
        }
        private string Ngay_sinh_benh_nhan = string.Empty;
        public string ngay_sinh_benh_nhan
        {
            get
            {
                return Ngay_sinh_benh_nhan;
            }
            set
            {
                Ngay_sinh_benh_nhan = value;
            }
        }
        private decimal Can_nang = 0;
        public decimal can_nang
        {
            get
            {
                return Can_nang;
            }
            set
            {
                Can_nang = value;
            }
        }
        private string Gioi_tinh = string.Empty;
        public string gioi_tinh
        {
            get
            {
                return Gioi_tinh;
            }
            set
            {
                Gioi_tinh = value;
            }
        }
        private string Ma_so_the_bao_hiem_y_te = string.Empty;
        public string ma_so_the_bao_hiem_y_te
        {
            get
            {
                return Ma_so_the_bao_hiem_y_te;
            }
            set
            {
                Ma_so_the_bao_hiem_y_te = value;
            }
        }
        private string Thong_tin_nguoi_giam_ho = string.Empty;
        public string thong_tin_nguoi_giam_ho
        {
            get
            {
                return Thong_tin_nguoi_giam_ho;
            }
            set
            {
                Thong_tin_nguoi_giam_ho = value;
            }
        }
        private string Dia_chi = string.Empty;
        public string dia_chi
        {
            get
            {
                return Dia_chi;
            }
            set
            {
                Dia_chi = value;
            }
        }
        private List<chandoan> Chan_doan;
        public List<chandoan> chan_doan
        {
            get
            {
                if (Chan_doan == null)
                    Chan_doan = new List<chandoan>();
                return Chan_doan;
            }
            set
            {
                Chan_doan = value;
            }
        }
        private string Luu_y = string.Empty;
        public string luu_y
        {
            get
            {
                return Luu_y;
            }
            set
            {
                Luu_y = value;
            }
        }
        private string Hinh_thuc_dieu_tri = string.Empty;
        public string hinh_thuc_dieu_tri
        {
            get
            {
                return Hinh_thuc_dieu_tri;
            }
            set
            {
                Hinh_thuc_dieu_tri = value;
            }
        }
        private List<dot_dung_thuoc> Dot_dung_thuoc;
        public List<dot_dung_thuoc> dot_dung_thuoc
        {
            get
            {
                if (Dot_dung_thuoc == null)
                    Dot_dung_thuoc = new List<dot_dung_thuoc>();
                return Dot_dung_thuoc;
            }
            set
            {
                Dot_dung_thuoc = value;
            }
        }
        private List<thongtindonthuoc> Thong_tin_don_thuoc;
        public List<thongtindonthuoc> thong_tin_don_thuoc
        {
            get
            {
                if (Thong_tin_don_thuoc == null)
                    Thong_tin_don_thuoc = new List<thongtindonthuoc>();
                return Thong_tin_don_thuoc;
            }
            set
            {
                Thong_tin_don_thuoc = value;
            }
        }
        private string Loi_dan = string.Empty;
        public string loi_dan
        {
            get
            {
                return Loi_dan;
            }
            set
            {
                Loi_dan = value;
            }
        }
        private string So_dien_thoai_nguoi_kham_benh = string.Empty;
        public string so_dien_thoai_nguoi_kham_benh
        {
            get
            {
                return So_dien_thoai_nguoi_kham_benh;
            }
            set
            {
                So_dien_thoai_nguoi_kham_benh = value;
            }
        }
        private int Ngay_tai_kham;
        public int ngay_tai_kham
        {
            get
            {
                return Ngay_tai_kham;
            }
            set
            {
                Ngay_tai_kham = value;
            }
        }
        private string Ngay_gio_ke_don = string.Empty;
        public string ngay_gio_ke_don
        {
            get
            {
                return Ngay_gio_ke_don;
            }
            set
            {
                Ngay_gio_ke_don = value;
            }
        }
        private string Signature = string.Empty;
        public string signature
        {
            get
            {
                return Signature;
            }
            set
            {
                Signature = value;
            }
        }
    }
    [Serializable()]
    public class dot_dung_thuoc
    {
        private int Dot = 0;
        public int dot
        {
            get
            {
                return Dot;
            }
            set
            {
                Dot = value;
            }
        }
        private string Tu_ngay = string.Empty;
        public string tu_ngay
        {
            get
            {
                return Tu_ngay;
            }
            set
            {
                Tu_ngay = value;
            }
        }
        private string Den_ngay = string.Empty;
        public string den_ngay
        {
            get
            {
                return Den_ngay;
            }
            set
            {
                Den_ngay = value;
            }
        }
        private int So_thang_thuoc = 0;
        public int so_thang_thuoc
        {
            get
            {
                return So_thang_thuoc;
            }
            set
            {
                So_thang_thuoc = value;
            }
        }
    }
    [Serializable()]
    public class thong_tin_don_thuoc
    {
        private string Biet_duoc = string.Empty;
        public string biet_duoc
        {
            get
            {
                return Biet_duoc;
            }
            set
            {
                Biet_duoc = value;
            }
        }
        private string Ten_thuoc = string.Empty;
        public string ten_thuoc
        {
            get
            {
                return Ten_thuoc;
            }
            set
            {
                Ten_thuoc = value;
            }
        }
        private string Don_vi_tinh = string.Empty;
        public string don_vi_tinh
        {
            get
            {
                return Don_vi_tinh;
            }
            set
            {
                Don_vi_tinh = value;
            }
        }
        private decimal So_luong = 0;
        public decimal so_luong
        {
            get
            {
                return So_luong;
            }
            set
            {
                So_luong = value;
            }
        }
        private string Cach_dung = string.Empty;
        public string cach_dung
        {
            get
            {
                return Cach_dung;
            }
            set
            {
                Cach_dung = value;
            }
        }
    }
    [Serializable()]

    public class dangkybacsi
    {
        private string Ho_ten = string.Empty;
        public string ho_ten
        {
            get
            {
                return Ho_ten;
            }
            set
            {
                Ho_ten = value;
            }
        }
        private string Ngay_sinh = string.Empty;
        public string ngay_sinh
        {
            get
            {
                return Ngay_sinh;
            }
            set
            {
                Ngay_sinh = value;
            }
        }
        private string So_chung_chi_hanh_nghe = string.Empty;
        public string so_chung_chi_hanh_nghe
        {
            get
            {
                return So_chung_chi_hanh_nghe;
            }
            set
            {
                So_chung_chi_hanh_nghe = value;
            }
        }
        private string Ngay_cap_chung_chi_hanh_nghe = string.Empty;
        public string ngay_cap_chung_chi_hanh_nghe
        {
            get
            {
                return Ngay_cap_chung_chi_hanh_nghe;
            }
            set
            {
                Ngay_cap_chung_chi_hanh_nghe = value;
            }
        }
        private string Noi_cap_chung_chi_hanh_nghe = string.Empty;
        public string noi_cap_chung_chi_hanh_nghe
        {
            get
            {
                return Noi_cap_chung_chi_hanh_nghe;
            }
            set
            {
                Noi_cap_chung_chi_hanh_nghe = value;
            }
        }
        private string So_chung_minh_thu = string.Empty;
        public string so_chung_minh_thu
        {
            get
            {
                return So_chung_minh_thu;
            }
            set
            {
                So_chung_minh_thu = value;
            }
        }
        private string Ngay_cap_chung_minh_thu = string.Empty;
        public string ngay_cap_chung_minh_thu
        {
            get
            {
                return Ngay_cap_chung_minh_thu;
            }
            set
            {
                Ngay_cap_chung_minh_thu = value;
            }
        }
        private string Noi_cap_chung_minh_thu = string.Empty;
        public string noi_cap_chung_minh_thu
        {
            get
            {
                return Noi_cap_chung_minh_thu;
            }
            set
            {
                Noi_cap_chung_minh_thu = value;
            }
        }
        private string Dia_chi_thanh_pho = string.Empty;
        public string dia_chi_thanh_pho
        {
            get
            {
                return Dia_chi_thanh_pho;
            }
            set
            {
                Dia_chi_thanh_pho = value;
            }
        }
        private string Dia_chi_quan_huyen = string.Empty;
        public string dia_chi_quan_huyen
        {
            get
            {
                return Dia_chi_quan_huyen;
            }
            set
            {
                Dia_chi_quan_huyen = value;
            }
        }
        private string Dia_chi_phuong_xa = string.Empty;
        public string dia_chi_phuong_xa
        {
            get
            {
                return Dia_chi_phuong_xa;
            }
            set
            {
                Dia_chi_phuong_xa = value;
            }
        }
        private string Dia_chi_chi_tiet = string.Empty;
        public string dia_chi_chi_tiet
        {
            get
            {
                return Dia_chi_chi_tiet;
            }
            set
            {
                Dia_chi_chi_tiet = value;
            }
        }
        private string Email = string.Empty;
        public string email
        {
            get
            {
                return Email;
            }
            set
            {
                Email = value;
            }
        }
        private string Dien_thoai = string.Empty;
        public string dien_thoai
        {
            get
            {
                return Dien_thoai;
            }
            set
            {
                Dien_thoai = value;
            }
        }
        private string Van_bang_chuyen_mon = string.Empty;
        public string van_bang_chuyen_mon
        {
            get
            {
                return Van_bang_chuyen_mon;
            }
            set
            {
                Van_bang_chuyen_mon = value;
            }
        }
        private List<thoi_gian_lam_viec> Thoi_gian_lam_viec;
        public List<thoi_gian_lam_viec> thoi_gian_lam_viec
        {
            get
            {
                if (Thoi_gian_lam_viec == null)
                    Thoi_gian_lam_viec = new List<thoi_gian_lam_viec>();
                return Thoi_gian_lam_viec;
            }
            set
            {
                Thoi_gian_lam_viec = value;
            }
        }
        private List<string> File_giay_chung_nhan_hanh_nghe;
        public List<string> file_giay_chung_nhan_hanh_nghe
        {
            get
            {
                if (File_giay_chung_nhan_hanh_nghe == null)
                    File_giay_chung_nhan_hanh_nghe = new List<string>();
                return File_giay_chung_nhan_hanh_nghe;
            }
            set
            {
                File_giay_chung_nhan_hanh_nghe = value;
            }
        }
        private string File_anh_dai_dien = string.Empty;
        public string file_anh_dai_dien
        {
            get
            {
                return File_anh_dai_dien;
            }
            set
            {
                File_anh_dai_dien = value;
            }
        }
        private List<string> Linh_vuc;
        public List<string> linh_vuc
        {
            get
            {
                if (Linh_vuc == null)
                    Linh_vuc = new List<string>();
                return Linh_vuc;
            }
            set
            {
                Linh_vuc = value;
            }
        }
        private string Don_vi_khai_bao = string.Empty;
        public string don_vi_khai_bao
        {
            get
            {
                return Don_vi_khai_bao;
            }
            set
            {
                Don_vi_khai_bao = value;
            }
        }
    }
    [Serializable()]
    public class thoi_gian_lam_viec
    {
        private string Ten_don_vi = string.Empty;
        public string ten_don_vi
        {
            get
            {
                return Ten_don_vi;
            }
            set
            {
                Ten_don_vi = value;
            }
        }
        private string Dia_chi_don_vi = string.Empty;
        public string dia_chi_don_vi
        {
            get
            {
                return Dia_chi_don_vi;
            }
            set
            {
                Dia_chi_don_vi = value;
            }
        }
        private string _thoi_gian_lam_viec = string.Empty;
        public string Thoi_gian_lam_viec
        {
            get
            {
                return _thoi_gian_lam_viec;
            }
            set
            {
                _thoi_gian_lam_viec = value;
            }
        }
    }
    [Serializable()]
    public class doitacmalienthongbacsi
    {
        private string So_chung_chi_hanh_nghe_bac_si = string.Empty;
        public string so_chung_chi_hanh_nghe_bac_si
        {
            get
            {
                return So_chung_chi_hanh_nghe_bac_si;
            }
            set
            {
                So_chung_chi_hanh_nghe_bac_si = value;
            }
        }
        private string Ma_lien_thong_bac_si = string.Empty;
        public string ma_lien_thong_bac_si
        {
            get
            {
                return Ma_lien_thong_bac_si;
            }
            set
            {
                Ma_lien_thong_bac_si = value;
            }
        }
    }
    [Serializable()]
    public class doitacmalienthongbacsi_return_data
    {
        private string Ma_lien_thong_bac_si = string.Empty;
        public string ma_lien_thong_bac_si
        {
            get
            {
                return Ma_lien_thong_bac_si;
            }
            set
            {
                Ma_lien_thong_bac_si = value;
            }
        }
        private string Message = string.Empty;
        public string message
        {
            get
            {
                return Message;
            }
            set
            {
                Message = value;
            }
        }
    }
    //object nhan ket qua tra ve khi thao tac voi don thuoc
    [Serializable()]
    public class dangkycosokhamchuabenh
    {
        private string So_giay_phep = string.Empty;
        public string so_giay_phep
        {
            get
            {
                return So_giay_phep;
            }
            set
            {
                So_giay_phep = value;
            }
        }
        private string Ngay_cap_giay_phep = string.Empty;
        public string ngay_cap_giay_phep
        {
            get
            {
                return Ngay_cap_giay_phep;
            }
            set
            {
                Ngay_cap_giay_phep = value;
            }
        }
        private string Noi_cap_giay_phep = string.Empty;
        public string noi_cap_giay_phep
        {
            get
            {
                return Noi_cap_giay_phep;
            }
            set
            {
                Noi_cap_giay_phep = value;
            }
        }
        private string Ten_co_so = string.Empty;
        public string ten_co_so
        {
            get
            {
                return Ten_co_so;
            }
            set
            {
                Ten_co_so = value;
            }
        }
        private string Ten_nguoi_dai_dien = string.Empty;
        public string ten_nguoi_dai_dien
        {
            get
            {
                return Ten_nguoi_dai_dien;
            }
            set
            {
                Ten_nguoi_dai_dien = value;
            }
        }
        private string So_chung_chi_hanh_nghe = string.Empty;
        public string so_chung_chi_hanh_nghe
        {
            get
            {
                return So_chung_chi_hanh_nghe;
            }
            set
            {
                So_chung_chi_hanh_nghe = value;
            }
        }
        private string Noi_cap_chung_chi_hanh_nghe = string.Empty;
        public string noi_cap_chung_chi_hanh_nghe
        {
            get
            {
                return Noi_cap_chung_chi_hanh_nghe;
            }
            set
            {
                Noi_cap_chung_chi_hanh_nghe = value;
            }
        }
        private string Dia_chi_hanh_nghe_thanh_pho = string.Empty;
        public string dia_chi_hanh_nghe_thanh_pho
        {
            get
            {
                return Dia_chi_hanh_nghe_thanh_pho;
            }
            set
            {
                Dia_chi_hanh_nghe_thanh_pho = value;
            }
        }
        private string Dia_chi_hanh_nghe_quan_huyen = string.Empty;
        public string dia_chi_hanh_nghe_quan_huyen
        {
            get
            {
                return Dia_chi_hanh_nghe_quan_huyen;
            }
            set
            {
                Dia_chi_hanh_nghe_quan_huyen = value;
            }
        }
        private string Dia_chi_hanh_nghe_phuong_xa = string.Empty;
        public string dia_chi_hanh_nghe_phuong_xa
        {
            get
            {
                return Dia_chi_hanh_nghe_phuong_xa;
            }
            set
            {
                Dia_chi_hanh_nghe_phuong_xa = value;
            }
        }
        private string Dia_chi_hanh_nghe_chi_tiet = string.Empty;
        public string dia_chi_hanh_nghe_chi_tiet
        {
            get
            {
                return Dia_chi_hanh_nghe_chi_tiet;
            }
            set
            {
                Dia_chi_hanh_nghe_chi_tiet = value;
            }
        }
        private string Email = string.Empty;
        public string email
        {
            get
            {
                return Email;
            }
            set
            {
                Email = value;
            }
        }
        private string Dien_thoai = string.Empty;
        public string dien_thoai
        {
            get
            {
                return Dien_thoai;
            }
            set
            {
                Dien_thoai = value;
            }
        }
        private List<thoi_gian_hoat_dong> Thoi_gian_hoat_dong;
        public List<thoi_gian_hoat_dong> thoi_gian_hoat_dong
        {
            get
            {
                if (Thoi_gian_hoat_dong == null)
                    Thoi_gian_hoat_dong = new List<thoi_gian_hoat_dong>();
                return Thoi_gian_hoat_dong;
            }
            set
            {
                Thoi_gian_hoat_dong = value;
            }
        }
        private List<string> Pham_vi_hoat_dong_chuyen_mon;
        public List<string> pham_vi_hoat_dong_chuyen_mon
        {
            get
            {
                if (Pham_vi_hoat_dong_chuyen_mon == null)
                    Pham_vi_hoat_dong_chuyen_mon = new List<string>();
                return Pham_vi_hoat_dong_chuyen_mon;
            }
            set
            {
                Pham_vi_hoat_dong_chuyen_mon = value;
            }
        }
        private string Hinh_thuc_to_chuc = string.Empty;
        public string hinh_thuc_to_chuc
        {
            get
            {
                return Hinh_thuc_to_chuc;
            }
            set
            {
                Hinh_thuc_to_chuc = value;
            }
        }
        private string File_giay_phep = string.Empty;
        public string file_giay_phep
        {
            get
            {
                return File_giay_phep;
            }
            set
            {
                File_giay_phep = value;
            }
        }
        private string File_danh_muc_ky_thuat = string.Empty;
        public string file_danh_muc_ky_thuat
        {
            get
            {
                return File_danh_muc_ky_thuat;
            }
            set
            {
                File_danh_muc_ky_thuat = value;
            }
        }
        private string File_nhan_su_dang_ky = string.Empty;
        public string file_nhan_su_dang_ky
        {
            get
            {
                return File_nhan_su_dang_ky;
            }
            set
            {
                File_nhan_su_dang_ky = value;
            }
        }
        private string File_trang_thiet_bi_dang_ky = string.Empty;
        public string file_trang_thiet_bi_dang_ky
        {
            get
            {
                return File_trang_thiet_bi_dang_ky;
            }
            set
            {
                File_trang_thiet_bi_dang_ky = value;
            }
        }
        private string Mo_hinh_to_chuc = string.Empty;
        public string mo_hinh_to_chuc
        {
            get
            {
                return Mo_hinh_to_chuc;
            }
            set
            {
                Mo_hinh_to_chuc = value;
            }
        }
        private string Tuyen_ky_thuat = string.Empty;
        public string tuyen_ky_thuat
        {
            get
            {
                return Tuyen_ky_thuat;
            }
            set
            {
                Tuyen_ky_thuat = value;
            }
        }
        private string Loai_hinh_quan_ly = string.Empty;
        public string loai_hinh_quan_ly
        {
            get
            {
                return Loai_hinh_quan_ly;
            }
            set
            {
                Loai_hinh_quan_ly = value;
            }
        }
    }
    [Serializable()]
    public class thoi_gian_hoat_dong
    {
        private string Loai_thoi_gian_hoat_dong = string.Empty;
        public string loai_thoi_gian_hoat_dong
        {
            get
            {
                return Loai_thoi_gian_hoat_dong;
            }
            set
            {
                Loai_thoi_gian_hoat_dong = value;
            }
        }
        private string ma_hoa_don = string.Empty;
        public string Ma_hoa_don
        {
            get
            {
                return ma_hoa_don;
            }
            set
            {
                ma_hoa_don = value;
            }
        }
        private List<tuy_chon> Tuy_chon;
        public List<tuy_chon> tuy_chon
        {
            get
            {
                if (Tuy_chon == null)
                    Tuy_chon = new List<tuy_chon>();
                return Tuy_chon;
            }
            set
            {
                Tuy_chon = value;
            }
        }
    }
    [Serializable()]
    public class tuy_chon
    {
        private string Type = string.Empty;
        public string type
        {
            get
            {
                return Type;
            }
            set
            {
                Type = value;
            }
        }
        private string Gio_tu = string.Empty;
        public string gio_tu
        {
            get
            {
                return Gio_tu;
            }
            set
            {
                Gio_tu = value;
            }
        }
        private string Gio_den = string.Empty;
        public string gio_den
        {
            get
            {
                return Gio_den;
            }
            set
            {
                Gio_den = value;
            }
        }
    }
    [Serializable()]
    public class doitacmalienthongcosokhamchuabenh
    {
        private string Ma_bao_hiem_co_so_kham_chua_benh = string.Empty;
        public string ma_bao_hiem_co_so_kham_chua_benh
        {
            get
            {
                return Ma_bao_hiem_co_so_kham_chua_benh;
            }
            set
            {
                Ma_bao_hiem_co_so_kham_chua_benh = value;
            }
        }
        private string Ma_lien_thong_co_so_kham_chua_benh = string.Empty;
        public string ma_lien_thong_co_so_kham_chua_benh
        {
            get
            {
                return Ma_lien_thong_co_so_kham_chua_benh;
            }
            set
            {
                Ma_lien_thong_co_so_kham_chua_benh = value;
            }
        }
    }
    [Serializable()]
    public class doitacmalienthongcosokhamchuabenh_return_data
    {
        private string Ma_lien_thong_co_so_kham_chua_benh = string.Empty;
        public string ma_lien_thong_co_so_kham_chua_benh
        {
            get
            {
                return Ma_lien_thong_co_so_kham_chua_benh;
            }
            set
            {
                Ma_lien_thong_co_so_kham_chua_benh = value;
            }
        }
        private string Message = string.Empty;
        public string message
        {
            get
            {
                return Message;
            }
            set
            {
                Message = value;
            }
        }
    }
    [Serializable()]
    public class chandoan
    {
        private string Ma_chan_doan = string.Empty;
        public string ma_chan_doan
        {
            get
            {
                return Ma_chan_doan;
            }
            set
            {
                Ma_chan_doan = value;
            }
        }
        private string Ten_chan_doan = string.Empty;
        public string ten_chan_doan
        {
            get
            {
                return Ten_chan_doan;
            }
            set
            {
                Ten_chan_doan = value;
            }
        }
        private string Ket_luan = string.Empty;
        public string ket_luan
        {
            get
            {
                return Ket_luan;
            }
            set
            {
                Ket_luan = value;
            }
        }
    }
    [Serializable()]
    public class thongtindonthuoc
    {
        private string Ma_thuoc = string.Empty;
        public string ma_thuoc
        {
            get
            {
                return Ma_thuoc;
            }
            set
            {
                Ma_thuoc = value;
            }
        }
        private string Biet_duoc = string.Empty;
        public string biet_duoc
        {
            get
            {
                return Biet_duoc;
            }
            set
            {
                Biet_duoc = value;
            }
        }
        private string Ten_thuoc = string.Empty;
        public string ten_thuoc
        {
            get
            {
                return Ten_thuoc;
            }
            set
            {
                Ten_thuoc = value;
            }
        }
        private string Don_vi_tinh = string.Empty;
        public string don_vi_tinh
        {
            get
            {
                return Don_vi_tinh;
            }
            set
            {
                Don_vi_tinh = value;
            }
        }
        private decimal So_luong = 0;
        public decimal so_luong
        {
            get
            {
                return So_luong;
            }
            set
            {
                So_luong = value;
            }
        }
        private string Cach_dung = string.Empty;
        public string cach_dung
        {
            get
            {
                return Cach_dung;
            }
            set
            {
                Cach_dung = value;
            }
        }
    }
    [Serializable()]
    public class donthuocget
    {
        private string Ma_don_thuoc = string.Empty;
        public string ma_don_thuoc
        {
            get
            {
                return Ma_don_thuoc;
            }
            set
            {
                Ma_don_thuoc = value;
            }
        }
        private string Ho_ten_benh_nhan = string.Empty;
        public string ho_ten_benh_nhan
        {
            get
            {
                return Ho_ten_benh_nhan;
            }
            set
            {
                Ho_ten_benh_nhan = value;
            }
        }
        private string Ngay_sinh_benh_nhan = string.Empty;
        public string ngay_sinh_benh_nhan
        {
            get
            {
                return Ngay_sinh_benh_nhan;
            }
            set
            {
                Ngay_sinh_benh_nhan = value;
            }
        }
        private string Ma_dinh_danh_y_te = string.Empty;
        public string ma_dinh_danh_y_te
        {
            get
            {
                return Ma_dinh_danh_y_te;
            }
            set
            {
                Ma_dinh_danh_y_te = value;
            }
        }
        private string Loai_don_thuoc = string.Empty;
        public string loai_don_thuoc
        {
            get
            {
                return Loai_don_thuoc;
            }
            set
            {
                Loai_don_thuoc = value;
            }
        }
        private string Hinh_thuc_dieu_tri = string.Empty;
        public string hinh_thuc_dieu_tri
        {
            get
            {
                return Hinh_thuc_dieu_tri;
            }
            set
            {
                Hinh_thuc_dieu_tri = value;
            }
        }
        private string Dia_chi = string.Empty;
        public string dia_chi
        {
            get
            {
                return Dia_chi;
            }
            set
            {
                Dia_chi = value;
            }
        }
        private string Gioi_tinh = string.Empty;
        public string gioi_tinh
        {
            get
            {
                return Gioi_tinh;
            }
            set
            {
                Gioi_tinh = value;
            }
        }
        private decimal Can_nang = 0;
        public decimal can_nang
        {
            get
            {
                return Can_nang;
            }
            set
            {
                Can_nang = value;
            }
        }
        private string Ma_so_the_bao_hiem_y_te = string.Empty;
        public string ma_so_the_bao_hiem_y_te
        {
            get
            {
                return Ma_so_the_bao_hiem_y_te;
            }
            set
            {
                Ma_so_the_bao_hiem_y_te = value;
            }
        }
        private List<thongtindonthuoc> Thong_tin_don_thuoc;
        public List<thongtindonthuoc> thong_tin_don_thuoc
        {
            get
            {
                if (Thong_tin_don_thuoc == null)
                    Thong_tin_don_thuoc = new List<thongtindonthuoc>();
                return Thong_tin_don_thuoc;
            }
            set
            {
                Thong_tin_don_thuoc = value;
            }
        }
        private List<dot_dung_thuoc> Dot_dung_thuoc;
        public List<dot_dung_thuoc> dot_dung_thuoc
        {
            get
            {
                if (Dot_dung_thuoc == null)
                    Dot_dung_thuoc = new List<dot_dung_thuoc>();
                return Dot_dung_thuoc;
            }
            set
            {
                Dot_dung_thuoc = value;
            }
        }
        private List<chandoan> Chan_doan;
        public List<chandoan> chan_doan
        {
            get
            {
                if (Chan_doan == null)
                    Chan_doan = new List<chandoan>();
                return Chan_doan;
            }
            set
            {
                Chan_doan = value;
            }
        }
        private string Luu_y = string.Empty;
        public string luu_y
        {
            get
            {
                return Luu_y;
            }
            set
            {
                Luu_y = value;
            }
        }
        private string Loi_dan = string.Empty;
        public string loi_dan
        {
            get
            {
                return Loi_dan;
            }
            set
            {
                Loi_dan = value;
            }
        }
        private string Ten_bac_si = string.Empty;
        public string ten_bac_si
        {
            get
            {
                return Ten_bac_si;
            }
            set
            {
                Ten_bac_si = value;
            }
        }
        private string Ten_co_so_kham_chua_benh = string.Empty;
        public string ten_co_so_kham_chua_benh
        {
            get
            {
                return Ten_co_so_kham_chua_benh;
            }
            set
            {
                Ten_co_so_kham_chua_benh = value;
            }
        }
        private string So_dien_thoai_co_so_kham_chua_benh = string.Empty;
        public string so_dien_thoai_co_so_kham_chua_benh
        {
            get
            {
                return So_dien_thoai_co_so_kham_chua_benh;
            }
            set
            {
                So_dien_thoai_co_so_kham_chua_benh = value;
            }
        }
        private string Ngay_gio_ke_don = string.Empty;
        public string ngay_gio_ke_don
        {
            get
            {
                return Ngay_gio_ke_don;
            }
            set
            {
                Ngay_gio_ke_don = value;
            }
        }
    }
    [Serializable()]
    public class donthuocUpdate
    {
        private string Ma_don_thuoc = string.Empty;
        public string ma_don_thuoc
        {
            get
            {
                return Ma_don_thuoc;
            }
            set
            {
                Ma_don_thuoc = value;
            }
        }
        private List<thongtinthuoc> Thong_tin_thuoc;
        public List<thongtinthuoc> thong_tin_thuoc
        {
            get
            {
                if (Thong_tin_thuoc == null)
                    Thong_tin_thuoc = new List<thongtinthuoc>();
                return Thong_tin_thuoc;
            }
            set
            {
                Thong_tin_thuoc = value;
            }
        }
        private string Ma_dinh_danh_co_so_cung_ung_thuoc = string.Empty;
        public string ma_dinh_danh_co_so_cung_ung_thuoc
        {
            get
            {
                return Ma_dinh_danh_co_so_cung_ung_thuoc;
            }
            set
            {
                Ma_dinh_danh_co_so_cung_ung_thuoc = value;
            }
        }
        private string Ten_co_so_cung_ung_thuoc = string.Empty;
        public string ten_co_so_cung_ung_thuoc
        {
            get
            {
                return Ten_co_so_cung_ung_thuoc;
            }
            set
            {
                Ten_co_so_cung_ung_thuoc = value;
            }
        }
        private string So_dien_thoai_co_so_cung_ung_thuoc = string.Empty;
        public string so_dien_thoai_co_so_cung_ung_thuoc
        {
            get
            {
                return So_dien_thoai_co_so_cung_ung_thuoc;
            }
            set
            {
                So_dien_thoai_co_so_cung_ung_thuoc = value;
            }
        }
        private string Dia_chi_co_so_cung_ung_thuoc = string.Empty;
        public string dia_chi_co_so_cung_ung_thuoc
        {
            get
            {
                return Dia_chi_co_so_cung_ung_thuoc;
            }
            set
            {
                Dia_chi_co_so_cung_ung_thuoc = value;
            }
        }
        private string Ma_hoa_don = string.Empty;
        public string ma_hoa_don
        {
            get
            {
                return Ma_hoa_don;
            }
            set
            {
                Ma_hoa_don = value;
            }
        }
    }
    [Serializable()]
    public class thongtinthuoc
    {
        private string Ma_thuoc_da_ke_don = string.Empty;
        public string ma_thuoc_da_ke_don
        {
            get
            {
                return Ma_thuoc_da_ke_don;
            }
            set
            {
                Ma_thuoc_da_ke_don = value;
            }
        }
        private string Ma_thuoc = string.Empty;
        public string ma_thuoc
        {
            get
            {
                return Ma_thuoc;
            }
            set
            {
                Ma_thuoc = value;
            }
        }
        private string Biet_duoc = string.Empty;
        public string biet_duoc
        {
            get
            {
                return Biet_duoc;
            }
            set
            {
                Biet_duoc = value;
            }
        }
        private string Ten_thuoc = string.Empty;
        public string ten_thuoc
        {
            get
            {
                return Ten_thuoc;
            }
            set
            {
                Ten_thuoc = value;
            }
        }
        private string Don_vi_tinh = string.Empty;
        public string don_vi_tinh
        {
            get
            {
                return Don_vi_tinh;
            }
            set
            {
                Don_vi_tinh = value;
            }
        }
        private int So_luong = 0;
        public int so_luong
        {
            get
            {
                return So_luong;
            }
            set
            {
                So_luong = value;
            }
        }
        private string Cach_dung = string.Empty;
        public string cach_dung
        {
            get
            {
                return Cach_dung;
            }
            set
            {
                Cach_dung = value;
            }
        }
    }
    #endregion
    // ham dung de trao doi du lieu voi API RESTfull
    public class DTDTAPI
    {
        public string PostURL(string url, string username, string password, string jsondata)
        {
            Uri myUri = new Uri(url);
            WebRequest myWebRequest = HttpWebRequest.Create(myUri);
            myWebRequest.ContentType = "application/json";
            myWebRequest.Method = "POST";
            HttpWebRequest myHttpWebRequest = (HttpWebRequest)myWebRequest;
            NetworkCredential myNetworkCredential = new NetworkCredential(username, password);
            CredentialCache myCredentialCache = new CredentialCache();
            myCredentialCache.Add(myUri, "Basic", myNetworkCredential);
            myHttpWebRequest.PreAuthenticate = true;
            myHttpWebRequest.Credentials = myCredentialCache;
            using (var streamWriter = new StreamWriter(myWebRequest.GetRequestStream()))
            {
                streamWriter.Write(jsondata);
                streamWriter.Flush();
                streamWriter.Close();
            }
            WebResponse myWebResponse = myWebRequest.GetResponse();
            Stream responseStream = myWebResponse.GetResponseStream();
            StreamReader myStreamReader = new StreamReader(responseStream, Encoding.Default);
            string pageContent = myStreamReader.ReadToEnd();
            responseStream.Close();
            myWebResponse.Close();
            return pageContent;
        }
        public string PutURLtoken(string url, string token, string jsondata)
        {
            Uri myUri = new Uri(url);
            WebRequest myWebRequest = HttpWebRequest.Create(myUri);
            myWebRequest.ContentType = "application/json";
            myWebRequest.Method = "PUT";
            HttpWebRequest myHttpWebRequest = (HttpWebRequest)myWebRequest;
            myHttpWebRequest.PreAuthenticate = true;
            myHttpWebRequest.Headers.Add("Authorization", "Bearer " + token);
            using (var streamWriter = new StreamWriter(myWebRequest.GetRequestStream()))
            {
                streamWriter.Write(jsondata);
                streamWriter.Flush();
                streamWriter.Close();
            }
            WebResponse myWebResponse = myWebRequest.GetResponse();
            Stream responseStream = myWebResponse.GetResponseStream();
            StreamReader myStreamReader = new StreamReader(responseStream, Encoding.Default);
            string pageContent = myStreamReader.ReadToEnd();
            responseStream.Close();
            myWebResponse.Close();
            return pageContent;
        }
        public string PostURLtoken(string url, string token, string jsondata)
        {
            Uri myUri = new Uri(url);
            WebRequest myWebRequest = HttpWebRequest.Create(myUri);
            myWebRequest.ContentType = "application/json";
            myWebRequest.Method = "POST";
            HttpWebRequest myHttpWebRequest = (HttpWebRequest)myWebRequest;
            myHttpWebRequest.PreAuthenticate = true;
            myHttpWebRequest.Headers.Add("Authorization", "Bearer " + token);
            using (var streamWriter = new StreamWriter(myWebRequest.GetRequestStream()))
            {
                streamWriter.Write(jsondata);
                streamWriter.Flush();
                streamWriter.Close();
            }
            WebResponse myWebResponse = myWebRequest.GetResponse();
            Stream responseStream = myWebResponse.GetResponseStream();
            StreamReader myStreamReader = new StreamReader(responseStream, Encoding.Default);
            string pageContent = myStreamReader.ReadToEnd();
            responseStream.Close();
            myWebResponse.Close();
            return pageContent;
        }
        public string DeleteURLtoken(string url, string token)
        {
            Uri myUri = new Uri(url);
            WebRequest myWebRequest = HttpWebRequest.Create(myUri);
            myWebRequest.ContentType = "application/json";
            myWebRequest.Method = "DELETE";
            HttpWebRequest myHttpWebRequest = (HttpWebRequest)myWebRequest;
            myHttpWebRequest.PreAuthenticate = true;
            myHttpWebRequest.Headers.Add("Authorization", "Bearer " + token);
            using (var streamWriter = new StreamWriter(myWebRequest.GetRequestStream()))
            {
                streamWriter.Flush();
                streamWriter.Close();
            }
            WebResponse myWebResponse = myWebRequest.GetResponse();
            Stream responseStream = myWebResponse.GetResponseStream();
            StreamReader myStreamReader = new StreamReader(responseStream, Encoding.Default);
            string pageContent = myStreamReader.ReadToEnd();
            responseStream.Close();
            myWebResponse.Close();
            return pageContent;
        }
        public string PostURLNoAuth(string url, string jsondata)
        {
            Uri myUri = new Uri(url);
            WebRequest myWebRequest = HttpWebRequest.Create(myUri);
            myWebRequest.ContentType = "application/json";
            myWebRequest.Method = "POST";
            HttpWebRequest myHttpWebRequest = (HttpWebRequest)myWebRequest;
            myHttpWebRequest.PreAuthenticate = true;
            //myHttpWebRequest.Headers.Add("Authorization", "Bearer " + token);
            using (var streamWriter = new StreamWriter(myWebRequest.GetRequestStream()))
            {
                streamWriter.Write(jsondata);
                streamWriter.Flush();
                streamWriter.Close();
            }
            WebResponse myWebResponse = myWebRequest.GetResponse();
            Stream responseStream = myWebResponse.GetResponseStream();
            StreamReader myStreamReader = new StreamReader(responseStream, Encoding.Default);
            string pageContent = myStreamReader.ReadToEnd();
            responseStream.Close();
            myWebResponse.Close();
            return pageContent;
        }
        #region RESTfulAPI
        //ham giai ma chuoi UTF-8
        public string DecodeFromUtf8(string utf8String)
        {
            return Regex.Replace(
              utf8String,
              @"\\u(?<Value>[a-fA-F0-9]{4})",
              m =>
              {
                  return ((char)int.Parse(m.Groups["Value"].Value, NumberStyles.HexNumber)).ToString();
              });
        }
        //ham dang nhap co so kham chua benh de lay to_ken them bac si
        public string dangnhapCoSoKCB(string port, string user, string pass)
        {
            string url = port + "/auth/dang-nhap-co-so-kham-chua-benh";
            dangnhapcosokhamchuabenh dn = new dangnhapcosokhamchuabenh();
            //RESTful rf = new RESTful();
            dn.ma_lien_thong_co_so_kham_chua_benh = user;
            dn.password = pass;
            var serializer = new JavaScriptSerializer();
            string serializedResult = serializer.Serialize(dn);
            string returndata = PostURLNoAuth(url, serializedResult);
            var data = serializer.Deserialize<dangnhapbacsi_return_data>(returndata);
            if (data != null && data.token_type == "bearer" && !string.IsNullOrEmpty(data.token))
                return data.token;
            else return "";
            //return serializedResult;
            //return returndata;
        }
        //ham dang nhap bac si de lay to_ken day don   
        //ktra trong bang SAVETokenAPI xem da có token mà thời gian lấy token < thời gian hiện tại 7 phút thì lấy, neu khong thi goi API de lay token moi va luu token lay duoc vao bang HSSKTokenAPI
        //Loai=SAVETokenUpdate


        public string dangnhapBS(string port, string user, string pass, string macskcb)
        {
            string loai = "SAVETokenUpdate";
            DataTable dr = new DataTable();
            string tenStore = "spSAVETokenAPI_Get";
            string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
            using (SqlConnection Conection = new SqlConnection(StrConection))
            {
                Conection.Open();
                using (SqlCommand Command = new SqlCommand(tenStore, Conection))
                {
                    Command.CommandType = CommandType.StoredProcedure;
                    Command.Parameters.Add(new SqlParameter("@Loai", loai));
                    SqlDataAdapter dp = new SqlDataAdapter(Command);
                    dp.Fill(dr);
                }
                if (dr.Rows.Count > 0)
                    return dr.Rows[0][0].ToString();
                else
                {
                    string url = port + "/auth/dang-nhap-bac-si";
                    dangnhapbacsi dn = new dangnhapbacsi();
                    dn.ma_lien_thong_bac_si = user;
                    dn.ma_lien_thong_co_so_kham_chua_benh = macskcb;
                    dn.password = pass;
                    var serializer = new JavaScriptSerializer();
                    string serializedResult = serializer.Serialize(dn);
                    string token  = PostURLNoAuth(url, serializedResult);
                    //var data = serializer.Deserialize<dangnhapbacsi_return_data>(returndata);
                    //if (data != null && data.token_type == "bearer" && !string.IsNullOrEmpty(data.token))
                    //    return data.token;
                    //else return "";
                    //WriteLog(token);
                    if (!string.IsNullOrEmpty(token) && token.Length > 0)
                        CreateToken(loai, token);
                    return token;

                }

            }
        }
        //Ham de ghi token vao bang HSSKTokenAPI
        public void CreateToken(string loai, string token)
        {
            DataTable dr = new DataTable();
            string tenStore = "spLUUTokenAPI_Token_CREATE";
            string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
            using (SqlConnection Conection = new SqlConnection(StrConection))
            {
                Conection.Open();
                using (SqlCommand Command = new SqlCommand(tenStore, Conection))
                {
                    Command.CommandType = CommandType.StoredProcedure;
                    Command.Parameters.Add(new SqlParameter("@Token", token));
                    Command.Parameters.Add(new SqlParameter("@Loai", loai));
                    SqlDataAdapter dp = new SqlDataAdapter(Command);
                    dp.Fill(dr);
                }
            }
        }
    
        //ham them ma lien thong bac si vao co so kcb
        public string themBS(string port, string user, string token)
        {
            string url = port + "/v1/them-bac-si";
            var serializer = new JavaScriptSerializer();
            string serializedResult = "{\"ma_lien_thong_bac_si\" : \"" + user + "\"}";
            string returndata = PostURLtoken(url, token, serializedResult);
            //var data = serializer.Deserialize<dangnhapbacsi_return_data>(returndata);
            //if (data != null && data.token_type == "bearer" && !string.IsNullOrEmpty(data.token))
            //    return data.token;
            //else return "";
            //return serializedResult;
            //return returndata;
            string output = DecodeFromUtf8(returndata);
            return output;
        }
        //ham gui don thuoc
        public string Gui_don_thuoc(string port, string token, donthuoc dt)
        {
            string url = port + "/v1/gui-don-thuoc";
            var serializer = new JavaScriptSerializer();
            string serializedResult = serializer.Serialize(dt);
            string returndata = PostURLtoken(url, token, serializedResult);
            //var data = serializer.Deserialize<kq_don_thuoc_return>(returndata);
            //if (data != null && data.Code == 200 && data.Ma_don_thuoc_quoc_gia != "")
            //    return data.Ma_don_thuoc_quoc_gia;
            //else return "";
            //var output = System.Net.WebUtility.HtmlDecode(returndata);
            string output = DecodeFromUtf8(returndata);
            WriteLog("output" + output);
            return output;
        }
        #endregion
    }
    #region PACS
    public class MSH
    {
        private string MSH1 = "MSH";
        public string MSH_1
        {
            get
            {
                return MSH1;
            }
            set
            {
                MSH1 = value;
            }
        }
        private string MSH2 = "^~\\&";
        public string MSH_2
        {
            get
            {
                return MSH2;
            }
            set
            {
                MSH2 = value;
            }
        }
        private string MSH3 = "HIS";
        public string MSH_3
        {
            get
            {
                return MSH3;
            }
            set
            {
                MSH3 = value;
            }
        }
        private string MSH4 = "MEDYX_QN";
        public string MSH_4
        {
            get
            {
                return MSH4;
            }
            set
            {
                MSH4 = value;
            }
        }
        private string MSH5 = "PACS";
        public string MSH_5
        {
            get
            {
                return MSH5;
            }
            set
            {
                MSH5 = value;
            }
        }
        private string MSH6 = "VRPACS";
        public string MSH_6
        {
            get
            {
                return MSH6;
            }
            set
            {
                MSH6 = value;
            }
        }
        private string MSH7 = "";
        public string MSH_7
        {
            get
            {
                return MSH7;
            }
            set
            {
                MSH7 = value;
            }
        }
        private string MSH8 = "";
        public string MSH_8
        {
            get
            {
                return MSH8;
            }
            set
            {
                MSH8 = value;
            }
        }
        private string MSH9 = "OMI^023^OMI_O23";
        public string MSH_9
        {
            get
            {
                return MSH9;
            }
            set
            {
                MSH9 = value;
            }
        }
        private string MSH91 = "OMI";
        public string MSH_91
        {
            get
            {
                return MSH91;
            }
            set
            {
                MSH91 = value;
            }
        }
        private string MSH92 = "O23";
        public string MSH_92
        {
            get
            {
                return MSH92;
            }
            set
            {
                MSH92 = value;
            }
        }
        private string MSH93 = "OMI_O23";
        public string MSH_93
        {
            get
            {
                return MSH93;
            }
            set
            {
                MSH93 = value;
            }
        }
        private string MSH10 = "";
        public string MSH_10
        {
            get
            {
                return MSH10;
            }
            set
            {
                MSH10 = value;
            }
        }
        private string MSH11 = "P";
        public string MSH_11
        {
            get
            {
                return MSH11;
            }
            set
            {
                MSH11 = value;
            }
        }
        private string MSH12 = "2.7";
        public string MSH_12
        {
            get
            {
                return MSH12;
            }
            set
            {
                MSH12 = value;
            }
        }
        private string MSH15 = "";
        public string MSH_15
        {
            get
            {
                return MSH15;
            }
            set
            {
                MSH15 = value;
            }
        }
        private string MSH16 = "";
        public string MSH_16
        {
            get
            {
                return MSH16;
            }
            set
            {
                MSH16 = value;
            }
        }
        private string MSH17 = "VNM";
        public string MSH_17
        {
            get
            {
                return MSH17;
            }
            set
            {
                MSH17 = value;
            }
        }
        private string MSH18 = "UNICODE UTF-8";
        public string MSH_18
        {
            get
            {
                return MSH18;
            }
            set
            {
                MSH18 = value;
            }
        }
        public string GetString()
        {
            string kq = MSH1 + "|" + MSH2 + "|" + MSH3 + "|" + MSH4 + "|" + MSH5 + "|" + MSH6 + "|" + MSH7 + "|" + MSH8 + "|" + MSH9 + "|" + MSH10 + "|" + MSH11 + "|" + MSH12 + "|" + MSH15 + "|" + MSH16 + "|" + MSH17 + "|" + MSH18;
            return kq;
        }
    }
    public class PID
    {
        private string PID0 = "PID";
        public string PID_0
        {
            get
            {
                return PID0;
            }
            set
            {
                PID0 = value;
            }
        }
        private string PID1 = "";
        public string PID_1
        {
            get
            {
                return PID1;
            }
            set
            {
                PID1 = value;
            }
        }
        private string PID2 = "";
        public string PID_2
        {
            get
            {
                return PID2;
            }
            set
            {
                PID2 = value;
            }
        }
        private string PID3 = "";
        public string PID_3
        {
            get
            {
                return PID3;
            }
            set
            {
                PID3 = value;
            }
        }
        private string PID4 = "";
        public string PID_4
        {
            get
            {
                return PID4;
            }
            set
            {
                PID4 = value;
            }
        }
        private string PID5 = "";
        public string PID_5
        {
            get
            {
                return PID5;
            }
            set
            {
                PID5 = value;
            }
        }
        private string PID6 = "";
        public string PID_6
        {
            get
            {
                return PID6;
            }
            set
            {
                PID6 = value;
            }
        }
        private string PID7 = "";
        public string PID_7
        {
            get
            {
                return PID7;
            }
            set
            {
                PID7 = value;
            }
        }
        private string PID8 = "";
        public string PID_8
        {
            get
            {
                return PID8;
            }
            set
            {
                PID8 = value;
            }
        }
        private string PID9 = "";
        public string PID_9
        {
            get
            {
                return PID9;
            }
            set
            {
                PID9 = value;
            }
        }
        private string PID10 = "";
        public string PID_10
        {
            get
            {
                return PID10;
            }
            set
            {
                PID10 = value;
            }
        }
        private string PID11 = "";
        public string PID_11
        {
            get
            {
                return PID11;
            }
            set
            {
                PID11 = value;
            }
        }
        private string PID12 = "";
        public string PID_12
        {
            get
            {
                return PID12;
            }
            set
            {
                PID12 = value;
            }
        }
        private string PID13 = "^0";
        public string PID_13
        {
            get
            {
                return PID13;
            }
            set
            {
                PID13 = value;
            }
        }
        public string GetString()
        {
            string kq = PID0 + "|" + PID1 + "|" + PID2 + "|" + PID3 + "|" + PID4 + "|" + PID5 + "|" + PID6 + "|" + PID7 + "|" + PID8 + "|" + PID9 + "|" + PID10 + "|" + PID11 + "|" + PID12 + "|" + PID13;
            return kq;
        }
    }
    public class PV1
    {
        private string PV10 = "PV1";
        public string PV1_0
        {
            get
            {
                return PV10;
            }
            set
            {
                PV10 = value;
            }
        }
        private string PV11 = "1";
        public string PV1_1
        {
            get
            {
                return PV11;
            }
            set
            {
                PV11 = value;
            }
        }
        private string PV12 = "I";
        public string PV1_2
        {
            get
            {
                return PV12;
            }
            set
            {
                PV12 = value;
            }
        }
        private string PV132 = "";
        public string PV1_32
        {
            get
            {
                return PV132;
            }
            set
            {
                PV132 = value;
            }
        }
        private string PV133 = "";
        public string PV1_33
        {
            get
            {
                return PV133;
            }
            set
            {
                PV133 = value;
            }
        }
        private string PV139 = "";
        public string PV1_39
        {
            get
            {
                return PV139;
            }
            set
            {
                PV139 = value;
            }
        }
        public string GetString()
        {
            string kq = PV10 + "|" + PV11 + "|" + PV12 + "|^" + PV132 + "^" + PV133 + "^^^^^^" + PV139;
            return kq;
        }
    }
    public class IN1
    {
        private string IN11 = "1";
        public string IN1_1
        {
            get
            {
                return IN11;
            }
            set
            {
                IN11 = value;
            }
        }
        private string IN12 = "";
        public string IN1_2
        {
            get
            {
                return IN12;
            }
            set
            {
                IN12 = value;
            }
        }
        private string IN13 = "";
        public string IN1_3
        {
            get
            {
                return IN13;
            }
            set
            {
                IN13 = value;
            }
        }
        public string GetString()
        {
            string kq = "IN1|" + IN11 + "|" + IN12 + "|" + IN13;
            return kq;
        }
    }
    public class ORC
    {
        private string ORC1 = "";
        public string ORC_1
        {
            get
            {
                return ORC1;
            }
            set
            {
                ORC1 = value;
            }
        }
        private string ORC2 = "";
        public string ORC_2
        {
            get
            {
                return ORC2;
            }
            set
            {
                ORC2 = value;
            }
        }
        private string ORC31 = "";
        public string ORC_31
        {
            get
            {
                return ORC31;
            }
            set
            {
                ORC31 = value;
            }
        }
        private string ORC32 = "";
        public string ORC_32
        {
            get
            {
                return ORC32;
            }
            set
            {
                ORC32 = value;
            }
        }
        private string ORC41 = "";
        public string ORC_41
        {
            get
            {
                return ORC41;
            }
            set
            {
                ORC41 = value;
            }
        }
        private string ORC42 = "";
        public string ORC_42
        {
            get
            {
                return ORC42;
            }
            set
            {
                ORC42 = value;
            }
        }
        private string ORC5 = "";
        public string ORC_5
        {
            get
            {
                return ORC5;
            }
            set
            {
                ORC5 = value;
            }
        }
        private string ORC15 = "";
        public string ORC_15
        {
            get
            {
                return ORC15;
            }
            set
            {
                ORC15 = value;
            }
        }
        private string ORC27 = "";
        public string ORC_27
        {
            get
            {
                return ORC27;
            }
            set
            {
                ORC27 = value;
            }
        }
        private string ORC29 = "I";
        public string ORC_29
        {
            get
            {
                return ORC29;
            }
            set
            {
                ORC29 = value;
            }
        }
        public string GetString()
        {
            string kq = "ORC|" + ORC1 + "|" + ORC2 + "|" + ORC31 + "^" + ORC32 + "||" + ORC5 + "||||||||||" + ORC15 + "||||||||||||" + ORC27 + "||" + ORC29;
            return kq;
        }
    }
    public class OBR
    {
        private string OBR1 = "";
        public string OBR_1
        {
            get
            {
                return OBR1;
            }
            set
            {
                OBR1 = value;
            }
        }
        private string OBR2 = "";
        public string OBR_2
        {
            get
            {
                return OBR2;
            }
            set
            {
                OBR2 = value;
            }
        }
        private string OBR31 = "";
        public string OBR_31
        {
            get
            {
                return OBR31;
            }
            set
            {
                OBR31 = value;
            }
        }
        private string OBR32 = "";
        public string OBR_32
        {
            get
            {
                return OBR32;
            }
            set
            {
                OBR32 = value;
            }
        }
        private string OBR41 = "";
        public string OBR_41
        {
            get
            {
                return OBR41;
            }
            set
            {
                OBR41 = value;
            }
        }
        private string OBR42 = "";
        public string OBR_42
        {
            get
            {
                return OBR42;
            }
            set
            {
                OBR42 = value;
            }
        }
        private string OBR7 = "";
        public string OBR_7
        {
            get
            {
                return OBR7;
            }
            set
            {
                OBR7 = value;
            }
        }
        private string OBR8 = "";
        public string OBR_8
        {
            get
            {
                return OBR8;
            }
            set
            {
                OBR8 = value;
            }
        }
        private string OBR13 = "";
        public string OBR_13
        {
            get
            {
                return OBR13;
            }
            set
            {
                OBR13 = value;
            }
        }
        private string OBR161 = "";
        public string OBR_161
        {
            get
            {
                return OBR161;
            }
            set
            {
                OBR161 = value;
            }
        }
        private string OBR162 = "";
        public string OBR_162
        {
            get
            {
                return OBR162;
            }
            set
            {
                OBR162 = value;
            }
        }
        private string OBR18 = "";
        public string OBR_18
        {
            get
            {
                return OBR18;
            }
            set
            {
                OBR18 = value;
            }
        }
        private string OBR20 = "";
        public string OBR_20
        {
            get
            {
                return OBR20;
            }
            set
            {
                OBR20 = value;
            }
        }
        private string OBR22 = "";
        public string OBR_22
        {
            get
            {
                return OBR22;
            }
            set
            {
                OBR22 = value;
            }
        }
        private string OBR24 = "";
        public string OBR_24
        {
            get
            {
                return OBR24;
            }
            set
            {
                OBR24 = value;
            }
        }
        public string GetString()
        {
            string kq = "OBR|" + OBR1 + "|" + OBR2 + "|" + OBR31 + "^" + OBR32 + "|" + OBR41 + "^" + OBR42 + "|||" + OBR8 + "||||||" + OBR13 + "|||" + OBR161 + "^" + OBR162 + "||" + OBR18 + "||" + OBR20 + "||" + OBR22 + "||" + OBR24;
            return kq;
        }
    }
    public class MSA
    {
        private string MSA0 = "MSA";
        public string MSA_0
        {
            get
            {
                return MSA0;
            }
            set
            {
                MSA0 = value;
            }
        }
        private string MSA1 = "";
        public string MSA_1
        {
            get
            {
                return MSA1;
            }
            set
            {
                MSA1 = value;
            }
        }
        private string MSA2 = "";
        public string MSA_2
        {
            get
            {
                return MSA2;
            }
            set
            {
                MSA2 = value;
            }
        }
        public string GetString()
        {
            string kq = MSA0 + "|" + MSA1 + "|" + MSA2;
            return kq;
        }
        public MSA(string s)
        {
            if (s.Trim().Length > 0)
            {
                string[] arr = s.Split('|');
                if (arr.Length > 0)
                {
                    MSA0 = arr[0];
                    MSA1 = arr[1];
                    MSA2 = arr[2];
                }
            }
        }
        public MSA()
        {
        }
    }
    public class ERR
    {
        private string ERR3 = "";
        public string ERR_3
        {
            get
            {
                return ERR3;
            }
            set
            {
                ERR3 = value;
            }
        }
        private string ERR4 = "";
        public string ERR_4
        {
            get
            {
                return ERR4;
            }
            set
            {
                ERR4 = value;
            }
        }
        private string ERR5 = "";
        public string ERR_5
        {
            get
            {
                return ERR5;
            }
            set
            {
                ERR5 = value;
            }
        }
        private string ERR7 = "";
        public string ERR_7
        {
            get
            {
                return ERR7;
            }
            set
            {
                ERR7 = value;
            }
        }
        public string GetString()
        {
            string kq = "ERR||" + ERR3 + "|" + ERR4 + "|" + ERR5 + "||" + ERR7;
            return kq;
        }
        public ERR()
        { }
        public ERR(string s)
        {
            if (s.Trim().Length > 0)
            {
                string[] arr = s.Split('|');
                if (arr.Length > 0)
                {
                    ERR3 = arr[3];
                    ERR4 = arr[4];
                    ERR5 = arr[5];
                    ERR7 = arr[7];
                }
            }
        }
    }
    public class mes
    {
        public string message { get; set; }
    }
    public class PACSOrder
    {
        public string SOPHIEUYEUCAU { get; set; }
        public int stt { get; set; }
        public string MABENHNHAN { get; set; }
        public string TenBenhNhan { get; set; }
        public int NAMSINH { get; set; }
        public string GIOITINH { get; set; }
        public string MADOITUONG { get; set; }
        public string Diachi { get; set; }
        public string MaBacSi { get; set; }
        public string MaKhoaPhong { get; set; }
        public string MACHANDOAN { get; set; }
        public string ChanDoan { get; set; }
        public string MADICHVU { get; set; }
        public string tendv { get; set; }
        public string ngaydk { get; set; }
        public string sothebhyt { get; set; }
        public string sophong { get; set; }
        public string sogiuong { get; set; }
        public string DienThoai { get; set; }
        public string MaNhomDichVu { get; set; }
        public string ngaydaukykcc { get; set; }
        public string bsdieutri { get; set; }
        public string Khoa { get; set; }
        public string TenBSChiDinh { get; set; }
        public string TenBSDieuTri { get; set; }
        public string MaSo { get; set; }
        public string MaSoKham { get; set; }
        public PACSOrder()
        {
            SOPHIEUYEUCAU = "";
            stt = 0;
            MABENHNHAN = "";
            TenBenhNhan = "";
            NAMSINH = 0;
            GIOITINH = "";
            MADOITUONG = "";
            Diachi = "";
            MaBacSi = "";
            MaKhoaPhong = "";
            MACHANDOAN = "";
            ChanDoan = "";
            MADICHVU = "";
            tendv = "";
            ngaydk = "";
            sothebhyt = "";
            sophong = "";
            sogiuong = "";
            DienThoai = "";
            MaNhomDichVu = "";
            ngaydaukykcc = "";
            bsdieutri = "";
            Khoa = "";
            TenBSChiDinh = "";
            TenBSDieuTri = "";
            MaSo = "";
            MaSoKham = "";
        }
        public PACSOrder(string SOPHIEUYEUCAU,
        int stt,
        string MABENHNHAN,
        string TenBenhNhan,
        int NAMSINH,
        string GIOITINH,
        string MADOITUONG,
        string Diachi,
        string MaBacSi,
        string MaKhoaPhong,
        string MACHANDOAN,
        string ChanDoan,
        string MADICHVU,
        string tendv,
        string ngaydk,
        string sothebhyt,
        string sophong,
        string sogiuong,
        string DienThoai,
        string MaNhomDichVu,
        string ngaydaukykcc,
        string bsdieutri,
        string Khoa,
        string TenBSChiDinh,
        string TenBSDieuTri,
        string MaSo,
        string MaSoKham)
        {
            this.SOPHIEUYEUCAU = SOPHIEUYEUCAU;
            this.stt = stt;
            this.MABENHNHAN = MABENHNHAN;
            this.TenBenhNhan = TenBenhNhan;
            this.NAMSINH = NAMSINH;
            this.GIOITINH = GIOITINH;
            this.MADOITUONG = MADOITUONG;
            this.Diachi = Diachi;
            this.MaBacSi = MaBacSi;
            this.MaKhoaPhong = MaKhoaPhong;
            this.MACHANDOAN = MACHANDOAN;
            this.ChanDoan = ChanDoan;
            this.MADICHVU = MADICHVU;
            this.tendv = tendv;
            this.ngaydk = ngaydk;
            this.sothebhyt = sothebhyt;
            this.sophong = sophong;
            this.sogiuong = sogiuong;
            this.DienThoai = DienThoai;
            this.MaNhomDichVu = MaNhomDichVu;
            this.ngaydaukykcc = ngaydaukykcc;
            this.bsdieutri = bsdieutri;
            this.Khoa = Khoa;
            this.TenBSChiDinh = TenBSChiDinh;
            this.TenBSDieuTri = TenBSDieuTri;
            this.MaSo = MaSo;
            this.MaSoKham = MaSoKham;
        }
        public PACSOrder(IDataReader dr)
        {
            if (dr["SOPHIEUYEUCAU"].GetType().Name != "DBNull" && dr["SOPHIEUYEUCAU"] != null)
            {
                this.SOPHIEUYEUCAU = Convert.ToString(dr["SOPHIEUYEUCAU"]);
            }
            else
            {
                this.SOPHIEUYEUCAU = "";
            }
            if (dr["stt"].GetType().Name != "DBNull" && dr["stt"] != null)
            {
                this.stt = Convert.ToInt32(dr["stt"]);
            }
            else
            {
                this.stt = 0;
            }
            if (dr["MABENHNHAN"].GetType().Name != "DBNull" && dr["MABENHNHAN"] != null)
            {
                this.MABENHNHAN = Convert.ToString(dr["MABENHNHAN"]);
            }
            else
            {
                this.MABENHNHAN = "";
            }
            if (dr["TenBenhNhan"].GetType().Name != "DBNull" && dr["TenBenhNhan"] != null)
            {
                this.TenBenhNhan = Convert.ToString(dr["TenBenhNhan"]);
            }
            else
            {
                this.TenBenhNhan = "";
            }
            if (dr["NAMSINH"].GetType().Name != "DBNull" && dr["NAMSINH"] != null)
            {
                this.NAMSINH = Convert.ToInt32(dr["NAMSINH"]);
            }
            else
            {
                this.NAMSINH = 0;
            }
            if (dr["GIOITINH"].GetType().Name != "DBNull" && dr["GIOITINH"] != null) { this.GIOITINH = Convert.ToString(dr["GIOITINH"]); } else { this.GIOITINH = ""; }
            if (dr["MADOITUONG"].GetType().Name != "DBNull" && dr["MADOITUONG"] != null) { this.MADOITUONG = Convert.ToString(dr["MADOITUONG"]); } else { this.MADOITUONG = ""; }
            if (dr["Diachi"].GetType().Name != "DBNull" && dr["Diachi"] != null) { this.Diachi = Convert.ToString(dr["Diachi"]); } else { this.Diachi = ""; }
            if (dr["MaBacSi"].GetType().Name != "DBNull" && dr["MaBacSi"] != null) { this.MaBacSi = Convert.ToString(dr["MaBacSi"]); } else { this.MaBacSi = ""; }
            if (dr["MaKhoaPhong"].GetType().Name != "DBNull" && dr["MaKhoaPhong"] != null) { this.MaKhoaPhong = Convert.ToString(dr["MaKhoaPhong"]); } else { this.MaKhoaPhong = ""; }
            if (dr["MACHANDOAN"].GetType().Name != "DBNull" && dr["MACHANDOAN"] != null) { this.MACHANDOAN = Convert.ToString(dr["MACHANDOAN"]); } else { this.MACHANDOAN = ""; }
            if (dr["ChanDoan"].GetType().Name != "DBNull" && dr["ChanDoan"] != null) { this.ChanDoan = Convert.ToString(dr["ChanDoan"]); } else { this.ChanDoan = ""; }
            if (dr["MADICHVU"].GetType().Name != "DBNull" && dr["MADICHVU"] != null) { this.MADICHVU = Convert.ToString(dr["MADICHVU"]); } else { this.MADICHVU = ""; }
            if (dr["tendv"].GetType().Name != "DBNull" && dr["tendv"] != null) { this.tendv = Convert.ToString(dr["tendv"]); } else { this.tendv = ""; }
            if (dr["ngaydk"].GetType().Name != "DBNull" && dr["ngaydk"] != null) { this.ngaydk = Convert.ToString(dr["ngaydk"]); } else { this.ngaydk = ""; }
            if (dr["sothebhyt"].GetType().Name != "DBNull" && dr["sothebhyt"] != null) { this.sothebhyt = Convert.ToString(dr["sothebhyt"]); } else { this.sothebhyt = ""; }
            if (dr["sophong"].GetType().Name != "DBNull" && dr["sophong"] != null) { this.sophong = Convert.ToString(dr["sophong"]); } else { this.sophong = ""; }
            if (dr["sogiuong"].GetType().Name != "DBNull" && dr["sogiuong"] != null) { this.sogiuong = Convert.ToString(dr["sogiuong"]); } else { this.sogiuong = ""; }
            if (dr["DienThoai"].GetType().Name != "DBNull" && dr["DienThoai"] != null) { this.DienThoai = Convert.ToString(dr["DienThoai"]); } else { this.DienThoai = ""; }
            if (dr["MaNhomDichVu"].GetType().Name != "DBNull" && dr["MaNhomDichVu"] != null) { this.MaNhomDichVu = Convert.ToString(dr["MaNhomDichVu"]); } else { this.MaNhomDichVu = ""; }
            if (dr["ngaydaukykcc"].GetType().Name != "DBNull" && dr["ngaydaukykcc"] != null) { this.ngaydaukykcc = Convert.ToString(dr["ngaydaukykcc"]); } else { this.ngaydaukykcc = ""; }
            if (dr["bsdieutri"].GetType().Name != "DBNull" && dr["bsdieutri"] != null) { this.bsdieutri = Convert.ToString(dr["bsdieutri"]); } else { this.bsdieutri = ""; }
            if (dr["Khoa"].GetType().Name != "DBNull" && dr["Khoa"] != null) { this.Khoa = Convert.ToString(dr["Khoa"]); } else { this.Khoa = ""; }
            if (dr["TenBSChiDinh"].GetType().Name != "DBNull" && dr["TenBSChiDinh"] != null) { this.TenBSChiDinh = Convert.ToString(dr["TenBSChiDinh"]); } else { this.TenBSChiDinh = ""; }
            if (dr["TenBSDieuTri"].GetType().Name != "DBNull" && dr["TenBSDieuTri"] != null) { this.TenBSDieuTri = Convert.ToString(dr["TenBSDieuTri"]); } else { this.TenBSDieuTri = ""; }
            if (dr["MaSo"].GetType().Name != "DBNull" && dr["MaSo"] != null) { this.MaSo = Convert.ToString(dr["MaSo"]); } else { this.MaSo = ""; }
            if (dr["MaSoKham"].GetType().Name != "DBNull" && dr["MaSoKham"] != null) { this.MaSoKham = Convert.ToString(dr["MaSoKham"]); } else { this.MaSoKham = ""; }
        }
    }
    public PACSOrder sp_PACS_Order(String SoPhieuYeuCau, DateTime ngaychidinh, DateTime ngaychidinhden)
    {
        // return ((IDataReader)SqlHelper.ExecuteReader(ConnectionString, DatabaseOwner + ObjectQualifier + "spKhamBenh_C_GETs", _qadmin, _DaTT, _ngayYC, _loai, _dk, _makhoa, _denngayYC));
        //System.Data.SqlClient.SqlCommand cmd = SqlHelper.CreateCommand(SQLConnectionDataBC, DatabaseOwner + ObjectQualifier + "spKhamBenh_C_GETs");
        PACSOrder PACSOrder = new PACSOrder();
        string tenStore = "sp_PACS_Order_Send";
        string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
        using (SqlConnection Conection = new SqlConnection(StrConection))
        {
            Conection.Open();
            using (SqlCommand Command = new SqlCommand(tenStore, Conection))
            {
                Command.CommandType = CommandType.StoredProcedure;
                Command.Parameters.Add(new SqlParameter("@SoPhieuYeuCau", SoPhieuYeuCau));
                Command.Parameters.Add(new SqlParameter("@ngaychidinh", ngaychidinh));
                Command.Parameters.Add(new SqlParameter("@ngaychidinhden", ngaychidinhden));
                IDataReader dt;
                dt = (IDataReader)Command.ExecuteReader(CommandBehavior.CloseConnection);
                if (dt.Read())
                    PACSOrder = new PACSOrder(dt);
                dt.Close(); dt.Dispose();
                Command.Dispose();
                //Command = null;
            }
        }
        return PACSOrder;
    }
    public DataTable GetPACS_Send(string masokham)
    {
        DataTable dr = new DataTable();
        string tenStore = "spKhamBenh_C_GetPACS_SendBH";
        string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
        using (SqlConnection Conection = new SqlConnection(StrConection))
        {
            Conection.Open();
            using (SqlCommand Command = new SqlCommand(tenStore, Conection))
            {
                Command.CommandType = CommandType.StoredProcedure;
                //Command.Parameters.Add(new SqlParameter("@Loai", "View"));
                Command.Parameters.Add(new SqlParameter("@masokham", masokham));
                SqlDataAdapter dp = new SqlDataAdapter(Command);
                dp.Fill(dr);
            }
            //if (dr.Rows.Count > 0)
            //    return dr.Rows[0][0].ToString();
            //else
            //    return "";
            return dr;
        }
    }
    public void spKhamBenh_C_GetPACS_Send_Update(string masokham, string sttlist)
    {
        DataTable dr = new DataTable();
        string tenStore = "spKhamBenh_C_GetPACS_Send_Update";
        string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
        using (SqlConnection Conection = new SqlConnection(StrConection))
        {
            Conection.Open();
            using (SqlCommand Command = new SqlCommand(tenStore, Conection))
            {
                Command.CommandType = CommandType.StoredProcedure;
                //Command.Parameters.Add(new SqlParameter("@Loai", "View"));
                Command.Parameters.Add(new SqlParameter("@masokham", masokham));
                Command.Parameters.Add(new SqlParameter("@STTlist", sttlist));
                SqlDataAdapter dp = new SqlDataAdapter(Command);
                dp.Fill(dr);
            }
            //if (dr.Rows.Count > 0)
            //    return dr.Rows[0][0].ToString();
            //else
            //    return "";
            //return dr;
        }
    }
    public string PostOrder(string url, string username, string password, object send)
    {
        var serializer = new JavaScriptSerializer();
        //string json = "{\"username\":\"" + username + "\",\"password\":\"" + password + "\"}";
        //WriteLog(json);
        //string xau = 
        string serializedResult = serializer.Serialize(send);
        WriteLog(serializedResult);
        Uri myUri = new Uri(url);
        WebRequest myWebRequest = HttpWebRequest.Create(myUri);
        myWebRequest.ContentType = "application/json";
        myWebRequest.Method = "POST";
        HttpWebRequest myHttpWebRequest = (HttpWebRequest)myWebRequest;
        myHttpWebRequest.PreAuthenticate = true;
        //myHttpWebRequest.Headers.Add("Authorization", "Basic " + token);
        using (var streamWriter = new StreamWriter(myWebRequest.GetRequestStream()))
        {
            streamWriter.Write(serializedResult);
            streamWriter.Flush();
            streamWriter.Close();
        }
        WebResponse myWebResponse = myWebRequest.GetResponse();
        Stream responseStream = myWebResponse.GetResponseStream();
        StreamReader myStreamReader = new StreamReader(responseStream, Encoding.Default);
        string pageContent = myStreamReader.ReadToEnd();
        responseStream.Close();
        myWebResponse.Close();
        return pageContent;
        //return xau;
    }
    public DataTable GetPACS_SendHuy(string masokham)
    {
        DataTable dr = new DataTable();
        string tenStore = "spKhamBenh_C_GetPACS_SendBHHuy";
        string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
        using (SqlConnection Conection = new SqlConnection(StrConection))
        {
            Conection.Open();
            using (SqlCommand Command = new SqlCommand(tenStore, Conection))
            {
                Command.CommandType = CommandType.StoredProcedure;
                //Command.Parameters.Add(new SqlParameter("@Loai", "View"));
                Command.Parameters.Add(new SqlParameter("@masokham", masokham));
                SqlDataAdapter dp = new SqlDataAdapter(Command);
                dp.Fill(dr);
            }
            //if (dr.Rows.Count > 0)
            //    return dr.Rows[0][0].ToString();
            //else
            //    return "";
            return dr;
        }
    }
    public PACSOrder sp_PACS_OrderHuy(String SoPhieuYeuCau, DateTime ngaychidinh, DateTime ngaychidinhden)
    {
        // return ((IDataReader)SqlHelper.ExecuteReader(ConnectionString, DatabaseOwner + ObjectQualifier + "spKhamBenh_C_GETs", _qadmin, _DaTT, _ngayYC, _loai, _dk, _makhoa, _denngayYC));
        //System.Data.SqlClient.SqlCommand cmd = SqlHelper.CreateCommand(SQLConnectionDataBC, DatabaseOwner + ObjectQualifier + "spKhamBenh_C_GETs");
        PACSOrder PACSOrder = new PACSOrder();
        string tenStore = "sp_PACS_Order_SendHuy";
        string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
        using (SqlConnection Conection = new SqlConnection(StrConection))
        {
            Conection.Open();
            using (SqlCommand Command = new SqlCommand(tenStore, Conection))
            {
                Command.CommandType = CommandType.StoredProcedure;
                Command.Parameters.Add(new SqlParameter("@SoPhieuYeuCau", SoPhieuYeuCau));
                Command.Parameters.Add(new SqlParameter("@ngaychidinh", ngaychidinh));
                Command.Parameters.Add(new SqlParameter("@ngaychidinhden", ngaychidinhden));
                IDataReader dt;
                dt = (IDataReader)Command.ExecuteReader(CommandBehavior.CloseConnection);
                if (dt.Read())
                    PACSOrder = new PACSOrder(dt);
                dt.Close(); dt.Dispose();
                Command.Dispose();
                //Command = null;
            }
        }
        return PACSOrder;
    }
    public string GetIDPACS(string sophieuchidinh)
    {
        DataTable dr = new DataTable();
        string tenStore = "spID_PACS_Get";
        string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
        using (SqlConnection Conection = new SqlConnection(StrConection))
        {
            Conection.Open();
            using (SqlCommand Command = new SqlCommand(tenStore, Conection))
            {
                Command.CommandType = CommandType.StoredProcedure;
                Command.Parameters.Add(new SqlParameter("@SoPhieuChiDinh", sophieuchidinh));
                SqlDataAdapter dp = new SqlDataAdapter(Command);
                dp.Fill(dr);
            }
            if (dr.Rows.Count > 0)
                return dr.Rows[0][0].ToString();
            else
                return "";
        }
    }

    //ham lay port de xem kq PACS
    public DataTable GetPort1(string loai)
    {
        DataTable dr = new DataTable();
        string tenStore = "PACS_Port_Get";
        string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
        using (SqlConnection Conection = new SqlConnection(StrConection))
        {
            Conection.Open();
            using (SqlCommand Command = new SqlCommand(tenStore, Conection))
            {
                Command.CommandType = CommandType.StoredProcedure;
                //Command.Parameters.Add(new SqlParameter("@Loai", "View"));
                Command.Parameters.Add(new SqlParameter("@Loai", loai));
                SqlDataAdapter dp = new SqlDataAdapter(Command);
                dp.Fill(dr);
            }
            //if (dr.Rows.Count > 0)
            //    return dr.Rows[0][0].ToString();
            //else
            //    return "";
            return dr;
        }
    }
    //ham lay port de xem kq PACS
    public string GetPort2(string loai)
    {
        DataTable dr = new DataTable();
        string tenStore = "PACS_Port_Get";
        string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
        using (SqlConnection Conection = new SqlConnection(StrConection))
        {
            Conection.Open();
            using (SqlCommand Command = new SqlCommand(tenStore, Conection))
            {
                Command.CommandType = CommandType.StoredProcedure;
                //Command.Parameters.Add(new SqlParameter("@Loai", "View"));
                Command.Parameters.Add(new SqlParameter("@Loai", loai));
                SqlDataAdapter dp = new SqlDataAdapter(Command);
                dp.Fill(dr);
            }
            if (dr.Rows.Count > 0)
                return dr.Rows[0][0].ToString();
            else
                return "";
        }
    }
    #endregion

    protected void txtupdate_ValueChanged(object sender, EventArgs e)
    {

    }
}
