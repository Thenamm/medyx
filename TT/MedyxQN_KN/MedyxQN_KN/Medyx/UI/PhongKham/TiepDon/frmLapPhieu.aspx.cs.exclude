using System;
using System.Collections.Generic;
using System.Configuration;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using HTC.Business.CategoryList;
using HTC.Business.PhongKham;
//using HTC.Business.Duoc;
using HTC.Common.Web;
using Telerik.Web.UI;
using CrystalDecisions.CrystalReports.Engine;
using System.Data;
using System.Text;
using Newtonsoft.Json.Linq;
using Newtonsoft.Json;
using System.Net;
using System.IO;
using System.Web.Script.Serialization;
using System.Net;
using System.Net.Security;
using Microsoft.ApplicationBlocks.Data;
using System.Globalization;
using System.Data.SqlClient;
using Telerik.Web.UI.Skins;
using RadComboBox = Telerik.Web.UI.RadComboBox;
using RadGrid = Telerik.Web.UI.RadGrid;
using Csla;
using HTC.Business;
using Csla.Data;

public partial class UI_PhongKham_TiepDon_frmLapPhieu : WebBase
{
    //[WebMethod]
    //public static DMQuanHuyenListcb cboDMTinhChange(string Value)
    //{

    //       return DMQuanHuyenListcb.GetListbyTinh(Value);

    //}

    #region PAGE PARAM REQUEST
    // _NoiTT == "085"  thu bao hiem,dichvu  ||_NoiTT == "087"  clc, pk56 || (_NoiTT == "090" ||_NoiTT == "094" ||_NoiTT =="093") ban thuoc dy|| _NoiTT == "091"  ban thuoc 43 || _NoiTT == "092" ban 56 || _NoiTT == "093" ban ngoai gio 43 || _NoiTT == "095" ban ngoai gio 56) 
    //_loaiphieu =2 thu bao hiem, 9: tu tuc, 7 ban thuoc      


    private const string ViewState_MaSoKham = "MaSoKham";
    private const string ViewState_MaBN = "MaBN";

    private const string ViewState_PubMaDT = "PubMaDT";

    public void setUpdateDt(LocalDateTime time)
    {

    }

    public string _PubMaDT
    {
        get
        {
            if (ViewState[ViewState_PubMaDT] == null)
            {
                if (Request["PubMaDT"] == null)
                    ViewState[ViewState_PubMaDT] = "";
                else
                    ViewState[ViewState_PubMaDT] = Request["PubMaDT"].ToString();
            }
            return (string)ViewState[ViewState_PubMaDT];
        }

        set
        {
            ViewState[ViewState_PubMaDT] = value;
        }


    }
    private const string ViewState_SoHDCuoi = "SoHDCuoi";

    public string _SoHDCuoi
    {
        get
        {
            if (ViewState[ViewState_SoHDCuoi] == null)
            {
                if (Request["SoHDCuoi"] == null)
                    ViewState[ViewState_SoHDCuoi] = "";
            }
            return (string)ViewState[ViewState_SoHDCuoi];
        }

        set
        {
            ViewState[ViewState_SoHDCuoi] = value;
        }


    }
    private const string ViewState_Pub_TransactionID = "Pub_TransactionID";

    public int _Pub_TransactionID
    {
        get
        {
            if (ViewState[ViewState_Pub_TransactionID] == null)
                ViewState[ViewState_Pub_TransactionID] = Pub_TransactionID;
            return (int)ViewState[ViewState_Pub_TransactionID];
        }

        set
        {
            ViewState[ViewState_Pub_TransactionID] = value;

        }

    }
    private const string ViewState_NoiTT = "NoiTT";

    public string _NoiTT
    {
        get
        {
            return (string)ViewState[ViewState_NoiTT];
        }

        set
        {
            ViewState[ViewState_NoiTT] = value;
        }

    }
    private const string ViewState_MaPX = "MaPX";

    public string _MaPX
    {
        get
        {
            return (string)ViewState[ViewState_MaPX];
        }

        set
        {
            ViewState[ViewState_MaPX] = value;
        }

    }
    private const string ViewState_MaPXDY = "MaPXDY";

    public string _MaPXDY
    {
        get
        {
            return (string)ViewState[ViewState_MaPXDY];
        }

        set
        {
            ViewState[ViewState_MaPXDY] = value;
        }

    }
    private const string ViewState_SoSoHD = "SoSoHD";

    public string _SoSoHD
    {
        get
        {
            return (string)ViewState[ViewState_SoSoHD];
        }

        set
        {
            ViewState[ViewState_SoSoHD] = value;
        }

    }
    private const string ViewState_SoHD = "SoHD";

    public string _SoHD
    {
        get
        {
            return (string)ViewState[ViewState_SoHD];
        }

        set
        {
            ViewState[ViewState_SoHD] = value;
        }

    }
    private const string ViewState_LanTT = "LanTT";

    public byte _LanTT
    {
        get
        {
            return (byte)ViewState[ViewState_LanTT];
        }

        set
        {
            ViewState[ViewState_LanTT] = value;
        }

    }
    private const string ViewState_MaKhoa = "MaKhoa";

    public string _MaKhoa
    {
        get
        {
            if (ViewState[ViewState_MaKhoa] == null)
            {
                if (_NoiTT == "085" || _NoiTT == "090" || _NoiTT == "091" || _NoiTT == "092")
                    ViewState[ViewState_MaKhoa] = "011";
                else
                    ViewState[ViewState_MaKhoa] = HTC.ShareVariables.pub_sMaKhoa087;
            }
            return (string)ViewState[ViewState_MaKhoa];
        }

        set
        {
            ViewState[ViewState_MaKhoa] = value;
        }

    }
    private const string ViewState_MaDT = "MaDT";

    public string _MaDT
    {
        get
        {

            return (string)cboDoiTuong.SelectedValue;
        }



    }

    public string _MaSoKham
    {
        get
        {
            if (ViewState[ViewState_MaSoKham] == null)
                ViewState[ViewState_MaSoKham] = "";

            return (string)ViewState[ViewState_MaSoKham];
        }

        set
        {
            ViewState[ViewState_MaSoKham] = value;
        }

    }

    public string _MaBN
    {
        get
        {
            if (ViewState[ViewState_MaBN] == null)
                ViewState[ViewState_MaBN] = "";

            return (string)ViewState[ViewState_MaBN];
        }

        set
        {
            ViewState[ViewState_MaBN] = value;
        }

    }
    private const string ViewState_NgayDK = "NgayDK";

public DateTime _NgayDK

    {
        get
        {
            if (ViewState[ViewState_NgayDK] == null) 
            if (Request["NgayDK"] == null)
                    _NgayDK = DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);
                else
                    _NgayDK = DateTime.Parse(Request["NgayDK"].ToString());
            return (DateTime)ViewState[ViewState_NgayDK];
        }

        set
        {
            ViewState[ViewState_NgayDK] = value;
        }

    }

    private const string ViewState_STT = "STT";

    public int _STT
    {
        get
        {
            if (ViewState[ViewState_STT] == null)
                ViewState[ViewState_STT] = 1;
            return (int)ViewState[ViewState_STT];
        }

        set
        {
            ViewState[ViewState_STT] = value;
        }

    }
    private const string ViewState_KTBHYT = "KTBHYT";

    public Boolean _KTBHYT
    {
        get
        {
            if (ViewState[ViewState_KTBHYT] == null)
            {

                ViewState[ViewState_KTBHYT] = false;
            }
            return (Boolean)ViewState[ViewState_KTBHYT];
        }

        set
        {
            ViewState[ViewState_KTBHYT] = value;
        }

    }
    private const string ViewState_Duyet = "Duyet";

    public byte _Duyet
    {
        get
        {
            if (ViewState[ViewState_Duyet] == null && _LoaiPhieu == 1)
            {
                if (Request["Duyet"] == null)
                    Response.Redirect("~/Default.aspx");
                else
                    ViewState[ViewState_Duyet] = Convert.ToByte(Request["Duyet"].ToString());
            }
            else if (ViewState[ViewState_Duyet] == null && _LoaiPhieu != 1)
            {
                if (Request["Duyet"] != null)
                    ViewState[ViewState_Duyet] = Convert.ToByte(Request["Duyet"].ToString());
                else
                    ViewState[ViewState_Duyet] = byte.MinValue;
            }

            return (byte)ViewState[ViewState_Duyet];
        }

        set
        {
            ViewState[ViewState_Duyet] = value;
        }

    }
    private const string ViewState_SoTT = "SoTT";

    public byte _SoTT
    {
        get
        {
            if (ViewState[ViewState_SoTT] == null)
            {
                if (Request["SoTT"] == null)
                    ViewState[ViewState_SoTT] = 0;
            }

            return byte.Parse(ViewState[ViewState_SoTT].ToString());
        }

        set
        {
            ViewState[ViewState_SoTT] = value;
        }

    }
    private const string ViewState_Order = "_Order";

    public int _Order
    {
        get
        {
            if (ViewState[ViewState_Order] == null)
            {
                ViewState[ViewState_Order] = 0;
            }

            return (int)ViewState[ViewState_Order];
        }

        set
        {
            ViewState[ViewState_Order] = value;
        }

    }
    private const string viewState_LoaiPhieu = "LoaiPhieu";
    public byte _LoaiPhieu
    {
        get
        {
            if (ViewState[viewState_LoaiPhieu] == null)
                if (Request["LoaiPhieu"] == null)
                    Response.Redirect("~/Default.aspx");
                else
                    ViewState[viewState_LoaiPhieu] = byte.Parse(Request["LoaiPhieu"].ToString());
            return (byte)ViewState[viewState_LoaiPhieu];
        }

        set
        {
            ViewState[viewState_LoaiPhieu] = value;
        }
    }

    #endregion

    private const string ViewState_ThongKe_BenhNhan_NgoaiTruListInfo = "ThongKe_BenhNhan_NgoaiTruListInfo";
    public ThongKe_BenhNhan_NgoaiTruListInfo _ThongKe_BenhNhan_NgoaiTruListInfo
    {
        get
        {
            return (ThongKe_BenhNhan_NgoaiTruListInfo)ViewState[ViewState_ThongKe_BenhNhan_NgoaiTruListInfo];
        }

        set
        {
            ViewState[ViewState_ThongKe_BenhNhan_NgoaiTruListInfo] = value;
        }
    }
    private const string ViewState_KhamBenh_GETsMABNListInfo = "KhamBenh_GETsMABNListInfo";
    public KhamBenh_GETsMABNListInfo _KhamBenh_GETsMABNListInfo
    {
        get
        {
            return (KhamBenh_GETsMABNListInfo)ViewState[ViewState_KhamBenh_GETsMABNListInfo];
        }

        set
        {
            ViewState[ViewState_KhamBenh_GETsMABNListInfo] = value;
        }
    }
    private const string ViewState_ThongtinBN = "ThongtinBN";
    public ThongtinBN _ThongtinBN
    {
        get
        {
            return (ThongtinBN)ViewState[ViewState_ThongtinBN];
        }

        set
        {
            ViewState[ViewState_ThongtinBN] = value;
        }
    }

    private const string ViewState_KhamBenh_DongTienList = "KhamBenh_DongTienList";
    public KhamBenh_DongTienList _KhamBenh_DongTienList
    {
        get
        {
            return (KhamBenh_DongTienList)ViewState[ViewState_KhamBenh_DongTienList];
        }

        set
        {
            ViewState[ViewState_KhamBenh_DongTienList] = value;
        }
    }


    //private const string ViewState_KhamBenh_GetsDichVuDTT = "KhamBenh_GetsDichVuList";
    //public KhamBenh_GetsDichVuList _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList;
    ////{
    ////    get
    ////    {
    ////        return (KhamBenh_GetsDichVuList)_KhamBenh .KhamBenh_GetsDichVuList;
    ////    }
    ////    set
    ////    {
    ////    }
    ////    //set
    ////    //{
    ////    //    ViewState[ViewState_KhamBenh_GetsDichVuDTT] = value;
    ////    //}
    ////}

    //private const string ViewState_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList = "KhamBenh_GetsDichVuList";
    //public KhamBenh_GetsDichVuList _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList;
    ////{
    ////    get
    ////    {
    ////        return (KhamBenh_GetsDichVuList)_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList;
    ////    }
    ////    set
    ////    {
    ////    }
    ////    //set
    ////    //{
    ////    //    ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList] = value;
    ////    //}
    ////}

    //#region Khám bệnh Thuốc sử dụng

    ////private const string ViewState_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList = "KhamBenh_ThuocSDList";
    //public KhamBenh_ThuocSDList _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList;
    ////{
    ////    get
    ////    {
    ////        //if (ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList] == null)
    ////        //{
    ////        //    LoadDetails_KhamBenh_ThuocSuDung();
    ////        //}

    ////        return (KhamBenh_ThuocSDList)_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList;
    ////    }
    ////    set
    ////    {
    ////    }
    ////    //set
    ////    //{
    ////    //    ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList] = value;
    ////    //}

    ////}

    ////private const string ViewState_KhamBenh_ThuocSD = "KhamBenh_ThuocSD";
    ////public KhamBenh_ThuocSD _KhamBenh_ThuocSD
    ////{
    ////    get
    ////    {
    ////        if (ViewState[ViewState_KhamBenh_ThuocSD] != null)
    ////        {
    ////            return (KhamBenh_ThuocSD)ViewState[ViewState_KhamBenh_ThuocSD];
    ////        }

    ////        return null;
    ////    }

    ////    set
    ////    {
    ////        ViewState[ViewState_KhamBenh_ThuocSD] = value;
    ////    }

    ////}
    //#endregion

    #region Khám bệnh thuốc Thang
    //private const string ViewState_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList = "ViewState_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList";
    //public KhamBenh_ThuocSD_DYList _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList;
    ////{
    ////    get
    ////    {

    ////        return (KhamBenh_ThuocSD_DYList)_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList;
    ////       // return (KhamBenh_ThuocSD_DYList)ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList];
    ////    }
    ////    set
    ////    {
    ////    }
    ////    //set
    ////    //{
    ////    //    ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList] = value;
    ////    //}

    ////}

    private const string ViewState_KhamBenh_ThuocSD_DY = "ViewState_KhamBenh_ThuocSD_DY";
    public KhamBenh_ThuocSD_DY _KhamBenh_ThuocSD_DY
    {
        get
        {
            return (KhamBenh_ThuocSD_DY)ViewState[ViewState_KhamBenh_ThuocSD_DY];
        }

        set
        {
            ViewState[ViewState_KhamBenh_ThuocSD_DY] = value;
        }

    }



    #endregion

    //#region Khám bệnh XN.TT.XQ.TDCN

    ////private const string ViewState_KhamBenh_C = "KhamBenh_C";
    ////public KhamBenh_C _KhamBenh_C
    ////{
    ////    get
    ////    {
    ////        if (ViewState[ViewState_KhamBenh_C] == null)
    ////        {
    ////            LoadDetails_KhamBenh_XNTT();
    ////        }

    ////        return (KhamBenh_C)ViewState[ViewState_KhamBenh_C];
    ////    }

    ////    set
    ////    {
    ////        ViewState[ViewState_KhamBenh_C] = value;
    ////    }

    ////}

    //private const string ViewState_ThongtinBN.KhamBenh.KhamBenh_C_List = "ViewState_ThongtinBN.KhamBenh.KhamBenh_C_List";
    //public KhamBenh_C_List _ThongtinBN.KhamBenh.KhamBenh_C_List;
    ////{
    ////    get
    ////    {
    ////        //if (ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_C_List] == null)
    ////        //{
    ////        //    LoadDetails_KhamBenh_XNTT();
    ////        //}
    ////        return (KhamBenh_C_List)_ThongtinBN.KhamBenh.KhamBenh_C_List;

    ////        //return (KhamBenh_C_List)ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_C_List];
    ////    }
    ////    set
    ////    {
    ////    }
    ////    //set
    ////    //{
    ////    //    ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_C_List] = value;
    ////    //}

    ////}
    //#endregion

    //#region Khám bệnh VTTH

    //private const string ViewState_ThongtinBN.KhamBenh.KhamBenh_VTTHList = "KhamBenh_VTTHList";
    //public KhamBenh_VTTHList _ThongtinBN.KhamBenh.KhamBenh_VTTHList;
    ////{
    ////    get
    ////    {
    ////        //if (ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_VTTHList] == null)
    ////        //{
    ////        //    LoadDetails_KhamBenh_VTTH();
    ////        //}
    ////        return (KhamBenh_VTTHList)_ThongtinBN.KhamBenh.KhamBenh_VTTHList;

    ////        //return (KhamBenh_VTTHList)ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_VTTHList];
    ////    }
    ////    set
    ////    {
    ////    }
    ////    //set
    ////    //{
    ////    //    ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_VTTHList] = value;
    ////    //}

    ////}
    //#endregion

    //#region Khám bệnh Hóa Chất

    //private const string ViewState_ThongtinBN.KhamBenh.KhamBenh_HoaChatList = "KhamBenh_HoaChatList";
    //public KhamBenh_HoaChatList _ThongtinBN.KhamBenh.KhamBenh_HoaChatList;
    ////{
    ////    get
    ////    {
    ////        //if (ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_HoaChatList] == null)
    ////        //{
    ////        //    LoadDetails_KhamBenh_HoaChat();
    ////        //}
    ////        return (KhamBenh_HoaChatList)_ThongtinBN.KhamBenh.KhamBenh_HoaChatList;

    ////        //return (KhamBenh_HoaChatList)ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_HoaChatList];
    ////    }
    ////    set
    ////    {
    ////    }
    ////    //set
    ////    //{
    ////    //    ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_HoaChatList] = value;
    ////    //}

    ////}
    //#endregion

    //#region Khám bệnh Máu

    //private const string ViewState_ThongtinBN.KhamBenh.KhamBenh_MauList = "KhamBenh_MauList";
    //public KhamBenh_MauList _ThongtinBN.KhamBenh.KhamBenh_MauList;
    ////{
    ////    get
    ////    {
    ////        //if (ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_MauList] == null)
    ////        //{
    ////        //    LoadDetails_KhamBenh_Mau();
    ////        //}
    ////        return (KhamBenh_MauList)_ThongtinBN.KhamBenh.KhamBenh_MauList;

    ////      //  return (KhamBenh_MauList)ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_MauList];
    ////    }
    ////    set
    ////    {
    ////    }
    ////    //set
    ////    //{
    ////    //    ViewState[ViewState_ThongtinBN.KhamBenh.KhamBenh_MauList] = value;
    ////    //}

    ////}
    //#endregion




    //#region index
    //private const string ViewState_ReportData1 = "ReportData1";

    //public DataSet ReportData1
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_ReportData1] != null)
    //        {
    //            return (DataSet)ViewState[ViewState_ReportData1];
    //        }

    //        return null;
    //    }

    //    set
    //    {
    //        ViewState[ViewState_ReportData1] = value;
    //    }
    //}
    //private const string ViewState_ReportData2 = "ReportData2";

    //public DataSet ReportData2
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_ReportData2] != null)
    //        {
    //            return (DataSet)ViewState[ViewState_ReportData2];
    //        }

    //        return null;
    //    }

    //    set
    //    {
    //        ViewState[ViewState_ReportData2] = value;
    //    }
    //}

    //private const string ViewState_ReportData3 = "ReportData3";

    //public DataSet ReportData3
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_ReportData3] != null)
    //        {
    //            return (DataSet)ViewState[ViewState_ReportData3];
    //        }

    //        return null;
    //    }

    //    set
    //    {
    //        ViewState[ViewState_ReportData3] = value;
    //    }
    //}

    //private const string ViewState_ReportData4 = "ReportData4";

    //public DataSet ReportData4
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_ReportData4] != null)
    //        {
    //            return (DataSet)ViewState[ViewState_ReportData4];
    //        }

    //        return null;
    //    }

    //    set
    //    {
    //        ViewState[ViewState_ReportData4] = value;
    //    }
    //}
    //private const string ViewState_ReportData5 = "ReportData5";

    //public DataSet ReportData5
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_ReportData5] != null)
    //        {
    //            return (DataSet)ViewState[ViewState_ReportData5];
    //        }

    //        return null;
    //    }

    //    set
    //    {
    //        ViewState[ViewState_ReportData5] = value;
    //    }
    //}
    //private const string ViewState_ReportData6 = "ReportData6";

    //public DataSet ReportData6
    //{
    //    get
    //    {
    //        if (ViewState[ViewState_ReportData6] != null)
    //        {
    //            return (DataSet)ViewState[ViewState_ReportData6];
    //        }

    //        return null;
    //    }

    //    set
    //    {
    //        ViewState[ViewState_ReportData6] = value;
    //    }
    //}
    //#endregion

    #region indextem
    private const string ViewState_MaSoKhamT = "MaSoKhamT";

    public string _MaSoKhamT
    {
        get
        {
            if (ViewState[ViewState_MaSoKhamT] == null)
                ViewState[ViewState_MaSoKhamT] = "";

            return (string)ViewState[ViewState_MaSoKhamT];
        }

        set
        {
            ViewState[ViewState_MaSoKhamT] = value;
        }

    }
    private const string ViewState_STTT = "STTT";

    public int _STTT
    {
        get
        {
            if (ViewState[ViewState_STTT] == null)
                ViewState[ViewState_STTT] = 1;
            return (int)ViewState[ViewState_STTT];
        }

        set
        {
            ViewState[ViewState_STTT] = value;
        }

    }
    private const string ViewState_Insert = "_Insert";

    public Boolean _Insert
    {
        get
        {
            if (ViewState[ViewState_Insert] == null)
                ViewState[ViewState_Insert] = false;
            return (Boolean)ViewState[ViewState_Insert];
        }

        set
        {
            ViewState[ViewState_Insert] = value;
        }

    }
    private const string ViewState_Update = "_Update";

    public Boolean _Update
    {
        get
        {
            if (ViewState[ViewState_Update] == null)
                ViewState[ViewState_Update] = false;
            return (Boolean)ViewState[ViewState_Update];
        }

        set
        {
            ViewState[ViewState_Update] = value;
        }

    }
    #endregion
    #region 0. thongtinbn
    private void LoadDetails_ThongTin(Boolean _load = true)
    {
        if (_load == false) return;

        if (_ThongtinBN != null)
        {
            if (_LoaiPhieu == 1)
            {
                if ((HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "HH") && _ThongtinBN.IsNew == true)
                {
                    _ThongtinBN.KhamBenh.LoaiKham = 0;
                    cboLoaiBN.SelectedValue = "0";
                }
                else if ((HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "HH") && _ThongtinBN.IsNew == false && _ThongtinBN.KhamBenh.IsNew == true)
                {

                    if (cboLoaiBN.SelectedValue == "0")
                    {
                        _ThongtinBN.KhamBenh.LoaiKham = 1;
                        cboLoaiBN.SelectedValue = "1";
                    }
                    else
                    {
                        // _ThongtinBN.KhamBenh.LoaiKham = byte.Parse(cboLoaiBN.SelectedValue);
                        _ThongtinBN.KhamBenh.LoaiKham = (cboLoaiBN.SelectedValue == "" ? byte.Parse("0") : byte.Parse(cboLoaiBN.SelectedValue));

                        cboLoaiBN.SelectedValue = _ThongtinBN.KhamBenh.LoaiKham.ToString();
                    }
                }


            }
            txtmabn.Text = _ThongtinBN.MaBN;
            dtNgaySinh.Text = _ThongtinBN.NgaySinh;
            DateTime date = DateTime.ParseExact(_ThongtinBN.KhamBenh.NgayDK, "d/M/yyyy", null);

            //dtNgayDK.Text = _ThongtinBN.KhamBenh.NgayDK;
            dtNgayDK.Text = date.ToString("dd/MM/yyyy");
            if (_ThongtinBN.KhamBenh.Gio != "")
                dtgio.Text = _ThongtinBN.KhamBenh.Gio;

            txthoten.Text = _ThongtinBN.Hoten;
           // dtNgayMienCCT.Text = _ThongtinBN.NgayMienCCT;
            txtDTDD.Text = _ThongtinBN.DTDD;
            txtDTCQ.Text = _ThongtinBN.DTCQ;
            txtNoiLamViec.Text = _ThongtinBN.NoiLamViec;
            if (HTC.ShareVariables.pub_spC == "QN")
                txtNoiLV.Text = _ThongtinBN.NoiLamViec;
            txtGhiChuHD.Text = _ThongtinBN.KhamBenh.Ghichu;
            if (_ThongtinBN.MaBN == "")
            {
                if ((HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "HH"))
                {
                    _ThongtinBN.GT = false;
                    optGT.Items[1].Selected = true;
                    optGT.Items[0].Selected = false;
                }
            }
            else
            {

                if (_ThongtinBN.GT == true)
                {
                    optGT.Items[0].Selected = true;
                    optGT.Items[1].Selected = false;
                }
                else
                {
                    optGT.Items[1].Selected = true;
                    optGT.Items[0].Selected = false;
                }

            }

            txtDiaChi.Text = _ThongtinBN.DiaChi;
            txtBaoTin.Text = _ThongtinBN.BaoTin;
            txtdienthoai.Text = _ThongtinBN.DienThoai;
            txttuoi.Text = _ThongtinBN.Tuoi.ToString();
            txtMaBAQL.Text = _ThongtinBN.MaBAQL;
            //if (_ThongtinBN.MaQG != "")
            //{
            //    RadComboBoxItem selectedItem = new RadComboBoxItem();
            //    if (_ThongtinBN.TenQG == "")
            //    {
            //        HTC.Business.CategoryList.DMQuocGiaListcb list = odsquocgia.Select() as HTC.Business.CategoryList.DMQuocGiaListcb;
            //        if (list != null)
            //            selectedItem.Text = list.FirstOrDefault(X => X.Key == _ThongtinBN.MaQG).Value;
            //        list = null;

            //    }
            //    else
            //        selectedItem.Text = _ThongtinBN.TenQG;
            //    selectedItem.Value = _ThongtinBN.MaQG;
            //    cboquocgia.Items.Add(selectedItem);
            //    selectedItem.Selected = true;
            //    selectedItem.DataBind();
            //    cboquocgia.DataBind();
            //}
            if (_ThongtinBN.MaQG == "00084")
            {
                cboquocgia.Text = "Việt Nam";
                cboquocgia.SelectedValue = "00084";
            }
            else
            {
                cboquocgia.Text = _ThongtinBN.TenQG;
                cboquocgia.SelectedValue = _ThongtinBN.MaQG;
            }
            if (_ThongtinBN.MaTinh != "")
            {
                cbotinh.Text = _ThongtinBN.TenTinh;
                cbotinh.SelectedValue = _ThongtinBN.MaTinh;

            }
            //else if (_ThongtinBN.IsNew ==false)
            //{
            //    cbotinh.Text = "";
            //    cbotinh.SelectedValue = "";

            //}

            if (_ThongtinBN.MaHuyen != "")
            {
                cbohuyen.Text = _ThongtinBN.TenQH;
                cbohuyen.SelectedValue = _ThongtinBN.MaHuyen;

            }

            if (_ThongtinBN.MaPXa != "")
            {
                cboPXa.Text = _ThongtinBN.TenPXa;
                cboPXa.SelectedValue = _ThongtinBN.MaPXa;

            }
            if (_ThongtinBN.MaNN != "")
            {
                cboNgheNghiep.Text = _ThongtinBN.TenNN;
                cboNgheNghiep.SelectedValue = _ThongtinBN.MaNN;

            }
            if (_ThongtinBN.madantoc != "")
            {
                cboDanToc.Text = DMDantoc.GetDMDantoc(_ThongtinBN.madantoc).TenDanToc;
                cboDanToc.SelectedValue = _ThongtinBN.madantoc;

            }
            //if (_ThongtinBN.MaTinh != "")
            //{
            //    RadComboBoxItem selectedItem = new RadComboBoxItem();

            //    selectedItem.Text = _ThongtinBN.TenTinh;
            //    selectedItem.Value = _ThongtinBN.MaTinh;
            //    cbotinh.Items.Add(selectedItem);
            //    selectedItem.Selected = true;
            //    selectedItem.DataBind();
            //    cbotinh.DataBind();
            //}

            //  if (_ThongtinBN.MaHuyen != "")
            //{
            //    RadComboBoxItem selectedItem = new RadComboBoxItem();

            //    selectedItem.Text = _ThongtinBN.TenQH;
            //    selectedItem.Value = _ThongtinBN.MaHuyen;
            //    cbohuyen.Items.Add(selectedItem);
            //    selectedItem.Selected = true;
            //    selectedItem.DataBind();
            //    cbohuyen.DataBind();
            //}

            //if (_ThongtinBN.MaNN != "")
            //{
            //    RadComboBoxItem selectedItem = new RadComboBoxItem();

            //    selectedItem.Text = _ThongtinBN.TenNN;
            //    selectedItem.Value = _ThongtinBN.MaNN;
            //    cboNgheNghiep.Items.Add(selectedItem);
            //    selectedItem.Selected = true;
            //    selectedItem.DataBind();
            //    cboNgheNghiep.DataBind();
            //}

            if (_MaSoKham == "")
            {
                _ThongtinBN.KhamBenh.MaDT = _ThongtinBN.MaDT;
                _ThongtinBN.KhamBenh.Sothe = _ThongtinBN.Sothe;
                if (!(_NoiTT == "095" && _LoaiPhieu == 1))
                {
                    _ThongtinBN.KhamBenh.GiatriDN = _ThongtinBN.GiaTriDN;
                    _ThongtinBN.KhamBenh.GiaTriTN = _ThongtinBN.GiaTriTN;
                }
                _ThongtinBN.KhamBenh.MaBV = _ThongtinBN.MaBV;
                _ThongtinBN.KhamBenh.mabhxh = _ThongtinBN.mabhxh;
                _ThongtinBN.KhamBenh.tenbv = _ThongtinBN.tenbv;
            }
            if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
            {
                if (_ThongtinBN.KhamBenh.KhamBenh_C_List[0].Machuyenkhoa != "")
                    cboChuyenKhoa.SelectedValue = _ThongtinBN.KhamBenh.KhamBenh_C_List[0].Machuyenkhoa;
            }
            cboLoaiBN.SelectedValue = _ThongtinBN.KhamBenh.LoaiKham.ToString();

            if (_MaBN != "")
            {
                if (_PubMaDT == "CR")
                {
                    _ThongtinBN.KhamBenh.MaDT = "00007";
                    _ThongtinBN.MaDT = "00007";
                }
                cboDoiTuong.SelectedValue = _ThongtinBN.KhamBenh.MaDT;

                txtSoThe.Text = _ThongtinBN.KhamBenh.Sothe;

                dtBHYTTN.Text = _ThongtinBN.KhamBenh.GiaTriTN;
                dtBHYTDN.Text = _ThongtinBN.KhamBenh.GiatriDN;
                if (_NoiTT == "095" && _LoaiPhieu == 1)
                {
                    dtCSDenNgay.Text = _ThongtinBN.KhamBenh.GiatriDN;
                    dtCSTuNgay.Text = _ThongtinBN.KhamBenh.GiaTriTN;
                }
                dtNgayGT.Text = _ThongtinBN.KhamBenh.NgayGT;
                if (_LoaiPhieu == 8)
                    txtkyquy.Text = _ThongtinBN.KhamBenh.KyQuyBH;
                if (_ThongtinBN.KhamBenh.MaBV != "")
                {
                    //  RadComboBoxItem selectedItem = new RadComboBoxItem();

                    cboDKBD.Text = _ThongtinBN.KhamBenh.tenbv;
                    cboDKBD.SelectedValue = _ThongtinBN.KhamBenh.MaBV;
                    //cboDKBD.Items.Add(selectedItem);
                    //selectedItem.Selected = true;
                    //selectedItem.DataBind();
                    //   cboDKBD.DataBind();
                    txtDKBD.Text = _ThongtinBN.KhamBenh.mabhxh;
                }
                if (_ThongtinBN.KhamBenh.MaBVGT != "")
                {
                    //  RadComboBoxItem selectedItem = new RadComboBoxItem();

                    cboDKGT.Text = _ThongtinBN.KhamBenh.TenBVGT;
                    cboDKGT.SelectedValue = _ThongtinBN.KhamBenh.MaBVGT;
                    //cboDKBD.Items.Add(selectedItem);
                    //selectedItem.Selected = true;
                    //selectedItem.DataBind();
                    //   cboDKBD.DataBind();
                    txtDKGT.Text = _ThongtinBN.KhamBenh.MABHXHGT;
                }

                //if (_ThongtinBN.KhamBenh.MaBV != "")
                //{
                //    RadComboBoxItem selectedItem = new RadComboBoxItem();

                //    selectedItem.Text = _ThongtinBN.KhamBenh.mabhxh;
                //    selectedItem.Value = _ThongtinBN.KhamBenh.MaBV;
                //    cboDKBD.Items.Add(selectedItem);
                //    selectedItem.Selected = true;
                //    selectedItem.DataBind();
                //    //   cboDKBD.DataBind();
                //    txtDKBD.Text = _ThongtinBN.KhamBenh.tenbv;
                //}
                //if (_ThongtinBN.KhamBenh.MaBVGT != "")
                //{
                //    RadComboBoxItem selectedItem = new RadComboBoxItem();

                //    selectedItem.Text = _ThongtinBN.KhamBenh.mabhxh;
                //    selectedItem.Value = _ThongtinBN.KhamBenh.MaBVGT;
                //    cboDKGT.Items.Add(selectedItem);
                //    selectedItem.Selected = true;
                //    selectedItem.DataBind();
                //    // cboDKGT.DataBind();
                //    txtDKGT.Text = _ThongtinBN.KhamBenh.TenBVGT;
                //}
                if (_ThongtinBN.KhamBenh.MaBenhNoiGT != "")
                {
                    // RadComboBoxItem selectedItem = new RadComboBoxItem();

                    cboCDnoiGT.Text = _ThongtinBN.KhamBenh.maicdngt;
                    cboCDnoiGT.SelectedValue = _ThongtinBN.KhamBenh.MaBenhNoiGT;
                    // cboCDnoiGT.Items.Add(selectedItem);
                    // selectedItem.Selected = true;
                    // selectedItem.DataBind();
                    //cboCDnoiGT.DataBind();
                }
                txtBenhNGT.Text = _ThongtinBN.KhamBenh.tenbenhngt;

                cboLoaiBN.SelectedValue = _ThongtinBN.KhamBenh.LoaiKham.ToString();
                dtNgayQT.Text = _ThongtinBN.KhamBenh.NgayQT;
            }

        }
        if (_ThongtinBN.IsNew == false && Pub_bQuyenForm < HTC.ShareVariables.KieuFormChiTiet.fSua)
        {

            txthoten.Enabled = false;
            txttuoi.Enabled = false;
            optGT.Enabled = false;
            dtNgaySinh.Enabled = false;
            cboquocgia.Enabled = false;
            cbotinh.Enabled = false;
            cbohuyen.Enabled = false;
            txtBaoTin.Enabled = false;
            txtDiaChi.Enabled = false;
            txtdienthoai.Enabled = false;
            cboNgheNghiep.Enabled = false;
            cboDanToc.Enabled = false;
            txtMaBAQL.Enabled = false;
        }
        if (_ThongtinBN.KhamBenh.MaBN != "" && Pub_bQuyenForm < HTC.ShareVariables.KieuFormChiTiet.fSua)
        {
            txtSoThe.Enabled = false;

            cboDoiTuong.Enabled = false;
            dtBHYTTN.Enabled = false;
            dtBHYTDN.Enabled = false;
            cboDKBD.Enabled = false;
            cboDKGT.Enabled = false;
            txtDKBD.Enabled = false;
            txtDKGT.Enabled = false;
            cboCDnoiGT.Enabled = false;
            txtBenhNGT.Enabled = false;
            dtNgayGT.Enabled = false;
        }
        //if (cboLoaiBN.SelectedValue == "")
        //{
        //    cboLoaiBN.SelectedValue = "0";
        //}


    }


    #endregion
    #region 0.CTT
    private void LoadDetails_KhamBenh_CTT(Boolean _load = true)
    {


        if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList != null)
        {
            grdCTT.DataSource = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList;
            grdCTT.Visible = true;
            if (_LoaiPhieu == 2 && HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
            {
                grdCTT.MasterTableView.GetColumn("ThanhTien").Display = true;
                grdCTT.MasterTableView.GetColumn("BHTinhTien").Display = false;
            }
            else if (_LoaiPhieu == 1 && _Duyet == 1)
                grdCTT.MasterTableView.GetColumn("ThanhTien").Display = false;
            else if (_LoaiPhieu == 1 && cboDoiTuong.SelectedValue.Substring(0, 1) == "1")
                grdCTT.MasterTableView.GetColumn("ThanhTien").Display = false;
            else if (_LoaiPhieu == 1 && cboDoiTuong.SelectedValue.Substring(0, 1) == "1")
                grdCTT.MasterTableView.GetColumn("ThanhTien").Display = false;
            else if (_LoaiPhieu != 2)
            {
                grdCTT.MasterTableView.GetColumn("ThanhTienBH").Display = false;
                grdCTT.MasterTableView.GetColumn("BHTinhTien").Display = false;
            }
            if ((_LoaiPhieu == 2 || _LoaiPhieu == 7) && HTC.ShareVariables.pub_spC == "YH")
                if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count > 0)
                {
                    lblSothang.Text = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList[0].SLThang.ToString() + " thang";
                }

            if (_LoaiPhieu == 1 && _Duyet == 1)
            {
                // grdCTT.MasterTableView.FilterExpression = " ISNULL(DUYETBH,0) = 0";

                foreach (GridDataItem dataItem in grdCTT.MasterTableView.Items)
                {
                    (dataItem.FindControl("Chkbox") as CheckBox).Checked = dataItem["DuyetBH"].Text == "True" ? true : false;
                }
            }
            if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
            {
                foreach (KhamBenh_C kb in _ThongtinBN.KhamBenh.KhamBenh_C_List)

                    if (kb.Machuyenkhoa != "")
                    {
                        cboChuyenKhoa.SelectedValue = kb.Machuyenkhoa;
                        break;
                    }
            }
            tinhlaihd();
            try
            {

                grdCTT.DataBind();
            }

            catch (Exception ex)
            { }
        }


    }
    #endregion

    #region 1. Đã TT
    private void LoadDetails_KhamBenh_DTT(Boolean _load = true)
    {


        if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList != null)
        {
            grdDTT.DataSource = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList;
            grdDTT.Visible = true;
            if (_LoaiPhieu == 2)
                grdCTT.MasterTableView.GetColumn("ThanhTien").Display = false;
            else if (_LoaiPhieu == 1 && _Duyet == 1)
                grdCTT.MasterTableView.GetColumn("ThanhTien").Display = false;
            else if (_LoaiPhieu == 1 && cboDoiTuong.SelectedValue.Substring(0, 1) == "1")
                grdCTT.MasterTableView.GetColumn("ThanhTien").Display = false;
            else if (_LoaiPhieu == 1 && cboDoiTuong.SelectedValue.Substring(0, 1) == "1")
                grdCTT.MasterTableView.GetColumn("ThanhTien").Display = false;

            else
            {
                grdCTT.MasterTableView.GetColumn("ThanhTienBH").Display = false;
                grdCTT.MasterTableView.GetColumn("BHTinhTien").Display = false;
            }
            try
            {

                grdDTT.DataBind();
            }
            catch (Exception ex)
            { }

        }


    }

    #endregion

    #region 2. Khám bệnh XN.TT.XQ.TDCN
    private KhamBenh_C Supports_KhamBenh_C(string madv, DMDichVu_Gia_DT _DMDichVu_Gia, GridEditableItem item)
    {
        KhamBenh_C _KhamBenh_C = KhamBenh_C.NewKhamBenh_C();
        RadComboBox combo = null;
        _KhamBenh_C.BHTinhtien = _DMDichVu_Gia.DTBH;

        _KhamBenh_C.MaBN = _ThongtinBN.MaBN;

        if (cboLoaiBN.SelectedValue == "10" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN") && _LoaiPhieu == 1)
        {
            _KhamBenh_C.DaTT = 3;
            _KhamBenh_C.DaTTTT = 3;
        }
        if (cboKhoaKB.SelectedValue != "")
        {
            _KhamBenh_C.makhoacd = cboKhoaKB.SelectedValue;
        }
        else
        {
            _KhamBenh_C.makhoacd = _MaKhoa;
        }
        if (item != null)
            combo = ((RadComboBox)item["MaKhoa"].FindControl("cboKhoa"));
        if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
        {
            _KhamBenh_C.bschidinh = cboNhanVien.SelectedValue;
            _KhamBenh_C.tenbschidinh = cboNhanVien.Text;

        }
        if (cboChanDoan.Text != "")
        {
            _KhamBenh_C.Mabenh = cboChanDoan.SelectedValue;
            _KhamBenh_C.maicd = cboChanDoan.Text;
        }

        _KhamBenh_C.NgayDK = dtNgayDK.Text;
        _KhamBenh_C.NoiTTBH = _NoiTT;
        _KhamBenh_C.NoiTTTT = _NoiTT;
        if (_KhamBenh_C.NoiTTTT == "087" || _KhamBenh_C.NoiTTTT == "095")
        {
            _KhamBenh_C.Makhoa = _DMDichVu_Gia.makhoa087;
            _KhamBenh_C.tenkhoa = _DMDichVu_Gia.tenkhoa087;
        }
        else if (_KhamBenh_C.NoiTTTT == "093")
        {
            _KhamBenh_C.Makhoa = _DMDichVu_Gia.makhoaNG;
            _KhamBenh_C.tenkhoa = _DMDichVu_Gia.tenkhoaNG;
        }
        else
        {
            _KhamBenh_C.Makhoa = _DMDichVu_Gia.makhoa;
            _KhamBenh_C.tenkhoa = _DMDichVu_Gia.tenkhoa;
        }
        if (_KhamBenh_C.Makhoa == "")
        {
            _KhamBenh_C.Makhoa = cboKhoaKB.SelectedValue;
            _KhamBenh_C.tenkhoa = cboKhoaKB.Text;
        }
        if (combo != null)
            if (combo.SelectedValue != "")
            {
                _KhamBenh_C.Makhoa = combo.SelectedValue;
                _KhamBenh_C.tenkhoa = combo.Text;
            }
        _KhamBenh_C.MaDT = cboDoiTuong.SelectedValue;
        _KhamBenh_C.CK = "0";

        _KhamBenh_C.DonGiaBH = _DMDichVu_Gia.Dongia == "" ? "0" : _DMDichVu_Gia.Dongia;
        _KhamBenh_C.DongiaTT = _DMDichVu_Gia.dongiatt == "" ? "0" : _DMDichVu_Gia.dongiatt;
        _KhamBenh_C.inthu = _DMDichVu_Gia.inthu;
        _KhamBenh_C.tentat = _DMDichVu_Gia.tentat;
        if (_DMDichVu_Gia.ADPhongMo > 1)
            _KhamBenh_C.BHTinhtien = false;
        else if (_DMDichVu_Gia.ADPhongMo == 2)
            _KhamBenh_C.BHTinhtien = false;

        if (_DMDichVu_Gia.ADChenhlech == true)
            _KhamBenh_C.GiaChenhLech = _DMDichVu_Gia.GiaChenhlenh == "" ? "0" : _DMDichVu_Gia.GiaChenhlenh;
        else
            _KhamBenh_C.GiaChenhLech = "0";

        _KhamBenh_C.MaDV = _DMDichVu_Gia.MaDV;
        _KhamBenh_C.TenTM = _DMDichVu_Gia.TenDV;

        _KhamBenh_C.MaMay = Pub_sMaMay;
        _KhamBenh_C.NguoiLap = Pub_sNguoiSD; _KhamBenh_C.NguoiSD = Pub_sNguoiSD;

        _KhamBenh_C.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;

        _KhamBenh_C.MaBN = _ThongtinBN.MaBN;
        _KhamBenh_C.Tinhtien = false;

        return _KhamBenh_C;
    }
    private void LoadDetails_KhamBenh_XNTT(Boolean _load = true)
    {


        if (_ThongtinBN.KhamBenh.KhamBenh_C_List != null)
        {
            grdXNTT.DataSource = _ThongtinBN.KhamBenh.KhamBenh_C_List;

            try
            {
                grdXNTT.MasterTableView.IsItemInserted = true;
                grdXNTT.DataBind();
                if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                {
                    KhamBenh_C kb = _ThongtinBN.KhamBenh.KhamBenh_C_List[0];
                    if (HTC.ShareVariables.pub_spC != "HU" || HTC.ShareVariables.pub_spC != "QN" || HTC.ShareVariables.pub_spC != "PH")
                    {
                        if (kb.makhoacd != "")
                        {
                            txtMaKhoa.Text = kb.makhoacd;
                            cboKhoaKB.SelectedValue = kb.makhoacd;
                            cboKhoaKB.Text = kb.tenkhoacd;
                        }
                        if (kb.bschidinh != "")
                        {
                            txtMaNV.Text = kb.bschidinh;
                            cboNhanVien.SelectedValue = kb.bschidinh;
                            cboNhanVien.Text = kb.tenbschidinh;
                        }
                        if (kb.Mabenh != "")
                        {
                            txtChanDoan.Text = kb.tenbenh;
                            cboChanDoan.SelectedValue = kb.Mabenh;
                            cboChanDoan.Text = kb.maicd;
                        }
                        if (_NoiTT == "095")
                        {
                            txtChanDoan.Text = kb.tenbenh;
                        }
                    }
                    if (kb.Machuyenkhoa != "")
                    {

                        cboChuyenKhoa.SelectedValue = kb.Machuyenkhoa;

                    }
                }
                else if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0)
                {
                    GridEditableItem editedItem = grdXNTT.MasterTableView.GetInsertItem();

                    RadComboBox combo = (RadComboBox)editedItem.FindControl("cboDichVu");
                    combo.EnableLoadOnDemand = true;
                    combo.EnableAutomaticLoadOnDemand = true;
                    combo.CheckBoxes = false;
                }

            }
            catch (Exception ex)
            { }

        }


    }

    #endregion
    #region 3 Khám bệnh Thuốc Tây Y
    private KhamBenh_ThuocSD Supports_KhamBenh_ThuocSD(string _MaThuoc, DMThuocKhoa _DMThuoc_Gia)
    {
        KhamBenh_ThuocSD _KhamBenh_ThuocSD = KhamBenh_ThuocSD.NewKhamBenh_ThuocSD();

        _KhamBenh_ThuocSD.BHTinhtien = _DMThuoc_Gia.DTBH;
        _KhamBenh_ThuocSD.MaMay = Pub_sMaMay;
        _KhamBenh_ThuocSD.NguoiLap = Pub_sNguoiSD; _KhamBenh_ThuocSD.NguoiSD = Pub_sNguoiSD;
        _KhamBenh_ThuocSD.MaBN = _ThongtinBN.MaBN;
        _KhamBenh_ThuocSD.Makhoa = _MaKhoa;
        _KhamBenh_ThuocSD.NgayDK = _ThongtinBN.KhamBenh.NgayDK;
        _KhamBenh_ThuocSD.NoiTTBH = _NoiTT;
        _KhamBenh_ThuocSD.NoiTTTT = _NoiTT;
        _KhamBenh_ThuocSD.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : (_NoiTT == "085" ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003")));
        _KhamBenh_ThuocSD.CK = "0";
        if (cboBSTayY.SelectedValue != "" && cboBSTayY.SelectedValue != "0")
        {
            _KhamBenh_ThuocSD.BSChiDinh = cboBSTayY.SelectedValue;
            _KhamBenh_ThuocSD.tenbschidinh = cboBSTayY.Text;

        }
        _KhamBenh_ThuocSD.DonGiaBH = _DMThuoc_Gia.DonGiaBH == "" ? "0" : _DMThuoc_Gia.DonGiaBH;
        _KhamBenh_ThuocSD.DongiaTT = _DMThuoc_Gia.DonGiaTT == "" ? "0" : _DMThuoc_Gia.DonGiaTT;
        if (_DMThuoc_Gia.adphongmo > 1)
            _KhamBenh_ThuocSD.BHTinhtien = false;
        else if (_DMThuoc_Gia.adphongmo == 2)
            _KhamBenh_ThuocSD.BHTinhtien = false;

        if (_DMThuoc_Gia.ADChenhLech == true)
            _KhamBenh_ThuocSD.GiaChenhLech = _DMThuoc_Gia.GiaChenhlech == "" ? "0" : _DMThuoc_Gia.GiaChenhlech;
        else
            _KhamBenh_ThuocSD.GiaChenhLech = "0";

        _KhamBenh_ThuocSD.Mathuoc = _DMThuoc_Gia.MaThuoc;
        _KhamBenh_ThuocSD.TenTM = _DMThuoc_Gia.TenTM;


        _KhamBenh_ThuocSD.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;

        _KhamBenh_ThuocSD.MaBN = _ThongtinBN.MaBN;
        _KhamBenh_ThuocSD.Tinhtien = false;

        return _KhamBenh_ThuocSD;
    }

    private void LoadDetails_KhamBenh_ThuocSuDung(Boolean _load = true, Boolean _goi = false)
    {

        if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList != null)
        {
            if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count > 0)
            {
                KhamBenh_ThuocSD kb = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList[0];

                if (kb.BSChiDinh != "")
                {
                    txtBSTayY.Text = kb.BSChiDinh;
                    cboBSTayY.SelectedValue = kb.BSChiDinh;
                    cboBSTayY.Text = kb.tenbschidinh;
                }
            }
            grdThuoc.DataSource = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList;

            try
            {
                grdThuoc.MasterTableView.IsItemInserted = true;
                grdThuoc.DataBind();
            }
            catch (Exception ex)
            { }

        }

    }
    #endregion

    #region 4. Khám bệnh Thuốc Thang -  Thuốc Đông Y
    private KhamBenh_ThuocSD_DY_C Supports_KhamBenh_ThuocSD_DY(string _MaThuoc, DMThuocKhoa _DMThuoc_Gia)
    {
        KhamBenh_ThuocSD_DY_C _KhamBenh_ThuocSD = KhamBenh_ThuocSD_DY_C.NewKhamBenh_ThuocSD_DY_C();

        _KhamBenh_ThuocSD.BHTinhtien = _DMThuoc_Gia.DTBH;


        _KhamBenh_ThuocSD.CK = 0;
        _KhamBenh_ThuocSD.QuyDoi = _DMThuoc_Gia.quydoi;
        _KhamBenh_ThuocSD.MaMay = Pub_sMaMay;
        _KhamBenh_ThuocSD.NguoiSD = Pub_sNguoiSD;
        _KhamBenh_ThuocSD.DongiaBH = _DMThuoc_Gia.DonGiaBH == "" ? "0" : _DMThuoc_Gia.DonGiaBH;
        _KhamBenh_ThuocSD.DongiaTT = _DMThuoc_Gia.DonGiaTT == "" ? "0" : _DMThuoc_Gia.DonGiaTT;
        if (_DMThuoc_Gia.adphongmo > 1)
            _KhamBenh_ThuocSD.BHTinhtien = false;
        else if (_DMThuoc_Gia.adphongmo == 2)
            _KhamBenh_ThuocSD.BHTinhtien = false;

        if (_DMThuoc_Gia.ADChenhLech == true)
            _KhamBenh_ThuocSD.GiaChenhLech = _DMThuoc_Gia.GiaChenhlech == "" ? "0" : _DMThuoc_Gia.GiaChenhlech;
        else
            _KhamBenh_ThuocSD.GiaChenhLech = "0";

        _KhamBenh_ThuocSD.Mathuoc = _DMThuoc_Gia.MaThuoc;
        _KhamBenh_ThuocSD.TenTM = _DMThuoc_Gia.TenTM;


        _KhamBenh_ThuocSD.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
        _KhamBenh_ThuocSD.Tinhtien = false;

        return _KhamBenh_ThuocSD;
    }

    private void Supports_KhamBenh_ThuocSD_DY()
    {
        KhamBenh_ThuocSD_DY _KhamBenh_ThuocSD_DYTT = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
        KhamBenh_ThuocSD_DY_CList _KhamBenh_ThuocSD_DY_CList = _KhamBenh_ThuocSD_DYTT.KhamBenh_ThuocSD_DY_Cs;
        _KhamBenh_ThuocSD_DYTT.MaKhoa = _MaKhoa;
        _KhamBenh_ThuocSD_DYTT.MaBN = _ThongtinBN.MaBN;
        _KhamBenh_ThuocSD_DYTT.NoiTTBH = _NoiTT;
        _KhamBenh_ThuocSD_DYTT.NoiTTTT = _NoiTT;
        _KhamBenh_ThuocSD_DYTT.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : ((_NoiTT == "085" || _NoiTT == "090") ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003"))); ;
        _KhamBenh_ThuocSD_DYTT.Tinhtien = true;
        _KhamBenh_ThuocSD_DYTT.MaMay = Pub_sMaMay;
        _KhamBenh_ThuocSD_DYTT.NguoiLap = Pub_sNguoiSD;
        _KhamBenh_ThuocSD_DYTT.NgayDK = _ThongtinBN.KhamBenh.NgayDK;
        if (cboBSDongY.SelectedValue != "" && cboBSDongY.SelectedValue != "0")
        {
            _KhamBenh_ThuocSD_DYTT.BSChiDinh = cboBSDongY.SelectedValue;
            _KhamBenh_ThuocSD_DYTT.TenBSChidinh = cboBSDongY.Text;

        }

        _KhamBenh_ThuocSD_DYTT.MaBN = _ThongtinBN.MaBN;
        if (_KhamBenh_ThuocSD_DY == null)
            _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();

        foreach (KhamBenh_ThuocSD_DY_C tmp4 in _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs)
        {

            KhamBenh_ThuocSD_DY_C _KhamBenh_ThuocSD_DY_C = KhamBenh_ThuocSD_DY_C.NewKhamBenh_ThuocSD_DY_C();

            _KhamBenh_ThuocSD_DY_C.BHTinhtien = tmp4.BHTinhtien;



            _KhamBenh_ThuocSD_DY_C.CK = 0;

            _KhamBenh_ThuocSD_DY_C.DongiaBH = tmp4.DongiaBH;
            _KhamBenh_ThuocSD_DY_C.DongiaTT = tmp4.DongiaTT;


            _KhamBenh_ThuocSD_DY_C.GiaChenhLech = "0";

            _KhamBenh_ThuocSD_DY_C.Mathuoc = tmp4.Mathuoc;
            _KhamBenh_ThuocSD_DY_C.TenTM = tmp4.TenTM;
            _KhamBenh_ThuocSD_DY_C.QuyDoi = tmp4.QuyDoi;
            _KhamBenh_ThuocSD_DY_C.SoLuongD = tmp4.SoLuongD;
            _KhamBenh_ThuocSD_DY_C.SLKeDon = tmp4.SLKeDon;
            _KhamBenh_ThuocSD_DY_C.SLMua = tmp4.SLMua;
            _KhamBenh_ThuocSD_DY_C.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
            _KhamBenh_ThuocSD_DY_C.Tinhtien = false;

            if (_KhamBenh_ThuocSD_DY_CList.Count == 0)
                _KhamBenh_ThuocSD_DY_C.STTThuoc = 1;
            else
                _KhamBenh_ThuocSD_DY_C.STTThuoc = _KhamBenh_ThuocSD_DY_CList[_KhamBenh_ThuocSD_DY_CList.Count - 1].STTThuoc + 1;

            _KhamBenh_ThuocSD_DY_CList.AssignTo(_KhamBenh_ThuocSD_DY_C);


        }
        _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.AssignTo(_KhamBenh_ThuocSD_DYTT);


    }


    private void LoadDetails_KhamBenh_ThuocThangList(Boolean _load = true, Boolean _goi = false)
    {
        if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList == null)
            return;
        if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count > 0)
        {
            grdDanhSachDY.DataSource = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList;

            try
            {
                grdDanhSachDY.DataBind();
            }
            catch (Exception ex)
            { }
            grdDanhSachDY.Visible = true;
            _KhamBenh_ThuocSD_DY = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList[0];
            txtSLThang.Text = _KhamBenh_ThuocSD_DY.SLMua;
            //RadComboBoxItem selectedItemh = new RadComboBoxItem();

            //selectedItemh.Text = _KhamBenh_ThuocSD_DY.TenBSChidinh;
            //selectedItemh.Value = _KhamBenh_ThuocSD_DY.BSChiDinh;
            //cboBSDongY.Items.Add(selectedItemh);
            //selectedItemh.Selected = true;
            //selectedItemh.DataBind();
            //cboBSDongY.DataBind();
            cboBSDongY.Text = _KhamBenh_ThuocSD_DY.TenBSChidinh;
            cboBSDongY.SelectedValue = _KhamBenh_ThuocSD_DY.BSChiDinh;

            grdThuocDY.DataSource = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
            grdThuocDY.DataBind();
            grdThuocDY.Height = 200;

        }
        else
            grdDanhSachDY.Visible = false;

    }
    private void LoadDetails_KhamBenh_ThuocThang(Boolean _load = true, Boolean _goi = false, string _masokham = "", byte _stt = 0)
    {
        KhamBenh _KhamBenh = _ThongtinBN.KhamBenh;
        //if (_goi == true)
        //{
        //    _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
        //    KhamBenh_ThuocSD_DY_CList _KhamBenh_ThuocSD_DY_CList = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
        //    DMThuocKhoaList _bagl = DMThuocKhoaList.FindDMThuocKhoaBThuoc(_MaKhoa, _ThongtinBN.KhamBenh.MaDT, 3, cboGoiDY.SelectedValue);
        //    _KhamBenh_ThuocSD_DY.MaKhoa = _MaKhoa;
        //    _KhamBenh_ThuocSD_DY.MaBN = _ThongtinBN.MaBN;
        //    _KhamBenh_ThuocSD_DY.NoiTTBH = _NoiTT;
        //    _KhamBenh_ThuocSD_DY.NoiTTTT = _NoiTT;
        //    if (cboBSDongY.SelectedValue != "" && cboBSDongY.SelectedValue != "0")
        //    {
        //        _KhamBenh_ThuocSD_DY.BSChiDinh = cboBSDongY.SelectedValue;
        //        _KhamBenh_ThuocSD_DY.TenBSChidinh = cboBSDongY.Text;

        //    }
        //    _KhamBenh_ThuocSD_DY.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : (_NoiTT == "085" ? "00001" : (_NoiTT == "087" ? "00002" : "00003"))); ;
        //    if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count == 0)
        //        _KhamBenh_ThuocSD_DY.STT = 1;
        //    else
        //        _KhamBenh_ThuocSD_DY.STT = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList[_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count - 1].STT + 1;

        //    _KhamBenh_ThuocSD_DY.NgayDK = _ThongtinBN.KhamBenh.NgayDK;


        //    _KhamBenh_ThuocSD_DY.MaBN = _ThongtinBN.MaBN;
        //    foreach (DMThuocKhoa tmp4 in _bagl)
        //    {
        //        Boolean addthuoc = true;
        //        foreach (KhamBenh_ThuocSD_DY_C bac in _KhamBenh_ThuocSD_DY_CList)
        //        {
        //            if (tmp4.MaThuoc == bac.MaThuoc)
        //            {


        //                addthuoc = false;
        //            }
        //        }
        //        if (addthuoc == true)
        //        {
        //            KhamBenh_ThuocSD_DY_C _bat = Supports_KhamBenh_ThuocSD_DY(tmp4.MaThuoc, tmp4);
        //            _bat.SLMua = tmp4.SoLuong.ToString();
        //            _bat.SLKeDon = tmp4.SoLuong.ToString();
        //            _bat.SoLuongD = (tmp4.SoLuong * tmp4.quydoi).ToString();

        //            _bat.STT = _KhamBenh_ThuocSD_DY.STT; 
        //            if (_KhamBenh_ThuocSD_DY_CList.Count == 0)
        //                _bat.STTThuoc = 1;
        //            else
        //                _bat.STTThuoc = _KhamBenh_ThuocSD_DY_CList[_KhamBenh_ThuocSD_DY_CList.Count - 1].STTThuoc + 1;
        //            _bat.OrderNumber = _bat.STTThuoc;
        //            _KhamBenh_ThuocSD_DY_CList.AssignTo(_bat);


        //        }
        //    }
        //    _KhamBenh_ThuocSD_DY.TinhLaiDon();
        //    txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
        //    txtTT.Value = (_KhamBenh_ThuocSD_DY.SLMua == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua)).ToString();

        //    _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.AssignTo(_KhamBenh_ThuocSD_DY);
        //    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.UpdatedTo(_KhamBenh_ThuocSD_DY);

        //    _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();

        //}
        //else 
        if (_masokham != "")
        {
            _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
            KhamBenh_ThuocSD_DY_CList _KhamBenh_ThuocSD_DY_CList = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
            DMThuocKhoaList _bagl = DMThuocKhoaList.FindDMThuocKhoaMaSoKhamDY(_MaKhoa, cboDoiTuong.SelectedValue, _masokham, _LoaiPhieu, _stt.ToString());


            _KhamBenh_ThuocSD_DY.MaKhoa = _MaKhoa;
            _KhamBenh_ThuocSD_DY.MaBN = _ThongtinBN.MaBN;
            _KhamBenh_ThuocSD_DY.NoiTTBH = _NoiTT;
            _KhamBenh_ThuocSD_DY.NoiTTTT = _NoiTT;
            _KhamBenh_ThuocSD_DY.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : ((_NoiTT == "085" || _NoiTT == "090") ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003")));

            _KhamBenh_ThuocSD_DY.NgayDK = _ThongtinBN.KhamBenh.NgayDK;
            if (cboBSDongY.SelectedValue != "" && cboBSDongY.SelectedValue != "0")
            {
                _KhamBenh_ThuocSD_DY.BSChiDinh = cboBSDongY.SelectedValue;
                _KhamBenh_ThuocSD_DY.TenBSChidinh = cboBSDongY.Text;

            }
            if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count == 0)
                _KhamBenh_ThuocSD_DY.STT = 1;
            else
                _KhamBenh_ThuocSD_DY.STT = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList[_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count - 1].STT + 1;


            foreach (DMThuocKhoa tmp4 in _bagl)
            {
                Boolean addthuoc = true;
                foreach (KhamBenh_ThuocSD_DY_C bac in _KhamBenh_ThuocSD_DY_CList)
                {

                    if (tmp4.MaThuoc == bac.Mathuoc)
                    {


                        addthuoc = false;
                    }
                }
                if (addthuoc == true)
                {
                    KhamBenh_ThuocSD_DY_C _bat = Supports_KhamBenh_ThuocSD_DY(tmp4.MaThuoc, tmp4);
                    _bat.SLMua = tmp4.SoLuong.ToString();
                    _bat.SLKeDon = tmp4.SoLuong.ToString();
                    _bat.SoLuongD = (tmp4.SoLuong * tmp4.quydoi).ToString();
                    _bat.STT = _KhamBenh_ThuocSD_DY.STT;
                    if (_KhamBenh_ThuocSD_DY_CList.Count == 0)
                        _bat.STTThuoc = 1;
                    else
                        _bat.STTThuoc = _KhamBenh_ThuocSD_DY_CList[_KhamBenh_ThuocSD_DY_CList.Count - 1].STTThuoc + 1;
                    _bat.OrderNumber = _bat.STTThuoc;
                    _KhamBenh_ThuocSD_DY_CList.AssignTo(_bat);
                }

            }
            _KhamBenh_ThuocSD_DY.TinhLaiDon();
            txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
            txtTT.Value = (_KhamBenh_ThuocSD_DY.SLMua == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua)).ToString();

            _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.AssignTo(_KhamBenh_ThuocSD_DY);

            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.NewTo(_KhamBenh_ThuocSD_DY);


            _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();
        }
        else if (_load == true)
            _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();


        txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
        txtTT.Value = (_KhamBenh_ThuocSD_DY.SLMua == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua)).ToString();

        if ((_LoaiPhieu != 1) || (_LoaiPhieu == 1 && _Duyet == 1))
            tinhlaihd();
        if (_KhamBenh_ThuocSD_DY.DaTTTT != 0 || _KhamBenh_ThuocSD_DY.DaTTBH != 0)
        {
            Label16.Text = "SL Trả";
            txtSLThang.Text = "";
            grdThuocDY.MasterTableView.GetColumn("Edit").Display = false;
            grdThuocDY.MasterTableView.GetColumn("Delete").Display = false;

        }
        if (_KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs != null)
        {
            grdThuocDY.DataSource = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;

            try
            {
                grdThuocDY.DataBind();
            }
            catch (Exception ex)
            { }

        }

    }

    #endregion




    #region 5 Khám bệnh VTTH
    private KhamBenh_VTTH Supports_KhamBenh_VTTH(string _mavt, DMVTYTKhoa _DMVTYT_Gia)
    {
        KhamBenh_VTTH _KhamBenh_VTTH = KhamBenh_VTTH.NewKhamBenh_VTTH();


        _KhamBenh_VTTH.BHTinhtien = _DMVTYT_Gia.DTBH;

        _KhamBenh_VTTH.MaBN = _ThongtinBN.MaBN;
        _KhamBenh_VTTH.Makhoa = _MaKhoa;
        _KhamBenh_VTTH.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : ((_NoiTT == "085" || _NoiTT == "090") ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003"))); ;

        _KhamBenh_VTTH.NgayDK = _ThongtinBN.KhamBenh.NgayDK;


        _KhamBenh_VTTH.CK = "0";

        _KhamBenh_VTTH.DonGiaBH = _DMVTYT_Gia.DonGiaBH == "" ? "0" : _DMVTYT_Gia.DonGiaBH;
        _KhamBenh_VTTH.DongiaTT = _DMVTYT_Gia.DonGiaTT == "" ? "0" : _DMVTYT_Gia.DonGiaTT;
        if (_DMVTYT_Gia.adphongmo > 1)
            _KhamBenh_VTTH.BHTinhtien = false;
        else if (_DMVTYT_Gia.adphongmo == 2)
            _KhamBenh_VTTH.BHTinhtien = false;

        if (_DMVTYT_Gia.ADChenhLech == true)
            _KhamBenh_VTTH.GiaChenhLech = _DMVTYT_Gia.GiaChenhlech == "" ? "0" : _DMVTYT_Gia.GiaChenhlech;
        else
            _KhamBenh_VTTH.GiaChenhLech = "0";

        _KhamBenh_VTTH.MaVT = _DMVTYT_Gia.MaVT;
        _KhamBenh_VTTH.TenTM = _DMVTYT_Gia.TenTM;


        _KhamBenh_VTTH.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;

        _KhamBenh_VTTH.MaBN = _ThongtinBN.MaBN;
        _KhamBenh_VTTH.Tinhtien = false;
        return _KhamBenh_VTTH;

    }

    /* private void LoadDetails_KhamBenh_VTTH(Boolean _load = true, Boolean _goi = false)
     {

         if (_ThongtinBN.KhamBenh.KhamBenh_VTTHList != null)
         {
             grdVTTH.DataSource = _ThongtinBN.KhamBenh.KhamBenh_VTTHList;

             try
             {
                 grdVTTH.DataBind();
             }
             catch (Exception ex)
             { }

         }

     }
     */
    #endregion


    #region 6. Khám bệnh Hóa Chất

    private KhamBenh_HoaChat Supports_KhamBenh_HoaChat(string _MaHC, DMHoaChatKhoa _DMHoaChat_Gia)
    {
        KhamBenh_HoaChat _KhamBenh_HoaChat = KhamBenh_HoaChat.NewKhamBenh_HoaChat();


        _KhamBenh_HoaChat.BHTinhtien = _DMHoaChat_Gia.DTBH;

        _KhamBenh_HoaChat.MaBN = _ThongtinBN.MaBN;
        _KhamBenh_HoaChat.Makhoa = _MaKhoa;
        _KhamBenh_HoaChat.NoiTTBH = _NoiTT;
        _KhamBenh_HoaChat.NoiTTTT = _NoiTT;
        _KhamBenh_HoaChat.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : ((_NoiTT == "085" || _NoiTT == "090") ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003"))); ;
        _KhamBenh_HoaChat.NgayDK = _ThongtinBN.KhamBenh.NgayDK;
        _KhamBenh_HoaChat.CK = "0";

        _KhamBenh_HoaChat.DonGiaBH = _DMHoaChat_Gia.DonGiaBH == "" ? "0" : _DMHoaChat_Gia.DonGiaBH;
        _KhamBenh_HoaChat.DongiaTT = _DMHoaChat_Gia.DonGiaTT == "" ? "0" : _DMHoaChat_Gia.DonGiaTT;
        if (_DMHoaChat_Gia.adphongmo > 1)
            _KhamBenh_HoaChat.BHTinhtien = false;
        else if (_DMHoaChat_Gia.adphongmo == 2)
            _KhamBenh_HoaChat.BHTinhtien = false;

        if (_DMHoaChat_Gia.ADChenhLech == true)
            _KhamBenh_HoaChat.GiaChenhLech = _DMHoaChat_Gia.GiaChenhlech == "" ? "0" : _DMHoaChat_Gia.GiaChenhlech;
        else
            _KhamBenh_HoaChat.GiaChenhLech = "0";

        _KhamBenh_HoaChat.MaHC = _DMHoaChat_Gia.MaHC;
        _KhamBenh_HoaChat.TenTM = _DMHoaChat_Gia.TenTM;


        _KhamBenh_HoaChat.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;

        _KhamBenh_HoaChat.MaBN = _ThongtinBN.MaBN;
        _KhamBenh_HoaChat.Tinhtien = false;
        return _KhamBenh_HoaChat;

    }

    /*  private void LoadDetails_KhamBenh_HoaChat(Boolean _load = true, Boolean _goi = false)
      {



          if (_ThongtinBN.KhamBenh.KhamBenh_HoaChatList != null)
          {
              grdHoaChat.DataSource = _ThongtinBN.KhamBenh.KhamBenh_HoaChatList;

              try
              {
                  grdHoaChat.DataBind();
              }
              catch (Exception ex)
              { }

          }

      }
      */
    #endregion

    #region 7. Khám bệnh Máu
    /*
    private void LoadDetails_KhamBenh_Mau(Boolean _load = true)
    {



        if (_ThongtinBN.KhamBenh.KhamBenh_MauList != null)
        {
            grdMau.DataSource = _ThongtinBN.KhamBenh.KhamBenh_MauList;

            try
            {
                grdMau.DataBind();
            }
            catch (Exception ex)
            { }

        }

    }
    */
    #endregion

    #region Tab hiện tại

    private const string ViewState_CurrentTab = "CurrentTab";
    public int CurrentTabIndex
    {
        get
        {
            if (ViewState[ViewState_CurrentTab] == null)
            {
                ViewState[ViewState_CurrentTab] = 0;

                return (int)ViewState[ViewState_CurrentTab];
            }
            else
                return (int)ViewState[ViewState_CurrentTab];
        }

        set
        {
            ViewState[ViewState_CurrentTab] = value;
        }
    }
    #endregion

    protected void Page_Load(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {

            if (Request["NgayDK"] != null)
            {
                dtNgayDK.Enabled = false;

                _NgayDK = DateTime.Parse(Request["NgayDK"].ToString().Substring(0, 10));
            }
            if (Request["MaBN"] != null)
            {
                txtmabn.Enabled = false;
                _MaBN = Request["MaBN"].ToString();

            }
            if (Request["PubMaDT"] != null)
            {

                _PubMaDT = Request["PubMaDT"].ToString();

            }

            if (_LoaiPhieu == 1 && HTC.ShareVariables.pub_spC == "PS")
            {
                if (_PubMaDT == "")
                    Response.Redirect("~/Default.aspx");
            }
            _NoiTT = Request["NoiTT"];
            CurrentTabIndex = 0;
            txtindextab.Value = CurrentTabIndex.ToString();
            RadTabStrip1.SelectedIndex = CurrentTabIndex;
            RadMultiPage1.SelectedIndex = CurrentTabIndex;
            if (cboDoiTuong.Items.Count == 0)
            {
                cboDoiTuong.DataSourceID = "odsDoiTuong";
                cboDoiTuong.DataBind();
            }
            ttqrcode.Visible = false;

            LoadData();
            SetData();

            if (_LoaiPhieu == 1 && _PubMaDT == "BH")
                txtloaiphieu.Value = "11";
            else if (_LoaiPhieu == 7 && (_NoiTT == "090" || _NoiTT == "087" || _NoiTT == "094" || _NoiTT == "093"))
                txtloaiphieu.Value = "77";
            else
                txtloaiphieu.Value = _LoaiPhieu.ToString();

            if (_ThongtinBN.KhamBenh.KhamBenh_C_List != null)
            {
                if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0 && ((_LoaiPhieu == 1 && (HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")) || ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && HTC.ShareVariables.pub_spC != "PS")))
                {
                    grdXNTT.MasterTableView.IsItemInserted = true;
                    grdXNTT.DataBind();
                }
            }
            else if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList != null)
            {
                if ((_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count == 0 && _LoaiPhieu == 7 && (_NoiTT == "090" || _NoiTT == "087" || _NoiTT == "094" || _NoiTT == "093")))
                {
                    grdThuocDY.MasterTableView.IsItemInserted = true;
                    grdThuocDY.DataBind();
                }
            }

            else if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList != null)
            {
                if ((_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count == 0 && (_LoaiPhieu == 7 || _LoaiPhieu == 3)))
                {
                    grdThuoc.MasterTableView.IsItemInserted = true;
                    grdThuoc.DataBind();
                }
            }

            //else
            //{
            //    switch (CurrentTabIndex)
            //    {
            //        case 0:
            //            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList;
            //            break;
            //        case 1:
            //            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList;
            //            break;
            //        case 2:
            //            _ThongtinBN.KhamBenh.KhamBenh_C_List = _ThongtinBN.KhamBenh.KhamBenh_C_List;
            //            _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList;
            //            break;
            //        case 3:
            //            _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList;
            //            break;
            //        case 4:
            //            _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList;
            //            break;
            //        case 5:
            //            _ThongtinBN.KhamBenh.KhamBenh_VTTHList = _ThongtinBN.KhamBenh.KhamBenh_VTTHList;
            //            break;
            //        case 6:
            //            _ThongtinBN.KhamBenh.KhamBenh_HoaChatList = _ThongtinBN.KhamBenh.KhamBenh_HoaChatList;
            //            break;
            //        case 7:

            //            _ThongtinBN.KhamBenh.KhamBenh_MauList = _ThongtinBN.KhamBenh.KhamBenh_MauList;
            //            break;
            //    }

            //}

            //if (!(CheckReportViewerReload(ReportData3) || CheckReportViewerReload(ReportData4) || CheckReportViewerReload(ReportData1) || CheckReportViewerReload(ReportData2) || CheckReportViewerReload(ReportData5)))
            //{
            //    ReportData3 = null;
            //    ReportData4 = null;
            //    ReportData5 = null;
            //    ReportData6 = null;
            //    ReportData1 = null;
            //    ReportData2 = null;

            //}

            //if (_LoaiPhieu != 1&&HTC.ShareVariables.pub_spC =="PS" )
            //{
            //    cboNhanVien.EnableLoadOnDemand = true;
            //    cboNhanVien.EnableAutomaticLoadOnDemand = true;

            //}
            //if (_LoaiPhieu == 7)
            //{
            //    if (_NoiTT == "089")
            //    {
            //        cboBSDongY.EnableLoadOnDemand = true;
            //        cboBSDongY.EnableAutomaticLoadOnDemand = false;
            //    }
            //    else
            //    {
            //        cboBSTayY.EnableLoadOnDemand = true;
            //        cboBSTayY.EnableAutomaticLoadOnDemand = false;

            //    }
            //}
            //System.Threading.Thread thread = new System.Threading.Thread(new System.Threading.ThreadStart(ThreadFunc));
            //thread.Name = "ThreadFunc";
            //thread.IsBackground = true;
            //thread.Start();
        }
    }
    protected void ThreadFunc()
    {
        try
        {
            string PubMaDT = _PubMaDT;
            while (true)
            {
                if ((txtmabn.Text == "" && txthoten.Text == "" && txtSoThe.Text == "" && Application[Pub_sQuay + "Tran"] != null))
                {
                    _Pub_TransactionID = int.Parse(Application[Pub_sQuay + "Tran"].ToString());
                    ShowMessage(_Pub_TransactionID.ToString());

                    string _Pub_sCodePatient = "";

                    Application[Pub_sQuay + "Tran"] = null;
                    if (Application[Pub_sQuay + "Pati"] != null)
                        _Pub_sCodePatient = Application[Pub_sQuay + "Pati"].ToString();
                    if (_Pub_sCodePatient != "" && _Pub_sCodePatient != null && _Pub_TransactionID != 0 && _Pub_TransactionID != null)
                    {
                        //CloseWindow();
                        //if (_LoaiPhieu == 1 || _LoaiPhieu == 11)
                        //    OpenWindow("frmLapPhieu.aspx?LoaiPhieu=" + _LoaiPhieu + "&pubmadt=" + _PubMaDT + "&noitt=" + _NoiTT + "&duyet=" + _Duyet + "&maBN=" + _MaBN + "&ngayDK=" + _NgayDK);
                        //else
                        OpenWindow("frmLapPhieu.aspx?LoaiPhieu=" + _LoaiPhieu + "&&noitt=" + _NoiTT + "&duyet=" + _Duyet + "&pubmadt=" + _PubMaDT + "&&maBN=" + _MaBN + "&&ngayDK=" + _NgayDK);

                        //if (_LoaiPhieu == 1 || _LoaiPhieu == 11)
                        //    Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={0}&pubmadt={5}&&noitt={1}&duyet={2}&&maBN={3}&&ngayDK={4}", _LoaiPhieu, _NoiTT, _Duyet, _Pub_sCodePatient, dtNgayDK.Text, PubMaDT), false);
                        //else
                        //    Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={0}&&noitt={1}&duyet={2}&pubmadt={5}&&maBN={3}&&ngayDK={4}", _LoaiPhieu, _NoiTT, _Duyet, _Pub_sCodePatient, dtNgayDK.Text, PubMaDT), false);
                    }
                    System.Threading.Thread.Sleep(TimeSpan.FromMinutes(3));
                }
                else
                    // Wait for certain time interval
                    System.Threading.Thread.Sleep(TimeSpan.FromSeconds(10));
            }
        }
        catch (Exception ex)
        {
        }
    }
    protected void Page_PreRender(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
            base.Page_PreRender(sender, e);
            if (HTC.ShareVariables.pub_spC == "PS")
            {
                grdKhoa.MasterTableView.GetColumn("SoLuotCKC").Display = true;
                grdKhoa.MasterTableView.GetColumn("SoLuotCKC").Visible = true;
                grdKhoa.MasterTableView.GetColumn("SoLuotTD").Display = true;
                grdKhoa.MasterTableView.GetColumn("SoLuotTDC").Display = true;
                grdKhoa.MasterTableView.GetColumn("SoLuotTTC").Display = true;
                grdKhoa.MasterTableView.GetColumn("SoLuotTT").Display = true;
            }
            else if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN")
            {
                grdKhoa.MasterTableView.GetColumn("SoLuotCKC").Display = false;
                grdKhoa.MasterTableView.GetColumn("SoLuotCKC").Visible = false;
                grdKhoa.MasterTableView.GetColumn("SoLuotTD").Display = false;
                grdKhoa.MasterTableView.GetColumn("SoLuotTDC").Display = false;
                grdKhoa.MasterTableView.GetColumn("SoLuotTTC").Display = false;
                grdKhoa.MasterTableView.GetColumn("SoLuotTT").Display = false;
                grdKhoa.MasterTableView.GetColumn("SoLuotCK").HeaderText = "Chưa khám";
                grdKhoa.MasterTableView.GetColumn("SoLuotDK").HeaderText = "Đã khám";
            }
            else
            {
                grdKhoa.MasterTableView.GetColumn("SoLuotCKC").Display = false;
                grdKhoa.MasterTableView.GetColumn("SoLuotCKC").Visible = false;
                grdKhoa.MasterTableView.GetColumn("SoLuotTD").Display = false;
                grdKhoa.MasterTableView.GetColumn("SoLuotTDC").Display = false;
                grdKhoa.MasterTableView.GetColumn("SoLuotTTC").Display = false;
                grdKhoa.MasterTableView.GetColumn("SoLuotTT").Display = true;
                grdKhoa.MasterTableView.GetColumn("SoLuotCK").HeaderText = "Chưa khám";
                grdKhoa.MasterTableView.GetColumn("SoLuotDK").HeaderText = "Đã khám";
            }
            if (txtmabn.Text == "" && txthoten.Text == "" && txtSoThe.Text == "")
            {
                if (_LoaiPhieu == 1)
                    cboLoaiBN.Focus();
                else if (_LoaiPhieu == 2 && HTC.ShareVariables.pub_spC == "YH")
                    txtQRCode.Focus();
                else if (_LoaiPhieu == 2 && HTC.ShareVariables.pub_spC != "PS")
                    txtSoThe.Focus();
                else if ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && HTC.ShareVariables.pub_spC == "PS")
                    txtmabn.Focus();
                else
                    txtmabn.Focus();

            }
            else if (RadTabStrip1.TabIndex == 2)
                grdXNTT.Focus();


        }

    }


    private void SetData()
    {
        try
        {
            ViewState[ViewState_KTBHYT] = false;
            txtview.Value = HTC.ShareVariables.pub_spC;
            lblSothang.Text = "";
            grdDanhSach.Visible = false;
            Label34.Visible = false;
            txtNoiLV.Visible = false;
            if (HTC.ShareVariables.pub_spC == "PS")
            {
                txtdienthoai.AutoPostBack = true;
            }
            else
            {
                txtdienthoai.AutoPostBack = false;
            }
            if (HTC.ShareVariables.pub_spC != "PS")
            {
                Label34.Visible = true;
                txtNoiLV.Visible = true;
            }
            if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN")
            {
                Label32.Visible = true;
                txtGhiChuHD.Visible = true;
                diachi.ColSpan = 1;
            }
            else
            {
                lblxa.Visible = false;
                lblxa.Disabled = false;
                xa.Visible = false;
                xa.Disabled = false;
            }
            if (_PubMaDT == "TT")
            {
                txtSoThe.Enabled = false;
                chkTraiTuyen.Visible = false;
                ttbh.Visible = false;
            }
            if (HTC.ShareVariables.pub_spC == "PS")
            {
                Label24.Visible = false;
                txtTongDTT.Visible = false;
                if (_LoaiPhieu == 1 && _NoiTT == "095")
                {
                    idCSTN.Visible = true;
                }
                else
                    idCSTN.Visible = false;
            }
            else
            {

                Label24.Visible = true;
                txtTongDTT.Visible = true;
                idCSTN.Visible = false;
            }
            ShowHideThuocThang();
            //if (HTC.ShareVariables.pub_spC == "YH")
            //    dtNgayQT.Enabled = false;
            if (HTC.ShareVariables.pub_spC == "PS" && _LoaiPhieu == 1 && _Duyet == 0)
                txtmabn.Enabled = false;
            //if (HTC.ShareVariables.pub_spC == "YH" && _LoaiPhieu == 2)
            //    cboKhoaKB.AutoPostBack = true;
            //else
            //    cboKhoaKB.AutoPostBack = false;
            if (HTC.ShareVariables.pub_sMaTinh != "" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
            {
                if (grdKhoa.Visible == true)
                    cbohuyen.AutoPostBack = false;
                else
                    cbohuyen.AutoPostBack = true;
            }
            else
                cbohuyen.AutoPostBack = false;

            if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && txtsohd.Text == "")
            {
                // pub_sKyHieuHD = DateTime.Now.ToString("MM/dd/yyyy").Substring(0, 2) + DateTime.Now.Year.ToString().Substring(2, 2) + "-" + Pub_sQuay + "-";
                pub_sKyHieuHD = Pub_sQuay + "-" + Pub_sNguoiSD;
                txtKyhieu.Text = pub_sKyHieuHD;
                txtsohd.Text = HTC.Business.DataProvider.Instance().CapMa("KhamBenh_HoaDon", DateTime.Now.ToString("MM/dd/yyyy").Substring(0, 2) + DateTime.Now.Year.ToString().Substring(2, 2), "right(SoHD,4)", 4, " and sosohd ='" + txtKyhieu.Text + "' and sohd like '" + DateTime.Now.ToString("MM/dd/yyyy").Substring(0, 2) + DateTime.Now.Year.ToString().Substring(2, 2) + "%'", txtsohd.Text);

                //  txtsohd.Text = int.Parse(HTC.Business.DataProvider.Instance().CapMa("KhamBenh_HoaDon", "", "SoHD", 6, " and sosohd ='" + txtKyhieu.Text + "'", txtsohd.Text)).ToString();
            }
            else if ((_NoiTT == "091" || _NoiTT == "092") && txtsohd.Text == "")
            {
                pub_sKyHieuHD = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + Pub_sQuay + "/" + Pub_sNguoiSD;
                if (HTC.ShareVariables.pub_spC == "PS")
                    pub_sKyHieuHD = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + DateTime.Now.Month.ToString() + "/" + DateTime.Now.Day.ToString() + "/" + Pub_sNguoiSD;

                txtKyhieu.Text = pub_sKyHieuHD;
                if (HTC.ShareVariables.pub_spC != "PS" || _LoaiPhieu == 7)
                    txtsohd.Text = int.Parse(HTC.Business.DataProvider.Instance().CapMa("KhamBenh_HoaDon", "", "SoHD", 6, " and sosohd ='" + txtKyhieu.Text + "'", txtsohd.Text)).ToString();
            }
            else if (!(((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && HTC.ShareVariables.pub_spC == "PS") || ((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093") || _LoaiPhieu == 1) && txtsohd.Text == "")
            {

                string kh = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + Pub_sNguoiSD;
                if (pub_sKyHieuHD == kh && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH"))
                {
                    txtKyhieu.Text = pub_sKyHieuHD;
                    txtsohd.Text = pub_sSoHD;
                }
                else
                {
                    if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "YH") || _LoaiPhieu == 7)
                    {
                        //if (HTC.ShareVariables.pub_spC == "HU")
                        //    pub_sKyHieuHD = DateTime.Now.ToString("MM/dd/yyyy").Substring(0, 2) + DateTime.Now.Year.ToString().Substring(2, 2) + "-" + Pub_sQuay + "-";
                        if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                            pub_sKyHieuHD = Pub_sQuay + "-" + Pub_sNguoiSD;
                        else if (HTC.ShareVariables.pub_spC == "PS")
                            pub_sKyHieuHD = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + DateTime.Now.Month.ToString() + "/" + DateTime.Now.Day.ToString() + "/" + Pub_sNguoiSD;
                        else
                            pub_sKyHieuHD = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + Pub_sQuay + "/" + Pub_sNguoiSD;

                        txtKyhieu.Text = pub_sKyHieuHD;
                    }
                }
                if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                    txtsohd.Text = HTC.Business.DataProvider.Instance().CapMa("KhamBenh_HoaDon", DateTime.Now.ToString("MM/dd/yyyy").Substring(0, 2) + DateTime.Now.Year.ToString().Substring(2, 2), "right(SoHD,4)", 4, " and sosohd ='" + txtKyhieu.Text + "' and sohd like '" + DateTime.Now.ToString("MM/dd/yyyy").Substring(0, 2) + DateTime.Now.Year.ToString().Substring(2, 2) + "%'", txtsohd.Text);
                else if (HTC.ShareVariables.pub_spC != "PS" || _LoaiPhieu == 7)
                    txtsohd.Text = int.Parse(HTC.Business.DataProvider.Instance().CapMa("KhamBenh_HoaDon", "", "SoHD", 6, " and sosohd ='" + txtKyhieu.Text + "'", txtsohd.Text)).ToString();

            }
            else if (txtKyhieu.Enabled == true && txtKyhieu.Visible == true)
            {

                if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "YH") || _LoaiPhieu == 7)
                    if (txtKyhieu.Text == "")
                    {
                        if (string.IsNullOrEmpty(pub_sKyHieuHD))
                        {
                            //if (HTC.ShareVariables.pub_spC == "HU")
                            //    txtKyhieu.Text = DateTime.Now.ToString("MM/dd/yyyy").Substring(0, 2) + DateTime.Now.Year.ToString().Substring(2, 2) + "-" + Pub_sQuay + "-";
                            if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                                txtKyhieu.Text = Pub_sQuay + "-" + Pub_sNguoiSD;
                            else if (HTC.ShareVariables.pub_spC == "PS")
                                txtKyhieu.Text = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + DateTime.Now.Month.ToString() + "/" + DateTime.Now.Day.ToString() + "/" + Pub_sNguoiSD;

                            else
                                txtKyhieu.Text = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + Pub_sQuay + "/" + Pub_sNguoiSD;
                        }
                        else
                            txtKyhieu.Text = pub_sKyHieuHD;
                        pub_sKyHieuHD = txtKyhieu.Text;

                    }
                if (HTC.ShareVariables.pub_spC == "PS" && txtKyhieu.Text == "")
                    txtKyhieu.Text = "PS/" + DateTime.Now.Year.ToString("####").Substring(2, 2) + "P";
                else if (txtKyhieu.Text == "" && HTC.ShareVariables.pub_spC == "HH")
                    txtKyhieu.Text = "HH/" + DateTime.Now.Year.ToString("####").Substring(2, 2) + "P";

                if (txtsohd.Text == "")
                    if (HTC.ShareVariables.pub_spC != "PS" || _LoaiPhieu == 7)
                        txtsohd.Text = pub_sSoHD;

            }




            if (pub_bQadmin == false)
            {
                grdThuoc.MasterTableView.GetColumn("Huy").Display = false;
                grdThuocDY.MasterTableView.GetColumn("Huy").Display = false;
                //grdVTTH.MasterTableView.GetColumn("Huy").Display = false;
                //grdHoaChat.MasterTableView.GetColumn("Huy").Display = false;
                //grdMau.MasterTableView.GetColumn("Huy").Display = false;
                grdXNTT.MasterTableView.GetColumn("Huy").Display = false;

            }
            if (HTC.ShareVariables.pub_spC == "YH")
                txtMaKhoa.Visible = false;
            if (HTC.ShareVariables.pub_spC != "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                grdKhoa.MasterTableView.GetColumn("soLuotDangK").Display = false;
            else
                grdKhoa.MasterTableView.GetColumn("soLuotDangK").Display = true;
            if (HTC.ShareVariables.pub_spC != "YH")
            {
                grdDTT.MasterTableView.GetColumn("Delete").Display = false;
                grdDTT.MasterTableView.GetColumn("Edit").Display = false;
            }
            else if (_NoiTT == "090" && HTC.ShareVariables.pub_spC == "YH")
            {
                grdDTT.MasterTableView.GetColumn("Delete").Display = false;
                grdDTT.MasterTableView.GetColumn("Edit").Display = false;
            }
            if ((HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "HH" || HTC.ShareVariables.pub_spC == "YH") && _NoiTT != "085")
            {
                grdXNTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdCTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdDTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdXNTT.MasterTableView.GetColumn("DonGiaBH").Display = false;
                grdCTT.MasterTableView.GetColumn("DonGiaBH").Display = false;
                grdDTT.MasterTableView.GetColumn("DonGiaBH").Display = false;
            }
            else if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _LoaiPhieu == 2)
            {
                grdXNTT.MasterTableView.GetColumn("DonGiaTT").Display = true;
                grdCTT.MasterTableView.GetColumn("DonGiaTT").Display = true;
                grdDTT.MasterTableView.GetColumn("DonGiaTT").Display = true;
                grdXNTT.MasterTableView.GetColumn("DonGiaBH").Display = true;
                grdCTT.MasterTableView.GetColumn("DonGiaBH").Display = true;
                grdDTT.MasterTableView.GetColumn("DonGiaBH").Display = true;
                grdCTT.MasterTableView.GetColumn("ThanhTien").Display = true;
                grdDTT.MasterTableView.GetColumn("ThanhTien").Display = true;
                grdCTT.MasterTableView.GetColumn("ThanhTienBH").Display = true;
                grdDTT.MasterTableView.GetColumn("ThanhTienBH").Display = true;
                grdCTT.MasterTableView.GetColumn("BHTinhTien").Display = false;
            }
            else if (_LoaiPhieu == 2)
            {
                grdXNTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdCTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdDTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdXNTT.MasterTableView.GetColumn("DonGiaTT").Display = false;
                grdCTT.MasterTableView.GetColumn("DonGiaTT").Display = false;
                grdDTT.MasterTableView.GetColumn("DonGiaTT").Display = false;
            }
            else if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 7 || _LoaiPhieu == 3)
            {
                grdXNTT.MasterTableView.GetColumn("DonGiaBH").Display = false;
                grdCTT.MasterTableView.GetColumn("DonGiaBH").Display = false;
                grdDTT.MasterTableView.GetColumn("DonGiaBH").Display = false;
            }
            else if (_PubMaDT == "BH" && HTC.ShareVariables.pub_spC == "PS")
            {

                grdXNTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdCTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdDTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdXNTT.MasterTableView.GetColumn("DonGiaTT").Display = false;
                grdCTT.MasterTableView.GetColumn("DonGiaTT").Display = false;
                grdDTT.MasterTableView.GetColumn("DonGiaTT").Display = false;
            }
            else if ((((_LoaiPhieu == 9 || _LoaiPhieu == 8)) && (HTC.ShareVariables.pub_spC == "PS")))
            {
                grdXNTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdCTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdDTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdXNTT.MasterTableView.GetColumn("DonGiaBH").Display = false;
                grdCTT.MasterTableView.GetColumn("DonGiaBH").Display = false;
                grdDTT.MasterTableView.GetColumn("DonGiaBH").Display = false;
            }
            else if (((_LoaiPhieu == 2) && (HTC.ShareVariables.pub_spC == "PS")))
            {
                grdXNTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdCTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdDTT.MasterTableView.GetColumn("GiaChenhLech").Display = false;
                grdXNTT.MasterTableView.GetColumn("DonGiaTT").Display = false;
                grdCTT.MasterTableView.GetColumn("DonGiaTT").Display = false;
                grdDTT.MasterTableView.GetColumn("DonGiaTT").Display = false;
            }

            if (((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8) || (_LoaiPhieu == 7 && HTC.ShareVariables.pub_spC == "PS")) && (HTC.ShareVariables.pub_spC == "PS" || (_NoiTT == "087" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")))))
            {

                dtNgaySinh.Enabled = false;
                txthoten.Enabled = false;
                cboquocgia.Enabled = false;
                cboChuyenKhoa.Enabled = false;
                optGT.Enabled = false;
                cboPXa.Enabled = false;
                cboDoiTuong.Enabled = false;
                txtBaoTin.Enabled = false;
                txttuoi.Enabled = false;
                txtdienthoai.Enabled = false;
                cbohuyen.Enabled = false;
                cbotinh.Enabled = false;
                cboNgheNghiep.Enabled = false;
                cboDanToc.Enabled = false;
                txtDiaChi.Enabled = false;
                txtMaBAQL.Enabled = false;
            }
            else if (_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 1)
            {
                cboDoiTuong.Enabled = true;
            }
            if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _NoiTT == "087")
            {
                txtMaBAQL.Visible = true;
                txtMaBAQL.Enabled = true;
                Label43.Text = "Mã QL";
                txtSoThe.Visible = false;
                txtSoThe.Enabled = false;
                chkTraiTuyen.Visible = false;
            }
            //if (_LoaiPhieu != 2 || HTC.ShareVariables.pub_spC != "HU")
            //    baraction.FindItemByValue("cmdAddTT").Visible = false;
            if (_LoaiPhieu == 1)
                baraction.FindItemByValue("cmdSua").Enabled = true;
            else if ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && (HTC.ShareVariables.pub_spC == "YH" || (HTC.ShareVariables.pub_spC == "PH" && _NoiTT == "085")))
                baraction.FindItemByValue("cmdSua").Enabled = true;
            //else if ((_LoaiPhieu == 7||_LoaiPhieu ==3) && _ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "0")
            //    baraction.FindItemByValue("cmdSua").Enabled = true;
            else
                baraction.FindItemByValue("cmdSua").Enabled = false;


            if (_LoaiPhieu == 2 || ((_LoaiPhieu == 9) && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")))
                baraction.FindItemByValue("cmdAddKQ").Visible = true;
            else
                baraction.FindItemByValue("cmdAddKQ").Visible = false;

            if (_ThongtinBN.KhamBenh.NgayQT != "" && pub_bQadmin == false)
            {
                // Khong Duoc Edit???

                if (Pub_bQuyenForm < HTC.ShareVariables.KieuFormChiTiet.fThem)
                    baraction.FindItemByValue("cmdSave").Enabled = false;
                if (Pub_bQuyenForm != HTC.ShareVariables.KieuFormChiTiet.fDelete)
                {
                    baraction.FindItemByValue("cmdHuyHD").Enabled = false;
                    baraction.FindItemByValue("cmdHoanHD").Enabled = false;
                    grdDTT.MasterTableView.GetColumn("Delete").Display = false;
                    Label17.Visible = false;
                    txtMG.Visible = false;
                    cboNguoiDuyet.Visible = false;
                }

            }
            if (HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ ")
            {
                cdsKhoa.SelectMethod = "GetListByAccountNgoaiTru";

            }

            if (_LoaiPhieu == 2 && _ThongtinBN.KhamBenh.NgayQT != "")
                baraction.FindItemByValue("cmdPrintLai").Visible = true;
            else if (_LoaiPhieu != 1 && _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count > 0)
                baraction.FindItemByValue("cmdPrintLai").Visible = true;
            else if (_LoaiPhieu == 1 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _Duyet == 0)
                baraction.FindItemByValue("cmdPrintLai").Visible = true;
            if (_LoaiPhieu == 1 && _Duyet == 1)
            {
                baraction.FindItemByValue("cmdHuyHD").Visible = false;
                baraction.FindItemByValue("cmdHoanHD").Visible = false;
                baraction.FindItemByValue("cmdAddThuoc").Visible = false;
                baraction.FindItemByValue("cmdAddThuocDY").Visible = false;
                baraction.FindItemByValue("cmdChuaTT").Text = "DS chưa duyệt";
                baraction.FindItemByValue("cmdDaTT").Text = "DS đã duyệt";
                RadTabStrip1.Tabs[0].Text = "Dịch vụ chưa duyệt";
                RadTabStrip1.Tabs[1].Text = "Dịch vụ đã duyệt";
                if (_LoaiPhieu == 1 && _Duyet == 1 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH"))
                {
                    baraction.FindItemByValue("cmdPrintLai").Visible = false;
                    baraction.FindItemByValue("cmdPrint").Visible = false;
                    baraction.FindItemByValue("cmdHuy").Visible = false;
                    baraction.FindItemByValue("cmdChuaTT").Visible = false;
                    baraction.FindItemByValue("cmdDaTT").Visible = false;
                    baraction.FindItemByValue("cmdLayBN").Visible = false;
                    baraction.FindItemByValue("cmdSua").Visible = false;
                    baraction.FindItemByValue("cmdQRCode").Visible = false;
                    baraction.FindItemByValue("cmdAddXN").Visible = false;
                    if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count > 0)
                    {
                        CurrentTabIndex = 1;
                        txtindextab.Value = CurrentTabIndex.ToString();
                        RadTabStrip1.SelectedIndex = CurrentTabIndex;
                        RadMultiPage1.SelectedIndex = CurrentTabIndex;
                    }

                }
                //RadTabStrip1.Tabs[1].Visible = false;
                if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count == 0)
                    RadTabStrip1.Tabs[1].Visible = false;
                else
                    RadTabStrip1.Tabs[1].Visible = true;
                if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count > 0)
                {
                    CurrentTabIndex = 0;
                    txtindextab.Value = CurrentTabIndex.ToString();
                    RadTabStrip1.Visible = true;
                    RadTabStrip1.Tabs[0].Visible = true;
                }

                RadTabStrip1.Tabs[2].Visible = false;
                RadTabStrip1.Tabs[3].Visible = false;
                RadTabStrip1.Tabs[4].Visible = false;
                grdCTT.MasterTableView.GetColumn("Edit").Display = false;
                grdDTT.MasterTableView.GetColumn("Edit").Display = false;
                grdCTT.MasterTableView.GetColumn("Delete").Display = false;
                grdDTT.MasterTableView.GetColumn("Delete").Display = false;
                grdCTT.MasterTableView.GetColumn("CheckBoxTemplateColumn").Display = true;
                grdDTT.MasterTableView.GetColumn("CheckBoxTemplateColumn").Display = true;
                RadTabStrip1.SelectedIndex = CurrentTabIndex;
                RadTabStrip1.Tabs[CurrentTabIndex].Selected = true;
                RadMultiPage1.SelectedIndex = CurrentTabIndex;
                LoadDetails(false, CurrentTabIndex, false);

            }

            else if (_LoaiPhieu == 1)
            {
                baraction.FindItemByValue("cmdHuyHD").Visible = false;
                baraction.FindItemByValue("cmdHoanHD").Visible = false;
                baraction.FindItemByValue("cmdAddThuoc").Visible = false;
                baraction.FindItemByValue("cmdAddThuocDY").Visible = false;
                baraction.FindItemByValue("cmdDaTT").Visible = false;
                baraction.FindItemByValue("cmdChuaTT").Text = "DS BN";



                //if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count == 0)
                RadTabStrip1.Tabs[0].Visible = false;
                //else
                //    RadTabStrip1.Tabs[0].Visible = true;

                RadTabStrip1.Tabs[1].Visible = false;
                RadTabStrip1.Tabs[2].Visible = false;


                RadTabStrip1.Tabs[3].Visible = false;
                RadTabStrip1.Tabs[4].Visible = false;

                if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count == 0)
                    RadTabStrip1.Tabs[0].Visible = false;
                if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count != 0)
                {
                    //CurrentTabIndex = 0;
                    //RadTabStrip1.Visible = true;
                    //RadTabStrip1.Tabs[0].Visible = true;
                    CurrentTabIndex = 2;
                    txtindextab.Value = CurrentTabIndex.ToString();
                    RadTabStrip1.Visible = false;
                    RadTabStrip1.Tabs[2].Visible = true;
                }

                else
                {
                    CurrentTabIndex = 2;
                    txtindextab.Value = CurrentTabIndex.ToString();
                    RadTabStrip1.Visible = false;
                    RadTabStrip1.Tabs[2].Visible = true;


                }

                RadTabStrip1.SelectedIndex = CurrentTabIndex;

                RadMultiPage1.SelectedIndex = CurrentTabIndex;
            }
            else
            {
                if (!(_NoiTT == "090" || (_LoaiPhieu == 7 && _NoiTT == "087") || (_LoaiPhieu == 7 && _NoiTT == "085" && HTC.ShareVariables.pub_spC == "QN") || _NoiTT == "094"))
                    baraction.FindItemByValue("cmdAddThuocDY").Visible = false;
                else
                    baraction.FindItemByValue("cmdAddThuocDY").Visible = true;
                if (_LoaiPhieu == 7 && HTC.ShareVariables.pub_spC != "PS")
                {
                    if (_NoiTT != "091" && _NoiTT != "092" && HTC.ShareVariables.pub_spC != "QN")
                        baraction.FindItemByValue("cmdAddThuoc").Visible = false;
                    else
                        baraction.FindItemByValue("cmdAddThuoc").Visible = true;
                }
                else if (_LoaiPhieu == 7 && HTC.ShareVariables.pub_spC == "PS")
                {
                    baraction.FindItemByValue("cmdAddThuoc").Visible = false;
                }
                else if (_LoaiPhieu == 3)
                {
                    baraction.FindItemByValue("cmdHuyHD").Visible = false;
                    baraction.FindItemByValue("cmdHoanHD").Visible = false;
                    baraction.FindItemByValue("cmdAddThuocDY").Visible = false;
                    baraction.FindItemByValue("cmdDaTT").Visible = false;
                    baraction.FindItemByValue("cmdChuaTT").Text = "DS BN";
                    baraction.FindItemByValue("cmdAddThuoc").Visible = true;
                }
                if (((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && (HTC.ShareVariables.pub_spC == "PS")) || _LoaiPhieu == 7 || _LoaiPhieu == 3)
                    baraction.FindItemByValue("cmdAddXN").Visible = false;
                if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && (_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && _NoiTT == "087")
                    baraction.FindItemByValue("cmdAddXN").Visible = false;
                if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN") && (_LoaiPhieu == 2 || (_LoaiPhieu == 9)) && _NoiTT == "087")
                {
                    baraction.FindItemByValue("cmdSua").Visible = false;
                    baraction.FindItemByValue("cmdAddKQ").Visible = false;
                }
                if (!(HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || _LoaiPhieu == 2 || (_LoaiPhieu == 8 && HTC.ShareVariables.pub_spC == "PS")))
                {

                    baraction.FindItemByValue("cmdAddKQ").Visible = false;
                }
                if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count == 0)
                    RadTabStrip1.Tabs[0].Visible = false;
                RadTabStrip1.Tabs[1].Visible = false;
                RadTabStrip1.Tabs[2].Visible = false;
                RadTabStrip1.Tabs[3].Visible = false;
                RadTabStrip1.Tabs[4].Visible = false;


                if (((_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 2) && _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count == 0 && _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count == 0 && HTC.ShareVariables.pub_spC != "PS")
                {
                    CurrentTabIndex = 2;
                    txtindextab.Value = CurrentTabIndex.ToString();
                    RadTabStrip1.SelectedIndex = CurrentTabIndex;
                    RadMultiPage1.SelectedIndex = CurrentTabIndex;
                    RadTabStrip1.Tabs[2].Visible = true;
                }

                else if (_LoaiPhieu == 7 && (_NoiTT == "090" || _NoiTT == "087" || _NoiTT == "094" || _NoiTT == "093" || (_NoiTT == "085" && HTC.ShareVariables.pub_spC == "QN")) && _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count <= 1)
                {
                    if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count == 0)
                    {
                        CurrentTabIndex = 4;
                        txtindextab.Value = CurrentTabIndex.ToString();
                        RadTabStrip1.SelectedIndex = CurrentTabIndex;
                        RadMultiPage1.SelectedIndex = CurrentTabIndex;
                        grdDanhSachDY.Visible = false;
                    }
                }
                else if ((_LoaiPhieu == 7 && _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count == 0) || _LoaiPhieu == 3)
                {
                    CurrentTabIndex = 3;
                    txtindextab.Value = CurrentTabIndex.ToString();
                    RadTabStrip1.SelectedIndex = CurrentTabIndex;

                    RadMultiPage1.SelectedIndex = CurrentTabIndex;

                }

                if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count != 0 && _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count == 0)
                {
                    CurrentTabIndex = 0;
                    txtindextab.Value = CurrentTabIndex.ToString();
                    RadTabStrip1.SelectedIndex = CurrentTabIndex;

                    RadMultiPage1.SelectedIndex = CurrentTabIndex;
                    RadTabStrip1.Visible = true;
                    RadTabStrip1.Tabs[0].Visible = true;

                    LoadDetails(false, CurrentTabIndex, false);
                }
                else if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count != 0 || _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count != 0)
                {
                    CurrentTabIndex = 0;
                    txtindextab.Value = CurrentTabIndex.ToString();
                    RadTabStrip1.SelectedIndex = CurrentTabIndex;

                    RadMultiPage1.SelectedIndex = CurrentTabIndex;
                    RadTabStrip1.Visible = true;
                    RadTabStrip1.Tabs[0].Visible = true;
                    RadTabStrip1.Tabs[1].Visible = true;
                    LoadDetails(false, CurrentTabIndex, false);
                }

            }
            //if (_LoaiPhieu == 1 && _Duyet == 1)
            //{
            //    baraction.FindItemByValue("cmdSave").Text = "Duyệt";
            //    baraction.FindItemByValue("cmdPrint").Visible = false;
            //}
            //else 
            if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count == 0 && _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count == 0 && (_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && _NoiTT == "085" && (HTC.ShareVariables.pub_spC == "PS"))
            {

                baraction.FindItemByValue("cmdPrint").Visible = false;
                baraction.FindItemByValue("cmdSave").Visible = false;
            }
            else
            {
                if (((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && (HTC.ShareVariables.pub_spC == "PS")))
                    baraction.FindItemByValue("cmdSave").Visible = false;
                else
                    baraction.FindItemByValue("cmdSave").Visible = true;
                if (!(_LoaiPhieu == 1 && _Duyet == 1 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")))
                    baraction.FindItemByValue("cmdPrint").Visible = true;

            }
            //if ((_LoaiPhieu == 1 && _Duyet != 1) || _LoaiPhieu != 1)
            //{
            //    baraction.FindItemByValue("cmdSave").Visible = false;
            //}

            /// SECURITY


            if (Pub_bQuyenForm < HTC.ShareVariables.KieuFormChiTiet.fThem)
                baraction.FindItemByValue("cmdSave").Enabled = false;
            //if (Pub_bQuyenForm != HTC.ShareVariables.KieuFormChiTiet.fDelete)
            //{

            //    baraction.FindItemByValue("cmdSave").Enabled = false;
            //}
            if (Pub_bQuyenForm < HTC.ShareVariables.KieuFormChiTiet.fThem)
                baraction.FindItemByValue("cmdPrint").Enabled = false;

            if (Pub_bQuyenForm != HTC.ShareVariables.KieuFormChiTiet.fDelete)
            {

                baraction.FindItemByValue("cmdHuyHD").Enabled = false;
                baraction.FindItemByValue("cmdHoanHD").Enabled = false;
                txtMG.Enabled = false;
                cboNguoiDuyet.Visible = false;
            }
            if (HTC.ShareVariables.pub_spC == "PS")
            {
                if (_LoaiPhieu != 2 && pub_bQadmin == false)
                {
                    baraction.FindItemByValue("cmdPrintLai").Visible = false;
                }
            }
            else
            {
                baraction.FindItemByValue("cmdHuyHD").Visible = false;
            }
            if (HTC.ShareVariables.pub_spC == "PS")
            {
                if (_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8))
                {
                    baraction.FindItemByValue("cmdSua").Enabled = false;
                    enableTNBN(false);
                    txtmabn.Enabled = true;
                    dtNgayDK.Enabled = true;
                }
            }
            visablecontrol();
        }
        catch (Exception ex)
        {
            ShowMessage("Không hiển thị được dữ liệu" + ex.Message);


        }
    }
    private void SetObject()
    {
        ///* if (Cache[odsVTTH.CacheKeyDependency] == null)
        //     Cache[odsVTTH.CacheKeyDependency] = cboDoiTuong.SelectedValue;
        // else if (Cache[odsVTTH.CacheKeyDependency].ToString() != cboDoiTuong.SelectedValue)
        //     Cache[odsVTTH.CacheKeyDependency] = cboDoiTuong.SelectedValue;

        // if (Cache[odsChePhamMau.CacheKeyDependency] == null)
        //     Cache[odsChePhamMau.CacheKeyDependency] = cboDoiTuong.SelectedValue;
        // else if (Cache[odsChePhamMau.CacheKeyDependency].ToString() != cboDoiTuong.SelectedValue)
        //     Cache[odsChePhamMau.CacheKeyDependency] = cboDoiTuong.SelectedValue;

        // if (Cache[odsHoaChat.CacheKeyDependency] == null)
        //     Cache[odsHoaChat.CacheKeyDependency] = cboDoiTuong.SelectedValue;
        // else if (Cache[odsHoaChat.CacheKeyDependency].ToString() != cboDoiTuong.SelectedValue)
        //     Cache[odsHoaChat.CacheKeyDependency] = cboDoiTuong.SelectedValue;
        // */
        //if (Cache[odsThuoc.CacheKeyDependency] == null)
        //    Cache[odsThuoc.CacheKeyDependency] = _NoiTT == "091" ? HTC.ShareVariables.pub_sMaKX091 : HTC.ShareVariables.pub_sMaKX092 + dtNgayDK.Text;
        //else if (Cache[odsThuoc.CacheKeyDependency].ToString() != ((_NoiTT == "091" ? HTC.ShareVariables.pub_sMaKX091 : HTC.ShareVariables.pub_sMaKX092) + dtNgayDK.Text))
        //    Cache[odsThuoc.CacheKeyDependency] = ((_NoiTT == "091" ? HTC.ShareVariables.pub_sMaKX091 : HTC.ShareVariables.pub_sMaKX092) + dtNgayDK.Text) + dtNgayDK.Text;

        //if (Cache[odsThuocDY.CacheKeyDependency] == null)
        //    Cache[odsThuocDY.CacheKeyDependency] = cboDoiTuong.SelectedValue;
        //else if (Cache[odsThuocDY.CacheKeyDependency].ToString() != cboDoiTuong.SelectedValue)
        //    Cache[odsThuocDY.CacheKeyDependency] = cboDoiTuong.SelectedValue;

        //if (Cache[odsDichVu.CacheKeyDependency] == null)
        //    Cache[odsDichVu.CacheKeyDependency] = cboDoiTuong.SelectedValue;
        //else if (Cache[odsDichVu.CacheKeyDependency].ToString() != cboDoiTuong.SelectedValue + _NoiTT)
        //    Cache[odsDichVu.CacheKeyDependency] = cboDoiTuong.SelectedValue + _NoiTT;
    }
    private void ShowHideThuocThang()
    {
        RadTabStrip1.Tabs[4].Visible = _IsBVYHocCoTruyen;

    }

    private void LoadDetails(Boolean _load = true, int selectedTabIndex = 0, Boolean goi = false)
    {
        try
        {

            LoadDetails_ThongTin(_load);

            //grdCTT.MasterTableView.EnableColumnsViewState = false;
            //grdCTT.MasterTableView.ViewStateMode = ViewStateMode.Disabled;
            //grdDTT.MasterTableView.EnableColumnsViewState = false;
            //grdDTT.MasterTableView.ViewStateMode = ViewStateMode.Disabled;
            //grdXNTT.MasterTableView.EnableColumnsViewState = false;
            //grdXNTT.MasterTableView.ViewStateMode = ViewStateMode.Disabled;
            //grdThuoc.MasterTableView.EnableColumnsViewState = false;
            //grdThuoc.MasterTableView.ViewStateMode = ViewStateMode.Disabled;
            //grdThuocDY.MasterTableView.EnableColumnsViewState = false;
            //grdThuocDY.MasterTableView.ViewStateMode = ViewStateMode.Disabled;
            //grdDanhSachDY.MasterTableView.EnableColumnsViewState = false;
            //grdDanhSachDY.MasterTableView.ViewStateMode = ViewStateMode.Disabled;
            //grdLichSuKham.MasterTableView.EnableColumnsViewState = false;
            //grdDanhSachDY.MasterTableView.ViewStateMode = ViewStateMode.Disabled;
            //RadPageView1.EnableViewState = false;
            //RadPageView1.ViewStateMode = ViewStateMode.Disabled;
            //RadPageView2.EnableViewState = false;
            //RadPageView2.ViewStateMode = ViewStateMode.Disabled;
            //RadPageView3.EnableViewState = false;
            //RadPageView3.ViewStateMode = ViewStateMode.Disabled;
            //RadPageView4.EnableViewState = false;
            //RadPageView4.ViewStateMode = ViewStateMode.Disabled;
            //RadPageView5.EnableViewState = false;
            //RadPageView5.ViewStateMode = ViewStateMode.Disabled;
            if (selectedTabIndex >= 0)
            {
                RadTab selectedTab = RadTabStrip1.Tabs[selectedTabIndex];
                if (selectedTab != null)
                {
                    switch (selectedTabIndex)
                    {
                        case 0:
                            RadPageView1.EnableViewState = true;
                            //RadPageView1.ViewStateMode = ViewStateMode.Enabled;

                            //grdCTT.MasterTableView.EnableColumnsViewState = true;
                            //grdCTT.MasterTableView.ViewStateMode = ViewStateMode.Enabled;

                            LoadDetails_KhamBenh_CTT(_load);

                            break;
                        case 1:
                            RadPageView2.EnableViewState = true;
                            //RadPageView2.ViewStateMode = ViewStateMode.Enabled;
                            //grdDTT.MasterTableView.EnableColumnsViewState = true;
                            //grdDTT.MasterTableView.ViewStateMode = ViewStateMode.Enabled;

                            LoadDetails_KhamBenh_DTT(_load);
                            break;
                        case 2:
                            {
                                //grdXNTT.MasterTableView.EnableColumnsViewState = true;
                                //grdXNTT.MasterTableView.ViewStateMode = ViewStateMode.Enabled;
                                RadPageView3.EnableViewState = true;
                                RadPageView3.ViewStateMode = ViewStateMode.Enabled;
                                LoadDetails_KhamBenh_XNTT(_load);

                                //grdXNTT.MasterTableView.IsItemInserted = true;
                                //grdXNTT.DataBind();
                                if (_LoaiPhieu == 2)
                                    cboKhoaKB.Focus();
                                else
                                    cboNhanVien.Focus();

                                break;
                            }

                        case 3:
                            {
                                //grdThuoc.MasterTableView.EnableColumnsViewState = true;
                                //grdThuoc.MasterTableView.ViewStateMode = ViewStateMode.Enabled;
                                //RadPageView4.EnableViewState = true;
                                //RadPageView4.ViewStateMode = ViewStateMode.Enabled;
                                LoadDetails_KhamBenh_ThuocSuDung(_load, goi);
                                tinhlaihd();
                                break;
                            }
                        case 4:
                            {
                                //grdThuocDY.MasterTableView.EnableColumnsViewState = true;
                                //grdThuocDY.MasterTableView.ViewStateMode = ViewStateMode.Enabled;
                                //grdDanhSachDY.MasterTableView.EnableColumnsViewState = true;
                                //grdDanhSachDY.MasterTableView.ViewStateMode = ViewStateMode.Enabled;
                                //RadPageView5.EnableViewState = true;
                                //RadPageView5.ViewStateMode = ViewStateMode.Enabled;
                                LoadDetails_KhamBenh_ThuocThang(_load, goi);
                                LoadDetails_KhamBenh_ThuocThangList(_load, goi);
                                if (_KhamBenh_ThuocSD_DY == null)
                                    _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
                                if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList == null)
                                    _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList = KhamBenh_ThuocSD_DYList.NewList();

                                if (_KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs.Count == 0 && _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count == 0)
                                {
                                    grdThuocDY.MasterTableView.IsItemInserted = true;
                                    grdThuocDY.DataBind();
                                    cboBSDongY.Focus();
                                }
                                break;

                            }
                        //case 5:
                        //    LoadDetails_KhamBenh_VTTH(_load, goi);
                        //    break;

                        //case 6:
                        //    LoadDetails_KhamBenh_HoaChat(_load, goi);
                        //    break;

                        //case 7:
                        //    LoadDetails_KhamBenh_Mau(_load);
                        //  break;

                    }

                }
            }

        }
        catch (Exception ex)
        {
            ShowMessage("Không hiển thị được dữ liệu" + ex.Message);


        }

        DataTable dt = spDMUpdateVV_KB(_ThongtinBN.MaBN);
        if (dt != null && dt.Rows.Count > 0)
        {
            string mavaovien = dt.Rows[0][0].ToString();
            string lydovaovien = dt.Rows[0][1].ToString();
            string makhambenh = dt.Rows[0][2].ToString();
            string doituongkhambenh = dt.Rows[0][3].ToString();
            cbolydovaovien.SelectedValue = mavaovien;
            cbolydovaovien.Text = lydovaovien;
            cbodoituongkhambenh.SelectedValue = makhambenh;
            cbodoituongkhambenh.Text = doituongkhambenh;
        }


    }

    private void LoadData(Boolean _load = true)
    {

        cbolydovaovien.DataSource = GetDMlydovaovienM();// combo 
        cbolydovaovien.DataBind();

        cbodoituongkhambenh.DataSource = GetDMdoituongkhambenhM();// combo 
        cbodoituongkhambenh.DataBind();

        if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _LoaiPhieu != 7 && _LoaiPhieu != 1 && _NoiTT == "085")
            _LoaiPhieu = 2;

        try
        {
            if (_MaBN == "")
            {
                //if (Pub_sCodePatient != null)
                //    if (Pub_sCodePatient != "")
                //    {
                //_MaBN = Pub_sCodePatient;
                dtNgayDK.Text = DateTime.Now.ToString("dd/MM/yyyy");
                WriteLog(" dtNgayDK.Text: " + dtNgayDK.Text);
                //DateTime ngayDK = DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);
                //Pub_sCodePatient = "";
                //}
            }
            if (!string.IsNullOrEmpty(_MaBN))
            {
                if (_load == true)
                {

                    if (_LoaiPhieu == 1 && _Duyet == 1)
                        _ThongtinBN = ThongtinBN.GetThongtinBN(_MaBN, _NgayDK, 11, _NoiTT);
                    else
                        _ThongtinBN = ThongtinBN.GetThongtinBN(_MaBN, _NgayDK, _LoaiPhieu, _NoiTT);
                    if (_LoaiPhieu == 2 && (HTC.ShareVariables.pub_spC == "PS"))
                    {
                        ThongtinBN _obttbn = ThongtinBN.GetThongtinBN(_MaBN, _NgayDK, 9, _NoiTT);
                        if (_obttbn.KhamBenh.KhamBenh_GetsDichVuCTTList.Count > 0)
                            OpenWindow("frmLapPhieu.aspx?LoaiPhieu=9&noitt=" + _NoiTT + "&duyet=" + _Duyet + "&MaBN=" + _MaBN + "&NgayDK=" + _NgayDK + "&PubMaDT=" + _PubMaDT);
                        _obttbn = null;
                    }
                    else if (_LoaiPhieu == 8 && (HTC.ShareVariables.pub_spC == "PS") && _ThongtinBN.KhamBenh.KyQuyBH != "0" && _ThongtinBN.KhamBenh.KyQuyBH != "")
                    {
                        if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                        {
                            if (_ThongtinBN.KhamBenh.KhamBenh_C_List[0].MaHuongDT != "")

                                OpenWindow("frmPhieuChiBT.aspx?LoaiPhieu=8&madt=" + _MaDT + "&NoiTT=" + _NoiTT + "&MaBN=" + _MaBN + "&NgayDK=" + _NgayDK.ToString());
                        }
                    }
                }

                if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "1" && _LoaiPhieu == 2 && (_ThongtinBN.KhamBenh.TongTienBHCTT > 0 || _ThongtinBN.KhamBenh.TongTienTTCTT > 0) && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "PH"))
                {
                    baraction.FindItemByValue("cmdDuyetBH").Visible = true;
                    baraction.FindItemByValue("cmdAddXN").Visible = false;
                }
                else if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "1" && _LoaiPhieu == 2 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH"))
                {
                    baraction.FindItemByValue("cmdDuyetBH").Visible = false;
                    baraction.FindItemByValue("cmdAddXN").Visible = true;
                }
                else
                    baraction.FindItemByValue("cmdDuyetBH").Visible = false;
                if ((_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList != null || _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList != null) && _LoaiPhieu == 2 && _ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "1")
                {
                    if (_LoaiPhieu == 2 && (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count > 0) && _ThongtinBN.KhamBenh.NgayQT == "")
                    {
                        if (dtNgayQT.Text == "")
                        {
                            dtNgayQT.Text = DateTime.Now.ToString("dd/MM/yyyy");
                        }
                        _ThongtinBN.KhamBenh.NgayQT = dtNgayQT.Text + " " + DateTime.Now.ToString("HH:mm");

                    }
                    else if (_LoaiPhieu == 2 && (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count > 0) && _ThongtinBN.KhamBenh.NgayQT == "")
                    {
                        if (dtNgayQT.Text == "")
                        {
                            dtNgayQT.Text = DateTime.Now.ToString("dd/MM/yyyy");
                        }
                        _ThongtinBN.KhamBenh.NgayQT = dtNgayQT.Text + " " + DateTime.Now.ToString("HH:mm");
                    }
                }
                if (_LoaiPhieu == 2 && _ThongtinBN.KhamBenh.NgayQT == "" && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0 && dtNgayQT.Text == "" && _ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "1" && HTC.ShareVariables.pub_spC !="PS"  )
                {
                    if (dtNgayQT.Text == "")
                    {
                        dtNgayQT.Text = DateTime.Now.ToString("dd/MM/yyyy");
                    }
                    _ThongtinBN.KhamBenh.NgayQT = dtNgayQT.Text + " " + DateTime.Now.ToString("HH:mm");
                }
                
                _ThongtinBN.KhamBenh.loai = _LoaiPhieu;
                if (_LoaiPhieu == 1 && _Duyet == 1 && (HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "HH"))
                    _ThongtinBN.KhamBenh.loai = 11;

                if ((_ThongtinBN.MaDT.Substring(0, 1) != "0" && _LoaiPhieu == 2 && (HTC.ShareVariables.pub_spC != "HU" && HTC.ShareVariables.pub_spC != "QN" && HTC.ShareVariables.pub_spC != "PH")) || _LoaiPhieu != 2 || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                {

                    cboDoiTuong.SelectedValue = _ThongtinBN.MaDT;
                    if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                        _MaKhoa = _ThongtinBN.KhamBenh.KhamBenh_C_List[0].Makhoa;
                    if (_NoiTT == "085" && (cboDoiTuong.SelectedValue == "00002" || cboDoiTuong.SelectedValue == "00003"))
                    {
                        cboDoiTuong.SelectedValue = "00001";
                        _ThongtinBN.MaDT = "00001";
                        cboDoiTuong.SelectedValue = "00001";
                    }
                    else if (_NoiTT == "085" && (cboDoiTuong.SelectedValue.Substring(0, 1) == "1") && _PubMaDT == "TT")
                    {
                        cboDoiTuong.SelectedValue = "00001";
                        _ThongtinBN.MaDT = "00001";
                        cboDoiTuong.SelectedValue = "00001";
                    }
                    else if (_NoiTT == "085" && (cboDoiTuong.SelectedValue.Substring(0, 1) == "1") && _PubMaDT == "CR")
                    {
                        cboDoiTuong.SelectedValue = "00007";
                        _ThongtinBN.MaDT = "00007";
                        cboDoiTuong.SelectedValue = "00007";
                    }
                    else if (_NoiTT == "090" && _ThongtinBN.KhamBenh.IsNew == true)
                    {
                        cboDoiTuong.SelectedValue = "00001";
                        _ThongtinBN.MaDT = "00001";
                        cboDoiTuong.SelectedValue = "00001";
                    }
                    else if ((_NoiTT == "087" || _NoiTT == "095") && (_LoaiPhieu == 1 || _LoaiPhieu == 7 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && HTC.ShareVariables.pub_spC != "HU" && HTC.ShareVariables.pub_spC != "QN" && HTC.ShareVariables.pub_spC != "PH")
                    {
                        if (_ThongtinBN.KhamBenh.MaDT == "00001" || _ThongtinBN.KhamBenh.MaDT == "00003" || _ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "1")
                        {
                            cboDoiTuong.SelectedValue = "00002";
                            _ThongtinBN.MaDT = "00002";
                            cboDoiTuong.SelectedValue = "00002";
                        }
                    }
                    else if ((_NoiTT == "087" || _NoiTT == "095") && (_LoaiPhieu == 1 || _LoaiPhieu == 7 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH"))
                    {
                        if (_ThongtinBN.KhamBenh.MaDT == "00001" || _ThongtinBN.KhamBenh.MaDT == "00004" || _ThongtinBN.KhamBenh.MaDT == "00005")
                        {
                            cboDoiTuong.SelectedValue = "00002";
                            _ThongtinBN.MaDT = "00002";
                            cboDoiTuong.SelectedValue = "00002";
                        }
                    }
                    else if (_NoiTT == "093" && (cboDoiTuong.SelectedValue.Substring(0, 1) == "0"))
                    {
                        cboDoiTuong.SelectedValue = "00003";
                        _ThongtinBN.MaDT = "00003";
                        cboDoiTuong.SelectedValue = "00003";
                    }

                    LoadDetails(true, CurrentTabIndex);

                    if ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 1) && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count < 1)
                    {
                        if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count == 0 && _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count == 0 && _ThongKe_BenhNhan_NgoaiTruListInfo == null && _ThongtinBN.MaBN != "")
                        {
                            DateTime d=DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);

                            if (_PubMaDT == "TT")
                            {
                                _ThongKe_BenhNhan_NgoaiTruListInfo = ThongKe_BenhNhan_NgoaiTruListInfo.GetThongKe_BenhNhan_NgoaiTru_Info(d, d, "All", 7, _NoiTT);

                            }
                            else if (_PubMaDT == "BH")
                            {
                                _ThongKe_BenhNhan_NgoaiTruListInfo = ThongKe_BenhNhan_NgoaiTruListInfo.GetThongKe_BenhNhan_NgoaiTru_Info(d, d, "All", 8, _NoiTT);

                            }
                            else
                            {
                                _ThongKe_BenhNhan_NgoaiTruListInfo = ThongKe_BenhNhan_NgoaiTruListInfo.GetThongKe_BenhNhan_NgoaiTru_Info(d, d, "All", 9, _NoiTT);

                            }

                            _KhamBenh_GETsMABNListInfo = KhamBenh_GETsMABNListInfo.GetAllKhamBenh_GETsMABNInfo(_ThongtinBN.MaBN, 1, "");
                            grdXNTT.Height = 100;
                            grdLichSuKham.DataSource = _KhamBenh_GETsMABNListInfo;
                            grdLichSuKham.DataBind();
                            grdKhoa.DataSource = _ThongKe_BenhNhan_NgoaiTruListInfo;
                            grdKhoa.DataBind();
                            grdKhoa.Visible = true;
                            grdLichSuKham.Visible = true;
                        }
                    }
                    return;
                }

            }

            // neu ko ton tai ban ghi nao
            _MaBN = "";


            _NgayDK = DateTime.Now;

            _ThongtinBN = ThongtinBN.NewThongtinBN();

            _ThongtinBN.NgayDK = _NgayDK.ToString("dd/MM/yyyy");
            //WriteLog("  _ThongtinBN.NgayDK: " + _ThongtinBN.NgayDK);

            _ThongtinBN.KhamBenh.loai = _LoaiPhieu;
            _ThongtinBN.KhamBenh.LoaiKham = 0;
            _ThongtinBN.MaQG = "00084";
            if (_NoiTT == "087" || _NoiTT == "095")
            {
                _ThongtinBN.KhamBenh.MaDT = "00002";
                _ThongtinBN.MaDT = "00002";
                cboDoiTuong.SelectedValue = "00002";
            }
            else if (_NoiTT == "093")
            {
                _ThongtinBN.KhamBenh.MaDT = "00003";
                _ThongtinBN.MaDT = "00003";
                cboDoiTuong.SelectedValue = "00003";
            }
            else if (_NoiTT == "085" && _PubMaDT == "CR")
            {
                _ThongtinBN.KhamBenh.MaDT = "00007";
                _ThongtinBN.MaDT = "00007";
                cboDoiTuong.SelectedValue = "00007";
            }
            else if (_NoiTT == "085")
            {
                _ThongtinBN.KhamBenh.MaDT = "00001";
                _ThongtinBN.MaDT = "00001";
                cboDoiTuong.SelectedValue = "00001";
            }
            if (HTC.ShareVariables.pub_sMaTinh != "" && _LoaiPhieu != 7)
            {
                if (cbotinh.Text != HTC.ShareVariables.pub_sTenTinh)
                {
                    cbotinh.Text = HTC.ShareVariables.pub_sTenTinh;
                    cbotinh.SelectedValue = HTC.ShareVariables.pub_sMaTinh;
                    cbohuyen.DataBind();
                }
            }

            if ((HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "HH"))

                if (_ThongtinBN.GT == true)
                {
                    optGT.Items[0].Selected = true;
                    optGT.Items[1].Selected = false;
                }
                else
                {
                    optGT.Items[1].Selected = true;
                    optGT.Items[0].Selected = false;
                }

            if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count > 0)
                CurrentTabIndex = 0;
            else if (_LoaiPhieu == 2 && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH"))
                CurrentTabIndex = 2;
            else if (_LoaiPhieu == 1)
                CurrentTabIndex = 2;
            else if ((_LoaiPhieu == 9 || _LoaiPhieu == 8))
                CurrentTabIndex = 2;
            else if (_LoaiPhieu == 7 && (_NoiTT == "090" || _NoiTT == "087" || _NoiTT == "094" || _NoiTT == "093" || (_NoiTT == "085" && HTC.ShareVariables.pub_spC == "QN")))
                CurrentTabIndex = 4;
            else if ((_LoaiPhieu == 7 && HTC.ShareVariables.pub_spC != "PS") || _LoaiPhieu == 3)
                CurrentTabIndex = 3;
            else if (_LoaiPhieu == 7)
                CurrentTabIndex = 1;
            txtindextab.Value = CurrentTabIndex.ToString();
            LoadDetails(true, CurrentTabIndex);

            //if (_LoaiPhieu == 1 || (HTC.ShareVariables.pub_spC == "PS" ||HTC .ShareVariables .pub_spC =="HU"))
            //    cboLoaiBN.Focus();
            //else 
            if (_LoaiPhieu == 2 && HTC.ShareVariables.pub_spC == "YH")
                txtQRCode.Focus();
            else if (_LoaiPhieu == 2 && HTC.ShareVariables.pub_spC != "PS")
                txtSoThe.Focus();
            else if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && HTC.ShareVariables.pub_spC != "PS")
                txthoten.Focus();
            else if ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && HTC.ShareVariables.pub_spC == "PS")

                txtKyhieu.Focus();
            else

                txtmabn.Focus();

        }
        catch (Exception ex)
        {
            ShowMessage("Không load được dữ liệu" + ex.Message);


        }

    }
    protected void grdDanhSach_ItemCommand(object sender, Telerik.Web.UI.GridCommandEventArgs e)
    {
        if (e.CommandName == "Edit")
        {

            try
            {
                //GridDataItem item = grdDanhSach.MasterTableView.Items[e.CommandArgument.ToString()] as GridDataItem;
                GridEditableItem editedItem = e.Item as GridEditableItem;
                string mabn = editedItem.GetDataKeyValue("MaBN").ToString();
                grdDanhSach.Visible = false;
                txtmabn.Text = mabn;
                SearchBN();
                e.Canceled = true;
                grdDanhSach.Visible = false;

            }
            catch (Exception)
            {
                //throw;
            }
        }
    }

    protected void btnSearch_Click(object sender, EventArgs e)
    {
    }
    private bool SearchData()
    {
        try
        {

            string dk = "";
            if (dtNgaySinh.Text != "")
            {
                dk = dk + " and year(a.ngaysinh)=" + dtNgaySinh.Text.Substring(6, 4);
            }
            ThongtinBNList _ThongTinBNList = ThongtinBNList.FindThongtinBN(0, txtmabn.Text, txthoten.Text, true, txtSoThe.Text, cboDKBD.SelectedValue, DateTime.Parse(dtBHYTDN.Text == "" ? "01/01/1900" : dtBHYTDN.Text), txtDiaChi.Text, txtdienthoai.Text, "", "", "", 0, DateTime.Parse("01/01/1900"), optGT.Items[0].Selected, "", cboquocgia.SelectedValue, cbotinh.SelectedValue, cbohuyen.SelectedValue, "", "", "", "", "", DateTime.Parse("01/01/1900"), DateTime.Parse("01/01/1900"), dk, DateTime.Parse("01/01/1900"), false, (dtNgaySinh.Text != "" ? true : false));
            if (_ThongTinBNList.Count > 0)
            {
                if (_ThongTinBNList.Count > 1)
                {
                    grdDanhSach.Visible = true;
                    grdDanhSach.DataSource = _ThongTinBNList;
                    grdDanhSach.DataBind();
                }
                else
                {
                    grdDanhSach.Visible = false;
                    txtmabn.Text = _ThongTinBNList[0].MaBN;
                    SearchBN();
                    ShowMessage("Đã tồn tại bệnh nhân này trong dữ liệu");
                }
            }
            return true;
        }
        catch (Exception ex)
        {
            ShowMessage("Không thể kiểm tra được dữ liệu" + ex.Message);
            return true;
        }
    }
    protected void baraction_ButtonClick(object sender, RadToolBarEventArgs e)
    {
        try
        {
            if ((_NoiTT == "091" || _NoiTT == "092") && HTC.ShareVariables.pub_spC == "PS" && (((RadToolBarButton)e.Item).CommandName.Equals("cmdSave", StringComparison.InvariantCultureIgnoreCase)))
                ((RadToolBarButton)e.Item).CommandName = "cmdPrint";
            if (_LoaiPhieu != 1 && _LoaiPhieu != 7 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _NoiTT == "085")
            {
                _LoaiPhieu = 2;
            }

            if (((RadToolBarButton)e.Item).CommandName.Equals("cmdFilter", StringComparison.InvariantCultureIgnoreCase))
            {
                SearchData();


            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdSave", StringComparison.InvariantCultureIgnoreCase))
            {

                if (UpdateDataSave())
                {
                    clearBN();

                }
                else
                {
                    txtMaKhoa.Text = "";
                    cboKhoaKB.SelectedValue = "";
                    cboKhoaKB.Text = "";
                    baraction.FindItemByValue("cmdPrint").Enabled = true;
                }
            }

            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdExit", StringComparison.InvariantCultureIgnoreCase))
            {
                if (_LoaiPhieu == 1 && _Duyet == 1 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH"))
                    Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={1}&&noitt={0}&&duyet={2}&PubMaDT={5}&&maBN={3}&&ngayDK={4}", _NoiTT, 2, 1, _ThongtinBN.MaBN, dtNgayDK.Text, ""), false);
                else
                    Response.Redirect("~/Default.aspx");
            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdQRCode", StringComparison.InvariantCultureIgnoreCase))
            {
                if (ttqrcode.Visible == false)
                    ttqrcode.Visible = true;
                else
                    ttqrcode.Visible = false;
            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdHuy", StringComparison.InvariantCultureIgnoreCase))
            {
                // Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={1}&&noitt={0}&&duyet={2}&PubMaDT={3}", _NoiTT, _LoaiPhieu, _Duyet, _PubMaDT), false);
                clearBN();
                if (Pub_bQuyenForm >= HTC.ShareVariables.KieuFormChiTiet.fThem)
                    baraction.FindItemByValue("cmdPrint").Enabled = true;

            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdLayBN", StringComparison.InvariantCultureIgnoreCase))
            {
                if (Pub_sMaBN != "")
                {
                    txtmabn.Text = Pub_sMaBN;
                    _MaBN = Pub_sMaBN;
                    DateTime d= DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);
                    _ThongtinBN = ThongtinBN.GetThongtinBN(txtmabn.Text, d, _LoaiPhieu, _NoiTT);
                    LoadData(false);
                    SetData();
                    enableTNBN(false);
                    BefoChuyenDT();
                    cboDoiTuong.SelectedValue = _ThongtinBN.KhamBenh.MaDT;
                    if (_LoaiPhieu == 2 && HTC.ShareVariables.pub_spC != "PS")
                        chkTraiTuyen.Focus();
                    else if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && HTC.ShareVariables.pub_spC != "PS")
                        txtMaKhoa.Focus();
                    else if (_LoaiPhieu == 1 && _PubMaDT == "TT")
                        cboChuyenKhoa.Focus();
                    else if (_LoaiPhieu == 1 && _PubMaDT == "BH")
                        chkTraiTuyen.Focus();
                    else if (_LoaiPhieu == 1)
                        txtMaKhoa.Focus();
                    grdKhoa.Visible = false;
                    grdLichSuKham.Visible = false;
                }
            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdSua", StringComparison.InvariantCultureIgnoreCase))
            {
                enableTNBN(true);
                dtNgayDK.Enabled = false;
                txtmabn.Enabled = false;
                txtSoThe.Enabled = true;
                if (_PubMaDT == "TT")
                {
                    ttbh.Visible = false;
                    ttgt.Visible = false;
                }
                else
                {
                    ttbh.Visible = true;
                    ttgt.Visible = true;
                }
                if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN")
                    cboDoiTuong.Enabled = true;

            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdPrint", StringComparison.InvariantCultureIgnoreCase))
            {
                if (UpdateDataSave(true))
                {

                    if (_LoaiPhieu == 1 || (_LoaiPhieu == 2 && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 1 && HTC.ShareVariables.pub_spC == "YH"))
                        PrintDataDV(false);
                    else if (_LoaiPhieu == 3)
                        PrintDataDV(false);
                    else if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 1 && HTC.ShareVariables.pub_spC == "PH" && txtkyquy.Text != "" && txtkyquy.Text != "0" && _ThongtinBN.KhamBenh.KyQuyBH != "")
                        PrintDataDV(false);
                    else if (((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0 && _NoiTT == "085"))
                    {
                        if (_LoaiPhieu == 7 && (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count >= 1 || _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count >= 1))
                        {
                            if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                            {
                                if (_ThongtinBN.KhamBenh.KhamBenh_C_List[0].MaDV.Substring(0, 2) == "ST")

                                    PrintDataDV(false);
                            }
                            else
                            {
                                PrintDataDV(false);
                            }
                        }
                        else if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                        {
                            if (_ThongtinBN.KhamBenh.KhamBenh_C_List[0].STT <= 1 && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 1)
                                PrintDataDV(false);
                        }
                        //if ((_LoaiPhieu == 2 && HTC.ShareVariables.pub_spC == "HU"))
                        //{
                        //    PrintDataPTHD(null);

                        //}
                        foreach (KhamBenh_HoaDon kb in _ThongtinBN.KhamBenh.KhamBenh_HoaDonList)
                        {
                            if ((HTC.ShareVariables.pub_spC == "PS") && ((_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 2) && kb.Sophieu == 0 && (kb.TongThu - kb.TongChi >= 1000) && kb.NgayLap == "")
                                PrintDataHD(kb);
                            if (_LoaiPhieu == 7 && (HTC.ShareVariables.pub_spC == "QN"))
                            {
                                PrintDataDV(false, kb.SoSoHD, kb.SoHD, ((kb.Sophieu == 1 && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || (_NoiTT == "090" || _NoiTT == "094" || _NoiTT == "093"))) ? byte.Parse("1") : byte.Parse("2")));
                                if (kb.NgayLap == "" || HTC.ShareVariables.pub_spC == "QN")
                                    PrintDataThuocDY(true, "", kb.SoHD, kb.SoSoHD);
                                else if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count > 0)
                                {
                                    if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList[0].NguoiLap == Pub_sNguoiSD)
                                        PrintDataThuocDY(true, "", kb.SoHD, kb.SoSoHD);

                                }
                            }
                            else if ((_LoaiPhieu == 7 && (HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "QN") && ((HTC.ShareVariables.pub_spC == "QN" && _NoiTT == "085") || _NoiTT == "090" || (_LoaiPhieu == 7 && _NoiTT == "087")) || (_LoaiPhieu == 7 && _NoiTT == "087")) && kb.Sophieu == 0)
                            {
                                if (kb.NgayLap == "" || HTC.ShareVariables.pub_spC == "QN")
                                    PrintDataThuocDY(true, "", kb.SoHD, kb.SoSoHD);
                                else if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count > 0)
                                {
                                    if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList[0].NguoiLap == Pub_sNguoiSD)
                                        PrintDataThuocDY(true, "", kb.SoHD, kb.SoSoHD);

                                }
                            }
                            else if (kb.NgayLap == "" && ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")))
                            {
                                PrintDataDV(false, kb.SoSoHD, kb.SoHD, ((kb.Sophieu == 1 && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || (_NoiTT == "090" || _NoiTT == "094" || _NoiTT == "093"))) ? byte.Parse("1") : byte.Parse("2")));

                            }
                            else if (kb.NgayLap == "" && (_LoaiPhieu == 2 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")))
                            {
                                PrintDataPTHD(kb);

                            }
                            else if (kb.NgayLap == "" && ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && HTC.ShareVariables.pub_spC == "PS"))
                            {
                                PrintDataDV(false, kb.SoSoHD, kb.SoHD, ((kb.Sophieu == 1 && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || (_NoiTT == "090" || _NoiTT == "094" || _NoiTT == "093"))) ? byte.Parse("1") : byte.Parse("2")));


                            }
                            else if (kb.NgayLap == "" && ((_LoaiPhieu == 7 && (HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "HH")) || (HTC.ShareVariables.pub_spC == "YH")))
                            {
                                PrintDataDV(false, kb.SoSoHD, kb.SoHD, ((kb.Sophieu == 1 && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || (_NoiTT == "090" || (_LoaiPhieu == 7 && _NoiTT == "087") || _NoiTT == "094" || _NoiTT == "093"))) ? byte.Parse("1") : byte.Parse("2")));

                            }
                        }
                    }
                    else if (_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 7)
                    {
                        //if ((_LoaiPhieu == 2 && HTC.ShareVariables.pub_spC == "HU"))
                        //{
                        //    PrintDataPTHD(null);

                        //}
                        if (HTC.ShareVariables.pub_spC == "PS")
                        {
                            if (_KhamBenh_DongTienList != null)
                            {
                                foreach (KhamBenh_DongTien kb in _KhamBenh_DongTienList)
                                {
                                    if (kb.Huy == false && kb.MaLDThuTien == "00020")
                                        PrintDataPhieuChi(kb);
                                }
                            }
                        }
                        foreach (KhamBenh_HoaDon kb in _ThongtinBN.KhamBenh.KhamBenh_HoaDonList)
                        {
                            if ((HTC.ShareVariables.pub_spC == "PS") && ((_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 2) && kb.Sophieu == 0 && (kb.TongThu - kb.TongChi >= 1000) && kb.NgayLap == "")
                            {
                                PrintDataHD(kb);

                            }
                            if ((HTC.ShareVariables.pub_spC == "YH") && ((_LoaiPhieu == 9 || _LoaiPhieu == 8) || ((_NoiTT == "090" || _NoiTT == "087") && _LoaiPhieu == 7)) && kb.Sophieu == 0 && (kb.TongThu - kb.TongChi >= 1000) && kb.NgayLap == "")
                            {
                                PrintDataHD(kb);

                            }
                            if ((HTC.ShareVariables.pub_spC == "HH") && ((_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 2) && kb.Sophieu == 0 && (kb.TongThu - kb.TongChi >= 1000) && kb.NgayLap == "")
                            {
                                PrintDataHD(kb);

                            }
                            if (_LoaiPhieu == 7 && HTC.ShareVariables.pub_spC == "QN")
                            {
                                if (_LoaiPhieu == 7 && (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count >= 1 || _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count >= 1))
                                {
                                    if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                                    {
                                        if (_ThongtinBN.KhamBenh.KhamBenh_C_List[0].MaDV.Substring(0, 2) == "ST")
                                            PrintDataDV(false, kb.SoSoHD, kb.SoHD, ((kb.Sophieu == 1 && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || (_NoiTT == "090" || _NoiTT == "094" || _NoiTT == "093"))) ? byte.Parse("1") : byte.Parse("2")));
                                    }
                                    else
                                    {
                                        PrintDataDV(false, kb.SoSoHD, kb.SoHD, ((kb.Sophieu == 1 && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || (_NoiTT == "090" || _NoiTT == "094" || _NoiTT == "093"))) ? byte.Parse("1") : byte.Parse("2")));

                                    }
                                }
                                PrintDataThuocDY(true, "", kb.SoHD, kb.SoSoHD);
                            }
                            else if (kb.NgayLap == "" && (_LoaiPhieu == 7 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && kb.Sophieu == 1))
                            {
                                PrintDataDV(false, kb.SoSoHD, kb.SoHD, ((kb.Sophieu == 1 && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || (_NoiTT == "090" || _NoiTT == "094" || _NoiTT == "093"))) ? byte.Parse("1") : byte.Parse("2")));

                            }
                            else if ((_LoaiPhieu == 7 && kb.NgayLap == "" && (HTC.ShareVariables.pub_spC == "YH") && (_NoiTT == "090" || (_LoaiPhieu == 7 && _NoiTT == "087") || _NoiTT == "094" || _NoiTT == "093") && kb.Sophieu == 0))
                            {
                                PrintDataThuocDY(true, "", kb.SoHD, kb.SoSoHD);

                            }
                            else if (kb.NgayLap == "" && ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")))
                            {
                                PrintDataDV(false, kb.SoSoHD, kb.SoHD, ((kb.Sophieu == 1 && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || (_NoiTT == "090" || _NoiTT == "094" || _NoiTT == "093"))) ? byte.Parse("1") : byte.Parse("2")));

                            }
                            else if (kb.NgayLap == "" && (_LoaiPhieu == 2 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN")))
                            {
                                PrintDataPTHD(kb);
                            }
                            else if (kb.NgayLap == "" && ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && HTC.ShareVariables.pub_spC == "PS" && (_NoiTT == "087" || _NoiTT == "095")))
                            {
                                PrintDataDV(false, kb.SoSoHD, kb.SoHD, ((kb.Sophieu == 1 && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || (_NoiTT == "090" || _NoiTT == "094" || _NoiTT == "093"))) ? byte.Parse("1") : byte.Parse("2")));

                            }
                            else if (kb.NgayLap == "" && ((_LoaiPhieu == 7 && (HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "HH")) || (HTC.ShareVariables.pub_spC == "YH")))
                            {
                                PrintDataDV(false, kb.SoSoHD, kb.SoHD, ((kb.Sophieu == 1 && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || ((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093"))) ? byte.Parse("1") : byte.Parse("2")));
                                if (_LoaiPhieu == 7 && cboLoaiBN.SelectedValue == "10" && (_NoiTT == "091" || _NoiTT == "092"))
                                {
                                    PrintDataHD(kb);
                                }
                            }


                        }
                        if (HTC.ShareVariables.pub_spC == "YH" && (_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085")
                            PrintDataHoanDV();

                    }

                    if ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && dtNgayQT.Text == "")
                        if (HTC.ShareVariables.pub_spC != "HU" && HTC.ShareVariables.pub_spC != "PS" && _KhamBenh_DongTienList != null)
                        {
                            PrintDataPT(false);

                        }
                        else if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _KhamBenh_DongTienList != null)
                        {
                            if (_KhamBenh_DongTienList.Count > 0)
                                if (_KhamBenh_DongTienList[0].STT != 1)
                                    PrintDataPT(false);
                        }
                    if ((_LoaiPhieu == 2 || (cboDoiTuong.SelectedValue.Substring(0, 1) == "2" && (_LoaiPhieu == 9 || _LoaiPhieu == 8) && HTC.ShareVariables.pub_spC == "YH") || (_LoaiPhieu == 1 && _Duyet == 1)) && dtNgayQT.Text != "")
                        PrintVPThanhToanBH(true, "");

                    // Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={1}&&noitt={0}&&duyet={2}", _NoiTT, _LoaiPhieu, _Duyet), false);
                    // clearBN();
                    clearBN();

                }
                else
                {
                    txtMaKhoa.Text = "";
                    cboKhoaKB.SelectedValue = "";
                    cboKhoaKB.Text = "";
                    baraction.FindItemByValue("cmdPrint").Enabled = true;
                }
            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdChuaTT", StringComparison.InvariantCultureIgnoreCase))
            {

                Response.Redirect("~/UI/PhongKham/TiepDon/frmDSBenhNhan.aspx?loaiphieu=" + _LoaiPhieu + "&noitt=" + _NoiTT + "&duyet=" + _Duyet + "&LoaiKQCN=0&PubMaDT=" + _PubMaDT);

            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdDaTT", StringComparison.InvariantCultureIgnoreCase))
            {
                Response.Redirect("~/UI/PhongKham/TiepDon/frmDSBenhNhan.aspx?loaiphieu=" + _LoaiPhieu + "&noitt=" + _NoiTT + "&duyet=" + _Duyet + "&LoaiKQCN=1&PubMaDT=" + _PubMaDT);

            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdHoanHD", StringComparison.InvariantCultureIgnoreCase))
            {

                if (Pub_bQuyenForm < HTC.ShareVariables.KieuFormChiTiet.fDelete)
                {
                    ShowMessage("Không có quyền hủy dịch vụ hoặc hủy hóa đơn");
                    return;
                }
                else
                {

                    KhamBenh_GetsDichVu kb = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.FirstOrDefault(x => x.SoHD == _SoHD);
                    if (kb != null)
                    {
                        if (kb.MaSoKham == "")
                        {
                            ShowMessage("Không có quyền hủy dịch vụ hoặc hủy hóa đơn");
                            if (txtGhiChuHD.Text == "" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN"))
                            {
                                Label32.Visible = true;
                                txtGhiChuHD.Visible = true;
                                return;
                            }
                            return;
                        }
                        else if (kb.SLTra != "" && kb.SLTra != "0")
                        {
                            ShowMessage("Không có quyền hủy dịch vụ hoặc hủy hóa đơn");
                            if (txtGhiChuHD.Text == "" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN"))
                            {
                                Label32.Visible = true;
                                txtGhiChuHD.Visible = true;
                                return;
                            }
                            return;
                        }

                    }

                    if (!string.IsNullOrEmpty(_SoHD) && !string.IsNullOrEmpty(_SoSoHD))
                    {
                        KhamBenh_HoaDon hd = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.FirstOrDefault(X => X.SoHD == _SoHD);

                        if (hd == null && _LoaiPhieu != 2)
                        {
                            ShowMessage("Hóa đơn không tồn tại");
                            if (txtGhiChuHD.Text == "" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN"))
                            {
                                Label32.Visible = true;
                                txtGhiChuHD.Visible = true;
                                return;
                            }
                            return;
                        }
                        else if (hd != null)
                        {

                            if (hd.TongChi > 0)
                            {
                                ShowMessage("Hóa đơn này đã hoàn rồi");
                                if (txtGhiChuHD.Text == "" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN"))
                                {
                                    Label32.Visible = true;
                                    txtGhiChuHD.Visible = true;
                                    return;
                                }
                                return;
                            }
                            if (HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ ")
                            {
                                if (DateDiff(DateInterval.Day, DateTime.Parse(hd.NgayThu.Substring(0, 10)), DateTime.Parse(DateTime.Now.ToString().Substring(0, 10))) != 0 && pub_bQadmin == false)
                                {
                                    ShowMessage("Không thể hủy khác ngày!Chỉ admin mới được hủy phiếu");

                                    return;
                                }
                            }
                        }
                        //foreach (KhamBenh_ThuocSD a in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
                        //{
                        //    if (a.Phat == true && a.dadung == false&& a.BHTinhtien ==true &&a.Tinhtien ==false &&a.Huy == false )
                        //    {
                        //        ShowMessage("Thuốc đã phát không thể hoàn hóa đơn");
                        //        return;
                        //    }
                        //}
                        if (txtGhiChuHD.Text == "" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN"))
                        {
                            Label32.Visible = true;
                            txtGhiChuHD.Visible = true;
                            ShowMessage("Nhập lý do hoàn hủy hóa đơn");
                            return;
                        }
                        UpdateDataHoanHD(_SoSoHD, _SoHD);

                        if (_LoaiPhieu == 7 && HTC.ShareVariables.pub_spC != "PS")
                        {
                            UpdatePhieuBan(_SoSoHD, _SoHD);
                            if (HTC.ShareVariables.pub_spC == "QN")
                                UpdatePhieuBanDY(_SoSoHD, _SoHD);
                        }
                        if (HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ " && dtNgayDK.Text != DateTime.Now.ToString("dd/MM/yyyy"))
                        {
                        }
                        else
                            Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={1}&&noitt={0}&&duyet={2}&&maBN={3}&PubMaDT={5}&&ngayDK={4}", _NoiTT, _LoaiPhieu, _Duyet, _ThongtinBN.MaBN, dtNgayDK.Text, _PubMaDT), false);

                    }
                }
            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdHuyHD", StringComparison.InvariantCultureIgnoreCase))
            {
                if (Pub_bQuyenForm < HTC.ShareVariables.KieuFormChiTiet.fDelete)
                    ShowMessage("Không có quyền hủy dịch vụ hoặc hủy hóa đơn");
                else
                    if (!string.IsNullOrEmpty(_SoHD) && !string.IsNullOrEmpty(_SoSoHD))
                    {
                        UpdateDataHoanHD(_SoSoHD, _SoHD, true);
                        Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={1}&&noitt={0}&&duyet={2}&&maBN={3}&PubMaDT={5}&&ngayDK={4}", _NoiTT, _LoaiPhieu, _Duyet, _ThongtinBN.MaBN, dtNgayDK.Text, _PubMaDT), false);
                    }
            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdDuyetBH", StringComparison.InvariantCultureIgnoreCase))
            {

                Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={1}&PubMaDT={5}&&noitt={0}&&duyet={2}&&maBN={3}&&ngayDK={4}", _NoiTT, 1, 1, _ThongtinBN.MaBN, dtNgayDK.Text, "BH"), false);

            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdAddTT", StringComparison.InvariantCultureIgnoreCase))
            {


                OpenWindow("frmLapPhieu.aspx?LoaiPhieu=9&&noitt=" + _NoiTT + "&&duyet=" + _Duyet + "&PubMaDT=" + _PubMaDT + "&&maBN=" + _ThongtinBN.MaBN + "&&ngayDK=" + _NgayDK);

            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdPrintLai", StringComparison.InvariantCultureIgnoreCase))
            {
                if (cboDoiTuong.SelectedValue.Substring(0, 1) != "1" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _LoaiPhieu != 1 && _LoaiPhieu != 7 && _NoiTT == "085")
                    _LoaiPhieu = 9;
                else if (cboDoiTuong.SelectedValue.Substring(0, 1) == "1" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _LoaiPhieu != 1 && _LoaiPhieu != 7 && _NoiTT == "085")
                    _LoaiPhieu = 2;

                if (_LoaiPhieu == 2 && dtNgayQT.Text == "")
                    if (HTC.ShareVariables.pub_spC != "HU" && HTC.ShareVariables.pub_spC != "QN" && HTC.ShareVariables.pub_spC != "PS" && HTC.ShareVariables.pub_spC != "PH" && _KhamBenh_DongTienList != null)
                    {
                        PrintDataPT(false);

                    }
                    else if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _KhamBenh_DongTienList != null)
                    {
                        if (_KhamBenh_DongTienList.Count > 0)
                            if (_KhamBenh_DongTienList[0].STT != 1)
                                PrintDataPT(false);
                    }

                if (_SoHD == "&nbsp")
                    _SoHD = "";
                if (_LoaiPhieu == 1)
                    PrintDataDV(true);

                if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 1 && _NoiTT != "087" && ((HTC.ShareVariables.pub_spC == "HU" && HTC.ShareVariables.pub_sTenBV != "BỆNH VIỆN TRUNG ƯƠNG HUẾ ") || HTC.ShareVariables.pub_spC == "PH") && (_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && dtNgayQT.Text == "")
                {
                    if (_ThongtinBN.KhamBenh.KhamBenh_C_List[0].STT <= 1)
                        PrintDataDV(false);
                }
                else if (_LoaiPhieu == 3)
                {
                    PrintDataDV(false);
                }
                else if (!string.IsNullOrEmpty(_SoSoHD) && ((HTC.ShareVariables.pub_spC == "PS" && pub_bQadmin == true) || (HTC.ShareVariables.pub_spC != "PS")))
                {

                    foreach (KhamBenh_HoaDon kb in _ThongtinBN.KhamBenh.KhamBenh_HoaDonList)
                    {

                        if (kb.SoSoHD == _SoSoHD && kb.SoHD == _SoHD)
                        {

                            if ((HTC.ShareVariables.pub_spC == "PS") && ((_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 2) && kb.Sophieu == 0 && (kb.TongThu - kb.TongChi >= 1000))
                                PrintDataHD(kb);
                            if ((HTC.ShareVariables.pub_spC == "YH") && ((_LoaiPhieu == 9 || _LoaiPhieu == 8) || (_LoaiPhieu == 7 && (_NoiTT == "090" || _NoiTT == "087"))) && kb.Sophieu == 0 && (kb.TongThu - kb.TongChi >= 1000))
                                PrintDataHD(kb);
                            if (_LoaiPhieu == 7 && (HTC.ShareVariables.pub_spC == "QN"))
                            {
                                PrintDataDV(true, kb.SoSoHD, kb.SoHD, ((kb.Sophieu == 1 && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || (_NoiTT == "090" || _NoiTT == "094" || _NoiTT == "093"))) ? byte.Parse("1") : byte.Parse("2")));
                                PrintDataThuocDY(true, "In lại", kb.SoHD, kb.SoSoHD);
                            }
                            else if (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")))
                            {
                                PrintDataDV(true, kb.SoSoHD, kb.SoHD, ((kb.Sophieu == 1 && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || (_NoiTT == "090" || _NoiTT == "094" || _NoiTT == "093"))) ? byte.Parse("1") : byte.Parse("2")));

                            }
                            else if ((_LoaiPhieu == 2 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")))
                            {
                                PrintDataPTHD(kb);

                            }
                            else if ((_LoaiPhieu == 7 && (HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "QN") && ((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093")) && kb.Sophieu == 0)
                            {
                                PrintDataThuocDY(true, "In lại", kb.SoHD, kb.SoSoHD);

                            }
                            else if (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && HTC.ShareVariables.pub_spC == "PS") && (_NoiTT == "087" || _NoiTT == "095"))
                            {
                                PrintDataDV(true, kb.SoSoHD, kb.SoHD, ((kb.Sophieu == 1 && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || (_NoiTT == "090" || _NoiTT == "094" || _NoiTT == "093"))) ? byte.Parse("1") : byte.Parse("2")));

                            }
                            else if (((_LoaiPhieu == 7 && (HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "HH")) || (HTC.ShareVariables.pub_spC == "YH")))
                            {

                                PrintDataDV(true, kb.SoSoHD, kb.SoHD, ((kb.Sophieu == 1 && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || ((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093"))) ? byte.Parse("1") : byte.Parse("2")));

                            }
                        }
                    }
                }
                else if (_LoaiPhieu != 1)
                    PrintDataDV();
                if ((_LoaiPhieu == 2 || (cboDoiTuong.SelectedValue.Substring(0, 1) == "2" && (_LoaiPhieu == 9 || _LoaiPhieu == 8) && HTC.ShareVariables.pub_spC == "YH") || (_LoaiPhieu == 1 && _Duyet == 1)) && dtNgayQT.Text != "")
                {
                    PrintVPThanhToanBH();
                }

                if (HTC.ShareVariables.pub_spC == "YH" && (_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085")
                    PrintDataHoanDV();

                //Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={1}&&noitt={0}&&duyet={2}", _NoiTT, _LoaiPhieu, _Duyet), false);
                // clearBN();
                clearBN();
            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdAddKQ", StringComparison.InvariantCultureIgnoreCase))
            {
                if (HTC.ShareVariables.pub_spC == "PS")
                    OpenWindow("frmPhieuChiBT.aspx?LoaiPhieu=" + _LoaiPhieu + "&madt=" + _MaDT + "&NoiTT=" + _NoiTT + "&MaBN=" + _MaBN + "&NgayDK=" + _NgayDK.ToString());
                else
                    UpdatePhieuThu(2, true);
            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdAddXN", StringComparison.InvariantCultureIgnoreCase))
            {
                CurrentTabIndex = 2;
                txtindextab.Value = CurrentTabIndex.ToString();
                ShowDV();
                RadTabStrip1.SelectedIndex = CurrentTabIndex;
                RadMultiPage1.SelectedIndex = CurrentTabIndex;
                LoadDetails(false, CurrentTabIndex, false);

                //grdXNTT.MasterTableView.IsItemInserted = true;
                //grdXNTT.DataBind();
            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdAddThuoc", StringComparison.InvariantCultureIgnoreCase))
            {

                CurrentTabIndex = 3;
                txtindextab.Value = CurrentTabIndex.ToString();
                RadTabStrip1.SelectedIndex = CurrentTabIndex;
                RadMultiPage1.SelectedIndex = CurrentTabIndex;
                LoadDetails(false, CurrentTabIndex, false);
                RadTabStrip1.Tabs[3].Visible = true;

                //grdThuoc.MasterTableView.IsItemInserted = true;
                //grdThuoc.DataBind();
            }
            else if (((RadToolBarButton)e.Item).CommandName.Equals("cmdAddThuocDY", StringComparison.InvariantCultureIgnoreCase))
            {
                if (_KhamBenh_ThuocSD_DY != null && txtSLThang.Text != "")
                {
                    if (_KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs.Count > 0)
                    {
                        _KhamBenh_ThuocSD_DY.SLMua = txtSLThang.Text;
                        _KhamBenh_ThuocSD_DY.SLThang = txtSLThang.Text;

                        _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.UpdatedTo(_KhamBenh_ThuocSD_DY);
                    }
                }
                CurrentTabIndex = 4;
                txtindextab.Value = CurrentTabIndex.ToString();
                RadTabStrip1.SelectedIndex = CurrentTabIndex;
                RadMultiPage1.SelectedIndex = CurrentTabIndex;
                _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
                LoadDetails(false, CurrentTabIndex, false);
                LoadDetails_KhamBenh_ThuocThang();
                RadTabStrip1.Tabs[4].Visible = true;
                grdThuocDY.MasterTableView.IsItemInserted = true;
                grdThuocDY.DataBind();
            }

        }
        catch (Exception ex)
        {
            ShowMessage("Không thực hiện được dữ liệu 1" + ex.Message);
            baraction.FindItemByValue("cmdPrint").Enabled = true;

        }
    }
    protected Boolean UpdateDataSave(Boolean indv = true)
    {
        

        try
        {

            if ((baraction.FindItemByValue("cmdSave").Enabled == false || baraction.FindItemByValue("cmdSave").Visible == false) && _LoaiPhieu == 1 && _Duyet == 1)
                return true;
            if ((baraction.FindItemByValue("cmdPrint").Enabled == false || baraction.FindItemByValue("cmdPrint").Visible == false) && !(_LoaiPhieu == 1 && _Duyet == 1))
                return true;
            baraction.FindItemByValue("cmdPrint").Enabled = false;
            if (cboDoiTuong.SelectedValue.Substring(0, 1) != "1" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _LoaiPhieu != 1 && _LoaiPhieu != 7 && _NoiTT == "085")
                _LoaiPhieu = 9;
            else if (cboDoiTuong.SelectedValue.Substring(0, 1) == "1" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _LoaiPhieu != 1 && _LoaiPhieu != 7 && _NoiTT == "085")
                _LoaiPhieu = 2;
            if (CheckFormDataM() == false)
            {
                return false;
            }

            if (_LoaiPhieu == 8 && HTC.ShareVariables.pub_spC == "PS" && _ThongtinBN.KhamBenh.KyQuyBH != "0" && _ThongtinBN.KhamBenh.KyQuyBH != "")
            {
                DateTime NgayDK = DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);
                ThongtinBN tt = ThongtinBN.GetThongtinBN(txtmabn.Text, NgayDK, _LoaiPhieu, _NoiTT);
                if (tt.KhamBenh.KyQuyBH != "0" && tt.KhamBenh.KyQuyBH != "")
                {
                    if (tt.KhamBenh.KhamBenh_C_List.Count > 0)
                    {
                        if (tt.KhamBenh.KhamBenh_C_List[0].MaHuongDT != "")

                            OpenWindow("frmPhieuChiBT.aspx?LoaiPhieu=8&madt=" + _MaDT + "&NoiTT=" + _NoiTT + "&MaBN=" + _MaBN + "&NgayDK=" + _NgayDK.ToString());
                    }
                    return false;
                }
            }
            if ((HTC.ShareVariables.pub_spC == "HH" && _LoaiPhieu == 2))
            {
                foreach (KhamBenh_ThuocSD kb in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
                {
                    if (kb.Huy == false && kb.DATT == 0 && kb.BHTinhtien == true && kb.Tinhtien == false)
                    {
                        if (decimal.Parse(kb.SLKeDon) > kb.TONCKDT || decimal.Parse(kb.SLKeDon) > kb.TONCK)
                        {
                            ShowMessage("Thuốc " + kb.TenTM + " đã hết tồn");
                            return false;
                        }
                    }
                }

            }
            if (HTC.ShareVariables.pub_spC == "QN")
            {
                if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "1" && _LoaiPhieu == 2)
                {
                    if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 1 || _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count > 0 || _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count > 0)
                    {
                        ShowMessage("Bệnh nhân bảo hiểm không thanh toán");
                        return false;
                    }
                }
                foreach (KhamBenh_ThuocSD kb in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
                {
                    if (kb.Huy == false && kb.DATT == 0 && kb.dadung == false)
                    {
                        if (decimal.Parse(kb.SLKeDon) > kb.TONCK)
                        {
                            ShowMessage("Thuốc " + kb.TenTM + " đã hết tồn");
                            return false;
                        }
                    }
                }
                foreach (KhamBenh_ThuocSD_DY kb in _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList)
                {
                    if (kb.Huy == false && kb.DATT == 0 && kb.Huy == false)
                    {
                        foreach (KhamBenh_ThuocSD_DY_C kbc in kb.KhamBenh_ThuocSD_DY_Cs)
                        {
                            if (kbc.Huy == false && decimal.Parse(kbc.SLKeDon) * decimal.Parse(kb.SLMua) > kbc.TONCK)
                            {
                                ShowMessage("Thuốc " + kbc.TenTM + " đã hết tồn");
                                return false;
                            }
                        }
                    }
                }
            }
            if (_ThongtinBN.KhamBenh.IsNew == true)
            {
                if (_LoaiPhieu != 1 && _LoaiPhieu != 3)
                {
                    if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count == 0 && _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count == 0 && _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Count == 0)
                    {
                        ShowMessage("Chưa nhập dịch vụ");
                        return false;
                    }
                }
                else if (_LoaiPhieu != 3)
                {
                    if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0)
                    {
                        ShowMessage("Chưa nhập dịch vụ");
                        return false;
                    }
                }
                else if (_LoaiPhieu == 3)
                {
                    if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count == 0)
                    {
                        ShowMessage("Chưa nhập thuốc");
                        return false;
                    }
                }
            }
            if ((Pub_bQuyenForm < HTC.ShareVariables.KieuFormChiTiet.fSua && _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count == 0) && _LoaiPhieu != 1)
            {
                ShowMessage("Không có quyền sửa, hủy dịch vụ hoặc hủy hóa đơn");
                return false;
            }

            if (_LoaiPhieu == 1 && BH_internet == "YES" && txtSoThe.Text != "" && (_ThongtinBN.KhamBenh.NgayQT == "" || _ThongtinBN.KhamBenh.MaBV == "") && _ThongtinBN.KhamBenh.IsNew == false && _ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "1")
            {
                Boolean kt = false;
                if (txtSoThe.Text.Substring(0, 3).ToUpper() == "HT5")
                {
                    ShowMessage("Thẻ HT5 không thể khám được bệnh nhân");
                    return false;
                }

                foreach (KhamBenh_C kbc in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                {
                    if (kbc.DaTT == 0 && kbc.BHTinhtien == true && kbc.Tinhtien == false && kbc.Huy == false)
                    {
                        CheckThe();
                        kt = true;
                        if (_KTBHYT == false)
                        {
                            _KTBHYT = true;
                            return false;
                        }
                    }

                }
            }

            if (_LoaiPhieu == 2 && BH_internet == "YES" && txtSoThe.Text != "" && cboLoaiBN.SelectedValue == "2" && _ThongtinBN.KhamBenh.IsNew == false && _ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "1")
            {
                Boolean kt = false;
                if (txtSoThe.Text.Substring(0, 3).ToUpper() == "HT5")
                {
                    ShowMessage("Thẻ HT5 không thể khám được bệnh nhân");
                    return false;
                }
                foreach (KhamBenh_C kbc in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                {
                    if (kbc.DaTT == 0 && kbc.BHTinhtien == true && kbc.Tinhtien == false && kbc.Huy == false)
                    {
                        CheckThe();
                        kt = true;
                        if (_KTBHYT == false)
                        {
                            _KTBHYT = true;
                            return false;
                        }
                    }

                }
            }
            if (CheckFormData() == true)
            {
                if (_LoaiPhieu == 1 || _LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8))
                    if (cboNhanVien.SelectedValue != "" || cboChanDoan.SelectedValue != "" || txtChanDoan.Text != "")
                    {
                        foreach (KhamBenh_C kbc in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                        {
                            if (kbc.MaDV.Substring(0, 2) == "PK" && kbc.BSKham == "")
                            {
                                kbc.BSKham = cboNhanVien.SelectedValue;
                                kbc.bschidinh = cboNhanVien.SelectedValue;
                            }
                            if (kbc.bschidinh == "")
                            {
                                kbc.bschidinh = cboNhanVien.SelectedValue;
                            }
                            if (kbc.tenbenh == "")
                            {
                                kbc.tenbenh = txtChanDoan.Text;
                                kbc.Mabenh = cboChanDoan.SelectedValue;
                            }
                        }
                    }
                if (HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "QN")
                {
                    if (_KhamBenh_ThuocSD_DY != null && _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList != null)
                    {
                        if (_KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs.Count > 0 && _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count > 0)
                        {
                            if (_KhamBenh_ThuocSD_DY.DATT == 0)
                            {
                                _KhamBenh_ThuocSD_DY.SLMua = txtSLThang.Text;
                                _KhamBenh_ThuocSD_DY.SLThang = txtSLThang.Text;
                            }
                            _KhamBenh_ThuocSD_DY.TinhLaiDon();
                            txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
                            txtTT.Value = (_KhamBenh_ThuocSD_DY.SLMua == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua)).ToString();
                            tinhlaihd();
                            _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.UpdatedTo(_KhamBenh_ThuocSD_DY);
                        }
                    }
                }

                if ((_LoaiPhieu == 2 || (_LoaiPhieu == 1 && _Duyet == 1 && _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count > 0 && txtTongHD.Text == "")) && dtNgayQT.Text == "" && _ThongtinBN.KhamBenh.NgayQT == "" && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 1 && HTC.ShareVariables .pub_spC !="PS" )
                {
                    dtNgayQT.Text = DateTime.Now.ToString("dd/MM/yyyy");

                }
                // them ky quy , tam thu o day 
                //if (_ThongtinBN.KhamBenh.IsNew == true && !(cboLoaiBN.SelectedValue == "5" || cboLoaiBN.SelectedValue == "4" || cboLoaiBN.SelectedValue == "6") && (txtkyquy.Text == "" || txtkyquy.Text == "0") && HTC.ShareVariables.pub_spC == "PH" && (_LoaiPhieu == 9 || _LoaiPhieu == 8))
                //{
                //    ShowMessage("Yêu cầu bệnh nhân dịch vụ phải ký quỹ , tạm thu");
                //    return false;
                //}
                // het 
                if (_KhamBenh_DongTienList != null && HTC.ShareVariables.pub_spC != "PS")
                {
                    if (_KhamBenh_DongTienList.Count == 0 && txtkyquy.Text != "")
                    {
                        UpdatePhieuThu(2, true);
                    }
                }
                if (_ThongtinBN.KhamBenh.NgayQT != "" && dtNgayQT.Text != "")
                {
                    if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count > 0)
                    {
                        if (DateDiff(DateInterval.Day, DateTime.Parse(_ThongtinBN.KhamBenh.NgayQT.Substring(0, 10)), DateTime.Parse(dtNgayQT.Text)) != 0)
                            _ThongtinBN.KhamBenh.NgayQT = dtNgayQT.Text + " " + DateTime.Now.ToString("HH:mm");
                    }
                }
                else if (_ThongtinBN.KhamBenh.NgayQT == "" && dtNgayQT.Text != "" && HTC.ShareVariables .pub_spC !="PS" )
                    _ThongtinBN.KhamBenh.NgayQT = dtNgayQT.Text + " " + DateTime.Now.ToString("HH:mm");

                _ThongtinBN.KhamBenh.CK = txtMG.Text == "" ? 0 : decimal.Parse(txtMG.Text);


                if (_LoaiPhieu == 1 || _LoaiPhieu == 7 || _LoaiPhieu == 3 || (HTC.ShareVariables.pub_spC != "PS"))
                    UpdateThongTinBN();
                else if (_ThongtinBN.KhamBenh.IsNew == true && _LoaiPhieu != 1)
                {

                    _ThongtinBN.NguoiLap = Pub_sNguoiSD;
                    _ThongtinBN.MaMay = Pub_sMaMay;

                    ThongtinBN tmp = _ThongtinBN.Clone();
                    tmp.ApplyEdit();
                    _ThongtinBN = tmp.Save();


                }

                if (_ThongtinBN.KhamBenh.IsNew == true)
                {
                    if (txtkyquy.Text != "")
                    {
                        _ThongtinBN.KhamBenh.KyQuyBH = (decimal.Parse(_ThongtinBN.KhamBenh.KyQuyBH == "" ? "0" : _ThongtinBN.KhamBenh.KyQuyBH) + decimal.Parse(txtkyquy.Text)).ToString();

                    }
                    _ThongtinBN.KhamBenh.Ghichu = txtGhiChuHD.Text;
                    _ThongtinBN.KhamBenh.MaBN = _ThongtinBN.MaBN;
                    _ThongtinBN.KhamBenh.MaMay = Pub_sMaMay;
                    _ThongtinBN.KhamBenh.NguoiSD = Pub_sNguoiSD;
                    _ThongtinBN.KhamBenh.ApplyEdit();
                    _ThongtinBN.KhamBenh.Save();
                    if (txtkyquy.Text != "")
                    {
                        UpdatePhieuThu(1, indv);

                    }
                }
                else if (_ThongtinBN.KhamBenh.IsDirty == true && _LoaiPhieu == 1)
                {
                    _ThongtinBN.KhamBenh.MaBN = _ThongtinBN.MaBN;
                    _ThongtinBN.KhamBenh.MaMay = Pub_sMaMay;
                    _ThongtinBN.KhamBenh.NguoiSD = Pub_sNguoiSD;
                    _ThongtinBN.KhamBenh.ApplyEdit();
                    _ThongtinBN.KhamBenh.Save();
                }
                // se them may thu kiem tra ... o day
                if (_LoaiPhieu != 1 || (_LoaiPhieu == 1 && _Duyet == 1 && dtNgayQT.Text != "" && txtTongHD.Text == ""))
                {
                    _MaPX = "";
                    if (_LoaiPhieu == 7 && (_NoiTT == "091" || _NoiTT == "092") && HTC.ShareVariables.pub_spC != "QN")
                        UpdatePhieuBan();
                    if (HTC.ShareVariables.pub_spC == "QN" && _LoaiPhieu == 7)
                    {
                        UpdatePhieuBan();
                        UpdatePhieuBanDY(_SoSoHD, _SoHD);
                    }
                    if (_ThongtinBN.KhamBenh.IsDirty == true)
                    {
                        _ThongtinBN.KhamBenh.MaMay = Pub_sMaMay;
                        _ThongtinBN.KhamBenh.NguoiSD = Pub_sNguoiSD;
                    }
                    if (HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "HU"  || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                    {
                        if ((_ThongtinBN.KhamBenh.KyQuyBH != "") && (dtNgayQT.Text != "" && _LoaiPhieu == 2))
                        {
                            _KhamBenh_DongTienList = KhamBenh_DongTienList.NewList();
                            decimal sotien = 0;
                            KhamBenh_DongTien _KhamBenh_DongTien = KhamBenh_DongTien.NewKhamBenh_DongTien();

                            //if (_ThongtinBN.KhamBenh.KyQuyBH == "" && txtTongHD.Text != "")
                            //{
                            //    sotien = decimal.Parse(txtTongHD.Text.Replace(",", ""));
                            //    _KhamBenh_DongTien.MaLDThuTien = "00008";
                            //}
                            //else if (_ThongtinBN.KhamBenh.KyQuyBH != "" && txtTongHD.Text == "")
                            //{
                            //    sotien = decimal.Parse(_ThongtinBN.KhamBenh.KyQuyBH.Replace(",", ""));
                            //    _KhamBenh_DongTien.MaLDThuTien = "00020";
                            //}
                            //else if (decimal.Parse(_ThongtinBN.KhamBenh.KyQuyBH.Replace(",", "")) - decimal.Parse(txtTongHD.Text.Replace(",", "")) > 0)
                            //{
                            //    sotien = decimal.Parse(_ThongtinBN.KhamBenh.KyQuyBH.Replace(",", "")) - decimal.Parse(txtTongHD.Text.Replace(",", ""));
                            //    _KhamBenh_DongTien.MaLDThuTien = "00020";
                            //}
                            //else if (decimal.Parse(_ThongtinBN.KhamBenh.KyQuyBH.Replace(",", "")) - decimal.Parse(txtTongHD.Text.Replace(",", "")) < 0)
                            //{
                            //    sotien = decimal.Parse(txtTongHD.Text.Replace(",", "")) - decimal.Parse(_ThongtinBN.KhamBenh.KyQuyBH.Replace(",", ""));
                            //    _KhamBenh_DongTien.MaLDThuTien = "00008";
                            //}
                            sotien = decimal.Parse(_ThongtinBN.KhamBenh.KyQuyBH.Replace(",", ""));

                            if (sotien > 0)
                            {
                                _KhamBenh_DongTien.MaLDThuTien = "00020";
                                if (HTC.ShareVariables.pub_spC == "PH")
                                    _KhamBenh_DongTien.MaLDThuTien = "00033";
                                _KhamBenh_DongTien.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                                _KhamBenh_DongTien.MaKhoa = cboKhoaKB.SelectedValue;
                                _KhamBenh_DongTien.loai = _LoaiPhieu;
                                _KhamBenh_DongTien.NoiTT = _NoiTT;
                                _KhamBenh_DongTien.SPThu = txtKyhieu.Text + txtsohd.Text;
                                _KhamBenh_DongTien.SoTien = sotien.ToString();
                                _KhamBenh_DongTien.NguoiThu = Pub_sNguoiSD;
                                _KhamBenh_DongTien.NgayDong = DateTime.Now.ToString("dd/MM/yyyy");
                                _KhamBenh_DongTien.MaMay = Pub_sMaMay;
                                _KhamBenh_DongTien.NguoiLap = Pub_sNguoiSD;


                                _KhamBenh_DongTien.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : (_NoiTT == "085" ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003"))); ;
                                _KhamBenh_DongTienList.NewTo(_KhamBenh_DongTien);

                                if (_KhamBenh_DongTienList != null)
                                    _KhamBenh_DongTienList.Save();
                            }

                            _ThongtinBN.KhamBenh.KyQuyBH = "0";
                        }
                        else if (cboDoiTuong.SelectedValue.Substring(0, 1) == "0" && (_LoaiPhieu == 9 || _LoaiPhieu == 8) && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _ThongtinBN.KhamBenh.KyQuyBH != "" && (_ThongtinBN.KhamBenh.IsNew == false && (_LoaiPhieu == 9 || _LoaiPhieu == 8) && (HTC.ShareVariables.pub_spC == "PH") && _ThongtinBN.KhamBenh.NgaySD != ""))
                        {
                            _KhamBenh_DongTienList = KhamBenh_DongTienList.GetAllKhamBenh_DongTien(_ThongtinBN.KhamBenh.MaSoKham);
                            int count = _KhamBenh_DongTienList.Count - 1;
                            for (int i = 0; i <= count; i++)
                            {
                                KhamBenh_DongTien _kb = _KhamBenh_DongTienList[i];
                                if (!(_kb.MaLDThuTien == "00020" || _kb.MaLDThuTien == "00033"))
                                {
                                    KhamBenh_DongTien _KhamBenh_DongTien = KhamBenh_DongTien.NewKhamBenh_DongTien();
                                    _KhamBenh_DongTien.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                                    _KhamBenh_DongTien.MaKhoa = cboKhoaKB.SelectedValue;
                                    _KhamBenh_DongTien.SPThu = _kb.SPThu;
                                    _KhamBenh_DongTien.NoiTT = _NoiTT;
                                    _KhamBenh_DongTien.loai = _LoaiPhieu;
                                    _KhamBenh_DongTien.SoTien = _kb.SoTien;
                                    _KhamBenh_DongTien.NguoiThu = Pub_sNguoiSD;
                                    _KhamBenh_DongTien.NgayDong = DateTime.Now.ToString("dd/MM/yyyy");
                                    _KhamBenh_DongTien.MaLDThuTien = "00020";
                                    if (HTC.ShareVariables.pub_spC == "PH")
                                        _KhamBenh_DongTien.MaLDThuTien = "00033";
                                    _KhamBenh_DongTien.MaMay = Pub_sMaMay;
                                    _KhamBenh_DongTien.NguoiLap = Pub_sNguoiSD;
                                    _KhamBenh_DongTien.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : (_NoiTT == "085" ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003"))); ;
                                    _KhamBenh_DongTienList.NewTo(_KhamBenh_DongTien);
                                }
                            }
                            if (_KhamBenh_DongTienList != null)
                                _KhamBenh_DongTienList.Save();
                            _ThongtinBN.KhamBenh.KyQuyBH = "0";
                        }
                    }
                    else if (_ThongtinBN.KhamBenh.KyQuyBH != "" && _LoaiPhieu == 2 && dtNgayQT.Text != "")
                    {
                        _KhamBenh_DongTienList = KhamBenh_DongTienList.GetAllKhamBenh_DongTien(_ThongtinBN.KhamBenh.MaSoKham);
                        int count = _KhamBenh_DongTienList.Count - 1;
                        for (int i = 0; i <= count; i++)
                        {
                            KhamBenh_DongTien _kb = _KhamBenh_DongTienList[i];
                            if (_kb.MaLDThuTien != "00020")
                                break;
                            if (_kb.MaLDThuTien != "00033" && HTC.ShareVariables.pub_spC == "PH")
                                break;
                            KhamBenh_DongTien _KhamBenh_DongTien = KhamBenh_DongTien.NewKhamBenh_DongTien();
                            _KhamBenh_DongTien.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                            _KhamBenh_DongTien.MaKhoa = cboKhoaKB.SelectedValue;
                            _KhamBenh_DongTien.SPThu = _kb.SPThu;
                            _KhamBenh_DongTien.NoiTT = _NoiTT;

                            _KhamBenh_DongTien.SoTien = _kb.SoTien;
                            _KhamBenh_DongTien.NguoiThu = Pub_sNguoiSD;
                            _KhamBenh_DongTien.NgayDong = DateTime.Now.ToString("dd/MM/yyyy");
                            _KhamBenh_DongTien.MaLDThuTien = "00020";
                            if (HTC.ShareVariables.pub_spC == "PH")
                                _KhamBenh_DongTien.MaLDThuTien = "00033";
                            _KhamBenh_DongTien.MaMay = Pub_sMaMay;
                            _KhamBenh_DongTien.NguoiLap = Pub_sNguoiSD;


                            _KhamBenh_DongTien.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : (_NoiTT == "085" ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003"))); ;
                            _KhamBenh_DongTienList.NewTo(_KhamBenh_DongTien);
                        }
                        if (_KhamBenh_DongTienList != null)
                            _KhamBenh_DongTienList.Save();
                        _ThongtinBN.KhamBenh.KyQuyBH = "0";
                    }

                    if (_ThongtinBN.KhamBenh.NgayQT != "" && dtNgayQT.Text != "")
                    {
                        if (DateDiff(DateInterval.Day, DateTime.Parse(_ThongtinBN.KhamBenh.NgayQT.Substring(0, 10)), DateTime.Parse(dtNgayQT.Text)) != 0)
                            _ThongtinBN.KhamBenh.NgayQT = dtNgayQT.Text + " " + DateTime.Now.ToString("HH:mm");
                    }
                    else if (_ThongtinBN.KhamBenh.NgayQT == "" && dtNgayQT.Text != "")
                        _ThongtinBN.KhamBenh.NgayQT = dtNgayQT.Text + " " + DateTime.Now.ToString("HH:mm");




                    _ThongtinBN.KhamBenh.ApplyEdit();
                    // them ky quy , tam thu o day 
                    if (_ThongtinBN.KhamBenh.IsNew == false && _ThongtinBN.KhamBenh.NgaySD == "" && _ThongtinBN.KhamBenh.KyQuyBH != "" && _ThongtinBN.KhamBenh.KyQuyBH != "0" && HTC.ShareVariables.pub_spC == "PH" && (_LoaiPhieu == 9 || _LoaiPhieu == 8))
                    {
                        // không viết hóa đơn;
                    }
                    else if (_LoaiPhieu != 3)
                    {
                        UpdateThanhToanHD();
                    }
                    // het 
                    if (_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 7)
                    {
                        foreach (KhamBenh_HoaDon hd in _ThongtinBN.KhamBenh.KhamBenh_HoaDonList)
                        {
                            if (hd.LydoThu.Trim() == "")
                            {
                                ShowMessage("Không thanh toán được bệnh nhân này!Bạn thanh toán lại");
                                return false;
                            }
                        }
                    }

                    UpdateMienGiam();

                    _ThongtinBN.KhamBenh.Save();
                }

                string sql = "UPDATE ThongTinBN SET Lydovaovien = '" + cbolydovaovien.SelectedValue + "', Doituongkhambenh = '" + cbodoituongkhambenh.SelectedValue + "' WHERE mabn = '" + _ThongtinBN.MaBN + "'";
                HTC.Business.DataProvider.Instance().ExcSQL(sql);

                //if (_ThongtinBN.KhamBenh.IsNew == false)
                //{
                //    if (txtkyquy.Text != _ThongtinBN.KhamBenh.KyQuyBH && txtkyquy.Text != "0" && txtkyquy.Text != "" && _LoaiPhieu == 2)
                //        _ThongtinBN.KhamBenh.KyQuyBH = (decimal.Parse(_ThongtinBN.KhamBenh.KyQuyBH == "" ? "0" :_ThongtinBN.KhamBenh.KyQuyBH) + decimal.Parse(txtkyquy.Text)).ToString();
                //}
                if (_LoaiPhieu == 1 && _Duyet == 1)
                {
                    UpdateDuyetBN();
                }
                baraction.FindItemByValue("cmdPrint").Enabled = true;


                if (_LoaiPhieu == 1 && _Duyet == 1 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH"))
                {
                    Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={0}&&noitt={1}&duyet={2}&pubmadt={5}&&maBN={3}&&ngayDK={4}", 2, _NoiTT, _Duyet, _MaBN, dtNgayDK.Text, _PubMaDT), false);
                }

                return true;
            }
            else
            {
                baraction.FindItemByValue("cmdPrint").Enabled = true;
                return false;
            }

        }
        catch (Exception ex)
        {
            ShowMessage("Không lưu được dữ liệu" + ex.Message);
            // baraction.FindItemByValue("cmdPrint").Enabled = false;

            return false;
        }

        
    }

    protected void UpdatePhieuThu(byte insert = 0, Boolean indv = true)
    {
        try
        {
            if (_ThongtinBN.KhamBenh.MaSoKham == "")
                return;
            if (_KhamBenh_DongTienList == null)
                _KhamBenh_DongTienList = KhamBenh_DongTienList.NewList();

            if (txtkyquy.Text != "" && (_LoaiPhieu == 2 || ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH"))) && (insert == 1 || insert == 2))
            {
                KhamBenh_DongTien _KhamBenh_DongTien = KhamBenh_DongTien.NewKhamBenh_DongTien();
                _KhamBenh_DongTien.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                _KhamBenh_DongTien.MaKhoa = cboKhoaKB.SelectedValue;
                _KhamBenh_DongTien.lanin = 1;
                _KhamBenh_DongTien.loai = _LoaiPhieu;
                _KhamBenh_DongTien.NoiTT = _NoiTT;
                _KhamBenh_DongTien.SoTien = txtkyquy.Text;
                _KhamBenh_DongTien.NguoiThu = Pub_sNguoiSD;
                _KhamBenh_DongTien.NgayDong = DateTime.Now.ToString("dd/MM/yyyy");
                if (_ThongtinBN.KhamBenh.KyQuyBH == "" && _ThongtinBN.KhamBenh.IsNew == true)
                    _KhamBenh_DongTien.MaLDThuTien = "00001";
                else
                    _KhamBenh_DongTien.MaLDThuTien = "00002";

                if (_ThongtinBN.KhamBenh.KyQuyBH == "" && _ThongtinBN.KhamBenh.IsNew == true && HTC.ShareVariables.pub_spC == "PH")
                    _KhamBenh_DongTien.MaLDThuTien = "00030";
                else if (HTC.ShareVariables.pub_spC == "PH")
                    _KhamBenh_DongTien.MaLDThuTien = "00031";
                _KhamBenh_DongTien.MaMay = Pub_sMaMay;
                _KhamBenh_DongTien.NguoiSD = Pub_sNguoiSD;
                _KhamBenh_DongTien.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : (_NoiTT == "085" ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003"))); ;
                _KhamBenh_DongTienList.NewTo(_KhamBenh_DongTien);
                _KhamBenh_DongTienList.Save();

                if (txtkyquy.Text != "" && _LoaiPhieu == 2 && insert == 2)
                    _ThongtinBN.KhamBenh.KyQuyBH = (decimal.Parse(_ThongtinBN.KhamBenh.KyQuyBH == "" ? "0" : _ThongtinBN.KhamBenh.KyQuyBH) + decimal.Parse(txtkyquy.Text)).ToString();
                if ((insert == 2 && indv == true) || HTC.ShareVariables.pub_spC == "PH")
                    PrintDataPT();
                else
                    ShowMessage("Đã thêm một phiếu thu " + txtkyquy.Text + " đồng!Phiếu sẽ in khi chỉ định dịch vụ");
            }
            if (indv == true && (txtkyquy.Text == "" && _LoaiPhieu == 2) && insert == 2 && _ThongtinBN.KhamBenh.DuyetBH == false)
            {
                string sql = "";
                sql = " UPDATE khambenh SET madt ='" + cboDoiTuong.SelectedValue + "', sothe ='" + txtSoThe.Text + "',   duyetbh=1,ngayd=getdate(),nguoid='" + Pub_sNguoiSD + "'";
                sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and isnull(duyetbh,0) =0";
                HTC.Business.DataProvider.Instance().ExcSQL(sql);
            }
        }

        catch (Exception ex)
        {
            ShowMessage("Không thanh toán được ký quỹ" + ex.Message);
        }
    }
    protected void RadTabStrip1_TabClick(object sender, RadTabStripEventArgs e)
    {
        CurrentTabIndex = RadTabStrip1.SelectedIndex;
        txtindextab.Value = CurrentTabIndex.ToString();
        RadMultiPage1.SelectedIndex = CurrentTabIndex;
        LoadDetails(false, CurrentTabIndex, false);
        //switch (CurrentTabIndex)
        //{

        //    case 2:
        //        {
        //            grdXNTT.MasterTableView.IsItemInserted = true;
        //            grdXNTT.DataBind();
        //            break;
        //        }
        //    case 3:
        //        {
        //            grdThuoc.MasterTableView.IsItemInserted = true;
        //            grdThuoc.DataBind();
        //            break;
        //        }
        //    case 4:
        //        {
        //            grdThuocDY.MasterTableView.IsItemInserted = true;
        //            grdThuocDY.DataBind();
        //            break;
        //        }

        //}

    }

    protected void grdDichVu_NeedDataSource(object sender, GridNeedDataSourceEventArgs e)
    {
        switch (CurrentTabIndex)
        {

            case 0: //ctt
                {

                    grdCTT.DataSource = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList;




                    break;

                }

            case 1: //datt
                {

                    grdDTT.DataSource = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList;





                    break;

                }
            case 2: //xn
                {

                    _ThongtinBN.KhamBenh.KhamBenh_C_List.OrderByDescending(x => x.STT);

                    grdXNTT.DataSource = _ThongtinBN.KhamBenh.KhamBenh_C_List;
                    // grdXNTT.MasterTableView.FilterExpression = " datt =0";

                    break;

                }
            case 3: //thuoc
                {

                    grdThuoc.DataSource = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList;
                    grdThuoc.MasterTableView.FilterExpression = " datt =0";




                    break;

                }
            case 4: //thuoc dy
                {

                    grdDanhSachDY.DataSource = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList;

                    if (_KhamBenh_ThuocSD_DY != null)
                    {
                        grdThuocDY.DataSource = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
                    }
                    else
                    {
                        _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
                        grdThuocDY.DataSource = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;

                    }
                    break;
                }

            //case 5://vtyt
            //    {

            //        grdVTTH.DataSource = _ThongtinBN.KhamBenh.KhamBenh_VTTHList;



            //        break;
            //    }
            //case 6://hc
            //    {


            //        grdHoaChat.DataSource = _ThongtinBN.KhamBenh.KhamBenh_HoaChatList;



            //        break;
            //    }
            //case 7://mau
            //    {



            //        grdMau.DataSource = _ThongtinBN.KhamBenh.KhamBenh_MauList;

            //        break;
            //    }

        }

    }


    private bool CheckFormDataM()
    {

        if (txthoten.Text == "")
        {
            ShowMessage("Chưa nhập họ tên");

            txthoten.Focus();
            return false;
        }
        //if (txtGhiChuHD.Visible == true && txtGhiChuHD.Text == "")
        //{
        //    ShowMessage("Chưa nhập ghi chú về hóa đơn");
        //    txtGhiChuHD.Focus();
        //    return false;
        //}
        if (txtkyquy.Text != "")
        {
            try
            {
                decimal.Parse(txtkyquy.Text);
            }
            catch (Exception)
            {
                ShowMessage("Tiền ký quỹ sai định dạng");
            }
            if (decimal.Parse(txtkyquy.Text) < 0)
            {
                ShowMessage("Tiền ký quỹ sai định dạng");
                return false;
            }
        }
        if (_LoaiPhieu == 1 && _PubMaDT != "CC" && HTC.ShareVariables.pub_spC == "PS")
            if (cboLoaiBN.SelectedValue == "2")
            {
                ShowMessage("Bệnh nhân này là bệnh nhân thường");
                cboLoaiBN.Focus();
                return false;
            }

        if (cboDoiTuong.SelectedValue.Substring(0, 1) == "0" && _LoaiPhieu == 2)
        {
            ShowMessage("Chưa chọn đối tượng khám bệnh");
            return false;
        }
        else if (cboDoiTuong.SelectedValue.Substring(0, 1) == "0" && _PubMaDT == "BH")
        {
            ShowMessage("Chưa chọn đối tượng khám bệnh");
            return false;
        }
        if (txttuoi.Text == "")
        {

            ShowMessage("Chưa nhập ngày sinh hoặc tuổi");

            txttuoi.Focus();
            return false;
        }
        try
        {
            byte.Parse(txttuoi.Text);
            if (byte.Parse(txttuoi.Text) >= byte.Parse("131"))
            {
                ShowMessage("Tuổi phải nhỏ hơn 130 tuổi");
                return false;
            }
        }
        catch (Exception ex)
        {
            ShowMessage("Tuổi phải nhỏ hơn 130 tuổi" + ex.Message);
            return false;
            //throw;
        }

        if (optGT.Items[0].Selected == false && optGT.Items[1].Selected == false)
        {
            ShowMessage("Chưa nhập giới tính");

            optGT.Focus();
            return false;
        }
        if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0 && _LoaiPhieu == 2 && cboDoiTuong.SelectedValue.Substring(0, 1) == "1")
        {
            KhamBenh_C k = _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(x => x.malh == "00003");
            if (k != null)
            {
                if (k.IsNew == false && k.Mabenh == "")
                {
                    ShowMessage("Bác sỹ chưa khám bệnh!Không thể thanh toán được");
                    return false;
                }
            }
            //if (k.IsNew == false && k.MaHuongDT == "" && HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ "&& k.MaDV.ToUpper() =="TK01")
            //{
            //    ShowMessage("Bác sỹ có hướng điều trị cho bệnh nhân!Không thể thanh toán được");
            //    return false;
            //}
            if (dtNgayQT.Text != "")
            {
                if (txtTongCTT.Text != "" && txtTongCTT.Text != "0" && DateDiff(DateInterval.Day, DateTime.Parse(dtNgayQT.Text.Substring(0, 10)), DateTime.Parse(DateTime.Now.ToString("dd/MM/yyyy"))) > 0)
                {
                    ShowMessage("Ngày quyết toán trước ngày hiện tại");
                    return false;
                }
            }
        }


        if (txttuoi.Text != "" && dtNgaySinh.Text == "")
        {
            dtNgaySinh.Text = DateTime.Now.AddYears(0 - int.Parse(txttuoi.Text)).ToString("dd/MM/yyyy");
        }
        if (_LoaiPhieu != 1)
        {
            if ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && (HTC.ShareVariables.pub_spC == "PS") && (txtKyhieu.Text == "" || txtsohd.Text == ""))
            {
                ShowMessage("Chưa nhập ký hiệu hóa đơn");
                txtKyhieu.Focus();
                return false;
            }
            if ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && (HTC.ShareVariables.pub_spC == "HH") && (txtKyhieu.Text == "" || txtsohd.Text == ""))
            {
                ShowMessage("Chưa nhập ký hiệu hóa đơn");
                txtKyhieu.Focus();
                return false;
            }
            if (HTC.ShareVariables.pub_spC == "YH" && (((_LoaiPhieu == 9 || _LoaiPhieu == 8) && _NoiTT == "085") || ((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093")) && (txtsohd.Text == "" || txtKyhieu.Text == ""))
            {
                ShowMessage("Chưa nhập ký hiệu hóa đơn");
                txtKyhieu.Focus();
                return false;
            }
            int num = 0; Boolean kq = false;
            if (txtsohd.Text != "")
            {
                kq = int.TryParse(txtsohd.Text, out  num);
                if (kq == false)
                {
                    ShowMessage("Số hóa đơn định dạng sai");
                    txtKyhieu.Focus();
                    return false;
                }
                KhamBenh_HoaDon _KhamBenh_HoaDon = KhamBenh_HoaDon.GetKhamBenh_HoaDon(txtKyhieu.Text, txtsohd.Text);
                if (_KhamBenh_HoaDon.MaSoKham != "")
                {
                    if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                        txtsohd.Text = HTC.Business.DataProvider.Instance().CapMa("KhamBenh_HoaDon", DateTime.Now.ToString("MM/dd/yyyy").Substring(0, 2) + DateTime.Now.Year.ToString().Substring(2, 2), "right(SoHD,4)", 4, " and sosohd ='" + txtKyhieu.Text + "' and sohd like '" + DateTime.Now.ToString("MM/dd/yyyy").Substring(0, 2) + DateTime.Now.Year.ToString().Substring(2, 2) + "%'", txtsohd.Text);
                    else
                        txtsohd.Text = int.Parse(HTC.Business.DataProvider.Instance().CapMa("KhamBenh_HoaDon", "", "SOHD", 6, " and sosohd ='" + txtKyhieu.Text + "'", txtsohd.Text)).ToString();
                    ShowMessage(" Đã tồn tại số hóa đơn này!Số hóa đơn tiếp theo là" + txtsohd.Text);
                    return false;
                }

            }
        }
        if ((((HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "HH")) && _LoaiPhieu != 7) || _LoaiPhieu == 2)
        {
            if (cboquocgia.SelectedValue == "00084")
            {
                if (HTC.ShareVariables.pub_spC != "HU")
                {
                    if (txtDiaChi.Text == "")
                    {
                        ShowMessage("Chưa nhập địa chỉ");

                        txtDiaChi.Focus();
                        return false;
                    }
                }
                if (HTC.ShareVariables.pub_spC == "HU" && cbotinh.SelectedValue == "00031" && cboLoaiBN.SelectedValue != "10")
                {
                    if (cboPXa.SelectedValue == "")
                    {
                        ShowMessage("Chưa nhập phường xã");
                        txtDiaChi.Focus();
                        return false;
                    }
                }
                if (HTC.ShareVariables.pub_spC == "QN" && cbotinh.SelectedValue == "00022" && cboLoaiBN.SelectedValue != "10")
                {
                    if (cboPXa.SelectedValue == "")
                    {
                        ShowMessage("Chưa nhập phường xã");
                        txtDiaChi.Focus();
                        return false;
                    }
                }
                if (cbohuyen.SelectedValue == "" && cboLoaiBN.SelectedValue != "10")
                {
                    ShowMessage("Chưa nhập quận , huyện");

                    cbohuyen.Focus();
                    return false;
                }
                if (cbotinh.SelectedValue == "" && cboLoaiBN.SelectedValue != "10")
                {
                    ShowMessage("Chưa nhập tỉnh, thành phố");

                    cbotinh.Focus();
                    return false;
                }
            }
            if ((HTC.ShareVariables.pub_spC == "PS"))
            {
                if (cboNgheNghiep.SelectedValue == "")
                {
                    ShowMessage("Chưa nhập nghề nghiệp");
                    cboNgheNghiep.Focus();
                    return false;
                }
                if (txtdienthoai.Text == "")
                {
                    ShowMessage("Chưa nhập điện thoại liên hệ");
                    cboNgheNghiep.Focus();
                    return false;
                }
            }
        }
        if (_LoaiPhieu == 2 && (txtSoThe.Text == "" || cboDoiTuong.SelectedValue.Substring(0, 1) == "0"))
        {
            ShowMessage("Chưa nhập thẻ BH");
            txtSoThe.Focus();
            return false;
        }
        if ((_LoaiPhieu == 2) || (_LoaiPhieu == 1 && _PubMaDT == "BH") || (cboDoiTuong.SelectedValue.Substring(0, 1) == "1" && HTC.ShareVariables.pub_spC == "QN"))
        {
            if (cboDoiTuong.SelectedValue.Substring(0, 1) == "1" && (cboDKBD.SelectedValue == "" || cboDKBD.SelectedValue == null))
            {
                ShowMessage("Chưa nhập nơi đăng ký ban đầu");
                cboDKBD.Focus();
                return false;
            }
            DateTime dk= DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);
            DateTime BHYTTN = DateTime.ParseExact(dtBHYTTN.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);
            if (DateDiff(DateInterval.Day, dk, BHYTTN) > 0)
            {
                ShowMessage("Ngày khám không được nhỏ hơn giá trị ngày");
                return false;
            }
            if (DateDiff(DateInterval.Day, BHYTTN, dk) > 0)
            {
                ShowMessage("Ngày khám không được lớn hơn giá trị ngày");
                return false;
            }

        }
        try
        {

            DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);

        }
        catch (Exception ex)
        {
            ShowMessage("Giá trị ngày ĐK sai!");
            dtNgayDK.Focus();
            return false;
        }
        try
        {

            if (_LoaiPhieu == 2 && cboDoiTuong.SelectedValue.Substring(0, 1) != "0")
                DateTime.Parse(dtBHYTDN.Text);
        }
        catch (Exception ex)
        {
            ShowMessage("Giá trị đến ngày sai!");
            dtBHYTDN.Focus();
            return false;
        }
        try
        {


            if (_LoaiPhieu == 2 && cboDoiTuong.SelectedValue.Substring(0, 1) != "0")
                DateTime.Parse(dtBHYTTN.Text);

        }
        catch (Exception ex)
        {
            ShowMessage("Giá trị từ ngày sai!");
            dtBHYTTN.Focus();
            return false;
        }
        try
        {


            if (_LoaiPhieu == 2 && cboDoiTuong.SelectedValue.Substring(0, 1) != "0")
                if (txtDKGT.Text != "")
                    DateTime.Parse(dtNgayGT.Text);
        }
        catch (Exception ex)
        {
            ShowMessage("Giá trị ngày GT sai!");
            dtNgayGT.Focus();
            return false;
        }
        if (_LoaiPhieu == 2 && _ThongtinBN.KhamBenh.IsNew == true && cboDoiTuong.SelectedValue.Substring(0, 1) != "0")
            if ((DateTime.Parse(DateTime.Now.ToString("dd/MM/yyyy")) - DateTime.Parse(dtBHYTDN.Text)).Days > 0)
            {
                ShowMessage("Hạn thẻ BH trước ngày hiện tại");
                dtBHYTTN.Focus();
                return false;
            }

        return true;
    }

    private bool CheckFormData()
    {

        if (_LoaiPhieu == 1 && _PubMaDT != "CC" && HTC.ShareVariables.pub_spC == "PS")
            if (cboLoaiBN.SelectedValue == "2")
            {
                ShowMessage("Bệnh nhân này là bệnh nhân thường");
                cboLoaiBN.Focus();
                return false;
            }

        if (cboDoiTuong.SelectedValue.Substring(0, 1) == "0" && _LoaiPhieu == 2 && (HTC.ShareVariables.pub_spC != "HU" && HTC.ShareVariables.pub_spC != "QN" && HTC.ShareVariables.pub_spC != "PH"))
        {
            ShowMessage("Chưa chọn đối tượng khám bệnh");
            return false;
        }
        else if (cboDoiTuong.SelectedValue.Substring(0, 1) == "0" && _PubMaDT == "BH")
        {
            ShowMessage("Chưa chọn đối tượng khám bệnh");
            return false;
        }

        if (_LoaiPhieu == 2 && txtSoThe.Text == "" && cboDoiTuong.SelectedValue.Substring(0, 1) == "1")
        {
            ShowMessage("Chưa nhập thẻ BH");
            txtSoThe.Focus();
            return false;
        }
        if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "PH")
        {
            if (cboDoiTuong.SelectedValue.Substring(4, 1) == "8")
            {
                ShowMessage("Không tồn tại đối tượng này");
                return false;
            }
        }
        if (_LoaiPhieu == 2 && HTC.ShareVariables.pub_spC != "YH")
        {
            if (cboDoiTuong.SelectedValue.Substring(0, 1) == "1" && (cboDKBD.SelectedValue == "" || cboDKBD.SelectedValue == null))
            {
                ShowMessage("Chưa nhập nơi đăng ký ban đầu");
                cboDKBD.Focus();
                return false;
            }
            if (txtSoThe.Text != "" && (cboDKBD.SelectedValue == "" || cboDKBD.SelectedValue == null))
            {
                ShowMessage("Chưa nhập nơi đăng ký ban đầu");
                cboDKBD.Focus();
                return false;
            }
            if (txtSoThe.Text != "" && (dtBHYTTN.Text == "" || dtBHYTDN.Text == ""))
            {
                ShowMessage("Chưa nhập hạn thẻ");
                dtBHYTTN.Focus();
                return false;
            }
        }

        try
        {

            DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);

        }
        catch (Exception ex)
        {
            ShowMessage("Giá trị ngày ĐK sai!");
            dtNgayDK.Focus();
            return false;
        }
        if (_LoaiPhieu == 1 && HTC.ShareVariables.pub_spC == "PS")
        {
            if (cboKhoaKB.SelectedValue == "")
            {
                ShowMessage("Chưa nhập mã khoa khám bệnh hoặc khoa chỉ định");
                cboKhoaKB.Focus();
                return false;
            }
        }
        if (_LoaiPhieu == 1 && (HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "HH") && cboLoaiBN.SelectedValue != "10")
        {
            if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
            {
                foreach (KhamBenh_C kbc in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                {
                    if ((kbc.malh == "00003" || kbc.malh == "00030") && kbc.Machuyenkhoa == "")
                    {
                        if (cboChuyenKhoa.SelectedValue == "")
                        {
                            ShowMessage("Chưa nhập chuyên khoa");
                            cboKhoaKB.Text = "";
                            cboKhoaKB.SelectedValue = "";
                            cboChuyenKhoa.Focus();
                            return false;
                        }
                    }
                }
            }
            else if ((HTC.ShareVariables.pub_spC == "PS") && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0 && (txtMaKhoa.Text != "" || cboKhoaKB.Text != ""))
            {
                if (txtmadv.Value.Length >= 2)
                    if (cboChuyenKhoa.SelectedValue == "" && (txtmadv.Value.Substring(0, 2)).ToUpper() == "PK")
                    {
                        ShowMessage("Chưa nhập chuyên khoa");
                        cboKhoaKB.Text = "";
                        cboKhoaKB.SelectedValue = "";
                        cboChuyenKhoa.Focus();
                        return false;
                    }
            }
        }
        if (txthoten.Text != "" && cboDoiTuong.SelectedValue.Substring(0, 1) == "1" && BH_internet == "YES" && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0 && ((_LoaiPhieu == 1 && cboDoiTuong.SelectedValue.Substring(0, 1) == "1") || _LoaiPhieu == 2))
        {
            if (txtSoThe.Text.Substring(0, 3).ToUpper() == "HT5")
            {
                ShowMessage("Thẻ HT5 không thể khám được bệnh nhân");
                return false;
            }
            CheckThe();
        }
        if (_ThongtinBN.KhamBenh.IsNew == true && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count <= 1 && ((_LoaiPhieu == 1 && cboDoiTuong.SelectedValue.Substring(0, 1) == "1") || (_LoaiPhieu == 2 && txtSoThe.Text != "")))
        {
            string count = "";
            if (_ThongtinBN.MaBN != "")
                count = HTC.Business.DataProvider.Instance().spKhamBenh_ThanhToan_KT(_ThongtinBN.MaBN);
            else
                count = HTC.Business.DataProvider.Instance().spKhamBenh_ThanhToan_KT(txtSoThe.Text);
            if (count != "" && count != "" && count != "0")
            {
                ShowMessage("Bệnh nhân này chưa thanh toán kỳ cũ ngày " + count);
            }
        }
        return true;

    }

    private void CheckThe()
    {
        string ketqua = "";

        string sql = " insert into CheckOutTheBHYT(SoThe,HoTen,NgaySinh,NgayLap,MaLoi,MoTa,MaMay,NguoiLap) select ";

        try
        {
            HisBHYT bhyt = new HisBHYT();
            HisBHYT.KQNhanLichSuKCB2018 ls = bhyt.CheckOutSoThe2018(txtSoThe.Text.ToUpper(), txthoten.Text, dtNgaySinh.Text, (optGT.Items[0].Selected == true ? "1" : "2"), dtBHYTTN.Text, dtBHYTDN.Text, txtDKBD.Text);
            if (ls == null)
            {

                if (ketqua == "")
                {
                    sql = sql + "'" + txtSoThe.Text + "',N'" + txthoten.Text + "','" + dtNgaySinh.Text + "',getdate(),null,N'" + "Không thể tra cứu thẻ bảo hiểm trên cổng BHXH!Kiểm tra kết nối hoặc mật khẩu" + Application["BH_user"].ToString() + "/" + Application["BH_password"].ToString() + "','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";
                }
                HTC.Business.DataProvider.Instance().ExcSQL(sql);
                ketqua = "Không thể tra cứu thẻ bảo hiểm trên cổng BHXH!Kiểm tra kết nối hoặc mật khẩu";

            }
            else if (ls.maKetQua == "401" || ls.maKetQua == "500")
            {

                ketqua = "Không kết nối được với máy BHYT";
                sql = sql + "'" + txtSoThe.Text + "',N'" + txthoten.Text + "','" + dtNgaySinh.Text + "',getdate(),'" + ls.maKetQua + "',N'" + ketqua + "','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";

            }
            else if (ls.maKetQua == "01" || ls.maKetQua == "02" || ls.maKetQua == "03" || ls.maKetQua == "04")
            {
                ketqua = "Thẻ khám bệnh có vấn đề về hạn thẻ! Hạn thẻ trên cổng BHXH giá trị  từ ngày  :" + ls.gtTheTu + " đến ngày là :" + ls.gtTheDen;
                //dtBHYTTN.Text = ls.gtTheTu;
                //dtBHYTDN.Text = ls.gtTheDen;
                //  sql = sql + "'" + txtSoThe .Text + "',N'" + ls.hoTen  + "','" + dtNgaySinh .Text + "',getdate(),'"+ ls.maKetQua +"',N'" +ketqua +"','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";

            }
            else if (ls.maKetQua == "08" || ls.maKetQua == "080")
            {
                ketqua = "Thẻ khám bệnh bị sai giới tính";
                //   sql = sql + "'" + txtSoThe .Text + "',N'" + ls.hoTen  + "','" + dtNgaySinh .Text + "',getdate(),'"+ ls.maKetQua +"',N'" +ketqua +"','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";

            }
            else if (ls.maKetQua == "09" || ls.maKetQua == "090")
            {

                ketqua = "Thẻ khám bệnh bị sai nơi đăng ký ban đầu! Nơi đăng ký ban đầu của thẻ là +" + ls.maDKBD;
                //   sql = sql + "'" + txtSoThe .Text + "',N'" + ls.hoTen  + "','" + dtNgaySinh .Text + "',getdate(),'"+ ls.maKetQua +"',N'" +ketqua +"','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";

            }
            else if (ls.maKetQua == "07" || ls.maKetQua == "070")
            {

                ketqua = "Thẻ khám bệnh bị sai ngày sinh ";
                //   sql = sql + "'" + txtSoThe .Text + "',N'" + ls.hoTen  + "','" + dtNgaySinh .Text + "',getdate(),'"+ ls.maKetQua +"',N'" +ketqua +"','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";

            }
            else if (ls.maKetQua == "010")
            {


                ketqua = "Thẻ hết giá trị sử dụng! Hạn thẻ trên cổng BHXH giá trị  từ ngày  :" + ls.gtTheTu + " đến ngày là :" + ls.gtTheDen + " thời điểm đủ năm 5 năm liên tục : " + ls.ngayDu5Nam;

                //   sql = sql + "'" + txtSoThe .Text + "',N'" + ls.hoTen  + "','" + dtNgaySinh .Text + "',getdate(),'"+ ls.maKetQua +"',N'" +ketqua +"','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";
                //dtBHYTTN.Text = ls.gtTheTu;
                //dtBHYTDN.Text = ls.gtTheDen;
            }
            else if (ls.maKetQua == "110")
            {
                ketqua = "Thẻ bị thu hồi! Hạn thẻ trên cổng BHXH giá trị  từ ngày  :" + ls.gtTheTu + " đến ngày là :" + ls.gtTheDen + " thời điểm đủ năm 5 năm liên tục : " + ls.ngayDu5Nam;
                //  sql = sql + "'" + txtSoThe .Text + "',N'" + ls.hoTen  + "','" + dtNgaySinh .Text + "',getdate(),'"+ ls.maKetQua +"',N'" +ketqua +"','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";

            }

            else if (ls.maKetQua == "110" || ls.maKetQua == "120" || ls.maKetQua == "121" || ls.maKetQua == "122" || ls.maKetQua == "123" || ls.maKetQua == "124")
            {


                ketqua = "Thẻ đã báo giảm!Nơi đăng ký ban đầu trên cổng BHXH của thẻ là +" + ls.maDKBD + " giá trị  từ ngày  :" + ls.gtTheTu + " đến ngày là :" + ls.gtTheDen + " thời điểm đủ năm 5 năm liên tục : " + ls.ngayDu5Nam;
                //  sql = sql + "'" + txtSoThe .Text + "',N'" + ls.hoTen  + "','" + dtNgaySinh .Text + "',getdate(),'"+ ls.maKetQua +"',N'" +ketqua +"','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";

            }
            else if (ls.maKetQua == "051" || ls.maKetQua == "050" || ls.maKetQua == "052" || ls.maKetQua == "053")
            {


                ketqua = "Các thông tin trên thẻ bị sai! Nơi đăng ký ban đầu trên cổng BHXH của thẻ là :" + ls.maDKBD + " giá trị  từ ngày  :" + ls.gtTheTu + " đến ngày là :" + ls.gtTheDen + " thời điểm đủ năm 5 năm liên tục : " + ls.ngayDu5Nam;
                //sql = sql + "'" + txtSoThe .Text + "',N'" + ls.hoTen  + "','" + dtNgaySinh .Text + "',getdate(),'"+ ls.maKetQua +"',N'" +ketqua +"','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";

            }
            else if (ls.maKetQua == "060" || ls.maKetQua == "061" || ls.maKetQua == "06")
            {


                ketqua = "Thông tin họ tên trên thẻ bị sai ";
                // sql = sql + "'" + txtSoThe .Text + "',N'" + ls.hoTen  + "','" + dtNgaySinh .Text + "',getdate(),'"+ ls.maKetQua +"',N'" +ketqua +"','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";

            }

            if (ls != null)
            {
                if (ls.gtTheDen != "" && ls.gtTheDen != null)
                {
                    dtBHYTDN.Text = ls.gtTheDen;
                }
               
                if (ls.dsLichSuKCB2018 != null)
                {
                    if (ls.dsLichSuKCB2018.Length > 0)
                    {
                        HisBHYT.HoSo2018 hs = ls.dsLichSuKCB2018[0];
                        if ((DateTime.Parse(hs.ngayRa.Substring(6, 2) + "/" + hs.ngayRa.Substring(4, 2) + "/" + hs.ngayRa.Substring(0, 4)) - DateTime.Now).Days >= -7)
                        {
                            ketqua = ketqua + ". Khám ngày cuối là " + hs.ngayRa.Substring(6, 2) + "/" + hs.ngayRa.Substring(4, 2) + "/" + hs.ngayRa.Substring(0, 4) + " với bệnh là " + hs.tenBenh;

                            sql = sql + "'" + txtSoThe.Text + "',N'" + ls.hoTen + "','" + dtNgaySinh.Text + "',getdate(),'" + ls.maKetQua + "',N'" + ketqua + " ! Hạn thẻ từ ngày  :" + ls.gtTheTu + " đến ngày là :" + ls.gtTheDen + "','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";
                        }
                        else
                        {
                            sql = sql + "'" + txtSoThe.Text + "',N'" + ls.hoTen + "','" + dtNgaySinh.Text + "',getdate(),'" + ls.maKetQua + "',N'" + ketqua + " ! Hạn thẻ từ ngày  :" + ls.gtTheTu + " đến ngày là :" + ls.gtTheDen + " ! Khám ngày cuối là " + hs.ngayRa + " với bệnh là " + hs.tenBenh + "','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";

                        }
                        //if (dtBHYTTN.Text != ls.gtTheTu || dtBHYTDN.Text != ls.gtTheDen)
                        //    ketqua = "Thẻ " + txtSoThe.Text + " họ tên là :" + txthoten.Text + " có giá trị thẻ BHYT từ ngày  :" + ls.gtTheTu + " đến ngày :" + ls.gtTheDen + " thời điểm đủ năm 5 năm liên tục : " + ls.ngayDu5Nam + ".Yêu cầu check lại giá trị thẻ! " + ketqua;

                        HTC.Business.DataProvider.Instance().ExcSQL(sql);
                    }
                    else
                    {

                        ketqua = ketqua + "Bệnh nhân chưa có lịch sử khám bệnh";

                        //if (dtBHYTTN.Text != ls.gtTheTu || dtBHYTDN.Text != ls.gtTheDen)
                        //    ketqua = "Thẻ " + txtSoThe.Text + " họ tên là :" + txthoten.Text + " có giá trị thẻ BHYT từ ngày  :" + ls.gtTheTu + " đến ngày :" + ls.gtTheDen + " thời điểm đủ năm 5 năm liên tục : " + ls.ngayDu5Nam + ".Yêu cầu check lại giá trị thẻ! " + ketqua;
                        if (sql == " insert into CheckOutTheBHYT(SoThe,HoTen,NgaySinh,NgayLap,MaLoi,MoTa,MaMay,NguoiLap) select ")
                        {
                            sql = sql + "'" + txtSoThe.Text + "',N'" + ls.hoTen + "','" + dtNgaySinh.Text + "',getdate(),'" + ls.maKetQua + "',N'" + ketqua + " ! Hạn thẻ từ ngày  :" + ls.gtTheTu + " đến ngày là :" + ls.gtTheDen + "','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";
                        }
                        HTC.Business.DataProvider.Instance().ExcSQL(sql);
                    }
                }
                else
                {
                    if (ketqua == "")
                    {
                        ketqua = "Bệnh nhân chưa có lịch sử khám bệnh trên cổng BHYT" + ls.maKetQua;
                    }
                    if (sql == " insert into CheckOutTheBHYT(SoThe,HoTen,NgaySinh,NgayLap,MaLoi,MoTa,MaMay,NguoiLap) select ")
                    {
                        sql = sql + "'" + txtSoThe.Text + "',N'" + ls.hoTen + "','" + dtNgaySinh.Text + "',getdate(),'" + ls.maKetQua + "',N'" + ketqua + " ! Hạn thẻ từ ngày  :" + ls.gtTheTu + " đến ngày là :" + ls.gtTheDen + "','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";
                    }
                    HTC.Business.DataProvider.Instance().ExcSQL(sql);
                }

                //dtBHYTTN.Text = ls.gtTheTu;
                //dtBHYTDN.Text = ls.gtTheDen;
            }
            if (HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "QN")
            {
                ketqua = ketqua + ". Họ tên : " + ls.hoTen + ", Giới tính : " + ls.gioiTinh + " , Hạn thẻ : " + ls.gtTheTu + "-" + ls.gtTheDen;
                ketqua = ketqua + " . Thời điểm đủ 5 năm liên tục : " + ls.ngayDu5Nam + " . Nơi KCBBĐ:" + ls.maDKBD;
                if (ls.maTheMoi != "" && ls.maTheMoi != ls.maThe)
                    ketqua = ketqua + ". Chủ thẻ đã được cấp mã thẻ mới: " + ls.maTheMoi + " hạn thẻ từ: " + ls.gtTheTuMoi + " đến " + ls.gtTheDenMoi + " . Nơi KCBBĐ:" + ls.maDKBD;
                HisBHYT.HoSo2018 hs = ls.dsLichSuKCB2018[0];
                if (ls.dsLichSuKCB2018 != null)
                {

                    if (ls.dsLichSuKCB2018.Length > 0)
                        ketqua = ketqua + ".Khám ngày cuối là " + hs.ngayRa.Substring(6, 2) + "/" + hs.ngayRa.Substring(4, 2) + "/" + hs.ngayRa.Substring(0, 4) + " với bệnh là " + hs.tenBenh;
                }
                ShowMessage(ketqua);
            }
            else if (ketqua != "")
                ShowMessage(ketqua);

        }
        catch (Exception ex)
        {
            try
            {
                if (ketqua != "")
                    ShowMessage(ketqua);
                else
                {
                    ketqua = "Không thể tra cứu thẻ bảo hiểm trên cổng BHXH!Kiểm tra kết nối hoặc mật khẩu";
                    ShowMessage(ketqua);
                }
                if (sql == " insert into CheckOutTheBHYT(SoThe,HoTen,NgaySinh,NgayLap,MaLoi,MoTa,MaMay,NguoiLap) select ")
                {
                    sql = sql + "'" + txtSoThe.Text + "',N'" + txthoten.Text + "','" + dtNgaySinh.Text + "',getdate(),null,N'" + "Không thể tra cứu thẻ bảo hiểm trên cổng BHXH!Kiểm tra kết nối hoặc mật khẩu" + Application["BH_user"].ToString() + "/" + Application["BH_password"].ToString() + "','" + Pub_sMaMay + "','" + Pub_sNguoiSD + "'";

                    HTC.Business.DataProvider.Instance().ExcSQL(sql);
                }

            }
            catch (Exception ex1)
            {
                ShowMessage(ex1.Message);
            }
        }
    }

    public void comboDataBound(object sender, RadComboBoxItemEventArgs e)
    {

        switch (CurrentTabIndex)
        {

            case 2:
                {
                    DMDichVu_Gia_DT dataItem = e.Item.DataItem as DMDichVu_Gia_DT;


                    if (dataItem == null)
                        e.Item.Attributes["DongiaTT"] = "";
                    else
                        e.Item.Attributes["DongiaTT"] = dataItem.dongiatt.ToString();

                    if (dataItem == null)
                        e.Item.Attributes["DongiaBH"] = "";
                    else
                        e.Item.Attributes["DongiaBH"] = dataItem.Dongia.ToString();
                    if (dataItem == null)
                        e.Item.Attributes["DongiaBH"] = "";
                    else
                        e.Item.Attributes["DongiaCL"] = dataItem.GiaChenhlenh.ToString();
                    if (dataItem == null)
                        e.Item.Attributes["BHTinhTien"] = "";
                    else
                        e.Item.Attributes["BHTinhTien"] = dataItem.DTBH.ToString();
                    if (dataItem == null)
                        e.Item.Attributes["NhapSL"] = "";
                    else
                        e.Item.Attributes["NhapSL"] = dataItem.nhapsl.ToString();
                    //CheckBox chkBox = (CheckBox)e.Item.FindControl("chkChon");
                    //chkBox.Attributes.Add("onclick", "clicked_chkBox('" + dataItem.MaDV + "')");
                    break;
                }
            case 3:
                {
                    DMThuoc_TonKho dataItem = e.Item.DataItem as DMThuoc_TonKho;

                    if (dataItem == null)
                        e.Item.Attributes["tendvt"] = "";
                    else
                        e.Item.Attributes["tendvt"] = dataItem.TenDVT.ToString();

                    if (dataItem == null)
                        e.Item.Attributes["DongiaTT"] = "";
                    else
                        e.Item.Attributes["DongiaTT"] = dataItem.DonGiaTT.ToString();

                    if (dataItem == null)
                        e.Item.Attributes["DongiaBH"] = "";
                    else
                        e.Item.Attributes["DongiaBH"] = dataItem.DonGiaTT.ToString();
                    if (dataItem == null)
                        e.Item.Attributes["BHTinhTien"] = "";
                    else
                        e.Item.Attributes["BHTinhTien"] = "False";

                    break;
                }
            case 4:
                {
                    DMThuocKhoa dataItem = e.Item.DataItem as DMThuocKhoa;

                    if (dataItem == null)
                        e.Item.Attributes["tendvt"] = "";
                    else
                        e.Item.Attributes["tendvt"] = dataItem.TenDVT.ToString();

                    if (dataItem == null)
                        e.Item.Attributes["DongiaTT"] = "";
                    else
                        e.Item.Attributes["DongiaTT"] = dataItem.DonGiaD.ToString();

                    if (dataItem == null)
                        e.Item.Attributes["DongiaBH"] = "";
                    else
                        e.Item.Attributes["DongiaBH"] = dataItem.DonGiaBHD.ToString();
                    if (dataItem == null)
                        e.Item.Attributes["BHTinhTien"] = "";
                    else
                        e.Item.Attributes["BHTinhTien"] = dataItem.DTBH.ToString();

                    break;
                }

        }
    }

    private bool UpdateThongTinBN()
    {


        // thong tinbn 
        _ThongtinBN.GiaTriTN = dtBHYTTN.Text;
        _ThongtinBN.GiaTriDN = dtBHYTDN.Text;
        _ThongtinBN.Hoten = txthoten.Text;
        _ThongtinBN.DTDD = txtDTDD.Text;
        _ThongtinBN.DTCQ = txtDTCQ.Text;
        _ThongtinBN.NoiLamViec = txtNoiLamViec.Text;
        if (HTC.ShareVariables.pub_spC != "PS")
            _ThongtinBN.NoiLamViec = txtNoiLV.Text;

        _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
        _ThongtinBN.Sothe = txtSoThe.Text;
       // _ThongtinBN.NgayMienCCT = dtNgayMienCCT.Text;
         _ThongtinBN.MaBV = cboDKBD.SelectedValue;
        _ThongtinBN.MaBAQL = txtMaBAQL.Text;
        if (optGT.Items[0].Selected == true)

            _ThongtinBN.GT = true;
        else
            _ThongtinBN.GT = false;


        _ThongtinBN.NgaySinh = dtNgaySinh.Text;
        _ThongtinBN.Tuoi = byte.Parse(txttuoi.Text);
        _ThongtinBN.MaTinh = cbotinh.SelectedValue;
        _ThongtinBN.MaHuyen = cbohuyen.SelectedValue;
        _ThongtinBN.MaQG = cboquocgia.SelectedValue;
        if (cboPXa.SelectedValue != null && cboPXa.SelectedValue != "")
            _ThongtinBN.MaPXa = cboPXa.SelectedValue;

        _ThongtinBN.DienThoai = txtdienthoai.Text;

        _ThongtinBN.DiaChi = txtDiaChi.Text;

        _ThongtinBN.BaoTin = txtBaoTin.Text;
        _ThongtinBN.MaNN = cboNgheNghiep.SelectedValue;
        _ThongtinBN.madantoc = cboDanToc.SelectedValue;
        if (_ThongtinBN.IsDirty == true || _ThongtinBN.IsNew == true)
        {
            if (_ThongtinBN.IsNew == true)
            {
                _ThongtinBN.NguoiLap = Pub_sNguoiSD;
                _ThongtinBN.MaMay = Pub_sMaMay;

            }
            else
            {
                _ThongtinBN.NguoiSD = Pub_sNguoiSD;
                _ThongtinBN.MaMay = Pub_sMaMay;
            }
            ThongtinBN tmp = _ThongtinBN.Clone();
            if (txthoten.Enabled == true || (txtMaBAQL.Enabled == true && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")))
            {
                tmp.ApplyEdit();
                _ThongtinBN = tmp.Save();
            }
        }



        KhamBenh _KhamBenh = _ThongtinBN.KhamBenh;
        _ThongtinBN.KhamBenh.loai = _LoaiPhieu;

        _ThongtinBN.KhamBenh.MaBenhNoiGT = cboCDnoiGT.SelectedValue;
        _ThongtinBN.KhamBenh.tenbenhngt = txtBenhNGT.Text;
        _ThongtinBN.KhamBenh.CDNoiGT = txtBenhNGT.Text;
        _ThongtinBN.KhamBenh.GiatriDN = dtBHYTDN.Text;
        _ThongtinBN.KhamBenh.GiaTriTN = dtBHYTTN.Text;
        if (_NoiTT == "095" && _LoaiPhieu == 1)
        {
            _ThongtinBN.KhamBenh.GiatriDN = dtCSDenNgay.Text;
            _ThongtinBN.KhamBenh.GiaTriTN = dtCSTuNgay.Text;
        }
        _ThongtinBN.KhamBenh.MaBN = _ThongtinBN.MaBN;
        _ThongtinBN.KhamBenh.MaBV = cboDKBD.SelectedValue;
        _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
        _ThongtinBN.KhamBenh.NgayGT = dtNgayGT.Text;
        _ThongtinBN.KhamBenh.MaBVGT = cboDKGT.SelectedValue;

        _ThongtinBN.KhamBenh.Sothe = txtSoThe.Text;
      //  _ThongtinBN.KhamBenh.NgayMienCCT = dtNgayMienCCT.Text;
      
      DateTime d= DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);
        _ThongtinBN.KhamBenh.NgayDK = d.ToString("MM/dd/yyyy");
        _ThongtinBN.KhamBenh.Gio = dtgio.Text;
        if (_ThongtinBN.KhamBenh.IsNew == true)
            _ThongtinBN.KhamBenh.NguoiLap = Pub_sNguoiSD;
        _ThongtinBN.KhamBenh.MaMay = Pub_sNguoiSD;
        _ThongtinBN.KhamBenh.NguoiSD = Pub_sNguoiSD;
        _ThongtinBN.KhamBenh.MaBenhNoiGT = cboCDnoiGT.SelectedValue;
        _ThongtinBN.KhamBenh.GiaTriTN = dtBHYTTN.Text;
        if (_NoiTT == "095" && _LoaiPhieu == 1)
        {
            _ThongtinBN.KhamBenh.GiatriDN = dtCSDenNgay.Text;
            _ThongtinBN.KhamBenh.GiaTriTN = dtCSTuNgay.Text;
        }
        _ThongtinBN.KhamBenh.LoaiKham = (cboLoaiBN.SelectedValue == null || cboLoaiBN.SelectedValue == "") ? _ThongtinBN.KhamBenh.LoaiKham : byte.Parse(cboLoaiBN.SelectedValue);


        return true;
    }
    private bool UpdateDuyetBN()
    {
        string sql = "";
        sql = " UPDATE khambenh SET madt ='" + cboDoiTuong.SelectedValue + "', sothe ='" + txtSoThe.Text + "',   duyetbh=1,ngayd=getdate(),nguoid='" + Pub_sNguoiSD + "'";
        sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and isnull(duyetbh,0) =0";
        HTC.Business.DataProvider.Instance().ExcSQL(sql);
        sql = " UPDATE thongtinbn SET madt ='" + cboDoiTuong.SelectedValue + "', sothe ='" + txtSoThe.Text + "'";
        sql = sql + " WHERE mabn ='" + _ThongtinBN.MaBN + "'";
        HTC.Business.DataProvider.Instance().ExcSQL(sql);
        string sql_c = "";
        string sql_thuoc = "";
        string sql_vt = "";
        string sql_hc = "";
        string sql_mau = "";

        foreach (GridDataItem dataItem in grdCTT.MasterTableView.Items)
        {
            bool isChecked = (dataItem.FindControl("Chkbox") as CheckBox).Checked;

            if (isChecked)
            {
                string loaidv = dataItem.GetDataKeyValue("LoaiDV").ToString();
                int stt = int.Parse(dataItem.GetDataKeyValue("SoTT").ToString());
                switch (loaidv)
                {
                    case "1":
                        {
                            sql_c = sql_c + "," + stt.ToString();
                            break;
                        }
                    case "2":
                        {
                            sql_thuoc = sql_thuoc + "," + stt.ToString();
                            break;
                        }
                    case "3":
                        {
                            sql_vt = sql_vt + "," + stt.ToString();
                            break;
                        }
                    case "4":
                        {
                            sql_mau = sql_mau + "," + stt.ToString();
                            break;
                        }
                    case "5":
                        {
                            sql_hc = sql_hc + "," + stt.ToString();
                            break;
                        }
                }
            }
        }
        //xn,tt,xq
        if (sql_c != "")
        {
            //sql = " UPDATE khambenh_c SET duyetbh=0";
            //sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and duyetbh =1 and datt =0";
            //HTC.Business.DataProvider.Instance().ExcSQL(sql);
            sql = " UPDATE khambenh_c SET madt= '" + cboDoiTuong.SelectedValue + "', duyetbh=1,ngaydbh=getdate(),nguoidbh='" + Pub_sNguoiSD + "'";
            if (txtTongHD.Text == "")
                sql = sql + " , datt = " + _LoaiPhieu.ToString() + ", dattbh = " + _LoaiPhieu.ToString() + ", noittbh='" + _NoiTT + "',nguoittbh='" + Pub_sNguoiSD + "' ,ngayttoanbh =getdate()";
            sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and isnull(duyetbh,0) =0";
            sql = sql + " and stt in (" + sql_c.Substring(1) + ")";
            HTC.Business.DataProvider.Instance().ExcSQL(sql);
        }
        //thuoc
        if (sql_thuoc != "")
        {
            //sql = " UPDATE khambenh_ThuocSD SET duyetbh=0";
            //sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and duyetbh =1 and datt =0";
            //HTC.Business.DataProvider.Instance().ExcSQL(sql);
            sql = " UPDATE khambenh_ThuocSD SET madt= '" + cboDoiTuong.SelectedValue + "',duyetbh=1,ngaydbh=getdate(),nguoidbh='" + Pub_sNguoiSD + "'";
            if (txtTongHD.Text == "")
                sql = sql + " , datt = " + _LoaiPhieu.ToString() + ", dattbh = " + _LoaiPhieu.ToString() + ", noittbh='" + _NoiTT + "',nguoittbh='" + Pub_sNguoiSD + "' ,ngayttoanbh =getdate()";
            sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and isnull(duyetbh,0) =0";
            sql = sql + " and stt in (" + sql_thuoc.Substring(1) + ")";
            HTC.Business.DataProvider.Instance().ExcSQL(sql);
        }
        // vtth
        if (sql_vt != "")
        {
            //sql = " UPDATE khambenh_VTTH SET duyetbh=0,dattbh=0";
            //sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and duyetbh =1 and datt =0";
            //HTC.Business.DataProvider.Instance().ExcSQL(sql);
            sql = " UPDATE khambenh_VTTH SET madt= '" + cboDoiTuong.SelectedValue + "',duyetbh=1,ngaydbh=getdate(),nguoidbh='" + Pub_sNguoiSD + "'";
            if (txtTongHD.Text == "")
                sql = sql + " , datt = " + _LoaiPhieu.ToString() + ", dattbh = " + _LoaiPhieu.ToString() + ", noittbh='" + _NoiTT + "',nguoittbh='" + Pub_sNguoiSD + "' ,ngayttoanbh =getdate()";
            sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and isnull(duyetbh,0) =0";
            sql = sql + " and stt in (" + sql_vt.Substring(1) + ")";
            HTC.Business.DataProvider.Instance().ExcSQL(sql);
        }
        // mau
        if (sql_mau != "")
        {
            //sql = " UPDATE khambenh_Mau SET duyetbh=0";
            //sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and duyetbh =1 and datt =0";
            //HTC.Business.DataProvider.Instance().ExcSQL(sql);
            sql = " UPDATE khambenh_Mau SET madt= '" + cboDoiTuong.SelectedValue + "',duyetbh=1,ngaydbh=getdate(),nguoidbh='" + Pub_sNguoiSD + "'";
            if (txtTongHD.Text == "")
                sql = sql + " , datt = " + _LoaiPhieu.ToString() + ", dattbh = " + _LoaiPhieu.ToString() + ", noittbh='" + _NoiTT + "',nguoittbh='" + Pub_sNguoiSD + "' ,ngayttoanbh =getdate()";
            sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and isnull(duyetbh,0) =0";
            sql = sql + " and stt in (" + sql_mau.Substring(1) + ")";
            HTC.Business.DataProvider.Instance().ExcSQL(sql);
        }
        // hoa chat
        if (sql_hc != "")
        {
            //sql = " UPDATE khambenh_HoaChat SET duyetbh=0";
            //sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and duyetbh =1 and datt =0";
            //HTC.Business.DataProvider.Instance().ExcSQL(sql);
            sql = " UPDATE khambenh_HoaChat SET madt= '" + cboDoiTuong.SelectedValue + "',duyetbh=1,ngaydbh=getdate(),nguoidbh='" + Pub_sNguoiSD + "'";
            if (txtTongHD.Text == "")
                sql = sql + ", datt = " + _LoaiPhieu.ToString() + " , dattbh = " + _LoaiPhieu.ToString() + ", noittbh='" + _NoiTT + "',nguoittbh='" + Pub_sNguoiSD + "' ,ngayttoanbh =getdate()";
            sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and isnull(duyetbh,0) =0";
            sql = sql + " and stt in (" + sql_hc.Substring(1) + ")";
            HTC.Business.DataProvider.Instance().ExcSQL(sql);
        }
        // update huy duyet
        sql_c = "";
        sql_thuoc = "";
        sql_vt = "";
        sql_hc = "";
        sql_mau = "";

        foreach (GridDataItem dataItem in grdDTT.MasterTableView.Items)
        {
            bool isChecked = (dataItem.FindControl("Chkbox") as CheckBox).Checked;

            if (isChecked)
            {
                string loaidv = dataItem.GetDataKeyValue("LoaiDV").ToString();
                int stt = int.Parse(dataItem.GetDataKeyValue("SoTT").ToString());
                switch (loaidv)
                {
                    case "1":
                        {
                            sql_c = sql_c + "," + stt.ToString();
                            break;
                        }
                    case "2":
                        {
                            sql_thuoc = sql_thuoc + "," + stt.ToString();
                            break;
                        }
                    case "3":
                        {
                            sql_vt = sql_vt + "," + stt.ToString();
                            break;
                        }
                    case "4":
                        {
                            sql_mau = sql_mau + "," + stt.ToString();
                            break;
                        }
                    case "5":
                        {
                            sql_hc = sql_hc + "," + stt.ToString();
                            break;
                        }
                }
            }
        }
        //xn,tt,xq
        if (sql_c != "")
        {
            //sql = " UPDATE khambenh_c SET duyetbh=0";
            //sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and duyetbh =1 and datt =0";
            //HTC.Business.DataProvider.Instance().ExcSQL(sql);
            sql = " UPDATE khambenh_c SET madt= '" + cboDoiTuong.SelectedValue + "', duyetbh=0,ngaydbh=getdate(),nguoidbh='" + Pub_sNguoiSD + "'";
            if (txtTongHD.Text == "")
                sql = sql + " , datt = 0, dattbh = 0, noittbh='" + _NoiTT + "',nguoittbh='" + Pub_sNguoiSD + "' ,ngayttoanbh =getdate()";
            sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and isnull(duyetbh,0) =1";
            sql = sql + " and stt in (" + sql_c.Substring(1) + ")";
            HTC.Business.DataProvider.Instance().ExcSQL(sql);
        }
        //thuoc
        if (sql_thuoc != "")
        {
            //sql = " UPDATE khambenh_ThuocSD SET duyetbh=0";
            //sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and duyetbh =1 and datt =0";
            //HTC.Business.DataProvider.Instance().ExcSQL(sql);
            sql = " UPDATE khambenh_ThuocSD SET madt= '" + cboDoiTuong.SelectedValue + "',duyetbh=0,ngaydbh=getdate(),nguoidbh='" + Pub_sNguoiSD + "'";
            if (txtTongHD.Text == "")
                sql = sql + " , datt = 0, dattbh = 0, noittbh='" + _NoiTT + "',nguoittbh='" + Pub_sNguoiSD + "' ,ngayttoanbh =getdate()";
            sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and isnull(duyetbh,0) =1";
            sql = sql + " and stt in (" + sql_thuoc.Substring(1) + ")";
            HTC.Business.DataProvider.Instance().ExcSQL(sql);
        }
        // vtth
        if (sql_vt != "")
        {
            //sql = " UPDATE khambenh_VTTH SET duyetbh=0,dattbh=0";
            //sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and duyetbh =1 and datt =0";
            //HTC.Business.DataProvider.Instance().ExcSQL(sql);
            sql = " UPDATE khambenh_VTTH SET madt= '" + cboDoiTuong.SelectedValue + "',duyetbh=0,ngaydbh=getdate(),nguoidbh='" + Pub_sNguoiSD + "'";
            if (txtTongHD.Text == "")
                sql = sql + " , datt = 0, dattbh = 0, noittbh='" + _NoiTT + "',nguoittbh='" + Pub_sNguoiSD + "' ,ngayttoanbh =getdate()";
            sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and isnull(duyetbh,0) =1";
            sql = sql + " and stt in (" + sql_vt.Substring(1) + ")";
            HTC.Business.DataProvider.Instance().ExcSQL(sql);
        }
        // mau
        if (sql_mau != "")
        {
            //sql = " UPDATE khambenh_Mau SET duyetbh=0";
            //sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and duyetbh =1 and datt =0";
            //HTC.Business.DataProvider.Instance().ExcSQL(sql);
            sql = " UPDATE khambenh_Mau SET madt= '" + cboDoiTuong.SelectedValue + "',duyetbh=0,ngaydbh=getdate(),nguoidbh='" + Pub_sNguoiSD + "'";
            if (txtTongHD.Text == "")
                sql = sql + " , datt = 0, dattbh = 0, noittbh='" + _NoiTT + "',nguoittbh='" + Pub_sNguoiSD + "' ,ngayttoanbh =getdate()";
            sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and isnull(duyetbh,0) =1";
            sql = sql + " and stt in (" + sql_mau.Substring(1) + ")";
            HTC.Business.DataProvider.Instance().ExcSQL(sql);
        }
        // hoa chat
        if (sql_hc != "")
        {
            //sql = " UPDATE khambenh_HoaChat SET duyetbh=0";
            //sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and duyetbh =1 and datt =0";
            //HTC.Business.DataProvider.Instance().ExcSQL(sql);
            sql = " UPDATE khambenh_HoaChat SET madt= '" + cboDoiTuong.SelectedValue + "',duyetbh=0,ngaydbh=getdate(),nguoidbh='" + Pub_sNguoiSD + "'";
            if (txtTongHD.Text == "")
                sql = sql + ", datt = 0 , dattbh = 0, noittbh='" + _NoiTT + "',nguoittbh='" + Pub_sNguoiSD + "' ,ngayttoanbh =getdate()";
            sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and isnull(duyetbh,0) =1";
            sql = sql + " and stt in (" + sql_hc.Substring(1) + ")";
            HTC.Business.DataProvider.Instance().ExcSQL(sql);
        }
        return true;
    }
    private bool UpdateDataHoanHD(string sosohd = "", string sohd = "", Boolean huy = false)
    {
        string sql = "";
        if (sosohd == null)
            sosohd = "";
        if (sosohd == "")
            return false;
        //if (_LoaiPhieu == 2)
        //{
        //    sql = " UPDATE khambenh SET duyetbh=0,ngayd=getdate(),nguoid='" + Pub_sNguoiSD + "'";
        //    sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and duyetbh =0";
        //    HTC.Business.DataProvider.Instance().ExcSQL(sql);
        //}
        //sql = " UPDATE khambenh_hoadon SET tongchi=tongthu,ngaychi=getdate(),nguoichi='" + Pub_sNguoiSD + "'";
        //sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and noitt='" + _NoiTT + "'";
        //if (sosohd != "")
        //    sql = sql + " and sosohd ='" + sosohd + "' and sohd ='" + sohd + "'";
        //HTC.Business.DataProvider.Instance().ExcSQL(sql);
        //// ShowMessage(_LoaiPhieu.ToString ());
        //if (_LoaiPhieu == 2)
        //{
        //    sql = " UPDATE khambenh_c SET duyetbh=0,sosohdbh = null,sohdbh=null,datt=0,dattbh=0";
        //    sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "'  and dattbh <>0";
        //    sql = sql + " and noittbh='" + _NoiTT + "'";
        //    if (sosohd != "")
        //        sql = sql + " and sosohdbh ='" + sosohd + "' and sohdbh ='" + sohd + "'";
        //    //ShowMessage(sql);
        //    HTC.Business.DataProvider.Instance().ExcSQL(sql);
        //    sql = " UPDATE khambenh_thuocsd SET duyetbh=0,sosohdbh = null,sohdbh=null,datt=0,dattbh=0";
        //    sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "'  and dattbh <>0";
        //    sql = sql + " and noittbh='" + _NoiTT + "'";
        //    if (sosohd != "")
        //        sql = sql + " and sosohdbh ='" + sosohd + "' and sohdbh ='" + sohd + "'";

        //    HTC.Business.DataProvider.Instance().ExcSQL(sql);
        //    if (HTC.ShareVariables.pub_spC == "YH")
        //    {
        //        sql = " UPDATE khambenh_thuocsd_dy SET duyetbh=0,sosohdbh = null,sohdbh=null,datt=0,dattbh=0";
        //        sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and dattbh <>0";
        //        sql = sql + " and noittbh='" + _NoiTT + "'";
        //        if (sosohd != "")
        //            sql = sql + " and sosohdbh ='" + sosohd + "' and sohdbh ='" + sohd + "'";

        //        HTC.Business.DataProvider.Instance().ExcSQL(sql);
        //    }
        //    sql = " UPDATE khambenh_vtth SET duyetbh=0,sosohdbh = null,sohdbh=null,datt=0,dattbh=0";
        //    sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "'  and dattbh <>0";
        //    sql = sql + " and noittbh='" + _NoiTT + "'";
        //    if (sosohd != "")
        //        sql = sql + " and sosohdbh ='" + sosohd + "' and sohdbh ='" + sohd + "'";

        //    HTC.Business.DataProvider.Instance().ExcSQL(sql);
        //    sql = " UPDATE khambenh_hoachat SET duyetbh=0,sosohdbh = null,sohdbh=null,datt=0,dattbh=0";
        //    sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "'  and dattbh <>0";
        //    sql = sql + " and noittbh='" + _NoiTT + "'";
        //    if (sosohd != "")
        //        sql = sql + " and sosohdbh ='" + sosohd + "' and sohdbh ='" + sohd + "'";

        //    HTC.Business.DataProvider.Instance().ExcSQL(sql);
        //    sql = " UPDATE khambenh_mau SET duyetbh=0,sosohdbh = null,sohdbh=null,datt=0,dattbh=0";
        //    sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "'  and dattbh <>0";
        //    sql = sql + " and noittbh='" + _NoiTT + "'";
        //    if (sosohd != "")
        //        sql = sql + " and sosohdbh ='" + sosohd + "' and sohdbh ='" + sohd + "'";

        //    HTC.Business.DataProvider.Instance().ExcSQL(sql);
        //}
        //else
        //{
        //    sql = " UPDATE khambenh_c SET sosohdtt = null,sohdtt=null,datt=0,datttt=0";
        //    sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and datttt <>0";
        //    if (sosohd != "")
        //        sql = sql + " and sosohdtt ='" + sosohd + "' and sohdtt ='" + sohd + "'";
        //    sql = sql + " and noitttt='" + _NoiTT + "'";

        //    HTC.Business.DataProvider.Instance().ExcSQL(sql);
        //    sql = " UPDATE khambenh_thuocsd SET sosohdtt = null,sohdtt=null,datt=0,datttt=0";
        //    sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and datttt <>0";
        //    if (sosohd != "")
        //        sql = sql + " and sosohdtt ='" + sosohd + "' and sohdtt ='" + sohd + "'";
        //    sql = sql + " and noitttt='" + _NoiTT + "'";

        //    HTC.Business.DataProvider.Instance().ExcSQL(sql);
        //    if (HTC.ShareVariables.pub_spC == "YH")
        //    {
        //        sql = " UPDATE khambenh_thuocsd_dy SET sosohdtt = null,sohdtt=null,datt=0,datttt=0";
        //        sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and datttt <>0";
        //        if (sosohd != "")
        //            sql = sql + " and sosohdtt ='" + sosohd + "' and sohdtt ='" + sohd + "'";
        //        sql = sql + " and noitttt='" + _NoiTT + "'";

        //    }
        //    HTC.Business.DataProvider.Instance().ExcSQL(sql);
        //    sql = " UPDATE khambenh_hoachat SET sosohdtt = null,sohdtt=null,datt=0,datttt=0";
        //    sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and datttt <>0";
        //    if (sosohd != "")
        //        sql = sql + " and sosohdtt ='" + sosohd + "' and sohdtt ='" + sohd + "'";
        //    sql = sql + " and noitttt='" + _NoiTT + "'";

        //    HTC.Business.DataProvider.Instance().ExcSQL(sql);
        //    sql = " UPDATE khambenh_vtth SET sosohdtt = null,sohdtt=null,datt=0,datttt=0";
        //    sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and datttt <>0";
        //    if (sosohd != "")
        //        sql = sql + " and sosohdtt ='" + sosohd + "' and sohdtt ='" + sohd + "'";
        //    sql = sql + " and noitttt='" + _NoiTT + "'";

        //    HTC.Business.DataProvider.Instance().ExcSQL(sql);
        //    sql = " UPDATE khambenh_mau SET sosohdtt = null,sohdtt=null,datt=0,datttt=0";
        //    sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "' and datttt <>0";
        //    if (sosohd != "")
        //        sql = sql + " and sosohdtt ='" + sosohd + "' and sohdtt ='" + sohd + "'";
        //    sql = sql + " and noitttt='" + _NoiTT + "'";

        //    HTC.Business.DataProvider.Instance().ExcSQL(sql);
        if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && sosohd == "" && sohd == "" && _LanTT >= 90)
        {
            sql = " exec spKhamBenh_HoaDon_Huy '" + _ThongtinBN.KhamBenh.MaSoKham + "','" + _LanTT + "','" + _LanTT + "','" + _NoiTT + "','" + Pub_sNguoiSD + "','" + Pub_sMaMay + "'," + (huy == false ? _LoaiPhieu : _LoaiPhieu + 100).ToString();
            HTC.Business.DataProvider.Instance().ExcSQL(sql);
        }
        else
        {
            sql = " exec spKhamBenh_HoaDon_Huy '" + _ThongtinBN.KhamBenh.MaSoKham + "','" + sosohd + "','" + sohd + "','" + _NoiTT + "','" + Pub_sNguoiSD + "','" + Pub_sMaMay + "'," + (huy == false ? _LoaiPhieu : _LoaiPhieu + 100).ToString();
            HTC.Business.DataProvider.Instance().ExcSQL(sql);
        }

        if (HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ " && (HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ " && dtNgayDK.Text != DateTime.Now.ToString("dd/MM/yyyy")))
        {
            PrintDataHoanDV(sosohd, sohd);
            //CloseWindow();
            //OpenWindow("frmLapPhieu.aspx?LoaiPhieu=" + _LoaiPhieu + "&noitt=" + _NoiTT + "&duyet=" + _Duyet + "&PubMaDT=" + _PubMaDT + "&maBN=" + _MaBN + "&ngayDK=" + _ThongtinBN.KhamBenh.NgayDK);
            _MaBN = "";
            SearchBN();
        }
        else
            Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={0}&&noitt={1}&duyet={2}&&maBN={3}&&ngayDK={4}&PubMaDT={5}", _LoaiPhieu, _NoiTT, _Duyet, _MaBN, _ThongtinBN.KhamBenh.NgayDK, _PubMaDT), false);

        return true;
    }
    private void UpdateMienGiam()
    {
        if (txtMG.Text != "" && _ThongtinBN.KhamBenh.TongThuHoaDon != 0)
        {
            KhamBenh_MienGiam _mg = KhamBenh_MienGiam.NewKhamBenh_MienGiam();
            _mg.maSoKham = _ThongtinBN.KhamBenh.MaSoKham;
            _mg.STT = 1;
            if (_ThongtinBN.KhamBenh.TongThuHoaDon != 0)
            {
                _mg.CK = decimal.Parse(txtMG.Text == "" ? "0" : txtMG.Text);
                _mg.SoTien = (_ThongtinBN.KhamBenh.TongThuHoaDon - decimal.Parse(txtTongHD.Text == "" ? "0" : txtTongHD.Text)).ToString();

            }
            _mg.GhiChu = txtGhiChuHD.Text;
            _mg.DATT = _LoaiPhieu;
            _mg.NoiTT = _NoiTT;
            if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                _mg.MaKhoa = _ThongtinBN.KhamBenh.KhamBenh_C_List[0].Makhoa;
            _mg.MaMienGiam = "00001";
            _mg.nguoiKy = cboNguoiDuyet.SelectedValue;
            _mg.MaMay = Pub_sMaMay;
            _mg.NguoiLap = Pub_sNguoiSD;
            if (_LoaiPhieu == 2)
                _mg.MaDT = cboDoiTuong.SelectedValue;
            else if (cboDoiTuong.SelectedValue.Substring(0, 1) == "0")
                _mg.MaDT = cboDoiTuong.SelectedValue;
            else
            {
                if (_NoiTT == "087" || _NoiTT == "095")
                    _mg.MaDT = "00002";
                else if (_NoiTT == "093")
                    _mg.MaDT = "00002";
                else
                    _mg.MaDT = "00001";
            }
            if (_mg.SoTien != "")
            {
                _mg.ApplyEdit();
                _mg.Save();
            }
        }


    }
    private bool UpdateThanhToanHD()
    {
        string lydothu = "";
        string lydothuTN = "";
        decimal tongthuTN = 0;
        string lydothuDY = "";
        decimal tongthuDY = 0;
        string sohdtra = "";
        string sosohdtra = "";
        string sttdv = "";
        string sttthuoc = "";
        string sttdy = "";
        string sttvt = "";
        if (!(_LoaiPhieu == 2 || _LoaiPhieu == 7 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)))
            return false;

        if (txtsohd.Text != "" && HTC.ShareVariables.pub_spC == "YH")
        {
            try
            {
                int.Parse(txtsohd.Text);
            }
            catch
            {
            }
        }

        // cap nhat so hoa don va update thanh toan

        // chua thanh toan va khong in thu
        if (sosohdtra == "" && _ThongtinBN.KhamBenh.KhamBenh_C_List != null)
            foreach (KhamBenh_C kb in _ThongtinBN.KhamBenh.KhamBenh_C_List)
            {
                if (kb.SLTra != "0" && kb.SLTraCu == "0")
                {
                    sosohdtra = kb.SoSoHD;
                    sohdtra = kb.SoHD;
                    break;
                }
            }
        if (sosohdtra == "" && _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList != null)
            foreach (KhamBenh_ThuocSD kb in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
            {
                if (kb.SLTra != "0" && kb.SLTraCu == "0")
                {
                    sosohdtra = kb.SoSoHD;
                    sohdtra = kb.SoHD;
                    break;
                }
            }
        if (sosohdtra == "" && _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList != null)
            foreach (KhamBenh_ThuocSD_DY kb in _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList)
            {
                if (kb.SLTra != 0 && kb.SLTraCu == "0")
                {
                    sosohdtra = kb.SoSoHD;
                    sohdtra = kb.SoHD;
                    break;
                }
            }
        if (sosohdtra == "" && _ThongtinBN.KhamBenh.KhamBenh_VTTHList != null)
            foreach (KhamBenh_VTTH kb in _ThongtinBN.KhamBenh.KhamBenh_VTTHList)
            {
                if (kb.SLTra != "0" && kb.SLTraCu == "0")
                {
                    sosohdtra = kb.SoSoHD;
                    sohdtra = kb.SoHD;
                    break;
                }
            }
        if (sosohdtra == "" && _ThongtinBN.KhamBenh.KhamBenh_HoaChatList != null)
            foreach (KhamBenh_HoaChat kb in _ThongtinBN.KhamBenh.KhamBenh_HoaChatList)
            {
                if (kb.SLTra != "0" && kb.SLTraCu == "0")
                {
                    sosohdtra = kb.SoSoHD;
                    sohdtra = kb.SoHD;
                    break;
                }
            }
        if (sosohdtra == "" && _ThongtinBN.KhamBenh.KhamBenh_MauList != null)
            foreach (KhamBenh_Mau kb in _ThongtinBN.KhamBenh.KhamBenh_MauList)
            {
                if (kb.SLTra != "0" && kb.SLTraCu == "0")
                {
                    sosohdtra = kb.SoSoHD;
                    sohdtra = kb.SoHD;
                    break;
                }
            }
        _SoHDCuoi = txtsohd.Text;
        if (_ThongtinBN.KhamBenh.KhamBenh_C_List != null)
            foreach (KhamBenh_C _kbc in _ThongtinBN.KhamBenh.KhamBenh_C_List)
            {
                if (_kbc.DaTTBH == 0 && (_LoaiPhieu == 2 || (_LoaiPhieu == 1 && _Duyet == 1 && dtNgayQT.Text != "" && txtTongHD.Text == "")) && _kbc.slmua != "0" && _kbc.slmua != "")
                {
                    //c
                    if (txtTongHD.Text != "")
                    {
                        _kbc.SoSoHD = txtKyhieu.Text;
                        _kbc.SoHD = txtsohd.Text;
                    }
                    _kbc.NoiTTBH = _NoiTT;
                    _kbc.DaTTBH = _LoaiPhieu;
                    _kbc.DaTT = _LoaiPhieu;
                    if (HTC.ShareVariables.pub_spC == "PS")
                        lydothu = lydothu + (_kbc.tentat == "" ? _kbc.TenDV : _kbc.tentat) + ", ";
                    else if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                        lydothu = lydothu + _kbc.TenDV + "(" + (decimal.Parse(_kbc.thanhtien) / 1000).ToString() + "), ";

                    _kbc.NguoiSD = Pub_sNguoiSD;
                    _kbc.MaMay = Pub_sMaMay;
                    sttdv = sttdv + _kbc.STT + ",";
                }
                else if (_kbc.DaTTTT == 0 && _LoaiPhieu != 2 && _kbc.slmua != "0" && _kbc.slmua != "")
                {
                    //c
                    _kbc.DaTTTT = _LoaiPhieu;
                    if (_kbc.inthu == false || (HTC.ShareVariables.pub_spC != "YH") || (_NoiTT != "085" && (!((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094"))))
                    {
                        if (txtTongHD.Text != "")
                        {
                            _kbc.SoSoHD = txtKyhieu.Text;
                            _kbc.SoHD = txtsohd.Text;
                        }
                    }
                    _kbc.NoiTTTT = _NoiTT;
                    _kbc.DaTT = _LoaiPhieu;
                    _kbc.NguoiSD = Pub_sNguoiSD;
                    _kbc.MaMay = Pub_sMaMay;
                    sttdv = sttdv + _kbc.STT + ",";
                    if (_kbc.thanhtien != "")
                    {
                        if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                            lydothu = lydothu + _kbc.TenDV + "(" + (decimal.Parse(_kbc.thanhtien) / 1000).ToString() + "), ";
                        else if (_kbc.inthu == true && HTC.ShareVariables.pub_spC == "YH" && ((_NoiTT == "085" && (_LoaiPhieu == 9 || _LoaiPhieu == 8)) || ((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093")))
                        {
                            if ((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)))
                            {
                                lydothuTN = lydothuTN + (_kbc.tentat == "" ? _kbc.MaDV : _kbc.tentat) + "(" + (decimal.Parse(_kbc.slmua == "" ? "0" : _kbc.slmua)).ToString() + "), ";
                                tongthuTN = tongthuTN + decimal.Parse(_kbc.thanhtien);
                            }
                            else
                            {
                                lydothuTN = lydothuTN + (_kbc.tentat == "" ? _kbc.MaDV : _kbc.tentat) + "(" + (decimal.Parse(_kbc.thanhtien) / 1000).ToString() + "), ";
                                tongthuTN = tongthuTN + decimal.Parse(_kbc.thanhtien);
                            }
                        }
                        else if (HTC.ShareVariables.pub_spC == "PS" && _kbc.DongiaTT != "" && _kbc.DongiaTT != "0")
                            lydothu = lydothu + (_kbc.tentat == "" ? _kbc.TenDV : _kbc.tentat) + ", ";

                        else if (cboNhanVien.Text != "" && _kbc.MaDV.Substring(0, 2).ToUpper() == "PK" && HTC.ShareVariables.pub_spC == "YH")
                            lydothu = lydothu + _kbc.TenDV + " -  (" + _kbc.tenbschidinh + " - " + _kbc.tenkhoa + ")  - (" + (decimal.Parse(_kbc.thanhtien) / 1000).ToString() + "), ";
                        else if (HTC.ShareVariables.pub_spC != "PS")
                            lydothu = lydothu + (_kbc.tentat == "" ? _kbc.MaDV : _kbc.tentat) + "(" + (decimal.Parse(_kbc.thanhtien) / 1000).ToString() + "), ";
                    }
                    else
                    {
                        if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                            lydothu = lydothu + _kbc.TenDV + ", ";
                        else if (_kbc.inthu == true && HTC.ShareVariables.pub_spC == "YH" && ((_NoiTT == "085" && (_LoaiPhieu == 9 || _LoaiPhieu == 8)) || ((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093")))
                        {
                            if ((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)))
                            {
                                lydothuTN = lydothuTN + (_kbc.tentat == "" ? _kbc.MaDV : _kbc.tentat) + ", ";

                            }
                            else
                            {
                                lydothuTN = lydothuTN + (_kbc.tentat == "" ? _kbc.MaDV : _kbc.tentat) + ",";

                            }
                        }
                        else if (HTC.ShareVariables.pub_spC == "PS" && _kbc.DongiaTT != "" && _kbc.DongiaTT != "0")
                            lydothu = lydothu + (_kbc.tentat == "" ? _kbc.TenDV : _kbc.tentat) + ", ";

                         else if (HTC.ShareVariables.pub_spC != "PS" )
                            lydothu = lydothu + (_kbc.tentat == "" ? _kbc.MaDV : _kbc.tentat) + ", ";
                    }
                }
                else if (_kbc.SLTra != "0" && _kbc.SLTra != "" && _kbc.Ngaytra != "" && _kbc.slmua != "0" && _kbc.slmua != "")
                {
                    _kbc.SoSoHDTra = _kbc.SoSoHD;
                    _kbc.SoHDTra = _kbc.SoHD;

                }
                else if (sosohdtra == _kbc.SoSoHD && sohdtra == _kbc.SoHD)
                {
                    if (_kbc.thanhtien != "")
                    {
                        if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                            lydothu = lydothu + _kbc.TenDV + "(" + (decimal.Parse(_kbc.thanhtien) / 1000).ToString() + ")(ĐTT), ";

                        else if (_kbc.inthu == true && HTC.ShareVariables.pub_spC == "YH" && ((_NoiTT == "085" && (_LoaiPhieu == 9 || _LoaiPhieu == 8)) || ((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093")))
                        {
                            lydothuTN = lydothuTN + (_kbc.tentat == "" ? _kbc.MaDV : _kbc.tentat) + "(" + (decimal.Parse(_kbc.thanhtien) / 1000).ToString() + "), ";
                            tongthuTN = tongthuTN + decimal.Parse(_kbc.thanhtien);
                        }
                        else if (HTC.ShareVariables.pub_spC == "PS")
                            lydothu = lydothu + (_kbc.tentat == "" ? _kbc.TenDV : _kbc.tentat) + "(ĐTT), ";


                        else
                            lydothu = lydothu + (_kbc.tentat == "" ? _kbc.MaDV : _kbc.tentat) + "(" + (decimal.Parse(_kbc.thanhtien) / 1000).ToString() + " thang) ";
                    }
                }
            }

        if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList != null)
            foreach (KhamBenh_ThuocSD _kbc in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
            {
                if (_kbc.DaTTBH == 0 && (_LoaiPhieu == 2 || (_LoaiPhieu == 1 && _Duyet == 1 && dtNgayQT.Text != "" && txtTongHD.Text == "")) && _kbc.SLMua != "0" && _kbc.SLMua != "")
                {
                    //c
                    _kbc.DaTTBH = _LoaiPhieu;
                    if (txtTongHD.Text != "")
                    {
                        _kbc.SoSoHD = txtKyhieu.Text;
                        _kbc.SoHD = txtsohd.Text;
                    }
                    _kbc.NoiTTBH = _NoiTT;
                    _kbc.DATT = _LoaiPhieu;
                    if (HTC.ShareVariables.pub_spC == "PS")
                        lydothu = lydothu + (_kbc.TenTM == "" ? _kbc.TenTM : _kbc.TenTM) + "(" + _kbc.SLMua + ")" + ", ";
                    else
                        lydothu = lydothu + _kbc.TenTM + "(" + _kbc.thanhtien + "), ";
                    _kbc.NguoiSD = Pub_sNguoiSD;
                    _kbc.MaMay = Pub_sMaMay;
                    sttthuoc = sttthuoc + _kbc.STT + ",";
                }
                else if (_kbc.DaTTTT == 0 && _LoaiPhieu != 2 && _kbc.SLMua != "0" && _kbc.SLMua != "")
                {
                    //c
                    _kbc.DaTTTT = _LoaiPhieu;
                    if (txtTongHD.Text != "")
                    {
                        _kbc.SoSoHD = txtKyhieu.Text;
                        _kbc.SoHD = txtsohd.Text;
                    }
                    _kbc.NoiTTTT = _NoiTT;
                    _kbc.DATT = _LoaiPhieu;
                    _kbc.NguoiSD = Pub_sNguoiSD;
                    _kbc.MaMay = Pub_sMaMay;
                    if (HTC.ShareVariables.pub_spC == "PS")
                        lydothu = lydothu + _kbc.TenTM + "(" + _kbc.SLMua + ")" + ", ";
                    else
                        lydothu = lydothu + _kbc.TenTM + "(" + _kbc.thanhtien + "), ";
                    if (_LoaiPhieu == 7 && _NoiTT != "085")
                    {
                        _kbc.Makx = (_NoiTT == "091") ? HTC.ShareVariables.pub_sMaKX091 : HTC.ShareVariables.pub_sMaKX092;
                        _kbc.MaPX = _MaPX;
                        _kbc.Phat = true;
                        _kbc.Duyet = true;

                    }
                    else if (_LoaiPhieu == 7 && HTC.ShareVariables.pub_spC == "QN")
                    {
                        _kbc.Makx = HTC.ShareVariables.pub_sMaKX091;
                        _kbc.MaPX = _MaPX;
                        _kbc.Phat = true;
                        _kbc.Duyet = true;
                    }
                    sttthuoc = sttthuoc + _kbc.STT + ",";
                }
                else if (_kbc.SLTra != "0" && _kbc.SLTra != "" && _kbc.Ngaytra != "")
                {
                    _kbc.SoSoHDTra = _kbc.SoSoHD;
                    _kbc.SoHDTra = _kbc.SoHD;

                }
                else if (sosohdtra == _kbc.SoSoHD && sohdtra == _kbc.SoHD)
                {
                    if (HTC.ShareVariables.pub_spC == "PS")
                        lydothu = lydothu + _kbc.TenTM + "(ĐTT), ";
                    else
                        lydothu = lydothu + _kbc.TenTM + "(" + _kbc.thanhtien + "), ";
                }
            }
        if (HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN")
        {
            foreach (KhamBenh_ThuocSD_DY _kbc in _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList)
            {
                if (_kbc.DaTTTT == 0 && _LoaiPhieu != 2 && _kbc.SLMua != "0" && _kbc.SLMua != "")
                {
                    //c
                    _kbc.DATT = _LoaiPhieu;
                    _kbc.DaTTTT = _LoaiPhieu;
                    if (HTC.ShareVariables.pub_spC == "QN")
                    {
                        _kbc.MaPX = _MaPXDY;
                        _kbc.Phat = true;
                        _kbc.Duyet = true;
                        _kbc.NguoiP = Pub_sNguoiSD;
                        _kbc.NgayP = DateTime.Now.ToString();
                    }
                    if (txtTongHD.Text != "")
                    {
                        _kbc.SoSoHD = txtKyhieu.Text;
                        _kbc.SoHD = txtsohd.Text;
                    }
                    _kbc.NoiTTTT = _NoiTT;
                    if (_kbc.TongDon != "")
                        // tongthuDY = decimal.Parse(_kbc.TongDon);
                        //if (HTC.ShareVariables.pub_spC =="QN")
                        //    lydothuDY = lydothuDY + "Thuốc ĐY" + "(" + _kbc.SLMua + " thang), ";
                        //else
                        lydothu = lydothu + "Thuốc ĐY" + "(" + _kbc.SLMua + " thang), ";
                    sttdy = sttdy + _kbc.STT + ",";
                    _kbc.NguoiSD = Pub_sNguoiSD;
                    _kbc.MaMay = Pub_sMaMay;

                }
                else if (_kbc.DaTTBH == 0 && _LoaiPhieu == 2 && _kbc.SLMua != "0" && _kbc.SLMua != "")
                {
                    //c
                    _kbc.DATT = _LoaiPhieu;
                    _kbc.DaTTBH = _LoaiPhieu;
                    if (txtTongHD.Text != "")
                    {
                        _kbc.SoSoHD = txtKyhieu.Text;
                        _kbc.SoHD = txtsohd.Text;
                    }
                    _kbc.NoiTTBH = _NoiTT;
                    _kbc.DATT = _LoaiPhieu;
                    _kbc.NguoiSD = Pub_sNguoiSD;
                    _kbc.MaMay = Pub_sMaMay;

                }
                else if (_kbc.SLTra != 0 && _kbc.Ngaytra != "")
                {
                    _kbc.SoSoHDTra = _kbc.SoSoHD;
                    _kbc.SoHDTra = _kbc.SoHD;

                }
                else if (sosohdtra == _kbc.SoSoHD && sohdtra == _kbc.SoHD && _kbc.SLMua != "" && _kbc.SLMua != "0")
                {
                    //if (HTC.ShareVariables.pub_spC == "QN")
                    //    lydothuDY = lydothuDY + "Thuốc ĐY" + "(" + (int.Parse(_kbc.SLMua == "" ? "0" : _kbc.SLMua) - int.Parse((_kbc.SLTra.ToString() == "" || _kbc.SLTra.ToString() == "0.00") ? "0" : _kbc.SLTra.ToString())).ToString() + " thang), ";
                    //   else
                    lydothu = lydothu + "Thuốc ĐY" + "(" + (int.Parse(_kbc.SLMua == "" ? "0" : _kbc.SLMua) - int.Parse((_kbc.SLTra.ToString() == "" || _kbc.SLTra.ToString() == "0.00") ? "0" : _kbc.SLTra.ToString())).ToString() + " thang), ";
                }
            }
        }
        if (_ThongtinBN.KhamBenh.KhamBenh_VTTHList != null)
            foreach (KhamBenh_VTTH _kbc in _ThongtinBN.KhamBenh.KhamBenh_VTTHList)
            {
                if (_kbc.DaTTBH == 0 && (_LoaiPhieu == 2 || (_LoaiPhieu == 1 && _Duyet == 1 && dtNgayQT.Text != "" && txtTongHD.Text == "")) && _kbc.SLMua != "0" && _kbc.SLMua != "")
                {
                    //c
                    _kbc.DaTTBH = _LoaiPhieu;
                    if (txtTongHD.Text != "")
                    {
                        _kbc.SoSoHD = txtKyhieu.Text;
                        _kbc.SoHD = txtsohd.Text;
                    }
                    _kbc.NoiTTBH = _NoiTT;
                    _kbc.NguoiTTBH = Pub_sNguoiSD;
                    _kbc.NguoiTT = Pub_sNguoiSD;
                    if (HTC.ShareVariables.pub_spC == "PS")
                        lydothu = lydothu + (_kbc.TenTM == "" ? _kbc.TenTM : _kbc.TenTM) + ", ";
                    else
                        lydothu = lydothu + _kbc.TenTM + "(" + _kbc.thanhtien + "), ";
                    _kbc.NguoiSD = Pub_sNguoiSD;
                    _kbc.MaMay = Pub_sMaMay;
                    sttvt = sttvt + _kbc.STT + ",";
                }
                else if (_kbc.DaTTTT == 0 && _LoaiPhieu != 2 && _kbc.SLMua != "0" && _kbc.SLMua != "")
                {
                    //c
                    _kbc.DaTTTT = _LoaiPhieu;
                    if (txtTongHD.Text != "")
                    {
                        _kbc.SoSoHD = txtKyhieu.Text;
                        _kbc.SoHD = txtsohd.Text;
                    }
                    _kbc.NoiTTTT = _NoiTT;
                    _kbc.DATT = _LoaiPhieu;
                    _kbc.NguoiTTTT = Pub_sNguoiSD;
                    _kbc.NguoiTT = Pub_sNguoiSD;
                    if (HTC.ShareVariables.pub_spC == "PS")
                        lydothu = lydothu + _kbc.TenTM + ", ";
                    else
                        lydothu = lydothu + _kbc.TenTM + "(" + _kbc.thanhtien + "), ";
                    _kbc.NguoiSD = Pub_sNguoiSD;
                    _kbc.MaMay = Pub_sMaMay;
                    sttvt = sttvt + _kbc.STT + ",";
                }
                else if (_kbc.SLTra != "0" && _kbc.SLTra != "" && _kbc.Ngaytra != "")
                {
                    _kbc.SoSoHDTra = _kbc.SoSoHD;
                    _kbc.SoHDTra = _kbc.SoHD;

                }
                else if (sosohdtra == _kbc.SoSoHD && sohdtra == _kbc.SoHD)
                {
                    if (HTC.ShareVariables.pub_spC == "PS")
                        lydothu = lydothu + _kbc.TenTM + "(ĐTT), ";
                    else
                        lydothu = lydothu + _kbc.TenTM + "(" + _kbc.thanhtien + "), ";
                }
            }
        if (_ThongtinBN.KhamBenh.KhamBenh_MauList != null)
            foreach (KhamBenh_Mau _kbc in _ThongtinBN.KhamBenh.KhamBenh_MauList)
            {
                if (_kbc.DaTTBH == 0 && (_LoaiPhieu == 2 || (_LoaiPhieu == 1 && _Duyet == 1 && dtNgayQT.Text != "" && txtTongHD.Text == "")) && _kbc.SLMua != "0" && _kbc.SLMua != "")
                {
                    //c
                    _kbc.DaTTBH = _LoaiPhieu;
                    if (txtTongHD.Text != "")
                    {
                        _kbc.SoSoHD = txtKyhieu.Text;
                        _kbc.SoHD = txtsohd.Text;
                    }
                    _kbc.NoiTTBH = _NoiTT;
                    _kbc.DATT = _LoaiPhieu;
                    if (HTC.ShareVariables.pub_spC == "PS")
                        lydothu = lydothu + (_kbc.TenTM == "" ? _kbc.TenTM : _kbc.TenTM) + ", ";
                    else
                        lydothu = lydothu + _kbc.TenTM + "(" + _kbc.thanhtien + "), ";
                    _kbc.NguoiSD = Pub_sNguoiSD;
                    _kbc.MaMay = Pub_sMaMay;
                }
                else if (_kbc.DaTTTT == 0 && _LoaiPhieu != 2 && _kbc.SLMua != "0" && _kbc.SLMua != "")
                {
                    //c
                    _kbc.DaTTTT = _LoaiPhieu;
                    if (txtTongHD.Text != "")
                    {
                        _kbc.SoSoHD = txtKyhieu.Text;
                        _kbc.SoHD = txtsohd.Text;
                    }
                    _kbc.NoiTTTT = _NoiTT;
                    _kbc.DATT = _LoaiPhieu;
                    if (HTC.ShareVariables.pub_spC == "PS")
                        lydothu = lydothu + _kbc.TenTM + ", ";
                    else
                        lydothu = lydothu + _kbc.TenTM + "(" + _kbc.thanhtien + "), ";
                    _kbc.NguoiSD = Pub_sNguoiSD;
                    _kbc.MaMay = Pub_sMaMay;

                }
                else if (_kbc.SLTra != "0" && _kbc.SLTra != "" && _kbc.Ngaytra != "")
                {
                    _kbc.SoSoHDTra = _kbc.SoSoHD;
                    _kbc.SoHDTra = _kbc.SoHD;

                }
                else if (sosohdtra == _kbc.SoSoHD && sohdtra == _kbc.SoHD)
                {
                    if (HTC.ShareVariables.pub_spC == "PS")
                        lydothu = lydothu + _kbc.TenTM + "(ĐTT), ";
                    else
                        lydothu = lydothu + _kbc.TenTM + "(" + _kbc.thanhtien + "), ";
                }
            }
        if (_ThongtinBN.KhamBenh.KhamBenh_HoaChatList != null)
            foreach (KhamBenh_HoaChat _kbc in _ThongtinBN.KhamBenh.KhamBenh_HoaChatList)
            {
                if (_kbc.DaTTBH == 0 && (_LoaiPhieu == 2 || (_LoaiPhieu == 1 && _Duyet == 1 && dtNgayQT.Text != "" && txtTongHD.Text == "")) && _kbc.SLMua != "0" && _kbc.SLMua != "")
                {
                    //c
                    _kbc.DaTTBH = _LoaiPhieu;
                    if (txtTongHD.Text != "")
                    {
                        _kbc.SoSoHD = txtKyhieu.Text;
                        _kbc.SoHD = txtsohd.Text;
                    }
                    _kbc.NoiTTBH = _NoiTT;
                    _kbc.DATT = _LoaiPhieu;
                    if (HTC.ShareVariables.pub_spC == "PS")
                        lydothu = lydothu + (_kbc.TenTM == "" ? _kbc.TenTM : _kbc.TenTM) + ", ";
                    else
                        lydothu = lydothu + _kbc.TenTM + "(" + _kbc.thanhtien + "), ";
                    _kbc.NguoiSD = Pub_sNguoiSD;
                    _kbc.MaMay = Pub_sMaMay;
                }
                else if (_kbc.DaTTTT == 0 && _LoaiPhieu != 2 && _kbc.SLMua != "0" && _kbc.SLMua != "")
                {
                    //c
                    _kbc.DaTTTT = _LoaiPhieu;
                    if (txtTongHD.Text != "")
                    {
                        _kbc.SoSoHD = txtKyhieu.Text;
                        _kbc.SoHD = txtsohd.Text;
                    }
                    _kbc.NoiTTTT = _NoiTT;
                    if (HTC.ShareVariables.pub_spC == "PS")
                        lydothu = lydothu + _kbc.TenTM + ", ";
                    else
                        lydothu = lydothu + _kbc.TenTM + "(" + _kbc.thanhtien + "), ";
                    _kbc.NguoiSD = Pub_sNguoiSD;
                    _kbc.MaMay = Pub_sMaMay;

                }
                else if (_kbc.SLTra != "0" && _kbc.SLTra != "" && _kbc.Ngaytra != "")
                {
                    _kbc.SoSoHDTra = _kbc.SoSoHD;
                    _kbc.SoHDTra = _kbc.SoHD;

                }
                else if (sosohdtra == _kbc.SoSoHD && sohdtra == _kbc.SoHD)
                {
                    if (HTC.ShareVariables.pub_spC == "PS")
                        lydothu = lydothu + _kbc.TenTM + "(ĐTT), ";
                    else
                        lydothu = lydothu + _kbc.TenTM + "(" + _kbc.thanhtien + "), ";
                }
            }

        // nhap cac so hoa don
        if (txtTongHD.Text != "" && txtTongHD.Text != "0")
        {
            if (txtKyhieu.Text == "")
            {
                //if (HTC.ShareVariables.pub_spC == "HU")
                //    txtKyhieu.Text = DateTime.Now.ToString("MM/dd/yyyy").Substring(0, 2) + DateTime.Now.Year.ToString().Substring(2, 2) + "-" + Pub_sQuay + "-";
                //else
                if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                    txtKyhieu.Text = DateTime.Now.Year.ToString().Substring(2, 2) + "-" + Pub_sQuay + "-" + Pub_sNguoiSD;
                else
                    txtKyhieu.Text = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + Pub_sQuay + "/" + Pub_sNguoiSD;
            }
            KhamBenh_HoaDon _KhamBenh_HoaDon = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Contains(txtKyhieu.Text, txtsohd.Text);

            if (_KhamBenh_HoaDon == null && (decimal.Parse(txtTongHD.Text) - tongthuTN - tongthuDY > 0))
            {
                _KhamBenh_HoaDon = KhamBenh_HoaDon.NewKhamBenh_HoaDon();
                _KhamBenh_HoaDon.MaBN = _ThongtinBN.MaBN;
                _KhamBenh_HoaDon.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                if (tongthuTN != 0 && tongthuDY != 0)
                    _KhamBenh_HoaDon.TongThu = decimal.Parse(txtTongHD.Text) - tongthuTN - tongthuDY;
                else if (tongthuTN != 0)
                    _KhamBenh_HoaDon.TongThu = decimal.Parse(txtTongHD.Text) - tongthuTN;
                else if (tongthuDY != 0)
                    _KhamBenh_HoaDon.TongThu = decimal.Parse(txtTongHD.Text) - tongthuDY;
                else
                    _KhamBenh_HoaDon.TongThu = decimal.Parse(txtTongHD.Text);
                _KhamBenh_HoaDon.NoiTT = _NoiTT;
                _KhamBenh_HoaDon.loai = _LoaiPhieu;
                _KhamBenh_HoaDon.SoSoHD = txtKyhieu.Text;
                _KhamBenh_HoaDon.SoHD = txtsohd.Text;
                _KhamBenh_HoaDon.NgayDK = dtNgayDK.Text;
                if (_LoaiPhieu == 2)
                {
                    _KhamBenh_HoaDon.TongTienBH = _ThongtinBN.KhamBenh.TongThuHoaDon - _ThongtinBN.KhamBenh.TongTienTTCTT;
                    if (_ThongtinBN.KhamBenh.KhamBenh_HoaDonList.FirstOrDefault(X => X.TongChi != 0) != null)
                    {
                        _KhamBenh_HoaDon.TongBHTra = _ThongtinBN.KhamBenh.TongTienBH - _ThongtinBN.KhamBenh.TongThuHoaDon - _ThongtinBN.KhamBenh.TongTienTTCTT;
                        _KhamBenh_HoaDon.TongBH = _ThongtinBN.KhamBenh.TongTienBH;
                    }
                    else
                    {
                        _KhamBenh_HoaDon.TongBHTra = _ThongtinBN.KhamBenh.TongTienCTT - _ThongtinBN.KhamBenh.TongThuHoaDon - _ThongtinBN.KhamBenh.TongTienTTCTT;
                        _KhamBenh_HoaDon.TongBH = _ThongtinBN.KhamBenh.TongTienCTT - _ThongtinBN.KhamBenh.TongTienTTCTT;
                    }

                }
                _KhamBenh_HoaDon.MaMay = Pub_sMaMay;
                _KhamBenh_HoaDon.NguoiLap = Pub_sNguoiSD;
                _KhamBenh_HoaDon.NguoiSD = Pub_sNguoiSD;
                _KhamBenh_HoaDon.NguoiThu = Pub_sNguoiSD;
                _KhamBenh_HoaDon.NgayThu = DateTime.Now.ToString();
                _KhamBenh_HoaDon.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 1) == "0" ? cboDoiTuong.SelectedValue : "00001");
                _KhamBenh_HoaDon.LydoChi = (sttdv != "" ? "sttdv in (" + sttdv.Substring(0, sttdv.Length - 1) + ")" : "");
                if (sttthuoc != "")
                {
                    if (_KhamBenh_HoaDon.LydoChi != "")
                        _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttthuoc != "" ? "sttthuoc in (" + sttthuoc.Substring(0, sttthuoc.Length - 1) + ")" : "");
                    else
                        _KhamBenh_HoaDon.LydoChi = (sttthuoc != "" ? "sttthuoc in (" + sttthuoc.Substring(0, sttthuoc.Length - 1) + ")" : "");
                }
                if (sttvt != "")
                {
                    if (_KhamBenh_HoaDon.LydoChi != "")
                        _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttvt != "" ? "sttvt in (" + sttvt.Substring(0, sttvt.Length - 1) + ")" : "");
                    else
                        _KhamBenh_HoaDon.LydoChi = (sttvt != "" ? "sttvt in (" + sttvt.Substring(0, sttvt.Length - 1) + ")" : "");
                }
                if (sttdy != "")
                {
                    if (_KhamBenh_HoaDon.LydoChi != "")
                        _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttdy != "" ? "sttdy in (" + sttdy.Substring(0, sttdy.Length - 1) + ")" : "");
                    else
                        _KhamBenh_HoaDon.LydoChi = (sttdy != "" ? "sttdy in (" + sttdy.Substring(0, sttdy.Length - 1) + ")" : "");
                }
                if (_LoaiPhieu == 2 && cboDoiTuong.SelectedValue.Substring(0, 1) != "0" & _KhamBenh_HoaDon.IsNew == true && HTC.ShareVariables.pub_spC != "YH")
                    _KhamBenh_HoaDon.LydoThu = lydothu + "-" + txtSoThe.Text;
                else if (_LoaiPhieu == 2 && cboDoiTuong.SelectedValue.Substring(0, 1) != "0" & _KhamBenh_HoaDon.IsNew == true)
                    _KhamBenh_HoaDon.LydoThu = _KhamBenh_HoaDon.LydoThu + "-" + txtSoThe.Text;
                else
                    _KhamBenh_HoaDon.LydoThu = lydothu;
                if (HTC.ShareVariables.pub_spC == "PS" && (_NoiTT == "091" || _NoiTT == "092") && _LoaiPhieu == 7 && cboLoaiBN.SelectedValue == "10")
                {
                    _KhamBenh_HoaDon.Sophieu = 1;
                }
                _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.AssignTo(_KhamBenh_HoaDon);
                if (tongthuTN > 0)
                {
                    _KhamBenh_HoaDon = KhamBenh_HoaDon.NewKhamBenh_HoaDon();
                    _KhamBenh_HoaDon.MaBN = _ThongtinBN.MaBN;
                    _KhamBenh_HoaDon.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                    _KhamBenh_HoaDon.TongThu = tongthuTN;
                    _KhamBenh_HoaDon.LydoThu = lydothuTN;
                    _KhamBenh_HoaDon.loai = _LoaiPhieu;

                    _KhamBenh_HoaDon.NoiTT = _NoiTT;
                    _KhamBenh_HoaDon.SoSoHD = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NgayDK = dtNgayDK.Text;
                    _KhamBenh_HoaDon.MaMay = Pub_sMaMay;
                    _KhamBenh_HoaDon.NguoiLap = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NguoiSD = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NguoiThu = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NgayThu = DateTime.Now.ToString();
                    _KhamBenh_HoaDon.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : ((_NoiTT == "085" || _NoiTT == "090") ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003")));
                    _KhamBenh_HoaDon.Sophieu = 1;
                    _KhamBenh_HoaDon.LydoChi = (sttdv != "" ? "sttdv in (" + sttdv.Substring(0, sttdv.Length - 1) + ")" : "");
                    if (_KhamBenh_HoaDon.LydoChi != "")
                        _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttthuoc != "" ? "sttthuoc in (" + sttthuoc.Substring(0, sttthuoc.Length - 1) + ")" : "");
                    else
                        _KhamBenh_HoaDon.LydoChi = (sttthuoc != "" ? "sttthuoc in (" + sttthuoc.Substring(0, sttthuoc.Length - 1) + ")" : "");
                    if (_KhamBenh_HoaDon.LydoChi != "")
                        _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttvt != "" ? "sttvt in (" + sttvt.Substring(0, sttvt.Length - 1) + ")" : "");
                    else
                        _KhamBenh_HoaDon.LydoChi = (sttvt != "" ? "sttvt in (" + sttvt.Substring(0, sttvt.Length - 1) + ")" : "");

                    _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.AssignTo(_KhamBenh_HoaDon);

                }
                if (tongthuDY > 0)
                {
                    _KhamBenh_HoaDon = KhamBenh_HoaDon.NewKhamBenh_HoaDon();
                    _KhamBenh_HoaDon.MaBN = _ThongtinBN.MaBN;
                    _KhamBenh_HoaDon.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                    _KhamBenh_HoaDon.TongThu = tongthuDY;
                    _KhamBenh_HoaDon.LydoThu = lydothuDY;
                    _KhamBenh_HoaDon.loai = _LoaiPhieu;
                    _KhamBenh_HoaDon.NoiTT = _NoiTT;
                    if (HTC.ShareVariables.pub_spC == "QN")
                        _KhamBenh_HoaDon.SoSoHD = txtKyhieu.Text;
                    else
                        _KhamBenh_HoaDon.SoSoHD = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NgayDK = dtNgayDK.Text;
                    _KhamBenh_HoaDon.MaMay = Pub_sMaMay;
                    _KhamBenh_HoaDon.NguoiLap = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NguoiSD = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NguoiThu = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NgayThu = DateTime.Now.ToString();
                    _KhamBenh_HoaDon.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : ((_NoiTT == "085" || _NoiTT == "090") ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003")));
                    _KhamBenh_HoaDon.Sophieu = 0;
                    if (sttdy != "")
                    {
                        if (_KhamBenh_HoaDon.LydoChi != "")
                            _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttdy != "" ? "sttdy in (" + sttdy.Substring(0, sttdy.Length - 1) + ")" : "");
                        else
                            _KhamBenh_HoaDon.LydoChi = (sttdy != "" ? "sttdy in (" + sttdy.Substring(0, sttdy.Length - 1) + ")" : "");
                    }
                    _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.AssignTo(_KhamBenh_HoaDon);

                }
            }
            else if (_KhamBenh_HoaDon != null && (decimal.Parse(txtTongHD.Text) - tongthuTN - tongthuDY > 0))
            {
                _KhamBenh_HoaDon.MaBN = _ThongtinBN.MaBN;
                _KhamBenh_HoaDon.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                _KhamBenh_HoaDon.NoiTT = _NoiTT;
                _KhamBenh_HoaDon.NgayDK = dtNgayDK.Text;
                _KhamBenh_HoaDon.loai = _LoaiPhieu;
                _KhamBenh_HoaDon.LydoChi = (sttdv != "" ? "sttdv in (" + sttdv.Substring(0, sttdv.Length - 1) + ")" : "");
                if (sttthuoc != "")
                {
                    if (_KhamBenh_HoaDon.LydoChi != "")
                        _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttthuoc != "" ? "sttthuoc in (" + sttthuoc.Substring(0, sttthuoc.Length - 1) + ")" : "");
                    else
                        _KhamBenh_HoaDon.LydoChi = (sttthuoc != "" ? "sttthuoc in (" + sttthuoc.Substring(0, sttthuoc.Length - 1) + ")" : "");
                }
                if (sttvt != "")
                {
                    if (_KhamBenh_HoaDon.LydoChi != "")
                        _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttvt != "" ? "sttvt in (" + sttvt.Substring(0, sttvt.Length - 1) + ")" : "");
                    else
                        _KhamBenh_HoaDon.LydoChi = (sttvt != "" ? "sttvt in (" + sttvt.Substring(0, sttvt.Length - 1) + ")" : "");
                }
                if (sttdy != "")
                {
                    if (_KhamBenh_HoaDon.LydoChi != "")
                        _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttdy != "" ? "sttdy in (" + sttdy.Substring(0, sttdy.Length - 1) + ")" : "");
                    else
                        _KhamBenh_HoaDon.LydoChi = (sttdy != "" ? "sttdy in (" + sttdy.Substring(0, sttdy.Length - 1) + ")" : "");
                }
                if (_LoaiPhieu == 2)
                {
                    _KhamBenh_HoaDon.TongTienBH = _ThongtinBN.KhamBenh.TongThuHoaDon - _ThongtinBN.KhamBenh.TongTienTTCTT;
                    if (_ThongtinBN.KhamBenh.KhamBenh_HoaDonList.FirstOrDefault(X => X.TongChi != 0) != null)
                    {
                        _KhamBenh_HoaDon.TongBHTra = _ThongtinBN.KhamBenh.TongTienBH - _ThongtinBN.KhamBenh.TongThuHoaDon - _ThongtinBN.KhamBenh.TongTienTTCTT;
                        _KhamBenh_HoaDon.TongBH = _ThongtinBN.KhamBenh.TongTienBH;
                    }
                    else
                    {
                        _KhamBenh_HoaDon.TongBHTra = _ThongtinBN.KhamBenh.TongTienCTT - _ThongtinBN.KhamBenh.TongThuHoaDon - _ThongtinBN.KhamBenh.TongTienTTCTT;
                        _KhamBenh_HoaDon.TongBH = _ThongtinBN.KhamBenh.TongTienCTT - _ThongtinBN.KhamBenh.TongTienTTCTT;
                    }

                }
                _KhamBenh_HoaDon.MaMay = Pub_sMaMay;
                _KhamBenh_HoaDon.NguoiLap = Pub_sNguoiSD;
                _KhamBenh_HoaDon.NguoiSD = Pub_sNguoiSD;
                _KhamBenh_HoaDon.NguoiThu = Pub_sNguoiSD;
                _KhamBenh_HoaDon.SoSoHD = txtKyhieu.Text;
                _KhamBenh_HoaDon.SoHD = txtsohd.Text;
                if (tongthuTN != 0 && tongthuDY != 0)
                    _KhamBenh_HoaDon.TongThu = decimal.Parse(txtTongHD.Text) - tongthuTN - tongthuDY;
                else if (tongthuTN != 0)
                    _KhamBenh_HoaDon.TongThu = decimal.Parse(txtTongHD.Text) - tongthuTN;
                else if (tongthuDY != 0)
                    _KhamBenh_HoaDon.TongThu = decimal.Parse(txtTongHD.Text) - tongthuDY;
                else
                    _KhamBenh_HoaDon.TongThu = decimal.Parse(txtTongHD.Text);

                _KhamBenh_HoaDon.NgayThu = DateTime.Now.ToString();
                _KhamBenh_HoaDon.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : "00001");
                if (_LoaiPhieu == 2)
                    _KhamBenh_HoaDon.LydoThu = "Thu tiền BH phải trả";
                else
                    _KhamBenh_HoaDon.LydoThu = lydothu;
                if (_KhamBenh_HoaDon.IsNew == true && HTC.ShareVariables.pub_spC == "PS" && (_NoiTT == "091" || _NoiTT == "092") && _LoaiPhieu == 7 && cboLoaiBN.SelectedValue == "10")
                {
                    _KhamBenh_HoaDon.Sophieu = 1;
                }
                _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.UpdatedTo(_KhamBenh_HoaDon);
                if (tongthuTN > 0)
                {
                    // hoa don tu nguyen 
                    _KhamBenh_HoaDon = KhamBenh_HoaDon.NewKhamBenh_HoaDon();
                    _KhamBenh_HoaDon.MaBN = _ThongtinBN.MaBN;
                    _KhamBenh_HoaDon.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                    _KhamBenh_HoaDon.TongThu = tongthuTN;
                    _KhamBenh_HoaDon.LydoThu = lydothuTN;
                    _KhamBenh_HoaDon.loai = _LoaiPhieu;
                    _KhamBenh_HoaDon.NoiTT = _NoiTT;
                    if (HTC.ShareVariables.pub_spC == "QN")
                        _KhamBenh_HoaDon.SoSoHD = txtKyhieu.Text;
                    else
                        _KhamBenh_HoaDon.SoSoHD = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NgayDK = dtNgayDK.Text;
                    _KhamBenh_HoaDon.MaMay = Pub_sMaMay;
                    _KhamBenh_HoaDon.NguoiLap = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NgayThu = DateTime.Now.ToString();
                    _KhamBenh_HoaDon.NguoiSD = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NguoiThu = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : ((_NoiTT == "085" || _NoiTT == "090") ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003")));
                    _KhamBenh_HoaDon.Sophieu = 1;
                    _KhamBenh_HoaDon.LydoChi = (sttdv != "" ? "sttdv in (" + sttdv.Substring(0, sttdv.Length - 1) + ")" : "");
                    if (_KhamBenh_HoaDon.LydoChi != "")
                        _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttthuoc != "" ? "sttthuoc in (" + sttthuoc.Substring(0, sttthuoc.Length - 1) + ")" : "");
                    else
                        _KhamBenh_HoaDon.LydoChi = (sttthuoc != "" ? "sttthuoc in (" + sttthuoc.Substring(0, sttthuoc.Length - 1) + ")" : "");
                    if (_KhamBenh_HoaDon.LydoChi != "")
                        _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttvt != "" ? "sttvt in (" + sttvt.Substring(0, sttvt.Length - 1) + ")" : "");
                    else
                        _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.AssignTo(_KhamBenh_HoaDon);

                }
                if (tongthuDY > 0)
                {
                    // hoa don tu nguyen 
                    _KhamBenh_HoaDon = KhamBenh_HoaDon.NewKhamBenh_HoaDon();
                    _KhamBenh_HoaDon.MaBN = _ThongtinBN.MaBN;
                    _KhamBenh_HoaDon.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                    _KhamBenh_HoaDon.TongThu = tongthuDY;
                    _KhamBenh_HoaDon.LydoThu = lydothuDY;
                    _KhamBenh_HoaDon.loai = _LoaiPhieu;
                    _KhamBenh_HoaDon.NoiTT = _NoiTT;
                    if (HTC.ShareVariables.pub_spC == "QN")
                        _KhamBenh_HoaDon.SoSoHD = txtKyhieu.Text;
                    else
                        _KhamBenh_HoaDon.SoSoHD = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NgayDK = dtNgayDK.Text;
                    _KhamBenh_HoaDon.MaMay = Pub_sMaMay;
                    _KhamBenh_HoaDon.NguoiLap = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NgayThu = DateTime.Now.ToString();
                    _KhamBenh_HoaDon.NguoiSD = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NguoiThu = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : ((_NoiTT == "085" || _NoiTT == "090") ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003")));
                    _KhamBenh_HoaDon.Sophieu = 0;

                    if (sttdy != "")
                    {
                        if (_KhamBenh_HoaDon.LydoChi != "")
                            _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttdy != "" ? "sttdy in (" + sttdy.Substring(0, sttdy.Length - 1) + ")" : "");
                        else
                            _KhamBenh_HoaDon.LydoChi = (sttdy != "" ? "sttdy in (" + sttdy.Substring(0, sttdy.Length - 1) + ")" : "");
                    }
                    _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.AssignTo(_KhamBenh_HoaDon);

                }
            }
            else if ((decimal.Parse(txtTongHD.Text) - tongthuTN - tongthuDY == 0) && (tongthuTN != 0 || tongthuDY != 0))
            {
                if (_KhamBenh_HoaDon != null)
                {
                    _KhamBenh_HoaDon.MaBN = _ThongtinBN.MaBN;
                    _KhamBenh_HoaDon.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                    _KhamBenh_HoaDon.NoiTT = _NoiTT;
                    _KhamBenh_HoaDon.loai = _LoaiPhieu;
                    _KhamBenh_HoaDon.NgayDK = dtNgayDK.Text;
                    _KhamBenh_HoaDon.MaMay = Pub_sMaMay;
                    _KhamBenh_HoaDon.NguoiLap = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NguoiSD = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NguoiThu = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NgayThu = DateTime.Now.ToString();
                    _KhamBenh_HoaDon.SoSoHD = txtKyhieu.Text;
                    _KhamBenh_HoaDon.SoHD = txtsohd.Text;
                    if (tongthuTN != 0 && tongthuDY != 0)
                        _KhamBenh_HoaDon.TongThu = decimal.Parse(txtTongHD.Text) - tongthuTN - tongthuDY;
                    else if (tongthuTN != 0)
                        _KhamBenh_HoaDon.TongThu = decimal.Parse(txtTongHD.Text) - tongthuTN;
                    else if (tongthuDY != 0)
                        _KhamBenh_HoaDon.TongThu = decimal.Parse(txtTongHD.Text) - tongthuDY;
                    else
                        _KhamBenh_HoaDon.TongThu = decimal.Parse(txtTongHD.Text);
                    _KhamBenh_HoaDon.NgayThu = DateTime.Now.ToString();
                    _KhamBenh_HoaDon.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : "00001");
                    if (_LoaiPhieu == 2)
                        _KhamBenh_HoaDon.LydoThu = "Thu tiền BH phải trả";
                    else
                        _KhamBenh_HoaDon.LydoThu = lydothu;
                    _KhamBenh_HoaDon.LydoChi = (sttdv != "" ? "sttdv in (" + sttdv.Substring(0, sttdv.Length - 1) + ")" : "");
                    if (sttthuoc != "")
                    {
                        if (_KhamBenh_HoaDon.LydoChi != "")
                            _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttthuoc != "" ? "sttthuoc in (" + sttthuoc.Substring(0, sttthuoc.Length - 1) + ")" : "");
                        else
                            _KhamBenh_HoaDon.LydoChi = (sttthuoc != "" ? "sttthuoc in (" + sttthuoc.Substring(0, sttthuoc.Length - 1) + ")" : "");
                    }
                    if (sttvt != "")
                    {
                        if (_KhamBenh_HoaDon.LydoChi != "")
                            _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttvt != "" ? "sttvt in (" + sttvt.Substring(0, sttvt.Length - 1) + ")" : "");
                        else
                            _KhamBenh_HoaDon.LydoChi = (sttvt != "" ? "sttvt in (" + sttvt.Substring(0, sttvt.Length - 1) + ")" : "");
                    }
                    if (sttdy != "")
                    {
                        if (_KhamBenh_HoaDon.LydoChi != "")
                            _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttdy != "" ? "sttdy in (" + sttdy.Substring(0, sttdy.Length - 1) + ")" : "");
                        else
                            _KhamBenh_HoaDon.LydoChi = (sttdy != "" ? "sttdy in (" + sttdy.Substring(0, sttdy.Length - 1) + ")" : "");
                    }

                    if (_KhamBenh_HoaDon.IsNew == true && HTC.ShareVariables.pub_spC == "PS" && (_NoiTT == "091" || _NoiTT == "092") && _LoaiPhieu == 7 && cboLoaiBN.SelectedValue == "10")
                    {
                        _KhamBenh_HoaDon.Sophieu = 1;
                    }
                    _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.UpdatedTo(_KhamBenh_HoaDon);
                }
                if (tongthuTN > 0)
                {
                    // hoa don tu nguyen 
                    _KhamBenh_HoaDon = KhamBenh_HoaDon.NewKhamBenh_HoaDon();
                    _KhamBenh_HoaDon.MaBN = _ThongtinBN.MaBN;
                    _KhamBenh_HoaDon.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                    _KhamBenh_HoaDon.TongThu = tongthuTN;
                    _KhamBenh_HoaDon.LydoThu = lydothuTN;
                    _KhamBenh_HoaDon.loai = _LoaiPhieu;
                    _KhamBenh_HoaDon.NoiTT = _NoiTT;
                    if (HTC.ShareVariables.pub_spC == "QN")
                        _KhamBenh_HoaDon.SoSoHD = txtKyhieu.Text;
                    else
                        _KhamBenh_HoaDon.SoSoHD = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NgayDK = dtNgayDK.Text;
                    _KhamBenh_HoaDon.MaMay = Pub_sMaMay;
                    _KhamBenh_HoaDon.NguoiLap = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NguoiSD = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NgayThu = DateTime.Now.ToString();
                    _KhamBenh_HoaDon.NguoiThu = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : ((_NoiTT == "085" || _NoiTT == "090") ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003")));
                    _KhamBenh_HoaDon.Sophieu = 1;
                    _KhamBenh_HoaDon.LydoChi = (sttdv != "" ? "sttdv in (" + sttdv.Substring(0, sttdv.Length - 1) + ")" : "");
                    if (_KhamBenh_HoaDon.LydoChi != "")
                        _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttthuoc != "" ? "sttthuoc in (" + sttthuoc.Substring(0, sttthuoc.Length - 1) + ")" : "");
                    else
                        _KhamBenh_HoaDon.LydoChi = (sttthuoc != "" ? "sttthuoc in (" + sttthuoc.Substring(0, sttthuoc.Length - 1) + ")" : "");
                    if (_KhamBenh_HoaDon.LydoChi != "")
                        _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttvt != "" ? "sttvt in (" + sttvt.Substring(0, sttvt.Length - 1) + ")" : "");
                    else
                        _KhamBenh_HoaDon.LydoChi = (sttvt != "" ? "sttvt in (" + sttvt.Substring(0, sttvt.Length - 1) + ")" : "");

                    _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.AssignTo(_KhamBenh_HoaDon);

                }
                if (tongthuDY > 0)
                {
                    // hoa don tu nguyen 
                    _KhamBenh_HoaDon = KhamBenh_HoaDon.NewKhamBenh_HoaDon();
                    _KhamBenh_HoaDon.MaBN = _ThongtinBN.MaBN;
                    _KhamBenh_HoaDon.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                    _KhamBenh_HoaDon.TongThu = tongthuDY;
                    _KhamBenh_HoaDon.LydoThu = lydothuDY;
                    _KhamBenh_HoaDon.loai = _LoaiPhieu;
                    _KhamBenh_HoaDon.NoiTT = _NoiTT;
                    if (HTC.ShareVariables.pub_spC == "QN")
                        _KhamBenh_HoaDon.SoSoHD = txtKyhieu.Text;
                    else
                        _KhamBenh_HoaDon.SoSoHD = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NgayDK = dtNgayDK.Text;
                    _KhamBenh_HoaDon.MaMay = Pub_sMaMay;
                    _KhamBenh_HoaDon.NguoiLap = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NguoiSD = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.NgayThu = DateTime.Now.ToString();
                    _KhamBenh_HoaDon.NguoiThu = Pub_sNguoiSD;
                    _KhamBenh_HoaDon.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 2) == "0" ? cboDoiTuong.SelectedValue : ((_NoiTT == "085" || _NoiTT == "090") ? "00001" : ((_NoiTT == "087" || _NoiTT == "095") ? "00002" : "00003")));
                    _KhamBenh_HoaDon.Sophieu = 0;
                    _KhamBenh_HoaDon.LydoChi = (sttdv != "" ? "sttdv in (" + sttdv.Substring(0, sttdv.Length - 1) + ")" : "");
                    _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.AssignTo(_KhamBenh_HoaDon);

                }
            }
            else if (_KhamBenh_HoaDon == null && (0 - decimal.Parse(txtTongHD.Text) > 0))
            {
                foreach (KhamBenh_HoaDon _kbhdtra in _ThongtinBN.KhamBenh.KhamBenh_HoaDonList)
                    if (_kbhdtra.TongThu == _kbhdtra.TongChi && _kbhdtra.TongThu != 0 && _kbhdtra.NgayLap == "")
                    {
                        _KhamBenh_HoaDon = KhamBenh_HoaDon.NewKhamBenh_HoaDon();
                        _KhamBenh_HoaDon.MaBN = _ThongtinBN.MaBN;
                        _KhamBenh_HoaDon.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                        _KhamBenh_HoaDon.Sophieu = _kbhdtra.Sophieu;
                        _KhamBenh_HoaDon.TongThu = _kbhdtra.TongThu + decimal.Parse(txtTongHD.Text);
                        _KhamBenh_HoaDon.NoiTT = _NoiTT;
                        _KhamBenh_HoaDon.loai = _LoaiPhieu;
                        _KhamBenh_HoaDon.SoSoHD = txtKyhieu.Text;
                        _KhamBenh_HoaDon.SoHD = txtsohd.Text;
                        _KhamBenh_HoaDon.NgayDK = dtNgayDK.Text;
                        if (_LoaiPhieu == 2)
                        {
                            _KhamBenh_HoaDon.TongTienBH = _ThongtinBN.KhamBenh.TongThuHoaDon;
                            if (_ThongtinBN.KhamBenh.KhamBenh_HoaDonList.FirstOrDefault(X => X.TongChi != 0) != null)
                            {
                                _KhamBenh_HoaDon.TongBHTra = _ThongtinBN.KhamBenh.TongTienBH - _ThongtinBN.KhamBenh.TongThuHoaDon;
                                _KhamBenh_HoaDon.TongBH = _ThongtinBN.KhamBenh.TongTienBH;
                            }
                            else
                            {
                                _KhamBenh_HoaDon.TongBHTra = _ThongtinBN.KhamBenh.TongTienCTT - _ThongtinBN.KhamBenh.TongThuHoaDon;
                                _KhamBenh_HoaDon.TongBH = _ThongtinBN.KhamBenh.TongTienCTT;
                            }

                        }
                        _KhamBenh_HoaDon.LydoChi = (sttdv != "" ? "sttdv in (" + sttdv.Substring(0, sttdv.Length - 1) + ")" : "");
                        if (sttthuoc != "")
                        {
                            if (_KhamBenh_HoaDon.LydoChi != "")
                                _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttthuoc != "" ? "sttthuoc in (" + sttthuoc.Substring(0, sttthuoc.Length - 1) + ")" : "");
                            else
                                _KhamBenh_HoaDon.LydoChi = (sttthuoc != "" ? "sttthuoc in (" + sttthuoc.Substring(0, sttthuoc.Length - 1) + ")" : "");
                        }
                        if (sttvt != "")
                        {
                            if (_KhamBenh_HoaDon.LydoChi != "")
                                _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttvt != "" ? "sttvt in (" + sttvt.Substring(0, sttvt.Length - 1) + ")" : "");
                            else
                                _KhamBenh_HoaDon.LydoChi = (sttvt != "" ? "sttvt in (" + sttvt.Substring(0, sttvt.Length - 1) + ")" : "");
                        }
                        if (sttdy != "")
                        {
                            if (_KhamBenh_HoaDon.LydoChi != "")
                                _KhamBenh_HoaDon.LydoChi = _KhamBenh_HoaDon.LydoChi + ";" + (sttdy != "" ? "sttdy in (" + sttdy.Substring(0, sttdy.Length - 1) + ")" : "");
                            else
                                _KhamBenh_HoaDon.LydoChi = (sttdy != "" ? "sttdy in (" + sttdy.Substring(0, sttdy.Length - 1) + ")" : "");
                        }
                        _KhamBenh_HoaDon.MaMay = Pub_sMaMay;
                        _KhamBenh_HoaDon.NguoiLap = Pub_sNguoiSD;
                        _KhamBenh_HoaDon.NguoiSD = Pub_sNguoiSD;
                        _KhamBenh_HoaDon.NgayThu = DateTime.Now.ToString();
                        _KhamBenh_HoaDon.NguoiThu = Pub_sNguoiSD;
                        _KhamBenh_HoaDon.MaDT = _LoaiPhieu == 2 ? cboDoiTuong.SelectedValue : ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && cboDoiTuong.SelectedValue.Substring(0, 1) == "0" ? cboDoiTuong.SelectedValue : "00001");
                        if (_LoaiPhieu == 2 && cboDoiTuong.SelectedValue.Substring(0, 1) != "0" & _KhamBenh_HoaDon.IsNew == true && HTC.ShareVariables.pub_spC != "PS")
                            _KhamBenh_HoaDon.LydoThu = _KhamBenh_HoaDon.LydoThu + "-" + txtSoThe.Text;
                        else if (_LoaiPhieu == 2 && cboDoiTuong.SelectedValue.Substring(0, 1) != "0" & _KhamBenh_HoaDon.IsNew == true)
                            _KhamBenh_HoaDon.LydoThu = _KhamBenh_HoaDon.LydoThu;
                        else
                            _KhamBenh_HoaDon.LydoThu = lydothu;
                        if (_KhamBenh_HoaDon.IsNew == true && HTC.ShareVariables.pub_spC == "PS" && (_NoiTT == "091" || _NoiTT == "092") && _LoaiPhieu == 7 && cboLoaiBN.SelectedValue == "10")
                        {
                            _KhamBenh_HoaDon.Sophieu = 1;
                        }
                        _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.AssignTo(_KhamBenh_HoaDon);
                        break;
                    }
            }
            if (HTC.ShareVariables.pub_spC == "YH" && ((_NoiTT == "085" && _LoaiPhieu == 2) || _NoiTT == "091" || _NoiTT == "092" || _NoiTT == "093" || _NoiTT == "095") && _KhamBenh_HoaDon != null)
            {
                _KhamBenh_HoaDon.Sophieu = 1;
                _KhamBenh_HoaDon.loai = _LoaiPhieu;
            }

            // cac hoa don huy
            foreach (KhamBenh_HoaDon _hd in _ThongtinBN.KhamBenh.KhamBenh_HoaDonList)
            {

                if (_hd.TongChi == _hd.TongThu && _hd.TongThu != 0 && _hd.NguoiChi == "")
                {
                    _hd.NgayChi = DateTime.Now.ToString("dd/MM/yyyy");
                    _hd.NguoiChi = Pub_sNguoiSD;
                    _hd.MaMay = Pub_sMaMay;
                    _hd.NguoiSD = Pub_sNguoiSD;
                    _hd.NoiCT = _NoiTT;
                    _hd.LydoChi = txtGhiChuHD.Text + " " + _hd.LydoChi;
                    KhamBenh_HoaDon _hdmoi = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.FirstOrDefault(X => X.NgayLap == "");
                    if (_ThongtinBN.KhamBenh.KhamBenh_C_List != null)
                        foreach (KhamBenh_C _kbc in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                        {
                            if (_kbc.SoHD == _hd.SoHD && _kbc.SoSoHD == _hd.SoSoHD)
                            {
                                //c
                                _kbc.SoSoHDTra = _kbc.SoSoHD;
                                _kbc.SoHDTra = _kbc.SoHD;
                                _kbc.SoSoHD = _hdmoi == null ? "" : _hdmoi.SoSoHD;
                                _kbc.SoHD = _hdmoi == null ? "" : _hdmoi.SoHD;

                            }

                        }
                    if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList != null)
                        foreach (KhamBenh_ThuocSD _kbc in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
                        {
                            if (_kbc.SoHD == _hd.SoHD && _kbc.SoSoHD == _hd.SoSoHD)
                            {
                                //c
                                _kbc.SoSoHDTra = _kbc.SoSoHD;
                                _kbc.SoHDTra = _kbc.SoHD;
                                _kbc.SoSoHD = _hdmoi == null ? "" : _hdmoi.SoSoHD;
                                _kbc.SoHD = _hdmoi == null ? "" : _hdmoi.SoHD;

                            }

                        }
                    if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList != null)
                        foreach (KhamBenh_ThuocSD_DY _kbc in _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList)
                        {
                            if (_kbc.SoHD == _hd.SoHD && _kbc.SoSoHD == _hd.SoSoHD)
                            {
                                //c
                                _kbc.SoSoHDTra = _kbc.SoSoHD;
                                _kbc.SoHDTra = _kbc.SoHD;
                                _kbc.SoSoHD = _hdmoi == null ? "" : _hdmoi.SoSoHD;
                                _kbc.SoHD = _hdmoi == null ? "" : _hdmoi.SoHD;

                            }

                        }
                    if (_ThongtinBN.KhamBenh.KhamBenh_VTTHList != null)
                        foreach (KhamBenh_VTTH _kbc in _ThongtinBN.KhamBenh.KhamBenh_VTTHList)
                        {
                            if (_kbc.SoHD == _hd.SoHD && _kbc.SoSoHD == _hd.SoSoHD)
                            {
                                //c
                                _kbc.SoSoHDTra = _kbc.SoSoHD;
                                _kbc.SoHDTra = _kbc.SoHD;
                                _kbc.SoSoHD = _hdmoi == null ? "" : _hdmoi.SoSoHD;
                                _kbc.SoHD = _hdmoi == null ? "" : _hdmoi.SoHD;

                            }

                        }
                    if (_ThongtinBN.KhamBenh.KhamBenh_HoaChatList != null)
                        foreach (KhamBenh_HoaChat _kbc in _ThongtinBN.KhamBenh.KhamBenh_HoaChatList)
                        {
                            if (_kbc.SoHD == _hd.SoHD && _kbc.SoSoHD == _hd.SoSoHD)
                            {
                                //c
                                _kbc.SoSoHDTra = _kbc.SoSoHD;
                                _kbc.SoHDTra = _kbc.SoHD;
                                _kbc.SoSoHD = _hdmoi == null ? "" : _hdmoi.SoSoHD;
                                _kbc.SoHD = _hdmoi == null ? "" : _hdmoi.SoHD;

                            }


                        }
                    if (_ThongtinBN.KhamBenh.KhamBenh_MauList != null)
                        foreach (KhamBenh_Mau _kbc in _ThongtinBN.KhamBenh.KhamBenh_MauList)
                        {
                            if (_kbc.SoHD == _hd.SoHD && _kbc.SoSoHD == _hd.SoSoHD)
                            {
                                //c
                                _kbc.SoSoHDTra = _kbc.SoSoHD;
                                _kbc.SoHDTra = _kbc.SoHD;
                                _kbc.SoSoHD = _hdmoi == null ? "" : _hdmoi.SoSoHD;
                                _kbc.SoHD = _hdmoi == null ? "" : _hdmoi.SoHD;
                            }
                        }
                }
                if (_hd.LydoThu != "")
                {
                    if (_hd.IsNew == true || _hd.IsDirty == true)
                    {
                        _hd.ApplyEdit();
                        _hd.Save();
                        if (_hd.Sophieu == 0)
                        {
                            if (_hd.SoHD != "" && _hd.TongThu != 0)
                            {
                                pub_sKyHieuHD = txtKyhieu.Text;
                                if (txtsohd.Text != "")
                                {
                                    if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                                        pub_sSoHD = Addx(txtsohd.Text, txtsohd.Text.Length, "0");

                                    else

                                        pub_sSoHD = Addx(txtsohd.Text, txtsohd.Text.Length, "");
                                    if (HTC.ShareVariables.pub_spC != "PS" || _LoaiPhieu == 7)
                                        txtsohd.Text = pub_sSoHD;
                                    else
                                        txtsohd.Text = "";
                                }
                            }
                        }
                    }
                }
            }
        }
        else
        {
            if (sosohdtra != "")
            {
                KhamBenh_HoaDon _KhamBenh_HoaDon = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Contains(sosohdtra, sohdtra);
                if (_KhamBenh_HoaDon != null)
                    if (_KhamBenh_HoaDon.TongChiCu == 0 && _KhamBenh_HoaDon.TongThu == _KhamBenh_HoaDon.TongChi && _KhamBenh_HoaDon.TongChi != 0)
                    {
                        _KhamBenh_HoaDon.LydoChi = txtGhiChuHD.Text + " " + _KhamBenh_HoaDon.LydoChi;
                        _KhamBenh_HoaDon.ApplyEdit();
                        _KhamBenh_HoaDon.Save();
                    }
            }
        }
        // cap nhat lai so hoa don cua phieu in thu

        KhamBenh_HoaDon _kbhd = KhamBenh_HoaDon.NewKhamBenh_HoaDon();

        foreach (KhamBenh_HoaDon kbhd in _ThongtinBN.KhamBenh.KhamBenh_HoaDonList)
        {
            if ((kbhd.Sophieu == 1 && kbhd.NgayLap == ""))
            {
                _kbhd = kbhd;
                break;
            }
        }

        if (_kbhd.SoHD != "")
        {
            if (HTC.ShareVariables.pub_spC == "YH" && ((_NoiTT == "085" && _LoaiPhieu == 2) || _NoiTT == "091" || _NoiTT == "092" || _NoiTT == "093" || _NoiTT == "087" || _NoiTT == "095") || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
            {
                pub_sSoHD = _kbhd.SoHD;
                if (_kbhd.SoHD != "" && _kbhd.TongThu != 0)
                {
                    pub_sKyHieuHD = txtKyhieu.Text;
                    txtsohd.Text = _kbhd.SoHD;
                    if (txtsohd.Text != "")
                    {
                        if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                            pub_sSoHD = Addx(txtsohd.Text, txtsohd.Text.Length, "0");
                        else
                            pub_sSoHD = Addx(txtsohd.Text, txtsohd.Text.Length, "");
                        txtsohd.Text = pub_sSoHD;
                    }
                }
            }
            foreach (KhamBenh_C _kbc in _ThongtinBN.KhamBenh.KhamBenh_C_List)
            {
                if (_kbc.SoHD == "")
                {
                    //c

                    _kbc.SoSoHD = _kbhd.SoSoHD;
                    _kbc.SoHD = _kbhd.SoHD;

                }

            }
            foreach (KhamBenh_ThuocSD _kbc in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
            {
                if (_kbc.SoHD == "")
                {
                    //c

                    _kbc.SoSoHD = _kbhd.SoSoHD;
                    _kbc.SoHD = _kbhd.SoHD;

                }
            }
            foreach (KhamBenh_ThuocSD_DY _kbc in _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList)
            {
                if (_kbc.SoHD == "")
                {
                    //c

                    _kbc.SoSoHD = _kbhd.SoSoHD;
                    _kbc.SoHD = _kbhd.SoHD;

                }
            }
            foreach (KhamBenh_VTTH _kbc in _ThongtinBN.KhamBenh.KhamBenh_VTTHList)
            {
                if (_kbc.SoHD == "")
                {
                    //c

                    _kbc.SoSoHD = _kbhd.SoSoHD;
                    _kbc.SoHD = _kbhd.SoHD;

                }
            }
            foreach (KhamBenh_Mau _kbc in _ThongtinBN.KhamBenh.KhamBenh_MauList)
            {
                if (_kbc.SoHD == "")
                {
                    //c

                    _kbc.SoSoHD = _kbhd.SoSoHD;
                    _kbc.SoHD = _kbhd.SoHD;

                }
            }
            foreach (KhamBenh_HoaChat _kbc in _ThongtinBN.KhamBenh.KhamBenh_HoaChatList)
            {
                if (_kbc.SoHD == "")
                {
                    //c

                    _kbc.SoSoHD = _kbhd.SoSoHD;
                    _kbc.SoHD = _kbhd.SoHD;

                }

            }

        }
        return true;
    }

    private bool UpdatePhieuBanDY(string sosohd = "", string sohd = "")
    {
        string MaThuoc = string.Empty;

        try
        {
            HTC.Business.Duoc.PhieuXuat _PhieuXuat = HTC.Business.Duoc.PhieuXuat.NewPhieuXuat();
            _PhieuXuat.NoiXuat = (_NoiTT == "091") ? HTC.ShareVariables.pub_sMaKX091 : HTC.ShareVariables.pub_sMaKX092;
            _PhieuXuat.NgayXuat = DateTime.Now.ToString("dd/MM/yyyy");
            _PhieuXuat.NgayXuatTT = DateTime.Now.ToString("dd/MM/yyyy");
            _PhieuXuat.NVXuat = Pub_sNguoiSD;
            _PhieuXuat.DaPhat = true;
            _PhieuXuat.DaDuyet = true;
            _PhieuXuat.LoaiPhieu = 3;
            _PhieuXuat.GhiChu = _ThongtinBN.MaBN + "-" + txthoten.Text;
            _PhieuXuat.NguoiSD = Pub_sNguoiSD;
            _PhieuXuat.NguoiLap = Pub_sNguoiSD;
            HTC.Business.Duoc.NhapTra _NHAPTRA = HTC.Business.Duoc.NhapTra.NewNhapTra();
            _NHAPTRA.NgayNhapTT = DateTime.Now.ToString("dd/MM/yyyy");
            _NHAPTRA.NgayNhap = DateTime.Now.ToString("dd/MM/yyyy");
            _NHAPTRA.Noinhap = (_NoiTT == "091") ? HTC.ShareVariables.pub_sMaKX091 : HTC.ShareVariables.pub_sMaKX092;
            _NHAPTRA.NoiXuat = "011";
            _NHAPTRA.DaDuyet = true;
            _NHAPTRA.DaPhat = 1;
            _NHAPTRA.BNTra = true;
            _NHAPTRA.Loaiphieu = 2;
            _NHAPTRA.NguoiSD = Pub_sNguoiSD;
            _NHAPTRA.NguoiLap = Pub_sNguoiSD;
            _PhieuXuat.GhiChu = "ĐY" + _ThongtinBN.MaBN + "-" + txthoten.Text;
            int idtra = 0;
            foreach (KhamBenh_ThuocSD_DY kb in _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList)
            {
                if (kb.Huy == false)
                {
                    foreach (KhamBenh_ThuocSD_DY_C kbc in kb.KhamBenh_ThuocSD_DY_Cs)
                    {
                        if (kbc.Huy == false)
                        {
                            if (kb.DaTTTT == 0)
                            {
                                HTC.Business.Duoc.PhieuXuat_C _PhieuXuat_C = _PhieuXuat.PhieuXuatCs.NewTo();
                                _PhieuXuat_C.MaThuoc = kbc.Mathuoc;

                                _PhieuXuat_C.SoLuong = (decimal.Parse(kbc.SLMua) * decimal.Parse(kb.SLMua)).ToString();
                                _PhieuXuat_C.SoLuongYC = (decimal.Parse(kbc.SLMua) * decimal.Parse(kb.SLMua)).ToString();
                                _PhieuXuat_C.GiaBan = decimal.Parse(kbc.DongiaTT);
                                _PhieuXuat_C.NguoiSD = Pub_sNguoiSD;

                                _PhieuXuat.PhieuXuatCs.AssignTo(_PhieuXuat_C);
                            }
                            else if (kb.DaTTTT != 0 && kb.SLTra != 0)
                            {
                                if ((kb.SLTraCu == "0" || kb.SLTraCu == "") && kb.SLTra > 0)
                                {
                                    HTC.Business.Duoc.NhapTra_C _NHAPTRA_C = _NHAPTRA.NhapTraCs.NewTo();
                                    _NHAPTRA_C.MaThuoc = kbc.Mathuoc;
                                    _NHAPTRA_C.NguoiSD = Pub_sNguoiSD;
                                    _NHAPTRA_C.Soluong = (decimal.Parse(kbc.SLMua) * kb.SLTra).ToString();
                                    _NHAPTRA_C.SoLuongYC = (decimal.Parse(kbc.SLMua) * kb.SLTra).ToString();
                                    _NHAPTRA_C.GiaBan = decimal.Parse(kbc.DongiaTT);
                                    _NHAPTRA.NhapTraCs.AssignTo(_NHAPTRA_C);
                                    idtra = kbc.STT;
                                }
                            }
                            else if (kb.DaTTTT != 0 && kb.SoHD == sohd && kb.SoSoHD == sosohd)
                            {
                                if ((kb.SLTraCu == "0" || kb.SLTraCu == ""))
                                {
                                    HTC.Business.Duoc.NhapTra_C _NHAPTRA_C = _NHAPTRA.NhapTraCs.NewTo();
                                    _NHAPTRA_C.MaThuoc = kbc.Mathuoc;
                                    _NHAPTRA_C.NguoiSD = Pub_sNguoiSD;
                                    _NHAPTRA_C.Soluong = (decimal.Parse(kbc.SLMua) * decimal.Parse(kb.SLMua)).ToString();
                                    _NHAPTRA_C.SoLuongYC = (decimal.Parse(kbc.SLMua) * decimal.Parse(kb.SLMua)).ToString();
                                    _NHAPTRA_C.GiaBan = decimal.Parse(kbc.DongiaTT);
                                    _NHAPTRA.NhapTraCs.AssignTo(_NHAPTRA_C);
                                    idtra = kbc.STT;
                                }
                            }
                        }
                    }
                }
            }
            if (_PhieuXuat.PhieuXuatCs.Count > 0)
            {
                HTC.Business.Duoc.PhieuXuat tmp = (HTC.Business.Duoc.PhieuXuat)_PhieuXuat.Clone() as HTC.Business.Duoc.PhieuXuat;
                tmp.ApplyEdit();
                _PhieuXuat = tmp.Save();
                _MaPXDY = _PhieuXuat.MaPX;
            }

            if (_NHAPTRA.NhapTraCs.Count > 0 && sohd != "")
            {
                if (HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "QN")
                {
                    string sql = "exec sp_TraThuocBN 1,N'" + _ThongtinBN.KhamBenh.MaSoKham + "','" + sohd + "','" + Pub_sNguoiSD + "','" + Pub_sMaMay + "'";


                    HTC.Business.DataProvider.Instance().ExcSQL(sql);

                }
                else
                {
                    HTC.Business.Duoc.NhapTra tmp = (HTC.Business.Duoc.NhapTra)_NHAPTRA.Clone() as HTC.Business.Duoc.NhapTra;
                    tmp.ApplyEdit();
                    _NHAPTRA = tmp.Save();
                }
            }
        }
        catch (Exception ex)
        {

            //throw;
        }

        return true;
    }
    private bool UpdatePhieuBan(string sosohd = "", string sohd = "")
    {
        string MaThuoc = string.Empty;

        try
        {
            HTC.Business.Duoc.PhieuXuat _PhieuXuat = HTC.Business.Duoc.PhieuXuat.NewPhieuXuat();
            _PhieuXuat.NoiXuat = (_NoiTT == "091") ? HTC.ShareVariables.pub_sMaKX091 : HTC.ShareVariables.pub_sMaKX092;
            _PhieuXuat.NgayXuat = DateTime.Now.ToString("dd/MM/yyyy");
            _PhieuXuat.NgayXuatTT = DateTime.Now.ToString("dd/MM/yyyy");
            _PhieuXuat.NVXuat = Pub_sNguoiSD;
            _PhieuXuat.DaPhat = true;
            _PhieuXuat.DaDuyet = true;
            _PhieuXuat.LoaiPhieu = 3;
            _PhieuXuat.GhiChu = _ThongtinBN.MaBN + "-" + txthoten.Text;
            _PhieuXuat.NguoiSD = Pub_sNguoiSD;
            _PhieuXuat.NguoiLap = Pub_sNguoiSD;
            HTC.Business.Duoc.NhapTra _NHAPTRA = HTC.Business.Duoc.NhapTra.NewNhapTra();
            _NHAPTRA.NgayNhapTT = DateTime.Now.ToString("dd/MM/yyyy");
            _NHAPTRA.NgayNhap = DateTime.Now.ToString("dd/MM/yyyy");
            _NHAPTRA.Noinhap = (_NoiTT == "091") ? HTC.ShareVariables.pub_sMaKX091 : HTC.ShareVariables.pub_sMaKX092;
            _NHAPTRA.NoiXuat = "011";
            _NHAPTRA.DaDuyet = true;
            _NHAPTRA.DaPhat = 1;
            _NHAPTRA.BNTra = true;
            _NHAPTRA.Loaiphieu = 2;
            _NHAPTRA.NguoiSD = Pub_sNguoiSD;
            _NHAPTRA.NguoiLap = Pub_sNguoiSD;
            _PhieuXuat.GhiChu = _ThongtinBN.MaBN + "-" + txthoten.Text;
            int idtra = 0;
            foreach (KhamBenh_ThuocSD obj1 in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
            {
                if (obj1.Huy == false)
                {
                    if (obj1.DaTTTT == 0)
                    {
                        HTC.Business.Duoc.PhieuXuat_C _PhieuXuat_C = _PhieuXuat.PhieuXuatCs.NewTo();
                        _PhieuXuat_C.MaThuoc = obj1.Mathuoc;

                        _PhieuXuat_C.SoLuong = obj1.SLMua;
                        _PhieuXuat_C.SoLuongYC = obj1.SLMua;
                        _PhieuXuat_C.GiaBan = decimal.Parse(obj1.DongiaTT);
                        _PhieuXuat_C.NguoiSD = Pub_sNguoiSD;

                        _PhieuXuat.PhieuXuatCs.AssignTo(_PhieuXuat_C);
                    }
                    else if (obj1.DaTTTT != 0 && obj1.SLTra != "" && obj1.SLTra != "0")
                    {
                        if ((obj1.SLTraCu == "0" || obj1.SLTraCu == "") && decimal.Parse(obj1.SLTra) > 0)
                        {
                            HTC.Business.Duoc.NhapTra_C _NHAPTRA_C = _NHAPTRA.NhapTraCs.NewTo();
                            _NHAPTRA_C.MaThuoc = obj1.Mathuoc;
                            _NHAPTRA_C.NguoiSD = Pub_sNguoiSD;
                            _NHAPTRA_C.Soluong = obj1.SLTra;
                            _NHAPTRA_C.SoLuongYC = obj1.SLTra;
                            _NHAPTRA_C.GiaBan = decimal.Parse(obj1.DongiaTT);
                            _NHAPTRA.NhapTraCs.AssignTo(_NHAPTRA_C);
                            idtra = obj1.STT;
                        }
                    }
                    else if (obj1.DaTTTT != 0 && obj1.SoHD == sohd && obj1.SoSoHD == sosohd)
                    {
                        if ((obj1.SLTraCu == "0" || obj1.SLTraCu == ""))
                        {
                            HTC.Business.Duoc.NhapTra_C _NHAPTRA_C = _NHAPTRA.NhapTraCs.NewTo();
                            _NHAPTRA_C.MaThuoc = obj1.Mathuoc;
                            _NHAPTRA_C.NguoiSD = Pub_sNguoiSD;
                            _NHAPTRA_C.Soluong = obj1.SLMua;
                            _NHAPTRA_C.SoLuongYC = obj1.SLMua;
                            _NHAPTRA_C.GiaBan = decimal.Parse(obj1.DongiaTT);
                            idtra = obj1.STT;
                            _NHAPTRA.NhapTraCs.AssignTo(_NHAPTRA_C);
                        }
                    }
                }
            }

            if (_PhieuXuat.PhieuXuatCs.Count > 0)
            {
                HTC.Business.Duoc.PhieuXuat tmp = (HTC.Business.Duoc.PhieuXuat)_PhieuXuat.Clone() as HTC.Business.Duoc.PhieuXuat;
                tmp.ApplyEdit();
                _PhieuXuat = tmp.Save();
                _MaPX = _PhieuXuat.MaPX;
                _PhieuXuat = HTC.Business.Duoc.PhieuXuat.GetPhieuXuat(_MaPX, 3, true, true);
                GuiDonThuoc(_PhieuXuat);
            }

            if (_NHAPTRA.NhapTraCs.Count > 0 && sohd != "")
            {
                if (HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "QN")
                {
                    string sql = "exec sp_TraThuocBN 2,N'" + _ThongtinBN.KhamBenh.MaSoKham + "','" + sohd + "','" + Pub_sNguoiSD + "','" + Pub_sMaMay + "'";

                    HTC.Business.DataProvider.Instance().ExcSQL(sql);

                }
                else
                {

                    HTC.Business.Duoc.NhapTra tmp = (HTC.Business.Duoc.NhapTra)_NHAPTRA.Clone() as HTC.Business.Duoc.NhapTra;
                    tmp.ApplyEdit();
                    _NHAPTRA = tmp.Save();
                }
            }
        }
        catch (Exception ex)
        {

            //throw;
        }

        return true;
    }
    private bool UpdateDataThuoc(GridEditableItem editedItem, FormAction action)
    {
        string MaThuoc = string.Empty;

        try
        {

            if (_MaKhoa == "")
                if (cboBSTayY.SelectedValue != "" && cboBSTayY.SelectedValue != null)
                    _MaKhoa = DMNhanVien.GetDMNhanVien(cboBSTayY.SelectedValue).MaKhoa;
            KhamBenh_ThuocSD _KhamBenh_ThuocSD;
            if (action == FormAction.INSERT)
                _KhamBenh_ThuocSD = KhamBenh_ThuocSD.NewKhamBenh_ThuocSD();
            else
            {
                int STT = int.Parse(editedItem.GetDataKeyValue("STT").ToString());

                _KhamBenh_ThuocSD = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.FirstOrDefault(X => X.STT == STT);
            }
            if (action != FormAction.DELETE)
            {
                _KhamBenh_ThuocSD.MaSoKham = _MaSoKham;
                _KhamBenh_ThuocSD.Makhoa = _MaKhoa;
                _KhamBenh_ThuocSD.MaBN = _MaBN;


                //if (!CheckFormData()) return false;
                //else
                {
                    if (editedItem["SLMua"].FindControl("tbSoLuong") == null)
                        return false;
                    string soLuong = ((RadNumericTextBox)editedItem["SLMua"].FindControl("tbSoLuong")).Text;
                    string lieuDung = ((TextBox)editedItem["LieuDung"].Controls[0]).Text;
                    string cachDung = ((TextBox)editedItem["CachDung"].Controls[0]).Text;
                    Boolean tinhtien = ((CheckBox)editedItem["TinhTien"].Controls[0]).Checked;

                    if (soLuong == "" || soLuong == null || soLuong == "0")
                    {
                        ShowMessage("Chưa nhập số lượng");
                        ((RadNumericTextBox)editedItem["SLMua"].FindControl("tbSoLuong")).Focus();
                        return false;
                    };
                    if (decimal.Parse(soLuong) < 0)
                    {
                        ShowMessage("Số lượng định dạng sai");
                        ((RadNumericTextBox)editedItem["SLMua"].FindControl("tbSoLuong")).Focus();

                        return false;
                    };

                    if (action != FormAction.DELETE)
                    {
                        _KhamBenh_ThuocSD.NgayDK = _ThongtinBN.KhamBenh.NgayDK;
                        if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
                        {
                            _KhamBenh_ThuocSD.BSChiDinh = cboNhanVien.SelectedValue;
                            _KhamBenh_ThuocSD.tenbschidinh = cboNhanVien.Text;

                        }
                        _KhamBenh_ThuocSD.LieuDung = lieuDung;
                        _KhamBenh_ThuocSD.CachDung = cachDung;

                        _KhamBenh_ThuocSD.NguoiSD = Pub_sNguoiSD;




                        ////   =============================================
                        if (action != FormAction.INSERT)
                        {
                            _KhamBenh_ThuocSD.SLKeDon = (decimal.Parse(soLuong)).ToString();
                            _KhamBenh_ThuocSD.SLMua = _KhamBenh_ThuocSD.SLKeDon;
                            _KhamBenh_ThuocSD.SoLuongD = (decimal.Parse(soLuong) * _KhamBenh_ThuocSD.QuyDoi).ToString();
                        }
                        else if (action == FormAction.INSERT)
                        {
                            RadComboBox cboThuoc = editedItem["MaThuoc"].FindControl("cboThuoc") as RadComboBox;
                            if (cboThuoc != null)
                            {
                                MaThuoc = cboThuoc.SelectedValue;
                            }
                            if (MaThuoc == "")
                            {
                                ShowMessage("Chưa nhập tên thuốc");
                                cboThuoc.Focus();
                                return false;
                            };
                            DMThuoc_TonKhoList list = DMThuoc_TonKhoList.FindDMThuocTonKhoMa((_NoiTT == "091" ? HTC.ShareVariables.pub_sMaKX091 : HTC.ShareVariables.pub_sMaKX092), DateTime.Now, MaThuoc);


                            if (list == null)
                                return false;
                            DMThuoc_TonKho _DMThuocKhoa = list.FirstOrDefault(X => X.MaThuoc == MaThuoc);
                            if (_DMThuocKhoa == null)
                                return false;
                            _KhamBenh_ThuocSD.QuyDoi = _DMThuocKhoa.quydoi;
                            _KhamBenh_ThuocSD.SLKeDon = (_DMThuocKhoa.quydoi * decimal.Parse(soLuong)).ToString();
                            _KhamBenh_ThuocSD.SLMua = _KhamBenh_ThuocSD.SLKeDon;
                            _KhamBenh_ThuocSD.SoLuongD = soLuong;
                            _KhamBenh_ThuocSD.BHTinhtien = false;
                            _KhamBenh_ThuocSD.CK = "0";
                            _KhamBenh_ThuocSD.DonGiaBH = (string.IsNullOrEmpty(_DMThuocKhoa.DonGiaTT.ToString()) ? "0" : _DMThuocKhoa.DonGiaTT.ToString());
                            _KhamBenh_ThuocSD.DongiaTT = (string.IsNullOrEmpty(_DMThuocKhoa.DonGiaTT.ToString()) ? "0" : _DMThuocKhoa.DonGiaTT.ToString());
                            _KhamBenh_ThuocSD.NoiTTBH = _NoiTT;
                            _KhamBenh_ThuocSD.NoiTTTT = _NoiTT;
                            _KhamBenh_ThuocSD.MaDT = cboDoiTuong.SelectedValue;

                            if (cboBSTayY.SelectedValue != "" && cboBSTayY.SelectedValue != "0" && _KhamBenh_ThuocSD.BSChiDinh == "")
                            {
                                _KhamBenh_ThuocSD.BSChiDinh = cboBSTayY.SelectedValue;
                                _KhamBenh_ThuocSD.tenbschidinh = cboBSTayY.Text;

                            }


                            _KhamBenh_ThuocSD.Mathuoc = MaThuoc;

                            _KhamBenh_ThuocSD.TenTM = _DMThuocKhoa.TenTM;
                            _KhamBenh_ThuocSD.tendvt = _DMThuocKhoa.TenDVT;

                            _KhamBenh_ThuocSD.TONCK = _DMThuocKhoa.TonCK;
                            _KhamBenh_ThuocSD.TONCKDT = _DMThuocKhoa.TonCKDT;
                            _KhamBenh_ThuocSD.sovisa = _DMThuocKhoa.sovisa;
                            _KhamBenh_ThuocSD.matduong = _DMThuocKhoa.matduong;
                            _KhamBenh_ThuocSD.hamluong = _DMThuocKhoa.hamluong;
                            _KhamBenh_ThuocSD.duongdung = _DMThuocKhoa.duongdung;
                        }
                        _KhamBenh_ThuocSD.Tinhtien = tinhtien;
                        ///''''''''''''''''''''''
                        _KhamBenh_ThuocSD.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                        _KhamBenh_ThuocSD.MaBN = _ThongtinBN.MaBN;
                        if (((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7) || (_NoiTT == "085" && _LoaiPhieu == 7 && HTC.ShareVariables.pub_spC == "QN")) || _NoiTT == "094" || _NoiTT == "093") || _NoiTT == "091" || _NoiTT == "092" || _NoiTT == "093")
                            _KhamBenh_ThuocSD.Tinhtien = true;
                        if (action == FormAction.INSERT)
                        {
                            if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count == 0)
                            {
                                _KhamBenh_ThuocSD.STT = 1;
                            }
                            else
                            {
                                _KhamBenh_ThuocSD.STT = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList[_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count - 1].STT + 1;
                            }
                        }
                    }
                }
            }
            if (action == FormAction.EDIT)
            {
                _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.UpdatedTo(_KhamBenh_ThuocSD);
                if (_KhamBenh_ThuocSD.DATT == 0)
                {
                    KhamBenh_GetsDichVu _KhamBenh_GetsDichVu;
                    if (_Order == 0)
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.OrderNumber == _KhamBenh_ThuocSD.STT);
                    else
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.OrderNumber == _Order);

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.UpdatedTo(_KhamBenh_ThuocSD, _KhamBenh_GetsDichVu);
                }
                else
                {
                    KhamBenh_GetsDichVu _KhamBenh_GetsDichVu;
                    if (_Order == 0)
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.FirstOrDefault(X => X.OrderNumber == _KhamBenh_ThuocSD.STT);
                    else
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.FirstOrDefault(X => X.OrderNumber == _Order);

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.UpdatedTo(_KhamBenh_ThuocSD, _KhamBenh_GetsDichVu);
                }
            }
            else if (action == FormAction.INSERT)
            {
                _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.AssignTo(_KhamBenh_ThuocSD, _ThongtinBN.KhamBenh);
                _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.NewTo(_KhamBenh_ThuocSD);

            }
            else if (action == FormAction.DELETE)
            {

                _KhamBenh_ThuocSD.NguoiHuy = Pub_sNguoiSD; _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.RemoveTo(_KhamBenh_ThuocSD, _ThongtinBN.KhamBenh);
                if (_KhamBenh_ThuocSD.DATT == 0)
                {

                    if (_Order == 0)
                        _Order = _KhamBenh_ThuocSD.STT;

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.RemoveTo(_Order);
                }
                else
                {
                    if (_Order == 0)
                        _Order = _KhamBenh_ThuocSD.STT;

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.RemoveTo(_Order);
                }
            }

            grdThuoc.EditIndexes.Clear();
            grdThuoc.MasterTableView.IsItemInserted = true;

            grdThuoc.MasterTableView.Rebind();
            grdThuoc.Rebind();
            _Order = 0;



        }
        catch (Exception ex)
        {
            ShowMessage("Không lưu được dữ liệu" + ex.Message); ;

            //throw;
        }

        return true;
    }

    private bool UpdateDataThuocDY(GridEditableItem editedItem, FormAction action, string grid = "")
    {
        string MaThuoc = string.Empty;

        try
        {
            if (_MaKhoa == "")
                if (cboBSDongY.SelectedValue != "" && cboBSDongY.SelectedValue != null)
                    _MaKhoa = DMNhanVien.GetDMNhanVien(cboBSDongY.SelectedValue).MaKhoa;
            KhamBenh_ThuocSD_DY_C _KhamBenh_ThuocSD_DY_C;
            KhamBenh_ThuocSD_DY_CList _KhamBenh_ThuocSD_DY_CList;
            _KhamBenh_ThuocSD_DY_CList = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
            if (_KhamBenh_ThuocSD_DY == null)
                _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
            if (_LoaiPhieu == 77 || _LoaiPhieu == 7)
            {
                _KhamBenh_ThuocSD_DY.MaDT = "00001";
                _KhamBenh_ThuocSD_DY.Tinhtien = true;
            }
            if (action == FormAction.INSERT)
                _KhamBenh_ThuocSD_DY_C = KhamBenh_ThuocSD_DY_C.NewKhamBenh_ThuocSD_DY_C();
            else
            {
                if (grid == "grdDanhSachDY")
                {
                    int STT = int.Parse(editedItem.GetDataKeyValue("STT").ToString());
                    _KhamBenh_ThuocSD_DY = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.FirstOrDefault(X => X.STT == STT);

                    _KhamBenh_ThuocSD_DY.SLMua = "0";
                    _KhamBenh_ThuocSD_DY.SLThang = "0";
                    _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.UpdatedTo(_KhamBenh_ThuocSD_DY, _ThongtinBN.KhamBenh);
                    _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();
                    _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
                    txtSLThang.Text = "0";
                    LoadDetails(false, CurrentTabIndex, false);
                    txtSLThang.Text = "0";
                    return true;
                }
                if (editedItem != null)
                {
                    int STT = int.Parse(editedItem.GetDataKeyValue("STTThuoc").ToString());

                    _KhamBenh_ThuocSD_DY_C = _KhamBenh_ThuocSD_DY_CList.FirstOrDefault(X => X.STTThuoc == STT);
                }
                else
                    _KhamBenh_ThuocSD_DY_C = KhamBenh_ThuocSD_DY_C.NewKhamBenh_ThuocSD_DY_C();
            }
            if (action != FormAction.DELETE)
            {
                _KhamBenh_ThuocSD_DY.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                _KhamBenh_ThuocSD_DY.MaKhoa = _MaKhoa;
                _KhamBenh_ThuocSD_DY.MaBN = _MaBN;
                if (((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093") || _NoiTT == "091" || _NoiTT == "092" || _NoiTT == "093")
                    _KhamBenh_ThuocSD_DY.Tinhtien = true;
                if (txtSLThang.Text == "")
                    txtSLThang.Text = "1";
                _KhamBenh_ThuocSD_DY.SLThang = txtSLThang.Text;
                _KhamBenh_ThuocSD_DY.SLMua = txtSLThang.Text;
                _KhamBenh_ThuocSD_DY.NgayDK = _ThongtinBN.KhamBenh.NgayDK;
                if (_KhamBenh_ThuocSD_DY.STT == 0)
                    _KhamBenh_ThuocSD_DY.STT = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count + 1;
                if (_KhamBenh_ThuocSD_DY.IsNew == true)
                {
                    _KhamBenh_ThuocSD_DY.NoiTTBH = _NoiTT;
                    _KhamBenh_ThuocSD_DY.NoiTTTT = _NoiTT;
                    _KhamBenh_ThuocSD_DY.MaDT = cboDoiTuong.SelectedValue;
                    _KhamBenh_ThuocSD_DY.MaKhoa = "011";
                }
                //if (!CheckFormData()) return false;
                //else
                {
                    if (action != FormAction.DELETE)
                    {
                        if (cboBSDongY.SelectedValue != "" && cboBSDongY.SelectedValue != "0" && _KhamBenh_ThuocSD_DY.BSChiDinh == "")
                        {
                            _KhamBenh_ThuocSD_DY.BSChiDinh = cboBSDongY.SelectedValue;
                            _KhamBenh_ThuocSD_DY.TenBSChidinh = cboBSDongY.Text;

                        }


                        ////   =============================================
                        if (editedItem != null)
                        {
                            string soLuong = ((RadNumericTextBox)editedItem["SoLuongD"].FindControl("tbSoLuong")).Text;
                            if (soLuong == "" || soLuong == null || soLuong == "0")
                            {
                                ShowMessage("Chưa nhập số lượng");
                                ((RadNumericTextBox)editedItem["SoLuongD"].FindControl("tbSoLuong")).Focus();
                                return false;
                            };
                            if (decimal.Parse(soLuong) < 0)
                            {
                                ShowMessage("Số lượng định dạng sai");
                                ((RadNumericTextBox)editedItem["SoLuongD"].FindControl("tbSoLuong")).Focus();

                                return false;
                            };
                            if (action != FormAction.INSERT)
                            {
                                _KhamBenh_ThuocSD_DY_C.SLKeDon = (_KhamBenh_ThuocSD_DY_C.QuyDoi * decimal.Parse(soLuong)).ToString();
                                _KhamBenh_ThuocSD_DY_C.SLMua = _KhamBenh_ThuocSD_DY_C.SLKeDon;
                                _KhamBenh_ThuocSD_DY_C.SoLuongD = soLuong;
                            }
                            else if (action == FormAction.INSERT)
                            {
                                RadComboBox cboThuoc = editedItem["MaThuoc"].FindControl("cboThuoc") as RadComboBox;
                                if (cboThuoc != null)
                                {
                                    MaThuoc = cboThuoc.SelectedValue;
                                }
                                DMThuocKhoaList list = null;

                                DMThuocKhoa _DMThuocKhoa = null;
                                if (MaThuoc == "")
                                {
                                    if (cboThuoc.Text != "")
                                    {
                                        list = DMThuocKhoaList.FindDMThuocKhoaTenDY("011", "00001", cboThuoc.Text, _LoaiPhieu);
                                        if (list.Count > 0)
                                        {
                                            _DMThuocKhoa = list[0];
                                            MaThuoc = _DMThuocKhoa.MaThuoc;
                                        }
                                        else
                                        {
                                            ShowMessage("Chưa nhập tên thuốc");
                                            cboThuoc.Focus();
                                            return false;
                                        }
                                    }
                                    else
                                    {
                                        ShowMessage("Chưa nhập tên thuốc");
                                        cboThuoc.Focus();
                                        return false;
                                    }
                                };
                                if (list == null)
                                    list = DMThuocKhoaList.FindDMThuocKhoaMaDY("011", "00001", MaThuoc, _LoaiPhieu);
                                if (list == null)
                                    return false;
                                if (_DMThuocKhoa == null)
                                    _DMThuocKhoa = list.FirstOrDefault(X => X.MaThuoc == MaThuoc);
                                if (_DMThuocKhoa == null)
                                    return false;
                                _KhamBenh_ThuocSD_DY_C.QuyDoi = _DMThuocKhoa.quydoi;
                                _KhamBenh_ThuocSD_DY_C.SLKeDon = (decimal.Parse(soLuong) / _DMThuocKhoa.quydoi).ToString();
                                _KhamBenh_ThuocSD_DY_C.SLMua = _KhamBenh_ThuocSD_DY_C.SLKeDon;
                                _KhamBenh_ThuocSD_DY_C.SoLuongD = soLuong;
                                _KhamBenh_ThuocSD_DY_C.STT = _KhamBenh_ThuocSD_DY.STT;
                                _KhamBenh_ThuocSD_DY_C.BHTinhtien = _DMThuocKhoa.DTBH;
                                _KhamBenh_ThuocSD_DY_C.QuyDoi = _DMThuocKhoa.quydoi;
                                _KhamBenh_ThuocSD_DY_C.DongiaBH = (decimal.Parse((string.IsNullOrEmpty(_DMThuocKhoa.DonGiaBH) ? "0" : _DMThuocKhoa.DonGiaBH))).ToString();
                                _KhamBenh_ThuocSD_DY_C.DongiaTT = (decimal.Parse((string.IsNullOrEmpty(_DMThuocKhoa.DonGiaTT) ? "0" : _DMThuocKhoa.DonGiaTT))).ToString();

                                if (_DMThuocKhoa.adphongmo > 1)
                                {
                                    // _KhamBenh_ThuocSD.TinhNgoai = True
                                    _KhamBenh_ThuocSD_DY_C.BHTinhtien = false;
                                }
                                else if (_DMThuocKhoa.adphongmo == 2)
                                {
                                    //_KhamBenh_ThuocSD.TinhNgoai = True
                                    _KhamBenh_ThuocSD_DY_C.BHTinhtien = false;
                                }
                                if (_DMThuocKhoa.ADChenhLech == true)
                                {
                                    _KhamBenh_ThuocSD_DY_C.GiaChenhLech = (string.IsNullOrEmpty(_DMThuocKhoa.GiaChenhlech) ? "0" : _DMThuocKhoa.GiaChenhlech);
                                }
                                else
                                {
                                    _KhamBenh_ThuocSD_DY_C.GiaChenhLech = "0";
                                }
                                _KhamBenh_ThuocSD_DY_C.Mathuoc = MaThuoc;

                                _KhamBenh_ThuocSD_DY_C.TenTM = _DMThuocKhoa.TenTM;
                                _KhamBenh_ThuocSD_DY_C.TenDVT = _DMThuocKhoa.TenDVT;
                                _KhamBenh_ThuocSD_DY_C.TinhNgoai = (_DMThuocKhoa.ApdungGoi == true ? false : true);


                                _KhamBenh_ThuocSD_DY_C.TONCK = decimal.Parse(_DMThuocKhoa.TonCK == "" ? "0" : _DMThuocKhoa.TonCK);
                                _KhamBenh_ThuocSD_DY_C.TONCKDT = decimal.Parse(_DMThuocKhoa.TonCKDT == "" ? "0" : _DMThuocKhoa.TonCKDT);
                                if (action == FormAction.INSERT)
                                {
                                    if (_KhamBenh_ThuocSD_DY_CList.Count == 0)
                                    {
                                        _KhamBenh_ThuocSD_DY_C.STTThuoc = 1;
                                    }
                                    else
                                    {
                                        _KhamBenh_ThuocSD_DY_C.STTThuoc = _KhamBenh_ThuocSD_DY_CList[_KhamBenh_ThuocSD_DY_CList.Count - 1].STTThuoc + 1;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            if (action == FormAction.EDIT)
            {
                if (editedItem != null)
                    _KhamBenh_ThuocSD_DY_CList.UpdatedTo(_KhamBenh_ThuocSD_DY_C);
                if (_KhamBenh_ThuocSD_DY.IsNew == false)
                {
                    _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.UpdatedTo(_KhamBenh_ThuocSD_DY);

                }
                if (_KhamBenh_ThuocSD_DY.IsNew == true)
                {
                    _KhamBenh_ThuocSD_DY.MaMay = Pub_sNguoiSD;
                    _KhamBenh_ThuocSD_DY.NguoiLap = Pub_sNguoiSD;
                }
                _KhamBenh_ThuocSD_DY.NguoiSD = Pub_sNguoiSD;
                _KhamBenh_ThuocSD_DY_C.NguoiSD = Pub_sNguoiSD;
                if (_KhamBenh_ThuocSD_DY.DATT == 0)
                {
                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.UpdatedTo(_KhamBenh_ThuocSD_DY);
                }
                else
                {
                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.UpdatedTo(_KhamBenh_ThuocSD_DY);
                }
                if (_KhamBenh_ThuocSD_DY.IsNew == false)
                {
                    tinhlaihd();
                }
            }
            else if (action == FormAction.INSERT)
            {
                if (_KhamBenh_ThuocSD_DY.IsNew == true)
                {
                    _KhamBenh_ThuocSD_DY.MaMay = Pub_sNguoiSD;
                    _KhamBenh_ThuocSD_DY.NguoiLap = Pub_sNguoiSD;
                }
                _KhamBenh_ThuocSD_DY.NguoiSD = Pub_sNguoiSD;
                _KhamBenh_ThuocSD_DY_C.NguoiSD = Pub_sNguoiSD;
                if (editedItem != null)
                    _KhamBenh_ThuocSD_DY_CList.AssignTo(_KhamBenh_ThuocSD_DY_C);
                _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.NewTo(_KhamBenh_ThuocSD_DY);


            }
            else if (action == FormAction.DELETE)
            {
                if (editedItem != null)
                    _KhamBenh_ThuocSD_DY_CList.RemoveTo(_KhamBenh_ThuocSD_DY_C);
                if (_KhamBenh_ThuocSD_DY.IsNew == true)
                {
                    _KhamBenh_ThuocSD_DY.MaMay = Pub_sNguoiSD;
                    _KhamBenh_ThuocSD_DY.NguoiLap = Pub_sNguoiSD;
                }
                _KhamBenh_ThuocSD_DY.NguoiSD = Pub_sNguoiSD;
                _KhamBenh_ThuocSD_DY_C.NguoiSD = Pub_sNguoiSD;
                if (_KhamBenh_ThuocSD_DY.DATT == 0)
                {

                    if (_Order == 0)
                        _Order = _KhamBenh_ThuocSD_DY_C.STT;

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.RemoveTo(_Order);
                }
                else
                {
                    if (_Order == 0)
                        _Order = _KhamBenh_ThuocSD_DY_C.STT;

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.RemoveTo(_Order);
                }
            }
            _KhamBenh_ThuocSD_DY.TinhLaiDon();

            txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
            txtTT.Value = (_KhamBenh_ThuocSD_DY.SLMua == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua)).ToString();

            _Order = 0;
            if (_KhamBenh_ThuocSD_DY_CList.Count == 1 && action == FormAction.INSERT)
                _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.NewTo(_KhamBenh_ThuocSD_DY);
            else if (_KhamBenh_ThuocSD_DY != null && _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs.Count > 0)
                _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.UpdatedTo(_KhamBenh_ThuocSD_DY);


            if (action == FormAction.EDIT)
            {
                grdThuocDY.MasterTableView.IsItemInserted = true;
                grdThuocDY.MasterTableView.InsertItem();
                grdThuocDY.DataBind();
            }

        }
        catch (Exception ex)
        {
            ShowMessage("Không lưu được dữ liệu" + ex.Message); ;

            //throw;
        }

        return true;
    }
    private bool UpdateDataCTT(GridEditableItem editedItem, FormAction action)
    {
        string MaDV = string.Empty;
        string loaidv = string.Empty;
        int stt = 0;
        int order = 0;

        try
        {

            if (action == FormAction.DELETE)
            {
                loaidv = editedItem.GetDataKeyValue("LoaiDV").ToString();
                stt = int.Parse(editedItem.GetDataKeyValue("SoTT").ToString());
                order = int.Parse(editedItem.GetDataKeyValue("OrderNumber").ToString());

                switch (loaidv)
                {
                    case "1":
                        {
                            KhamBenh_C _KhamBenh_C = _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(X => X.STT == stt);
                            if (_KhamBenh_C.MaHuongDT != "" && _LoaiPhieu != 1)
                            {
                                ShowMessage("Bệnh nhân đã thực hiện dịch vụ này");
                                return false;
                            }
                            if (_KhamBenh_C.MaDV.Substring(0, 2) == "TK" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN") && txtSoThe.Text != "" && _KhamBenh_C.DaTT == 0)
                            {
                                if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0 || _ThongtinBN.KhamBenh.TongThuocTY > 0)
                                {
                                    ShowMessage("Bệnh nhân đã chỉ định dịch vụ!Không thể xóa phiếu khám này");
                                    return false;
                                }
                            }
                            if (_LoaiPhieu == 1 || HTC.ShareVariables.pub_spC != "PS")
                            {
                                _KhamBenh_C.slmua = "0";
                                _KhamBenh_C.SoLuong = "0";
                                _KhamBenh_C.Huy = true;
                            }

                            _KhamBenh_C.NguoiHuy = Pub_sNguoiSD; _ThongtinBN.KhamBenh.KhamBenh_C_List.RemoveTo(_KhamBenh_C, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.RemoveTo(order);

                            break;
                        }
                    case "2":
                        {
                            KhamBenh_ThuocSD _KhamBenh_ThuocSD = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.FirstOrDefault(X => X.STT == stt);

                            _KhamBenh_ThuocSD.NguoiHuy = Pub_sNguoiSD; _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.RemoveTo(_KhamBenh_ThuocSD, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.RemoveTo(order);

                            break;
                        }
                    case "3":
                        {
                            KhamBenh_VTTH _KhamBenh_VTTH = _ThongtinBN.KhamBenh.KhamBenh_VTTHList.FirstOrDefault(X => X.STT == stt);
                            KhamBenh_GetsDichVu _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.OrderNumber == order);

                            _KhamBenh_VTTH.NguoiHuy = Pub_sNguoiSD; _ThongtinBN.KhamBenh.KhamBenh_VTTHList.RemoveTo(_KhamBenh_VTTH, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.RemoveTo(order);

                            break;
                        }
                    case "4":
                        {
                            KhamBenh_Mau _KhamBenh_Mau = _ThongtinBN.KhamBenh.KhamBenh_MauList.FirstOrDefault(X => X.STT == stt);

                            _KhamBenh_Mau.NguoiHuy = Pub_sNguoiSD; _ThongtinBN.KhamBenh.KhamBenh_MauList.RemoveTo(_KhamBenh_Mau, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.RemoveTo(order);

                            break;
                        }
                    case "5":
                        {
                            KhamBenh_HoaChat _KhamBenh_HoaChat = _ThongtinBN.KhamBenh.KhamBenh_HoaChatList.FirstOrDefault(X => X.STT == stt);

                            _KhamBenh_HoaChat.NguoiHuy = Pub_sNguoiSD; _ThongtinBN.KhamBenh.KhamBenh_HoaChatList.RemoveTo(_KhamBenh_HoaChat, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.RemoveTo(order);

                            break;
                        }
                    default:
                        {
                            break;
                        }
                }
            }
            else if (action == FormAction.EDIT)
            {
                loaidv = editedItem.GetDataKeyValue("LoaiDV").ToString();
                stt = int.Parse(editedItem.GetDataKeyValue("SoTT").ToString());
                order = int.Parse(editedItem.GetDataKeyValue("OrderNumber").ToString());
                decimal soluong = decimal.Parse(((TextBox)editedItem["SLTT"].Controls[0]).Text);

                Boolean mg = ((CheckBox)editedItem["MG"].Controls[0]).Checked;

                if (soluong <= 0)
                {
                    ShowMessage("Số lượng định dạng sai");
                    ((TextBox)editedItem["SLTT"].Controls[0]).Focus();

                    return false;
                };
                switch (loaidv)
                {
                    case "1":
                        {
                            KhamBenh_C _KhamBenh_C = _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(X => X.STT == stt);
                            if (_KhamBenh_C.MaHuongDT != "" && _LoaiPhieu != 1)
                            {
                                ShowMessage("Bệnh nhân đã thực hiện dịch vụ này");
                                return false;
                            }
                            KhamBenh_GetsDichVu _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.OrderNumber == order);
                            if (_LoaiPhieu != 1)
                            {
                                _KhamBenh_C.slmua = soluong.ToString();
                                _KhamBenh_C.SoLuong = soluong.ToString();
                                if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN")
                                    if (mg == true)
                                        _KhamBenh_C.CK = "100";
                                    else
                                        _KhamBenh_C.CK = "0";
                            }
                            else
                            {
                                if (cboKhoaKB.SelectedValue != "" && HTC.ShareVariables.pub_spC != "YH")
                                {
                                    _KhamBenh_C.Makhoa = cboKhoaKB.SelectedValue;
                                    _KhamBenh_C.makhoacd = cboKhoaKB.SelectedValue;
                                }
                                if (cboChuyenKhoa.SelectedValue != "")
                                {
                                    _KhamBenh_C.Machuyenkhoa = cboChuyenKhoa.SelectedValue;
                                }
                            }
                            _ThongtinBN.KhamBenh.KhamBenh_C_List.UpdatedTo(_KhamBenh_C, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.UpdatedTo(_KhamBenh_C, _KhamBenh_GetsDichVu);

                            break;
                        }
                    case "2":
                        {
                            KhamBenh_ThuocSD _KhamBenh_ThuocSD = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.FirstOrDefault(X => X.STT == stt);
                            KhamBenh_GetsDichVu _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.OrderNumber == order);
                            _KhamBenh_ThuocSD.SLMua = soluong.ToString();
                            _KhamBenh_ThuocSD.SLKeDon = soluong.ToString();
                            if (mg == true)
                                _KhamBenh_ThuocSD.CK = "100";
                            else
                                _KhamBenh_ThuocSD.CK = "0";
                            _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.UpdatedTo(_KhamBenh_ThuocSD, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.UpdatedTo(_KhamBenh_ThuocSD, _KhamBenh_GetsDichVu);

                            break;
                        }
                    case "3":
                        {
                            KhamBenh_VTTH _KhamBenh_VTTH = _ThongtinBN.KhamBenh.KhamBenh_VTTHList.FirstOrDefault(X => X.STT == stt);
                            KhamBenh_GetsDichVu _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.OrderNumber == order);
                            _KhamBenh_VTTH.SLMua = soluong.ToString();
                            _KhamBenh_VTTH.SLKeDon = soluong.ToString();
                            if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN")
                                if (mg == true)
                                    _KhamBenh_VTTH.CK = "100";
                                else
                                    _KhamBenh_VTTH.CK = "0";
                            _ThongtinBN.KhamBenh.KhamBenh_VTTHList.UpdatedTo(_KhamBenh_VTTH, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.UpdatedTo(_KhamBenh_VTTH, _KhamBenh_GetsDichVu);

                            break;
                        }
                    case "4":
                        {
                            KhamBenh_Mau _KhamBenh_Mau = _ThongtinBN.KhamBenh.KhamBenh_MauList.FirstOrDefault(X => X.STT == stt);
                            KhamBenh_GetsDichVu _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.OrderNumber == order);
                            _KhamBenh_Mau.SLMua = soluong.ToString();
                            _KhamBenh_Mau.SLKeDon = soluong.ToString();

                            _ThongtinBN.KhamBenh.KhamBenh_MauList.UpdatedTo(_KhamBenh_Mau, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.UpdatedTo(_KhamBenh_Mau, _KhamBenh_GetsDichVu);

                            break;
                        }
                    case "5":
                        {
                            KhamBenh_HoaChat _KhamBenh_HoaChat = _ThongtinBN.KhamBenh.KhamBenh_HoaChatList.FirstOrDefault(X => X.STT == stt);
                            KhamBenh_GetsDichVu _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.OrderNumber == order);
                            _KhamBenh_HoaChat.SLMua = soluong.ToString();
                            _KhamBenh_HoaChat.SLKeDon = soluong.ToString();

                            _ThongtinBN.KhamBenh.KhamBenh_HoaChatList.UpdatedTo(_KhamBenh_HoaChat, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.UpdatedTo(_KhamBenh_HoaChat, _KhamBenh_GetsDichVu);

                            break;
                        }
                    default:
                        {
                            break;
                        }
                }
            }
            grdCTT.MasterTableView.DataBind();
            grdCTT.DataBind();
        }
        catch (Exception ex)
        {
            ShowMessage("Không lưu được dữ liệu" + ex.Message); ;

            //throw;
        }

        return true;

    }
    private bool UpdateDataDTT(GridEditableItem editedItem, FormAction action)
    {
        string MaDV = string.Empty;
        string loaidv = string.Empty;
        int stt = 0;
        int order = 0;

        try
        {

            if (action == FormAction.DELETE)
            {
                loaidv = editedItem.GetDataKeyValue("LoaiDV").ToString();
                stt = int.Parse(editedItem.GetDataKeyValue("SoTT").ToString());
                order = int.Parse(editedItem.GetDataKeyValue("OrderNumber").ToString());

                switch (loaidv)
                {
                    case "1":
                        {
                            KhamBenh_C _KhamBenh_C = _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(X => X.STT == stt);
                            if (_KhamBenh_C.MaHuongDT != "" && _LoaiPhieu != 1)
                            {
                                ShowMessage("Bệnh nhân đã thực hiện dịch vụ này");
                                return false;
                            }


                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.RemoveTo(order);
                            if (_LoaiPhieu != 1)
                            {
                                _KhamBenh_C.SLTra = _KhamBenh_C.slmua;
                                _KhamBenh_C.SLTraCu = "0";
                            }
                            else
                            {
                                if (cboKhoaKB.SelectedValue != "")
                                {
                                    _KhamBenh_C.Makhoa = cboKhoaKB.SelectedValue;
                                    _KhamBenh_C.makhoacd = cboKhoaKB.SelectedValue;
                                }
                                if (cboChuyenKhoa.SelectedValue != "")
                                {
                                    _KhamBenh_C.Machuyenkhoa = cboChuyenKhoa.SelectedValue;
                                }
                            }
                            KhamBenh_HoaDon _KhamBenh_HoaDon = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Contains(_KhamBenh_C.SoSoHD, _KhamBenh_C.SoHD);
                            if (_KhamBenh_HoaDon != null)
                                _KhamBenh_HoaDon.TongChi = _KhamBenh_HoaDon.TongThu;
                            _ThongtinBN.KhamBenh.KhamBenh_C_List.UpdatedTo(_KhamBenh_C, _ThongtinBN.KhamBenh);

                            break;
                        }
                    case "2":
                        {
                            KhamBenh_ThuocSD _KhamBenh_ThuocSD = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.FirstOrDefault(X => X.STT == stt);

                            //KhamBenh_HoaDon _KhamBenh_HoaDon = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Contains(_KhamBenh_ThuocSD.SoSoHD, _KhamBenh_ThuocSD.SoHD);
                            //if (_KhamBenh_HoaDon != null)
                            //    _KhamBenh_HoaDon.TongChi = _KhamBenh_HoaDon.TongThu;
                            _KhamBenh_ThuocSD.SLTra = _KhamBenh_ThuocSD.SLMua;
                            _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.UpdatedTo(_KhamBenh_ThuocSD, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.RemoveTo(order);

                            break;
                        }
                    case "3":
                        {
                            KhamBenh_VTTH _KhamBenh_VTTH = _ThongtinBN.KhamBenh.KhamBenh_VTTHList.FirstOrDefault(X => X.STT == stt);
                            //KhamBenh_HoaDon _KhamBenh_HoaDon = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Contains(_KhamBenh_VTTH.SoSoHD, _KhamBenh_VTTH.SoHD);
                            //if (_KhamBenh_HoaDon != null)
                            //    _KhamBenh_HoaDon.TongChi = _KhamBenh_HoaDon.TongThu;
                            KhamBenh_GetsDichVu _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.FirstOrDefault(X => X.OrderNumber == order);
                            _KhamBenh_VTTH.SLTra = _KhamBenh_VTTH.SLMua;

                            _ThongtinBN.KhamBenh.KhamBenh_VTTHList.UpdatedTo(_KhamBenh_VTTH, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.RemoveTo(order);

                            break;
                        }
                    case "4":
                        {
                            KhamBenh_Mau _KhamBenh_Mau = _ThongtinBN.KhamBenh.KhamBenh_MauList.FirstOrDefault(X => X.STT == stt);
                            _KhamBenh_Mau.SLTra = _KhamBenh_Mau.SLMua;
                            //KhamBenh_HoaDon _KhamBenh_HoaDon = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Contains(_KhamBenh_Mau.SoSoHD, _KhamBenh_Mau.SoHD);
                            //if (_KhamBenh_HoaDon != null)
                            //    _KhamBenh_HoaDon.TongChi = _KhamBenh_HoaDon.TongThu;

                            _ThongtinBN.KhamBenh.KhamBenh_MauList.UpdatedTo(_KhamBenh_Mau, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.RemoveTo(order);

                            break;
                        }
                    case "5":
                        {
                            KhamBenh_HoaChat _KhamBenh_HoaChat = _ThongtinBN.KhamBenh.KhamBenh_HoaChatList.FirstOrDefault(X => X.STT == stt);
                            _KhamBenh_HoaChat.SLTra = _KhamBenh_HoaChat.SLMua;
                            //KhamBenh_HoaDon _KhamBenh_HoaDon = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Contains(_KhamBenh_HoaChat.SoSoHD, _KhamBenh_HoaChat.SoHD);
                            //if (_KhamBenh_HoaDon != null)
                            //    _KhamBenh_HoaDon.TongChi = _KhamBenh_HoaDon.TongThu;

                            _ThongtinBN.KhamBenh.KhamBenh_HoaChatList.UpdatedTo(_KhamBenh_HoaChat, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.RemoveTo(order);

                            break;
                        }
                    default:
                        {
                            break;
                        }
                }
            }
            else if (action == FormAction.EDIT)
            {
                loaidv = editedItem.GetDataKeyValue("LoaiDV").ToString();
                stt = int.Parse(editedItem.GetDataKeyValue("SoTT").ToString());
                order = int.Parse(editedItem.GetDataKeyValue("OrderNumber").ToString());
                decimal slmua = decimal.Parse(((TextBox)editedItem["SLMua"].Controls[0]).Text);
                decimal sltra = decimal.Parse(((TextBox)editedItem["SLTra"].Controls[0]).Text);
                decimal soluong = slmua - sltra;
                if (slmua - sltra < 0)
                {
                    ShowMessage("Số lượng định dạng sai");
                    ((TextBox)editedItem["SLTra"].Controls[0]).Focus();

                    return false;
                };
                switch (loaidv)
                {
                    case "1":
                        {
                            KhamBenh_C _KhamBenh_C = _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(X => X.STT == stt);
                            KhamBenh_GetsDichVu _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.FirstOrDefault(X => X.OrderNumber == order);
                            if (_KhamBenh_C.MaHuongDT != "")
                            {
                                ShowMessage("Đã nhập kết quả dịch vụ này");
                                return false;
                            }
                            if ((decimal.Parse(_KhamBenh_C.slmua) - soluong) <= 0)
                            {
                                ShowMessage("Số lượng trả lớn hơn số lượng mua");
                                return false;
                            }
                            //KhamBenh_HoaDon _KhamBenh_HoaDon = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Contains(_KhamBenh_C.SoSoHD, _KhamBenh_C.SoHD);
                            //if (_KhamBenh_HoaDon != null)
                            //    _KhamBenh_HoaDon.TongChi = _KhamBenh_HoaDon.TongThu;

                            _KhamBenh_C.SLTra = (decimal.Parse(_KhamBenh_C.slmua) - soluong).ToString();
                            _ThongtinBN.KhamBenh.KhamBenh_C_List.UpdatedTo(_KhamBenh_C, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.UpdatedTo(_KhamBenh_C, _KhamBenh_GetsDichVu);

                            break;
                        }
                    case "2":
                        {
                            KhamBenh_ThuocSD _KhamBenh_ThuocSD = _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.FirstOrDefault(X => X.STT == stt);
                            if ((decimal.Parse(_KhamBenh_ThuocSD.SLMua) - soluong) <= 0)
                            {
                                ShowMessage("Số lượng trả lớn hơn số lượng mua");
                                return false;
                            }
                            KhamBenh_GetsDichVu _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.FirstOrDefault(X => X.OrderNumber == order);
                            _KhamBenh_ThuocSD.SLTra = (decimal.Parse(_KhamBenh_ThuocSD.SLMua) - soluong).ToString();
                            //KhamBenh_HoaDon _KhamBenh_HoaDon = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Contains(_KhamBenh_ThuocSD.SoSoHD, _KhamBenh_ThuocSD.SoHD);
                            //if (_KhamBenh_HoaDon != null)
                            //    _KhamBenh_HoaDon.TongChi = _KhamBenh_HoaDon.TongThu;

                            _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.UpdatedTo(_KhamBenh_ThuocSD, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.UpdatedTo(_KhamBenh_ThuocSD, _KhamBenh_GetsDichVu);

                            break;
                        }
                    case "3":
                        {
                            KhamBenh_VTTH _KhamBenh_VTTH = _ThongtinBN.KhamBenh.KhamBenh_VTTHList.FirstOrDefault(X => X.STT == stt);
                            if ((decimal.Parse(_KhamBenh_VTTH.SLMua) - soluong) <= 0)
                            {
                                ShowMessage("Số lượng trả lớn hơn số lượng mua");
                                return false;
                            }
                            KhamBenh_GetsDichVu _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.FirstOrDefault(X => X.OrderNumber == order);
                            _KhamBenh_VTTH.SLTra = (decimal.Parse(_KhamBenh_VTTH.SLMua) - soluong).ToString();
                            //KhamBenh_HoaDon _KhamBenh_HoaDon = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Contains(_KhamBenh_VTTH.SoSoHD, _KhamBenh_VTTH.SoHD);
                            //if (_KhamBenh_HoaDon != null)
                            //    _KhamBenh_HoaDon.TongChi = _KhamBenh_HoaDon.TongThu;

                            _ThongtinBN.KhamBenh.KhamBenh_VTTHList.UpdatedTo(_KhamBenh_VTTH, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.UpdatedTo(_KhamBenh_VTTH, _KhamBenh_GetsDichVu);

                            break;
                        }
                    case "4":
                        {
                            KhamBenh_Mau _KhamBenh_Mau = _ThongtinBN.KhamBenh.KhamBenh_MauList.FirstOrDefault(X => X.STT == stt);
                            if ((decimal.Parse(_KhamBenh_Mau.SLMua) - soluong) <= 0)
                            {
                                ShowMessage("Số lượng trả lớn hơn số lượng mua");
                                return false;
                            }
                            KhamBenh_GetsDichVu _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.OrderNumber == order);
                            _KhamBenh_Mau.SLTra = (decimal.Parse(_KhamBenh_Mau.SLMua) - soluong).ToString();
                            //KhamBenh_HoaDon _KhamBenh_HoaDon = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Contains(_KhamBenh_Mau.SoSoHD, _KhamBenh_Mau.SoHD);
                            //if (_KhamBenh_HoaDon != null)
                            //    _KhamBenh_HoaDon.TongChi = _KhamBenh_HoaDon.TongThu;

                            _ThongtinBN.KhamBenh.KhamBenh_MauList.UpdatedTo(_KhamBenh_Mau, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.UpdatedTo(_KhamBenh_Mau, _KhamBenh_GetsDichVu);

                            break;
                        }
                    case "5":
                        {
                            KhamBenh_HoaChat _KhamBenh_HoaChat = _ThongtinBN.KhamBenh.KhamBenh_HoaChatList.FirstOrDefault(X => X.STT == stt);
                            if ((decimal.Parse(_KhamBenh_HoaChat.SLMua) - soluong) <= 0)
                            {
                                ShowMessage("Số lượng trả lớn hơn số lượng mua");
                                return false;
                            }
                            KhamBenh_GetsDichVu _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.OrderNumber == order);
                            _KhamBenh_HoaChat.SLTra = (decimal.Parse(_KhamBenh_HoaChat.SLMua) - soluong).ToString();
                            //KhamBenh_HoaDon _KhamBenh_HoaDon = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Contains(_KhamBenh_HoaChat.SoSoHD, _KhamBenh_HoaChat.SoHD);
                            //if (_KhamBenh_HoaDon != null)
                            //    _KhamBenh_HoaDon.TongChi = _KhamBenh_HoaDon.TongThu;

                            _ThongtinBN.KhamBenh.KhamBenh_HoaChatList.UpdatedTo(_KhamBenh_HoaChat, _ThongtinBN.KhamBenh);

                            _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.UpdatedTo(_KhamBenh_HoaChat, _KhamBenh_GetsDichVu);

                            break;
                        }
                    default:
                        {
                            break;
                        }
                }
            }
            grdDTT.MasterTableView.DataBind();
            grdDTT.DataBind();
        }
        catch (Exception ex)
        {
            ShowMessage("Không lưu được dữ liệu" + ex.Message); ;

            //throw;
        }

        return true;

    }

    private bool UpdateDataVTTH(GridEditableItem editedItem, FormAction action)
    {
        string MaVT = string.Empty;

        try
        {

            KhamBenh_VTTH _KhamBenh_VTTH;
            if (action == FormAction.INSERT)
                _KhamBenh_VTTH = KhamBenh_VTTH.NewKhamBenh_VTTH();
            else
            {
                int STT = int.Parse(editedItem.GetDataKeyValue("STT").ToString());

                _KhamBenh_VTTH = _ThongtinBN.KhamBenh.KhamBenh_VTTHList.FirstOrDefault(X => X.STT == STT);
            }
            if (action != FormAction.DELETE)
            {
                _KhamBenh_VTTH.MaSoKham = _MaSoKham;
                _KhamBenh_VTTH.Makhoa = _MaKhoa;
                _KhamBenh_VTTH.MaBN = _MaBN;



                if (!CheckFormData()) return false;
                else
                {


                    string soLuong = ((RadNumericTextBox)editedItem["SLKeDon"].FindControl("tbSoLuong")).Text;
                    Boolean tinhtien = ((CheckBox)editedItem["TinhTien"].Controls[0]).Checked;
                    if (soLuong == "" || soLuong == null || soLuong == "0")
                    {
                        ShowMessage("Chưa nhập số lượng");
                        ((RadNumericTextBox)editedItem["SLKeDon"].FindControl("tbSoLuong")).Focus();
                        return false;
                    };
                    if (decimal.Parse(soLuong) < 0)
                    {
                        ShowMessage("Số lượng định dạng sai");
                        ((RadNumericTextBox)editedItem["SLKeDon"].FindControl("tbSoLuong")).Focus();

                        return false;
                    };


                    if (action != FormAction.DELETE)
                    {
                        _KhamBenh_VTTH.NgayDK = _ThongtinBN.KhamBenh.NgayDK;
                        if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
                        {
                            _KhamBenh_VTTH.BSChiDinh = cboNhanVien.SelectedValue;
                            _KhamBenh_VTTH.tenbschidinh = cboNhanVien.Text;

                        }

                        _KhamBenh_VTTH.SLKeDon = soLuong;
                        _KhamBenh_VTTH.SLMua = _KhamBenh_VTTH.SLKeDon;

                        _KhamBenh_VTTH.NguoiSD = Pub_sNguoiSD;

                        ////   ============================================
                        if (_KhamBenh_VTTH.IsNew == true)
                        {
                            RadComboBox cboThuoc = editedItem["MaVT"].FindControl("cboDichVu") as RadComboBox;
                            if (cboThuoc != null)
                            {
                                MaVT = cboThuoc.SelectedValue;
                            }
                            if (MaVT == "")
                                return false;
                            DMVTYTKhoaList list = DMVTYTKhoaList.FindDMVTYTKhoaMa("011", cboDoiTuong.SelectedValue, "", 2) as DMVTYTKhoaList;

                            if (list == null)
                                return false;
                            DMVTYTKhoa _DMVTYTKhoa = list.FirstOrDefault(X => X.MaVT == MaVT);
                            if (_DMVTYTKhoa == null)
                                return false;
                            _KhamBenh_VTTH.BHTinhtien = _DMVTYTKhoa.DTBH;
                            _KhamBenh_VTTH.CK = "0";
                            _KhamBenh_VTTH.DonGiaBH = (string.IsNullOrEmpty(_DMVTYTKhoa.DonGiaBH) ? "0" : _DMVTYTKhoa.DonGiaBH);
                            _KhamBenh_VTTH.DongiaTT = (string.IsNullOrEmpty(_DMVTYTKhoa.DonGiaTT) ? "0" : _DMVTYTKhoa.DonGiaTT);
                            _KhamBenh_VTTH.NoiTTBH = _NoiTT;
                            _KhamBenh_VTTH.NoiTTTT = _NoiTT;
                            _KhamBenh_VTTH.MaDT = cboDoiTuong.SelectedValue;
                            if (_DMVTYTKhoa.adphongmo > 1)
                            {
                                // _KhamBenh_VTTH.TinhNgoai = True
                                _KhamBenh_VTTH.BHTinhtien = false;
                            }
                            else if (_DMVTYTKhoa.adphongmo == 2)
                            {
                                //_KhamBenh_VTTH.TinhNgoai = True
                                _KhamBenh_VTTH.BHTinhtien = false;
                            }
                            if (_DMVTYTKhoa.ADChenhLech == true)
                            {
                                _KhamBenh_VTTH.GiaChenhLech = (string.IsNullOrEmpty(_DMVTYTKhoa.GiaChenhlech) ? "0" : _DMVTYTKhoa.GiaChenhlech);
                            }
                            else
                            {
                                _KhamBenh_VTTH.GiaChenhLech = "0";
                            }
                            _KhamBenh_VTTH.MaVT = MaVT;

                            _KhamBenh_VTTH.TenTM = _DMVTYTKhoa.TenTM;
                            _KhamBenh_VTTH.tendvt = _DMVTYTKhoa.TenDVT;
                            _KhamBenh_VTTH.Tinhtien = tinhtien;
                            ///''''''''''''''''''''''
                            _KhamBenh_VTTH.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                            _KhamBenh_VTTH.MaBN = _ThongtinBN.MaBN;

                            _KhamBenh_VTTH.TONCK = decimal.Parse(_DMVTYTKhoa.TonCK == "" ? "0" : _DMVTYTKhoa.TonCK);
                            _KhamBenh_VTTH.TONCKDT = decimal.Parse(_DMVTYTKhoa.TonCKDT == "" ? "0" : _DMVTYTKhoa.TonCKDT);
                            if (((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093") || _NoiTT == "091" || _NoiTT == "092" || _NoiTT == "093")
                                _KhamBenh_VTTH.Tinhtien = true;

                            if (action == FormAction.INSERT)
                            {
                                if (_ThongtinBN.KhamBenh.KhamBenh_VTTHList.Count == 0)
                                {
                                    _KhamBenh_VTTH.STT = 1;
                                }
                                else
                                {
                                    _KhamBenh_VTTH.STT = _ThongtinBN.KhamBenh.KhamBenh_VTTHList[_ThongtinBN.KhamBenh.KhamBenh_VTTHList.Count - 1].STT + 1;
                                }
                            }
                        }
                    }
                }
            }
            if (action == FormAction.EDIT)
            {
                _ThongtinBN.KhamBenh.KhamBenh_VTTHList.UpdatedTo(_KhamBenh_VTTH, _ThongtinBN.KhamBenh);
                //_ThongtinBN.KhamBenh.KhamBenh_VTTHList.ApplyEdit();     
                //_ThongtinBN.KhamBenh.KhamBenh_VTTHList.Save();
            }
            else if (action == FormAction.INSERT)
            {
                _ThongtinBN.KhamBenh.KhamBenh_VTTHList.AssignTo(_KhamBenh_VTTH, _ThongtinBN.KhamBenh);
                //_ThongtinBN.KhamBenh.KhamBenh_VTTHList.ApplyEdit();     
                //_ThongtinBN.KhamBenh.KhamBenh_VTTHList.Save();

            }
            else if (action == FormAction.DELETE)
            {
                _KhamBenh_VTTH.NguoiHuy = Pub_sNguoiSD; _ThongtinBN.KhamBenh.KhamBenh_VTTHList.RemoveTo(_KhamBenh_VTTH, _ThongtinBN.KhamBenh);
                if (_KhamBenh_VTTH.DATT == 0)
                {

                    if (_Order == 0)
                        _Order = _KhamBenh_VTTH.STT;

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.RemoveTo(_Order);
                }
                else
                {
                    if (_Order == 0)
                        _Order = _KhamBenh_VTTH.STT;

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.RemoveTo(_Order);
                }
            }
            _Order = 0;
            //grdVTTH.EditIndexes.Clear();
            //grdVTTH.MasterTableView.Rebind();
            //grdVTTH.Rebind();
            grdCTT.Rebind();
            grdDTT.Rebind();



        }
        catch (Exception ex)
        {
            ShowMessage("Không lưu được dữ liệu" + ex.Message); ;

            //throw;
        }

        return true;

    }
    private bool UpdateDataXN(GridEditableItem editedItem, FormAction action, string madv = "", DMDichVu_Gia_DT _DMDV_Gia = null)
    {
        string MaDV = string.Empty;
        if (_NoiTT == "095")
        {
            txtChanDoan.Text = txtGhiChu.Text;
        }
        try
        {
            RadComboBox combo = null;
            KhamBenh_C _KhamBenh_C;
            if (_MaKhoa == "" || _MaKhoa == null)
            {
                if (cboKhoaKB.SelectedValue != "")
                    _MaKhoa = cboKhoaKB.SelectedValue;
                else if (cboBSDongY.SelectedValue != "" && cboBSDongY.SelectedValue != null)
                    _MaKhoa = DMNhanVien.GetDMNhanVien(cboBSDongY.SelectedValue).MaKhoa;
            }
            if (action == FormAction.INSERT)
                _KhamBenh_C = KhamBenh_C.NewKhamBenh_C();
            else
            {
                int STT = int.Parse(editedItem.GetDataKeyValue("STT").ToString());

                _KhamBenh_C = _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(X => X.STT == STT);
            }
            if (action != FormAction.DELETE)
            {
                if (cboLoaiBN.SelectedValue == "10" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN") && _LoaiPhieu == 1)
                {
                    _KhamBenh_C.DaTT = 3;
                    _KhamBenh_C.DaTTTT = 3;
                }
                _KhamBenh_C.MaSoKham = _MaSoKham;
                _KhamBenh_C.makhoacd = _MaKhoa;
                _KhamBenh_C.MaBN = _MaBN;
                _KhamBenh_C.MaMay = Pub_sMaMay;
                if (_KhamBenh_C.MaHuongDT != "" && _LoaiPhieu != 1)
                {
                    ShowMessage("Bệnh nhân đã thực hiện dịch vụ này");
                    return false;
                }

                //if (!CheckFormData()) return false;
                //else
                {
                    string soLuong = "";
                    Boolean tinhtien = false;
                    if (editedItem != null)
                    {
                        if (editedItem["SLMua"].FindControl("tbSLMua") == null)
                        {
                            soLuong = "1";
                            tinhtien = false;

                        }
                        else
                        {
                            soLuong = ((RadNumericTextBox)editedItem["SLMua"].FindControl("tbSLMua")).Text;
                            tinhtien = ((CheckBox)editedItem["TinhTien"].Controls[0]).Checked;
                        }
                        combo = ((RadComboBox)editedItem["MaKhoa"].FindControl("cboKhoa"));

                    }

                    if (madv == "" || madv == null)
                    {
                        RadComboBox cboThuoc = editedItem["MaDV"].FindControl("cboDichVu") as RadComboBox;
                        if (cboThuoc != null)
                        {
                            madv = cboThuoc.SelectedValue;
                            if (madv == "")
                            {
                                RadComboBox cboMaThuoc = editedItem["MaDV"].FindControl("cboMaDichVu") as RadComboBox;
                                if (cboMaThuoc != null)
                                {
                                    madv = cboMaThuoc.SelectedValue;
                                }
                            }
                            if (madv != "" && soLuong == "")
                                return false;
                            else if (madv == "" && soLuong == "")
                            {
                                ShowMessage("Chưa nhập tên dịch vụ");

                                return false;
                            }
                        }
                    }

                    if (soLuong == "")
                        soLuong = "1";
                    if (soLuong == "" || soLuong == null || soLuong == "0")
                    {
                        ShowMessage("Chưa nhập số lượng");
                        ((RadNumericTextBox)editedItem["SLMua"].FindControl("tbSoLuong")).Focus();
                        return false;
                    };
                    if (decimal.Parse(soLuong) < 0)
                    {
                        ShowMessage("Số lượng định dạng sai");
                        ((RadNumericTextBox)editedItem["SLMua"].FindControl("tbSoLuong")).Focus();

                        return false;
                    };
                    if (action != FormAction.DELETE)
                    {
                        if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
                        {
                            _KhamBenh_C.bschidinh = cboNhanVien.SelectedValue;
                            _KhamBenh_C.tenbschidinh = cboNhanVien.Text;
                            if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0)
                            {
                                _KhamBenh_C.BSKham = cboNhanVien.SelectedValue;
                                _KhamBenh_C.tenbs = cboNhanVien.Text;
                            }
                        }

                        if (cboChanDoan.SelectedValue != "" && cboChanDoan.SelectedValue != "0")
                        {
                            _KhamBenh_C.Mabenh = cboChanDoan.SelectedValue;
                            _KhamBenh_C.maicd = cboChanDoan.Text;

                        }
                        _KhamBenh_C.tenbenh = txtChanDoan.Text;
                        _KhamBenh_C.NguoiSD = Pub_sNguoiSD;
                        _KhamBenh_C.MaMay = Pub_sMaMay;
                        ////   =============================================
                        if (action == FormAction.EDIT && _LoaiPhieu != 1)
                        {
                            _KhamBenh_C.SoLuong = (decimal.Parse(soLuong)).ToString();
                            _KhamBenh_C.slmua = _KhamBenh_C.SoLuong;
                            _KhamBenh_C.Tinhtien = tinhtien;
                            if (cboKhoaKB.SelectedValue != "" && HTC.ShareVariables.pub_spC == "PS" && (_KhamBenh_C.MaDV.Substring(0, 2) == "SA" || _KhamBenh_C.MaDV.Substring(0, 2) == "PK" || _KhamBenh_C.MaDV.Substring(0, 2) == "TT"))
                            {
                                _KhamBenh_C.Makhoa = cboKhoaKB.SelectedValue;
                                _KhamBenh_C.makhoacd = cboKhoaKB.SelectedValue;
                                _KhamBenh_C.tenkhoa = cboKhoaKB.Text;
                            }
                            else if (cboKhoaKB.SelectedValue != "")
                            {
                                _KhamBenh_C.makhoacd = cboKhoaKB.SelectedValue;
                                _KhamBenh_C.tenkhoacd = cboKhoaKB.Text;
                            }
                            if (cboChuyenKhoa.SelectedValue != "")
                            {
                                _KhamBenh_C.Machuyenkhoa = cboChuyenKhoa.SelectedValue;
                            }
                            if (combo != null)
                                if (combo.SelectedValue != "")
                                {
                                    _KhamBenh_C.Makhoa = combo.SelectedValue;
                                    _KhamBenh_C.tenkhoa = combo.Text;
                                }
                        }
                        else if (action == FormAction.EDIT && _LoaiPhieu == 1)
                        {
                            if (cboKhoaKB.SelectedValue != "")
                            {
                                _KhamBenh_C.Makhoa = cboKhoaKB.SelectedValue;
                                _KhamBenh_C.makhoacd = cboKhoaKB.SelectedValue;
                                _KhamBenh_C.tenkhoa = cboKhoaKB.Text;
                            }
                            if (cboNhanVien.SelectedValue != "")
                            {
                                _KhamBenh_C.BSKham = cboNhanVien.SelectedValue;
                                _KhamBenh_C.tenbs = cboNhanVien.Text;
                            }
                            if (cboChuyenKhoa.SelectedValue != "")
                            {
                                _KhamBenh_C.Machuyenkhoa = cboChuyenKhoa.SelectedValue;
                            }
                            if (_KhamBenh_C.DaTT == 0)
                            {
                                _KhamBenh_C.SoLuong = (decimal.Parse(soLuong)).ToString();
                                _KhamBenh_C.slmua = _KhamBenh_C.SoLuong;
                                _KhamBenh_C.Tinhtien = tinhtien;
                            }
                            if (combo != null)
                                if (combo.SelectedValue != "")
                                {
                                    _KhamBenh_C.Makhoa = combo.SelectedValue;
                                    _KhamBenh_C.tenkhoa = combo.Text;
                                }
                        }
                        else if (action == FormAction.INSERT)
                        {
                            //if (editedItem != null)
                            //{
                            //    RadComboBox cboThuoc = editedItem["MaDV"].FindControl("cboDichVu") as RadComboBox;
                            //    ShowMessage(cboThuoc.Text);
                            //    if (cboThuoc != null)
                            //    {
                            //        MaDV = cboThuoc.SelectedValue;
                            //    }
                            //}
                            //else
                            MaDV = madv;
                            if (MaDV == "")
                                return false;
                            if (MaDV == "" || MaDV == null)
                                return false;
                            DMDichVu_Gia_DT _DMDichVu_Gia;
                            if (_DMDV_Gia == null)
                            {
                                DMDichVu_Gia_DTList list = null;
                                if (HTC.ShareVariables.pub_spC == "PS")
                                    list = DMDichVu_Gia_DTList.FindDMDichVu_Gia_DTByMa(MaDV + "/" + cboKhoaKB.SelectedValue, cboDoiTuong.SelectedValue);
                                else
                                    list = DMDichVu_Gia_DTList.FindDMDichVu_Gia_DTByMa(MaDV, cboDoiTuong.SelectedValue);
                                if (list == null)
                                    return false;
                                _DMDichVu_Gia = list.FirstOrDefault(X => X.MaDV == MaDV);

                            }
                            else

                                _DMDichVu_Gia = _DMDV_Gia;
                            if (_DMDichVu_Gia == null)
                                return false;
                            if (_NoiTT == "087" || _NoiTT == "095")
                            {
                                if (cboDoiTuong.SelectedValue != "00002" && cboDoiTuong.SelectedValue.Substring(0, 1) == "0")
                                    _KhamBenh_C.DongiaTT = _DMDichVu_Gia.Dongia == "" ? "0" : _DMDichVu_Gia.Dongia;
                                else
                                    _KhamBenh_C.DongiaTT = _DMDichVu_Gia.dongiaclc == "" ? "0" : _DMDichVu_Gia.dongiaclc;
                                _KhamBenh_C.NoiTTBH = _NoiTT;
                                _KhamBenh_C.NoiTTTT = _NoiTT;
                            }
                            else
                            {
                                _KhamBenh_C.DongiaTT = _DMDichVu_Gia.dongiatt == "" ? "0" : _DMDichVu_Gia.dongiatt;
                                _KhamBenh_C.NoiTTBH = _NoiTT;
                                _KhamBenh_C.NoiTTTT = _NoiTT;
                            }
                            if (_KhamBenh_C.NoiTTTT == "087" || _KhamBenh_C.NoiTTTT == "095")
                            {
                                _KhamBenh_C.Makhoa = _DMDichVu_Gia.makhoa087;
                                _KhamBenh_C.tenkhoa = _DMDichVu_Gia.tenkhoa087;
                            }
                            else if (_KhamBenh_C.NoiTTTT == "093")
                            {
                                _KhamBenh_C.Makhoa = _DMDichVu_Gia.makhoaNG;
                                _KhamBenh_C.tenkhoa = _DMDichVu_Gia.tenkhoaNG;
                            }
                            else
                            {
                                _KhamBenh_C.Makhoa = _DMDichVu_Gia.makhoa;
                                _KhamBenh_C.tenkhoa = _DMDichVu_Gia.tenkhoa;
                            }
                            if (_KhamBenh_C.Makhoa == "")
                            {
                                _KhamBenh_C.Makhoa = cboKhoaKB.SelectedValue;
                                _KhamBenh_C.tenkhoa = cboKhoaKB.Text;
                            }
                            if (combo != null)
                            {
                                if (combo.SelectedValue != "")
                                {
                                    _KhamBenh_C.Makhoa = combo.SelectedValue;
                                    _KhamBenh_C.tenkhoa = combo.Text;
                                }

                            }
                            if (cboKhoaKB.SelectedValue == "" && cboKhoaKB.Text != "" && _KhamBenh_C.Makhoa == "")
                            {
                                DMKhoaList _dmkhoal = DMKhoaList.FindDMKhoaByTen(cboKhoaKB.Text, Pub_sAccount);
                                if (_dmkhoal.Count > 0)
                                {
                                    cboKhoaKB.Text = _dmkhoal[0].TenKhoa;
                                    cboKhoaKB.SelectedValue = _dmkhoal[0].MaKhoa;
                                    _KhamBenh_C.Makhoa = combo.SelectedValue;
                                    _KhamBenh_C.tenkhoa = combo.Text;
                                }
                            }

                            if (_KhamBenh_C.Makhoa.Length < 3)
                            {
                                ShowMessage("Chưa nhập khoa phòng");
                                return false;
                            }
                            if (_DMDichVu_Gia.MaDV.Substring(0, 2).ToUpper() == "PK" && cboChuyenKhoa.SelectedValue != "" && _DMDV_Gia == null)
                                _KhamBenh_C.Machuyenkhoa = cboChuyenKhoa.SelectedValue;
                            else if (_DMDichVu_Gia.MaDV.Substring(0, 2).ToUpper() == "PK" && cboChuyenKhoa.SelectedValue != "" && _DMDV_Gia.makhoa == "" && _DMDV_Gia.makhoa087 == "")
                                _KhamBenh_C.Machuyenkhoa = cboChuyenKhoa.SelectedValue;
                            if (cboChanDoan.Text != "")
                            {
                                _KhamBenh_C.Mabenh = cboChanDoan.SelectedValue;
                                _KhamBenh_C.maicd = cboChanDoan.Text;
                            }
                            if ((_DMDichVu_Gia.maLH == "00003" || _DMDichVu_Gia.maLH == "00030") && HTC.ShareVariables.pub_spC == "PS")
                            {
                                if (cboChuyenKhoa.SelectedValue == "")
                                {
                                    ShowMessage("Chưa nhập chuyên khoa");
                                    cboKhoaKB.Text = "";
                                    cboKhoaKB.SelectedValue = "";
                                    cboChuyenKhoa.Focus();
                                    return false;
                                }
                            }
                            _KhamBenh_C.tenbenh = txtChanDoan.Text;
                            if (_LoaiPhieu == 1 && _PubMaDT == "CC")
                            {
                                _KhamBenh_C.TToanSau = true;
                            }
                            _KhamBenh_C.malh = _DMDichVu_Gia.maLH;
                            _KhamBenh_C.BHTinhtien = _DMDichVu_Gia.DTBH;
                            _KhamBenh_C.CK = "0";
                            _KhamBenh_C.DonGiaBH = (string.IsNullOrEmpty(_DMDichVu_Gia.Dongia) ? "0" : _DMDichVu_Gia.Dongia);
                            // _KhamBenh_C.DongiaTT = (string.IsNullOrEmpty(_DMDichVu_Gia.dongiatt) ? "0" : _DMDichVu_Gia.dongiatt);

                            //_KhamBenh_C.NoiTTBH = _NoiTT;
                            //_KhamBenh_C.NoiTTTT = _NoiTT;
                            _KhamBenh_C.MaDT = cboDoiTuong.SelectedValue;

                            if (_DMDichVu_Gia.ADPhongMo > 1)
                            {
                                // _KhamBenh_C.TinhNgoai = True
                                _KhamBenh_C.BHTinhtien = false;
                            }
                            else if (_DMDichVu_Gia.ADPhongMo == 2)
                            {
                                //_KhamBenh_C.TinhNgoai = True
                                _KhamBenh_C.BHTinhtien = false;
                            }
                            if (_DMDichVu_Gia.ADChenhlech == true)
                            {
                                _KhamBenh_C.GiaChenhLech = (string.IsNullOrEmpty(_DMDichVu_Gia.GiaChenhlenh) ? "0" : _DMDichVu_Gia.GiaChenhlenh);
                            }
                            else
                            {
                                _KhamBenh_C.GiaChenhLech = "0";
                            }
                            _KhamBenh_C.SoLuong = (decimal.Parse(soLuong)).ToString();
                            _KhamBenh_C.slmua = _KhamBenh_C.SoLuong;
                            _KhamBenh_C.Tinhtien = tinhtien;
                            if (cboKhoaKB.SelectedValue != "")
                            {

                                _KhamBenh_C.makhoacd = cboKhoaKB.SelectedValue;
                            }
                            if (cboChuyenKhoa.SelectedValue != "")
                            {
                                _KhamBenh_C.Machuyenkhoa = cboChuyenKhoa.SelectedValue;
                            }
                            _KhamBenh_C.MaDV = MaDV;
                            _KhamBenh_C.NhapSL = _DMDichVu_Gia.nhapsl;
                            _KhamBenh_C.inthu = _DMDichVu_Gia.inthu;
                            _KhamBenh_C.TenTM = _DMDichVu_Gia.TenDV;
                            _KhamBenh_C.tentat = _DMDichVu_Gia.tentat;
                            _KhamBenh_C.Tinhtien = tinhtien;
                            ///''''''''''''''''''''''
                            _KhamBenh_C.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                            _KhamBenh_C.MaBN = _ThongtinBN.MaBN;
                            if (((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093") || _NoiTT == "091" || _NoiTT == "092" || _NoiTT == "093")
                                _KhamBenh_C.Tinhtien = true;

                            if (action == FormAction.INSERT)
                            {
                                if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0)
                                {
                                    _KhamBenh_C.STT = 1;
                                }
                                else
                                {
                                    _KhamBenh_C.STT = _ThongtinBN.KhamBenh.KhamBenh_C_List[_ThongtinBN.KhamBenh.KhamBenh_C_List.Count - 1].STT + 1;
                                }
                            }
                        }
                    }
                }
            }
            if (action == FormAction.EDIT)
            {
                _ThongtinBN.KhamBenh.KhamBenh_C_List.UpdatedTo(_KhamBenh_C, _ThongtinBN.KhamBenh);
                if (_KhamBenh_C.DaTT == 0)
                {
                    KhamBenh_GetsDichVu _KhamBenh_GetsDichVu;
                    if (_Order == 0)
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.SoTT == _KhamBenh_C.STT);
                    else
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.SoTT == _Order);
                    if (_KhamBenh_GetsDichVu != null)
                        _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.UpdatedTo(_KhamBenh_C, _KhamBenh_GetsDichVu);
                }
                else
                {
                    KhamBenh_GetsDichVu _KhamBenh_GetsDichVu;
                    if (_Order == 0)
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.FirstOrDefault(X => X.SoTT == _KhamBenh_C.STT);
                    else
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.FirstOrDefault(X => X.SoTT == _Order);
                    if (_KhamBenh_GetsDichVu != null)
                        _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.UpdatedTo(_KhamBenh_C, _KhamBenh_GetsDichVu);
                }
                //_ThongtinBN.KhamBenh.KhamBenh_C_List.ApplyEdit();     
                //_ThongtinBN.KhamBenh.KhamBenh_C_List.Save();
            }
            else if (action == FormAction.INSERT)
            {
                if (_KhamBenh_C.MaHuongDT != "" && _LoaiPhieu != 1)
                {
                    ShowMessage("Bệnh nhân đã thực hiện dịch vụ này");
                    return false;
                }
                _ThongtinBN.KhamBenh.KhamBenh_C_List.AssignTo(_KhamBenh_C, _ThongtinBN.KhamBenh);
                _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.NewTo(_KhamBenh_C);

                //_ThongtinBN.KhamBenh.KhamBenh_C_List.ApplyEdit();     
                //_ThongtinBN.KhamBenh.KhamBenh_C_List.Save();

            }
            else if (action == FormAction.DELETE)
            {
                if (_LoaiPhieu == 1 || _KhamBenh_C.DaTT == 0)
                {
                    _KhamBenh_C.slmua = "0";
                    _KhamBenh_C.SoLuong = "0";
                    _KhamBenh_C.Huy = true;
                    _KhamBenh_C.MaMay = Pub_sMaMay;
                    _KhamBenh_C.NguoiHuy = Pub_sNguoiSD;
                }
                _KhamBenh_C.NguoiHuy = Pub_sNguoiSD; _ThongtinBN.KhamBenh.KhamBenh_C_List.RemoveTo(_KhamBenh_C, _ThongtinBN.KhamBenh);
                if (_KhamBenh_C.DaTT == 0)
                {

                    if (_Order == 0)
                        _Order = _KhamBenh_C.STT;

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.RemoveTo(_Order);
                }
                else
                {
                    if (_Order == 0)
                        _Order = _KhamBenh_C.STT;

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.RemoveTo(_Order);
                }
            }
            if (_ThongKe_BenhNhan_NgoaiTruListInfo != null)
            {
                _KhamBenh_GETsMABNListInfo = null;
                _ThongKe_BenhNhan_NgoaiTruListInfo = null;
                grdXNTT.Height = 300;
                grdLichSuKham.Visible = false;
                grdKhoa.Visible = false;
            }
            _Order = 0;
        }
        catch (Exception ex)
        {
            ShowMessage("Không lưu được dữ liệu" + ex.Message); ;

            //throw;
        }

        return true;
    }
    private bool UpdateDataHoaChat(GridEditableItem editedItem, FormAction action)
    {
        string MaHC = string.Empty;

        try
        {

            KhamBenh_HoaChat _KhamBenh_HoaChat;
            if (action == FormAction.INSERT)
                _KhamBenh_HoaChat = KhamBenh_HoaChat.NewKhamBenh_HoaChat();
            else
            {
                int STT = int.Parse(editedItem.GetDataKeyValue("STT").ToString());

                _KhamBenh_HoaChat = _ThongtinBN.KhamBenh.KhamBenh_HoaChatList.FirstOrDefault(X => X.STT == STT);
            }
            if (action != FormAction.DELETE)
            {
                _KhamBenh_HoaChat.MaSoKham = _MaSoKham;
                _KhamBenh_HoaChat.Makhoa = _MaKhoa;
                _KhamBenh_HoaChat.MaBN = _MaBN;



                if (!CheckFormData()) return false;
                else
                {


                    string soLuong = ((RadNumericTextBox)editedItem["SLKeDon"].FindControl("tbSoLuong")).Text;
                    Boolean tinhtien = ((CheckBox)editedItem["TinhTien"].Controls[0]).Checked;
                    if (soLuong == "" || soLuong == null || soLuong == "0")
                    {
                        ShowMessage("Chưa nhập số lượng");
                        ((RadNumericTextBox)editedItem["SLKeDon"].FindControl("tbSoLuong")).Focus();
                        return false;
                    };
                    if (decimal.Parse(soLuong) < 0)
                    {
                        ShowMessage("Số lượng định dạng sai");
                        ((RadNumericTextBox)editedItem["SLKeDon"].FindControl("tbSoLuong")).Focus();

                        return false;
                    };


                    if (action != FormAction.DELETE)
                    {
                        _KhamBenh_HoaChat.NgayDK = _ThongtinBN.KhamBenh.NgayDK;
                        if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
                        {
                            _KhamBenh_HoaChat.BSChiDinh = cboNhanVien.SelectedValue;
                            _KhamBenh_HoaChat.tenbschidinh = cboNhanVien.Text;

                        }
                        _KhamBenh_HoaChat.SLKeDon = soLuong;
                        _KhamBenh_HoaChat.SLMua = _KhamBenh_HoaChat.SLKeDon;

                        _KhamBenh_HoaChat.NguoiSD = Pub_sNguoiSD;

                        ////   =============================================
                        if (_KhamBenh_HoaChat.IsNew == true)
                        {
                            RadComboBox cboThuoc = editedItem["MaHC"].FindControl("cboDichVu") as RadComboBox;
                            if (cboThuoc != null)
                            {
                                MaHC = cboThuoc.SelectedValue;
                            }
                            if (MaHC == "")
                                return false;
                            //  DMHoaChatKhoaList list = odsHoaChat.Select() as DMHoaChatKhoaList;
                            DMHoaChatKhoaList list = DMHoaChatKhoaList.FindDMHoaChatKhoaMa("011", cboDoiTuong.SelectedValue, MaHC, 3) as DMHoaChatKhoaList;
                            if (list == null)
                                return false;
                            DMHoaChatKhoa _DMHoaChatKhoa = list.FirstOrDefault(X => X.MaHC == MaHC);
                            if (_DMHoaChatKhoa == null)
                                return false;
                            _KhamBenh_HoaChat.BHTinhtien = _DMHoaChatKhoa.DTBH;
                            _KhamBenh_HoaChat.CK = "0";
                            _KhamBenh_HoaChat.DonGiaBH = (string.IsNullOrEmpty(_DMHoaChatKhoa.DonGiaBH) ? "0" : _DMHoaChatKhoa.DonGiaBH);
                            _KhamBenh_HoaChat.DongiaTT = (string.IsNullOrEmpty(_DMHoaChatKhoa.DonGiaTT) ? "0" : _DMHoaChatKhoa.DonGiaTT);
                            _KhamBenh_HoaChat.NoiTTBH = _NoiTT;
                            _KhamBenh_HoaChat.NoiTTTT = _NoiTT;

                            if (_DMHoaChatKhoa.adphongmo > 1)
                            {
                                // _KhamBenh_HoaChat.TinhNgoai = True
                                _KhamBenh_HoaChat.BHTinhtien = false;
                            }
                            else if (_DMHoaChatKhoa.adphongmo == 2)
                            {
                                //_KhamBenh_HoaChat.TinhNgoai = True
                                _KhamBenh_HoaChat.BHTinhtien = false;
                            }
                            if (_DMHoaChatKhoa.ADChenhLech == true)
                            {
                                _KhamBenh_HoaChat.GiaChenhLech = (string.IsNullOrEmpty(_DMHoaChatKhoa.GiaChenhlech) ? "0" : _DMHoaChatKhoa.GiaChenhlech);
                            }
                            else
                            {
                                _KhamBenh_HoaChat.GiaChenhLech = "0";
                            }
                            _KhamBenh_HoaChat.MaHC = MaHC;

                            _KhamBenh_HoaChat.TenTM = _DMHoaChatKhoa.TenTM;
                            _KhamBenh_HoaChat.tendvt = _DMHoaChatKhoa.TenDVT;
                            _KhamBenh_HoaChat.Tinhtien = tinhtien;
                            ///''''''''''''''''''''''
                            _KhamBenh_HoaChat.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                            _KhamBenh_HoaChat.MaBN = _ThongtinBN.MaBN;

                            _KhamBenh_HoaChat.TONCK = decimal.Parse(_DMHoaChatKhoa.TonCK == "" ? "0" : _DMHoaChatKhoa.TonCK);
                            _KhamBenh_HoaChat.TONCKDT = decimal.Parse(_DMHoaChatKhoa.TonCKDT == "" ? "0" : _DMHoaChatKhoa.TonCKDT);
                            if (((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093") || _NoiTT == "091" || _NoiTT == "092" || _NoiTT == "093")
                                _KhamBenh_HoaChat.Tinhtien = true;

                            if (action == FormAction.INSERT)
                            {
                                if (_ThongtinBN.KhamBenh.KhamBenh_HoaChatList.Count == 0)
                                {
                                    _KhamBenh_HoaChat.STT = 1;
                                }
                                else
                                {
                                    _KhamBenh_HoaChat.STT = _ThongtinBN.KhamBenh.KhamBenh_HoaChatList[_ThongtinBN.KhamBenh.KhamBenh_HoaChatList.Count - 1].STT + 1;
                                }
                            }
                        }
                    }
                }
            }
            if (action == FormAction.EDIT)
            {
                _ThongtinBN.KhamBenh.KhamBenh_HoaChatList.UpdatedTo(_KhamBenh_HoaChat, _ThongtinBN.KhamBenh);
                if (_KhamBenh_HoaChat.DATT == 0)
                {
                    KhamBenh_GetsDichVu _KhamBenh_GetsDichVu;
                    if (_Order == 0)
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.OrderNumber == _KhamBenh_HoaChat.STT);
                    else
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.OrderNumber == _Order);

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.UpdatedTo(_KhamBenh_HoaChat, _KhamBenh_GetsDichVu);
                }
                else
                {
                    KhamBenh_GetsDichVu _KhamBenh_GetsDichVu;
                    if (_Order == 0)
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.FirstOrDefault(X => X.OrderNumber == _KhamBenh_HoaChat.STT);
                    else
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.FirstOrDefault(X => X.OrderNumber == _Order);

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.UpdatedTo(_KhamBenh_HoaChat, _KhamBenh_GetsDichVu);
                }
            }
            else if (action == FormAction.INSERT)
            {
                _ThongtinBN.KhamBenh.KhamBenh_HoaChatList.AssignTo(_KhamBenh_HoaChat, _ThongtinBN.KhamBenh);
                if (_KhamBenh_HoaChat.DATT == 0)
                {

                    if (_Order == 0)
                        _Order = _KhamBenh_HoaChat.STT;

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.RemoveTo(_Order);
                }
                else
                {
                    if (_Order == 0)
                        _Order = _KhamBenh_HoaChat.STT;

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.RemoveTo(_Order);
                }

            }
            else if (action == FormAction.DELETE)
            {
                _KhamBenh_HoaChat.NguoiHuy = Pub_sNguoiSD; _ThongtinBN.KhamBenh.KhamBenh_HoaChatList.RemoveTo(_KhamBenh_HoaChat, _ThongtinBN.KhamBenh);
                _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.RemoveTo(_KhamBenh_HoaChat.STT);

            }

            //grdHoaChat.EditIndexes.Clear();
            //grdHoaChat.MasterTableView.Rebind();
            //grdHoaChat.Rebind();

            grdCTT.Rebind();
            grdDTT.Rebind();

            _Order = 0;
        }
        catch (Exception ex)
        {
            ShowMessage("Không lưu được dữ liệu" + ex.Message); ;

            //throw;
        }

        return true;
    }

    private bool UpdateDataMau(GridEditableItem editedItem, FormAction action)
    {
        string MaThuoc = string.Empty;

        try
        {

            KhamBenh_Mau _KhamBenh_Mau;
            if (action == FormAction.INSERT)
                _KhamBenh_Mau = KhamBenh_Mau.NewKhamBenh_Mau();
            else
            {
                int STT = int.Parse(editedItem.GetDataKeyValue("STT").ToString());

                _KhamBenh_Mau = _ThongtinBN.KhamBenh.KhamBenh_MauList.FirstOrDefault(X => X.STT == STT);
            }
            if (action != FormAction.DELETE)
            {
                _KhamBenh_Mau.MaSoKham = _MaSoKham;
                _KhamBenh_Mau.Makhoa = _MaKhoa;
                _KhamBenh_Mau.MaBN = _MaBN;



                if (!CheckFormData()) return false;
                else
                {

                    string soLuong = ((RadNumericTextBox)editedItem["SLKeDon"].FindControl("tbSoLuong")).Text;
                    Boolean tinhtien = ((CheckBox)editedItem["TinhTien"].Controls[0]).Checked;

                    if (soLuong == "" || soLuong == null || soLuong == "0")
                    {
                        ShowMessage("Chưa nhập số lượng");
                        ((RadNumericTextBox)editedItem["SLKeDon"].FindControl("tbSoLuong")).Focus();
                        return false;
                    };
                    if (decimal.Parse(soLuong) < 0)
                    {
                        ShowMessage("Số lượng định dạng sai");
                        ((RadNumericTextBox)editedItem["SLKeDon"].FindControl("tbSoLuong")).Focus();

                        return false;
                    };

                    if (action != FormAction.DELETE)
                    {
                        _KhamBenh_Mau.NgayDK = _ThongtinBN.KhamBenh.NgayDK;
                        if (cboNhanVien.SelectedValue != "" && cboNhanVien.SelectedValue != "0")
                        {
                            _KhamBenh_Mau.BSChiDinh = cboNhanVien.SelectedValue;
                            _KhamBenh_Mau.tenbschidinh = cboNhanVien.Text;

                        }


                        _KhamBenh_Mau.SLKeDon = soLuong;
                        _KhamBenh_Mau.SLMua = _KhamBenh_Mau.SLKeDon;

                        _KhamBenh_Mau.NguoiSD = Pub_sNguoiSD;

                        ////   =============================================
                        if (_KhamBenh_Mau.IsNew == true)
                        {
                            RadComboBox cboThuoc = editedItem["MaThuoc"].FindControl("cboDichVu") as RadComboBox;
                            if (cboThuoc != null)
                            {
                                MaThuoc = cboThuoc.SelectedValue;
                            }
                            if (MaThuoc == "")
                                return false;
                            // DMChePhamMauKhoaList list = odsChePhamMau.Select() as DMChePhamMauKhoaList;
                            DMChePhamMauKhoaList list = DMChePhamMauKhoaList.FindDMChePhamMauKhoaMa("011", cboDoiTuong.SelectedValue, MaThuoc, 3) as DMChePhamMauKhoaList;
                            if (list == null)
                                return false;
                            DMChePhamMauKhoa _DMChePhamMauKhoa = list.FirstOrDefault(X => X.MaCPMau == MaThuoc);
                            if (_DMChePhamMauKhoa == null)
                                return false;
                            _KhamBenh_Mau.BHTinhtien = _DMChePhamMauKhoa.DTBH;
                            _KhamBenh_Mau.CK = "0";
                            _KhamBenh_Mau.DonGiaBH = (string.IsNullOrEmpty(_DMChePhamMauKhoa.DonGiaBH) ? "0" : _DMChePhamMauKhoa.DonGiaBH);
                            _KhamBenh_Mau.DongiaTT = (string.IsNullOrEmpty(_DMChePhamMauKhoa.DonGiaTT) ? "0" : _DMChePhamMauKhoa.DonGiaTT);
                            _KhamBenh_Mau.NoiTTBH = _NoiTT;
                            _KhamBenh_Mau.NoiTTTT = _NoiTT;

                            if (_DMChePhamMauKhoa.adphongmo > 1)
                            {
                                // _KhamBenh_Mau.TinhNgoai = True
                                _KhamBenh_Mau.BHTinhtien = false;
                            }
                            else if (_DMChePhamMauKhoa.adphongmo == 2)
                            {
                                //_KhamBenh_Mau.TinhNgoai = True
                                _KhamBenh_Mau.BHTinhtien = false;
                            }
                            if (_DMChePhamMauKhoa.ADChenhLech == true)
                            {
                                _KhamBenh_Mau.GiaChenhLech = (string.IsNullOrEmpty(_DMChePhamMauKhoa.GiaChenhlech) ? "0" : _DMChePhamMauKhoa.GiaChenhlech);
                            }
                            else
                            {
                                _KhamBenh_Mau.GiaChenhLech = "0";
                            }
                            _KhamBenh_Mau.MaCPMau = MaThuoc;

                            _KhamBenh_Mau.TenTM = _DMChePhamMauKhoa.TenTM;
                            _KhamBenh_Mau.tendvt = _DMChePhamMauKhoa.TenDVT;
                            _KhamBenh_Mau.Tinhtien = tinhtien;
                            ///''''''''''''''''''''''
                            _KhamBenh_Mau.MaSoKham = _ThongtinBN.KhamBenh.MaSoKham;
                            _KhamBenh_Mau.MaBN = _ThongtinBN.MaBN;

                            _KhamBenh_Mau.TONCK = decimal.Parse(_DMChePhamMauKhoa.TonCK == "" ? "0" : _DMChePhamMauKhoa.TonCK);
                            _KhamBenh_Mau.TONCKDT = decimal.Parse(_DMChePhamMauKhoa.TonCKDT == "" ? "0" : _DMChePhamMauKhoa.TonCKDT);
                            if (((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093") || _NoiTT == "091" || _NoiTT == "092" || _NoiTT == "093")
                                _KhamBenh_Mau.Tinhtien = true;
                            if (action == FormAction.INSERT)
                            {
                                if (_ThongtinBN.KhamBenh.KhamBenh_MauList.Count == 0)
                                {
                                    _KhamBenh_Mau.STT = 1;
                                }
                                else
                                {
                                    _KhamBenh_Mau.STT = _ThongtinBN.KhamBenh.KhamBenh_MauList[_ThongtinBN.KhamBenh.KhamBenh_MauList.Count - 1].STT + 1;
                                }
                            }
                        }
                    }
                }
            }
            if (action == FormAction.EDIT)
            {
                _ThongtinBN.KhamBenh.KhamBenh_MauList.UpdatedTo(_KhamBenh_Mau, _ThongtinBN.KhamBenh);
                if (_KhamBenh_Mau.DATT == 0)
                {
                    KhamBenh_GetsDichVu _KhamBenh_GetsDichVu;
                    if (_Order == 0)
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.OrderNumber == _KhamBenh_Mau.STT);
                    else
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.OrderNumber == _Order);

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.UpdatedTo(_KhamBenh_Mau, _KhamBenh_GetsDichVu);
                }
                else
                {
                    KhamBenh_GetsDichVu _KhamBenh_GetsDichVu;
                    if (_Order == 0)
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.FirstOrDefault(X => X.OrderNumber == _KhamBenh_Mau.STT);
                    else
                        _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.FirstOrDefault(X => X.OrderNumber == _Order);

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.UpdatedTo(_KhamBenh_Mau, _KhamBenh_GetsDichVu);
                }
            }
            else if (action == FormAction.INSERT)
            {
                _ThongtinBN.KhamBenh.KhamBenh_MauList.AssignTo(_KhamBenh_Mau, _ThongtinBN.KhamBenh);
                _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.NewTo(_KhamBenh_Mau);

            }
            else if (action == FormAction.DELETE)
            {
                _KhamBenh_Mau.NguoiHuy = Pub_sNguoiSD; _ThongtinBN.KhamBenh.KhamBenh_MauList.RemoveTo(_KhamBenh_Mau, _ThongtinBN.KhamBenh);
                if (_KhamBenh_Mau.DATT == 0)
                {

                    if (_Order == 0)
                        _Order = _KhamBenh_Mau.STT;

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.RemoveTo(_Order);
                }
                else
                {
                    if (_Order == 0)
                        _Order = _KhamBenh_Mau.STT;

                    _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.RemoveTo(_Order);
                }

            }

            //grdMau.EditIndexes.Clear();
            //grdMau.MasterTableView.Rebind();
            //grdMau.Rebind();
            grdCTT.Rebind();
            grdDTT.Rebind();
            _Order = 0;



        }
        catch (Exception ex)
        {
            ShowMessage("Không lưu được dữ liệu" + ex.Message);

            //throw;
        }

        return true;

    }


    public Boolean PrintDataHD(KhamBenh_HoaDon _KhamBenh_HoaDon)
    {
        try
        {
            String sPath = string.Empty;
            ReportDocument rpt = new ReportDocument();
            FormulaFieldDefinitions Myformulas;
            String ngay = DateTime.Now.Day <= 9 ? "0" + DateTime.Now.Day.ToString() : DateTime.Now.Day.ToString();
            String thang = DateTime.Now.Month <= 9 ? "0" + DateTime.Now.Month.ToString() : DateTime.Now.Month.ToString();

            //if (_KhamBenh_HoaDon.SoHD != "" && (_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8))  )
            //{
            //    if (_KhamBenh_HoaDon != null)
            //    {
            //        if (_KhamBenh_HoaDon.TongThu != 0 && _KhamBenh_HoaDon.TongChi == 0)
            //            if (HTC.Business.DataProvider.Instance().KiemTraHoaDon(_KhamBenh_HoaDon.MaSoKham, _KhamBenh_HoaDon.SoSoHD, _KhamBenh_HoaDon.SoHD, _LoaiPhieu) == "")
            //            {
            //                ShowMessage("Không thể thanh toán được hóa đơn!Phải thanh toán lại hóa đơn này");
            //                Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={0}&&noitt={1}&duyet={2}&pubmadt={5}&&maBN={3}&&ngayDK={4}", _LoaiPhieu, _NoiTT, _Duyet, txtmabn.Text, DateTime.Parse(dtNgayDK.Text), _PubMaDT), false);

            //                return false;

            //            }
            //    }
            //}

            if ((HTC.ShareVariables.pub_spC == "PS"))
                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crBCHoadonNT.rpt";
            else if (HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "HH")
                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crBCHoadon.rpt";
            rpt.Load(Server.MapPath(sPath));
            Myformulas = rpt.DataDefinition.FormulaFields;
            if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 7)
            {
                if (cboDoiTuong.SelectedValue.Substring(0, 1) != "0")
                    Myformulas["PatientName"].Text = "'" + txthoten.Text + "-" + _ThongtinBN.MaBN + "'";
                else
                    Myformulas["PatientName"].Text = "'" + txthoten.Text + "-" + _ThongtinBN.MaBN + "'";
            }
            else
            {
                Myformulas["PatientName"].Text = "'" + txthoten.Text + "-" + _ThongtinBN.MaBN + "    -     " + cboDoiTuong.SelectedItem.Text + "'";

            }
            if (_LoaiPhieu == 2)
            {
                Myformulas["TongTien"].Text = "'Tổng tiền :" + _KhamBenh_HoaDon.TongBH.ToString("###,###") + " đồng'";

                Myformulas["TongBH"].Text = "'Tổng tiền BH trả " + _KhamBenh_HoaDon.TongBHTra.ToString("###,###") + " đồng'";
            }
            if (txtNoiLamViec.Text == "" && _NoiTT == "095")
                Myformulas["PatientAddress"].Text = "'" + (txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "")).Replace("'", "''") + "'";
            else if (_NoiTT == "095")
                Myformulas["PatientAddress"].Text = "'" + txtNoiLamViec.Text.Replace("'", "''") + "'";
            else
                Myformulas["PatientAddress"].Text = "'" + txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "") + "'";
            Myformulas["PayinReason"].Text = "'" + _KhamBenh_HoaDon.LydoThu + "'";
            Myformulas["SUM"].Text = "" + _KhamBenh_HoaDon.TongThu + "";
            Myformulas["doituong"].Text = "'" + cboDoiTuong.Text + "'";
            Myformulas["KHHD"].Text = "'" + _KhamBenh_HoaDon.SoSoHD + "'";
            Myformulas["SOHD"].Text = "'" + _KhamBenh_HoaDon.SoHD + "'";
            if (_KhamBenh_HoaDon.TenNguoiLap != "")
                Myformulas["NVTHUTIEN"].Text = "'" + _KhamBenh_HoaDon.TenNguoiLap + "'";
            else
                Myformulas["NVTHUTIEN"].Text = "'" + Pub_sTenNguoiSD + "'";

            PrintExport(rpt); rpt.Dispose(); rpt = null;//   PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer3.LoadReport(rpt, true, false);
            return true;
        }
        catch (Exception ex)
        {

            ShowMessage("Không in được hóa đơn" + ex.Message);
            return true;
        }

    }
    private void PrintDataThuocDY(Boolean _load = true, string _in = "", string sohd = "", string sosohd = "")
    {
        try
        {
            String sPath;
            String ngay = DateTime.Now.Day <= 9 ? "0" + DateTime.Now.Day.ToString() : DateTime.Now.Day.ToString();
            String thang = DateTime.Now.Month <= 9 ? "0" + DateTime.Now.Month.ToString() : DateTime.Now.Month.ToString();


            DataSet ReportData6 = new DataSet();

            // dy
            if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count > 0 && _LoaiPhieu == 7)
            {

                Boolean _print = false;

                foreach (KhamBenh_ThuocSD_DY _kbc in _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList)
                {
                    if (_kbc.DaTTTT == 7)
                    {
                        _print = true;
                        break; // TODO: might not be correct. Was : Exit For
                    }
                }


                if (_print == true)
                {
                    if (_load == true)
                    {
                        if (_in == "In lại" && sohd == "")
                            ReportData6 = HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc_DY(_ThongtinBN.KhamBenh.MaSoKham, "  and isnull(datttt,0) <> 0 and isnull(slthang,0) <> 0 ", false);
                        else if (_in == "In lại" && sohd != "")
                            ReportData6 = HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc_DY(_ThongtinBN.KhamBenh.MaSoKham, "  and isnull(datttt,0) <> 0 and isnull(slthang,0) <> 0 and k.sosohdtt ='" + sosohd + "' and k.sohdtt ='" + sohd + "'", false);
                        else if (cboBSDongY.SelectedValue == "" && HTC.ShareVariables.pub_spC == "YH")
                            ReportData6 = HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc_DY(_ThongtinBN.KhamBenh.MaSoKham, "  and isnull(datttt,0) <> 0 and isnull(slthang,0) <> 0 ", false);
                        else if (sohd != "")
                            ReportData6 = HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc_DY(_ThongtinBN.KhamBenh.MaSoKham, "  and isnull(datttt,0) <> 0 and isnull(slthang,0) <> 0 and k.sosohdtt ='" + sosohd + "' and k.sohdtt ='" + sohd + "'", false);
                        else
                            ReportData6 = HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc_DY(_ThongtinBN.KhamBenh.MaSoKham, "  and isnull(datttt,0) <> 0 and isnull(slthang,0) <> 0 and k.bschidinh ='" + cboBSDongY.SelectedValue + "'", false);
                    }

                    if (ReportData6.Tables[0].Rows.Count > 0)
                    {
                        //reports
                        sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRKhamBenh_DonThuoc_DYA5.rpt";
                        ReportDocument rpt = new ReportDocument();
                        FormulaFieldDefinitions Myformulas;


                        rpt.Load(Server.MapPath(sPath));
                        Myformulas = rpt.DataDefinition.FormulaFields;


                        Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                        Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                        Myformulas["DiaChiBV"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV + "'";
                        //Myformulas["NgayBC"].Text = "'" & Strings.Format(htc.ShareVariables .NgayLV , "dd/MM/yyyy") & "'"
                        Myformulas["NgayBC"].Text = "'" + "Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                        Myformulas["TenBN"].Text = "'" + txthoten.Text.Replace("'", "''").ToUpper() + "'";
                        Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text.Replace("'", "''") + "'";
                        Myformulas["mabn"].Text = "'*" + _ThongtinBN.MaBN + "*'";

                        Myformulas["SoTheBHYT"].Text = "'" + txtSoThe.Text + "'";

                        if (HTC.ShareVariables.pub_spC == "QN")
                            Myformulas["TenBC"].Text = "'PHIẾU THU'";
                        Myformulas["BacSy"].Text = "'BS :" + cboBSDongY.Text + "'";

                        Myformulas["Tuoi"].Text = "'" + txttuoi.Text + "'";
                        Myformulas["GioiTinh"].Text = "'" + (optGT.Items[0].Selected == true ? " Nam" : "Nữ") + "'";
                        Myformulas["SoTheBHYT"].Text = "'" + (txtSoThe.Text).ToUpper() + "'";

                        Myformulas["TenDT"].Text = "'" + cboDoiTuong.SelectedItem.Text + "'";


                        rpt.SetDataSource(ReportData6);

                        PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer6.LoadReport(rpt, true, false);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            ShowMessage("Không in được báo cáo" + ex.Message);

            //throw;
        }
    }
    public void PrintDataDV(bool inlai = false, string sosohd = "", string sohd = "", byte _kieuin = 0)
    {
        try
        {
            if (_Duyet == 1 && _LoaiPhieu == 1 && dtNgayQT.Text != "")
                return;
            String sPath = string.Empty;
            ReportDocument rpt = new ReportDocument();
            FormulaFieldDefinitions Myformulas;
            String ngay = DateTime.Now.Day <= 9 ? "0" + DateTime.Now.Day.ToString() : DateTime.Now.Day.ToString();
            String thang = DateTime.Now.Month <= 9 ? "0" + DateTime.Now.Month.ToString() : DateTime.Now.Month.ToString();
            Boolean _inhuongdant = false;
            Boolean _inhuongdan = false;
            Boolean _inhuongdan2 = true;
            //_kieuin=0 in tat, 1: inthu, 2: ko thu
            if ((sosohd == "" && (_LoaiPhieu == 9 || _LoaiPhieu == 8) && inlai == false && (HTC.ShareVariables.pub_spC != "HU" && HTC.ShareVariables.pub_spC != "QN" && HTC.ShareVariables.pub_spC != "PH")) || ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "PH") && sosohd == "" && (_LoaiPhieu == 9 || _LoaiPhieu == 8) && inlai == false && _NoiTT == "087"))
            {
                ShowMessage("Chưa chọn số phiếu để in");
                return;
            }
            if (_kieuin == 1)
                _inhuongdant = true;
            else if (_LoaiPhieu == 1)
            {
                foreach (KhamBenh_C kb in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                {
                    if (kb.inthu == true && (kb.DaTT == 0 || HTC.ShareVariables.pub_spC == "PS"))
                    {
                        _inhuongdant = true;
                        break;
                    }
                    else
                    {
                        _inhuongdant = false;
                    }
                }
            }
            else if (_kieuin == 0 && sosohd == "")
            {
                foreach (KhamBenh_C kb in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                {
                    if (kb.inthu == true || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                    {
                        _inhuongdant = true;
                        break;
                    }
                }
            }
            else if (_kieuin == 0 && sosohd == "" && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count >= 1 && (HTC.ShareVariables.pub_spC != "HU" && HTC.ShareVariables.pub_spC != "QN" && HTC.ShareVariables.pub_spC != "PH"))
            {
                foreach (KhamBenh_C kb in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                {
                    if (kb.inthu == true)
                    {
                        _inhuongdant = true;
                        break;
                    }
                }
            }
            else if (_kieuin == 2 && sosohd != "" && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count >= 1 && HTC.ShareVariables.pub_spC == "PS" && (_NoiTT == "087" || _NoiTT == "095"))
            {

                foreach (KhamBenh_C kb in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                {

                    if (kb.inthu == true && kb.MaDV.Substring(0, 2) == "SA" && kb.bschidinh != "" && (_NoiTT == "087" || _NoiTT == "095"))
                    {
                        if (kb.makhoacd != "")
                        {

                            _inhuongdant = true;
                            _inhuongdan2 = false;

                        }
                        break;
                    }
                }
            }

            if (_LoaiPhieu == 1 && (HTC.ShareVariables.pub_spC != "HU" && HTC.ShareVariables.pub_spC != "PH" && HTC.ShareVariables.pub_spC != "QN"))
                _inhuongdan = true;
            else if ((_kieuin == 2 && (HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "HH" || HTC.ShareVariables.pub_spC == "QN")) || ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && HTC.ShareVariables.pub_spC == "PS" && _inhuongdant == true && _inhuongdan2 == true) || (HTC.ShareVariables.pub_spC == "HU" && _kieuin == 2) || (HTC.ShareVariables.pub_spC == "PH" && _kieuin == 2) || ((_LoaiPhieu == 7 || _LoaiPhieu == 3) && HTC.ShareVariables.pub_spC == "PS"))
                _inhuongdan = true;
            else if (_LoaiPhieu == 1 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _NoiTT == "087")
            {
                _inhuongdan = true;
            }
            else if (_LoaiPhieu == 1 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "HH" || HTC.ShareVariables.pub_spC == "PH"))
            {
                foreach (KhamBenh_C kb in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                {
                    if (kb.inthu == false && kb.DaTT == 0)
                    {
                        _inhuongdan = true;
                        break;
                    }
                }
            }
            else if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && HTC.ShareVariables.pub_spC == "YH")
            {
                foreach (KhamBenh_C kb in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                {
                    if (kb.inthu == false && kb.DaTT == 0 && _NoiTT == "087")
                    {
                        _inhuongdan = true;
                        break;
                    }
                    else if (kb.inthu == false && kb.DaTT == 0 && kb.makhoacd == kb.Makhoa && _NoiTT == "085")
                    {
                        _inhuongdan = true;
                        break;
                    }
                }
                foreach (KhamBenh_C kb in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                {
                    if (kb.inthu == false && kb.NgayLap == "" && _NoiTT == "085")
                    {
                        _inhuongdan = true;
                        break;
                    }
                }
            }
            else if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && HTC.ShareVariables.pub_spC == "PH" && (txtkyquy.Text != "" && txtkyquy.Text != "0") && sosohd == "" && _ThongtinBN.KhamBenh.KyQuyBH != "")
            {
                foreach (KhamBenh_C kb in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                {
                    if (kb.inthu == false && kb.NgayLap == "" && _NoiTT == "085" && kb.STT > 1)
                    {
                        _inhuongdan = true;
                        break;
                    }
                }
            }
            //ShowMessage(_kieuin.ToString() + "/" + _inhuongdant.ToString()); ;
            if (HTC.ShareVariables.pub_spC == "PS" && _LoaiPhieu == 1)
            {
                if (cboLoaiBN.SelectedValue == "3")
                {
                    _inhuongdan = true;
                }
                else if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count < 2)
                {
                    _inhuongdan = false;
                }
            }
            if (_LoaiPhieu == 1 && inlai == true)
            {
                _inhuongdan = true;
                _inhuongdant = true;
            }
            DataSet ReportData1 = new DataSet();
            DataSet ReportData2 = new DataSet();
            if (dtNgayQT.Text != "" && _LoaiPhieu == 2)
            {
                _inhuongdant = false;
            }

            if (sosohd != "" && (_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && inlai == false)
            {
                KhamBenh_HoaDon kb = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.FirstOrDefault(X => X.SoHD == sohd);
                if (kb != null)
                {
                    if (kb.TongThu != 0 && kb.TongChi == 0)
                        if (HTC.Business.DataProvider.Instance().KiemTraHoaDon(kb.MaSoKham, kb.SoSoHD, kb.SoHD, _LoaiPhieu) == "")
                        {
                            ShowMessage("Không thể thanh toán được hóa đơn!Phải thanh toán lại hóa đơn này");
                            Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={0}&&noitt={1}&duyet={2}&pubmadt={5}&&maBN={3}&&ngayDK={4}", _LoaiPhieu, _NoiTT, _Duyet, txtmabn.Text, DateTime.Parse(dtNgayDK.Text), _PubMaDT), false);

                            return;

                        }
                }
            }

            if (_NoiTT == "095" && HTC.ShareVariables.pub_spC == "PS" && _LoaiPhieu == 1)
            {
                foreach (KhamBenh_C kb in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                {
                    ReportDocument rptcs = new ReportDocument();

                    sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRPhieuchamsoc.rpt";
                    rptcs.Load(Server.MapPath(sPath));
                    Myformulas = rptcs.DataDefinition.FormulaFields;
                    Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                    Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                    Myformulas["ms"].Text = "'*" + _ThongtinBN.MaBN + "*'";
                    Myformulas["hoten"].Text = "'" + txthoten.Text.Replace("'", "''").ToUpper() + "'";
                    if (txtNoiLamViec.Text == "")
                        Myformulas["DiaChi"].Text = "'" + (txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "")).Replace("'", "''") + "'";
                    else
                        Myformulas["DiaChi"].Text = "'" + txtNoiLamViec.Text.Replace("'", "''") + "'"; ;
                    Myformulas["Tuoi"].Text = "'" + dtNgaySinh.Text.Substring(6, 4) + "'";

                    Myformulas["ghichu"].Text = "'" + txtGhiChu.Text.Replace("'", "''") + "'";
                    Myformulas["sotien"].Text = "'" + kb.thanhtien + "'";
                    Myformulas["tungay"].Text = "'" + dtCSTuNgay.Text + "'";
                    Myformulas["denngay"].Text = "'" + dtCSDenNgay.Text + "'";
                    Myformulas["dienthoai"].Text = "'" + txtdienthoai.Text + "-" + txtDTCQ.Text + "-" + txtDTDD.Text + "'";
                    Myformulas["dichvu"].Text = "'" + kb.TenDV + "'";

                    PrintExport(rptcs, kb.STT.ToString());
                    rptcs.Dispose(); rptcs = null;
                }
            }
            if (_inhuongdant == true && ((_LoaiPhieu == 1 || (_LoaiPhieu == 7 && (_NoiTT == "090" || _NoiTT == "087" || _NoiTT == "093" || _NoiTT == "094" || (_NoiTT == "085" && HTC.ShareVariables.pub_spC == "QN"))) || ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "PH") && (_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && (_NoiTT == "085" || _NoiTT == "093")) || ((HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "HH" || HTC.ShareVariables.pub_spC == "QN") && (_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && _NoiTT == "085")) || (HTC.ShareVariables.pub_spC == "PS" && ((_LoaiPhieu == 9 || _LoaiPhieu == 8)) && (_NoiTT == "087" || _NoiTT == "095"))))
            {

                if (sosohd != "" && (_NoiTT == "090" || _NoiTT == "094" || _NoiTT == "093"))
                    ReportData1 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, 77, 77, " and inthu =1 and sosohd ='" + sosohd + "' and sohd ='" + sohd + "' and noitttt='" + _NoiTT + "'"));
                else if (sosohd != "" && _LoaiPhieu == 7 && (_NoiTT == "087"))
                    ReportData1 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, 77, 77, " and inthu =1 and sosohd ='" + sosohd + "' and sohd ='" + sohd + "' and noitttt='" + _NoiTT + "'"));
                else if (sosohd != "" && HTC.ShareVariables.pub_spC == "PS" && (_LoaiPhieu == 9 || _LoaiPhieu == 8))
                    ReportData1 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, _LoaiPhieu, _LoaiPhieu, " and madv like 'SA%' and inthu =1 and sosohd ='" + sosohd + "' and sohd ='" + sohd + "' and noitttt='" + _NoiTT + "'"));
                else if (sosohd != "" && ((HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") || (HTC.ShareVariables.pub_spC == "YH" && _NoiTT != "087" && _NoiTT != "091" && _NoiTT != "092")))
                    ReportData1 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, _LoaiPhieu, _LoaiPhieu, " and inthu =1 and sosohd ='" + sosohd + "' and sohd ='" + sohd + "' and noitttt='" + _NoiTT + "'"));
                else if (sosohd == "" && (_NoiTT == "087") && _LoaiPhieu == 7)
                    ReportData1 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, 77, 77, " and inthu =1  and noitttt='" + _NoiTT + "'"));
                else if (sosohd == "" && (_NoiTT == "090" || _NoiTT == "094"))
                    ReportData1 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, 77, 77, " and inthu =1  and noitttt='" + _NoiTT + "'"));
                else if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && inlai == false)
                    ReportData1 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, 0, 0, "  and datediff(n,a.ngaylap,getdate()) <15 and inthu =1  and noitttt='" + _NoiTT + "'"));
                else if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                    ReportData1 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, 0, 0, " and inthu =1  and noitttt='" + _NoiTT + "'"));
                else if (HTC.ShareVariables.pub_spC == "HH" && inlai == false)
                    ReportData1 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, 0, 0, "  and datediff(n,a.ngaylap,getdate()) <15 and inthu =1  and noitttt='" + _NoiTT + "'"));
                else if (HTC.ShareVariables.pub_spC == "HH")
                    ReportData1 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, 0, 0, " and inthu =1  and noitttt='" + _NoiTT + "'"));
                else if (HTC.ShareVariables.pub_spC == "YH")
                    ReportData1 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, 0, 0, " and inthu =1 and noitttt='" + _NoiTT + "'"));
                else
                    ReportData1 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, 0, _LoaiPhieu, " and ((inthu =1 and noitttt in('085','093') and (a.madv like 'PK%'  or a.madv like 'TT%')) or (inthu =1 and noitttt not in('085','093')))  and noitttt='" + _NoiTT + "'"));


                if (ReportData1.Tables[0].Rows.Count > 0)
                {
                    if ((HTC.ShareVariables.pub_spC == "PS"))
                        sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuHuongDan_RPT.rpt";
                    else if (((HTC.ShareVariables.pub_spC == "HU" && HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ ") && cboquocgia.SelectedValue == "00084"))
                        sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuHDanDG_RPTHue1.rpt";
                    else if (((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && cboquocgia.SelectedValue == "00084"))
                        sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuHDanDG_RPT.rpt";
                    else if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH"))
                        sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuHDanDGQT_RPT.rpt";
                    else if ((HTC.ShareVariables.pub_spC == "HH"))
                        sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuHuongDan_RPT.rpt";
                    else if ((HTC.ShareVariables.pub_spC == "YH" && _LoaiPhieu == 2) || (_LoaiPhieu == 1 && cboDoiTuong.SelectedValue.Substring(0, 1) == "1"))
                        sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuHDBH_rpt.rpt";

                    else if (HTC.ShareVariables.pub_spC == "YH")
                        sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuHD_rpt.rpt";
                    rpt.Load(Server.MapPath(sPath));
                    Myformulas = rpt.DataDefinition.FormulaFields;
                    Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                    Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                    if (_LoaiPhieu == 2 && cboDoiTuong.SelectedValue.Substring(0, 1) == "0")
                        Myformulas["TenBC"].Text = "'" + ("PHIẾU HƯỚNG DẪN") + "'";
                    else if ((HTC.ShareVariables.pub_spC == "YH" && _LoaiPhieu == 2) || (_LoaiPhieu == 1 && cboDoiTuong.SelectedValue.Substring(0, 1) == "1"))
                        Myformulas["TenBC"].Text = "'" + ("GIẤY KHÁM VÀ GIỮ THẺ BẢO HIỂM") + "'";
                    else if (_LoaiPhieu == 7 && ((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "093" || _NoiTT == "094"))
                        Myformulas["TenBC"].Text = "'" + ("PHIẾU SẮC THUỐC") + "'";
                    else if (_LoaiPhieu == 1 && cboDoiTuong.SelectedValue.Substring(0, 1) == "1")
                        Myformulas["TenBC"].Text = "'" + ("GIẤY KHÁM VÀ GIỮ THẺ BẢO HIỂM") + "'";
                    else if (HTC.ShareVariables.pub_spC == "YH")
                        Myformulas["TenBC"].Text = "'" + ("PHIẾU DỊCH VỤ") + "'";
                    else if (HTC.ShareVariables.pub_spC == "HH")
                        Myformulas["TenBC"].Text = "'" + ("PHIẾU DỊCH VỤ") + "'";
                    Myformulas["DienThoai"].Text = "'" + txtdienthoai.Text + "'";
                    if (HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ ")
                    {
                        Myformulas["TenQuay"].Text = "'" + Pub_sTenQuay + "'";
                    }
                    if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                    {
                        if (_LoaiPhieu == 2)
                        {
                            Myformulas["TongTien"].Text = (txtkyquy.Text == "" ? "0" : txtkyquy.Text.Replace(",", ""));
                            Myformulas["kyquy"].Text = "'Ký quỹ'";
                        }
                        else if ((cboDoiTuong.SelectedValue.Substring(0, 1) != "0" && _LoaiPhieu == 1))
                        {
                            Myformulas["TongTien"].Text = (_ThongtinBN.KhamBenh.KyQuyBH == "" ? "0" : _ThongtinBN.KhamBenh.KyQuyBH.Replace(",", ""));
                            Myformulas["kyquy"].Text = "'Ký quỹ'";
                        }
                        else if ((_LoaiPhieu == 9 || _LoaiPhieu == 8))
                        {
                            Myformulas["TongTien"].Text = txtTongHD.Text.Replace(",", "");
                            Myformulas["kyquy"].Text = "'Tiền khám'";
                        }
                        else if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && cboDoiTuong.SelectedValue.Substring(0, 1) == "0" && _LoaiPhieu == 1)
                        {
                            Myformulas["kyquy"].Text = "'Tiền khám'";
                        }
                    }
                    Myformulas["mabn"].Text = "'*" + _ThongtinBN.MaBN + "*'";
                    Myformulas["bn"].Text = "'" + _ThongtinBN.MaBN + "'";
                    if (HTC.ShareVariables.pub_spC == "PS")
                    {
                        if (_ThongtinBN.KhamBenh.bhtra == 100)
                            Myformulas["doituong"].Text = "'<BN phải trả 0 %>'";

                        else
                            Myformulas["doituong"].Text = "'<BN phải trả " + (100 - _ThongtinBN.KhamBenh.bhtra).ToString("###") + " %>'";
                    }
                    else
                        Myformulas["doituong"].Text = "'" + cboDoiTuong.SelectedItem.Text + "'";
                    Myformulas["noidk"].Text = "'" + cboDKBD.Text + "-" + txtDKBD.Text.Replace("'", "''") + "'";
                    if (_NoiTT == "087" || _NoiTT == "095")
                    {
                        Myformulas["khoakb"].Text = "'" + HTC.ShareVariables.pub_sTenPK + "'";
                    }
                    if ((_LoaiPhieu == 2 || cboDoiTuong.SelectedValue.Substring(0, 1) == "1") && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH"))
                    {
                        Myformulas["noigt"].Text = "'" + cboDKGT.Text + "-" + txtDKGT.Text + "'";
                        Myformulas["NGAYgt"].Text = "'" + dtNgayGT.Text + "'";
                        Myformulas["chandoanbd"].Text = "'" + txtBenhNGT.Text + "'";
                        Myformulas["mabenhbd"].Text = "'" + cboCDnoiGT.Text + "'";
                    }
                    Myformulas["NGAYDK"].Text = "'" + dtNgayDK.Text + "'";
                    Myformulas["hoten"].Text = "'" + txthoten.Text.Replace("'", "''").ToUpper() + "'";
                    Myformulas["masokham"].Text = "'*" + _ThongtinBN.KhamBenh.MaSoKham + "*'";

                    if (txtNoiLamViec.Text == "" && _NoiTT == "095")
                        Myformulas["DiaChi"].Text = "'" + (txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "")).Replace("'", "''") + "'";
                    else if (txtNoiLamViec.Text != "" && _NoiTT == "095")
                        Myformulas["DiaChi"].Text = "'" + txtNoiLamViec.Text.Replace("'", "''") + "'";
                    else if (!(txtDiaChi.Text == "" && cbohuyen.Text == "" && _LoaiPhieu != 7))
                        Myformulas["DiaChi"].Text = "'" + (txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "")).Replace("'", "''") + "'"; ;
                    // if (_LoaiPhieu == 2)
                    Myformulas["sothe"].Text = "'" + txtSoThe.Text + "'";

                    Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                    Myformulas["tungay"].Text = "'" + dtBHYTTN.Text + "'";

                    Myformulas["denngay"].Text = "'" + dtBHYTDN.Text + "'";

                    if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                    {

                        Myformulas["BacSy"].Text = "'" + _ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbs + "'";
                    }
                    Myformulas["Tuoi"].Text = "'" + dtNgaySinh.Text.Substring(6, 4) + "'";

                    Myformulas["GT"].Text = "'" + (optGT.Items[0].Selected == true ? "Nam" : "Nữ") + "'";

                    Myformulas["TenNguoiYC"].Text = "'" + Pub_sTenNguoiSD + "'";

                    if (inlai == true)
                    {
                        Myformulas["inlai"].Text = "'In lại'";
                        if (_LoaiPhieu != 1)
                        {
                            KhamBenh_HoaDon hd = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.FirstOrDefault(X => X.SoHD == sohd);
                            if (hd != null)
                                Myformulas["TenNguoiYC"].Text = "'" + hd.tenNguoiThu + "'";
                        }
                    }
                    else if (HTC.ShareVariables.pub_spC == "PH" && sosohd == "" && (_LoaiPhieu == 9 || _LoaiPhieu == 8) && _ThongtinBN.KhamBenh.KyQuyBH != "")
                        Myformulas["inlai"].Text = "'Chưa thanh toán'";
                    Myformulas["Ngayin"].Text = "'Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                    rpt.SetDataSource(ReportData1);
                    //if (HTC.ShareVariables.pub_spC == "YH")
                    //    PrintExportDirect(rpt);
                    //else
                    PrintExport(rpt);
                    rpt.Dispose(); rpt = null;// PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer1.LoadReport(rpt, true, false);
                }

            }

            if (_inhuongdan == true && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HH" || ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && HTC.ShareVariables.pub_spC == "YH") || _LoaiPhieu == 7 || _LoaiPhieu == 3))
            {
                if ((((_LoaiPhieu == 1 && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 1 && cboDoiTuong.SelectedValue.Substring(0, 1).ToString() != "0") || (_LoaiPhieu == 1 && cboDoiTuong.SelectedValue.Substring(0, 1).ToString() == "0") || (_LoaiPhieu != 1))) || (_kieuin == 0 && _LoaiPhieu != 1))
                {
                    // in cac dich vu khong in phieu thu hoac in tong cong 
                    ReportDocument rpt2 = new ReportDocument();
                    FormulaFieldDefinitions Myformulas2;


                    if (_LoaiPhieu == 3)
                        //  ReportData2 = (HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc(_ThongtinBN.KhamBenh.MaSoKham, " and isnull(slkedon,0) <> 0 and datttt=7 and sosohd ='" + sosohd + "' and sohd ='" + sohd + "' and noitttt='" + _NoiTT + "'", false));
                        ReportData2 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, 0, 0, " and noitttt='" + _NoiTT + "'"));
                    else if (_LoaiPhieu == 7 && (!((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093")))
                        //  ReportData2 = (HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc(_ThongtinBN.KhamBenh.MaSoKham, " and isnull(slkedon,0) <> 0 and datttt=7 and sosohd ='" + sosohd + "' and sohd ='" + sohd + "' and noitttt='" + _NoiTT + "'", false));
                        ReportData2 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, _LoaiPhieu, _LoaiPhieu, "  and sosohd ='" + sosohd + "' and sohd ='" + sohd + "' and noitttt='" + _NoiTT + "'"));

                    else if (sosohd != "" && ((HTC.ShareVariables.pub_spC == "PS")))
                        ReportData2 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, _LoaiPhieu, _LoaiPhieu, "  and sosohd ='" + sosohd + "' and sohd ='" + sohd + "' and noitttt='" + _NoiTT + "'"));
                    else if (sosohd != "" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH"))
                        ReportData2 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, _LoaiPhieu, _LoaiPhieu, "  and sosohd ='" + sosohd + "' and sohd ='" + sohd + "' and noitttt='" + _NoiTT + "'"));
                    else if (sosohd != "" && (((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093")))
                        ReportData2 = HTC.Business.DataProvider.Instance().crKhamBenh_DonThuoc_DY(_ThongtinBN.KhamBenh.MaSoKham, " and isnull(slthang,0) <> 0 and sosohd ='" + sosohd + "' and sohd ='" + sohd + "' and noitttt='" + _NoiTT + "'", false);
                    else if (sosohd != "" && (HTC.ShareVariables.pub_spC == "YH" && _NoiTT == "085"))
                        ReportData2 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, _LoaiPhieu, _LoaiPhieu, " and inthu =0 and sosohd ='" + sosohd + "' and sohd ='" + sohd + "' and noitttt='" + _NoiTT + "'"));
                    else if (sosohd != "" && (HTC.ShareVariables.pub_spC == "YH" && _NoiTT != "085"))
                        ReportData2 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, _LoaiPhieu, _LoaiPhieu, " and sosohd ='" + sosohd + "' and sohd ='" + sohd + "' and noitttt='" + _NoiTT + "'"));
                    else if ((_LoaiPhieu != 1 && HTC.ShareVariables.pub_spC != "PH") || (_LoaiPhieu != 1 && _ThongtinBN.KhamBenh.NgaySD != "" && HTC.ShareVariables.pub_spC == "PH"))
                        ReportData2 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, _LoaiPhieu, _LoaiPhieu, " and datt <> 0 and noitttt='" + _NoiTT + "'"));
                    else
                        ReportData2 = (HTC.Business.DataProvider.Instance().RptGetKhambenh_PhieuThu(false, _ThongtinBN.KhamBenh.MaSoKham, 0, _LoaiPhieu, " and noitttt='" + _NoiTT + "'"));


                    if (ReportData2.Tables[0].Rows.Count > 0)
                    {
                        if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "0" && HTC.ShareVariables.pub_spC == "HU" && _LoaiPhieu == 1)
                            sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuTDGA4_RPT.rpt";
                        else if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) != "0" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _LoaiPhieu == 1)
                            sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuTA4_RPT.rpt";
                        else if (((HTC.ShareVariables.pub_spC == "HU" && HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ ")))
                            sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuDGA4Hue1.rpt";
                        else if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "PH")
                            sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuDGA4.rpt";
                        else if (_LoaiPhieu == 7 && ((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093"))
                            sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRKhamBenh_DonThuoc_DYA5.rpt";
                        else if (_LoaiPhieu == 7 || _LoaiPhieu == 3)
                            sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRKhamBenh_PhieuThu_rpt.rpt";
                        else if ((HTC.ShareVariables.pub_spC == "PS"))
                            sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThu.rpt";
                        else if (HTC.ShareVariables.pub_spC == "QN")
                            sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuTDGVP_rpt.rpt";
                        else if (HTC.ShareVariables.pub_spC == "HH")
                            sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuTDG_rpt.rpt";
                        else if (HTC.ShareVariables.pub_spC == "YH")
                            sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuTDG_rpt.rpt";
                        rpt2.Load(Server.MapPath(sPath));
                        Myformulas2 = rpt2.DataDefinition.FormulaFields;
                        Myformulas2["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                        if (HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ ")
                        {
                            Myformulas2["TenQuay"].Text = "'" + Pub_sTenQuay + "'";
                        }
                        if (_LoaiPhieu == 7 && (_NoiTT == "087" || _NoiTT == "090"))
                            Myformulas2["TenBC"].Text = "'" + ("ĐƠN THUỐC") + "'";
                        else if (_LoaiPhieu == 3)
                            Myformulas2["TenBC"].Text = "'" + ("PHIẾU BÁN THUỐC") + "'";
                        else if (_LoaiPhieu == 7 && HTC.ShareVariables.pub_spC == "PS")
                            Myformulas2["TenBC"].Text = "'" + ("PHIẾU THU TIỀN") + "'";
                        else if (_LoaiPhieu == 7)
                            Myformulas2["TenBC"].Text = "'" + ("PHIẾU BÁN THUỐC") + "'";
                        else if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN"))
                            Myformulas2["TenBC"].Text = "'" + ("PHIẾU THU DỊCH VỤ Y TẾ") + "'";
                        else if (_LoaiPhieu != 7)
                            Myformulas2["TenBC"].Text = "'" + ("PHIẾU DỊCH VỤ") + "'";
                        Myformulas2["mabn"].Text = "'*" + _ThongtinBN.MaBN + "*'";
                        if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && inlai == false)
                            Myformulas2["SoPhieuThu"].Text = "'" + txtKyhieu.Text + txtsohd.Text + "'";
                        else if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && inlai == true)
                            Myformulas2["SoPhieuThu"].Text = "'" + _SoSoHD + _SoHD + "'";

                        if (txtNoiLamViec.Text == "" && _NoiTT == "095")
                            Myformulas2["DiaChi"].Text = "'" + (txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "")).Replace("'", "''") + "'";
                        else if (txtNoiLamViec.Text != "" && _NoiTT == "095")
                            Myformulas2["DiaChi"].Text = "'" + txtNoiLamViec.Text.Replace("'", "''") + "'";
                        else if (!(txtDiaChi.Text == "" && cbohuyen.Text == "" && _LoaiPhieu != 7))
                            Myformulas2["DiaChi"].Text = "'" + (txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "")).Replace("'", "''") + "'"; ;


                        //if (!(txtDiaChi.Text == "" && cbohuyen.Text == "" && _LoaiPhieu != 7))
                        //    Myformulas2["DiaChi"].Text = "'" + (txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "")).Replace("'", "''") + "'"; ;
                        // Myformulas2["DiaChi"].Text = "'" + txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "") + "'";

                        if ((_LoaiPhieu == 7 || _LoaiPhieu == 3) && (!((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093")))
                        {
                            Myformulas2["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV + "'";
                            Myformulas2["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                            Myformulas2["DiaChiBV"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV + "'";
                            Myformulas2["NgayBC"].Text = "'" + "Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                            Myformulas2["HoTen"].Text = "'" + txthoten.Text.Replace("'", "''").ToUpper() + "'";
                            Myformulas2["NGAYDK"].Text = "'" + dtNgayDK.Text + "'";
                            Myformulas2["masokham"].Text = "'" + _ThongtinBN.KhamBenh.MaSoKham + "'";
                            Myformulas2["mabn"].Text = "'*" + _ThongtinBN.MaBN + "*'";
                            Myformulas2["Tuoi"].Text = "'" + txttuoi.Text + "'";
                            Myformulas2["GT"].Text = "'" + (optGT.Items[0].Selected == true ? " Nam" : "Nữ") + "'";
                            Myformulas2["DoiTuong"].Text = "'" + cboDoiTuong.SelectedItem.Text + "'";
                            Myformulas2["TenNguoiYC"].Text = "'" + Pub_sTenNguoiSD + "'";
                        }
                        else if (_LoaiPhieu == 7 && ((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093"))
                        {
                            Myformulas2["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                            Myformulas2["DiaChiBV"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV + "'";
                            Myformulas2["NgayBC"].Text = "'" + "Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                            Myformulas2["TenBN"].Text = "'" + txthoten.Text.Replace("'", "''").ToUpper() + "'";
                            Myformulas2["BacSy"].Text = "'" + Pub_sTenNguoiSD + "'";
                            Myformulas2["NguoiLap"].Text = "'Người lập'";
                            Myformulas2["Tuoi"].Text = "'" + txttuoi.Text + "'";
                            Myformulas2["GioiTinh"].Text = "'" + (optGT.Items[0].Selected == true ? " Nam" : "Nữ") + "'";
                            Myformulas2["SoTheBHYT"].Text = "'" + (txtSoThe.Text).ToUpper() + "'";
                            Myformulas2["TenDT"].Text = "'" + cboDoiTuong.SelectedItem.Text + "'";
                            Myformulas2["mg"].Text = "" + _ThongtinBN.KhamBenh.MienGiam + "";
                        }
                        else
                        {
                            Myformulas2["bn"].Text = "'" + _ThongtinBN.MaBN + "'";
                            if (HTC.ShareVariables.pub_spC == "PS")
                            {
                                if (_ThongtinBN.KhamBenh.bhtra == 100)
                                    Myformulas2["doituong"].Text = "'<BN phải trả 0 %>'";

                                else
                                    Myformulas2["doituong"].Text = "'<BN phải trả " + (100 - _ThongtinBN.KhamBenh.bhtra).ToString("###") + " %>'";
                            }
                            else
                                Myformulas2["doituong"].Text = "'" + cboDoiTuong.SelectedItem.Text + "'";

                            Myformulas2["NGAYDK"].Text = "'" + dtNgayDK.Text + "'";
                            Myformulas2["hoten"].Text = "'" + txthoten.Text.Replace("'", "''").ToUpper() + "'";
                            Myformulas2["masokham"].Text = "'*" + _ThongtinBN.KhamBenh.MaSoKham + "*'";
                            //if (_LoaiPhieu == 2 || _LoaiPhieu ==1||_LoaiPhieu ==1)
                            Myformulas2["sothe"].Text = "'" + txtSoThe.Text + "'";
                            Myformulas2["denngay"].Text = "'" + dtBHYTDN.Text + "'";
                            Myformulas2["tungay"].Text = "'" + dtBHYTTN.Text + "'";
                            Myformulas2["noidk"].Text = "'" + cboDKBD.Text + "-" + txtDKBD.Text.Replace("'", "''") + "'";
                            Myformulas2["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";
                            Myformulas2["mg"].Text = "" + _ThongtinBN.KhamBenh.MienGiam + "";
                            if (_NoiTT == "087" || _NoiTT == "095")
                            {
                                Myformulas2["khoakb"].Text = "'" + HTC.ShareVariables.pub_sTenPK + "'";
                            }
                            else if (_NoiTT == "091")
                            {
                                Myformulas2["khoakb"].Text = "'" + HTC.ShareVariables.pub_sTenPK091 + "'";
                            }
                            else if (_NoiTT == "092")
                            {
                                Myformulas2["khoakb"].Text = "'" + HTC.ShareVariables.pub_sTenPK092 + "'";
                            }
                            if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                            {
                                Myformulas2["ChanDoanBD"].Text = "'" + _ThongtinBN.KhamBenh.KhamBenh_C_List[0].maicd + "-" + _ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbenh + "'";
                                Myformulas2["BacSy"].Text = "'" + _ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbschidinh + "'";
                                if (cboKhoaKB.SelectedValue != "")
                                    Myformulas2["Khoa"].Text = "'" + cboKhoaKB.Text + "'";
                                else if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                                    Myformulas2["Khoa"].Text = "'Phòng khám'";
                                else
                                    Myformulas2["Khoa"].Text = "'" + _ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenkhoa + "'";
                            }
                            Myformulas2["Tuoi"].Text = "'" + dtNgaySinh.Text.Substring(6, 4) + "'";

                            Myformulas2["GT"].Text = "'" + (optGT.Items[0].Selected == true ? "Nam" : "Nữ") + "'";
                            if (sPath == Request.ApplicationPath + "/UI/PhongKham/Reports/crKhambenh_PhieuThuT_rpt.rpt")
                            {
                                Myformulas2["nguoilap"].Text = "'Người lập'";
                                Myformulas2["BacSy"].Text = "'" + Pub_sTenNguoiSD + "'";

                            }
                            else
                                Myformulas2["TenNguoiYC"].Text = "'" + Pub_sTenNguoiSD + "'";

                            if (inlai == true)
                            {
                                Myformulas2["inlai"].Text = "'In lại'";
                                if (_LoaiPhieu != 1)
                                {
                                    KhamBenh_HoaDon hd = _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.FirstOrDefault(X => X.SoHD == sohd);
                                    if (hd != null)
                                        Myformulas2["TenNguoiYC"].Text = "'" + hd.tenNguoiThu + "'";
                                }

                            }
                            else if (HTC.ShareVariables.pub_spC == "PH" && sosohd == "" && (_LoaiPhieu == 9 || _LoaiPhieu == 8) && _ThongtinBN.KhamBenh.KyQuyBH != "")
                                Myformulas2["inlai"].Text = "'Chưa thanh toán'";
                            Myformulas2["Ngayin"].Text = "'Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                        }
                        rpt2.SetDataSource(ReportData2);
                        //if (HTC.ShareVariables.pub_spC == "YH")
                        //    PrintExportDirect(rpt2, true, sohd);
                        //else
                        PrintExport(rpt2, sohd);
                        rpt2.Dispose(); rpt2 = null;// HTCReportViewer2.LoadReport(rpt2, true, false);
                    }

                }
            }


            ReportData1 = null;
            ReportData2 = null;
        }
        catch (Exception ex)
        {
            //ShowMessage(MessageType.ERROR, FormAction.REPORTS);
            ShowMessage(ex.Message);
        }
    }

    public void PrintDataPT(bool isFetchData = true, Boolean inlai = false)
    {
        try
        {
            if (inlai == true)
            {
                _KhamBenh_DongTienList = KhamBenh_DongTienList.GetAllKhamBenh_DongTien(_ThongtinBN.KhamBenh.MaSoKham);

                if (_KhamBenh_DongTienList == null) return;
                foreach (KhamBenh_DongTien _kb in _KhamBenh_DongTienList)
                {
                    if ((_kb.MaLDThuTien == "00001" || _kb.MaLDThuTien == "00002" || (HTC.ShareVariables.pub_spC == "PH" && (_kb.MaLDThuTien == "00030" || _kb.MaLDThuTien == "00031"))))
                    {
                        String sPath = string.Empty;

                        sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRPhieuTamThuPK1.rpt";

                        ReportDocument rpt = new ReportDocument();
                        rpt.Load(Server.MapPath(sPath));


                        FormulaFieldDefinitions Myformulas = rpt.DataDefinition.FormulaFields;

                        Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan.ToUpper() + "'";
                        Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV.ToUpper() + "'";
                        Myformulas["hoten"].Text = "'" + txthoten.Text.Replace("'", "''").ToUpper() + "'";
                        Myformulas["Tuoi"].Text = "'" + txttuoi.Text + "'";
                        Myformulas["maba"].Text = "'" + _ThongtinBN.MaBN + "'";
                        //Myformulas["madv"].Text = "'" + _TaiKhoan + "'";
                        Myformulas["khoa"].Text = "'" + cboKhoaKB.Text + "'";
                        Myformulas["TenBC"].Text = "'PHIẾU TẠM THU'";
                        if (_kb.SoTien != "")
                        {
                            Myformulas["sotien"].Text = _kb.SoTien.Replace(",", "");
                        }


                        if (_kb.SPThu.Length == 9)
                        {
                            Myformulas["so"].Text = "'" + _kb.SPThu.Substring(_kb.SPThu.Length - 5, 5) + "'";
                            Myformulas["quyenso"].Text = "'" + _kb.SPThu.Substring(0, 4) + "'";
                        }
                        else if (_kb.SPThu.Length == 13)
                        {
                            Myformulas["so"].Text = "'" + _kb.SPThu.Substring(_kb.SPThu.Length - 6, 6) + "'";
                            Myformulas["quyenso"].Text = "'" + _kb.SPThu.Substring(0, 7) + "'";
                        }
                        else
                        {
                            Myformulas["so"].Text = "'" + _kb.SPThu.Substring(_kb.SPThu.Length - 8, 8) + "'";
                            Myformulas["quyenso"].Text = "'" + _kb.SPThu.Substring(0, 9) + "'";
                        }


                        Myformulas["diachibv"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV.ToUpper() + "'";
                        Myformulas["SoThe"].Text = "'" + txtSoThe.Text + "'";

                        //Myformulas["DiaChi"].Text = "'" + _BenhAn_Khoa.Diachi + " " + _BenhAn_Khoa.TenQH + " " + _BenhAn_Khoa.TenTinh + "'";
                        if (!(txtDiaChi.Text == "" && cbohuyen.Text == "" && _LoaiPhieu != 7))
                            //  Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text + " - " + cbohuyen.Text + "- " + cbotinh.Text + "'";
                            Myformulas["DiaChi"].Text = "'" + (txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "")).Replace("'", "''") + "'"; ;


                        Myformulas["GT"].Text = "'" + (optGT.Items[0].Selected == true ? "Nam" : "Nữ") + "'";

                        Myformulas["NgayPT"].Text = "' Ngày " + DateTime.Now.ToString("dd/MM/yyyy") + "'";

                        DateTime ngayPhieuThu = DateTime.Now;

                        Myformulas["Ngay"].Text = "'" + "Ngày " + ngayPhieuThu.Day + "  tháng  " + ngayPhieuThu.Month + "  năm  " + ngayPhieuThu.Year + "'";
                        //   Myformulas["NgayPT"].Text = "'" + "Ngày " + ngayPhieuThu.Day + "  tháng  " + ngayPhieuThu.Month + "  năm  " + ngayPhieuThu.Year + "'";

                        Myformulas["lydo"].Text = "'" + DMLDThuTien.GetDMLDThuTien(_kb.MaLDThuTien).TenLDThuTien + "'";
                        Myformulas["tennv"].Text = "'" + Pub_sTenNguoiSD + "'";

                        if (!HTC.ShareVariables.pub_spC.Equals("PS"))
                        {
                            Myformulas["doituong"].Text = "' BN :" + cboDoiTuong.Text + "'";
                        }


                        PrintExport(rpt); rpt.Dispose(); rpt = null;// PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer7.LoadReport(rpt, true, false);
                        if (isFetchData == true)
                        {
                            string sql = " UPDATE khambenh_dongtien SET lanin  = lanin+1";
                            sql = sql + " WHERE masokham ='" + _ThongtinBN.KhamBenh.MaSoKham + "'";
                            sql = sql + " and stt in (" + _kb.STT + ")";

                            HTC.Business.DataProvider.Instance().ExcSQL(sql);
                        }
                    }
                }

            }
            else
            {
                if (_KhamBenh_DongTienList == null) return;
                foreach (KhamBenh_DongTien _kb in _KhamBenh_DongTienList)
                {
                    if ((_kb.MaLDThuTien != "00020" && _kb.TenNguoiLap == "") || (HTC.ShareVariables.pub_spC == "PH" && _kb.MaLDThuTien != "00033" && _kb.MaLDThuTien != "00020" && _kb.TenNguoiLap == ""))
                    {
                        String sPath = string.Empty;

                        if (HTC.ShareVariables.pub_spC.Equals("PS", StringComparison.InvariantCultureIgnoreCase))
                            sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRPhieuTamThuPK.rpt";
                        else
                            sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRPhieuTamThuPK1.rpt";

                        ReportDocument rpt = new ReportDocument();
                        rpt.Load(Server.MapPath(sPath));


                        FormulaFieldDefinitions Myformulas = rpt.DataDefinition.FormulaFields;

                        Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan.ToUpper() + "'";
                        Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV.ToUpper() + "'";
                        Myformulas["hoten"].Text = "'" + txthoten.Text.Replace("'", "''").ToUpper() + "'";
                        Myformulas["Tuoi"].Text = "'" + txttuoi.Text + "'";
                        Myformulas["maba"].Text = "'" + _ThongtinBN.MaBN + "'";
                        //Myformulas["madv"].Text = "'" + _TaiKhoan + "'";
                        Myformulas["khoa"].Text = "'" + cboKhoaKB.Text + "'";

                        if (_kb.SoTien != "")
                        {
                            Myformulas["sotien"].Text = _kb.SoTien.Replace(",", "");
                        }


                        if (_kb.SPThu.Length == 9)
                        {
                            Myformulas["so"].Text = "'" + _kb.SPThu.Substring(_kb.SPThu.Length - 5, 5) + "'";
                            Myformulas["quyenso"].Text = "'" + _kb.SPThu.Substring(0, 4) + "'";
                        }
                        else
                        {
                            Myformulas["so"].Text = "'" + _kb.SPThu.Substring(_kb.SPThu.Length - 8, 8) + "'";
                            Myformulas["quyenso"].Text = "'" + _kb.SPThu.Substring(0, 9) + "'";
                        }
                        if (HTC.ShareVariables.pub_spC == "YH")
                            Myformulas["TenBC"].Text = "'PHIẾU TẠM THU'";

                        Myformulas["diachibv"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV.ToUpper() + "'";
                        Myformulas["SoThe"].Text = "'" + txtSoThe.Text + "'";

                        //Myformulas["DiaChi"].Text = "'" + _BenhAn_Khoa.Diachi + " " + _BenhAn_Khoa.TenQH + " " + _BenhAn_Khoa.TenTinh + "'";
                        if (!(txtDiaChi.Text == "" && cbohuyen.Text == "" && _LoaiPhieu != 7))
                            Myformulas["DiaChi"].Text = "'" + (txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "")).Replace("'", "''") + "'"; ;


                        Myformulas["GT"].Text = "'" + (optGT.Items[0].Selected == true ? "Nam" : "Nữ") + "'";

                        Myformulas["NgayPT"].Text = "' Ngày " + DateTime.Now.ToString("dd/MM/yyyy") + "'";

                        DateTime ngayPhieuThu = DateTime.Now;

                        Myformulas["Ngay"].Text = "'" + "Ngày " + ngayPhieuThu.Day + "  tháng  " + ngayPhieuThu.Month + "  năm  " + ngayPhieuThu.Year + "'";
                        //   Myformulas["NgayPT"].Text = "'" + "Ngày " + ngayPhieuThu.Day + "  tháng  " + ngayPhieuThu.Month + "  năm  " + ngayPhieuThu.Year + "'";

                        Myformulas["lydo"].Text = "'" + DMLDThuTien.GetDMLDThuTien(_kb.MaLDThuTien).TenLDThuTien + "'";
                        Myformulas["tennv"].Text = "'" + Pub_sTenNguoiSD + "'";

                        if (!HTC.ShareVariables.pub_spC.Equals("PS"))
                        {
                            Myformulas["doituong"].Text = "' BN :" + cboDoiTuong.Text + "'";
                        }


                        PrintExport(rpt); rpt.Dispose(); rpt = null;//   PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer7.LoadReport(rpt, true, false);
                    }
                }

            }
        }
        catch (Exception ex)
        {
            ShowMessage("Có lỗi trong quá trình in phiếu thu" + ex.Message);
        }
    }
    public void PrintDataPTHD(KhamBenh_HoaDon _KhamBenh_HoaDon = null)
    {
        try
        {

            //    _KhamBenh_DongTienList = KhamBenh_DongTienList.GetAllKhamBenh_DongTien(_ThongtinBN.KhamBenh.MaSoKham);

            //    if (_KhamBenh_DongTienList == null) return;

            //    for (int i = _KhamBenh_DongTienList.Count - 1; i >= 0; i--)
            //    {
            //        KhamBenh_DongTien _kb = _KhamBenh_DongTienList[i];
            //        if ((_kb.MaLDThuTien == "00008"))
            //        {
            //            String sPath = string.Empty;

            //            if (HTC.ShareVariables.pub_spC.Equals("PS", StringComparison.InvariantCultureIgnoreCase))
            //                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRPhieuTamThuPK.rpt";
            //            else
            //                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRPhieuTamThuPK1.rpt";

            //            ReportDocument rpt = new ReportDocument();
            //            rpt.Load(Server.MapPath(sPath));


            //            FormulaFieldDefinitions Myformulas = rpt.DataDefinition.FormulaFields;

            //            Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan.ToUpper() + "'";
            //            Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV.ToUpper() + "'";
            //            Myformulas["hoten"].Text = "'" + txthoten.Text.Replace("'", "''").ToUpper() + "'";
            //            Myformulas["Tuoi"].Text = "'" + txttuoi.Text + "'";
            //            Myformulas["maba"].Text = "'" + _ThongtinBN.MaBN + "'";
            //            //Myformulas["madv"].Text = "'" + _TaiKhoan + "'";
            //            Myformulas["khoa"].Text = "'" + cboKhoaKB.Text + "'";
            //            // if (HTC.ShareVariables.pub_spC == "YH")
            //            Myformulas["TenBC"].Text = "'PHIẾU THU'";
            //            if (_kb.SoTien != "")
            //            {
            //                Myformulas["sotien"].Text = _kb.SoTien.Replace(",", "");
            //            }


            //            if (_kb.SPThu.Length == 9)
            //            {
            //                Myformulas["so"].Text = "'" + _kb.SPThu.Substring(_kb.SPThu.Length - 5, 5) + "'";
            //                Myformulas["quyenso"].Text = "'" + _kb.SPThu.Substring(0, 4) + "'";
            //            }
            //            else if (_kb.SPThu.Length == 13)
            //            {
            //                Myformulas["so"].Text = "'" + _kb.SPThu.Substring(_kb.SPThu.Length - 6, 6) + "'";
            //                Myformulas["quyenso"].Text = "'" + _kb.SPThu.Substring(0, 7) + "'";
            //            }
            //            else
            //            {
            //                Myformulas["so"].Text = "'" + _kb.SPThu.Substring(_kb.SPThu.Length - 8, 8) + "'";
            //                Myformulas["quyenso"].Text = "'" + _kb.SPThu.Substring(0, 9) + "'";
            //            }


            //            Myformulas["diachibv"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV.ToUpper() + "'";
            //            Myformulas["SoThe"].Text = "'" + txtSoThe.Text + "'";

            //            //Myformulas["DiaChi"].Text = "'" + _BenhAn_Khoa.Diachi + " " + _BenhAn_Khoa.TenQH + " " + _BenhAn_Khoa.TenTinh + "'";
            //            if (!(txtDiaChi.Text == "" && cbohuyen.Text == "" && _LoaiPhieu != 7))
            //                Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text + " - " + cbohuyen.Text + "- " + cbotinh.Text + "'";


            //            Myformulas["GT"].Text = "'" + (optGT.Items[0].Selected == true ? "Nam" : "Nữ") + "'";

            //            Myformulas["NgayPT"].Text = "' Ngày " + DateTime.Now.ToString("dd/MM/yyyy") + "'";

            //            DateTime ngayPhieuThu = DateTime.Now;

            //            Myformulas["Ngay"].Text = "'" + "Ngày " + ngayPhieuThu.Day + "  tháng  " + ngayPhieuThu.Month + "  năm  " + ngayPhieuThu.Year + "'";
            //            //   Myformulas["NgayPT"].Text = "'" + "Ngày " + ngayPhieuThu.Day + "  tháng  " + ngayPhieuThu.Month + "  năm  " + ngayPhieuThu.Year + "'";

            //            Myformulas["lydo"].Text = "'" + DMLDThuTien.GetDMLDThuTien(_kb.MaLDThuTien).TenLDThuTien + "'";
            //            if (_kb.TenNguoiThu != "")
            //                Myformulas["tennv"].Text = "'" + _kb.TenNguoiThu + "'";
            //            else
            //                Myformulas["tennv"].Text = "'" + Pub_sTenNguoiSD + "'";

            //            if (!HTC.ShareVariables.pub_spC.Equals("PS"))
            //            {
            //                Myformulas["doituong"].Text = "' BN :" + cboDoiTuong.SelectedItem.Text  + "'";
            //            }


            //            PrintExport(rpt); rpt.Dispose(); rpt = null;// PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer7.LoadReport(rpt, true, false);
            //            break;
            //        }
            //        else if ((_kb.MaLDThuTien == "00020"))
            //        {
            //            String sPath = string.Empty;

            //            sPath = Request.ApplicationPath + "/UI/NoiTru/Reports/CRPhieuChi2006.rpt";

            //            ReportDocument rpt = new ReportDocument();
            //            rpt.Load(Server.MapPath(sPath));


            //            FormulaFieldDefinitions Myformulas = rpt.DataDefinition.FormulaFields;

            //            Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";

            //            Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV.ToUpper() + "'";
            //            Myformulas["hoten"].Text = "'" + txthoten.Text.Replace("'", "''").ToUpper() + "'";
            //            Myformulas["Tuoi"].Text = "'" + txttuoi.Text + "'";
            //            Myformulas["maba"].Text = "'" + _ThongtinBN.MaBN + "'";
            //            //Myformulas["madv"].Text = "'" + _TaiKhoan + "'";
            //            Myformulas["khoa"].Text = "'" + cboKhoaKB.Text + "'";
            //            if (_kb.SoTien != "")
            //            {
            //                Myformulas["sotien"].Text = _kb.SoTien.Replace(",", "");
            //            }
            //            if (_kb.SPThu.Length == 9)
            //            {
            //                Myformulas["so"].Text = "'" + _kb.SPThu.Substring(_kb.SPThu.Length - 5, 5) + "'";
            //                Myformulas["quyenso"].Text = "'" + _kb.SPThu.Substring(0, 4) + "'";
            //            }
            //            else if (_kb.SPThu.Length == 13)
            //            {
            //                Myformulas["so"].Text = "'" + _kb.SPThu.Substring(_kb.SPThu.Length - 6, 6) + "'";
            //                Myformulas["quyenso"].Text = "'" + _kb.SPThu.Substring(0, 7) + "'";
            //            }
            //            else
            //            {
            //                Myformulas["so"].Text = "'" + _kb.SPThu.Substring(_kb.SPThu.Length - 8, 8) + "'";
            //                Myformulas["quyenso"].Text = "'" + _kb.SPThu.Substring(0, 9) + "'";
            //            }
            //            //Myformulas["so"].Text = "'" + TextBox1.Text + "'";                
            //            if (_NoiTT == "085" || _NoiTT == "093")
            //                Myformulas["diachibv"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV.ToUpper() + "'";
            //            else
            //                Myformulas["diachibv"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV087.ToUpper() + "'";
            //            Myformulas["SoThe"].Text = "'" + txtSoThe.Text + "'";

            //            //Myformulas["DiaChi"].Text = "'" + _BenhAn_Khoa.DiaChi + " " + _BenhNhan.TenQH + " " + _BenhNhan.TenTinh + "'";
            //            if (!(txtDiaChi.Text == "" && cbohuyen.Text == "" && _LoaiPhieu != 7))
            //                Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text.Replace("'", "''") + "'";

            //            DateTime ngayPhieuChi = DateTime.Now;

            //            Myformulas["GT"].Text = "'" + (optGT.Items[0].Selected == true ? "Nam" : "Nữ") + "'";
            //            Myformulas["NgayPT"].Text = "' Ngày " + ngayPhieuChi.ToString("dd/MM/yyyy") + "'";
            //            Myformulas["Ngay"].Text = "'" + "Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";

            //            Myformulas["lydo"].Text = "'" + DMLDThuTien.GetDMLDThuTien(_kb.MaLDThuTien).TenLDThuTien + "'";
            //            PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer3.LoadReport(rpt,true,false);
            //            break;
            //        }
            //    }
            //}
            if (_KhamBenh_HoaDon != null)
            {
                if (_KhamBenh_HoaDon.TongThu != 0 && _KhamBenh_HoaDon.TongChi == 0)
                    if (HTC.Business.DataProvider.Instance().KiemTraHoaDon(_KhamBenh_HoaDon.MaSoKham, _KhamBenh_HoaDon.SoSoHD, _KhamBenh_HoaDon.SoHD, _LoaiPhieu) == "")
                    {
                        ShowMessage("Không thể thanh toán được hóa đơn!Phải thanh toán lại hóa đơn này");
                        Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={0}&&noitt={1}&duyet={2}&pubmadt={5}&&maBN={3}&&ngayDK={4}", _LoaiPhieu, _NoiTT, _Duyet, txtmabn.Text, DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), _PubMaDT), false);

                        return;

                    }
            }
            string sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRPhieuTamThuPK.rpt";

            ReportDocument rpt = new ReportDocument();
            rpt.Load(Server.MapPath(sPath));
            FormulaFieldDefinitions Myformulas = rpt.DataDefinition.FormulaFields;
            Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan.ToUpper() + "'";
            Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV.ToUpper() + "'";
            Myformulas["hoten"].Text = "'" + txthoten.Text.Replace("'", "''").ToUpper() + "'";
            Myformulas["Tuoi"].Text = "'" + txttuoi.Text + "'";
            Myformulas["maba"].Text = "'" + _ThongtinBN.MaBN + "'";
            //Myformulas["madv"].Text = "'" + _TaiKhoan + "'";
            Myformulas["khoa"].Text = "'" + cboKhoaKB.Text + "'";

            Myformulas["TenBC"].Text = "'PHIẾU THU TIỀN'";
            if (_KhamBenh_HoaDon == null)
            {
                Myformulas["sotien"].Text = txtTongHD.Text.Replace(",", "");
                Myformulas["so"].Text = "'" + txtsohd.Text + "'";
                Myformulas["quyenso"].Text = "'" + txtKyhieu.Text + "'";
            }
            else
            {
                Myformulas["sotien"].Text = _KhamBenh_HoaDon.TongThu.ToString().Replace(",", "");
                Myformulas["so"].Text = "'" + _KhamBenh_HoaDon.SoHD + "'";
                Myformulas["quyenso"].Text = "'" + _KhamBenh_HoaDon.SoSoHD + "'";
            }
            Myformulas["lydo"].Text = "'" + _KhamBenh_HoaDon.LydoThu.Replace("'", "''") + "'";

            if (txtkyquy.Text != "")
                Myformulas["tamthu"].Text = "" + decimal.Parse(txtkyquy.Text) + "";
            Myformulas["diachibv"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV.ToUpper() + "'";
            Myformulas["SoThe"].Text = "'" + txtSoThe.Text + "'";

            //Myformulas["DiaChi"].Text = "'" + _BenhAn_Khoa.Diachi + " " + _BenhAn_Khoa.TenQH + " " + _BenhAn_Khoa.TenTinh + "'";
            Myformulas["DiaChi"].Text = "'" + (txtDiaChi.Text + " - " + cbohuyen.Text + "- " + cbotinh.Text).Replace("'", "''") + "'";


            Myformulas["GT"].Text = "'" + (optGT.Items[0].Selected == true ? "Nam" : "Nữ") + "'";

            Myformulas["NgayPT"].Text = "' Ngày " + DateTime.Now.ToString("dd/MM/yyyy") + "'";

            DateTime ngayPhieuThu = DateTime.Now;

            Myformulas["Ngay"].Text = "'" + "Ngày " + ngayPhieuThu.Day + "  tháng  " + ngayPhieuThu.Month + "  năm  " + ngayPhieuThu.Year + "'";
            //   Myformulas["NgayPT"].Text = "'" + "Ngày " + ngayPhieuThu.Day + "  tháng  " + ngayPhieuThu.Month + "  năm  " + ngayPhieuThu.Year + "'";
            if (_KhamBenh_HoaDon.tenNguoiThu != "")
                Myformulas["tennv"].Text = "'" + _KhamBenh_HoaDon.tenNguoiThu + "'";
            else
                Myformulas["tennv"].Text = "'" + Pub_sTenNguoiSD + "'";

            Myformulas["doituong"].Text = "'" + cboDoiTuong.SelectedItem.Text + "'";



            PrintExport(rpt); rpt.Dispose(); rpt = null;// PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer7.LoadReport(rpt, true, false);
        }
        catch (Exception ex)
        {
            ShowMessage("Không in được phiếu thu" + ex.Message);
        }
    }

    public void PrintDataHoanDV(string sosohd = "1", string sohd = "1")
    {
        try
        {

            foreach (KhamBenh_HoaDon hd in _ThongtinBN.KhamBenh.KhamBenh_HoaDonList)
            {
                if ((hd.TongThu == hd.TongChi && hd.TongChiCu == 0 && hd.TongThu != 0) || (hd.SoSoHD == sosohd && hd.SoHD == sohd && hd.NgayThu.Substring(0, 10) != DateTime.Now.ToString("dd/MM/yyyy")))
                {
                    String sPath = string.Empty;

                    sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRPhieuThuChi.rpt";

                    ReportDocument rpt = new ReportDocument();
                    rpt.Load(Server.MapPath(sPath));


                    FormulaFieldDefinitions Myformulas = rpt.DataDefinition.FormulaFields;

                    Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan + "'";

                    Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV.ToUpper() + "'";
                    Myformulas["hoten"].Text = "'" + txthoten.Text.Replace("'", "''").ToUpper() + "'";
                    Myformulas["conlai"].Text = "'Số tiền phải trả BN '";
                    if (!(txtDiaChi.Text == "" && cbohuyen.Text == "" && _LoaiPhieu != 7))
                        //  Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "") + "'";
                        Myformulas["DiaChi"].Text = "'" + (txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "")).Replace("'", "''") + "'"; ;
                    Myformulas["tongthu"].Text = "'" + hd.TongThu.ToString("###,###") + "'";
                    Myformulas["lydo"].Text = "'Trả tiền khám bệnh nhân'";

                    Myformulas["loai"].Text = "1";
                    if (decimal.Parse(txtTongHD.Text == "" ? "0" : txtTongHD.Text) > 0)
                        Myformulas["tongdung"].Text = "'" + txtTongHD.Text + "'";
                    else
                        Myformulas["tongdung"].Text = "'" + (0 - decimal.Parse(txtTongHD.Text == "" ? "0" : txtTongHD.Text)).ToString("###,###") + "'";
                    Myformulas["sotien"].Text = "" + (hd.TongThu - decimal.Parse(txtTongHD.Text == "" ? "0" : txtTongHD.Text)).ToString() + "";
                    if (HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ ")
                    {
                        Myformulas["tongdung"].Text = "'0'";
                        Myformulas["sotien"].Text = "" + hd.TongThu + "";
                    }

                    DateTime ngayPhieuChi = DateTime.Now;

                    Myformulas["Ngay"].Text = "'" + "Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";

                    PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer3.LoadReport(rpt,true,false);
                }

            }
        }

        catch (Exception ex)
        {
            ShowMessage(MessageType.ERROR, FormAction.REPORTS);
        }
    }

    public void PrintDataPhieuChi(KhamBenh_DongTien kb)
    {
        try
        {
            String sPath = string.Empty;

            if (HTC.ShareVariables.pub_spC.Equals("YH", StringComparison.InvariantCultureIgnoreCase))
                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRPhieuChi2006.rpt";
            else
                sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRPhieuChi20063.rpt";

            ReportDocument rpt = new ReportDocument();
            rpt.Load(Server.MapPath(sPath));

            FormulaFieldDefinitions Myformulas = rpt.DataDefinition.FormulaFields;

            Myformulas["TenDVCQ"].Text = "'" + HTC.ShareVariables.pub_sTenDVChuQuan.ToUpper() + "'";
            Myformulas["TenBV"].Text = "'" + HTC.ShareVariables.pub_sTenBV.ToUpper() + "'";
            Myformulas["hoten"].Text = "'" + txthoten.Text.Replace("'", "''").ToUpper() + "'";
            Myformulas["Tuoi"].Text = "'" + txttuoi.Text + "'";
            if (HTC.ShareVariables.pub_spC == "HU")
            {
                Myformulas["mabn"].Text = "'" + txtmabn.Text + "'";
                Myformulas["MaSoKham"].Text = "'" + _MaSoKham + "'";

            }
            else
            {
                Myformulas["mabn"].Text = "'" + txtmabn.Text + "'";
            }


            Myformulas["sotien"].Text = kb.SoTien.Replace(",", "");


            if (kb.SPThu.Length == 9)
            {
                Myformulas["so"].Text = "'" + kb.SPThu.Substring(kb.SPThu.Length - 5, 5) + "'";
                Myformulas["quyenso"].Text = "'" + kb.SPThu.Substring(0, 4) + "'";
            }
            else if (kb.SPThu.Length == 13)
            {
                Myformulas["so"].Text = "'" + kb.SPThu.Substring(kb.SPThu.Length - 6, 6) + "'";
                Myformulas["quyenso"].Text = "'" + kb.SPThu.Substring(0, 7) + "'";
            }
            else if (kb.SPThu.Length == 17)
            {
                Myformulas["so"].Text = "'" + kb.SPThu.Substring(kb.SPThu.Length - 8, 8) + "'";
                Myformulas["quyenso"].Text = "'" + kb.SPThu.Substring(0, 9) + "'";
            }
            else if (kb.SPThu.Length > 9)
            {
                Myformulas["so"].Text = "'" + kb.SPThu.Substring(kb.SPThu.Length - 8, 8) + "'";
                Myformulas["quyenso"].Text = "'" + kb.SPThu.Substring(0, 9) + "'";
            }
            else if (kb.SPThu.Length < 9)
            {
                Myformulas["so"].Text = "'" + kb.SPThu + "'";

            }

            Myformulas["diachibv"].Text = "'" + HTC.ShareVariables.pub_sDiaChiBV.ToUpper() + "'";

            //Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text + " " + _ThongtinBN.TenQH + " " + _ThongtinBN.TenTinh + "'";
            Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text.Replace("'", "''") + "'";


            Myformulas["GT"].Text = "'" + (optGT.Items[0].Selected == true ? "Nam" : "Nữ") + "'";
            if (HTC.ShareVariables.pub_spC == "HU" && kb.NgayLap == "")
                Myformulas["NgayPT"].Text = "' Ngày " + DateTime.Now.ToString("dd/MM/yyyy HH:mm") + "'";
            else if (HTC.ShareVariables.pub_spC == "HU" && kb.NgayLap != "")
                Myformulas["NgayPT"].Text = "' Ngày " + DateTime.Parse(kb.NgayLap).ToString("dd/MM/yyyy HH:mm") + "'";
            else
                Myformulas["NgayPT"].Text = "' Ngày " + kb.NgayDong + "'";

            DateTime ngayPhieuThu = DateTime.Parse(kb.NgayDong);

            Myformulas["Ngay"].Text = "'" + "Ngày " + DateTime.Now.Day + "  tháng  " + DateTime.Now.Month + "  năm  " + DateTime.Now.Year + "'";
            //   Myformulas["NgayPT"].Text = "'" + "Ngày " + ngayPhieuThu.Day + "  tháng  " + ngayPhieuThu.Month + "  năm  " + ngayPhieuThu.Year + "'";
            if (HTC.ShareVariables.pub_spC == "HU")
            {
                Myformulas["lydo"].Text = "'" + kb.TenLDThuTien + "'";
                Myformulas["ghichu"].Text = "'" + txtGhiChu.Text + "'";

            }
            else
            {
                Myformulas["lydo"].Text = "'" + kb.TenLDThuTien + "'";

            }
            if (kb.TenNguoiLap != "")
                Myformulas["tennv"].Text = "'" + kb.TenNguoiLap + "'";

            else
                Myformulas["tennv"].Text = "'" + Pub_sTenNguoiSD + "'";



            PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer1.LoadReport(rpt,true,false);

        }
        catch (Exception ex)
        {

            ShowMessage("Không thể xem được báo cáo" + ex.Message);
        }
    }

    private bool ValidateForm(GridEditableItem editedItem)
    {
        return true;
    }

    protected void odsThuoc_VT_HC_M_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {
        SetObject();
        e.InputParameters["maKhoa"] = "011";
        if (_LoaiPhieu != 2)
            e.InputParameters["maDT"] = "00001";
        else
            e.InputParameters["maDT"] = _MaDT;
        //ShowMessage(txthienthi.Text);
        //  e.InputParameters["Ten"] = txthienthi.Text;
    }
    protected void odsDichVu_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {

        if (_LoaiPhieu == 2 || (_LoaiPhieu == 1 && cboDoiTuong.SelectedValue.Substring(0, 1) != "0") || cboDoiTuong.SelectedValue.Substring(4, 1) != "1")
            e.InputParameters["maDT"] = _MaDT;
        else
            e.InputParameters["maDT"] = "00001";
        if (HTC.ShareVariables.pub_spC == "PS")
            e.InputParameters["NoiTT"] = _NoiTT + "/" + cboKhoaKB.SelectedValue;
        else
            e.InputParameters["NoiTT"] = _NoiTT;
        // e.InputParameters["MaDV"] = txthienthi.Text;


    }

    protected void cboGoi_SelectedIndexChanged(object sender, RadComboBoxSelectedIndexChangedEventArgs e)
    {

        LoadDetails(true, CurrentTabIndex, true);

    }
    protected void cboBenhVien_ItemDataBound(object sender, RadComboBoxItemEventArgs e)
    {
        DMBenhVien dataItem = e.Item.DataItem as DMBenhVien;

        //if (dataItem == null)
        //    e.Item.Attributes["TenBV"] = "";
        //else
        //    e.Item.Attributes["TenBV"] = dataItem.TenBV.ToString();
        if (dataItem == null)
            e.Item.Attributes["MaBHXH"] = "";
        else
            e.Item.Attributes["MaBHXH"] = dataItem.MaBHXH.ToString();
    }
    protected void ObjectDanhMucBT_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {
        if (CurrentTabIndex == 3)
        {
            e.InputParameters["_loai"] = byte.Parse("1");
            e.InputParameters["mabs"] = cboBSTayY.SelectedValue;
        }
        else
        {
            e.InputParameters["_loai"] = byte.Parse("0");
            e.InputParameters["mabs"] = cboBSDongY.SelectedValue;
        }

    }
    protected void odsNhapHoTroDY_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {
        if (txtmabn.Text != "")
            e.InputParameters["masokham"] = txtmabn.Text;


    }
    protected void odsNhapHoTro_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {

        e.InputParameters["loai"] = _LoaiPhieu;
        if (txtmabn.Text == "")
        {
            e.InputParameters["mabn"] = "01>200000000";
            e.Cancel = true;
        }
        else

            e.InputParameters["mabn"] = txtmabn.Text;
        e.InputParameters["dk"] = "";
    }
    protected void odshuyen_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {
        if (cbotinh.SelectedValue == null)
        {
            e.Cancel = false;
            e.InputParameters["matinh"] = "";
        }
        else
            e.InputParameters["matinh"] = cbotinh.SelectedValue;
    }
    protected void odspxa_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {
        if (cbohuyen.SelectedValue == null)
        {
            e.Cancel = false;
            e.InputParameters["maqh"] = "";
        }
        else
            e.InputParameters["maqh"] = cbohuyen.SelectedValue;
    }
    protected void cboBenh_ItemDataBound(object sender, RadComboBoxItemEventArgs e)
    {
        DMBenhTat dataItem = e.Item.DataItem as DMBenhTat;

        if (dataItem == null)
            e.Item.Attributes["TenBenh"] = "";
        else
            e.Item.Attributes["TenBenh"] = dataItem.TenBenh.ToString();
    }
    protected void grdDichVu_ItemDataBound(object sender, GridItemEventArgs e)
    {
        if (e.Item.IsInEditMode && e.Item is GridEditableItem)
        {
            //  GridBoundColumn colre = e.Item.OwnerTableView.GetColumn("SoLuongYC") as GridBoundColumn;
            //  colre.ReadOnly = true;
            GridEditableItem item = e.Item as GridEditableItem;
            InitTabIndexForRadGrid(((RadGrid)sender), item, 1);
            //if (!(e.Item is IGridInsertItem))
            //{

            //    if (sender.Equals(grdThuoc) || sender.Equals(grdThuocDY))
            //    {
            //        RadComboBox combo = (RadComboBox)item["MaThuoc"].FindControl("cboThuoc");
            //        RadComboBoxItem selectedItem = new RadComboBoxItem();

            //        selectedItem.Text = item.GetDataKeyValue("TenTM").ToString();
            //        selectedItem.Value = item.GetDataKeyValue("MaThuoc").ToString();
            //        combo.Items.Add(selectedItem);
            //        selectedItem.Selected = true;
            //        selectedItem.DataBind();
            //        combo.DataBind();
            //    }


            //    else if (sender.Equals(grdXNTT))
            //    {

            //        RadComboBox comboMa = (RadComboBox)item["MaDVXN"].FindControl("cboMaDichVu");
            //        RadComboBoxItem selectedItemMa = new RadComboBoxItem();

            //        selectedItemMa.Text = item.GetDataKeyValue("MaDV").ToString();
            //        selectedItemMa.Value = item.GetDataKeyValue("MaDV").ToString();
            //        comboMa.Items.Add(selectedItemMa);
            //        selectedItemMa.Selected = true;
            //        selectedItemMa.DataBind();
            //        comboMa.DataBind();

            //        RadComboBox combo = (RadComboBox)item["MaDV"].FindControl("cboDichVu");
            //        RadComboBoxItem selectedItem = new RadComboBoxItem();

            //        selectedItem.Text = item.GetDataKeyValue("TenTM").ToString();
            //        selectedItem.Value = item.GetDataKeyValue("MaDV").ToString();
            //        combo.Items.Add(selectedItem);
            //        selectedItem.Selected = true;
            //        selectedItem.DataBind();
            //        combo.DataBind();
            //    }
            //    //else if (sender.Equals(grdVTTH))
            //    //{
            //    //    RadComboBox combo = (RadComboBox)item["MaVT"].FindControl("cboDichVu");
            //    //    RadComboBoxItem selectedItem = new RadComboBoxItem();

            //    //    selectedItem.Text = item.GetDataKeyValue("TenTM").ToString();
            //    //    selectedItem.Value = item.GetDataKeyValue("MaVT").ToString();
            //    //    combo.Items.Add(selectedItem);
            //    //    selectedItem.Selected = true;
            //    //    selectedItem.DataBind();
            //    //    combo.DataBind();
            //    //}
            //    //else if (sender.Equals(grdHoaChat))
            //    //{
            //    //    RadComboBox combo = (RadComboBox)item["MaHC"].FindControl("cboDichVu");
            //    //    RadComboBoxItem selectedItem = new RadComboBoxItem();

            //    //    selectedItem.Text = item.GetDataKeyValue("TenTM").ToString();
            //    //    selectedItem.Value = item.GetDataKeyValue("MaHC").ToString();
            //    //    combo.Items.Add(selectedItem);
            //    //    selectedItem.Selected = true;
            //    //    selectedItem.DataBind();
            //    //    combo.DataBind();
            //    //}
            //    //else if (sender.Equals(grdMau))
            //    //{
            //    //    RadComboBox combo = (RadComboBox)item["MaThuoc"].FindControl("cboDichVu");
            //    //    RadComboBoxItem selectedItem = new RadComboBoxItem();

            //    //    selectedItem.Text = item.GetDataKeyValue("TenCPMau").ToString();
            //    //    selectedItem.Value = item.GetDataKeyValue("MaThuoc").ToString();
            //    //    combo.Items.Add(selectedItem);
            //    //    selectedItem.Selected = true;
            //    //    selectedItem.DataBind();
            //    //    combo.DataBind();

            //    //}
            //}

            if (item.ItemIndex != -1)
            {

                if (sender.Equals(grdThuoc) || sender.Equals(grdThuocDY))
                {
                    item["MaThuoc"].Enabled = false;
                    RadNumericTextBox dataField = (RadNumericTextBox)item.FindControl("tbSoLuong");

                    dataField.Focus();
                }
                else if (sender.Equals(grdXNTT))
                {
                    item["MaDV"].Enabled = false;
                    item["MaDVXN"].Enabled = false;

                }
                //else if (sender.Equals(grdVTTH))
                //    item["MaVT"].Enabled = false;
                //else if (sender.Equals(grdHoaChat))
                //    item["MaHC"].Enabled = false;
                //else if (sender.Equals(grdMau))
                //    item["MaThuoc"].Enabled = false;
            }
            else
            {

                if (sender.Equals(grdThuoc) || sender.Equals(grdThuocDY))
                {
                    if (grdThuoc.EditItems.Count > 0)
                        e.Item.FireCommandEvent(RadGrid.CancelCommandName, string.Empty);
                    else
                    {

                        item["MaThuoc"].Enabled = true;

                        ((RadComboBox)item["MaThuoc"].FindControl("cboThuoc")).Focus();
                    }
                }
                else if (sender.Equals(grdXNTT))
                {
                    if (grdXNTT.EditItems.Count > 0)
                        e.Item.FireCommandEvent(RadGrid.CancelCommandName, string.Empty);
                    else
                    {

                        item["MaDV"].Enabled = true;
                        item["MaDVXN"].Enabled = true;
                        RadComboBox combo = ((RadComboBox)item["MaDVXN"].FindControl("cboMaDichVu"));


                        combo.Focus();
                    }
                }

                //else if (sender.Equals(grdVTTH))
                //{
                //    if (grdVTTH.EditItems.Count > 0)
                //        e.Item.FireCommandEvent(RadGrid.CancelCommandName, string.Empty);
                //    else
                //    {

                //        item["MaVT"].Enabled = true;

                //        ((RadComboBox)item["MaVT"].FindControl("cboDichVu")).Focus();
                //    }
                //}
                //else if (sender.Equals(grdHoaChat))
                //{

                //    if (grdHoaChat.EditItems.Count > 0)
                //        e.Item.FireCommandEvent(RadGrid.CancelCommandName, string.Empty);
                //    else
                //    {

                //        item["MaHC"].Enabled = true;

                //        ((RadComboBox)item["MaHC"].FindControl("cboDichVu")).Focus();
                //    }
                //}
                //else if (sender.Equals(grdMau))
                //{
                //    if (grdMau.EditItems.Count > 0)
                //        e.Item.FireCommandEvent(RadGrid.CancelCommandName, string.Empty);
                //    else
                //    {

                //        item["MaThuoc"].Enabled = true;

                //        ((RadComboBox)item["MaThuoc"].FindControl("cboDichVu")).Focus();
                //    }
                //}
            }
        }
    }
    protected void grdDichVu_ItemCommand(object sender, GridCommandEventArgs e)
    {
        try
        {
            _SoSoHD = "";
            _SoHD = "";
            //if ((e.CommandName == RadGrid.CancelCommandName || e.CommandName == RadGrid.CancelCommandName || e.CommandName == RadGrid.CancelAllCommandName) && (sender.Equals(grdXNTT)))
            //{
            //    GridEditableItem editItem = (GridEditableItem)e.Item;
            //    RadComboBox combo = (RadComboBox)editItem.FindControl("cboDichVu");

            //        combo.EnableLoadOnDemand = false;
            //        combo.EnableAutomaticLoadOnDemand = false;

            //}
            //else

            if (e.CommandName == "Edit" && (sender.Equals(grdCTT)))
            {
                if ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && (HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "HH"))
                {
                    e.Canceled = true;
                    ShowMessage("Không được phép sửa, hủy dịch vụ");
                }
                if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN")
                {
                    grdCTT.MasterTableView.GetColumn("MG").Display = true;
                }
                GridEditableItem editedItem = e.Item as GridEditableItem;

                string loaidv = editedItem.GetDataKeyValue("LoaiDV").ToString();
                if (loaidv == "6")
                {
                    CurrentTabIndex = 4;
                    txtindextab.Value = CurrentTabIndex.ToString();
                    int stt = int.Parse(editedItem.GetDataKeyValue("SoTT").ToString());

                    KhamBenh_ThuocSD_DY _KhamBenh_ThuocSD_DY = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.FirstOrDefault(X => X.STT == stt);
                    RadTabStrip1.SelectedIndex = CurrentTabIndex;
                    RadMultiPage1.SelectedIndex = CurrentTabIndex;
                    LoadDetails(false, CurrentTabIndex, false);
                }

            }
            else if (e.CommandName == "Edit" && (sender.Equals(grdDTT)))
            {
                if (Pub_bQuyenForm < HTC.ShareVariables.KieuFormChiTiet.fSua)
                {
                    ShowMessage("Không có quyền sửa, hủy dịch vụ hoặc hủy hóa đơn");
                    return;
                }
                GridEditableItem editedItem = e.Item as GridEditableItem;

                string loaidv = editedItem.GetDataKeyValue("LoaiDV").ToString();

                if (loaidv == "6")
                {
                    CurrentTabIndex = 4;
                    txtindextab.Value = CurrentTabIndex.ToString();
                    int stt = int.Parse(editedItem.GetDataKeyValue("SoTT").ToString());
                    KhamBenh_ThuocSD_DY _KhamBenh_ThuocSD_DY = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.FirstOrDefault(X => X.STT == stt);
                    RadTabStrip1.SelectedIndex = CurrentTabIndex;
                    RadMultiPage1.SelectedIndex = CurrentTabIndex;
                    LoadDetails(false, CurrentTabIndex, false);
                }

            }
            else if ((e.CommandName == "Edit" || e.CommandName == RadGrid.DeleteCommandName) && (sender.Equals(grdXNTT)))
            {
                GridEditableItem editedItem = e.Item as GridEditableItem;
                if (editedItem["NhapSL"].Text == "False" && (e.CommandName == "Edit") && editedItem["DaTT"].Text != "0" && _LoaiPhieu != 1)
                    e.Canceled = true;
                if ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && HTC.ShareVariables.pub_spC == "PS")
                    e.Canceled = true;
                if (_LoaiPhieu != 1)
                {
                    if (editedItem["DaTT"].Text != "0")
                    {
                        editedItem.Edit = false;
                        e.Canceled = true;
                    }
                }
                if (e.Canceled == true)
                    ShowMessage("Đã thanh toán hoặc không được phép sửa");

            }
            else if ((e.CommandName == "Edit" || e.CommandName == RadGrid.DeleteCommandName) && (sender.Equals(grdThuoc)))
            {
                GridEditableItem editedItem = e.Item as GridEditableItem;

                if (editedItem["DaTT"].Text != "0")
                {
                    editedItem.Edit = false;
                    e.Canceled = true;
                }
                if (e.Canceled == true)
                    ShowMessage("Đã thanh toán  không được phép sửa");

            }
            else if ((e.CommandName == "Edit" || e.CommandName == RadGrid.DeleteCommandName) && sender.Equals(grdDanhSachDY))
            {
                GridEditableItem _editedItem = e.Item as GridEditableItem;

                if (_editedItem != null)
                {
                    _STT = Byte.Parse(_editedItem.GetDataKeyValue("STT").ToString());
                    _KhamBenh_ThuocSD_DY = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.FirstOrDefault(X => X.STT == _STT);
                    grdThuocDY.DataSource = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
                    grdThuocDY.DataBind();
                    txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
                    txtTT.Value = (_KhamBenh_ThuocSD_DY.SLMua == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua)).ToString();
                    grdThuocDY.MasterTableView.IsItemInserted = false;
                }
            }
            else if ((e.CommandName == "Edit" || e.CommandName == RadGrid.DeleteCommandName) && (sender.Equals(grdThuocDY)))
            {
                if (_KhamBenh_ThuocSD_DY == null)
                    e.Canceled = true;
                else if (_KhamBenh_ThuocSD_DY.DATT != 0)
                {

                    ShowMessage("Đã thanh toán  không được phép sửa");
                    e.Canceled = true;
                }
                else
                {
                    GridEditableItem editedItem = e.Item as GridEditableItem;

                    int stt = int.Parse(editedItem.GetDataKeyValue("STT").ToString());
                    if (stt != 0)
                        _KhamBenh_ThuocSD_DY = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.FirstOrDefault(X => X.STT == stt);
                    grdThuocDY.DataSource = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
                    grdThuocDY.DataBind();
                    txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
                    txtTT.Value = (_KhamBenh_ThuocSD_DY.SLMua == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua)).ToString();

                    grdThuocDY.MasterTableView.IsItemInserted = false;
                }
            }
            else if (e.CommandName == "ViewDetail")
            {
                if (e.CommandArgument.ToString() != "")
                {
                    GridDataItem item = grdDTT.MasterTableView.Items[e.CommandArgument.ToString()] as GridDataItem;
                    GridEditableItem editedItem = (GridEditableItem)(grdDTT.MasterTableView.Items[e.CommandArgument.ToString()] as GridEditableItem);
                    if (_SoTT == null)
                        _SoTT = 0;
                    if (_SoTT == byte.Parse(editedItem.GetDataKeyValue("SoTT").ToString()))
                    {
                        if (editedItem["DaTT"].Text != "0" && _LoaiPhieu != 1)
                        {
                            editedItem.Edit = false;
                            e.Canceled = true;
                            ShowMessage("Đã thanh toán  không được phép sửa");
                        }
                        else
                            editedItem.Edit = true;
                    }
                    else
                    {
                        _SoTT = byte.Parse(editedItem.GetDataKeyValue("SoTT").ToString());

                        _SoHD = editedItem["SoHD"].Text;
                        _SoSoHD = editedItem["SoSoHD"].Text;
                        _LanTT = byte.Parse(editedItem["DaTT"].Text);
                    }
                }

            }
            else if (e.CommandName == "PerformInsert")
            {

                if (txtmadv.Value != "")
                {
                    if (CheckFormData() == true)
                    {
                        GridEditableItem editedItem = grdXNTT.MasterTableView.GetInsertItem();

                        AddXN(editedItem);

                        grdXNTT.MasterTableView.Rebind();
                        grdXNTT.Rebind();
                        grdXNTT.MasterTableView.IsItemInserted = true;
                        grdXNTT.MasterTableView.InsertItem();
                        txtmadv.Value = "";
                        e.Canceled = true;

                    }
                    else
                    {
                        txtmadv.Value = "";
                        e.Canceled = true;
                    }
                    //if (sender.Equals(grdXNTT))
                    //{
                    //    ShowDV();
                    //}
                }

            }

            //  txthienthi.Text  = "";
        }
        catch (Exception ex)
        {
            ShowMessage("Không thực hiện được dữ liệu 2" + ex.Message);
        }
    }

    protected Boolean UpdateData(GridEditableItem editedItem, FormAction _action, string grid = "")
    {
        if ((baraction.FindItemByValue("cmdPrint").Enabled == false || baraction.FindItemByValue("cmdPrint").Visible == false))
            return true;
        if (CheckFormData() == false)
            return false;

        if (_action == FormAction.EDIT)
            _Update = true;
        if (_action == FormAction.INSERT)
            _Insert = true;
        switch (CurrentTabIndex)
        {
            case 0:
                {
                    if (UpdateDataCTT(editedItem, _action) == false)
                        return false;
                    break;
                }
            case 1:
                {
                    if (UpdateDataDTT(editedItem, _action) == false)
                        return false;

                    break;
                }
            case 2:
                {

                    if (UpdateDataXN(editedItem, _action) == false)
                        return false;

                    break;
                }
            case 3:
                {

                    if (UpdateDataThuoc(editedItem, _action) == false)
                        return false;
                    break;
                }
            case 4:
                {

                    if (UpdateDataThuocDY(editedItem, _action, grid) == false)
                        return false;

                    break;
                }

            case 5:
                {
                    if (UpdateDataVTTH(editedItem, _action) == false)
                        return false;






                    break;
                }
            case 6:
                {
                    if (UpdateDataHoaChat(editedItem, _action) == false)
                        return false;
                    break;
                }
            case 7:
                {

                    if (UpdateDataMau(editedItem, _action) == false)
                        return false;
                    break;
                }

        }
        //string sql = "UPDATE ThongTinBN SET Lydovaovien = '" + cbolydovaovien.SelectedValue + "', Doituongkhambenh = '" + cbodoituongkhambenh.SelectedValue + "' WHERE mabn = '" + _ThongtinBN.MaBN + "'";
        //HTC.Business.DataProvider.Instance().ExcSQL(sql);

        if ((_LoaiPhieu != 1) || (_LoaiPhieu == 1 && _Duyet == 1))
            tinhlaihd();
        return true;
    }

    protected void grdDichVu_UpdateCommand(object sender, GridCommandEventArgs e)
    {
        try
        {
            GridEditableItem editedItem = e.Item as GridEditableItem;

            if (editedItem != null)
            {
                if (UpdateData(editedItem, FormAction.EDIT) == true)
                {
                    ShowMessage(MessageType.SUCCESS, FormAction.EDIT);
                }
                if (CurrentTabIndex == 4)
                {
                    if (_KhamBenh_ThuocSD_DY != null)
                    {
                        grdThuocDY.DataSource = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
                        grdThuocDY.DataBind();
                    }
                    grdThuocDY.MasterTableView.IsItemInserted = true;
                }
            }
        }
        catch (Exception ex)
        {
            //HandleException(ex, FormAction.EDIT);
            ShowMessage(MessageType.ERROR, FormAction.EDIT);
        }

        e.Canceled = false;
    }
    protected void grdDichVu_InsertCommand(object sender, GridCommandEventArgs e)
    {
        try
        {
            //if (CheckFormData() == false)
            //    return;
            GridEditableItem editedItem = null;
            if (sender.Equals(grdThuoc))

                editedItem = grdThuoc.MasterTableView.GetInsertItem();
            else if (sender.Equals(grdXNTT) && txtmadv.Value == "")
            {
                editedItem = grdXNTT.MasterTableView.GetInsertItem();
                //if (editedItem != null)
                //{
                //    if (editedItem["SLMua"].FindControl("tbSoLuong") == null)
                //    {

                //          RadComboBox combo = (RadComboBox)editedItem["MaDV"].FindControl("cboDichVu");
                //          ShowMessage("kj" + combo.SelectedValue);
                //          string madvct = combo.SelectedValue;
                //        if (madvct == "")
                //            return;
                //        DMDichVu_Gia_DTList listt = odsDichVu.Select() as DMDichVu_Gia_DTList;
                //        if (listt == null)
                //            return;
                //        DMDichVu_Gia_DT _DMDichVu_Giat = listt.FirstOrDefault(X => X.MaDV == madvct);
                //        if (_DMDichVu_Giat == null)
                //            return;

                //        RadComboBoxItem selectedItem = new RadComboBoxItem();

                //        selectedItem.Text = _DMDichVu_Giat.TenDV;
                //        selectedItem.Value = madvct;
                //        combo.Items.Add(selectedItem);
                //        selectedItem.Selected = true;
                //        selectedItem.DataBind();
                //        combo.DataBind();
                //        e.Canceled = true;
                //        return;

                //    }
                //}
            }
            else if (sender.Equals(grdThuocDY))
                editedItem = grdThuocDY.MasterTableView.GetInsertItem();
            //else if (sender.Equals(grdVTTH))
            //    editedItem = grdVTTH.MasterTableView.GetInsertItem();
            //else if (sender.Equals(grdHoaChat))
            //    editedItem = grdHoaChat.MasterTableView.GetInsertItem();
            //else if (sender.Equals(grdMau))
            //    editedItem = grdMau.MasterTableView.GetInsertItem();

            if (editedItem != null && ((txtmadv.Value == "" && CurrentTabIndex == 2) || CurrentTabIndex != 2))
            {

                if (UpdateData(editedItem, FormAction.INSERT) == true)
                {
                    ShowMessage(MessageType.SUCCESS, FormAction.INSERT);
                    if (sender.Equals(grdThuoc))
                    {
                        grdThuoc.MasterTableView.IsItemInserted = true;
                        grdThuoc.MasterTableView.InsertItem();
                    }
                    else if (sender.Equals(grdXNTT) && txtmadv.Value == "")
                    {
                        grdXNTT.MasterTableView.IsItemInserted = true;
                        grdXNTT.MasterTableView.InsertItem();
                        grdXNTT.DataBind();
                        clearDetail();
                    }
                    else if (sender.Equals(grdThuocDY))
                    {
                        grdThuocDY.MasterTableView.IsItemInserted = true;
                        grdThuocDY.MasterTableView.InsertItem();
                    }

                }

                else if (sender.Equals(grdXNTT) && txtmadv.Value == "")
                {


                    ((RadNumericTextBox)editedItem["SLMua"].FindControl("tbSLMua")).Focus();

                }
            }
            txtmadv.Value = "";

        }
        catch (Exception ex)
        {
            ShowMessage("Không lưu được dữ liệu" + ex.Message);
        }
        e.Canceled = true;
    }
    protected void grdDichVu_DeleteCommand(object sender, GridCommandEventArgs e)
    {
        try
        {
            string id = ((RadGrid)sender).ID;
            Boolean dele = false;
            GridEditableItem editedItem = e.Item as GridEditableItem;
            if (CurrentTabIndex != 2)
                dele = DeleteItem(editedItem, id);
            else if (CurrentTabIndex == 2 && grdXNTT.SelectedItems != null)
            {
                if (grdXNTT.SelectedItems.Count == 0)
                    dele = DeleteItem(editedItem, id);
                else
                    foreach (GridEditableItem item in grdXNTT.SelectedItems)
                    {
                        dele = DeleteItem(item, id);
                        if (dele == false)
                            break;
                    }
            }
            else if (CurrentTabIndex == 2)
                dele = DeleteItem(editedItem, id);
            if (dele == false)

                e.Canceled = true;

        }
        catch (Exception ex)
        {
            //throw;
        }
    }
    private Boolean DeleteItem(GridEditableItem editedItem, string id)
    {
        Boolean _dele = true;
        switch (CurrentTabIndex)
        {
            case 0:
            case 1:
                {
                    if (Pub_bQuyenForm < HTC.ShareVariables.KieuFormChiTiet.fSua && CurrentTabIndex == 1)
                    {
                        ShowMessage("Không có quyền sửa, hủy dịch vụ hoặc hủy hóa đơn");
                        return false;
                    }
                    string loaidv = editedItem.GetDataKeyValue("LoaiDV").ToString();
                    if (loaidv == "6")
                    {
                        ShowMessage("thuốc đông y không được phép xóa");
                        return false;
                    }
                    break;
                }
            case 2:
            case 3:
                {
                    if (CurrentTabIndex == 2 && _LoaiPhieu == 1 && cboLoaiBN.SelectedValue == "10" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN"))
                    {
                    }
                    else if ((editedItem["DaTT"].Text != "0" && editedItem["DaTT"].Text != ""))
                    {
                        ShowMessage("Chỉ định này đã thanh toán không thể xóa được");
                        _dele = false;
                    }

                    break;
                }
            case 4:
                {

                    if (id.IndexOf("grdDanhSachDY") >= 0)
                    {
                        int STT = int.Parse(editedItem.GetDataKeyValue("STT").ToString());
                        _KhamBenh_ThuocSD_DY = _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.FirstOrDefault(X => X.STT == STT);
                    }
                    if (_KhamBenh_ThuocSD_DY == null)
                        return false;
                    //if (_KhamBenh_ThuocSD_DY.MaSoKham == "")
                    //    return;
                    if (_KhamBenh_ThuocSD_DY.DATT != 0 && pub_bQadmin == false)
                    {
                        ShowMessage("Chỉ định này đã thanh toán không thể xóa được");
                        _dele = false;
                    }
                    if (_KhamBenh_ThuocSD_DY.Phat == true && pub_bQadmin == false)
                    {
                        ShowMessage("Chỉ định này đã phát không thể xóa được");
                        _dele = false;
                    }
                    break;
                }


        }
        if (_dele == true)
        {

            if (UpdateData(editedItem, FormAction.DELETE, id) == true)
            {
                ShowMessage(MessageType.SUCCESS, FormAction.DELETE);
            }
            if (CurrentTabIndex == 4)
            {
                if (_KhamBenh_ThuocSD_DY != null)
                {
                    grdThuocDY.DataSource = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
                    grdThuocDY.DataBind();
                }
                grdThuocDY.MasterTableView.IsItemInserted = true;
            }
        }
        return true;
    }
    protected void grdDTT_NeedDataSource(object sender, GridNeedDataSourceEventArgs e)
    {
        grdDTT.DataSource = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList;


    }
    protected void grdCTT_NeedDataSource(object sender, GridNeedDataSourceEventArgs e)
    {

        grdCTT.DataSource = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList;
    }




    protected Boolean AddXN(GridEditableItem item)
    {

        //IEnumerable<RadComboBoxItem> checkedItems = from checkedItem in cbodichvu.Items.ToList()
        //                                                 where ((CheckBox )checkedItem.FindControl("chkChon")).Checked  == true
        //                                                 select checkedItem;
        if (baraction.FindItemByValue("cmdPrint").Enabled == false || baraction.FindItemByValue("cmdPrint").Visible == false)
            return false;
        if (HTC.ShareVariables.pub_spC == "PS")
        {
            if (cboLoaiBN.SelectedValue != "3" && (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count > 0 || _ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0))
            {
                ShowMessage("Chỉ có bệnh nhân dịch vụ được nhập dịch vụ");
                txtmadv.Value = "";
                return false;
            }
            if (cboLoaiBN.SelectedValue != "3" && (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count == 0 && txtMaKhoa.Text == ""))
            {
                ShowMessage("Chỉ có bệnh nhân dịch vụ được nhập dịch vụ");
                txtmadv.Value = "";
                return false;
            }
        }
        string madv = txtmadv.Value;
        madv = madv.Substring(0, madv.Length - 1);
        string madvct = "";
        while (madv != "")
        {
            if (madv.IndexOf(",") == -1)
            {
                madvct = madv;
                madv = "";
            }
            else
            {
                madvct = madv.Substring(0, madv.IndexOf(","));
                madv = madv.Substring(madv.IndexOf(",") + 1);
            }
            if (madvct == "")
                return false;
            DMDichVu_Gia_DTList listt = null; DMDichVu_Gia_DTList.FindDMDichVu_Gia_DTByMa(madvct, cboDoiTuong.SelectedValue);
            if (HTC.ShareVariables.pub_spC == "PS")
                listt = DMDichVu_Gia_DTList.FindDMDichVu_Gia_DTByMa(madvct + "/" + cboKhoaKB.SelectedValue, cboDoiTuong.SelectedValue);
            else
                listt = DMDichVu_Gia_DTList.FindDMDichVu_Gia_DTByMa(madvct, cboDoiTuong.SelectedValue);
            if (listt == null)
                return false;
            DMDichVu_Gia_DT _DMDichVu_Giat = listt.FirstOrDefault(X => X.MaDV.ToUpper() == madvct.ToUpper());
            if (_DMDichVu_Giat == null)
                return false;
            if (_DMDichVu_Giat.nhapsl == false)
            {

                UpdateDataXN(item, FormAction.INSERT, madvct, _DMDichVu_Giat);
            }
            else if (_DMDichVu_Giat.nhapsl == true && _DMDichVu_Giat.dongiatt != "")
            {

                UpdateDataXN(item, FormAction.INSERT, madvct, _DMDichVu_Giat);
            }
            else if (_DMDichVu_Giat.dongiatt == "")
            {
                DMDichVu_Gia_Goi_DTList _DMDichVu_Gia_Goi_DTList = null;// DMDichVu_Gia_Goi_DTList.FindDMDichVu_Gia_Goi_DTByMa(madvct, cboDoiTuong.SelectedValue);
                if (HTC.ShareVariables.pub_spC == "PS")
                    _DMDichVu_Gia_Goi_DTList = DMDichVu_Gia_Goi_DTList.FindDMDichVu_Gia_Goi_DTByMa(madvct + "/" + cboKhoaKB.SelectedValue, cboDoiTuong.SelectedValue);
                else
                    _DMDichVu_Gia_Goi_DTList = DMDichVu_Gia_Goi_DTList.FindDMDichVu_Gia_Goi_DTByMa(madvct, cboDoiTuong.SelectedValue);
                if (_DMDichVu_Gia_Goi_DTList.Count > 0)
                {
                    foreach (DMDichVu_Gia_DT _DMDichVu_Gia in _DMDichVu_Gia_Goi_DTList)
                    {
                        KhamBenh_C _KhamBenh_C = Supports_KhamBenh_C(_DMDichVu_Gia.MaDV, _DMDichVu_Gia, item);
                        _KhamBenh_C.slmua = "1";
                        _KhamBenh_C.SoLuong = "1";
                        _KhamBenh_C.inthu = _DMDichVu_Gia.inthu;
                        if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0)
                            _KhamBenh_C.STT = 1;
                        else
                            _KhamBenh_C.STT = _ThongtinBN.KhamBenh.KhamBenh_C_List[_ThongtinBN.KhamBenh.KhamBenh_C_List.Count - 1].STT + 1;

                        _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.NewTo(_KhamBenh_C);

                        _ThongtinBN.KhamBenh.KhamBenh_C_List.AssignTo(_KhamBenh_C, _ThongtinBN.KhamBenh);
                    }


                }
                _ThongKe_BenhNhan_NgoaiTruListInfo = null;
                _KhamBenh_GETsMABNListInfo = null;
                _ThongKe_BenhNhan_NgoaiTruListInfo = null;
                grdXNTT.Height = 300;
                grdLichSuKham.Visible = false;
                grdKhoa.Visible = false;


            }

            if ((_LoaiPhieu != 1) || (_LoaiPhieu == 1 && _Duyet == 1))
                tinhlaihd();
            clearDetail();
        }
        return true;
    }
    protected void txtMaNV_TextChanged(object sender, EventArgs e)
    {
        if (txtMaNV.Text != "")
        {
            //cboNhanVien.ClearSelection();
            //cboNhanVien.DataBind();
            //  RadComboBoxItem selectedItem = new RadComboBoxItem();
            DMNhanVienList _DMNhanVienList = DMNhanVienList.FindDMNhanVienByMa(txtMaNV.Text.Trim());
            if (_DMNhanVienList.Count > 0)
            {
                cboNhanVien.Text = _DMNhanVienList[0].HoTen;
                cboNhanVien.SelectedValue = _DMNhanVienList[0].MaNV;
                txtMaNV.Text = _DMNhanVienList[0].MaNV;
                //selectedItem.Text = _DMNhanVienList[0].HoTen;
                //selectedItem.Value = _DMNhanVienList[0].MaNV;
                //cboNhanVien.Items.Add(selectedItem);
                //selectedItem.Selected = true;
                //selectedItem.DataBind();
                //cboNhanVien.DataBind();
            }

        }
    }
    protected void txtBSDongY_TextChanged(object sender, EventArgs e)
    {
        if (txtBSDongY.Text != "")
        {
            DMNhanVienList _DMNhanVienList = DMNhanVienList.FindDMNhanVienByMa(txtBSDongY.Text.Trim());
            if (_DMNhanVienList.Count > 0)
            {
                cboBSDongY.Text = _DMNhanVienList[0].HoTen;
                cboBSDongY.SelectedValue = _DMNhanVienList[0].MaNV;
            }
            //RadComboBoxItem selectedItem = new RadComboBoxItem();

            //selectedItem.Text = DMNhanVien.GetDMNhanVien(txtBSDongY.Text.Trim()).HoTen;
            //selectedItem.Value = txtBSDongY.Text;
            //cboBSDongY.Items.Add(selectedItem);
            //selectedItem.Selected = true;
            //selectedItem.DataBind();
            //cboBSDongY.DataBind();
            //grdThuocDY.MasterTableView.IsItemInserted = true;
            //grdThuocDY.Rebind();
        }
    }
    protected void txtBSTayY_TextChanged(object sender, EventArgs e)
    {
        if (txtBSTayY.Text != "")
        {
            DMNhanVienList _DMNhanVienList = DMNhanVienList.FindDMNhanVienByMa(txtBSTayY.Text.Trim());
            if (_DMNhanVienList.Count > 0)
            {
                cboBSTayY.Text = _DMNhanVienList[0].HoTen;
                cboBSTayY.SelectedValue = _DMNhanVienList[0].MaNV;
            }

            //RadComboBoxItem selectedItem = new RadComboBoxItem();

            //selectedItem.Text = DMNhanVien.GetDMNhanVien(txtBSTayY.Text.Trim()).HoTen;
            //selectedItem.Value = txtBSTayY.Text;
            //cboBSTayY.Items.Add(selectedItem);
            //selectedItem.Selected = true;
            //selectedItem.DataBind();
            //cboBSTayY.DataBind();
            //grdThuocDY.MasterTableView.IsItemInserted = true;
            //grdThuocDY.Rebind();
        }
    }
    private void SearchBN()
    {

        if (txtmabn.Text != "" && _MaBN == "")
        { 
            ThongtinBN _obttbn;
            DateTime M = DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy",CultureInfo.CurrentCulture, DateTimeStyles.None);
            if (_LoaiPhieu == 1 && _Duyet == 1)
                _obttbn = ThongtinBN.GetThongtinBN(txtmabn.Text, M, 11, _NoiTT);
            else
                _obttbn = ThongtinBN.GetThongtinBN(txtmabn.Text, M, _LoaiPhieu, _NoiTT);

            if (_obttbn != null && _obttbn.MaBN != "")
            {

                _ThongtinBN = _obttbn;

                _MaBN = _ThongtinBN.MaBN;
                _NgayDK = M;
                if (_ThongtinBN.KhamBenh.IsNew == true)
                {
                    //_ThongtinBN.KhamBenh.LoaiKham = byte.Parse(cboLoaiBN.SelectedValue);
                    _ThongtinBN.KhamBenh.LoaiKham = (cboLoaiBN.SelectedValue == "" ? byte.Parse("0") : byte.Parse(cboLoaiBN.SelectedValue));

                    if ((_ThongtinBN.Sothe != "" && _PubMaDT == "BH") || (_LoaiPhieu == 2 && _ThongtinBN.Sothe != ""))
                    {
                        if ((_ThongtinBN.Sothe.Substring(0, 3).ToUpper()) == "HN4" || _ThongtinBN.Sothe.Substring(0, 3).ToUpper() == "BT4" || (_ThongtinBN.Sothe.Substring(0, 3).ToUpper()) == "KC7" || (_ThongtinBN.Sothe.Substring(0, 3).ToUpper()) == "CB7" || (_ThongtinBN.Sothe.Substring(0, 3).ToUpper()) == "QN5" || (_ThongtinBN.Sothe.Substring(0, 3).ToUpper()) == "CA5" || (_ThongtinBN.Sothe.Substring(0, 3).ToUpper()) == "CY5")
                        {
                            if (_NoiTT == "085")
                                cboDoiTuong.SelectedValue = "10002";
                            else
                                cboDoiTuong.SelectedValue = "11002";
                            DMDoiTuong _dmdoituong = DMDoiTuong.GetDMDoiTuong(cboDoiTuong.SelectedValue);
                            _ThongtinBN.KhamBenh.bhtra = _dmdoituong.bhtra;
                            _ThongtinBN.KhamBenh.sotienbhtra = _dmdoituong.Sotien;
                            _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                            _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                        }
                        else if (_ThongtinBN.Sothe.Substring(0, 3).ToUpper() == "CN6" || _ThongtinBN.Sothe.Substring(0, 3).ToUpper() == "TC7")
                        {
                            if (_NoiTT == "085")
                                cboDoiTuong.SelectedValue = "10007";
                            else
                                cboDoiTuong.SelectedValue = "11007";
                            DMDoiTuong _dmdoituong = DMDoiTuong.GetDMDoiTuong(cboDoiTuong.SelectedValue);
                            _ThongtinBN.KhamBenh.bhtra = _dmdoituong.bhtra;
                            _ThongtinBN.KhamBenh.sotienbhtra = _dmdoituong.Sotien;
                            _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                            _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                        }

                        else
                        {
                            DMDoiTuongList _DMDoiTuongList = DMDoiTuongList.FindDMDoiTuongKyHieu(_ThongtinBN.Sothe.Substring(2, 1));
                            if (_DMDoiTuongList.Count > 0)
                            {
                                if (_NoiTT == "085")
                                {
                                    cboDoiTuong.SelectedValue = _DMDoiTuongList[0].MaDT;
                                }
                                else if (_NoiTT == "087")
                                {
                                    cboDoiTuong.SelectedValue = "11" + _DMDoiTuongList[0].MaDT.Substring(2);
                                }
                                _ThongtinBN.KhamBenh.bhtra = _DMDoiTuongList[0].bhtra;
                                _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuongList[0].Sotien;
                                _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                                _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                            }
                        }
                    }
                    else if (_PubMaDT == "CR" && _LoaiPhieu == 1)
                    {
                        if (_NoiTT == "085")
                            _ThongtinBN.MaDT = "00007";
                        else if (_NoiTT == "00093")
                            _ThongtinBN.MaDT = "00003";
                        else
                            _ThongtinBN.MaDT = "00002";
                        cboDoiTuong.SelectedValue = _ThongtinBN.MaDT;
                        _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                    }
                    else if (_PubMaDT == "TT" && _LoaiPhieu == 1)
                    {
                        if (_NoiTT == "085")
                            _ThongtinBN.MaDT = "00001";
                        else if (_NoiTT == "00093")
                            _ThongtinBN.MaDT = "00003";
                        else
                            _ThongtinBN.MaDT = "00002";
                        cboDoiTuong.SelectedValue = _ThongtinBN.MaDT;
                        _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                    }
                    //_ThongtinBN.KhamBenh.MaDT = _ThongtinBN.MaDT;
                    //DMDoiTuong _DMDoiTuong = DMDoiTuong.GetDMDoiTuong(_ThongtinBN.MaDT);

                    //if (_DMDoiTuong != null)
                    //{
                    //    cboDoiTuong.SelectedValue = _DMDoiTuong.MaDT;
                    //    _ThongtinBN.KhamBenh.bhtra = _DMDoiTuong.bhtra;
                    //    _ThongtinBN.KhamBenh.MaDT = _DMDoiTuong.MaDT;
                    //    _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuong.Sotien;
                    //}
                }
                else
                {

                    if (_LoaiPhieu == 2 && (HTC.ShareVariables.pub_spC == "PS"))
                    {
                        ThongtinBN _obttbn9 = ThongtinBN.GetThongtinBN(txtmabn.Text, DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), 9, _NoiTT);
                        if (_obttbn9.KhamBenh.KhamBenh_GetsDichVuCTTList.Count > 0)
                            OpenWindow("frmLapPhieu.aspx?LoaiPhieu=9&noitt=" + _NoiTT + "&duyet=" + _Duyet + "&MaBN=" + txtmabn.Text + "&NgayDK=" + DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None) + "&PubMaDT=" + _PubMaDT);
                        _obttbn9 = null;
                    }
                }

                LoadData(false);
                if (_LoaiPhieu == 8 && (HTC.ShareVariables.pub_spC == "PS") && _ThongtinBN.KhamBenh.KyQuyBH != "0" && _ThongtinBN.KhamBenh.KyQuyBH != "")
                {
                    // OpenWindow("frmPhieuChiBT.aspx?LoaiPhieu=8&madt=" + _MaDT + "&NoiTT=" + _NoiTT + "&MaBN=" + _MaBN + "&NgayDK=" + _NgayDK.ToString());
                    if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                    {
                        if (_ThongtinBN.KhamBenh.KhamBenh_C_List[0].MaHuongDT != "")

                            OpenWindow("frmPhieuChiBT.aspx?LoaiPhieu=8&madt=" + _MaDT + "&NoiTT=" + _NoiTT + "&MaBN=" + _MaBN + "&NgayDK=" + _NgayDK.ToString());
                    }
                }
                SetData();
                enableTNBN(false);
                BefoChuyenDT();
                if (_LoaiPhieu == 2 && HTC.ShareVariables.pub_spC != "PS")
                    chkTraiTuyen.Focus();
                else if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && HTC.ShareVariables.pub_spC != "PS")
                    txtMaKhoa.Focus();
                else if ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && HTC.ShareVariables.pub_spC == "PS")
                {
                    if (txtKyhieu.Text != "")
                        txtsohd.Focus();
                    else
                        txtKyhieu.Focus();
                }
                else if (_LoaiPhieu == 1 && _PubMaDT == "TT")
                    cboChuyenKhoa.Focus();
                else if (_LoaiPhieu == 1 && _PubMaDT == "CC")
                {
                    txtMaKhoa.Focus();
                    cboChuyenKhoa.Enabled = false;
                }
                else if (_LoaiPhieu == 1 && _PubMaDT == "BH")
                    chkTraiTuyen.Focus();
                else if (_LoaiPhieu == 1)
                    txtMaKhoa.Focus();

            }
        }

    }
    private void SearchBNCMT()
    {

        if (txtSoCMT.Text != "" && _MaBN == "" && txthoten.Text == "")
        {
            ThongtinBN _obttbn;
            if (_LoaiPhieu == 1 && _Duyet == 1)
                _obttbn = ThongtinBN.GetThongtinBN(txtSoCMT.Text, DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), 11, _NoiTT);
            else
                _obttbn = ThongtinBN.GetThongtinBN(txtSoCMT.Text, DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), _LoaiPhieu, _NoiTT);

            if (_obttbn != null && _obttbn.MaBN != "")
            {

                _ThongtinBN = _obttbn;

                _MaBN = _ThongtinBN.MaBN;
                if (_ThongtinBN.KhamBenh.IsNew == true)
                {
                    //_ThongtinBN.KhamBenh.LoaiKham = byte.Parse(cboLoaiBN.SelectedValue);
                    _ThongtinBN.KhamBenh.LoaiKham = (cboLoaiBN.SelectedValue == "" ? byte.Parse("0") : byte.Parse(cboLoaiBN.SelectedValue));

                    if ((_ThongtinBN.Sothe != "" && _PubMaDT == "BH") || (_LoaiPhieu == 2 && _ThongtinBN.Sothe != ""))
                    {
                        if ((_ThongtinBN.Sothe.Substring(0, 3).ToUpper()) == "HN4" || _ThongtinBN.Sothe.Substring(0, 3).ToUpper() == "BT4" || (_ThongtinBN.Sothe.Substring(0, 3).ToUpper()) == "KC7" || (_ThongtinBN.Sothe.Substring(0, 3).ToUpper()) == "CB7" || (_ThongtinBN.Sothe.Substring(0, 3).ToUpper()) == "QN5" || (_ThongtinBN.Sothe.Substring(0, 3).ToUpper()) == "CA5" || (_ThongtinBN.Sothe.Substring(0, 3).ToUpper()) == "CY5")
                        {
                            if (_NoiTT == "085")
                                cboDoiTuong.SelectedValue = "10002";
                            else
                                cboDoiTuong.SelectedValue = "11002";
                            DMDoiTuong _dmdoituong = DMDoiTuong.GetDMDoiTuong(cboDoiTuong.SelectedValue);
                            _ThongtinBN.KhamBenh.bhtra = _dmdoituong.bhtra;
                            _ThongtinBN.KhamBenh.sotienbhtra = _dmdoituong.Sotien;
                            _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                            _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                        }
                        else if (_ThongtinBN.Sothe.Substring(0, 3).ToUpper() == "CN6" || _ThongtinBN.Sothe.Substring(0, 3).ToUpper() == "TC7")
                        {
                            if (_NoiTT == "085")
                                cboDoiTuong.SelectedValue = "10007";
                            else
                                cboDoiTuong.SelectedValue = "11007";
                            DMDoiTuong _dmdoituong = DMDoiTuong.GetDMDoiTuong(cboDoiTuong.SelectedValue);
                            _ThongtinBN.KhamBenh.bhtra = _dmdoituong.bhtra;
                            _ThongtinBN.KhamBenh.sotienbhtra = _dmdoituong.Sotien;
                            _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                            _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                        }

                        else
                        {
                            DMDoiTuongList _DMDoiTuongList = DMDoiTuongList.FindDMDoiTuongKyHieu(_ThongtinBN.Sothe.Substring(2, 1));
                            if (_DMDoiTuongList.Count > 0)
                            {
                                if (_NoiTT == "085")
                                {
                                    cboDoiTuong.SelectedValue = _DMDoiTuongList[0].MaDT;
                                }
                                else if (_NoiTT == "087")
                                {
                                    cboDoiTuong.SelectedValue = "11" + _DMDoiTuongList[0].MaDT.Substring(2);
                                }
                                _ThongtinBN.KhamBenh.bhtra = _DMDoiTuongList[0].bhtra;
                                _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuongList[0].Sotien;
                                _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                                _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                            }
                        }
                    }
                    else if (_PubMaDT == "TT" && _LoaiPhieu == 1)
                    {
                        if (_NoiTT == "085")
                            _ThongtinBN.MaDT = "00001";
                        else if (_NoiTT == "00093")
                            _ThongtinBN.MaDT = "00003";
                        else
                            _ThongtinBN.MaDT = "00002";
                        cboDoiTuong.SelectedValue = _ThongtinBN.MaDT;
                        _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                    }
                    //_ThongtinBN.KhamBenh.MaDT = _ThongtinBN.MaDT;
                    //DMDoiTuong _DMDoiTuong = DMDoiTuong.GetDMDoiTuong(_ThongtinBN.MaDT);

                    //if (_DMDoiTuong != null)
                    //{
                    //    cboDoiTuong.SelectedValue = _DMDoiTuong.MaDT;
                    //    _ThongtinBN.KhamBenh.bhtra = _DMDoiTuong.bhtra;
                    //    _ThongtinBN.KhamBenh.MaDT = _DMDoiTuong.MaDT;
                    //    _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuong.Sotien;
                    //}
                }
                else
                {

                    if (_LoaiPhieu == 2 && (HTC.ShareVariables.pub_spC == "PS"))
                    {
                        ThongtinBN _obttbn9 = ThongtinBN.GetThongtinBN(txtSoCMT.Text, DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), 9, _NoiTT);
                        if (_obttbn9.KhamBenh.KhamBenh_GetsDichVuCTTList.Count > 0)
                            OpenWindow("frmLapPhieu.aspx?LoaiPhieu=9&noitt=" + _NoiTT + "&duyet=" + _Duyet + "&MaBN=" + txtSoCMT.Text + "&NgayDK=" + DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None) + "&PubMaDT=" + _PubMaDT);
                        _obttbn9 = null;
                    }
                }

                LoadData(false);
                SetData();
                enableTNBN(false);
                BefoChuyenDT();
                if (_LoaiPhieu == 2 && HTC.ShareVariables.pub_spC != "PS")
                    chkTraiTuyen.Focus();
                else if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && HTC.ShareVariables.pub_spC != "PS")
                    txtMaKhoa.Focus();
                else if ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && HTC.ShareVariables.pub_spC == "PS")
                {
                    if (txtKyhieu.Text != "")
                        txtsohd.Focus();
                    else
                        txtKyhieu.Focus();
                }
                else if (_LoaiPhieu == 1 && _PubMaDT == "TT")
                    cboChuyenKhoa.Focus();
                else if (_LoaiPhieu == 1 && _PubMaDT == "CC")
                {
                    txtMaKhoa.Focus();
                    cboChuyenKhoa.Enabled = false;
                }
                else if (_LoaiPhieu == 1 && _PubMaDT == "BH")
                    chkTraiTuyen.Focus();
                else if (_LoaiPhieu == 1)
                    txtMaKhoa.Focus();

            }
        }

    }
    private void visablecontrol()
    {
        if (HTC.ShareVariables.pub_spC != "PS" && ((_NoiTT == "085" && _LoaiPhieu == 2) || _NoiTT == "091" || _NoiTT == "092" || _NoiTT == "093" || (_NoiTT == "087" && _LoaiPhieu != 7) || _NoiTT == "095"))
        {
            txtKyhieu.Enabled = false;
            txtsohd.Enabled = false;
        }
        if (HTC.ShareVariables.pub_spC == "YH" && ((_NoiTT == "087" && _LoaiPhieu != 7) || _NoiTT == "093"))
        {
            txtKyhieu.Enabled = true;
            txtsohd.Enabled = true;
        }
        if (HTC.ShareVariables.pub_spC == "PS")
            txtkyquy.Enabled = false;
        if (txthoten.Text != "" && txtSoThe.Text == "")
        {
            ttbh.Visible = false;
            Label43.Enabled = false;
            txtSoThe.Enabled = false;
            chkTraiTuyen.Visible = false;

        }


        if (_LoaiPhieu == 1 && _Duyet == 0)
        {
            tthd.Visible = false;
            chkTraiTuyen.Visible = false;
            dtNgayQT.Visible = false;
            Label6.Visible = true;
            Label6.Text = "Hồ sơ KT";
            if (HTC.ShareVariables.pub_spC == "PH")
            {
                txtMaBAQL.Visible = true;
                txtMaBAQL.AutoPostBack = true;
                txtMaBAQL.Enabled = true;
            }
        }
        else if (_LoaiPhieu == 1 && _Duyet == 1)
        {
            tthd.Visible = true;
            chkTraiTuyen.Visible = false;
            dtNgayQT.Visible = false;
            Label6.Visible = false;
            txtMaBAQL.Visible = false;
            txtMaBAQL.AutoPostBack = false;
            txtMaBAQL.Enabled = false;
            Label12.Visible = false;
            txtKyhieu.Visible = false;
            txtsohd.Visible = false;
            Label15.Visible = false;
            Label17.Visible = false;
            txtkyquy.Visible = false;
            txtMG.Visible = false;
            cboNguoiDuyet.Visible = false;
            Label14.Visible = false;
        }
        else if (_LoaiPhieu == 2)
        {
            //if (HTC.ShareVariables.pub_spC == "YH")
            //    dtNgayQT.Enabled = false;
            //else
            //    dtNgayQT.Enabled = true;
            dtNgayQT.Visible = true;
            Label6.Visible = true;

        }
        else if (_LoaiPhieu == 7)
        {
            Label15.Visible = false;
            txtkyquy.Visible = false;
            dtNgayQT.Visible = false;
            Label6.Visible = false;
        }
        else
        {
            dtNgayQT.Visible = false;
            Label6.Visible = false;
        }
        if (_NoiTT == "087" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH"))
        {
            txtMaBAQL.Enabled = true;
        }
        //if (_LoaiPhieu == 2 && HTC.ShareVariables.pub_spC != "PS")
        //{
        //    chkTraiTuyen.Visible = true;
        //}
        if (!(_NoiTT == "090" || _NoiTT == "094" || (_LoaiPhieu == 7 && _NoiTT == "087") || (_LoaiPhieu == 7 && HTC.ShareVariables.pub_spC == "QN" && _NoiTT == "085")))
        {
            Label5.Visible = false;
            txtSLSac.Visible = false;

        }

        if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 7 || _NoiTT == "089" || (_NoiTT == "090" || _NoiTT == "094" || _NoiTT == "093") || _NoiTT == "091" || _NoiTT == "092" || _NoiTT == "093") // thu dich vu, ban thuoc,  clc, pk56,ban thuoc dy, ban ngoai gio
        {
            ttbh.Visible = false;
            Label43.Enabled = false;
            txtSoThe.Enabled = false;
            chkTraiTuyen.Visible = false;
            ttgt.Visible = false;
        }
        if (txtSoThe.Text == "" && _LoaiPhieu == 1 && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0)
        {
            dtBHYTDN.Enabled = true;
            dtBHYTTN.Enabled = true;
            cboDKBD.Enabled = true;


        }
        else if ((txtSoThe.Text == "" && _LoaiPhieu != 1))
        {
            dtBHYTDN.Enabled = false;
            dtBHYTTN.Enabled = false;
            cboDKBD.Enabled = false;
            txtDKBD.Enabled = false;
            cboDKGT.Enabled = false;
            txtDKGT.Enabled = false;
            cboCDnoiGT.Enabled = false;

            txtBenhNGT.Enabled = false;
        }
        else if (txtmabn.Text == "")
        {
            dtBHYTDN.Enabled = true;
            dtBHYTTN.Enabled = true;
            cboDKBD.Enabled = true;

            cboDKGT.Enabled = true;

            cboCDnoiGT.Enabled = true;
            txtBenhNGT.Enabled = true;
        }
        if (_LoaiPhieu == 7)
        {
            Label22.Visible = false;
            cboChuyenKhoa.Visible = false;
            //if (_ThongtinBN.MaBN != "" && _ThongtinBN.MaTinh != "")
            //{
            //    ttdcbn.Visible = true;
            //}
            //else
            //    ttdcbn.Visible = false;
            ttbngc.Visible = false;
        }
        if ((_LoaiPhieu == 2 && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0) || _LoaiPhieu == 1)
        {
            if (_LoaiPhieu == 2 && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                tthd.Visible = true;
            if (cboDoiTuong.SelectedValue.Substring(cboDoiTuong.SelectedValue.Length - 1, 1) == "8" || cboDoiTuong.SelectedValue.Substring(0, 1) == "0")
            {
                ttgt.Visible = false;
            }
            else if (cboDoiTuong.SelectedValue.Substring(cboDoiTuong.SelectedValue.Length - 1, 1) != "8" && cboDoiTuong.SelectedValue.Substring(0, 1) == "1")
            {
                ttgt.Visible = true;
            }
        }
        else
        {
            if (_LoaiPhieu == 2 && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0 && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "YH"))
                tthd.Visible = true;
            else if (_LoaiPhieu == 2 && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0)
                tthd.Visible = false;
            else if (_LoaiPhieu == 3)
            {
                tthd.Visible = true;
                Label12.Visible = false;
                txtKyhieu.Visible = false;
                Label14.Visible = false;
                txtsohd.Visible = false;
                Label15.Visible = false;
                txtkyquy.Visible = false;
                Label17.Visible = false;
                txtMG.Visible = false;
                cboNguoiDuyet.Visible = false;
            }
            ttgt.Visible = false;
        }
        if (_PubMaDT == "TT" && HTC.ShareVariables.pub_spC == "PS")
        {

            txtSoThe.Enabled = false;
            dtBHYTTN.Enabled = false;
            dtBHYTDN.Enabled = false;
            cboDKBD.Enabled = false;
            txtDKBD.Enabled = false;
            cboDoiTuong.Enabled = false;
            chkTraiTuyen.Visible = false;
        }
        else if (_PubMaDT == "TT" && HTC.ShareVariables.pub_spC == "PS")
        {

            txtSoThe.Enabled = false;
            dtBHYTTN.Enabled = false;
            dtBHYTDN.Enabled = false;
            cboDKBD.Enabled = false;
            txtDKBD.Enabled = false;
            chkTraiTuyen.Visible = false;
        }
    }
    protected void txtmabn_TextChanged(object sender, EventArgs e)
    {

        SearchBN();
    }
    private void enableTNBN(Boolean cancel = true)
    {
        txtmabn.Enabled = cancel;
        dtNgayDK.Enabled = cancel;
        dtNgaySinh.Enabled = cancel;
        txthoten.Enabled = cancel;
        txtSoCMT.Enabled = cancel;
        optGT.Enabled = cancel;
        txtMaBAQL.Enabled = cancel;
        txtBaoTin.Enabled = cancel;
        txttuoi.Enabled = cancel;
        txtMaBAQL.Enabled = cancel;
        cbohuyen.Enabled = cancel;
        txtDiaChi.Enabled = cancel;
        cbotinh.Enabled = cancel;
        cboNgheNghiep.Enabled = cancel;
        cboDanToc.Enabled = cancel;
        cboquocgia.Enabled = cancel;
        txtdienthoai.Enabled = cancel;
        // cboDoiTuong.Enabled = cancel;
        if (txtSoThe.Text == "" && _LoaiPhieu == 1 && _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count == 0 && _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count == 0)
        {
            dtBHYTDN.Enabled = true;
            dtBHYTTN.Enabled = true;
            cboDKBD.Enabled = true;
            txtDKBD.Enabled = true;

        }
        else
        {
            txtSoThe.Enabled = cancel;
            dtBHYTDN.Enabled = cancel;
            dtBHYTTN.Enabled = cancel;

            cboDKBD.Enabled = cancel;
            txtDKBD.Enabled = cancel;

        }
        cboDKGT.Enabled = cancel;
        txtDKGT.Enabled = cancel;
        cboCDnoiGT.Enabled = cancel;

        txtBenhNGT.Enabled = cancel;
        if (_PubMaDT == "TT")
        {

            txtSoThe.Enabled = false;
            dtBHYTTN.Enabled = false;
            dtBHYTDN.Enabled = false;
            cboDKBD.Enabled = false;
            txtDKBD.Enabled = false;
            cboDoiTuong.Enabled = false;
            chkTraiTuyen.Visible = false;
        }
    }
    protected void txtSoThe_TextChanged(object sender, EventArgs e)
    {
        KiemTraSoThe();
    }
    protected void KiemTraSoThe()
    {
        try
        {
            string madt = _ThongtinBN.KhamBenh.MaDT;

            if (txtSoThe.Text != "" && txtmabn.Text == "")
            {
                if (txtSoThe.Text.Substring(0, 3).ToUpper() == "HN5" || txtSoThe.Text.Substring(0, 3).ToUpper() == "HT5")
                {
                    ShowMessage("Thẻ đã không được phát hành");
                    return;
                }

                ThongtinBN _obttbn = ThongtinBN.GetThongtinBN(txtSoThe.Text, DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), _LoaiPhieu, _NoiTT);
                if (_obttbn != null && _obttbn.MaBN != "")
                {
                    _ThongtinBN = _obttbn;
                    _MaBN = _ThongtinBN.MaBN;
                    _NgayDK = DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);
                    if (_ThongtinBN.KhamBenh.IsNew == true)
                    {
                        //DMTheBH _dmthebh = DMTheBH.GetDMTheBH(txtSoThe.Text.Substring(0, 2).ToUpper());
                        //if (txtSoThe.Text.Substring(0, 3).ToUpper() == "HT2")
                        //{
                        //    _dmthebh.MaDT = "10002";
                        //    _ThongtinBN.KhamBenh.sotienbhtra = 1000000000;
                        //}

                        //if (_NoiTT == "085")
                        //{

                        //    _ThongtinBN.MaDT = _dmthebh.MaDT;
                        //    _ThongtinBN.KhamBenh.MaDT = _ThongtinBN.MaDT;
                        //    DMDoiTuong _DMDoiTuong = DMDoiTuong.GetDMDoiTuong(_ThongtinBN.MaDT);
                        //    cboDoiTuong.SelectedValue = _DMDoiTuong.MaDT;
                        //    _ThongtinBN.KhamBenh.bhtra = _DMDoiTuong.bhtra;
                        //    _ThongtinBN.KhamBenh.MaDT = _DMDoiTuong.MaDT;
                        //    _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuong.Sotien;

                        //}
                        //else
                        //{
                        //    _ThongtinBN.MaDT = "11" + _dmthebh.MaDT.Substring(2, 3);
                        //    _ThongtinBN.KhamBenh.MaDT = _ThongtinBN.MaDT;
                        //    DMDoiTuong _DMDoiTuong = DMDoiTuong.GetDMDoiTuong(_ThongtinBN.MaDT);
                        //    cboDoiTuong.SelectedValue = _DMDoiTuong.MaDT;
                        //    _ThongtinBN.KhamBenh.bhtra = _DMDoiTuong.bhtra;
                        //    _ThongtinBN.KhamBenh.MaDT = _DMDoiTuong.MaDT;
                        //    _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuong.Sotien;

                        //}
                        if (cboDoiTuong.SelectedValue.Substring(cboDoiTuong.SelectedValue.Length - 1, 1) != "8" && cboDoiTuong.SelectedValue.Substring(0, 1) != "2")
                        {
                            if ((txtSoThe.Text.Substring(0, 3).ToUpper()) == "HN4" || txtSoThe.Text.Substring(0, 3).ToUpper() == "BT4" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "KC7" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "CB7" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "QN5" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "CA5" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "CY5")
                            {
                                if (_NoiTT == "085")
                                    cboDoiTuong.SelectedValue = "10002";
                                else
                                    cboDoiTuong.SelectedValue = "11002";
                                DMDoiTuong _dmdoituong = DMDoiTuong.GetDMDoiTuong(cboDoiTuong.SelectedValue);
                                _ThongtinBN.KhamBenh.Sothe = txtSoThe.Text;
                                _ThongtinBN.Sothe = txtSoThe.Text;
                                _ThongtinBN.KhamBenh.bhtra = _dmdoituong.bhtra;
                                _ThongtinBN.KhamBenh.sotienbhtra = _dmdoituong.Sotien;
                                _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                                _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                                _ThongtinBN.KhamBenh.Sothe = txtSoThe.Text;
                                _ThongtinBN.Sothe = txtSoThe.Text;
                            }
                            else if (txtSoThe.Text.Substring(0, 3).ToUpper() == "CN6" || txtSoThe.Text.Substring(0, 3).ToUpper() == "TC7")
                            {
                                if (_NoiTT == "085")
                                    cboDoiTuong.SelectedValue = "10007";
                                else
                                    cboDoiTuong.SelectedValue = "11007";
                                DMDoiTuong _dmdoituong = DMDoiTuong.GetDMDoiTuong(cboDoiTuong.SelectedValue);
                                _ThongtinBN.KhamBenh.bhtra = _dmdoituong.bhtra;
                                _ThongtinBN.KhamBenh.sotienbhtra = _dmdoituong.Sotien;
                                _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                                _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                                _ThongtinBN.KhamBenh.Sothe = txtSoThe.Text;
                                _ThongtinBN.Sothe = txtSoThe.Text;
                            }
                            else
                            {
                                DMDoiTuongList _DMDoiTuongList = DMDoiTuongList.FindDMDoiTuongKyHieu(txtSoThe.Text.Substring(2, 1));
                                if (_DMDoiTuongList.Count > 0)
                                {
                                    if (_NoiTT == "085")
                                    {
                                        cboDoiTuong.SelectedValue = _DMDoiTuongList[0].MaDT;
                                    }
                                    else if (_NoiTT == "087")
                                    {
                                        cboDoiTuong.SelectedValue = "11" + _DMDoiTuongList[0].MaDT.Substring(2);
                                    }
                                    _ThongtinBN.KhamBenh.bhtra = _DMDoiTuongList[0].bhtra;
                                    _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuongList[0].Sotien;
                                    _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                                    _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                                    _ThongtinBN.KhamBenh.Sothe = txtSoThe.Text;
                                    _ThongtinBN.Sothe = txtSoThe.Text;
                                }
                            }
                        }
                        //_ThongtinBN.KhamBenh.MaDT = _ThongtinBN.MaDT;
                        //DMDoiTuong _DMDoiTuong = DMDoiTuong.GetDMDoiTuong(_ThongtinBN.MaDT);

                        //if (_DMDoiTuong != null)
                        //{
                        //    cboDoiTuong.SelectedValue = _DMDoiTuong.MaDT;
                        //    _ThongtinBN.KhamBenh.bhtra = _DMDoiTuong.bhtra;
                        //    _ThongtinBN.KhamBenh.MaDT = _DMDoiTuong.MaDT;
                        //    _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuong.Sotien;
                        //}
                    }

                    if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN") && txtSoThe.Text != "")
                    {
                        if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 2 || _LoaiPhieu == 1)
                            if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                            {
                                foreach (KhamBenh_C a in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                                {
                                    if (a.DaTT != 0 && a.MaDT.Substring(0, 1) == "0" && (a.SLTra == "0" || a.SLTra == ""))
                                    {
                                        ShowMessage("Đã thanh toán bệnh nhân!Yêu cầu hủy thanh toán");
                                        return;
                                    }
                                }
                            }

                        //if (txtSoThe.Text != "" && _ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Count > 0)
                        //{
                        //    foreach (KhamBenh_HoaDon a in _ThongtinBN.KhamBenh.KhamBenh_HoaDonList)
                        //    {
                        //        if (a.TongChi == 0 && a.MaDT.Substring(0, 1) == "0")
                        //        {
                        //            ShowMessage("Bệnh nhân BH đã được thanh toán, không thể thêm, xóa, sửa dịch vụ. Muốn nhập thêm, xóa, sửa dịch vụ, yêu cầu TCKT hoàn thanh toán!");
                        //            return;
                        //        }
                        //    }
                        //}
                    }
                    if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count > 0 && madt != "" && cboDoiTuong.SelectedValue != madt)
                    {
                        _ThongtinBN.ApplyEdit();
                        _ThongtinBN.KhamBenh.ApplyEdit();
                        _ThongtinBN.Save();
                        _ThongtinBN.KhamBenh.Save();
                        string sql = "exec spKhambenh_TINHLAIDT '" + _ThongtinBN.KhamBenh.MaSoKham + "','" + cboDoiTuong.SelectedValue + "'," + _LoaiPhieu.ToString() + ",''";
                        HTC.Business.DataProvider.Instance().ExcSQL(sql);
                        Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={1}&&noitt={0}&&duyet={2}&PubMaDT={5}&&maBN={3}&&ngayDK={4}", _NoiTT, _LoaiPhieu, _Duyet, _ThongtinBN.MaBN, dtNgayDK.Text, _PubMaDT), false);
                    }
                    LoadData(false);
                    SetData();
                    enableTNBN(false);
                    dtNgayDK.Enabled = false;
                    txtmabn.Enabled = false;
                    BefoChuyenDT();
                    if (_LoaiPhieu == 2 && _ThongtinBN.MaBN != "" && HTC.ShareVariables.pub_spC == "YH")
                    {

                        if (DateDiff(DateInterval.Day, DateTime.Parse(_ThongtinBN.GiaTriDN), DateTime.Now) > 0)
                        {

                            enableTNBN(true);
                            dtBHYTTN.Focus();
                        }
                        else if (txtDiaChi.Text == "")
                        {
                            enableTNBN(true);
                            txtDiaChi.Focus();
                        }
                        else if (cbotinh.SelectedValue == "")
                        {

                            enableTNBN(true);
                            cbotinh.Focus();
                        }
                        else if (cbohuyen.SelectedValue == "")
                        {
                            enableTNBN(true);
                            cbohuyen.Focus();
                        }
                        else
                        {

                            cboKhoaKB.Focus();
                        }
                    }
                    else if (_LoaiPhieu == 2 && _ThongtinBN.MaBN == "" && HTC.ShareVariables.pub_spC == "YH")
                    {
                        dtBHYTTN.Focus();
                    }
                    else if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) && HTC.ShareVariables.pub_spC != "PS")
                        txtMaKhoa.Focus();
                    else if (_LoaiPhieu == 1 && _PubMaDT == "TT")
                        cboChuyenKhoa.Focus();
                    else if (_LoaiPhieu == 1 && _PubMaDT == "BH")
                        chkTraiTuyen.Focus();
                    else if (_LoaiPhieu == 1)
                        txtMaKhoa.Focus();
                    else
                        dtBHYTTN.Focus();
                    return;
                }
            }
            if (txtSoThe.Text != "")
            {
                if ((txtSoThe.Text.Length != 15 && HTC.ShareVariables.pub_spC != "YH") || (!(txtSoThe.Text.Length == 15 || txtSoThe.Text.Length == 16) && HTC.ShareVariables.pub_spC == "YH"))
                {
                    ShowMessage("Số thẻ bảo hiểm phải có 15 ký tự!");
                    return;
                }
                //if (cboDKBD.Text == "" && HTC.ShareVariables.pub_sMaBHXH != "")
                //{
                //    RadComboBoxItem selectedItem = new RadComboBoxItem();

                //    selectedItem.Text = HTC.ShareVariables.pub_sMaBHXH;
                //    selectedItem.Value = HTC.ShareVariables.pub_sMaBV;
                //    cboDKBD.Items.Add(selectedItem);
                //    selectedItem.Selected = true;
                //    selectedItem.DataBind();
                //    cboDKBD.DataBind();
                //    txtDKBD.Text = HTC.ShareVariables.pub_sTenBVBHXH;
                //}
                if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN") && txtSoThe.Text != "")
                {
                    if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 2 || _LoaiPhieu == 1)

                        if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                        {
                            foreach (KhamBenh_C a in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                            {
                                if (a.DaTT != 0 && a.MaDT.Substring(0, 1) == "0" && (a.SLTra == "0" || a.SLTra == ""))
                                {
                                    ShowMessage("Đã thanh toán bệnh nhân!Yêu cầu hủy thanh toán");
                                    return;
                                }
                            }
                        }

                }
                if (cboDKBD.Text == "" && HTC.ShareVariables.pub_sTenBVBHXH != "")
                {
                    cboDKBD.Text = HTC.ShareVariables.pub_sTenBVBHXH;
                    cboDKBD.SelectedValue = HTC.ShareVariables.pub_sMaBV;
                    txtDKBD.Text = HTC.ShareVariables.pub_sMaBHXH;
                }
                if (cboDoiTuong.SelectedValue.Substring(cboDoiTuong.SelectedValue.Length - 1, 1) != "8" && cboDoiTuong.SelectedValue.Substring(0, 1) != "2")
                {
                    if (cboDoiTuong.SelectedValue.Substring(cboDoiTuong.SelectedValue.Length - 1, 1) != "8")
                    {
                        if ((txtSoThe.Text.Substring(0, 3).ToUpper()) == "HN4" || txtSoThe.Text.Substring(0, 3).ToUpper() == "BT4" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "KC7" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "CB7" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "QN5" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "CA5" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "CY5")
                        {
                            if (_NoiTT == "085")
                                cboDoiTuong.SelectedValue = "10002";
                            else
                                cboDoiTuong.SelectedValue = "11002";
                            DMDoiTuong _dmdoituong = DMDoiTuong.GetDMDoiTuong(cboDoiTuong.SelectedValue);
                            _ThongtinBN.KhamBenh.bhtra = _dmdoituong.bhtra;
                            _ThongtinBN.KhamBenh.sotienbhtra = _dmdoituong.Sotien;
                            _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                            _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                            _ThongtinBN.KhamBenh.Sothe = txtSoThe.Text;
                            _ThongtinBN.Sothe = txtSoThe.Text;
                        }
                        else if (txtSoThe.Text.Substring(0, 3).ToUpper() == "CN6" || txtSoThe.Text.Substring(0, 3).ToUpper() == "TC7")
                        {
                            if (_NoiTT == "085")
                                cboDoiTuong.SelectedValue = "10007";
                            else
                                cboDoiTuong.SelectedValue = "11007";
                            DMDoiTuong _dmdoituong = DMDoiTuong.GetDMDoiTuong(cboDoiTuong.SelectedValue);
                            _ThongtinBN.KhamBenh.bhtra = _dmdoituong.bhtra;
                            _ThongtinBN.KhamBenh.sotienbhtra = _dmdoituong.Sotien;
                            _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                            _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                            _ThongtinBN.KhamBenh.Sothe = txtSoThe.Text;
                            _ThongtinBN.Sothe = txtSoThe.Text;
                        }

                        else
                        {
                            DMDoiTuongList _DMDoiTuongList = DMDoiTuongList.FindDMDoiTuongKyHieu(txtSoThe.Text.Substring(2, 1));
                            if (_DMDoiTuongList.Count > 0)
                            {
                                if (_NoiTT == "085")
                                {
                                    cboDoiTuong.SelectedValue = _DMDoiTuongList[0].MaDT;
                                }
                                else if (_NoiTT == "087")
                                {
                                    cboDoiTuong.SelectedValue = "11" + _DMDoiTuongList[0].MaDT.Substring(2);
                                }
                                _ThongtinBN.KhamBenh.bhtra = _DMDoiTuongList[0].bhtra;
                                _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuongList[0].Sotien;
                                _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                                _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                                _ThongtinBN.KhamBenh.Sothe = txtSoThe.Text;
                                _ThongtinBN.Sothe = txtSoThe.Text;
                            }
                        }
                    }
                    //    if (_NoiTT == "085")
                    //    {
                    //        if (_DMDoiTuongList.Count > 0)
                    //        {
                    //            cboDoiTuong.SelectedValue = _DMDoiTuongList[0].MaDT;
                    //            _ThongtinBN.KhamBenh.bhtra = _DMDoiTuongList[0].bhtra;
                    //            _ThongtinBN.KhamBenh.MaDT = _DMDoiTuongList[0].MaDT;
                    //            _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuongList[0].Sotien;
                    //        }
                    //    }
                    //    else
                    //    {
                    //        if (_DMDoiTuongList.Count > 1)
                    //        {

                    //            cboDoiTuong.SelectedValue = _DMDoiTuongList[1].MaDT;
                    //            _ThongtinBN.KhamBenh.bhtra = _DMDoiTuongList[1].bhtra;
                    //            _ThongtinBN.KhamBenh.MaDT = _DMDoiTuongList[1].MaDT;
                    //            _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuongList[1].Sotien;

                    //        }
                    //        else if (_DMDoiTuongList.Count > 0)
                    //        {
                    //            cboDoiTuong.SelectedValue = _DMDoiTuongList[0].MaDT;
                    //            _ThongtinBN.KhamBenh.bhtra = _DMDoiTuongList[0].bhtra;
                    //            _ThongtinBN.KhamBenh.MaDT = _DMDoiTuongList[0].MaDT;
                    //            _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuongList[0].Sotien;
                    //        }

                    //    }
                }

                if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count > 0)
                {
                    _ThongtinBN.ApplyEdit();
                    _ThongtinBN.KhamBenh.ApplyEdit();
                    _ThongtinBN.Save();
                    _ThongtinBN.KhamBenh.Save();
                    string sql = "exec spKhambenh_TINHLAIDT '" + _ThongtinBN.KhamBenh.MaSoKham + "','" + cboDoiTuong.SelectedValue + "'," + _LoaiPhieu.ToString() + ",''";
                    HTC.Business.DataProvider.Instance().ExcSQL(sql);
                    // Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={1}&PubMaDT={5}&&noitt={0}&&duyet={2}&&maBN={3}&&ngayDK={4}", _NoiTT, _LoaiPhieu, _Duyet, _ThongtinBN.MaBN, dtNgayDK.Text, _PubMaDT), false);
                    Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={1}&PubMaDT={5}&&noitt={0}&&duyet={2}&&maBN={3}&&ngayDK={4}", _NoiTT, _LoaiPhieu, _Duyet, _ThongtinBN.MaBN, dtNgayDK.Text, _PubMaDT), false);

                }
                if (dtBHYTTN.Text == "")
                {
                    dtBHYTTN.Text = "01/01/" + DateTime.Now.Year.ToString();
                    dtBHYTDN.Text = "31/12/" + DateTime.Now.Year.ToString();
                    chkTraiTuyen.Focus();
                }
                BefoChuyenDT();
            }
            else if ((_LoaiPhieu == 2 || _PubMaDT == "CC") && txtSoThe.Text != "" && cboDoiTuong.SelectedValue.Substring(0, 1) != "2")
            {
                if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN") && txtSoThe.Text != "")
                {
                    if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 2 || _LoaiPhieu == 1)
                        if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                        {
                            foreach (KhamBenh_C a in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                            {
                                if (a.DaTT != 0 && a.MaDT.Substring(0, 1) == "0" && (a.SLTra == "0" || a.SLTra == ""))
                                {
                                    ShowMessage("Đã thanh toán bệnh nhân!Yêu cầu hủy thanh toán");
                                    return;
                                }
                            }
                        }

                }
                if (cboDoiTuong.SelectedValue.Substring(cboDoiTuong.SelectedValue.Length - 1, 1) != "8" && cboDoiTuong.SelectedValue.Substring(0, 1) != "2")
                {
                    if ((txtSoThe.Text.Substring(0, 3).ToUpper()) == "HN4" || txtSoThe.Text.Substring(0, 3).ToUpper() == "BT4" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "KC7" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "CB7" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "QN5" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "CA5" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "CY5")
                    {
                        if (_NoiTT == "085")
                            cboDoiTuong.SelectedValue = "10002";
                        else
                            cboDoiTuong.SelectedValue = "11002";
                        DMDoiTuong _dmdoituong = DMDoiTuong.GetDMDoiTuong(cboDoiTuong.SelectedValue);
                        _ThongtinBN.KhamBenh.bhtra = _dmdoituong.bhtra;
                        _ThongtinBN.KhamBenh.sotienbhtra = _dmdoituong.Sotien;
                        _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                        _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                        _ThongtinBN.KhamBenh.Sothe = txtSoThe.Text;
                        _ThongtinBN.Sothe = txtSoThe.Text;
                    }
                    else if (txtSoThe.Text.Substring(0, 3).ToUpper() == "CN6" || txtSoThe.Text.Substring(0, 3).ToUpper() == "TC7")
                    {
                        if (_NoiTT == "085")
                            cboDoiTuong.SelectedValue = "10007";
                        else
                            cboDoiTuong.SelectedValue = "11007";
                        DMDoiTuong _dmdoituong = DMDoiTuong.GetDMDoiTuong(cboDoiTuong.SelectedValue);
                        _ThongtinBN.KhamBenh.bhtra = _dmdoituong.bhtra;
                        _ThongtinBN.KhamBenh.sotienbhtra = _dmdoituong.Sotien;
                        _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                        _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                        _ThongtinBN.KhamBenh.Sothe = txtSoThe.Text;
                        _ThongtinBN.Sothe = txtSoThe.Text;
                    }

                    else
                    {
                        DMDoiTuongList _DMDoiTuongList = DMDoiTuongList.FindDMDoiTuongKyHieu(txtSoThe.Text.Substring(2, 1));
                        if (_DMDoiTuongList.Count > 0)
                        {
                            if (_NoiTT == "085")
                            {
                                cboDoiTuong.SelectedValue = _DMDoiTuongList[0].MaDT;
                            }
                            else if (_NoiTT == "087")
                            {
                                cboDoiTuong.SelectedValue = "11" + _DMDoiTuongList[0].MaDT.Substring(2);
                            }
                            _ThongtinBN.KhamBenh.bhtra = _DMDoiTuongList[0].bhtra;
                            _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuongList[0].Sotien;
                            _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                            _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                            _ThongtinBN.KhamBenh.Sothe = txtSoThe.Text;
                            _ThongtinBN.Sothe = txtSoThe.Text;
                        }
                    }
                }

                if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count > 0)
                {
                    _ThongtinBN.ApplyEdit();
                    _ThongtinBN.KhamBenh.ApplyEdit();
                    _ThongtinBN.Save();
                    _ThongtinBN.KhamBenh.Save();
                    string sql = "exec spKhambenh_TINHLAIDT '" + _ThongtinBN.KhamBenh.MaSoKham + "','" + cboDoiTuong.SelectedValue + "'," + _LoaiPhieu.ToString() + ",''";
                    HTC.Business.DataProvider.Instance().ExcSQL(sql);
                    Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={1}&PubMaDT={5}&&noitt={0}&&duyet={2}&&maBN={3}&&ngayDK={4}", _NoiTT, _LoaiPhieu, _Duyet, _ThongtinBN.MaBN, dtNgayDK.Text, _PubMaDT), false);
                }
            }
            visablecontrol();
            if (txtmabn.Text != "")
                enableTNBN(false);
            else
                enableTNBN(true);
            if (HTC.ShareVariables.pub_spC == "YH")
            {

                grdXNTT.MasterTableView.IsItemInserted = true;
                grdXNTT.MasterTableView.InsertItem();
                grdXNTT.Rebind();
                dtBHYTTN.Focus();
            }
        }
        catch (Exception ex)
        {
            ShowMessage("Không kiểm tra được thẻ này" + ex.Message);
        }
    }

    protected void grdChiTiet_ToggleSelectedState(object sender, EventArgs e)
    {
        CheckBox headerCheckBox = (sender as CheckBox);

        foreach (GridDataItem dataItem in grdCTT.MasterTableView.Items)
        {
            (dataItem.FindControl("Chkbox") as CheckBox).Checked = headerCheckBox.Checked;
            dataItem.Selected = headerCheckBox.Checked;
        }
    }
    protected void grdChiTietDaTT_ToggleSelectedState(object sender, EventArgs e)
    {
        CheckBox headerCheckBox = (sender as CheckBox);

        foreach (GridDataItem dataItem in grdDTT.MasterTableView.Items)
        {
            (dataItem.FindControl("Chkbox") as CheckBox).Checked = headerCheckBox.Checked;
            dataItem.Selected = headerCheckBox.Checked;
        }
    }
    protected void chkTraiTuyen_CheckedChanged(object sender, EventArgs e)
    {

        if (txtSoThe.Text != "")
        {

            if (chkTraiTuyen.Checked == true)
            {
                if (HTC.ShareVariables.pub_spC == "YH")
                    cboDoiTuong.SelectedValue = cboDoiTuong.SelectedValue.Substring(0, 3) + "18";

                else
                    cboDoiTuong.SelectedValue = cboDoiTuong.SelectedValue.Substring(0, 3) + "28";
                DMDoiTuong _DMDoiTuong = DMDoiTuong.GetDMDoiTuong(cboDoiTuong.SelectedValue);

                if (_DMDoiTuong != null)
                {
                    cboDoiTuong.SelectedValue = _DMDoiTuong.MaDT;
                    _ThongtinBN.KhamBenh.bhtra = _DMDoiTuong.bhtra;
                    _ThongtinBN.KhamBenh.MaDT = _DMDoiTuong.MaDT;
                    _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuong.Sotien;
                }

                BefoChuyenDT();
            }
            else
            {
                if ((txtSoThe.Text.Substring(0, 3).ToUpper()) == "HN4" || txtSoThe.Text.Substring(0, 3).ToUpper() == "BT4" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "KC7" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "CB7" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "QN5" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "CA5" || (txtSoThe.Text.Substring(0, 3).ToUpper()) == "CY5")
                {
                    if (_NoiTT == "085")
                        cboDoiTuong.SelectedValue = "10002";
                    else
                        cboDoiTuong.SelectedValue = "11002";
                    DMDoiTuong _dmdoituong = DMDoiTuong.GetDMDoiTuong(cboDoiTuong.SelectedValue);
                    _ThongtinBN.KhamBenh.bhtra = _dmdoituong.bhtra;
                    _ThongtinBN.KhamBenh.sotienbhtra = _dmdoituong.Sotien;
                    _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                    _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                }
                else if (txtSoThe.Text.Substring(0, 3).ToUpper() == "CN6" || txtSoThe.Text.Substring(0, 3).ToUpper() == "TC7")
                {
                    if (_NoiTT == "085")
                        cboDoiTuong.SelectedValue = "10007";
                    else
                        cboDoiTuong.SelectedValue = "11007";
                    DMDoiTuong _dmdoituong = DMDoiTuong.GetDMDoiTuong(cboDoiTuong.SelectedValue);
                    _ThongtinBN.KhamBenh.bhtra = _dmdoituong.bhtra;
                    _ThongtinBN.KhamBenh.sotienbhtra = _dmdoituong.Sotien;
                    _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                    _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                }
                else
                {
                    DMDoiTuongList _DMDoiTuongList = DMDoiTuongList.FindDMDoiTuongKyHieu(txtSoThe.Text.Substring(2, 1));
                    if (_DMDoiTuongList.Count > 0)
                    {
                        if (_NoiTT == "085")
                        {
                            cboDoiTuong.SelectedValue = _DMDoiTuongList[0].MaDT;
                        }
                        else if (_NoiTT == "087")
                        {
                            cboDoiTuong.SelectedValue = "11" + _DMDoiTuongList[0].MaDT.Substring(2);
                        }
                        _ThongtinBN.KhamBenh.bhtra = _DMDoiTuongList[0].bhtra;
                        _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuongList[0].Sotien;
                        _ThongtinBN.MaDT = cboDoiTuong.SelectedValue;
                        _ThongtinBN.KhamBenh.MaDT = cboDoiTuong.SelectedValue;
                    }
                }
                //DMDoiTuongList _DMDoiTuongList = DMDoiTuongList.FindDMDoiTuongKyHieu(txtSoThe.Text.Substring(2, 1));

                //if (_NoiTT == "085")
                //{
                //    if (_DMDoiTuongList.Count > 0)
                //    {
                //        cboDoiTuong.SelectedValue = _DMDoiTuongList[0].MaDT;
                //        _ThongtinBN.KhamBenh.bhtra = _DMDoiTuongList[0].bhtra;
                //        _ThongtinBN.KhamBenh.MaDT = _DMDoiTuongList[0].MaDT;
                //        _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuongList[0].Sotien;
                //    }
                //}
                //else
                //{
                //    if (_DMDoiTuongList.Count > 1)
                //    {

                //        cboDoiTuong.SelectedValue = _DMDoiTuongList[1].MaDT;
                //        _ThongtinBN.KhamBenh.bhtra = _DMDoiTuongList[1].bhtra;
                //        _ThongtinBN.KhamBenh.MaDT = _DMDoiTuongList[1].MaDT;
                //        _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuongList[1].Sotien;
                //    }
                //    else if (_DMDoiTuongList.Count > 0)
                //    {
                //        cboDoiTuong.SelectedValue = _DMDoiTuongList[0].MaDT;
                //        _ThongtinBN.KhamBenh.bhtra = _DMDoiTuongList[0].bhtra;
                //        _ThongtinBN.KhamBenh.MaDT = _DMDoiTuongList[0].MaDT;
                //        _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuongList[0].Sotien;
                //    }

                //}

                if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count > 0 || _ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                {
                    _ThongtinBN.ApplyEdit();
                    _ThongtinBN.KhamBenh.ApplyEdit();
                    _ThongtinBN.Save();
                    _ThongtinBN.KhamBenh.Save();
                    string sql = "exec spKhambenh_TINHLAIDT '" + _ThongtinBN.KhamBenh.MaSoKham + "','" + cboDoiTuong.SelectedValue + "'," + _LoaiPhieu.ToString() + ",''";
                    HTC.Business.DataProvider.Instance().ExcSQL(sql);
                    Response.Redirect(String.Format("~/UI/PhongKham/TiepDon/frmLapPhieu.aspx?LoaiPhieu={1}&PubMaDT={5}&&noitt={0}&&duyet={2}&&maBN={3}&&ngayDK={4}", _NoiTT, _LoaiPhieu, _Duyet, _ThongtinBN.MaBN, dtNgayDK.Text, _PubMaDT), false);
                }
                BefoChuyenDT();

            }

            dtBHYTTN.Focus();
        }
    }
    protected void txtSLThang_TextChanged(object sender, EventArgs e)
    {
        if (_KhamBenh_ThuocSD_DY == null)
            _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();

        if (_KhamBenh_ThuocSD_DY.IsNew == true)
        {
            if (_KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs.Count > 0)
            {

                _KhamBenh_ThuocSD_DY.SLThang = txtSLThang.Text;
                _KhamBenh_ThuocSD_DY.SLMua = txtSLThang.Text;
                _KhamBenh_ThuocSD_DY.TinhLaiDon();
                _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.UpdatedTo(_KhamBenh_ThuocSD_DY);
                txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
                txtTT.Value = (_KhamBenh_ThuocSD_DY.SLMua == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua)).ToString();

                tinhlaihd();
            }
        }
        else if (_KhamBenh_ThuocSD_DY.DaTTBH != 0 || _KhamBenh_ThuocSD_DY.DaTTTT != 0)
        {
            _KhamBenh_ThuocSD_DY.SLTra = decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua) - decimal.Parse(txtSLThang.Text);
            _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.UpdatedTo(_KhamBenh_ThuocSD_DY, _ThongtinBN.KhamBenh);
            _KhamBenh_ThuocSD_DY.TinhLaiDon();

            txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
            txtTT.Value = (_KhamBenh_ThuocSD_DY.SLTra.ToString() == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / (_KhamBenh_ThuocSD_DY.SLTra)).ToString();

            tinhlaihd();
        }
        else if (txtSLThang.Text != "")
        {
            _KhamBenh_ThuocSD_DY.SLMua = txtSLThang.Text;
            _KhamBenh_ThuocSD_DY.SLThang = txtSLThang.Text;
            _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.UpdatedTo(_KhamBenh_ThuocSD_DY);
            _KhamBenh_ThuocSD_DY.TinhLaiDon();

            txtTongDon.Text = _KhamBenh_ThuocSD_DY.TongDon;
            txtTT.Value = (_KhamBenh_ThuocSD_DY.SLMua == "0") ? "0" : (decimal.Parse(_KhamBenh_ThuocSD_DY.TongDon) / decimal.Parse(_KhamBenh_ThuocSD_DY.SLMua)).ToString();

            tinhlaihd();
        }

    }
    private void tinhlaihd()
    {
        if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) != "1" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _ThongtinBN.KhamBenh.MaSoKham != "" && _LoaiPhieu != 1 && _LoaiPhieu != 7 && _NoiTT == "085")
            _LoaiPhieu = 9;
        else if (_ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "1" && (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _ThongtinBN.KhamBenh.MaSoKham != "" && _LoaiPhieu != 1 && _LoaiPhieu != 7 && _NoiTT == "085")
            _LoaiPhieu = 2;

        if ((_LoaiPhieu != 1 || (_LoaiPhieu == 1 && _Duyet == 1)) && _ThongtinBN != null)
        {

            if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count > 0 || _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count > 0)
            {
                _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();

                txtTongCTT.Text = _ThongtinBN.KhamBenh.TongTienCTT.ToString("###,###");
                txtTongDTT.Text = (_ThongtinBN.KhamBenh.TongTienTTDTT + _ThongtinBN.KhamBenh.TongTienBHDTT).ToString("###,###");
                txtTongHD.Text = _ThongtinBN.KhamBenh.TongThuHoaDon.ToString("###,###");

            }
            else
            {
                txtTongCTT.Text = _ThongtinBN.KhamBenh.TongTienCTT.ToString("###,###");
                txtTongDTT.Text = (_ThongtinBN.KhamBenh.TongTienTTDTT + _ThongtinBN.KhamBenh.TongTienBHDTT).ToString("###,###");

                txtTongHD.Text = _ThongtinBN.KhamBenh.TongThuHoaDon.ToString("###,###");
            }
            if (_LoaiPhieu == 8 && HTC.ShareVariables.pub_spC == "PS")
            {
                Label24.Text = "Còn lại";
                Label24.Visible = true;
                txtConLai.Visible = true;
                txtTongDTT.Visible = false;

                if ((_ThongtinBN.KhamBenh.KyQuyBH == "" || _ThongtinBN.KhamBenh.KyQuyBH == "0") && _ThongtinBN.KhamBenh.TongThuHoaDon != 0)
                {
                    KhamBenh_DongTienList list = KhamBenh_DongTienList.GetAllKhamBenh_DongTienThu(_ThongtinBN.KhamBenh.MaSoKham);
                    decimal tong = 0;
                    foreach (KhamBenh_DongTien kb in list)
                    {
                        tong = tong + decimal.Parse(kb.SoTien == "" ? "0" : kb.SoTien);
                    }
                    txtkyquy.Text = tong.ToString("###,###");
                    txtConLai.Text = (tong - decimal.Parse(txtTongHD.Text == "" ? "0" : txtTongHD.Text)).ToString("###,###");

                }
                else if (_ThongtinBN.KhamBenh.TongThuHoaDon != 0)
                    txtConLai.Text = (decimal.Parse(_ThongtinBN.KhamBenh.KyQuyBH == "" ? "0" : _ThongtinBN.KhamBenh.KyQuyBH) - decimal.Parse(txtTongHD.Text == "" ? "0" : txtTongHD.Text)).ToString("###,###");
            }
            //  txtkyquy.Text = _ThongtinBN.KhamBenh.KyQuyBH;
            //  ShowMessage(_ThongtinBN.KhamBenh.TongThanhToan.ToString() + "/" + _ThongtinBN.KhamBenh.TongTienCTT.ToString() + "/" + _ThongtinBN.KhamBenh.TongTienBHCTT.ToString());
            if (txtKyhieu.Text == "")
            {
                if ((string.IsNullOrEmpty(pub_sKyHieuHD) && (HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")) || _LoaiPhieu == 7)
                {
                    //if (HTC.ShareVariables.pub_spC == "HU")
                    //    txtKyhieu.Text = DateTime.Now.ToString("MM/dd/yyyy").Substring(0, 2) + DateTime.Now.Year.ToString().Substring(2, 2) + "-" + Pub_sQuay + "-";
                    //else
                    if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                        txtKyhieu.Text = Pub_sQuay + "-" + Pub_sNguoiSD;
                    else if (HTC.ShareVariables.pub_spC == "PS")
                        txtKyhieu.Text = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + DateTime.Now.Month.ToString() + "/" + DateTime.Now.Day.ToString() + "/" + Pub_sNguoiSD;
                    else
                        txtKyhieu.Text = DateTime.Now.Year.ToString().Substring(2, 2) + "/" + Pub_sQuay + "/" + Pub_sNguoiSD;
                }
                else if (string.IsNullOrEmpty(pub_sKyHieuHD) && HTC.ShareVariables.pub_spC == "PS")
                    txtKyhieu.Text = "PS/" + DateTime.Now.Year.ToString("####").Substring(2, 2) + "P";
                else if (string.IsNullOrEmpty(pub_sKyHieuHD) && HTC.ShareVariables.pub_spC == "HH")
                    txtKyhieu.Text = "HH/" + DateTime.Now.Year.ToString("####").Substring(2, 2) + "P";
                pub_sKyHieuHD = txtKyhieu.Text;

            }
            if (txtsohd.Text == "")
                if (HTC.ShareVariables.pub_spC != "PS" || _LoaiPhieu == 7)
                    txtsohd.Text = pub_sSoHD;

        }
    }

    private void clearBN(Boolean _kinlai = true)
    {

        if (_ThongtinBN.MaBN != "")
            Pub_sMaBN = _ThongtinBN.MaBN;
        if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH") && _LoaiPhieu != 7 && _LoaiPhieu != 1 && _NoiTT == "085")
            _LoaiPhieu = 2;
        _KTBHYT = false;
        lblSothang.Text = "";
        grdCTT.DataSource = null;
        grdDTT.DataSource = null;
        grdXNTT.DataSource = null;
        grdDanhSachDY.DataSource = null;
        grdThuoc.DataSource = null;
        grdThuocDY.DataSource = null;
        _KhamBenh_GETsMABNListInfo = null;
        _ThongKe_BenhNhan_NgoaiTruListInfo = null;
        grdXNTT.Height = 300;
        grdLichSuKham.Visible = false;
        grdKhoa.Visible = false;
        ViewState[ViewState_ThongtinBN] = null;
        ViewState[ViewState_MaSoKham] = null;
        ViewState[ViewState_MaSoKhamT] = null;
        ViewState[ViewState_MaBN] = null;
        ViewState[ViewState_NgayDK] = null;
        ViewState[ViewState_SoTT] = null;
        ViewState[ViewState_STT] = null;
        ViewState[ViewState_STTT] = null;
        ViewState[ViewState_MaKhoa] = null;
        ViewState[ViewState_MaDT] = null;
        ViewState[ViewState_KhamBenh_DongTienList] = null;
        ViewState[ViewState_KhamBenh_ThuocSD_DY] = null;
        ViewState[ViewState_Order] = null;
        _ThongtinBN = ThongtinBN.NewThongtinBN();
        grdCTT.DataBind();
        grdDTT.DataBind();
        grdXNTT.DataBind();
        grdDanhSachDY.DataBind();
        grdThuoc.DataBind();
        grdThuocDY.DataBind();
        dtNgaySinh.Text = "";
        txthoten.Text = "";
        txtDTDD.Text = "";
        txtDTCQ.Text = "";
        txtNoiLamViec.Text = "";
        txtNoiLV.Text = "";
        txtSoThe.Text = "";
        txtMaKhoa.Text = "";
        txtGhiChuHD.Text = "";
        if (HTC.ShareVariables.pub_spC != "QN" && HTC.ShareVariables.pub_spC != "HU")
        {
            txtGhiChuHD.Visible = false;
            Label32.Visible = false;
        }
        dtgio.Text = "";
        _MaKhoa = null;
        chkTraiTuyen.Checked = false;
        dtBHYTTN.Text = "";
        dtBHYTDN.Text = "";
        txtBaoTin.Text = "";
        txtdienthoai.Text = "";
        txtDiaChi.Text = "";
        dtNgayQT.Text = "";
        cboChuyenKhoa.SelectedIndex = cboChuyenKhoa.DataSource != null ? 0 : -1;
        txtkyquy.Text = "";
        txtConLai.Text = "";
        txtTongHD.Text = "";
        txtTongCTT.Text = "";
        txtTongDon.Text = "";
        txtMG.Text = "";
        cboNguoiDuyet.SelectedValue = "";
        cboNguoiDuyet.Text = "";
        txtSLSac.Text = "";
        txtSLThang.Text = "";
        cbotinh.Text = HTC.ShareVariables.pub_sTenTinh;
        cbotinh.SelectedValue = HTC.ShareVariables.pub_sMaTinh;
        if (cbotinh.SelectedValue != "" && _LoaiPhieu != 7)
            cbohuyen.DataBind();
        else
        {
            cbohuyen.Text = "";
            cbohuyen.SelectedValue = "";
        }
        cbohuyen.Text = "";
        cbohuyen.SelectedValue = "";
        cboPXa.Text = "";
        cboPXa.SelectedValue = "";
        cboNgheNghiep.Text = "";
        cboNgheNghiep.SelectedValue = "";
        cboDanToc.Text = "";
        cboDanToc.SelectedValue = "";
        cboKhoaKB.Text = "";
        cboKhoaKB.SelectedValue = "";
        txtMaKhoa.Text = "";
        if (HTC.ShareVariables.pub_spC == "PS" && _LoaiPhieu == 1)
            txtmabn.Enabled = false;
        cboLoaiBN.SelectedValue = "0";

        cboNhanVien.SelectedValue = "";
        cboNhanVien.Text = "";
        txtMaNV.Text = "";
        cboDKBD.Text = "";
        cboDKBD.SelectedValue = "";
        txtDKBD.Text = "";

        cboDKGT.Text = "";
        cboDKGT.SelectedValue = "";
        txtDKGT.Text = "";

        cboCDnoiGT.Text = "";
        cboCDnoiGT.SelectedValue = "";
        txtBenhNGT.Text = "";
        cboChanDoan.Text = "";
        cboChanDoan.SelectedValue = "";
        txtChanDoan.Text = "";
        txtGhiChu.Text = "";
        cboBSDongY.Text = "";
        cboBSDongY.SelectedValue = "";
        txtBSDongY.Text = "";
        cboBSTayY.Text = "";
        cboBSTayY.SelectedValue = "";
        cboBSTayY.Text = "";
        optGT.Items[0].Selected = false;
        optGT.Items[1].Selected = false;
        txtSoThe.Enabled = true;
        txtmabn.Enabled = true;
        _LanTT = 0;
        _SoSoHD = "";
        _SoHD = "";
        if (((_LoaiPhieu == 1 || (_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 2) && _NoiTT == "085") || _LoaiPhieu == 7 || _LoaiPhieu == 3)
            cboDoiTuong.SelectedValue = "00001";
        else
            cboDoiTuong.SelectedValue = "00002";
        // cbotinh.DataBind();
        //cbohuyen.DataBind();
        //cboquocgia.DataBind();

        //cbohuyen.Items.Clear();
        //RadComboBoxItem selectedItemt = new RadComboBoxItem();

        //selectedItemt.Text = "";
        //selectedItemt.Value = "";
        //cbotinh.Items.Add(selectedItemt);
        //selectedItemt.Selected = true;
        //selectedItemt.DataBind();
        //cbotinh.DataBind();
        //cbotinh.Text = "";
        //cbotinh.DataBind();


        //cbohuyen.Items.Clear();
        //RadComboBoxItem selectedItemh = new RadComboBoxItem();

        //selectedItemh.Text = "";
        //selectedItemh.Value = "";
        //cbohuyen.Items.Add(selectedItemh);
        //selectedItemh.Selected = true;
        //selectedItemh.DataBind();
        //cbohuyen.DataBind();
        //cbohuyen.Text = "";
        //cbohuyen.DataBind();

        //cboNgheNghiep.Items.Clear();
        //RadComboBoxItem selectedItemnn = new RadComboBoxItem();

        //selectedItemnn.Text = "";
        //selectedItemnn.Value = "";
        //cboNgheNghiep.Items.Add(selectedItemnn);
        //selectedItemnn.Selected = true;
        //selectedItemnn.DataBind();
        //cboNgheNghiep.DataBind();
        //cboNgheNghiep.Text = "";
        //cbohuyen.DataBind();
        //cboDKBD.Items.Clear();
        //RadComboBoxItem selectedItemdk = new RadComboBoxItem();

        //selectedItemdk.Text = "";
        //selectedItemdk.Value = "";
        //cboDKBD.Items.Add(selectedItemdk);
        //selectedItemdk.Selected = true;
        //selectedItemdk.DataBind();
        //cboDKBD.DataBind();
        //cboDKBD.Text = "";
        //cboDKBD.DataBind();

        //txtDKBD.Text = "";

        //cboDKGT.Items.Clear();

        //RadComboBoxItem selectedItemgt = new RadComboBoxItem();

        //selectedItemgt.Text = "";
        //selectedItemgt.Value = "";
        //cboDKGT.Items.Add(selectedItemgt);
        //selectedItemgt.Selected = true;
        //selectedItemgt.DataBind();
        //cboDKGT.DataBind();
        //cboDKGT.Text = "";
        //cboDKGT.DataBind();
        //txtDKGT.Text = "";

        //cboCDnoiGT.Items.Clear();

        //RadComboBoxItem selectedItemcdgt = new RadComboBoxItem();
        //selectedItemcdgt.Text = "";
        //selectedItemcdgt.Value = "";
        //cboCDnoiGT.Items.Add(selectedItemgt);
        //selectedItemgt.Selected = true;
        //selectedItemgt.DataBind();
        //cboCDnoiGT.DataBind();
        //cboCDnoiGT.Text = "";
        //cboCDnoiGT.DataBind();

        //txtBenhNGT.Text = "";
        //cboChanDoan.Items.Clear();
        //RadComboBoxItem selectedItemcd = new RadComboBoxItem();
        //selectedItemcd.Text = "";
        //selectedItemcd.Value = "";
        //cboChanDoan.Items.Add(selectedItemgt);
        //selectedItemgt.Selected = true;
        //selectedItemgt.DataBind();
        //cboChanDoan.DataBind();
        //cboChanDoan.Text = "";
        //cboChanDoan.DataBind();

        //txtChanDoan.Text = "";

        //cboNhanVien.Items.Clear();
        //RadComboBoxItem selectedItembs = new RadComboBoxItem();
        //selectedItembs.Text = "";
        //selectedItembs.Value = "";
        //cboNhanVien.Items.Add(selectedItembs);
        //selectedItembs.Selected = true;
        //selectedItembs.DataBind();
        //cboNhanVien.DataBind();
        //cboNhanVien.Text = "";
        //cboNhanVien.DataBind();

        //cboKhoaKB.Items.Clear();
        //RadComboBoxItem selectedItemk = new RadComboBoxItem();
        //selectedItemk.Text = "";
        //selectedItemk.Value = "";
        //cboKhoaKB.Items.Add(selectedItemk);
        //selectedItemk.Selected = true;
        //selectedItemk.DataBind();
        //cboKhoaKB.DataBind();
        //cboKhoaKB.Text = "";
        //cboKhoaKB.DataBind();

        //cboBSDongY.Items.Clear();
        //RadComboBoxItem selectedItembsdy = new RadComboBoxItem();
        //selectedItembsdy.Text = "";
        //selectedItembsdy.Value = "";
        //cboBSDongY.Items.Add(selectedItembsdy);
        //selectedItembsdy.Selected = true;
        //selectedItembsdy.DataBind();
        //cboBSDongY.DataBind();
        //cboBSDongY.Text = "";
        //cboBSDongY.DataBind();

        //cboBSTayY.Items.Clear();
        //RadComboBoxItem selectedItembsty = new RadComboBoxItem();
        //selectedItembsty.Text = "";
        //selectedItembsty.Value = "";
        //cboBSTayY.Items.Add(selectedItembsty);
        //selectedItembsty.Selected = true;
        //selectedItembsty.DataBind();
        //cboBSTayY.DataBind();
        //cboBSTayY.Text = "";
        //cboBSTayY.DataBind();
        if (((_NoiTT == "090" || (_NoiTT == "087" && _LoaiPhieu == 7)) || _NoiTT == "094" || _NoiTT == "093" || (_NoiTT == "085" && _LoaiPhieu == 7 && HTC.ShareVariables.pub_spC == "QN")))
        {

            _KhamBenh_ThuocSD_DY = KhamBenh_ThuocSD_DY.NewKhamBenh_ThuocSD_DY();
            grdThuocDY.DataSource = _KhamBenh_ThuocSD_DY.KhamBenh_ThuocSD_DY_Cs;
            // grdThuocDY.DataBind(); 
        }
        enableTNBN(true);
        SetData();

        LoadData();
        tinhlaihd();

        RadTabStrip1.DataBind();
        if (_LoaiPhieu == 1)
            cboLoaiBN.Focus();
        else if (_LoaiPhieu == 2 && HTC.ShareVariables.pub_spC == "YH")
            txtQRCode.Focus();
        else if (_LoaiPhieu == 1 && HTC.ShareVariables.pub_spC == "YH" && ttqrcode.Visible == true)
            txtQRCode.Focus();
        else if (_LoaiPhieu == 2 && ttqrcode.Visible == true)
            txtQRCode.Focus();
        else
            txtmabn.Focus();
    }
    private void clearDetail()
    {
        if (HTC.ShareVariables.pub_spC == "PS")
        {
            txtChanDoan.Text = "";
            cboChanDoan.SelectedValue = "";
            cboChanDoan.Text = "";
            txtMaNV.Text = "";
            cboNhanVien.Text = "";
            cboNhanVien.SelectedValue = "";
            txtMaKhoa.Focus();

        }

    }

    private void PrintVPThanhToanBH(Boolean _load = true, string dk = "")
    {
        try
        {

            String sPath;
            ReportDocument rpt = new ReportDocument();
            FormulaFieldDefinitions Myformulas;
            String ngay = DateTime.Now.Day <= 9 ? "0" + DateTime.Now.Day.ToString() : DateTime.Now.Day.ToString();
            String thang = DateTime.Now.Month <= 9 ? "0" + DateTime.Now.Month.ToString() : DateTime.Now.Month.ToString();
            DataSet ReportData3 = new DataSet();
            DataSet ReportData4 = new DataSet();
            Boolean _print = ((_LoaiPhieu == 2 || (cboDoiTuong.SelectedValue.Substring(0, 1) == "2" && (_LoaiPhieu == 9 || _LoaiPhieu == 8) && HTC.ShareVariables.pub_spC == "YH") || (_LoaiPhieu == 1 && _Duyet == 1)) && dtNgayQT.Text != "");
            if (_print == true)
            {

                if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                    sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRInphoithanhtoan_BHNTMA4.rpt";
                else if (HTC.ShareVariables.pub_spC == "PS")
                    sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRInphoithanhtoan_BHNTMA4.rpt";
                else
                    sPath = Request.ApplicationPath + "/UI/PhongKham/Reports/CRInphoithanhtoan_BHNTMA4New.rpt";

                rpt.Load(Server.MapPath(sPath));
                Myformulas = rpt.DataDefinition.FormulaFields;
                Myformulas["dungtuyen"].Text = "'" + (cboDoiTuong.SelectedValue.Substring(4, 1) == "8" ? "" : "X") + "'";
                Myformulas["traituyen"].Text = "'" + (cboDoiTuong.SelectedValue.Substring(4, 1) != "8" ? "" : "X") + "'";
                Myformulas["MaBVThe"].Text = "'" + _ThongtinBN.KhamBenh.mabhxh + "'";
                Myformulas["benhvienden"].Text = "'" + _ThongtinBN.KhamBenh.MABHXHGT + "-" + _ThongtinBN.KhamBenh.TenBVGT.Replace("'", "''") + "'";
                if (HTC.ShareVariables.pub_spC == "PS")
                    Myformulas["TAMTHU"].Text = _ThongtinBN.KhamBenh.KyQuyBH.Replace(",", "");
                //Myformulas["daidien"].Text = "'" + nguoidaidien + "'";
                if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                {
                    foreach (KhamBenh_C kb in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                    {
                        if (kb.malh == "00003" || kb.malh == "00030")
                        {
                            Myformulas["maChuanDoan"].Text = "'" + kb.maicd + "'";
                            break;
                        }
                    }
                }
                //if (HTC.ShareVariables.pub_spC == "YH")
                //    Myformulas["Tuoi"].Text = "'" + _ThongtinBN.NgaySinh.Substring(6, 4) + "'";

                //else
                //    Myformulas["Tuoi"].Text = "'" + _ThongtinBN.NgaySinh + "'";
                
              // ----------------------
                    Myformulas["Tuoi"].Text = "'" + _ThongtinBN.NgaySinh + "'";

                    if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                    {
                        Myformulas["ChanDoan"].Text = "'" + _ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbenh + "'";
                        Myformulas["ChanDoanKem"].Text = "'" + _ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbenhKem + "'";

                        Myformulas["khoa"].Text = "'" + (_ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenkhoa).ToUpper() + "'";
                        Myformulas["MaChanDoanKem"].Text = "'" + _ThongtinBN.KhamBenh.KhamBenh_C_List[0].maicdKem + (_ThongtinBN.KhamBenh.KhamBenh_C_List[0].maicdKem2 != "" ? "-" + _ThongtinBN.KhamBenh.KhamBenh_C_List[0].maicdKem2 : "") + (_ThongtinBN.KhamBenh.KhamBenh_C_List[0].maicdKem3 != "" ? "-" + _ThongtinBN.KhamBenh.KhamBenh_C_List[0].maicdKem3 : "") + "'";
                        //if (_ThongtinBN.KhamBenh.MaKV != "")
                        //{
                        //    Myformulas["MaKV"].Text = "'" + _ThongtinBN.KhamBenh.MaKV + "'";

                        //    Myformulas["dunamnam"].Text = "'" + _ThongtinBN.KhamBenh.ngayDu5Nam + "'";
                        //}
                        //else
                        //{
                        //    try
                        //    {
                        //        HisBHYT bhyt = new HisBHYT();
                        //        HisBHYT.KQNhanLichSuKCB2018 ls = bhyt.CheckOutSoThe2018(txtSoThe.Text.ToUpper(), txthoten.Text.ToUpper(), dtNgaySinh.Text, (optGT.Items[0].Selected == true ? "1" : "2"), dtBHYTTN.Text, dtBHYTDN.Text, txtDKBD.Text);
                        //        if (ls != null)
                        //        {
                        //            Myformulas["MaKV"].Text = "'" + ls.maKV + "'";

                        //            Myformulas["dunamnam"].Text = "'" + ls.ngayDu5Nam + "'";
                        //            // Myformulas["makhoa"].Text = "'" + DMKhoa.GetDMKhoa ( _ThongtinBN.KhamBenh.KhamBenh_C_List[0].Makhoa).MaBYTe  + "'";
                        //        }
                        //    }
                        //    catch
                        //    {
                        //    }
                        //}
                      

                    }


                //-------------------------

                if (!string.IsNullOrEmpty(_ThongtinBN.KhamBenh.NgayQT) && !string.IsNullOrEmpty(_ThongtinBN.KhamBenh.NgayDK))
                {
                    Myformulas["ngaydt"].Text = (DateTime.Parse(_ThongtinBN.KhamBenh.NgayQT) - DateTime.Parse(_ThongtinBN.KhamBenh.NgayDK)).Days.ToString();
                }
                if (HTC.ShareVariables.pub_spC == "YH")
                {
                    Myformulas["ravien"].Text = "'" + _ThongtinBN.KhamBenh.NgayQT + "'";

                    Myformulas["vaovien"].Text = "'" + _ThongtinBN.KhamBenh.NgayLap + "'";
                }
                else
                {
                    if (!string.IsNullOrEmpty(_ThongtinBN.KhamBenh.NgayDK))
                        Myformulas["vaovien"].Text = "'" + DateTime.Parse(_ThongtinBN.KhamBenh.NgayDK).Day.ToString() + "/ " + DateTime.Parse(_ThongtinBN.KhamBenh.NgayDK).Month.ToString() + "/ " + DateTime.Parse(_ThongtinBN.KhamBenh.NgayDK).Year.ToString() + "'";
                    if (!string.IsNullOrEmpty(_ThongtinBN.KhamBenh.NgayQT))
                        Myformulas["ravien"].Text = "'" + DateTime.Parse(_ThongtinBN.KhamBenh.NgayQT).Day.ToString() + "/ " + DateTime.Parse(_ThongtinBN.KhamBenh.NgayQT).Month.ToString() + "/ " + DateTime.Parse(_ThongtinBN.KhamBenh.NgayQT).Year.ToString() + "'";
                }
                Myformulas["TenDVCQ"].Text = "'" + (HTC.ShareVariables.pub_sTenDVChuQuan) + "'";
                Myformulas["TenBV"].Text = "'" + (HTC.ShareVariables.pub_sTenBV) + "'";
                Myformulas["SophieuTTRV"].Text = "'" + _ThongtinBN.KhamBenh.sophieuttrv + "'";
                Myformulas["sobenhan"].Text = "'" + _ThongtinBN.MaBN + "'";
                Myformulas["hoten"].Text = "'" + (txthoten.Text).ToUpper() + "'";
                Myformulas["bh"].Text = "'" + txtSoThe.Text + "'";
                Myformulas["capcuu"].Text = "'" + (_ThongtinBN.KhamBenh.LoaiKham == 2 ? "X" : "") + "'";
                Myformulas["dungtuyen"].Text = "'" + (_ThongtinBN.KhamBenh.MaDT.Substring(4, 1) != "8" ? "X" : "") + "'";
                Myformulas["NguongCPBNtra"].Text = "'" + _ThongtinBN.KhamBenh.sotienbhtra + "'";
                Myformulas["PhantramBHTra"].Text = "'" + _ThongtinBN.KhamBenh.bhtra + "'";
                Myformulas["NoiDKBD"].Text = "'" + cboDKBD.Text + "'";
                Myformulas["nvketoan"].Text = "'" + (Pub_sTenNguoiSD).ToUpper() + "'";
                Myformulas["NgayQT"].Text = "'" + dtNgayQT.Text + "'";
                Myformulas["Tennv"].Text = "'" + (Pub_sTenNguoiSD).ToUpper() + "'";
                Myformulas["daidien"].Text = "'" + HTC.ShareVariables.pub_sDaiDien + "'";
                Myformulas["Denngay"].Text = "'" + dtBHYTTN.Text + " đến " + dtBHYTDN.Text + "'";
                // Myformulas["DiaChi"].Text = "'" + txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "") + "'";
                Myformulas["DiaChi"].Text = "'" + (txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "")).Replace("'", "''") + "'"; ;
                if (HTC.ShareVariables.pub_spC == "YH")
                {
                    if (_ThongtinBN.KhamBenh.NgayLap != "")
                        Myformulas["NGAYDK"].Text = "'" + _ThongtinBN.KhamBenh.NgayLap + "'";
                    else
                        Myformulas["NGAYDK"].Text = "'" + DateTime.Now.ToString("dd/MM/yyyy HH:mm") + "'";
                }
                else
                    Myformulas["NGAYDK"].Text = "'" + dtNgayDK.Text + "'";
                
                Myformulas["GT"].Text = "'" + (optGT.Items[0].Selected == true ? "Nam" : "Nữ") + "'";
                Myformulas["Ngayin"].Text = "'Ngày " + DateTime.Now.Day.ToString() + "  tháng  " + DateTime.Now.Month.ToString() + "  năm  " + DateTime.Now.Year.ToString() + "'";
                if (HTC.ShareVariables.pub_spC != "PS")
                    Myformulas["NVKetoan"].Text = "'" + Pub_sTenNguoiSD + "'";

                if (!string.IsNullOrEmpty(dk))
                {
                    if (ReportData3 == null)
                    {
                        if (cboDoiTuong.SelectedValue.Substring(0, 1) == "1" || cboDoiTuong.SelectedValue.Substring(0, 1) == "2")
                            ReportData3 = HTC.Business.DataProvider.Instance().RptGetInphoihoadonthanhtoan_BHNT(false, _ThongtinBN.KhamBenh.MaSoKham, 1, 2, "");
                        else if (_KhamBenh_DongTienList != null && HTC.ShareVariables.pub_spC == "PS")
                            if (_KhamBenh_DongTienList.Count > 0 && cboDoiTuong.SelectedValue.Substring(0, 1) == "0")
                            {
                                ReportData3 = HTC.Business.DataProvider.Instance().RptGetInphoihoadonthanhtoan_BHNT(false, _ThongtinBN.KhamBenh.MaSoKham, 9, 2, "");
                            }
                    }

                }
                else
                {
                    if (cboDoiTuong.SelectedValue.Substring(0, 1) == "1" || cboDoiTuong.SelectedValue.Substring(0, 1) == "2")
                        ReportData3 = HTC.Business.DataProvider.Instance().RptGetInphoihoadonthanhtoan_BHNT(false, _ThongtinBN.KhamBenh.MaSoKham, 1, 2, "");
                    else if (_KhamBenh_DongTienList != null && HTC.ShareVariables.pub_spC == "PS")
                        if (_KhamBenh_DongTienList.Count > 0 && cboDoiTuong.SelectedValue.Substring(0, 1) == "0")
                        {
                            ReportData3 = HTC.Business.DataProvider.Instance().RptGetInphoihoadonthanhtoan_BHNT(false, _ThongtinBN.KhamBenh.MaSoKham, 1, 9, "");
                        }


                }
                rpt.SetDataSource(ReportData3);
                //if (HTC.ShareVariables.pub_spC == "YH")
                //    PrintExportDirect(rpt);
                //else
                PrintExport(rpt);
                rpt.Dispose(); rpt = null;//  PrintExport(rpt); rpt.Dispose(); rpt = null;//HTCReportViewer3.LoadReport(rpt, true, false);

            }
            ReportData3 = null;
            ReportData4 = null;

        }
        catch (Exception ex)
        {
            ShowMessage("Không in được báo cáo" + ex.Message);

            //throw;
        }
    }

    protected void cboNhapHoTroDY_SelectedIndexChanged(object sender, RadComboBoxSelectedIndexChangedEventArgs e)
    {
        if (_ThongtinBN.MaBN != "")
        {
            if (cboNhapHoTroDY.SelectedValue.IndexOf("/") != 0)
            {
                _MaSoKhamT = cboNhapHoTroDY.SelectedValue.Substring(0, cboNhapHoTroDY.SelectedValue.IndexOf("/"));
                _STTT = int.Parse(cboNhapHoTroDY.SelectedValue.Substring(cboNhapHoTroDY.SelectedValue.IndexOf("/") + 1));
                LoadDetails_KhamBenh_ThuocThang(false, false, _MaSoKhamT, byte.Parse(_STTT.ToString()));
            }
        }
    }
    //protected void grdwidChiTiet_NeedDataSource(object sender, GridNeedDataSourceEventArgs e)
    //{

    //    grdwidChiTiet.DataSource = KhamBenh_ThuocSD_DY.GetKhamBenh_ThuocSD_DY(_MaSoKhamT, _STTT).KhamBenh_ThuocSD_DY_Cs;


    //}
    protected void txtSLSac_TextChanged(object sender, EventArgs e)
    {

        if (_IsBVYHocCoTruyen == true)
            if (txtSLSac.Text != "" && txtSLSac.Text != "0")
            {
                DMDichVu_Gia_DTList _DMDichVu_Gia_DTList = DMDichVu_Gia_DTList.FindDMDichVu_Gia_DTByMa("ST001", "00001");
                if (_DMDichVu_Gia_DTList.Count > 0)
                {
                    DMDichVu_Gia_DT _DMDichVu_Gia_DT = _DMDichVu_Gia_DTList[0];
                    KhamBenh_C _kbc = _ThongtinBN.KhamBenh.KhamBenh_C_List.FirstOrDefault(X => X.MaDV == _DMDichVu_Gia_DT.MaDV);
                    if (_kbc == null)
                    {
                        _kbc = Supports_KhamBenh_C("ST001", _DMDichVu_Gia_DT, null);
                        _kbc.slmua = txtSLSac.Text;
                        _kbc.SoLuong = txtSLSac.Text;
                        _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.NewTo(_kbc);
                        _ThongtinBN.KhamBenh.KhamBenh_C_List.AssignTo(_kbc, _ThongtinBN.KhamBenh);

                    }
                    else if (_kbc.DaTTTT != 0)
                    {
                        _kbc = Supports_KhamBenh_C("ST001", _DMDichVu_Gia_DT, null);
                        _kbc.slmua = txtSLSac.Text;
                        _kbc.SoLuong = txtSLSac.Text;
                        _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.NewTo(_kbc);
                        _ThongtinBN.KhamBenh.KhamBenh_C_List.AssignTo(_kbc, _ThongtinBN.KhamBenh);

                    }

                    else
                    {
                        _kbc.slmua = txtSLSac.Text;
                        _kbc.SoLuong = txtSLSac.Text;
                        _ThongtinBN.KhamBenh.KhamBenh_C_List.UpdatedTo(_kbc, _ThongtinBN.KhamBenh);
                        KhamBenh_GetsDichVu _KhamBenh_GetsDichVu = _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.FirstOrDefault(X => X.SoTT == _kbc.STT);
                        _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.UpdatedTo(_kbc, _KhamBenh_GetsDichVu);

                    }
                    _kbc.NguoiLap = Pub_sNguoiSD;
                    _kbc.MaMay = Pub_sNguoiSD;
                    _kbc.NguoiSD = Pub_sNguoiSD;

                    tinhlaihd();
                }
            }
    }



    protected void cmdThongTin_Click(object sender, EventArgs e)
    {
        try
        {
            if (_LoaiPhieu == 1 || _LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8))
            {
                if (HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")
                {
                    if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count == 0 && _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count == 0 && _ThongKe_BenhNhan_NgoaiTruListInfo == null)
                    {

                        if (_PubMaDT == "TT")
                        {
                            string _DK = _NoiTT + " EXISTS(SELECT B.MAKHOals FROM ACCOUNT B WHERE DBO.FGIAIMA(ACCOUNT)  ='" + Pub_sAccount;
                            _DK = _DK + "' AND (CHARINDEX( '''' + A.MAKHOa + '''' ,B.MAKHOals,1) <> 0 OR  ALLMAKHOacls = 1  or ALLMAKHOals = 1 )) ";

                            _ThongKe_BenhNhan_NgoaiTruListInfo = ThongKe_BenhNhan_NgoaiTruListInfo.GetThongKe_BenhNhan_NgoaiTru_Info(DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), "All", 7, _DK);

                        }
                        else if (_PubMaDT == "BH")
                        {
                            string _DK = _NoiTT + " EXISTS(SELECT B.MAKHOals FROM ACCOUNT B WHERE DBO.FGIAIMA(ACCOUNT)  ='" + Pub_sAccount;
                            _DK = _DK + "' AND (CHARINDEX( '''' + A.MAKHOa + '''' ,B.MAKHOals,1) <> 0 OR  ALLMAKHOacls = 1  or ALLMAKHOals = 1 )) ";

                            _ThongKe_BenhNhan_NgoaiTruListInfo = ThongKe_BenhNhan_NgoaiTruListInfo.GetThongKe_BenhNhan_NgoaiTru_Info(DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), "All", 8, _DK);

                        }
                        else
                        {
                            string _DK = _NoiTT + " EXISTS(SELECT B.MAKHOals FROM ACCOUNT B WHERE DBO.FGIAIMA(ACCOUNT)  ='" + Pub_sAccount;
                            _DK = _DK + "' AND (CHARINDEX( '''' + A.MAKHOa + '''' ,B.MAKHOals,1) <> 0 OR  ALLMAKHOacls = 1  or ALLMAKHOals = 1 )) ";

                            _ThongKe_BenhNhan_NgoaiTruListInfo = ThongKe_BenhNhan_NgoaiTruListInfo.GetThongKe_BenhNhan_NgoaiTru_Info(DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), "All", 9, _DK);

                        }
                        if (_ThongtinBN.MaBN != "")
                        {
                            _KhamBenh_GETsMABNListInfo = KhamBenh_GETsMABNListInfo.GetAllKhamBenh_GETsMABNInfo(_ThongtinBN.MaBN, 1, "");
                            grdLichSuKham.DataSource = _KhamBenh_GETsMABNListInfo;
                            grdLichSuKham.DataBind();
                            grdLichSuKham.Visible = true;
                        }

                        grdKhoa.DataSource = _ThongKe_BenhNhan_NgoaiTruListInfo;
                        grdKhoa.DataBind();
                        grdKhoa.Visible = true;
                        grdXNTT.Height = 100;
                    }
                }
            }
            if (cboPXa.Visible == true)
                cboPXa.Focus();
            else
                cboNgheNghiep.Focus();
        }
        catch (Exception ex)
        {

        }
    }
    protected void cbotinh_SelectedIndexChanged(object sender, RadComboBoxSelectedIndexChangedEventArgs e)
    {
        try
        {
            cbohuyen.DataBind();
            cbohuyen.Focus();
            if (_LoaiPhieu == 1 || _LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8))
            {
                if (cbohuyen.AutoPostBack == false)
                {
                    if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count == 0 && _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count == 0 && _ThongKe_BenhNhan_NgoaiTruListInfo == null)
                    {

                        if (_PubMaDT == "TT")
                        {
                            string _DK = _NoiTT + " EXISTS(SELECT B.MAKHOals FROM ACCOUNT B WHERE DBO.FGIAIMA(ACCOUNT)  ='" + Pub_sAccount;
                            _DK = _DK + "' AND (CHARINDEX( '''' + A.MAKHOa + '''' ,B.MAKHOals,1) <> 0 OR  ALLMAKHOacls = 1  or ALLMAKHOals = 1 )) ";
                            DateTime m = DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);
                            _ThongKe_BenhNhan_NgoaiTruListInfo = ThongKe_BenhNhan_NgoaiTruListInfo.GetThongKe_BenhNhan_NgoaiTru_Info(m, m, "All", 7, _DK);

                        }
                        else if (_PubMaDT == "BH")
                        {
                            string _DK = _NoiTT + " EXISTS(SELECT B.MAKHOals FROM ACCOUNT B WHERE DBO.FGIAIMA(ACCOUNT)  ='" + Pub_sAccount;
                            _DK = _DK + "' AND (CHARINDEX( '''' + A.MAKHOa + '''' ,B.MAKHOals,1) <> 0 OR  ALLMAKHOacls = 1  or ALLMAKHOals = 1 )) ";
                            DateTime m = DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);
                            _ThongKe_BenhNhan_NgoaiTruListInfo = ThongKe_BenhNhan_NgoaiTruListInfo.GetThongKe_BenhNhan_NgoaiTru_Info(m, m, "All", 8, _DK);

                        }
                        else
                        {
                            string _DK = _NoiTT + " EXISTS(SELECT B.MAKHOals FROM ACCOUNT B WHERE DBO.FGIAIMA(ACCOUNT)  ='" + Pub_sAccount;
                            _DK = _DK + "' AND (CHARINDEX( '''' + A.MAKHOa + '''' ,B.MAKHOals,1) <> 0 OR  ALLMAKHOacls = 1  or ALLMAKHOals = 1 )) ";
                            DateTime m = DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);
                            _ThongKe_BenhNhan_NgoaiTruListInfo = ThongKe_BenhNhan_NgoaiTruListInfo.GetThongKe_BenhNhan_NgoaiTru_Info(m, m, "All", 9, _DK);

                        }
                        if (_ThongtinBN.MaBN != "")
                        {
                            _KhamBenh_GETsMABNListInfo = KhamBenh_GETsMABNListInfo.GetAllKhamBenh_GETsMABNInfo(_ThongtinBN.MaBN, 1, "");
                            grdLichSuKham.DataSource = _KhamBenh_GETsMABNListInfo;
                            grdLichSuKham.DataBind();
                            grdLichSuKham.Visible = true;
                        }

                        grdKhoa.DataSource = _ThongKe_BenhNhan_NgoaiTruListInfo;
                        grdKhoa.DataBind();
                        grdKhoa.Visible = true;
                        grdXNTT.Height = 100;
                    }
                }
            }
        }
        catch (Exception ex)
        {

        }
    }
    protected void odsThuocTY_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {
        SetObject();

        e.InputParameters["maKho"] = _NoiTT == "091" ? HTC.ShareVariables.pub_sMaKX091 : HTC.ShareVariables.pub_sMaKX092;

        e.InputParameters["thang"] = DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);
        e.InputParameters["dk"] = " and isnull(m.tonck,0)>0";


    }
    private void BefoChuyenDT()
    {

        SetObject();
        //if (CurrentTabIndex == 2)
        //{
        //    Control control = FindControlIterative(this, "cboDichVu");
        //    if (control != null)
        //    {
        //        //odsDichVu.Select();
        //        //odsDichVu.DataBind();
        //        if (control is RadComboBox)
        //        {
        //            ((RadComboBox)control).AppendDataBoundItems = false; ((RadComboBox)control).DataBind(); ((RadComboBox)control).AppendDataBoundItems = true;
        //        }
        //    };
        //}
        //else if (CurrentTabIndex == 3 || CurrentTabIndex == 4)
        //{
        //    Control control = FindControlIterative(this, "cboThuoc");
        //    if (control != null)
        //    {
        //        if (control is RadComboBox)
        //        {
        //            ((RadComboBox)control).AppendDataBoundItems = false; ((RadComboBox)control).DataBind(); ((RadComboBox)control).AppendDataBoundItems = true;
        //        }
        //    };
        //}
    }
    protected void cboDoiTuong_SelectedIndexChanged(object sender, EventArgs e)
    {
        DMDoiTuong _DMDoiTuong = DMDoiTuong.GetDMDoiTuong(cboDoiTuong.SelectedValue);
        if (cboDoiTuong.SelectedValue.Substring(0, 1) == "2")
            txtSoThe.Mask = "aaaaaaaaaaaaaaaa";
        else
            txtSoThe.Mask = "ll.#.##.aa.###.#####";
        if (cboDoiTuong.SelectedValue.Substring(0, 1) == "0" && _LoaiPhieu == 2)
        {
            ShowMessage("Chưa chọn đối tượng khám bệnh");
            return;
        }
        else if (cboDoiTuong.SelectedValue.Substring(0, 1) == "0" && _PubMaDT == "BH")
        {
            ShowMessage("Chưa chọn đối tượng khám bệnh");
            return;
        }
        if ((HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN") && cboDoiTuong.SelectedValue.Substring(0, 1) == "0" && _ThongtinBN.KhamBenh.MaDT.Substring(0, 1) == "1")
        {
            if ((_LoaiPhieu == 9 || _LoaiPhieu == 8) || _LoaiPhieu == 2 || _LoaiPhieu == 1)
                if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
                {
                    foreach (KhamBenh_C a in _ThongtinBN.KhamBenh.KhamBenh_C_List)
                    {
                        if (a.DaTT != 0 && a.MaDT.Substring(0, 1) == "1" && (a.SLTra == "0" || a.SLTra == ""))
                        {
                            ShowMessage("Đã thanh toán bệnh nhân!Yêu cầu hủy thanh toán");
                            return;
                        }
                    }
                }
        }
        if (_DMDoiTuong != null)
        {
            cboDoiTuong.SelectedValue = _DMDoiTuong.MaDT;
            _ThongtinBN.MaDT = _DMDoiTuong.MaDT;
            _ThongtinBN.KhamBenh.bhtra = _DMDoiTuong.bhtra;
            _ThongtinBN.KhamBenh.MaDT = _DMDoiTuong.MaDT;
            _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuong.Sotien;
        }
        _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();
        txtTongHD.Text = (_ThongtinBN.KhamBenh.TongThuHoaDon * (100 - decimal.Parse(txtMG.Text == "" ? "0" : txtMG.Text)) / 100).ToString("###,###");
        if (_LoaiPhieu == 8 && HTC.ShareVariables.pub_spC == "PS")
        {
            Label24.Text = "Còn lại";
            txtConLai.Visible = true;
            txtTongDTT.Visible = false;
            txtConLai.Text = (decimal.Parse(_ThongtinBN.KhamBenh.KyQuyBH == "" ? "0" : _ThongtinBN.KhamBenh.KyQuyBH) - decimal.Parse(txtTongHD.Text == "" ? "0" : txtTongHD.Text)).ToString("###,###");
        }
        _ThongtinBN.KhamBenh.MienGiamTT = _ThongtinBN.KhamBenh.TongThuHoaDon * (decimal.Parse(txtMG.Text == "" ? "0" : txtMG.Text)) / 100;
        _ThongtinBN.KhamBenh.MienGiam = _ThongtinBN.KhamBenh.MienGiamTT;


    }
    protected void txtMG_TextChanged(object sender, EventArgs e)
    {
        if (txtTongHD.Text != "" && txtMG.Text != "")
        {
            txtGhiChuHD.Visible = true;
            Label32.Visible = true;
            if ((_LoaiPhieu == 9 || _LoaiPhieu == 8))
            {
                _ThongtinBN.KhamBenh.MienGiamTT = 0;
                _ThongtinBN.KhamBenh.MienGiam = 0;
                _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();
                txtTongHD.Text = (_ThongtinBN.KhamBenh.TongThuHoaDon * (100 - decimal.Parse(txtMG.Text == "" ? "0" : txtMG.Text)) / 100).ToString("###,###");
                if (_LoaiPhieu == 8 && HTC.ShareVariables.pub_spC == "PS")
                {
                    Label24.Text = "Còn lại";
                    Label24.Visible = true;
                    txtConLai.Visible = true;
                    txtTongDTT.Visible = false;
                    if ((_ThongtinBN.KhamBenh.KyQuyBH == "" || _ThongtinBN.KhamBenh.KyQuyBH == "0"))
                    {
                        KhamBenh_DongTienList list = KhamBenh_DongTienList.GetAllKhamBenh_DongTienThu(_ThongtinBN.KhamBenh.MaSoKham);
                        decimal tong = 0;
                        foreach (KhamBenh_DongTien kb in list)
                        {
                            tong = tong + decimal.Parse(kb.SoTien == "" ? "0" : kb.SoTien);
                        }
                        txtkyquy.Text = tong.ToString("###,###");
                        txtConLai.Text = (tong - decimal.Parse(txtTongHD.Text == "" ? "0" : txtTongHD.Text)).ToString("###,###");

                    }
                    else if (_ThongtinBN.KhamBenh.TongThuHoaDon != 0)
                        txtConLai.Text = (decimal.Parse(_ThongtinBN.KhamBenh.KyQuyBH == "" ? "0" : _ThongtinBN.KhamBenh.KyQuyBH) - decimal.Parse(txtTongHD.Text == "" ? "0" : txtTongHD.Text)).ToString("###,###");

                }
                _ThongtinBN.KhamBenh.MienGiamTT = _ThongtinBN.KhamBenh.TongThuHoaDon * (decimal.Parse(txtMG.Text == "" ? "0" : txtMG.Text)) / 100;
                _ThongtinBN.KhamBenh.MienGiam = _ThongtinBN.KhamBenh.MienGiamTT;
                _ThongtinBN.KhamBenh.Nguoiduyet = cboNguoiDuyet.SelectedValue;
            }
            else if (_LoaiPhieu == 7)
            {
                _ThongtinBN.KhamBenh.MienGiamTT = 0;
                _ThongtinBN.KhamBenh.MienGiam = 0;
                _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();
                txtTongHD.Text = (_ThongtinBN.KhamBenh.TongThuHoaDon * (100 - decimal.Parse(txtMG.Text == "" ? "0" : txtMG.Text)) / 100).ToString("###,###");

                _ThongtinBN.KhamBenh.MienGiamTT = _ThongtinBN.KhamBenh.TongThuHoaDon * (decimal.Parse(txtMG.Text == "" ? "0" : txtMG.Text)) / 100;
                _ThongtinBN.KhamBenh.MienGiam = _ThongtinBN.KhamBenh.MienGiamTT;
                _ThongtinBN.KhamBenh.Nguoiduyet = cboNguoiDuyet.SelectedValue;
            }
            else if (_LoaiPhieu == 2)
            {
                _ThongtinBN.KhamBenh.MienGiamBH = 0;
                _ThongtinBN.KhamBenh.MienGiam = 0;
                _ThongtinBN.KhamBenh.TinhLaiTienKhamBenh();
                txtTongHD.Text = (_ThongtinBN.KhamBenh.TongThuHoaDon * (100 - decimal.Parse(txtMG.Text == "" ? "0" : txtMG.Text)) / 100).ToString("###,###");
                _ThongtinBN.KhamBenh.MienGiamBH = _ThongtinBN.KhamBenh.TongThuHoaDon * (decimal.Parse(txtMG.Text == "" ? "0" : txtMG.Text)) / 100;
                _ThongtinBN.KhamBenh.MienGiam = _ThongtinBN.KhamBenh.MienGiamBH;
                _ThongtinBN.KhamBenh.Nguoiduyet = cboNguoiDuyet.SelectedValue;
            }
            //foreach (KhamBenh_C kbc in _ThongtinBN.KhamBenh.KhamBenh_C_List)
            //{
            //    kbc.CK = txtMG.Text;
            //}
            //foreach (KhamBenh_ThuocSD kbc in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
            //{
            //    kbc.CK = txtMG.Text;
            //}
            //foreach (KhamBenh_ThuocSD_DY kbc in _ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList)
            //{
            //    kbc.CK = decimal .Parse ( txtMG.Text);
            //}
            //foreach (KhamBenh_VTTH kbc in _ThongtinBN.KhamBenh.KhamBenh_VTTHList)
            //{
            //    kbc.CK = txtMG.Text;
            //}
            //foreach (KhamBenh_HoaChat kbc in _ThongtinBN.KhamBenh.KhamBenh_HoaChatList)
            //{
            //    kbc.CK = txtMG.Text;
            //}
            //foreach (KhamBenh_Mau kbc in _ThongtinBN.KhamBenh.KhamBenh_MauList)
            //{
            //    kbc.CK = txtMG.Text;
            //}
        }
    }

    protected void txtMaKhoa_TextChanged(object sender, EventArgs e)
    {
        try
        {


            txtMaKhoa.Text = txtMaKhoa.Text.Trim();
            if (txtMaKhoa.Text != "")
            {
                //cboKhoaKB.ClearSelection();
                //cboKhoaKB.DataBind();
                //RadComboBoxItem selectedItem = new RadComboBoxItem();
                if (txtMaKhoa.Text.Length == 1 || txtMaKhoa.Text.Length == 4)
                    txtMaKhoa.Text = "00" + txtMaKhoa.Text;
                else if (txtMaKhoa.Text.Length == 2 || txtMaKhoa.Text.Length == 5)
                    txtMaKhoa.Text = "0" + txtMaKhoa.Text;
                DMKhoa _dmkhoa = DMKhoa.GetDMKhoa(txtMaKhoa.Text);

                if (_dmkhoa.MaKhoa == "")
                {
                    DMKhoaList _dmkhoal = DMKhoaList.FindDMKhoaByMa(txtMaKhoa.Text, Pub_sAccount);
                    if (_dmkhoal.Count == 1)
                    {
                        _dmkhoa = _dmkhoal[0];
                    }
                    else
                    {
                        _dmkhoa = _dmkhoal.FirstOrDefault(X => X.MaKhoa == txtMaKhoa.Text);
                    }
                }
                if (_dmkhoa.MaKhoa == "")
                    return;
                cboKhoaKB.Text = _dmkhoa.TenKhoa;
                cboKhoaKB.SelectedValue = _dmkhoa.MaKhoa;
                if (cboLoaiBN.SelectedValue != "3")
                {
                    if (cboChuyenKhoa.SelectedValue == "")
                        cboChuyenKhoa.SelectedValue = _dmkhoa.Machuyenkhoa;
                    if (_dmkhoa.MaDV != "" && grdXNTT.MasterTableView.IsItemInserted == true && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count < 1)
                    {
                        txtmadv.Value = _dmkhoa.MaDV + ",";
                        if (CheckFormData() == true)
                        {

                            AddXN(null);
                            grdXNTT.MasterTableView.Rebind();
                            grdXNTT.Rebind();
                            grdXNTT.MasterTableView.IsItemInserted = true;
                            grdXNTT.MasterTableView.InsertItem();
                        }
                        else
                        {
                            txtMaKhoa.Text = "";
                            cboKhoaKB.SelectedValue = "";
                            cboKhoaKB.Text = "";
                        }
                        txtmadv.Value = "";

                    }
                }
                //ShowDV();
                txtMaNV.Focus();
            }
            txtMaNV.Focus();
        }

        catch (Exception ex)
        {
            return;
        }
    }
    protected void txtMaBAQL_TextChanged(object sender, EventArgs e)
    {
        if (txtMaBAQL.Text != "")
        {
            ThongtinBN _obttbn;
            if (_LoaiPhieu == 1 && _Duyet == 1)
                _obttbn = ThongtinBN.GetThongtinBN(txtMaBAQL.Text, DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), 11, _NoiTT);

            else
                _obttbn = ThongtinBN.GetThongtinBN(txtMaBAQL.Text, DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), _LoaiPhieu, _NoiTT);
            if (_obttbn != null && _obttbn.MaBN != "" && txtmabn.Text == _obttbn.MaBN)
            {
                ShowMessage("Đã có mã quản lý bệnh nhân này");
                return;
            }

            if (_obttbn != null && _obttbn.MaBN != "")
            {

                _ThongtinBN = _obttbn;

                _MaBN = _ThongtinBN.MaBN;
                if (_ThongtinBN.KhamBenh.IsNew == true)
                {
                    _ThongtinBN.KhamBenh.MaDT = _ThongtinBN.MaDT;
                    //_ThongtinBN.KhamBenh.LoaiKham = byte.Parse(cboLoaiBN.SelectedValue);
                    _ThongtinBN.KhamBenh.LoaiKham = (cboLoaiBN.SelectedValue == "" ? byte.Parse("0") : byte.Parse(cboLoaiBN.SelectedValue));

                    DMDoiTuong _DMDoiTuong = DMDoiTuong.GetDMDoiTuong(_ThongtinBN.MaDT);

                    if (_DMDoiTuong != null)
                    {
                        cboDoiTuong.SelectedValue = _DMDoiTuong.MaDT;
                        _ThongtinBN.KhamBenh.bhtra = _DMDoiTuong.bhtra;
                        _ThongtinBN.KhamBenh.MaDT = _DMDoiTuong.MaDT;
                        _ThongtinBN.KhamBenh.sotienbhtra = _DMDoiTuong.Sotien;
                    }

                }
                else
                {
                    if (_LoaiPhieu == 2 && (HTC.ShareVariables.pub_spC == "PS"))
                    {
                        ThongtinBN _obttbn9 = ThongtinBN.GetThongtinBN(txtmabn.Text, DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None), 9, _NoiTT);
                        if (_obttbn9.KhamBenh.KhamBenh_GetsDichVuCTTList.Count > 0)
                            OpenWindow("frmLapPhieu.aspx?LoaiPhieu=9&noitt=" + _NoiTT + "&duyet=" + _Duyet + "&MaBN=" + txtmabn.Text + "&NgayDK=" + dtNgayDK.Text + "&PubMaDT=" + _PubMaDT);
                        _obttbn9 = null;
                    }
                }
                LoadData(false);
                SetData();
                enableTNBN(false);
                BefoChuyenDT();
            }
        }

    }
    protected void grdXNTT_ItemCreated(object sender, GridItemEventArgs e)
    {

        if (e.Item is GridEditableItem && e.Item.IsInEditMode)
        {

            GridEditableItem editItem = (GridEditableItem)e.Item;
            if (editItem.ItemIndex != -1)
            {
                return;
            }

            RadComboBox combo = (RadComboBox)editItem.FindControl("cboMaDichVu");
            //RadComboBox comboMa = (RadComboBox)editItem.FindControl("cboMaDichVu");

            if (_LoaiPhieu == 2)
            {

                combo.EnableLoadOnDemand = true;
                combo.EnableAutomaticLoadOnDemand = true;
                combo.CheckBoxes = false;
                //comboMa.EnableLoadOnDemand = false;
                //comboMa.EnableAutomaticLoadOnDemand = false;
            }
            else if (_LoaiPhieu != 1 && (HTC.ShareVariables.pub_spC == "PS"))
            {
                combo.EnableLoadOnDemand = true;
                combo.EnableAutomaticLoadOnDemand = true;
                combo.CheckBoxes = false;
                //comboMa.EnableLoadOnDemand = true;
                //comboMa.EnableAutomaticLoadOnDemand = true;
                //cboNhanVien.EnableLoadOnDemand = true;
                //cboNhanVien.EnableAutomaticLoadOnDemand = true;
            }

            else if (((_LoaiPhieu == 9 || _LoaiPhieu == 8)) && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count >= 1)
            {
                if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 1)
                {
                    if (txtMaKhoa.Text != "" || cboKhoaKB.SelectedValue != "")
                    {
                        combo.EnableLoadOnDemand = true;
                        combo.EnableAutomaticLoadOnDemand = true;
                        combo.CheckBoxes = false;

                    }
                    else
                    {
                        //combo.EnableLoadOnDemand = false;
                        //combo.EnableAutomaticLoadOnDemand = false;
                        combo.EnableLoadOnDemand = true;
                        combo.EnableAutomaticLoadOnDemand = true;
                        combo.CheckBoxes = true;
                        combo.OnClientKeyPressing = "OnClientFocus";
                    }
                }
                else
                {
                    //combo.EnableLoadOnDemand = false;
                    //combo.EnableAutomaticLoadOnDemand = false;
                    combo.EnableLoadOnDemand = true;
                    combo.EnableAutomaticLoadOnDemand = true;
                    combo.CheckBoxes = true;
                    combo.OnClientKeyPressing = "OnClientFocus";
                }
                //comboMa.EnableLoadOnDemand = false;
                //comboMa.EnableAutomaticLoadOnDemand = false;

            }
            //else if (_LoaiPhieu == 1 && (HTC.ShareVariables.pub_spC == "HU"))
            //{
            //    combo.Filter = RadComboBoxFilter.Contains;
            //    combo.DataTextField = "TenDD";
            //    combo.EnableAutomaticLoadOnDemand = false;
            //    combo.EnableLoadOnDemand = true;

            //    //comboMa.EnableLoadOnDemand = true;
            //    //comboMa.EnableAutomaticLoadOnDemand = true;
            //    //cboNhanVien.EnableLoadOnDemand = true;
            //    //cboNhanVien.EnableAutomaticLoadOnDemand = true;
            //}
            else if (_LoaiPhieu == 1)
            {

                //combo.EnableLoadOnDemand = true;
                //combo.EnableAutomaticLoadOnDemand = true;

                combo.Filter = RadComboBoxFilter.StartsWith;
                combo.OnClientItemsRequesting = "OnClientItemsRequesting";
                combo.EnableAutomaticLoadOnDemand = true;
                combo.EnableLoadOnDemand = true;
                //comboMa.EnableLoadOnDemand = false;
                //comboMa.EnableAutomaticLoadOnDemand = false;
            }
            else if ((_LoaiPhieu == 9 || _LoaiPhieu == 8))
            {

                combo.EnableLoadOnDemand = true;
                combo.EnableAutomaticLoadOnDemand = true;
                combo.CheckBoxes = false;
                //comboMa.EnableLoadOnDemand = false;
                //comboMa.EnableAutomaticLoadOnDemand = false;
            }
        }
        //else if (_ThongtinBN.MaBN  == "" && _ThongtinBN.MaTinh   == "")
        //{
        //    ShowMessage(_ThongtinBN.MaTinh);
        //    combo.EnableLoadOnDemand = true;
        //    combo.EnableAutomaticLoadOnDemand = true;

        //    //cboNhanVien.EnableLoadOnDemand = true;
        //    //cboNhanVien.EnableAutomaticLoadOnDemand = true;
        //}
        //else
        //{

        //    combo.EnableLoadOnDemand = false;
        //    combo.EnableAutomaticLoadOnDemand = false;

        //}

    }

    private void ShowDV()
    {
        if (_LoaiPhieu != 7)
        {
            if (grdXNTT.MasterTableView.IsItemInserted == true)
            {
                GridEditableItem editedItem;
                try
                {
                    editedItem = grdXNTT.MasterTableView.GetInsertItem();


                }

                catch (Exception ex)
                {
                    return;
                }
                if (editedItem != null)
                {
                    RadComboBox combo = (RadComboBox)editedItem.FindControl("cboDichVu");
                    if (combo.EnableAutomaticLoadOnDemand == true)
                    {
                        combo.EnableLoadOnDemand = false;
                        combo.EnableAutomaticLoadOnDemand = false;
                        combo.CheckBoxes = true;
                        combo.OnClientFocus = "OnClientFocus";
                        combo.DataBind();
                    }
                }
            }
        }

    }
    protected void cboKhoaKB_SelectedIndexChanged(object sender, RadComboBoxSelectedIndexChangedEventArgs e)
    {
        if (cboKhoaKB.SelectedValue == "" && cboKhoaKB.Text != "")
        {
            DMKhoaList _dmkhoal = DMKhoaList.FindDMKhoaByTen(cboKhoaKB.Text, Pub_sAccount);
            if (_dmkhoal.Count > 0)
            {
                cboKhoaKB.Text = _dmkhoal[0].TenKhoa;
                cboKhoaKB.SelectedValue = _dmkhoal[0].MaKhoa;
            }
        }

        if (grdXNTT.MasterTableView.IsItemInserted == true && cboKhoaKB.SelectedValue != "")
        {
            //cboKhoaKB.ClearSelection();
            //cboKhoaKB.DataBind();
            //RadComboBoxItem selectedItem = new RadComboBoxItem();

            DMKhoaList _dmkhoal = DMKhoaList.FindDMKhoaByMa(cboKhoaKB.SelectedValue, Pub_sAccount);

            if (_dmkhoal.Count > 0)
            {
                DMKhoa dmkhoa = _dmkhoal.FirstOrDefault(x => x.MaKhoa == cboKhoaKB.SelectedValue);
                cboKhoaKB.Text = dmkhoa.TenKhoa;
                cboKhoaKB.SelectedValue = dmkhoa.MaKhoa;
                txtMaKhoa.Text = dmkhoa.MaKhoa;

                if ((cboLoaiBN.SelectedValue != "3" && HTC.ShareVariables.pub_spC == "PS") || HTC.ShareVariables.pub_spC == "YH" || HTC.ShareVariables.pub_spC == "PH" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN")
                {
                    if (cboChuyenKhoa.SelectedValue == "")
                        cboChuyenKhoa.SelectedValue = dmkhoa.Machuyenkhoa;

                    if (HTC.ShareVariables.pub_spC == "YH" && (_LoaiPhieu == 2 || (_LoaiPhieu == 1 && cboDKBD.SelectedValue != "")))
                    {
                        txtmadv.Value = "PK93,";
                        if (CheckFormData() == true)
                        {

                            AddXN(null);
                            grdXNTT.MasterTableView.Rebind();
                            grdXNTT.Rebind(); grdXNTT.MasterTableView.IsItemInserted = true;
                            grdXNTT.MasterTableView.InsertItem();
                        }
                        txtmadv.Value = "";
                    }
                    else if (dmkhoa.MaDV != "" && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0)
                    {
                        txtmadv.Value = dmkhoa.MaDV + ",";

                        if (CheckFormData() == true)
                        {

                            AddXN(null);
                            grdXNTT.MasterTableView.Rebind();
                            grdXNTT.Rebind();
                            grdXNTT.MasterTableView.IsItemInserted = true;
                            grdXNTT.MasterTableView.InsertItem();
                        }
                        txtmadv.Value = "";

                    }
                }
            }
            //ShowDV();

        }
        txtMaNV.Focus();
        // grdXNTT.Focus();
    }
    protected void txtDKGT_TextChanged(object sender, EventArgs e)
    {
        DMBenhVienList _DMBenhVienl = DMBenhVienList.FindDMBenhVienByMa(txtDKGT.Text);
        if (_DMBenhVienl.Count > 0)
        {
            cboDKGT.SelectedValue = _DMBenhVienl[0].MaBV;
            cboDKGT.Text = _DMBenhVienl[0].TenBV;
            txtDKGT.Text = _DMBenhVienl[0].MaBHXH;
            cboCDnoiGT.Focus();
        }
        else
        {
            ShowMessage("Không có mã bệnh viện này ");
        }
    }
    protected void txtDKBD_TextChanged(object sender, EventArgs e)
    {

        DMBenhVienList _DMBenhVienl = DMBenhVienList.FindDMBenhVienByMa(txtDKBD.Text);
        if (_DMBenhVienl.Count > 0)
        {
            cboDKBD.SelectedValue = _DMBenhVienl[0].MaBV;
            cboDKBD.Text = _DMBenhVienl[0].TenBV;
            txtDKBD.Text = _DMBenhVienl[0].MaBHXH;
            if (cboDKBD.SelectedValue == HTC.ShareVariables.pub_sMaBV)
                ttgt.Visible = false;
            else
                ttgt.Visible = true;
            txthoten.Focus();

        }
        else
        {
            ShowMessage("Không có mã bệnh viện này ");
        }

    }
    protected void grdLichSuKham_NeedDataSource(object sender, GridNeedDataSourceEventArgs e)
    {
        if (_KhamBenh_GETsMABNListInfo != null)
            grdLichSuKham.DataSource = _KhamBenh_GETsMABNListInfo;
    }
    protected void grdKhoa_NeedDataSource(object sender, GridNeedDataSourceEventArgs e)
    {
        if (_ThongKe_BenhNhan_NgoaiTruListInfo != null)
            grdKhoa.DataSource = _ThongKe_BenhNhan_NgoaiTruListInfo;
    }

    protected void cbohuyen_SelectedIndexChanged(object sender, RadComboBoxSelectedIndexChangedEventArgs e)
    {
        try
        {
            if (_LoaiPhieu == 1 || _LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8))
            {
                if (cbohuyen.AutoPostBack == true)
                {
                    if (_ThongtinBN.KhamBenh.KhamBenh_GetsDichVuCTTList.Count == 0 && _ThongtinBN.KhamBenh.KhamBenh_GetsDichVuList.Count == 0 && _ThongKe_BenhNhan_NgoaiTruListInfo == null)
                    {
                        DateTime m = DateTime.ParseExact(dtNgayDK.Text, "dd/MM/yyyy", CultureInfo.CurrentCulture, DateTimeStyles.None);
                        if (_PubMaDT == "TT")
                        {
                            string _DK = _NoiTT + " EXISTS(SELECT B.MAKHOals FROM ACCOUNT B WHERE DBO.FGIAIMA(ACCOUNT)  ='" + Pub_sAccount;
                            _DK = _DK + "' AND (CHARINDEX( '''' + A.MAKHOa + '''' ,B.MAKHOals,1) <> 0 OR  ALLMAKHOacls = 1  or ALLMAKHOals = 1 )) ";

                            _ThongKe_BenhNhan_NgoaiTruListInfo = ThongKe_BenhNhan_NgoaiTruListInfo.GetThongKe_BenhNhan_NgoaiTru_Info(m, m, "All", 7, _DK);

                        }
                        else if (_PubMaDT == "BH")
                        {
                            string _DK = _NoiTT + " EXISTS(SELECT B.MAKHOals FROM ACCOUNT B WHERE DBO.FGIAIMA(ACCOUNT)  ='" + Pub_sAccount;
                            _DK = _DK + "' AND (CHARINDEX( '''' + A.MAKHOa + '''' ,B.MAKHOals,1) <> 0 OR  ALLMAKHOacls = 1  or ALLMAKHOals = 1 )) ";

                            _ThongKe_BenhNhan_NgoaiTruListInfo = ThongKe_BenhNhan_NgoaiTruListInfo.GetThongKe_BenhNhan_NgoaiTru_Info(m, m, "All", 8, _DK);

                        }
                        else
                        {
                            string _DK = _NoiTT + " EXISTS(SELECT B.MAKHOals FROM ACCOUNT B WHERE DBO.FGIAIMA(ACCOUNT)  ='" + Pub_sAccount;
                            _DK = _DK + "' AND (CHARINDEX( '''' + A.MAKHOa + '''' ,B.MAKHOals,1) <> 0 OR  ALLMAKHOacls = 1  or ALLMAKHOals = 1 )) ";

                            _ThongKe_BenhNhan_NgoaiTruListInfo = ThongKe_BenhNhan_NgoaiTruListInfo.GetThongKe_BenhNhan_NgoaiTru_Info(m, m, "All", 9, _DK);

                        }
                        if (_ThongtinBN.MaBN != "")
                        {
                            _KhamBenh_GETsMABNListInfo = KhamBenh_GETsMABNListInfo.GetAllKhamBenh_GETsMABNInfo(_ThongtinBN.MaBN, 1, "");
                            grdLichSuKham.DataSource = _KhamBenh_GETsMABNListInfo;
                            grdLichSuKham.DataBind();
                            grdLichSuKham.Visible = true;
                        }

                        grdKhoa.DataSource = _ThongKe_BenhNhan_NgoaiTruListInfo;
                        grdKhoa.DataBind();
                        grdKhoa.Visible = true;
                        grdXNTT.Height = 100;
                        cboNgheNghiep.Focus();
                    }
                }
            }
            if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN")
            {
                cboPXa.DataBind();
                cboPXa.Focus();
            }
        }
        catch (Exception ex)
        {
            ShowMessage("Không in được báo cáo" + ex.Message);

            //throw;
        }
    }

    protected void cboLoaiBN_SelectedIndexChanged1(object sender, EventArgs e)
    {
        if (HTC.ShareVariables.pub_spC == "PS" && _LoaiPhieu == 1)
            if (cboLoaiBN.SelectedValue == "0")
                txtmabn.Enabled = false;
            else
                txtmabn.Enabled = true;
        if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "087")
        {
            txtMaKhoa.Text = "";
            cboKhoaKB.SelectedValue = "";
            cboKhoaKB.Text = "";
        }
    }
    //[WebMethod]
    //  public  static DMQuanHuyenListcb cboDMTinhChange(string Value)
    //  {
    //     return DMQuanHuyenListcb.GetListbyTinh(Value);

    //  }

    //  [WebMethod]
    //  public static DMPhuongXaListcb cboDMHuyenChange(string Value)
    //  {

    //      return DMPhuongXaListcb.GetListbyQH(Value);

    //  }

    protected void cdsKhoa_Selecting(object sender, ObjectDataSourceSelectingEventArgs e)
    {
        if (HTC.ShareVariables.pub_sTenBV == "BỆNH VIỆN TRUNG ƯƠNG HUẾ ")
        {
            cdsKhoa.SelectMethod = "GetListByAccountNgoaiTru";
        }
        e.InputParameters["account"] = Pub_sAccount;
    }
    protected void cboquocgia_SelectedIndexChanged(object sender, RadComboBoxSelectedIndexChangedEventArgs e)
    {
        if (cboquocgia.SelectedValue != "00084")
        {
            _ThongtinBN.MaTinh = "";
            cbotinh.SelectedValue = "";
            cbotinh.Text = "";
        }
        txtDiaChi.Focus();
    }
    protected void txtQRCode_TextChanged(object sender, EventArgs e)
    {
        try
        {
           
            if (txtQRCode.Text != "")
            {
                txtSoThe.Text = txtQRCode.Text.Substring(0, 15).ToUpper();
                KiemTraSoThe();
                string charkt = txtQRCode.Text.Substring(15, 1);
               
                if (txtmabn.Text == "")
                {
                    DMTinh TI = DMTinh.GetDMTinh(txtQRCode.Text.Substring(3, 2));
                    if (TI.MaTinh != "")
                    {
                        cbotinh.SelectedValue = TI.MaTinh;
                        cbotinh.Text = TI.TenTinh;
                        cbohuyen.DataBind();
                    }
                    string chuoi = txtQRCode.Text.Substring(16);
                    string kt = chuoi.Substring(0, chuoi.IndexOf(charkt));
                    txthoten.Text = ConvertHexStrToUnicode(kt.Trim());
                    chuoi = chuoi.Replace(kt + charkt, "");
                    if (chuoi.Substring(0, 10).IndexOf(charkt) > 0)
                    {
                        dtNgaySinh.Text = "01/01/" + chuoi.Substring(0, 4);
                        chuoi = chuoi.Substring(5);
                    }
                    else
                    {
                        dtNgaySinh.Text = chuoi.Substring(0, 10);
                        chuoi = chuoi.Substring(11);
                    }
                    txttuoi.Text = DateDiff(DateInterval.Year, DateTime.Parse(dtNgaySinh.Text), DateTime.Now).ToString();


                    if (chuoi.Substring(0, 1) == "1")
                    {
                        optGT.Items[0].Selected = true;
                        optGT.Items[1].Selected = false;
                    }
                    else
                    {
                        optGT.Items[1].Selected = true;
                        optGT.Items[0].Selected = false;
                    }
                    chuoi = chuoi.Substring(2);
                    kt = chuoi.Substring(0, chuoi.IndexOf(charkt));
                    txtDiaChi.Text = ConvertHexStrToUnicode(kt.Trim());

                    chuoi = chuoi.Replace(kt + charkt, "");
                    kt = chuoi.Substring(0, chuoi.IndexOf(charkt));
                    chuoi = chuoi.Replace(kt + charkt, "");
                    kt = kt.Replace(" - ", "");
                    kt = kt.Replace("-", "");
                    kt = kt.Replace(" ", "");
                    kt = kt.Replace(" – ", "");
                    kt = kt.Replace("–", "");
                    kt = kt.Replace(" ", "");
                    txtDKBD.Text = kt;
                    DMBenhVienList _DMBenhVienl = DMBenhVienList.FindDMBenhVienByMa(txtDKBD.Text);
                    if (_DMBenhVienl.Count > 0)
                    {
                        cboDKBD.SelectedValue = _DMBenhVienl[0].MaBV;
                        cboDKBD.Text = _DMBenhVienl[0].TenBV;
                        txtDKBD.Text = _DMBenhVienl[0].MaBHXH;
                        if (cboDKBD.SelectedValue == HTC.ShareVariables.pub_sMaBV)
                            ttgt.Visible = false;
                        else
                            ttgt.Visible = true;
                        cbotinh.Focus();

                    }
                    else
                    {
                        ShowMessage("Không có mã bệnh viện này ");

                    }

                    dtBHYTTN.Text = chuoi.Substring(0, 10);
                    chuoi = chuoi.Substring(11);

                    if (chuoi.Substring(0, 2) == "-|")
                    {
                        chuoi = chuoi.Substring(3);
                        dtBHYTDN.Text = DateTime.Parse(dtBHYTTN.Text).AddYears(1).AddDays(-1).ToString("dd/MM/yyyy");
                    }
                    else
                    {
                        dtBHYTDN.Text = chuoi.Substring(0, 10);
                        chuoi = chuoi.Substring(11);
                    }

                }
                string chuoidc = txtDiaChi.Text;
                if (txtDiaChi.Text.LastIndexOf(", ") > 1)
                {
                    int i = chuoidc.LastIndexOf(", ");
                    chuoidc = chuoidc.Substring(0, i);
                    if (chuoidc.LastIndexOf(", ") > 1)
                    {
                        i = chuoidc.LastIndexOf(", ");
                        txtDiaChi.Text = txtDiaChi.Text.Substring(0, i);
                        chuoidc = chuoidc.Substring(i + 1).Trim();
                        DMQuanHuyen qh = DMQuanHuyen.GetDMQuanHuyen(cbotinh.SelectedValue + chuoidc);
                        if (qh.TenQH != "")
                        {
                            cbohuyen.Text = qh.TenQH;
                            cbohuyen.SelectedValue = qh.MaQH;

                            if (HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN")
                            {
                                cboPXa.DataBind();
                                cboPXa.Focus();
                            }
                            else
                            {
                                cboNgheNghiep.Focus();
                            }
                        }
                    }
                }
                if (HTC.ShareVariables.pub_spC == "HU" && _LoaiPhieu == 2)
                {
                    if (txtDiaChi.Text.IndexOf(", ") > 0)
                    {
                        int i = txtDiaChi.Text.IndexOf(", ");
                        txtDiaChi.Text = txtDiaChi.Text.Substring(0, i);
                    }
                }

                txtQRCode.Text = "";
            }
        }
        catch (Exception ex)
        {
            ShowMessage("Không thực hiện được " + ex.Message);

            //throw;
        }
    }
    private string ConvertHexStrToUnicode(string hexString)
    {
        int length = hexString.Length;
        byte[] bytes = new byte[length / 2];
        for (int i = 0; i < length; i += 2)
        {
            bytes[i / 2] = Convert.ToByte(hexString.Substring(i, 2), 16);
        }
        return Encoding.UTF8.GetString(bytes);
    }
    protected void txtdienthoai_TextChanged(object sender, EventArgs e)
    {
        if (txtdienthoai.AutoPostBack == true)
        {
            if (txtmabn.Text == "" && _ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0 && HTC.ShareVariables.pub_spC == "PS")
            {

                SearchData();
            }
        }
    }
    protected void txtmabnKT_TextChanged(object sender, EventArgs e)
    {
        KhamBenh_GETsMABNListInfo _KhamBenh_GETsMABNListInfo = KhamBenh_GETsMABNListInfo.GetAllKhamBenh_GETsMABNInfo(txtMaBNKT.Text, 2, "");
        if (_KhamBenh_GETsMABNListInfo.Count > 0)
            ShowMessage(_KhamBenh_GETsMABNListInfo[0].tenbenh);
    }
    protected void txtSoCMT_TextChanged(object sender, EventArgs e)
    {
        SearchBNCMT();
    }
    protected void CreateThongTinBN()
    {


        txtmabn.Enabled = false;
        _MaBN = Pub_sCodePatient;

        CurrentTabIndex = 0;
        txtindextab.Value = CurrentTabIndex.ToString();
        RadTabStrip1.SelectedIndex = CurrentTabIndex;
        RadMultiPage1.SelectedIndex = CurrentTabIndex;
        LoadData();
        SetData();
        if (_ThongtinBN.KhamBenh.KhamBenh_C_List != null)
        {
            if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count == 0 && ((_LoaiPhieu == 1 && (HTC.ShareVariables.pub_spC == "PS" || HTC.ShareVariables.pub_spC == "HU" || HTC.ShareVariables.pub_spC == "QN" || HTC.ShareVariables.pub_spC == "PH")) || ((_LoaiPhieu == 2 || (_LoaiPhieu == 9 || _LoaiPhieu == 8)) && HTC.ShareVariables.pub_spC != "PS")))
            {
                grdXNTT.MasterTableView.IsItemInserted = true;
                grdXNTT.DataBind();
            }
        }
        else if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList != null)
        {
            if ((_ThongtinBN.KhamBenh.KhamBenh_ThuocSD_DYList.Count == 0 && _LoaiPhieu == 7 && (_NoiTT == "090" || _NoiTT == "087" || _NoiTT == "094" || _NoiTT == "093")))
            {
                grdThuocDY.MasterTableView.IsItemInserted = true;
                grdThuocDY.DataBind();
            }
        }

        else if (_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList != null)
        {
            if ((_ThongtinBN.KhamBenh.KhamBenh_ThuocSDList.Count == 0 && (_LoaiPhieu == 7 || _LoaiPhieu == 3)))
            {
                grdThuoc.MasterTableView.IsItemInserted = true;
                grdThuoc.DataBind();
            }
        }
    }

    public string _ma_co_soHD
    {
        get
        {
            if (HTC.ShareVariables.pub_spC == "PH")
                return "01925";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT =="092")
                return "01_004242";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "091")
                return "01_004241";
            else if (HTC.ShareVariables.pub_spC == "HH")
                return "01-000143"; // "01-000143";
            else
                return "";
        }
    }
    public string _tai_khoanHD
    {
        get
        {
            if (HTC.ShareVariables.pub_spC == "PH")
                return "01925";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "056")
                return "admin_01_004242_03_0836hno";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "043")
                return "admin_01_004241_03_0971hno";
            else if (HTC.ShareVariables.pub_spC == "HH")
                return "gpp_01_000143_030633"; //"gpp_01_000143_030633";
            else
                return "";
        }
    }
    public string _passwordHD
    {
        get
        {
            if (HTC.ShareVariables.pub_spC == "PH")
                return "123456a";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "091")
                return "123456a";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "092")
                return "123456a";
            else if (HTC.ShareVariables.pub_spC == "HH")
                return "123456a";
            else
                return "123456a";
        }

    }
    public string _ten_co_soHD
    {
        get
        {
            if (HTC.ShareVariables.pub_spC == "PH")
                return "01925";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "091")
                return "BỆNH VIỆN PHỤ SẢN TRUNG ƯƠNG";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "092")
                return "NHÀ THUỐC BỆNH VIỆN PHỤ SẢN TRUNG ƯƠNG";
            else if (HTC.ShareVariables.pub_spC == "HH")
                return "NHÀ THUỐC VIỆN HUYẾT HỌC-TRUYỀN MÁU TRUNG ƯƠNG";
            else
                return "";
        }
    }

    public string _ma_co_so
    {
        get
        {
            if (HTC.ShareVariables.pub_spC == "PH")
                return "01925";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "091")
                return "01905";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "092")
                return "01905";
            else if (HTC.ShareVariables.pub_spC == "HH")
                return "01920"; // "01-000143";
            else
                return "";
        }
    }
    public string _tai_khoan
    {
        get
        {
            if (HTC.ShareVariables.pub_spC == "PH")
                return "01925";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "091")
                return "admin_01925";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "092")
                return "admin_01925";
            else if (HTC.ShareVariables.pub_spC == "HH")
                return "admin_01920"; //"gpp_01_000143_030633";
            else
                return "";
        }
    }
    public string _password
    {
        get
        {
            if (HTC.ShareVariables.pub_spC == "PH")
                return "123456a";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "091")
                return "123456a";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "092")
                return "123456a";
            else if (HTC.ShareVariables.pub_spC == "HH")
                return "123456a";
            else
                return "123456a";
        }

    }
    public string _ten_co_so
    {
        get
        {
            if (HTC.ShareVariables.pub_spC == "PH")
                return "01925";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "091")
                return "BỆNH VIỆN PHỤ SẢN TRUNG ƯƠNG";
            else if (HTC.ShareVariables.pub_spC == "PS" && _NoiTT == "092")
                return "BỆNH VIỆN PHỤ SẢN TRUNG ƯƠNG";
            else if (HTC.ShareVariables.pub_spC == "HH")
                return "VIỆN HUYẾT HỌC-TRUYỀN MÁU TRUNG ƯƠNG";
            else
                return "";
        }
    }

    #region object RESTful
    //object phan API đăng nhập lấy phiên làm việc
    //object gui username, pass
    [Serializable()]
    public class dangnhap
    {
        private string usr = string.Empty;
        public string Usr
        {
            get
            {
                return usr;
            }
            set
            {
                usr = value;
            }
        }
        private string pwd = string.Empty;
        public string Pwd
        {
            get
            {
                return pwd;
            }
            set
            {
                pwd = value;
            }
        }
    }
    //object lay token tra ve
    [Serializable()]
    public class token_return_data
    {
        private string token = string.Empty;
        public string Token
        {
            get
            {
                return token;
            }
            set
            {
                token = value;
            }
        }
        private string token_type = string.Empty;
        public string Token_type
        {
            get
            {
                return token_type;
            }
            set
            {
                token_type = value;
            }
        }
    }
    [Serializable()]
    public class token_return
    {
        private int code = 0;
        public int Code
        {
            get
            {
                return code;
            }
            set
            {
                code = value;
            }
        }
        private string message = string.Empty;
        public string Message
        {
            get
            {
                return message;
            }
            set
            {
                message = value;
            }
        }
        private token_return_data data;
        public token_return_data Data
        {
            get { return data; }
            set { data = value; }
        }
    }
    //object phan Tạo đơn thuốc từ cơ sở khám chữa bệnh
    [Serializable()]
    public class donthuoc
    {
        private string Ma_don_thuoc_co_so_kcb = string.Empty;
        public string ma_don_thuoc_co_so_kcb
        {
            get
            {
                return Ma_don_thuoc_co_so_kcb;
            }
            set
            {
                Ma_don_thuoc_co_so_kcb = value;
            }
        }
        private thong_tin_don_vi Thong_tin_don_vi;
        public thong_tin_don_vi thong_tin_don_vi
        {
            get
            {
                return Thong_tin_don_vi;
            }
            set
            {
                Thong_tin_don_vi = value;
            }
        }
        private thong_tin_benh_nhan Thong_tin_benh_nhan;
        public thong_tin_benh_nhan thong_tin_benh_nhan
        {
            get { return Thong_tin_benh_nhan; }
            set { Thong_tin_benh_nhan = value; }
        }
        private thong_tin_benh Thong_tin_benh;
        public thong_tin_benh thong_tin_benh
        {
            get { return Thong_tin_benh; }
            set { Thong_tin_benh = value; }
        }
        private List<thong_tin_don_thuoc> Thong_tin_don_thuoc;
        public List<thong_tin_don_thuoc> thong_tin_don_thuoc
        {
            get
            {
                if (Thong_tin_don_thuoc == null)
                    Thong_tin_don_thuoc = new List<thong_tin_don_thuoc>();
                return Thong_tin_don_thuoc;
            }
            set
            {
                Thong_tin_don_thuoc = value;
            }
        }
        private string Nguoi_ke_don = string.Empty;
        public string nguoi_ke_don
        {
            get
            {
                return Nguoi_ke_don;
            }
            set
            {
                Nguoi_ke_don = value;
            }
        }
        private string Ngay_ke_don = string.Empty;
        public string ngay_ke_don
        {
            get
            {
                return Ngay_ke_don;
            }
            set
            {
                Ngay_ke_don = value;
            }
        }
    }
    [Serializable()]
    public class thong_tin_don_vi
    {
        private string Ma_co_so_kcb = string.Empty;
        public string ma_co_so_kcb
        {
            get
            {
                return Ma_co_so_kcb;
            }
            set
            {
                Ma_co_so_kcb = value;
            }
        }
        private string Ten_co_so_kcb = string.Empty;
        public string ten_co_so_kcb
        {
            get
            {
                return Ten_co_so_kcb;
            }
            set
            {
                Ten_co_so_kcb = value;
            }
        }
    }
    [Serializable()]
    public class thong_tin_benh_nhan
    {
        private string Ma_benh_nhan = string.Empty;
        public string ma_benh_nhan
        {
            get
            {
                return Ma_benh_nhan;
            }
            set
            {
                Ma_benh_nhan = value;
            }
        }
        private string Ho_ten = string.Empty;
        public string ho_ten
        {
            get
            {
                return Ho_ten;
            }
            set
            {
                Ho_ten = value;
            }
        }
        private byte Tuoi = 0;
        public byte tuoi
        {
            get { return Tuoi; }
            set { Tuoi = value; }
        }
        private byte Gioi_tinh;
        public byte gioi_tinh
        {
            get { return Gioi_tinh; }
            set
            {
                Gioi_tinh = value;
            }
        }
        private decimal Can_nang = 0;
        public decimal can_nang
        {
            get { return Can_nang; }
            set { Can_nang = value; }
        }
        private decimal Chieu_cao = 0;
        public decimal chieu_cao
        {
            get { return Chieu_cao; }
            set { Chieu_cao = value; }
        }
        private string Dia_chi = string.Empty;
        public string dia_chi
        {
            get
            {
                return Dia_chi;
            }
            set
            {
                Dia_chi = value;
            }
        }
    }
    [Serializable()]
    public class thong_tin_benh
    {
        private string Ma_benh = string.Empty;
        public string ma_benh
        {
            get
            {
                return Ma_benh;
            }
            set
            {
                Ma_benh = value;
            }
        }
        private string Ten_benh = string.Empty;
        public string ten_benh
        {
            get
            {
                return Ten_benh;
            }
            set
            {
                Ten_benh = value;
            }
        }
    }
    [Serializable()]
    public class thong_tin_don_thuoc
    {
        private string Ma_thuoc = string.Empty;
        public string ma_thuoc
        {
            get
            {
                return Ma_thuoc;
            }
            set
            {
                Ma_thuoc = value;
            }
        }
        private string Ten_thuoc = string.Empty;
        public string ten_thuoc
        {
            get
            {
                return Ten_thuoc;
            }
            set
            {
                Ten_thuoc = value;
            }
        }
        private string Don_vi_tinh = string.Empty;
        public string don_vi_tinh
        {
            get
            {
                return Don_vi_tinh;
            }
            set
            {
                Don_vi_tinh = value;
            }
        }
        private string Ham_luong = string.Empty;
        public string ham_luong
        {
            get
            {
                return Ham_luong;
            }
            set
            {
                Ham_luong = value;
            }
        }
        private string Duong_dung = string.Empty;
        public string duong_dung
        {
            get
            {
                return Duong_dung;
            }
            set
            {
                Duong_dung = value;
            }
        }
        private string Lieu_dung = string.Empty;
        public string lieu_dung
        {
            get
            {
                return Lieu_dung;
            }
            set
            {
                Lieu_dung = value;
            }
        }
        private string So_dang_ky = string.Empty;
        public string so_dang_ky
        {
            get
            {
                return So_dang_ky;
            }
            set
            {
                So_dang_ky = value;
            }
        }
        private decimal So_luong = 0;
        public decimal so_luong
        {
            get { return So_luong; }
            set { So_luong = value; }
        }
    }
    //object nhan ket qua tra ve khi thao tac voi don thuoc
    [Serializable()]
    public class kq_don_thuoc_return
    {
        private int Code = 0;
        public int code
        {
            get
            {
                return Code;
            }
            set
            {
                Code = value;
            }
        }
        private string Mess = string.Empty;
        public string mess
        {
            get
            {
                return Mess;
            }
            set
            {
                Mess = value;
            }
        }
        private string Ma_don_thuoc_quoc_gia = string.Empty;
        public string ma_don_thuoc_quoc_gia
        {
            get
            {
                return Ma_don_thuoc_quoc_gia;
            }
            set
            {
                Ma_don_thuoc_quoc_gia = value;
            }
        }
    }
    //object Liên thông hóa đơn bán thuốc của cơ sở GPP
    [Serializable()]
    public class hoa_don
    {
        private string Ma_hoa_don = string.Empty;
        public string ma_hoa_don
        {
            get
            {
                return Ma_hoa_don;
            }
            set
            {
                Ma_hoa_don = value;
            }
        }
        private string Ma_co_so = string.Empty;
        public string ma_co_so
        {
            get
            {
                return Ma_co_so;
            }
            set
            {
                Ma_co_so = value;
            }
        }
        private string Ma_don_thuoc_quoc_gia = string.Empty;
        public string ma_don_thuoc_quoc_gia
        {
            get
            {
                return Ma_don_thuoc_quoc_gia;
            }
            set
            {
                Ma_don_thuoc_quoc_gia = value;
            }
        }
        private string Ngay_ban = string.Empty;
        public string ngay_ban
        {
            get
            {
                return Ngay_ban;
            }
            set
            {
                Ngay_ban = value;
            }
        }
        private string Ho_ten_nguoi_ban = string.Empty;
        public string ho_ten_nguoi_ban
        {
            get
            {
                return Ho_ten_nguoi_ban;
            }
            set
            {
                Ho_ten_nguoi_ban = value;
            }
        }
        private string Ho_ten_khach_hang = string.Empty;
        public string ho_ten_khach_hang
        {
            get
            {
                return Ho_ten_khach_hang;
            }
            set
            {
                Ho_ten_khach_hang = value;
            }
        }
        private List<hoa_don_chi_tiet> Hoa_don_chi_tiet;
        public List<hoa_don_chi_tiet> hoa_don_chi_tiet
        {
            get
            {
                if (Hoa_don_chi_tiet == null)
                    Hoa_don_chi_tiet = new List<hoa_don_chi_tiet>();
                return Hoa_don_chi_tiet;
            }
            set
            {
                Hoa_don_chi_tiet = value;
            }
        }
    }
    [Serializable()]
    public class hoa_don_chi_tiet
    {
        private string Ma_thuoc = string.Empty;
        public string ma_thuoc
        {
            get
            {
                return Ma_thuoc;
            }
            set
            {
                Ma_thuoc = value;
            }
        }
        private string Ten_thuoc = string.Empty;
        public string ten_thuoc
        {
            get
            {
                return Ten_thuoc;
            }
            set
            {
                Ten_thuoc = value;
            }
        }
        private string So_lo = string.Empty;
        public string so_lo
        {
            get
            {
                return So_lo;
            }
            set
            {
                So_lo = value;
            }
        }
        private string Ngay_san_xuat = string.Empty;
        public string ngay_san_xuat
        {
            get
            {
                return Ngay_san_xuat;
            }
            set
            {
                Ngay_san_xuat = value;
            }
        }
        private string Han_dung = string.Empty;
        public string han_dung
        {
            get
            {
                return Han_dung;
            }
            set
            {
                Han_dung = value;
            }
        }
        private string Don_vi_tinh = string.Empty;
        public string don_vi_tinh
        {
            get
            {
                return Don_vi_tinh;
            }
            set
            {
                Don_vi_tinh = value;
            }
        }
        private string Ham_luong = string.Empty;
        public string ham_luong
        {
            get
            {
                return Ham_luong;
            }
            set
            {
                Ham_luong = value;
            }
        }
        private string Duong_dung = string.Empty;
        public string duong_dung
        {
            get
            {
                return Duong_dung;
            }
            set
            {
                Duong_dung = value;
            }
        }
        private string Lieu_dung = string.Empty;
        public string lieu_dung
        {
            get
            {
                return Lieu_dung;
            }
            set
            {
                Lieu_dung = value;
            }
        }
        private string So_dang_ky = string.Empty;
        public string so_dang_ky
        {
            get
            {
                return So_dang_ky;
            }
            set
            {
                So_dang_ky = value;
            }
        }
        private decimal So_luong = 0;
        public decimal so_luong
        {
            get { return So_luong; }
            set { So_luong = value; }
        }
        private decimal Don_gia = 0;
        public decimal don_gia
        {
            get { return Don_gia; }
            set { Don_gia = value; }
        }
        private decimal Thanh_tien = 0;
        public decimal thanh_tien
        {
            get { return Thanh_tien; }
            set { Thanh_tien = value; }
        }
        private decimal Ty_le_quy_doi = 0;
        public decimal ty_le_quy_doi
        {
            get { return Ty_le_quy_doi; }
            set { Ty_le_quy_doi = value; }
        }
    }
    //object nhan ket qua tra ve khi thao tac voi hoa don
    [Serializable()]
    public class kq_hoa_don_return
    {
        private int Code = 0;
        public int code
        {
            get
            {
                return Code;
            }
            set
            {
                Code = value;
            }
        }
        private string Mess = string.Empty;
        public string mess
        {
            get
            {
                return Mess;
            }
            set
            {
                Mess = value;
            }
        }
        private string Ma_hoa_don = string.Empty;
        public string ma_hoa_don
        {
            get
            {
                return Ma_hoa_don;
            }
            set
            {
                Ma_hoa_don = value;
            }
        }
    }
    public class hoadon_delete
    {
        private string Ma_co_so = string.Empty;
        public string ma_co_so
        {
            get
            {
                return Ma_co_so;
            }
            set
            {
                Ma_co_so = value;
            }
        }
        private string Ma_hoa_don_co_so = string.Empty;
        public string ma_hoa_don_co_so
        {
            get
            {
                return Ma_hoa_don_co_so;
            }
            set
            {
                Ma_hoa_don_co_so = value;
            }
        }
    }
    // object Liên thông phiếu nhập từ cơ sở GPP
    [Serializable()]
    public class phieu_nhap
    {
        private string Ma_phieu = string.Empty;
        public string ma_phieu
        {
            get
            {
                return Ma_phieu;
            }
            set
            {
                Ma_phieu = value;
            }
        }
        private string Ma_co_so = string.Empty;
        public string ma_co_so
        {
            get
            {
                return Ma_co_so;
            }
            set
            {
                Ma_co_so = value;
            }
        }
        private string Ngay_nhap = string.Empty;
        public string ngay_nhap
        {
            get
            {
                return Ngay_nhap;
            }
            set
            {
                Ngay_nhap = value;
            }
        }
        private byte Loai_phieu_nhap = 0;
        public byte loai_phieu_nhap
        {
            get { return Loai_phieu_nhap; }
            set { Loai_phieu_nhap = value; }
        }
        private string Ghi_chu = string.Empty;
        public string ghi_chu
        {
            get
            {
                return Ghi_chu;
            }
            set
            {
                Ghi_chu = value;
            }
        }
        private string Ten_co_so_cung_cap = string.Empty;
        public string ten_co_so_cung_cap
        {
            get
            {
                return Ten_co_so_cung_cap;
            }
            set
            {
                Ten_co_so_cung_cap = value;
            }
        }
        private List<chi_tiet> chi_tiet;
        public List<chi_tiet> Chi_tiet
        {
            get
            {
                if (chi_tiet == null)
                    chi_tiet = new List<chi_tiet>();
                return chi_tiet;
            }
            set
            {
                chi_tiet = value;
            }
        }
    }
    [Serializable()]
    public class chi_tiet
    {
        private string Ma_thuoc = string.Empty;
        public string ma_thuoc
        {
            get
            {
                return Ma_thuoc;
            }
            set
            {
                Ma_thuoc = value;
            }
        }
        private string Ten_thuoc = string.Empty;
        public string ten_thuoc
        {
            get
            {
                return Ten_thuoc;
            }
            set
            {
                Ten_thuoc = value;
            }
        }
        private string So_lo = string.Empty;
        public string so_lo
        {
            get
            {
                return So_lo;
            }
            set
            {
                So_lo = value;
            }
        }
        private string Ngay_san_xuat = string.Empty;
        public string ngay_san_xuat
        {
            get
            {
                return Ngay_san_xuat;
            }
            set
            {
                Ngay_san_xuat = value;
            }
        }
        private string Han_dung = string.Empty;
        public string han_dung
        {
            get
            {
                return Han_dung;
            }
            set
            {
                Han_dung = value;
            }
        }
        private string So_dklh = string.Empty;
        public string so_dklh
        {
            get
            {
                return So_dklh;
            }
            set
            {
                So_dklh = value;
            }
        }
        private decimal So_luong = 0;
        public decimal so_luong
        {
            get { return So_luong; }
            set { So_luong = value; }
        }
        private decimal Don_gia = 0;
        public decimal don_gia
        {
            get { return Don_gia; }
            set { Don_gia = value; }
        }
        private string Don_vi_tinh = string.Empty;
        public string don_vi_tinh
        {
            get
            {
                return Don_vi_tinh;
            }
            set
            {
                Don_vi_tinh = value;
            }
        }
    }
    //object nhan ket qua tra ve khi thao tac voi phieu_nhap
    [Serializable()]
    public class kq_phieu_nhap_return
    {
        private int Code = 0;
        public int code
        {
            get
            {
                return Code;
            }
            set
            {
                Code = value;
            }
        }
        private string Mess = string.Empty;
        public string mess
        {
            get
            {
                return Mess;
            }
            set
            {
                Mess = value;
            }
        }
        private string Ma_phieu_nhap = string.Empty;
        public string ma_phieu_nhap
        {
            get
            {
                return Ma_phieu_nhap;
            }
            set
            {
                Ma_phieu_nhap = value;
            }
        }
    }
    //object Liên thông phiếu xuất của cơ sở GPP
    [Serializable()]
    public class phieu_xuat
    {
        private string Ma_phieu = string.Empty;
        public string ma_phieu
        {
            get
            {
                return Ma_phieu;
            }
            set
            {
                Ma_phieu = value;
            }
        }
        private string Ma_co_so = string.Empty;
        public string ma_co_so
        {
            get
            {
                return Ma_co_so;
            }
            set
            {
                Ma_co_so = value;
            }
        }
        private string Ngay_xuat = string.Empty;
        public string ngay_xuat
        {
            get
            {
                return Ngay_xuat;
            }
            set
            {
                Ngay_xuat = value;
            }
        }
        private byte Loai_phieu_xuat = 0;
        public byte loai_phieu_xuat
        {
            get { return Loai_phieu_xuat; }
            set { Loai_phieu_xuat = value; }
        }
        private string Ghi_chu = string.Empty;
        public string ghi_chu
        {
            get
            {
                return Ghi_chu;
            }
            set
            {
                Ghi_chu = value;
            }
        }
        private string Ten_co_so_nhan = string.Empty;
        public string ten_co_so_nhan
        {
            get
            {
                return Ten_co_so_nhan;
            }
            set
            {
                Ten_co_so_nhan = value;
            }
        }
        private List<chi_tiet> chi_tiet;
        public List<chi_tiet> Chi_tiet
        {
            get
            {
                if (chi_tiet == null)
                    chi_tiet = new List<chi_tiet>();
                return chi_tiet;
            }
            set
            {
                chi_tiet = value;
            }
        }
    }
    //object nhan ket qua tra ve khi thao tac voi phieu_nhap
    [Serializable()]
    public class kq_phieu_xuat_return
    {
        private int Code = 0;
        public int code
        {
            get
            {
                return Code;
            }
            set
            {
                Code = value;
            }
        }
        private string Mess = string.Empty;
        public string mess
        {
            get
            {
                return Mess;
            }
            set
            {
                Mess = value;
            }
        }
        private string Ma_phieu_xuat = string.Empty;
        public string ma_phieu_xuat
        {
            get
            {
                return Ma_phieu_xuat;
            }
            set
            {
                Ma_phieu_xuat = value;
            }
        }
    }

    #endregion
    // ham dung de trao doi du lieu voi API RESTfull
    public class RESTful
    {
        public string PostURL(string url, string username, string password, string jsondata)
        {
            Uri myUri = new Uri(url);
            WebRequest myWebRequest = HttpWebRequest.Create(myUri);
            myWebRequest.ContentType = "application/json";
            myWebRequest.Method = "POST";
            HttpWebRequest myHttpWebRequest = (HttpWebRequest)myWebRequest;
            NetworkCredential myNetworkCredential = new NetworkCredential(username, password);
            CredentialCache myCredentialCache = new CredentialCache();
            myCredentialCache.Add(myUri, "Basic", myNetworkCredential);
            myHttpWebRequest.PreAuthenticate = true;
            myHttpWebRequest.Credentials = myCredentialCache;
            using (var streamWriter = new StreamWriter(myWebRequest.GetRequestStream()))
            {
                streamWriter.Write(jsondata);
                streamWriter.Flush();
                streamWriter.Close();
            }
            WebResponse myWebResponse = myWebRequest.GetResponse();
            Stream responseStream = myWebResponse.GetResponseStream();
            StreamReader myStreamReader = new StreamReader(responseStream, Encoding.Default);
            string pageContent = myStreamReader.ReadToEnd();
            responseStream.Close();
            myWebResponse.Close();
            return pageContent;
        }
        public string PutURLtoken(string url, string token, string jsondata)
        {
            Uri myUri = new Uri(url);
            WebRequest myWebRequest = HttpWebRequest.Create(myUri);
            myWebRequest.ContentType = "application/json";
            myWebRequest.Method = "PUT";
            HttpWebRequest myHttpWebRequest = (HttpWebRequest)myWebRequest;
            myHttpWebRequest.PreAuthenticate = true;
            myHttpWebRequest.Headers.Add("Authorization", "Bearer " + token);
            using (var streamWriter = new StreamWriter(myWebRequest.GetRequestStream()))
            {
                streamWriter.Write(jsondata);
                streamWriter.Flush();
                streamWriter.Close();
            }
            WebResponse myWebResponse = myWebRequest.GetResponse();
            Stream responseStream = myWebResponse.GetResponseStream();
            StreamReader myStreamReader = new StreamReader(responseStream, Encoding.Default);
            string pageContent = myStreamReader.ReadToEnd();
            responseStream.Close();
            myWebResponse.Close();
            return pageContent;
        }
        public string PostURLtoken(string url, string token, string jsondata)
        {
            Uri myUri = new Uri(url);
            WebRequest myWebRequest = HttpWebRequest.Create(myUri);
            myWebRequest.ContentType = "application/json";
            myWebRequest.Method = "POST";
            HttpWebRequest myHttpWebRequest = (HttpWebRequest)myWebRequest;
            myHttpWebRequest.PreAuthenticate = true;
            myHttpWebRequest.Headers.Add("Authorization", "Bearer " + token);
            using (var streamWriter = new StreamWriter(myWebRequest.GetRequestStream()))
            {
                streamWriter.Write(jsondata);
                streamWriter.Flush();
                streamWriter.Close();
            }
            WebResponse myWebResponse = myWebRequest.GetResponse();
            Stream responseStream = myWebResponse.GetResponseStream();
            StreamReader myStreamReader = new StreamReader(responseStream, Encoding.Default);
            string pageContent = myStreamReader.ReadToEnd();
            responseStream.Close();
            myWebResponse.Close();
            return pageContent;
        }
        public string DeleteURLtoken(string url, string token)
        {
            Uri myUri = new Uri(url);
            WebRequest myWebRequest = HttpWebRequest.Create(myUri);
            myWebRequest.ContentType = "application/json";
            myWebRequest.Method = "DELETE";
            HttpWebRequest myHttpWebRequest = (HttpWebRequest)myWebRequest;
            myHttpWebRequest.PreAuthenticate = true;
            myHttpWebRequest.Headers.Add("Authorization", "Bearer " + token);
            using (var streamWriter = new StreamWriter(myWebRequest.GetRequestStream()))
            {
                streamWriter.Flush();
                streamWriter.Close();
            }
            WebResponse myWebResponse = myWebRequest.GetResponse();
            Stream responseStream = myWebResponse.GetResponseStream();
            StreamReader myStreamReader = new StreamReader(responseStream, Encoding.Default);
            string pageContent = myStreamReader.ReadToEnd();
            responseStream.Close();
            myWebResponse.Close();
            return pageContent;
        }
    }

    #region RESTfulAPI
    //ham dang nhap de lay to_ken
    //tham so dau vao: 
    //port: dia chi url (do ncc API cung cap):  https://duocquocgia.com.vn  
    //user: username (do ncc API cung cap): thuoc: gpp_01_000130_030971, hoa don: admin_01925
    //pass: password (do ncc API cung cap): thuoc: 123456a, hoa don: 123456a
    //tra ve: chuoi token de xac thuc khi gui du lieu
    public string RESTfuldangnhap(string port, string user, string pass)
    {
        string url = port + "/api/tai_khoan/dang_nhap";
        dangnhap dn = new dangnhap();
        RESTful rf = new RESTful();
        dn.Usr = user;
        dn.Pwd = pass;
        var serializer = new JavaScriptSerializer();
        string serializedResult = serializer.Serialize(dn);
        string returndata = rf.PostURL(url, user, pass, serializedResult);
        var data = serializer.Deserialize<token_return>(returndata);
        if (data != null && data.Data.Token_type == "bearer" && !string.IsNullOrEmpty(data.Data.Token))
            return data.Data.Token;
        else return "";
    }
    #region Don thuoc
    //ham Tạo đơn thuốc từ cơ sở khám chữa bệnh
    //port: dia chi url (do ncc API cung cap):  https://duocquocgia.com.vn 
    //token: token lay duoc tu ham RESTfuldangnhap dung de xac thuc khi truyen, gui du lieu
    //dt: bien kieu class donthuoc(trong file RESTfulAPI.cs)
    // tra ve: Ma_don_thuoc_quoc_gia
    public string RESTful_tao_don_thuoc(string port, string token, donthuoc dt)
    {
        try
        {
            string url = port + "/api/lien_thong/don_thuoc";
            RESTful rf = new RESTful();
            var serializer = new JavaScriptSerializer();
            string serializedResult = serializer.Serialize(dt);
            string jsons = JsonConvert.SerializeObject(dt);
            WriteLog(jsons);
            string returndata = rf.PostURLtoken(url, token, serializedResult);
            var data = serializer.Deserialize<kq_don_thuoc_return>(returndata);

            if (data != null && data.code == 200 && data.ma_don_thuoc_quoc_gia != "")
            {
                WriteLog(data.ma_don_thuoc_quoc_gia);
                return data.ma_don_thuoc_quoc_gia;
            }
            else
            {
                WriteLog("Không nhận được mã lỗi");
                return "";

            }
        }
        catch (Exception ex)
        {
            WriteLog(ex.Message);
            return "";
        }
    }
    //ham cap nhat đơn thuốc từ cơ sở khám chữa bệnh
    //port: dia chi url (do ncc API cung cap):  https://duocquocgia.com.vn 
    //token: token lay duoc tu ham RESTfuldangnhap dung de xac thuc khi truyen, gui du lieu
    //dt: bien kieu class donthuoc(trong file RESTfulAPI.cs)
    // tra ve: Ma_don_thuoc_quoc_gia
    public string RESTful_cap_nhat_don_thuoc(string port, string token, donthuoc dt)
    {
        string url = port + "/api/lien_thong/don_thuoc";
        RESTful rf = new RESTful();
        var serializer = new JavaScriptSerializer();
        string serializedResult = serializer.Serialize(dt);
        string returndata = rf.PutURLtoken(url, token, serializedResult);
        var data = serializer.Deserialize<kq_don_thuoc_return>(returndata);
        if (data != null && data.code == 200 && data.ma_don_thuoc_quoc_gia != "")
            return data.ma_don_thuoc_quoc_gia;
        else return "";
    }
    //ham xoa đơn thuốc từ cơ sở khám chữa bệnh
    //port: dia chi url (do ncc API cung cap):  https://duocquocgia.com.vn 
    //macoso: ma cua co so kham chua benh (01925)
    //madonthuoc: Mã đơn thuốc do cơ sở khám chữa bệnh cấp
    //token: token lay duoc tu ham RESTfuldangnhap dung de xac thuc khi truyen, gui du lieu
    // tra ve: chuoi thong bao tinh trang xoa
    public string RESTful_xoa_don_thuoc(string port, string token, string macoso, string madonthuoc)
    {
        string url = port + "/api/lien_thong/don_thuoc/" + macoso + "/" + madonthuoc;
        RESTful rf = new RESTful();
        var serializer = new JavaScriptSerializer();
        string returndata = rf.DeleteURLtoken(url, token);
        var data = serializer.Deserialize<kq_don_thuoc_return>(returndata);
        return data.mess;
    }
    #endregion
    #region hoa don
    // ham tao hóa đơn bán thuốc của cơ sở GPP
    //port: dia chi url (do ncc API cung cap):  https://duocquocgia.com.vn 
    //token: token lay duoc tu ham RESTfuldangnhap dung de xac thuc khi truyen, gui du lieu
    //hd: bien kieu class hoa_don(trong file RESTfulAPI.cs)
    // tra ve: Ma_hoa_don
    public string RESTful_tao_hoa_don(string port, string token, hoa_don hd)
    {
        try
        {
            token = RESTfuldangnhap("https://duocquocgia.com.vn ", _tai_khoanHD, _passwordHD);
            string url = port + "/api/lien_thong/hoa_don";
            RESTful rf = new RESTful();
            var serializer = new JavaScriptSerializer();
            string serializedResult = serializer.Serialize(hd);
            string jsons = JsonConvert.SerializeObject(hd);
            WriteLog(jsons);
            string returndata = rf.PostURLtoken(url, token, serializedResult);
            var data = serializer.Deserialize<kq_hoa_don_return>(returndata);
            if (data != null)
            {
                WriteLog(data.mess + data.code + data.ma_hoa_don);
                return data.ma_hoa_don;
            }
            else
            {
                WriteLog("Không nhận được mã lỗi");
                return "";

            }
        }
        catch (Exception ex)
        {
            WriteLog(ex.Message);
            return "";
        }
    }
    // ham cap nhat hóa đơn bán thuốc của cơ sở GPP
    //port: dia chi url (do ncc API cung cap):  https://duocquocgia.com.vn 
    //token: token lay duoc tu ham RESTfuldangnhap dung de xac thuc khi truyen, gui du lieu
    //hd: bien kieu class hoa_don(trong file RESTfulAPI.cs)
    // tra ve: Ma_hoa_don
    public string RESTful_cap_nhat_hoa_don(string port, string token, hoa_don hd)
    {
        string url = port + "/api/lien_thong/hoa_don";
        RESTful rf = new RESTful();
        var serializer = new JavaScriptSerializer();
        string serializedResult = serializer.Serialize(hd);
        string returndata = rf.PutURLtoken(url, token, serializedResult);
        var data = serializer.Deserialize<kq_hoa_don_return>(returndata);
        if (data != null && data.code == 200 && data.ma_hoa_don != "")
            return data.ma_hoa_don;
        else return "";
    }
    //ham xoa hóa đơn bán thuốc của cơ sở GPP
    //port: dia chi url (do ncc API cung cap):  https://duocquocgia.com.vn 
    //macoso: ma cua co so kham chua benh (01-000130)
    //mahoadon: Mã đơn thuốc trên hệ thống quốc gia
    //token: token lay duoc tu ham RESTfuldangnhap dung de xac thuc khi truyen, gui du lieu
    // tra ve: chuoi thong bao tinh trang xoa
    public string RESTful_xoa_hoa_don(string port, string token, string macoso, string mahoadon)
    {
        string url = port + "/api/lien_thong/hoa_don/" + macoso + "/" + mahoadon;
        RESTful rf = new RESTful();
        var serializer = new JavaScriptSerializer();
        string returndata = rf.DeleteURLtoken(url, token);
        var data = serializer.Deserialize<kq_don_thuoc_return>(returndata);
        return data.mess;
    }
    #endregion
    #region phieu nhap
    // ham tao phiếu nhập từ cơ sở GPP
    //port: dia chi url (do ncc API cung cap):  https://duocquocgia.com.vn 
    //token: token lay duoc tu ham RESTfuldangnhap dung de xac thuc khi truyen, gui du lieu
    //pn: bien kieu class phieu_nhap(trong file RESTfulAPI.cs)
    // tra ve: Ma_phieu_nhap
    public string RESTful_tao_phieu_nhap(string port, string token, phieu_nhap pn)
    {
        string url = port + "/api/lien_thong/phieu_nhap";
        RESTful rf = new RESTful();
        var serializer = new JavaScriptSerializer();
        string serializedResult = serializer.Serialize(pn);
        string returndata = rf.PostURLtoken(url, token, serializedResult);
        var data = serializer.Deserialize<kq_phieu_nhap_return>(returndata);
        if (data != null && data.code == 200 && data.ma_phieu_nhap != "")
            return data.ma_phieu_nhap;
        else return "";
    }
    // ham cap nhat phiếu nhập từ cơ sở GPP
    //port: dia chi url (do ncc API cung cap):  https://duocquocgia.com.vn 
    //token: token lay duoc tu ham RESTfuldangnhap dung de xac thuc khi truyen, gui du lieu
    //pn: bien kieu class phieu_nhap(trong file RESTfulAPI.cs)
    // tra ve: Ma_phieu_nhap
    public string RESTful_cap_nhat_phieu_nhap(string port, string token, phieu_nhap pn)
    {
        string url = port + "/api/lien_thong/phieu_nhap";
        RESTful rf = new RESTful();
        var serializer = new JavaScriptSerializer();
        string serializedResult = serializer.Serialize(pn);
        string returndata = rf.PutURLtoken(url, token, serializedResult);
        var data = serializer.Deserialize<kq_phieu_nhap_return>(returndata);
        if (data != null && data.code == 200 && data.ma_phieu_nhap != "")
            return data.ma_phieu_nhap;
        else return "";
    }
    //ham xoa phiếu nhập từ cơ sở GPP
    //port: dia chi url (do ncc API cung cap):  https://duocquocgia.com.vn 
    //macoso: ma cua co so kham chua benh (01-000130)
    //maphieunhap: Mã phiếu nhập cơ sở
    //token: token lay duoc tu ham RESTfuldangnhap dung de xac thuc khi truyen, gui du lieu
    // tra ve: chuoi thong bao tinh trang xoa
    public string RESTful_xoa_phieu_nhap(string port, string token, string macoso, string maphieu)
    {
        string url = port + "/api/lien_thong/phieu_nhap/" + macoso + "/" + maphieu;
        RESTful rf = new RESTful();
        var serializer = new JavaScriptSerializer();
        string returndata = rf.DeleteURLtoken(url, token);
        var data = serializer.Deserialize<kq_don_thuoc_return>(returndata);
        return data.mess;
    }
    #endregion
    #region phieu xuat
    // ham tao phiếu xuất từ cơ sở GPP
    //port: dia chi url (do ncc API cung cap):  https://duocquocgia.com.vn 
    //token: token lay duoc tu ham RESTfuldangnhap dung de xac thuc khi truyen, gui du lieu
    //pn: bien kieu class phieu_xuat(trong file RESTfulAPI.cs)
    // tra ve: Ma_phieu_xuat
    public string RESTful_tao_phieu_xuat(string port, string token, phieu_xuat px)
    {
        string url = port + "/api/lien_thong/phieu_xuat";
        RESTful rf = new RESTful();
        var serializer = new JavaScriptSerializer();
        string serializedResult = serializer.Serialize(px);
        string returndata = rf.PostURLtoken(url, token, serializedResult);
        var data = serializer.Deserialize<kq_phieu_xuat_return>(returndata);
        if (data != null && data.code == 200 && data.ma_phieu_xuat != "")
            return data.ma_phieu_xuat;
        else return "";
    }
    // ham cap nhat phiếu xuất từ cơ sở GPP
    //port: dia chi url (do ncc API cung cap):  https://duocquocgia.com.vn 
    //token: token lay duoc tu ham RESTfuldangnhap dung de xac thuc khi truyen, gui du lieu
    //pn: bien kieu class phieu_xuat(trong file RESTfulAPI.cs)
    // tra ve: Ma_phieu_xuat
    public string RESTful_cap_nhat_phieu_xuat(string port, string token, phieu_xuat px)
    {
        string url = port + "/api/lien_thong/phieu_xuat";
        RESTful rf = new RESTful();
        var serializer = new JavaScriptSerializer();
        string serializedResult = serializer.Serialize(px);
        string returndata = rf.PutURLtoken(url, token, serializedResult);
        var data = serializer.Deserialize<kq_phieu_xuat_return>(returndata);
        if (data != null && data.code == 200 && data.ma_phieu_xuat != "")
            return data.ma_phieu_xuat;
        else return "";
    }
    //ham xoa phiếu xuất từ cơ sở GPP
    //port: dia chi url (do ncc API cung cap):  https://duocquocgia.com.vn 
    //macoso: ma cua co so kham chua benh (01-000130)
    //maphieuxuat: Mã phiếu xuất cơ sở
    //token: token lay duoc tu ham RESTfuldangnhap dung de xac thuc khi truyen, gui du lieu
    // tra ve: chuoi thong bao tinh trang xoa
    public string RESTful_xoa_phieu_xuat(string port, string token, string macoso, string maphieu)
    {
        string url = port + "/api/lien_thong/phieu_xuat/" + macoso + "/" + maphieu;
        RESTful rf = new RESTful();
        var serializer = new JavaScriptSerializer();
        string returndata = rf.DeleteURLtoken(url, token);
        var data = serializer.Deserialize<kq_don_thuoc_return>(returndata);
        return data.mess;
    }
    #endregion
    #endregion
    private void GuiDonThuoc(HTC.Business.Duoc.PhieuXuat px)
    {
        try
        {
            string token = RESTfuldangnhap("https://duocquocgia.com.vn ", _tai_khoan, _password);
            thong_tin_don_vi ttdv = new thong_tin_don_vi();
            ttdv.ma_co_so_kcb = _ma_co_so;
            ttdv.ten_co_so_kcb = _ten_co_so;
            donthuoc dt = new donthuoc();
            thong_tin_benh_nhan ttbn = new thong_tin_benh_nhan();
            //ttbn.can_nang = 50;
            //ttbn.chieu_cao = 165;
            ttbn.dia_chi = txtDiaChi.Text + (!string.IsNullOrEmpty(cboPXa.Text) ? " - " + cboPXa.Text : "") + (!string.IsNullOrEmpty(cbohuyen.Text) ? " - " + cbohuyen.Text : "") + (!string.IsNullOrEmpty(cbotinh.Text) ? "- " + cbotinh.Text : "");
            ttbn.gioi_tinh = (_ThongtinBN.GT == true ? byte.Parse("1") : byte.Parse("2"));
            ttbn.ho_ten = txthoten.Text;
            ttbn.ma_benh_nhan = _ThongtinBN.MaBN;
            ttbn.tuoi = byte.Parse(txttuoi.Text == "" ? "0" : txttuoi.Text);
            thong_tin_benh ttbenh = new thong_tin_benh();
            if (_ThongtinBN.KhamBenh.KhamBenh_C_List.Count > 0)
            {
                ttbenh.ma_benh = _ThongtinBN.KhamBenh.KhamBenh_C_List[0].maicd;
                ttbenh.ten_benh = _ThongtinBN.KhamBenh.KhamBenh_C_List[0].tenbenh;
            }
            else
            {
                ttbenh.ma_benh = "Z00";
                ttbenh.ten_benh = "Khám tổng quát và kiểm tra sức khoẻ cho những người không có điều gì than phiền về sức khoẻ hoặc những người đã có chẩn đoán";
            }
            List<thong_tin_don_thuoc> ttdtlist = new List<thong_tin_don_thuoc>();

            foreach (KhamBenh_ThuocSD kb in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
            {
                thong_tin_don_thuoc ttdt1 = new thong_tin_don_thuoc();
                ttdt1.don_vi_tinh = kb.tendvt;
                ttdt1.duong_dung = kb.duongdung;
                ttdt1.ham_luong = kb.hamluong;
                ttdt1.lieu_dung = kb.CachDung;
                ttdt1.ma_thuoc = kb.matduong;
                ttdt1.so_dang_ky = kb.sovisa;
                ttdt1.so_luong = decimal.Parse(kb.SLMua == "" ? "0" : kb.SLMua);
                ttdt1.ten_thuoc = kb.TenTM;

                if (ttdt1.ma_thuoc != "")
                    if (ttdt1.ma_thuoc.Substring(0, 1) == "D")
                        ttdtlist.Add(ttdt1);
            }
            if (_ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Count == 0)
                dt.ma_don_thuoc_co_so_kcb = _ThongtinBN.KhamBenh.MaSoKham + "1";
            else
                dt.ma_don_thuoc_co_so_kcb = _ThongtinBN.KhamBenh.MaSoKham + (_ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Count + 1).ToString();
            dt.ngay_ke_don = DateTime.Now.Year.ToString("####") + DateTime.Now.ToString("dd/MM/yyyy HH:mm").Substring(3, 2) + DateTime.Now.ToString("dd/MM/yyyy HH:mm").Substring(0, 2) + DateTime.Now.ToString("dd/MM/yyyy HH:mm").Substring(11, 2) + DateTime.Now.ToString("dd/MM/yyyy HH:mm").Substring(14, 2);
            dt.nguoi_ke_don = Pub_sTenNguoiSD;

            dt.thong_tin_don_vi = ttdv;
            dt.thong_tin_benh_nhan = ttbn;
            dt.thong_tin_benh = ttbenh;
            dt.thong_tin_don_thuoc = ttdtlist;
            string hd = RESTful_tao_don_thuoc("https://duocquocgia.com.vn ", token, dt);
            GuiHoaDon(hd, px);
        }
        catch (Exception ex)
        {


            //throw;
        }
    }

    private string GuiHoaDon(string idhoadon, HTC.Business.Duoc.PhieuXuat px)
    {

        thong_tin_don_vi ttdv = new thong_tin_don_vi();
        ttdv.ma_co_so_kcb = _ma_co_soHD;
        ttdv.ten_co_so_kcb = _ten_co_soHD;
        hoa_don dt = new hoa_don();


        List<hoa_don_chi_tiet> ttdtlist = new List<hoa_don_chi_tiet>();

        foreach (KhamBenh_ThuocSD kb in _ThongtinBN.KhamBenh.KhamBenh_ThuocSDList)
        {
            hoa_don_chi_tiet ttdt1 = new hoa_don_chi_tiet();
            ttdt1.don_vi_tinh = kb.tendvt;
            ttdt1.duong_dung = kb.duongdung;
            ttdt1.ham_luong = kb.hamluong;
            ttdt1.lieu_dung = kb.CachDung;
            ttdt1.ma_thuoc = kb.matduong;
            ttdt1.so_dang_ky = kb.sovisa;
            ttdt1.so_luong = decimal.Parse(kb.SLMua == "" ? "0" : kb.SLMua);
            ttdt1.ten_thuoc = kb.TenTM;
            ttdt1.don_gia = decimal.Parse(kb.DongiaTT == "" ? "0" : kb.DongiaTT);
            ttdt1.thanh_tien = ttdt1.don_gia * ttdt1.so_luong;
            ttdt1.ty_le_quy_doi = 1;
            HTC.Business.Duoc.PhieuXuat_C c = px.PhieuXuatCs.FirstOrDefault(x => x.MaThuoc == kb.Mathuoc);
            if (c != null)
            {
                if (c.SoLo.Length > 15)
                    ttdt1.so_lo = c.SoLo.Substring(15);
                else
                    ttdt1.so_lo = c.SoLo;
                ttdt1.han_dung = c.HanSD.Substring(6, 4) + c.HanSD.Substring(3, 2) + c.HanSD.Substring(0, 2);
            };
            if (ttdt1.ma_thuoc != "")
                if (ttdt1.ma_thuoc.Substring(0, 1) == "D")
                    ttdtlist.Add(ttdt1);

        }
        dt.ngay_ban = DateTime.Now.Year.ToString("####") + DateTime.Now.ToString("dd/MM/yyyy HH:mm").Substring(3, 2) + DateTime.Now.ToString("dd/MM/yyyy HH:mm").Substring(0, 2);
        dt.ho_ten_nguoi_ban = Pub_sTenNguoiSD;

        dt.ma_co_so = ttdv.ma_co_so_kcb;
        dt.ma_don_thuoc_quoc_gia = idhoadon;
        dt.ho_ten_khach_hang = txthoten.Text;
        if (_ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Count == 0)
            dt.ma_hoa_don = _ThongtinBN.KhamBenh.MaSoKham + "1";
        else
            dt.ma_hoa_don = _ThongtinBN.KhamBenh.MaSoKham + (_ThongtinBN.KhamBenh.KhamBenh_HoaDonList.Count + 1).ToString();
        dt.hoa_don_chi_tiet = ttdtlist;
        return RESTful_tao_hoa_don("https://duocquocgia.com.vn ", "", dt);
    }
    private string SuaHoaDon()
    {

        string token = RESTfuldangnhap("https://duocquocgia.com.vn ", _tai_khoan, _password);
        thong_tin_don_vi ttdv = new thong_tin_don_vi();
        ttdv.ma_co_so_kcb = "mht";
        ttdv.ten_co_so_kcb = "ctyht";
        donthuoc dt = new donthuoc();
        thong_tin_benh_nhan ttbn = new thong_tin_benh_nhan();
        ttbn.can_nang = 50;
        ttbn.chieu_cao = 165;
        ttbn.dia_chi = "123abc";
        ttbn.gioi_tinh = 1;
        ttbn.ho_ten = "Nguyeenx van a";
        ttbn.ma_benh_nhan = "htbn01";
        ttbn.tuoi = 25;
        thong_tin_benh ttbenh = new thong_tin_benh();
        ttbenh.ma_benh = "mb1";
        ttbenh.ten_benh = "benh1";
        List<thong_tin_don_thuoc> ttdtlist = new List<thong_tin_don_thuoc>();
        thong_tin_don_thuoc ttdt1 = new thong_tin_don_thuoc();
        ttdt1.don_vi_tinh = "vien";
        ttdt1.duong_dung = "uong";
        ttdt1.ham_luong = "123 mg";
        ttdt1.lieu_dung = "1 lann ngay";
        ttdt1.ma_thuoc = "mt01";
        ttdt1.so_dang_ky = "sdk01";
        ttdt1.so_luong = 1;
        ttdt1.ten_thuoc = "tenthuoc1";
        thong_tin_don_thuoc ttdt2 = new thong_tin_don_thuoc();
        ttdt2.don_vi_tinh = "vien2";
        ttdt2.duong_dung = "uong2";
        ttdt2.ham_luong = "123 mg2";
        ttdt2.lieu_dung = "1 lann ngay2";
        ttdt2.ma_thuoc = "mt01";
        ttdt2.so_dang_ky = "sdk012";
        ttdt2.so_luong = 2;
        ttdt2.ten_thuoc = "tenthuoc2";
        ttdtlist.Add(ttdt1);
        ttdtlist.Add(ttdt2);
        dt.ma_don_thuoc_co_so_kcb = "mt01";
        dt.ngay_ke_don = "201903292030";
        dt.nguoi_ke_don = "nguoike1";
        dt.ngay_ke_don = "201903292030";
        dt.thong_tin_don_vi = ttdv;
        dt.thong_tin_benh_nhan = ttbn;
        dt.thong_tin_benh = ttbenh;
        dt.thong_tin_don_thuoc = ttdtlist;
        return RESTful_cap_nhat_don_thuoc("https://duocquocgia.com.vn ", token, dt);
    }
    private void XoaHoaDon(string Ma_don_thuoc)
    {

        string token = RESTfuldangnhap("https://duocquocgia.com.vn ", _tai_khoan, _password);
        //Ma_co_so la truong Ma_co_so_kcb trong thong_tin_don_vi cua don thuoc


        RESTful_xoa_don_thuoc("https://duocquocgia.com.vn ", token, _tai_khoan, _password);

    }






    [Serializable()]
    public partial class ThongtinBN : BusinessBase<ThongtinBN>
    {
        #region Business Methods

        #region State Fields
        private SmartDate _giaTriTN = new SmartDate(true);
        private String _maBN = String.Empty;
        private String _hoten = String.Empty;
        private String _sothe = String.Empty;
        private String _maBV = String.Empty;
        private SmartDate _giaTriDN = new SmartDate(true);
        private String _maDT = String.Empty;
        private String _diaChi = String.Empty;
        private String _diaChiC = String.Empty;
        private String _dienThoai = String.Empty;
        private String _DTDD = String.Empty;
        private String _DTCQ = String.Empty;
        private String _RHD = String.Empty;
        private String _MaBAGD = String.Empty;
        private String _mail = String.Empty;
        private Byte _tuoi = 1;
        private int _thang = 1;
        private SmartDate _ngaySinh = new SmartDate(true);
        private SmartDate _ngaySinhD = new SmartDate(true);
        private SmartDate _ngayyc = new SmartDate(true);
        private Boolean _gt = false;
        private String _gtD = "Nữ";
        private Boolean _gtNu = false;
        private String _baoTin = String.Empty;
        private String _maQG = String.Empty;
        private String _maTinh = String.Empty;
        private String _maHuyen = String.Empty;
        private String _maPXa = String.Empty;
        private String _maNN = String.Empty;
        private String _tienSu = String.Empty;
        private String _tienSuThuoc = String.Empty;
        private String _tienSuGiaDinh = String.Empty;
        private String _nhomMau = String.Empty;
        private String _maBANoiT = String.Empty;
        private String _maKhoaVV = String.Empty;
        private SmartDate _ngayVV = new SmartDate(true);
        private String _maBANgoaiT = String.Empty;
        private SmartDate _ngayKham = new SmartDate(true);
        private String _ghichu = String.Empty;
        private String _maMay = String.Empty;
        private SmartDate _ngayLap = new SmartDate(true);
        private String _nguoiLap = String.Empty;
        private SmartDate _ngayHuy = new SmartDate(true);
        private String _nguoiHuy = String.Empty;
        private SmartDate _ngaySD = new SmartDate(true);
        private String _nguoiSD = String.Empty;
        private SmartDate _ngaySD1 = new SmartDate(true);
        private String _nguoiSD1 = String.Empty;
        private Boolean _huy = false;
        private SmartDate _ngayBANgoaiT = new SmartDate(true);
        private String _madantoc = String.Empty;
        private String _hotenbome = String.Empty;
        //private String _hotencha = String.Empty;
        //private String _Lansinh = String.Empty;
        //private String _MaBHXHCha = String.Empty;
        private String _MaBHXHMe = String.Empty;
        private String _Nguoidode = String.Empty;
        private String _Tinhtrangcon = String.Empty;
        private int _OrderNumber;
        private SmartDate _NgayDK = new SmartDate(true);
        private String _mabhxh = String.Empty;
        private String _tenbv = String.Empty;
        private String _maBAQL = String.Empty;
        private String _TenDT = String.Empty;
        private String _MaQuanHeQD = String.Empty;
        private String _MaQuanHam = String.Empty;
        private String _ngayDu5Nam = String.Empty;
        private String _maKV = String.Empty;
        private String _ngayMienCCT = String.Empty;
        private String _MaDonVi = String.Empty;
        private String _SoCMT = String.Empty;
        private String _MaNhomDV1 = String.Empty;
        private String _MaNhomDV2 = String.Empty;
        private String _tenQH = String.Empty;
        private String _tenPXa = String.Empty;
        private String _tenTinh = String.Empty;
        private String _tenQG = String.Empty;
        private String _tenNN = String.Empty;
        private string _noiLamViec = String.Empty;
        #endregion

        #region Business Properties and Methods
        public string NoiLamViec
        {
            get
            {
                CanReadProperty(true);
                return _noiLamViec;
            }
            set
            {
                CanReadProperty("NoiLamViec", true);
                if (!_noiLamViec.Equals(value))
                {
                    _noiLamViec = value;
                    PropertyHasChanged("NoiLamViec");
                }
            }
        }
        public String MaQuanHam
        {
            get
            {
                CanReadProperty("MaQuanHam", true);
                return _MaQuanHam;
            }
            set
            {
                CanWriteProperty("MaQuanHam", true);
                if (_MaQuanHam != value)
                {
                    _MaQuanHam = value;
                    PropertyHasChanged("MaQuanHam");
                }
            }
        }
        public string MaKV
        {
            get
            {
                CanReadProperty(true);
                return _maKV;
            }
            set
            {
                CanReadProperty("MaKV", true);
                if (!_maKV.Equals(value))
                {
                    _maKV = value;
                    PropertyHasChanged("MaKV");
                }
            }
        }
        public string NgayMienCCT
        {
            get
            {
                CanReadProperty(true);
                return _ngayMienCCT;
            }
            set
            {
                CanReadProperty("NgayMienCCT", true);
                if (!_ngayMienCCT.Equals(value))
                {
                    _ngayMienCCT = value;
                    PropertyHasChanged("NgayMienCCT");
                }
            }
        }
        public String ngayDu5Nam
        {
            get
            {
                CanReadProperty("ngayDu5Nam", true);
                return _ngayDu5Nam;
            }
            set
            {
                CanWriteProperty("ngayDu5Nam", true);
                if (_ngayDu5Nam != value)
                {
                    _ngayDu5Nam = value;
                    PropertyHasChanged("ngayDu5Nam");
                }
            }
        }
        public string TenTinh
        {
            get
            {
                CanReadProperty(true);
                return _tenTinh;
            }
            set
            {
                //CanWriteProperty(true);
                if (!_tenTinh.Equals(value))
                {
                    _tenTinh = value;
                    //PropertyHasChanged();
                }
            }
        }
        public String TenQG
        {
            get
            {
                CanReadProperty("TenQG", true);
                return _tenQG;
            }
            set
            {
                CanWriteProperty("TenQG", true);
                if (_tenQG != value)
                {
                    _tenQG = value;
                    PropertyHasChanged("TenQG");
                }
            }
        }
        public String TenQH
        {
            get
            {
                CanReadProperty("TenQH", true);
                return _tenQH;
            }
            set
            {
                CanWriteProperty("TenQH", true);
                if (_tenQH != value)
                {
                    _tenQH = value;
                    PropertyHasChanged("TenQH");
                }
            }
        }
        public String TenPXa
        {
            get
            {
                CanReadProperty("TenPXa", true);
                return _tenPXa;
            }
            set
            {
                CanWriteProperty("TenPXa", true);
                if (_tenPXa != value)
                {
                    _tenPXa = value;
                    PropertyHasChanged("TenPXa");
                }
            }
        }
        public String TenNN
        {
            get
            {
                CanReadProperty("TenNN", true);
                return _tenNN;
            }
            set
            {
                CanWriteProperty("TenNN", true);
                if (_tenNN != value)
                {
                    _tenNN = value;
                    PropertyHasChanged("TenNN");
                }
            }
        }

        public String MaNhomDV1
        {
            get
            {
                CanReadProperty("MaNhomDV1", true);
                return _MaNhomDV1;
            }
            set
            {
                CanWriteProperty("MaNhomDV1", true);
                if (_MaNhomDV1 != value)
                {
                    _MaNhomDV1 = value;
                    PropertyHasChanged("MaNhomDV1");
                }
            }
        }
        public String MaNhomDV2
        {
            get
            {
                CanReadProperty("MaNhomDV2", true);
                return _MaNhomDV2;
            }
            set
            {
                CanWriteProperty("MaNhomDV2", true);
                if (_MaNhomDV2 != value)
                {
                    _MaNhomDV2 = value;
                    PropertyHasChanged("MaNhomDV2");
                }
            }
        }
        public String MaQuanHeQD
        {
            get
            {
                CanReadProperty("MaQuanHeQD", true);
                return _MaQuanHeQD;
            }
            set
            {
                CanWriteProperty("MaQuanHeQD", true);
                if (_MaQuanHeQD != value)
                {
                    _MaQuanHeQD = value;
                    PropertyHasChanged("MaQuanHeQD");
                }
            }
        }

        public String MaDonVi
        {
            get
            {
                CanReadProperty("MaDonVi", true);
                return _MaDonVi;
            }
            set
            {
                CanWriteProperty("MaDonVi", true);
                if (_MaDonVi != value)
                {
                    _MaDonVi = value;
                    PropertyHasChanged("MaDonVi");
                }
            }
        }
        public String SoCMT
        {
            get
            {
                CanReadProperty("SoCMT", true);
                return _SoCMT;
            }
            set
            {
                CanWriteProperty("SoCMT", true);
                if (_SoCMT != value)
                {
                    _SoCMT = value;
                    PropertyHasChanged("SoCMT");
                }
            }
        }
        public String MaBAQL
        {
            get
            {
                CanReadProperty("MaBAQL", true);
                return _maBAQL;
            }
            set
            {
                CanWriteProperty("MaBAQL", true);
                if (_maBAQL != value)
                {
                    _maBAQL = value;
                    PropertyHasChanged("MaBAQL");
                }
            }
        }
        public string GiaTriTN
        {
            get
            {
                CanReadProperty("GiaTriTN", true);
                return _giaTriTN.Text;
            }
            set
            {
                CanWriteProperty("GiaTriTN", true);
                if (_giaTriTN.Text != value)
                {
                    _giaTriTN.Text = value;
                    PropertyHasChanged("GiaTriTN");
                }
            }
        }
        public String mabhxh
        {
            get
            {
                CanReadProperty("mabhxh", true);
                return _mabhxh;
            }
            set
            {
                CanWriteProperty("mabhxh", true);
                if (_mabhxh != value)
                {
                    _mabhxh = value;
                    PropertyHasChanged("mabhxh");
                }
            }
        }
        public String gtD
        {
            get
            {
                CanReadProperty("gtD", true);
                if (_gt == true)
                    return "Nam";
                else
                    return "Nữ";

            }

        }
        public String hotenbome
        {
            get
            {
                CanReadProperty("hotenbome", true);
                return _hotenbome;
            }
            set
            {
                CanWriteProperty("hotenbome", true);
                if (_hotenbome != value)
                {
                    _hotenbome = value;
                    PropertyHasChanged("hotenbome");
                }
            }
        }
        //public String Hotencha
        //{
        //    get
        //    {
        //        CanReadProperty("Hotencha", true);
        //        return _hotencha;
        //    }
        //    set
        //    {
        //        CanWriteProperty("Hotencha", true);
        //        if (_hotencha != value)
        //        {
        //            _hotencha = value;
        //            PropertyHasChanged("Hotencha");
        //        }
        //    }
        //}
        public String madantoc
        {
            get
            {
                CanReadProperty("madantoc", true);
                return _madantoc;
            }
            set
            {
                CanWriteProperty("madantoc", true);
                if (_madantoc != value)
                {
                    _madantoc = value;
                    PropertyHasChanged("madantoc");
                }
            }
        }
        public String tenbv
        {
            get
            {
                CanReadProperty("tenbv", true);
                return _tenbv;
            }
            set
            {
                CanWriteProperty("tenbv", true);
                if (_tenbv != value)
                {
                    _tenbv = value;
                    PropertyHasChanged("tenbv");
                }
            }
        }
        public String Sothe
        {
            get
            {
                CanReadProperty("Sothe", true);
                return _sothe;
            }
            set
            {
                CanWriteProperty("Sothe", true);
                if (_sothe != value)
                {
                    _sothe = value;
                    PropertyHasChanged("Sothe");
                }
            }
        }
        public String MaDT
        {
            get
            {
                CanReadProperty("MaDT", true);
                return _maDT;
            }
            set
            {
                CanWriteProperty("MaDT", true);
                if (_maDT != value)
                {
                    _maDT = value;
                    PropertyHasChanged("MaDT");
                }
            }
        }
        public String TenDT
        {
            get
            {
                CanReadProperty("TenDT", true);
                return _TenDT;
            }
            set
            {
                CanWriteProperty("TenDT", true);
                if (_TenDT != value)
                {
                    _TenDT = value;
                    PropertyHasChanged("TenDT");
                }
            }
        }
        public String MaBN
        {
            get
            {
                CanReadProperty("MaBN", true);
                return _maBN;
            }
            set
            {
                CanWriteProperty("MaBN", true);
                if (_maBN != value)
                {
                    _maBN = value;
                    PropertyHasChanged("MaBN");
                }
            }
        }

        public String Hoten
        {
            get
            {
                CanReadProperty("Hoten", true);
                return _hoten.ToUpper();
            }
            set
            {
                CanWriteProperty("Hoten", true);
                if (_hoten != value)
                {
                    _hoten = value;
                    PropertyHasChanged("Hoten");
                }
            }
        }
        //public String Lansinh
        //{
        //    get
        //    {
        //        CanReadProperty("Lansinh", true);
        //        return _Lansinh.ToUpper();
        //    }
        //    set
        //    {
        //        CanWriteProperty("Lansinh", true);
        //        if (_Lansinh != value)
        //        {
        //            _Lansinh = value;
        //            PropertyHasChanged("Lansinh");
        //        }
        //    }
        //}
        //public String MaBHXHCha
        //{
        //    get
        //    {
        //        CanReadProperty("Lansinh", true);
        //        return _MaBHXHCha.ToUpper();
        //    }
        //    set
        //    {
        //        CanWriteProperty("Lansinh", true);
        //        if (_MaBHXHCha != value)
        //        {
        //            _MaBHXHCha = value;
        //            PropertyHasChanged("Lansinh");
        //        }
        //    }
        //}
        //public String MaBHXHMe
        //{
        //    get
        //    {
        //        CanReadProperty("MaBHXHMe", true);
        //        return _MaBHXHMe.ToUpper();
        //    }
        //    set
        //    {
        //        CanWriteProperty("MaBHXHMe", true);
        //        if (_MaBHXHMe != value)
        //        {
        //            _MaBHXHMe = value;
        //            PropertyHasChanged("MaBHXHMe");
        //        }
        //    }
        //}
        public String Tinhtrangcon
        {
            get
            {
                CanReadProperty("Lansinh", true);
                return _Tinhtrangcon.ToUpper();
            }
            set
            {
                CanWriteProperty("Lansinh", true);
                if (_Tinhtrangcon != value)
                {
                    _Tinhtrangcon = value;
                    PropertyHasChanged("Lansinh");
                }
            }
        }
        public String Nguoidode
        {
            get
            {
                CanReadProperty("Nguoidode", true);
                return _Nguoidode.ToUpper();
            }
            set
            {
                CanWriteProperty("Nguoidode", true);
                if (_Nguoidode != value)
                {
                    _Nguoidode = value;
                    PropertyHasChanged("Nguoidode");
                }
            }
        }

        //public String Sothe
        //{
        //    get 
        //    {
        //        CanReadProperty("Sothe", true);
        //        return _sothe;
        //    }
        //    set 
        //    {
        //        CanWriteProperty("Sothe", true);
        //        if (_sothe != value) 
        //        {
        //            _sothe = value;
        //            PropertyHasChanged("Sothe");
        //        }
        //    }
        //}

        public String MaBV
        {
            get
            {
                CanReadProperty("MaBV", true);
                return _maBV;
            }
            set
            {
                CanWriteProperty("MaBV", true);
                if (_maBV != value)
                {
                    _maBV = value;
                    PropertyHasChanged("MaBV");
                }
            }
        }

        public string GiaTriDN
        {
            get
            {
                CanReadProperty("GiaTriDN", true);
                return _giaTriDN.Text;
            }
            set
            {
                CanWriteProperty("GiaTriDN", true);
                if (_giaTriDN.Text != value)
                {
                    _giaTriDN.Text = value;
                    PropertyHasChanged("GiaTriDN");
                }
            }
        }

        public String DiaChi
        {
            get
            {
                CanReadProperty("DiaChi", true);

                return _diaChi;
            }
            set
            {
                CanWriteProperty("DiaChi", true);
                if (_diaChi != value)
                {
                    _diaChi = value;
                    PropertyHasChanged("DiaChi");
                }
            }
        }
        public String DiaChiC
        {
            get
            {
                CanReadProperty("DiaChiC", true);

                return _diaChiC;
            }
            set
            {
                CanWriteProperty("DiaChiC", true);
                if (_diaChiC != value)
                {
                    _diaChiC = value;
                    PropertyHasChanged("DiaChiC");
                }
            }
        }

        public String DienThoai
        {
            get
            {
                CanReadProperty("DienThoai", true);
                return _dienThoai;
            }
            set
            {
                CanWriteProperty("DienThoai", true);
                if (_dienThoai != value)
                {
                    _dienThoai = value;
                    PropertyHasChanged("DienThoai");
                }
            }
        }
        public String DTCQ
        {
            get
            {
                CanReadProperty("DTCQ", true);
                return _DTCQ;
            }
            set
            {
                CanWriteProperty("DTCQ", true);
                if (_DTCQ != value)
                {
                    _DTCQ = value;
                    PropertyHasChanged("DTCQ");
                }
            }
        }
        public String DTDD
        {
            get
            {
                CanReadProperty("DTDD", true);
                return _DTDD;
            }
            set
            {
                CanWriteProperty("DTDD", true);
                if (_DTDD != value)
                {
                    _DTDD = value;
                    PropertyHasChanged("DTDD");
                }
            }
        }

        public String RHD
        {
            get
            {
                CanReadProperty("RHD", true);
                return _RHD;
            }
            set
            {
                CanWriteProperty("RHD", true);
                if (_RHD != value)
                {
                    _RHD = value;
                    PropertyHasChanged("RHD");
                }
            }
        }

        public String MaBAGD
        {
            get
            {
                CanReadProperty("MaBAGD", true);
                return _MaBAGD;
            }
            set
            {
                CanWriteProperty("MaBAGD", true);
                if (_MaBAGD != value)
                {
                    _MaBAGD = value;
                    PropertyHasChanged("MaBAGD");
                }
            }
        }

        public String Mail
        {
            get
            {
                CanReadProperty("Mail", true);
                return _mail;
            }
            set
            {
                CanWriteProperty("Mail", true);
                if (_mail != value)
                {
                    _mail = value;
                    PropertyHasChanged("Mail");
                }
            }
        }

        public byte Tuoi
        {
            get
            {

                //CanReadProperty("Tuoi", true);
                if (_ngaySinh.Date != DateTime.MinValue)
                    if (_ngaySinh.Date.Year != 0)
                        _tuoi = Convert.ToByte(Convert.ToInt32(DateTime.Now.Year) - _ngaySinh.Date.Year);
                return _tuoi;
            }
            set
            {
                CanWriteProperty("Tuoi", true);
                if (_tuoi != value)
                {
                    _tuoi = value;
                    PropertyHasChanged("Tuoi");
                }
            }
        }
        public int thang
        {
            get
            {

                //CanReadProperty("thang", true);
                if (Convert.ToInt32(DateTime.Now.Month - _ngaySinh.Date.Month) < 0)
                    _thang = Convert.ToInt32(DateTime.Now.Month - _ngaySinh.Date.Month + 13);
                else
                    _thang = Convert.ToInt32(DateTime.Now.Month - _ngaySinh.Date.Month + 1);
                return _thang;
            }
            set
            {
                CanWriteProperty("thang", true);
                if (_thang != value)
                {
                    _thang = value;
                    PropertyHasChanged("thang");
                }
            }
        }
        public string NgaySinh
        {
            get
            {
                CanReadProperty("NgaySinh", true);
                //_ngaySinh.FormatString = "MM/dd/yyyy"; 
                return _ngaySinh.Text;
            }
            set
            {
                CanWriteProperty("NgaySinh", true);
                if (_ngaySinh.Text != value)
                {
                    _ngaySinh.Text = value;
                    if (_ngaySinh.Date.Year != 1)
                        _tuoi = Convert.ToByte(Convert.ToInt32(DateTime.Now.Year) - _ngaySinh.Date.Year);
                    PropertyHasChanged("NgaySinh");
                }
            }
        }
        public string NgaySinhD
        {
            get
            {
                CanReadProperty("NgaySinh", true);
                _ngaySinhD = _ngaySinh;
                _ngaySinhD.FormatString = "dd/MM/yyyy";
                return _ngaySinh.Text;
            }

        }
        public Boolean GT
        {
            get
            {
                CanReadProperty("GT", true);
                return _gt;
            }
            set
            {
                CanWriteProperty("GT", true);
                if (_gt != value)
                {
                    _gt = value;
                    PropertyHasChanged("GT");
                }
            }
        }
        public Boolean GTNu
        {
            get
            {
                CanReadProperty("GTNu", true);
                if (_gt == true)
                    return false;
                else
                    return true;
            }
            set
            {
                CanWriteProperty("GTNu", true);
                if (_gtNu != value)
                {
                    if (value == true)
                        _gt = false;
                    else
                        _gt = true;
                    _gtNu = value;

                    PropertyHasChanged("GTnu");
                }

            }
        }
        public String BaoTin
        {
            get
            {
                CanReadProperty("BaoTin", true);
                return _baoTin;
            }
            set
            {
                CanWriteProperty("BaoTin", true);
                if (_baoTin != value)
                {
                    _baoTin = value;
                    PropertyHasChanged("BaoTin");
                }
            }
        }

        public String MaQG
        {
            get
            {
                CanReadProperty("MaQG", true);
                return _maQG;
            }
            set
            {
                CanWriteProperty("MaQG", true);
                if (_maQG != value)
                {
                    _maQG = value;
                    PropertyHasChanged("MaQG");
                }
            }
        }

        public String MaTinh
        {
            get
            {
                CanReadProperty("MaTinh", true);
                return _maTinh;
            }
            set
            {
                CanWriteProperty("MaTinh", true);
                if (_maTinh != value)
                {
                    _maTinh = value;
                    PropertyHasChanged("MaTinh");
                }
            }
        }

        public String MaHuyen
        {
            get
            {
                CanReadProperty("MaHuyen", true);
                return _maHuyen;
            }
            set
            {
                CanWriteProperty("MaHuyen", true);
                if (_maHuyen != value)
                {
                    _maHuyen = value;
                    PropertyHasChanged("MaHuyen");
                }
            }
        }
        public String MaPXa
        {
            get
            {
                CanReadProperty("MaPXa", true);
                return _maPXa;
            }
            set
            {
                CanWriteProperty("MaPXa", true);
                if (_maPXa != value)
                {
                    _maPXa = value;
                    PropertyHasChanged("MaPXa");
                }
            }
        }

        public String MaNN
        {
            get
            {
                CanReadProperty("MaNN", true);
                return _maNN;
            }
            set
            {
                CanWriteProperty("MaNN", true);
                if (_maNN != value)
                {
                    _maNN = value;
                    PropertyHasChanged("MaNN");
                }
            }
        }

        public String TienSu
        {
            get
            {
                CanReadProperty("TienSu", true);
                return _tienSu;
            }
            set
            {
                CanWriteProperty("TienSu", true);
                if (_tienSu != value)
                {
                    _tienSu = value;
                    PropertyHasChanged("TienSu");
                }
            }
        }

        public String TienSuThuoc
        {
            get
            {
                CanReadProperty("TienSuThuoc", true);
                return _tienSuThuoc;
            }
            set
            {
                CanWriteProperty("TienSuThuoc", true);
                if (_tienSuThuoc != value)
                {
                    _tienSuThuoc = value;
                    PropertyHasChanged("TienSuThuoc");
                }
            }
        }

        public String TienSuGiaDinh
        {
            get
            {
                CanReadProperty("TienSuGiaDinh", true);
                return _tienSuGiaDinh;
            }
            set
            {
                CanWriteProperty("TienSuGiaDinh", true);
                if (_tienSuGiaDinh != value)
                {
                    _tienSuGiaDinh = value;
                    PropertyHasChanged("TienSuGiaDinh");
                }
            }
        }

        public String NhomMau
        {
            get
            {
                CanReadProperty("NhomMau", true);
                return _nhomMau;
            }
            set
            {
                CanWriteProperty("NhomMau", true);
                if (_nhomMau != value)
                {
                    _nhomMau = value;
                    PropertyHasChanged("NhomMau");
                }
            }
        }

        public String MaBANoiT
        {
            get
            {
                CanReadProperty("MaBANoiT", true);
                return _maBANoiT;
            }
            set
            {
                CanWriteProperty("MaBANoiT", true);
                if (_maBANoiT != value)
                {
                    _maBANoiT = value;
                    PropertyHasChanged("MaBANoiT");
                }
            }
        }

        public String MaKhoaVV
        {
            get
            {
                CanReadProperty("MaKhoaVV", true);
                return _maKhoaVV;
            }
            set
            {
                CanWriteProperty("MaKhoaVV", true);
                if (_maKhoaVV != value)
                {
                    _maKhoaVV = value;
                    PropertyHasChanged("MaKhoaVV");
                }
            }
        }

        public string NgayVV
        {
            get
            {
                CanReadProperty("NgayVV", true);
                return _ngayVV.Text;
            }
            set
            {
                CanWriteProperty("NgayVV", true);
                if (_ngayVV.Text != value)
                {
                    _ngayVV.Text = value;
                    PropertyHasChanged("NgayVV");
                }
            }
        }

        public String MaBANgoaiT
        {
            get
            {
                CanReadProperty("MaBANgoaiT", true);
                return _maBANgoaiT;
            }
            set
            {
                CanWriteProperty("MaBANgoaiT", true);
                if (_maBANgoaiT != value)
                {
                    _maBANgoaiT = value;
                    PropertyHasChanged("MaBANgoaiT");
                }
            }
        }

        public string NgayKham
        {
            get
            {
                CanReadProperty("NgayKham", true);
                _ngayKham.FormatString = "dd/MM/yyyy";
                return _ngayKham.Text;
            }
            set
            {
                CanWriteProperty("NgayKham", true);
                if (_ngayKham.Text != value)
                {
                    _ngayKham.FormatString = "dd/MM/yyyy";
                    _ngayKham.Text = value;
                    PropertyHasChanged("NgayKham");
                }
            }
        }
        public string NgayDK
        {
            get
            {
                CanReadProperty("NgayDK", true);
                _NgayDK.FormatString = "dd/MM/yyyy";
                return _NgayDK.Text;
            }
            set
            {
                CanWriteProperty("NgayDK", true);
                if (_NgayDK.Text != value)
                {
                    _NgayDK.FormatString = "dd/MM/yyyy";
                    _NgayDK.Text = value;
                    PropertyHasChanged("NgayDK");
                }
            }
        }
        public String Ghichu
        {
            get
            {
                CanReadProperty("Ghichu", true);
                return _ghichu;
            }
            set
            {
                CanWriteProperty("Ghichu", true);
                if (_ghichu != value)
                {
                    _ghichu = value;
                    PropertyHasChanged("Ghichu");
                }
            }
        }

        public String MaMay
        {
            get
            {
                CanReadProperty("MaMay", true);
                return _maMay;
            }
            set
            {
                CanWriteProperty("MaMay", true);
                if (_maMay != value)
                {
                    _maMay = value;
                    PropertyHasChanged("MaMay");
                }
            }
        }

        public string NgayLap
        {
            get
            {
                CanReadProperty("NgayLap", true);
                return _ngayLap.Text;
            }
            set
            {
                CanWriteProperty("NgayLap", true);
                if (_ngayLap.Text != value)
                {
                    _ngayLap.Text = value;
                    PropertyHasChanged("NgayLap");
                }
            }
        }

        public String NguoiLap
        {
            get
            {
                CanReadProperty("NguoiLap", true);
                return _nguoiLap;
            }
            set
            {
                CanWriteProperty("NguoiLap", true);
                if (_nguoiLap != value)
                {
                    _nguoiLap = value;
                    PropertyHasChanged("NguoiLap");
                }
            }
        }

        //public string NgayHuy
        //{
        //    get 
        //    {
        //        CanReadProperty("NgayHuy", true);
        //        return _ngayHuy.Text;
        //    }
        //    set 
        //    {
        //        CanWriteProperty("NgayHuy", true);
        //        if (_ngayHuy.Text != value) 
        //        {
        //            _ngayHuy.Text = value;
        //            PropertyHasChanged("NgayHuy");
        //        }
        //    }
        //}

        //public String NguoiHuy
        //{
        //    get 
        //    {
        //        CanReadProperty("NguoiHuy", true);
        //        return _nguoiHuy;
        //    }
        //    set 
        //    {
        //        CanWriteProperty("NguoiHuy", true);
        //        if (_nguoiHuy != value) 
        //        {
        //            _nguoiHuy = value;
        //            PropertyHasChanged("NguoiHuy");
        //        }
        //    }
        //}

        public string NgaySD
        {
            get
            {
                CanReadProperty("NgaySD", true);
                return _ngaySD.Text;
            }
            set
            {
                CanWriteProperty("NgaySD", true);
                if (_ngaySD.Text != value)
                {
                    _ngaySD.Text = value;
                    PropertyHasChanged("NgaySD");
                }
            }
        }

        public String NguoiSD
        {
            get
            {
                CanReadProperty("NguoiSD", true);
                return _nguoiSD;
            }
            set
            {
                CanWriteProperty("NguoiSD", true);
                if (_nguoiSD != value)
                {
                    _nguoiSD = value;
                    PropertyHasChanged("NguoiSD");
                }
            }
        }

        //public string NgaySD1
        //{
        //    get 
        //    {
        //        CanReadProperty("NgaySD1", true);
        //        return _ngaySD1.Text;
        //    }
        //    set 
        //    {
        //        CanWriteProperty("NgaySD1", true);
        //        if (_ngaySD1.Text != value) 
        //        {
        //            _ngaySD1.Text = value;
        //            PropertyHasChanged("NgaySD1");
        //        }
        //    }
        //}

        //public String NguoiSD1
        //{
        //    get 
        //    {
        //        CanReadProperty("NguoiSD1", true);
        //        return _nguoiSD1;
        //    }
        //    set 
        //    {
        //        CanWriteProperty("NguoiSD1", true);
        //        if (_nguoiSD1 != value) 
        //        {
        //            _nguoiSD1 = value;
        //            PropertyHasChanged("NguoiSD1");
        //        }
        //    }
        //}

        public Boolean Huy
        {
            get
            {
                CanReadProperty("Huy", true);
                return _huy;
            }
            set
            {
                CanWriteProperty("Huy", true);
                if (_huy != value)
                {
                    _huy = value;
                    PropertyHasChanged("Huy");
                }
            }
        }

        //public string NgayBANgoaiT
        //{
        //    get 
        //    {
        //        CanReadProperty("NgayBANgoaiT", true);
        //        return _ngayBANgoaiT.Text;
        //    }
        //    set 
        //    {
        //        CanWriteProperty("NgayBANgoaiT", true);
        //        if (_ngayBANgoaiT.Text != value) 
        //        {
        //            _ngayBANgoaiT.Text = value;
        //            PropertyHasChanged("NgayBANgoaiT");
        //        }
        //    }
        //}

        public int OrderNumber
        {
            [System.Runtime.CompilerServices.MethodImpl(System.Runtime.CompilerServices.MethodImplOptions.NoInlining)]
            get
            {
                CanReadProperty(true);
                return _OrderNumber;
            }
            [System.Runtime.CompilerServices.MethodImpl(System.Runtime.CompilerServices.MethodImplOptions.NoInlining)]
            set
            {
                //CanWriteProperty(true);
                if (!_OrderNumber.Equals(value))
                {
                    _OrderNumber = value;
                    //PropertyHasChanged();
                }
            }
        }
        private KhamBenh _KhamBenh = KhamBenh.NewKhamBenh();

        public KhamBenh KhamBenh
        {
            [System.Runtime.CompilerServices.MethodImpl(System.Runtime.CompilerServices.MethodImplOptions.NoInlining)]
            get
            {
                //CanReadProperty(true);
                return _KhamBenh;
            }
            [System.Runtime.CompilerServices.MethodImpl(System.Runtime.CompilerServices.MethodImplOptions.NoInlining)]
            set
            {
                //CanWriteProperty(true);
                if (!_KhamBenh.Equals(value))
                {
                    _KhamBenh = value;
                    PropertyHasChanged();
                }
            }
        }
        protected override Object GetIdValue()
        {
            return _maBN;
        }
        public override bool IsDirty
        {
            get
            {
                return base.IsDirty;
            }
        }

        public override bool IsValid
        {
            get
            {
                return base.IsValid;
            }
        }
        #endregion
        #endregion


        #region Business Object Rules and Validation
        protected override void AddBusinessRules()
        {
            //TODO: add validation rules

            ValidationRules.AddRule<ThongtinBN>(ValidationNgaySinh<ThongtinBN>, "NgaySinh");

        }
        private static bool ValidationNgaySinh<T>(T target, Csla.Validation.RuleArgs e) where T : ThongtinBN
        {
            if (target._ngaySinh.Date > System.DateTime.Now.AddDays(1))
            {
                e.Description = "VALIDATION_NOW";
                return false;
            }
            else
                return true;
        }

        #endregion


        #region Factory Methods


        /// <summary>
        /// Factory method. New <see cref="ThongtinBN" /> Object is loaded from the database, based on given parameters.
        /// </summary> 
        /// 
        public static ThongtinBN NewThongtinBN()
        {
            //return new DMNhomThuoc();

            return DataPortal.Create<ThongtinBN>();
        }
        public static ThongtinBN GetThongtinBN(String maBN, DateTime ngaydk, Byte loai)
        {
            return DataPortal.Fetch<ThongtinBN>(new Criteria(maBN, ngaydk, loai));
        }
        public static ThongtinBN GetThongtinBN(String maBN, DateTime ngaydk, Byte loai, string noitt)
        {
            return DataPortal.Fetch<ThongtinBN>(new CriteriaTT(maBN, ngaydk, loai, noitt));
        }
        public static ThongtinBN GetThongtinBN(String maBN, Byte loai)
        {
            return DataPortal.Fetch<ThongtinBN>(new OtherCriteria("", "", maBN, loai));
        }
        public static ThongtinBN GetThongtinBN(String maBN, DateTime ngaydk, Byte loai, string masokham, int stt, byte loaikqcn, byte loaikq, string makhoa)
        {
            return DataPortal.Fetch<ThongtinBN>(new CriteriaKB(maBN, ngaydk, loai, masokham, stt, loaikqcn, loaikq, makhoa));
        }
        public static ThongtinBN GetThongtinBN(String maBN, DateTime ngaydk, Byte loai, string masokham, int stt, byte loaikqcn)
        {
            return DataPortal.Fetch<ThongtinBN>(new CriteriaKB(maBN, ngaydk, loai, masokham, stt, loaikqcn, 0, ""));
        }
        /// <summary>
        /// Marks the <see cref="ThongtinBN" /> Object for deletion. The Object will be deleted as part of the next save operation.
        /// </summary>
        public static void DeleteThongtinBN(String maBN, string mamay, string nguoihuy)
        {
            DataPortal.Delete(new OtherCriteria(mamay, nguoihuy, maBN, 0));
        }

        #endregion

        #region Constructors
        // Chu y !!!
        // Neu mot doi tuong Collection sao do muon su dung CBO.FillCollection cho doi tuong nay
        // thi khai bao ham khoi tao duoi day voi tu khoa public !!!
        protected internal ThongtinBN()
        {
            // MarkAsChild();

            _maDT = "00001";
            _madantoc = "00025";
            _MaNhomDV1 = "";
            _MaNhomDV2 = "";
            _gt = true;
            //MarkOld();

        }

        internal ThongtinBN(int OrderNumber,
  String maBN,
  String hoten,
  String sothe,
  String maBV,
  SmartDate giaTriDN,
  String diaChi,
            String diaChiC,
  String dienThoai,
  String RHD,
  String MaBAGD,
  String mail,
  Byte tuoi,
  SmartDate ngaySinh,
  Boolean gt,
  String baoTin,
  String maQG,
  String maTinh,
  String maHuyen,
              String maPXa,
  String maNN,
  String tienSu,
  String tienSuThuoc,
  String tienSuGiaDinh,
  String nhomMau,
  String maBANoiT,
  String maKhoaVV,
  SmartDate ngayVV,
  String maBANgoaiT,
  SmartDate ngayKham,
  String ghichu,
  String maMay,
  SmartDate ngayLap,
  String nguoiLap,
  SmartDate ngayHuy,
  String nguoiHuy,
  SmartDate ngaySD,
  String nguoiSD,
  SmartDate ngaySD1,
  String nguoiSD1,
  Boolean huy,
  SmartDate ngayBANgoaiT,
  string mabhxh,

  string tenbv,
  string madt,
                             SmartDate giatriTN, string mabaql, string tendt,
  SmartDate ngaydk, string MaDonVi
 , string ngayDu5Nam
 , string maquanheqd
 , string maquanham
 , string socmt
            , string tenqg
 , string tentinh
            , string tenqh, string tenPXa,
            string tennn)
        {
            _tenQG = tenqg;
            _MaQuanHam = maquanham;
            _tenTinh = tentinh;
            _tenQH = tenqh;
            _tenPXa = tenPXa;
            _tenNN = tennn;
            _TenDT = tendt;
            _OrderNumber = OrderNumber;
            _maBN = maBN;
            _MaDonVi = MaDonVi;
            _ngayDu5Nam = ngayDu5Nam;
            _MaQuanHeQD = maquanheqd;
            _SoCMT = socmt;
            _maBAQL = mabaql;
            _hoten = hoten;
            _sothe = sothe;
            _maBV = maBV;
            _giaTriDN = giaTriDN;
            _diaChi = diaChi;
            _diaChiC = diaChiC;
            _dienThoai = dienThoai;
            _RHD = RHD;
            _MaBAGD = MaBAGD;
            _mail = mail;
            _tuoi = tuoi;
            _ngaySinh = ngaySinh;
            _gt = gt;
            _baoTin = baoTin;
            _maQG = maQG;
            _maTinh = maTinh;
            _maHuyen = maHuyen;
            _maPXa = maPXa;
            _maNN = maNN;
            _tienSu = tienSu;
            _tienSuThuoc = tienSuThuoc;
            _tienSuGiaDinh = tienSuGiaDinh;
            _nhomMau = nhomMau;
            _maBANoiT = maBANoiT;
            _maKhoaVV = maKhoaVV;
            _ngayVV = ngayVV;
            _maBANgoaiT = maBANgoaiT;
            _ngayKham = ngayKham;
            _NgayDK = ngaydk;
            _ghichu = ghichu;
            _maMay = maMay;
            _ngayLap = ngayLap;
            _nguoiLap = nguoiLap;
            _ngayHuy = ngayHuy;
            _nguoiHuy = nguoiHuy;
            _ngaySD = ngaySD;
            _nguoiSD = nguoiSD;
            _ngaySD1 = ngaySD1;
            _nguoiSD1 = nguoiSD1;
            _huy = huy;
            _ngayBANgoaiT = ngayBANgoaiT;
            _mabhxh = mabhxh;
            _maDT = madt;
            _tenbv = tenbv;
            _giaTriTN = giatriTN;
        }

        #endregion

        #region Criteria

        [Serializable()]
        protected class Criteria
        {
            private String _maBN;
            public String MaBN
            {
                get
                {
                    return _maBN;
                }
            }
            private DateTime _ngaydk;
            public DateTime ngaydk
            {
                get
                {
                    return _ngaydk;
                }
            }
            private Byte _loai;
            public Byte loai
            {
                get
                {
                    return _loai;
                }
            }
            private Byte _loaikqcn;
            public Byte loaikqcn
            {
                get
                {
                    return _loaikqcn;
                }
            }
            public Criteria(String maBN, DateTime ngaydk, Byte loai)
            {
                _maBN = maBN;
                _ngaydk = ngaydk;
                _loai = loai;

            }

            public override bool Equals(object obj)
            {
                if (obj is Criteria)
                {
                    Criteria c = (Criteria)obj;
                    if (!_maBN.Equals(c._maBN))
                        return false;
                    return true;
                }
                return false;
            }

            public override int GetHashCode()
            {
                return string.Concat("Criteria", _maBN.ToString()).GetHashCode();
            }
        }
        protected class CriteriaTT
        {
            private String _maBN;
            public String MaBN
            {
                get
                {
                    return _maBN;
                }
            }
            private String _noiTT;
            public String noiTT
            {
                get
                {
                    return _noiTT;
                }
            }
            private DateTime _ngaydk;
            public DateTime ngaydk
            {
                get
                {
                    return _ngaydk;
                }
            }
            private Byte _loai;
            public Byte loai
            {
                get
                {
                    return _loai;
                }
            }
            private Byte _loaikqcn;
            public Byte loaikqcn
            {
                get
                {
                    return _loaikqcn;
                }
            }
            public CriteriaTT(String maBN, DateTime ngaydk, Byte loai, string noitt)
            {
                _maBN = maBN;
                _ngaydk = ngaydk;
                _loai = loai;
                _noiTT = noitt;
            }

            public override bool Equals(object obj)
            {
                if (obj is CriteriaTT)
                {
                    CriteriaTT c = (CriteriaTT)obj;
                    if (!_maBN.Equals(c._maBN))
                        return false;
                    return true;
                }
                return false;
            }

            public override int GetHashCode()
            {
                return string.Concat("CriteriaTT", _maBN.ToString()).GetHashCode();
            }
        }

        protected class CriteriaKB
        {
            private String _maBN;
            public String MaBN
            {
                get
                {
                    return _maBN;
                }
            }
            private String _makhoa;
            public String Makhoa
            {
                get
                {
                    return _makhoa;
                }
            }
            private String _masokham;
            public String masokham
            {
                get
                {
                    return _masokham;
                }
            }
            private DateTime _ngaydk;
            public DateTime ngaydk
            {
                get
                {
                    return _ngaydk;
                }
            }
            private Byte _loai;
            public Byte loai
            {
                get
                {
                    return _loai;
                }
            }
            private Byte _loaikqcn;
            public Byte loaikqcn
            {
                get
                {
                    return _loaikqcn;
                }
            }
            private Byte _loaikq;
            public Byte loaikq
            {
                get
                {
                    return _loaikq;
                }
            }
            private int _stt;
            public int stt
            {
                get
                {
                    return _stt;
                }
            }
            public CriteriaKB(String maBN, DateTime ngaydk, Byte loai, string masokham, int stt, byte loaikqcn, byte loaikq, string makhoa)
            {
                _maBN = maBN;
                _ngaydk = ngaydk;
                _loai = loai;
                _masokham = masokham;
                _stt = stt;
                _loaikqcn = loaikqcn;
                _loaikq = loaikq;
                _makhoa = makhoa;

            }

            public override bool Equals(object obj)
            {
                if (obj is CriteriaKB)
                {
                    CriteriaKB c = (CriteriaKB)obj;
                    if (!_maBN.Equals(c._maBN))
                        return false;
                    return true;
                }
                return false;
            }

            public override int GetHashCode()
            {
                return string.Concat("CriteriaKB", _maBN.ToString()).GetHashCode();
            }
        }


        protected class OtherCriteria
        {
            private String _maBN;
            public String maBN
            {
                get
                {
                    return _maBN;
                }
            }

            private String _maMay;
            public String MaMay
            {
                get
                {
                    return _maMay;
                }
            }

            private String _NguoiSD;
            public String NguoiSD
            {
                get
                {
                    return _NguoiSD;
                }
            }

            public OtherCriteria(String Mamay, String Nguoisd, String maBN, byte loai)
            {
                _maBN = maBN;
                _maMay = Mamay;
                _NguoiSD = Nguoisd;
            }
        }

        #endregion

        #region Authorization

        public static bool CanGetObject()
        {
            return true;
        }

        public static bool CanDeleteObject()
        {
            return true;
        }

        public static bool CanAddObject()
        {
            return true;
        }

        public static bool CanEditObject()
        {
            return true;
        }

        #endregion

        #region Data Access

        /// <summary>
        /// Retrieve an existing <see cref="ThongtinBN" /> Object based on data in the database.
        /// </summary>
        /// 

        protected void DataPortal_Fetch(Criteria crit)
        {
            // public abstract IDataReader GetThongtinBN(String _maBN);
            // public override IDataReader GetThongtinBN(String _maBN)
            // {
            //	   return ((IDataReader)SqlHelper.ExecuteReader(ConnectionString, DatabaseOwner + ObjectQualifier + "", _maBN));
            // }
            using (SafeDataReader dr = new SafeDataReader(DataProvider.Instance().GetThongtinBN(crit.MaBN)))
            {
                if (dr.Read())
                {
                    Fetch(dr);
                    //if (dr.NextResult())
                    //{
                    dr.Close();
                    //  dr = null;
                    if (!_NgayDK.IsEmpty)
                        _KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, _NgayDK.Date, "", crit.loai, crit.loaikqcn, 0, "");
                    else
                        _KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, crit.ngaydk, "", crit.loai, crit.loaikqcn, 0, "");
                    //  _KhamBenh = KhamBenh.GetKhamBenh(dr.GetString("masokham")   "", crit.loai, crit.loaikqcn);
                    if (_KhamBenh.MaSoKham == "")
                    {
                        _KhamBenh = KhamBenh.NewKhamBenh();
                        _KhamBenh.MaBV = _maBV;
                        _KhamBenh.MaDT = _maDT;
                        _KhamBenh.NgayDK = crit.ngaydk.ToString("dd/MM/yyyy");
                        _KhamBenh.mabhxh = _mabhxh;
                        _KhamBenh.Sothe = _sothe;
                        _KhamBenh.tenbv = _tenbv;
                        _KhamBenh.GiatriDN = _giaTriDN.ToString();
                        _KhamBenh.GiaTriTN = _giaTriTN.ToString();

                    }

                    //}
                    if (dr != null)
                    {
                        dr.Close();
                        //   dr = null;
                    }
                    MarkOld();
                    ValidationRules.CheckRules();
                    // dr.Close();
                    //DataProvider.Instance().CloseDB();
                }
            }
        }
        protected void DataPortal_Fetch(CriteriaTT crit)
        {
            // public abstract IDataReader GetThongtinBN(String _maBN);
            // public override IDataReader GetThongtinBN(String _maBN)
            // {
            //	   return ((IDataReader)SqlHelper.ExecuteReader(ConnectionString, DatabaseOwner + ObjectQualifier + "", _maBN));
            // }
            using (SafeDataReader dr = new SafeDataReader(DataProvider.Instance().GetThongtinBN(crit.MaBN)))
            {
                if (dr.Read())
                {
                    Fetch(dr);
                    //if (dr.NextResult())
                    //{
                    dr.Close();
                    //  dr = null;
                    if (!_NgayDK.IsEmpty)
                        _KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, _NgayDK.Date, crit.loai, crit.noiTT);
                    else
                        _KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, crit.ngaydk, crit.loai, crit.noiTT);
                    //  _KhamBenh = KhamBenh.GetKhamBenh(dr.GetString("masokham")   "", crit.loai, crit.loaikqcn);
                    if (_KhamBenh.MaSoKham == "")
                    {
                        _KhamBenh = KhamBenh.NewKhamBenh();
                        _KhamBenh.MaBV = _maBV;
                        _KhamBenh.MaDT = _maDT;
                        _KhamBenh.NgayDK = crit.ngaydk.ToString("dd/MM/yyyy");
                        _KhamBenh.mabhxh = _mabhxh;
                        _KhamBenh.Sothe = _sothe;
                        _KhamBenh.tenbv = _tenbv;
                        _KhamBenh.GiatriDN = _giaTriDN.ToString();
                        _KhamBenh.GiaTriTN = _giaTriTN.ToString();

                    }

                    //}
                    if (dr != null)
                    {
                        dr.Close();
                        //   dr = null;
                    }
                    MarkOld();
                    ValidationRules.CheckRules();
                    // dr.Close();
                    //DataProvider.Instance().CloseDB();
                }
            }
        }
        protected void DataPortal_Fetch(CriteriaKB crit)
        {
            // public abstract IDataReader GetThongtinBN(String _maBN);
            // public override IDataReader GetThongtinBN(String _maBN)
            // {
            //	   return ((IDataReader)SqlHelper.ExecuteReader(ConnectionString, DatabaseOwner + ObjectQualifier + "", _maBN));
            // }
            using (SafeDataReader dr = new SafeDataReader(DataProvider.Instance().GetThongtinBN(crit.MaBN)))
            {
                if (dr.Read())
                {
                    Fetch(dr);

                    dr.Close();
                    // dr = null;

                    //    if ((crit.loaikq == 1 || crit.loaikq == 2) && crit.loai == 4)
                    //    _KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, crit.ngaydk, crit.loaikqcn.ToString(), crit.loai, crit.loaikqcn, crit.loaikq, crit.Makhoa);
                    //else
                    //_KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, crit.ngaydk, crit.stt.ToString(), crit.loai, crit.loaikqcn, crit.loaikq,"");
                    if (!_NgayDK.IsEmpty)
                    {
                        //if ((crit.loaikq == 1 || crit.loaikq == 2) && crit.loai == 4)
                        //    _KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, _NgayDK.Date, crit.loaikqcn.ToString(), crit.loai, crit.loaikqcn, crit.loaikq, crit.Makhoa);
                        //else
                        //    _KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, _NgayDK.Date, "", crit.loai, crit.loaikqcn, 0, "");
                        if ((crit.loaikq == 1 || crit.loaikq == 2) && crit.loai == 4)
                            _KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, _NgayDK.Date, crit.loaikqcn.ToString(), crit.loai, crit.loaikqcn, crit.loaikq, crit.Makhoa);
                        else
                            _KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, _NgayDK.Date, crit.stt.ToString(), crit.loai, crit.loaikqcn, crit.loaikq, "");

                    }

                    else
                    {

                        if ((crit.loaikq == 1 || crit.loaikq == 2) && crit.loai == 4)
                            _KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, crit.ngaydk, crit.loaikqcn.ToString(), crit.loai, crit.loaikqcn, crit.loaikq, crit.Makhoa);
                        else
                            _KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, crit.ngaydk, crit.stt.ToString(), crit.loai, crit.loaikqcn, crit.loaikq, "");
                        //if ((crit.loaikq == 1 || crit.loaikq == 2) && crit.loai == 4)
                        //    _KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, crit.ngaydk, crit.loaikqcn.ToString(), crit.loai, crit.loaikqcn, crit.loaikq, crit.Makhoa);
                        //else
                        //   _KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, crit.ngaydk, "", crit.loai, crit.loaikqcn, 0, "");

                    }


                    //_KhamBenh = KhamBenh.FindKhamBenh(crit.MaBN, crit.ngaydk, "", crit.loai, crit.loaikqcn, 0, "");

                    if (_KhamBenh.MaSoKham == "")
                    {
                        _KhamBenh.MaBV = _maBV;
                        _KhamBenh.MaBN = _maBN;
                        _KhamBenh.MaDT = _maDT;
                        _KhamBenh.NgayDK = crit.ngaydk.ToString("dd/MM/yyyy");
                        _KhamBenh.mabhxh = _mabhxh;
                        _KhamBenh.Sothe = _sothe;
                        _KhamBenh.tenbv = _tenbv;
                        _KhamBenh.GiatriDN = _giaTriDN.ToString();
                        _KhamBenh.GiaTriTN = _giaTriTN.ToString();
                        _KhamBenh.NgayDK = DateTime.Now.ToLongDateString();
                    }
                    if (dr != null)
                    {
                        dr.Close();
                        //   dr = null;
                    }
                    MarkOld();
                    ValidationRules.CheckRules();
                    //DataProvider.Instance().CloseDB();
                    // dr.Close();
                }
            }
        }
        protected void DataPortal_Fetch(OtherCriteria crit)
        {
            // public abstract IDataReader GetThongtinBN(String _maBN);
            // public override IDataReader GetThongtinBN(String _maBN)
            // {
            //	   return ((IDataReader)SqlHelper.ExecuteReader(ConnectionString, DatabaseOwner + ObjectQualifier + "", _maBN));
            // }
            using (SafeDataReader dr = new SafeDataReader(DataProvider.Instance().GetThongtinBN(crit.maBN)))
            {
                if (dr.Read())
                {
                    Fetch(dr);
                    if (dr != null)
                    {
                        dr.Close();
                        //  dr = null;
                    }
                    _KhamBenh = null;
                    MarkOld();
                    ValidationRules.CheckRules();
                }
                // dr.Close();
                if (dr != null)
                {
                    dr.Close();
                    // dr = null;
                }
                //DataProvider.Instance().CloseDB();
            }
        }
        /// <summary>
        /// Load a <see cref="ThongtinBN" /> Object from given SafeDataReader.
        /// </summary>
        private void Fetch(SafeDataReader dr)
        {
            // Value properties
            if (dr.GetString("TenTinh") != null) _tenTinh = dr.GetString("TenTinh");
            if (dr.GetString("TenQH") != null) _tenQH = dr.GetString("TenQH");
            if (dr.GetString("TenPXa") != null) _tenPXa = dr.GetString("TenPXa");
            if (dr.GetString("TenQG") != null) _tenQG = dr.GetString("TenQG");
            if (dr.GetString("TenNN") != null) _tenNN = dr.GetString("TenNN");


            if (dr.GetString("MaBN") != null) _maBN = dr.GetString("MaBN");
            if (dr.GetString("Hoten") != null) _hoten = dr.GetString("Hoten");
            if (dr.GetString("Sothe") != null) _sothe = dr.GetString("Sothe");
            if (dr.GetString("TenDT") != null) _TenDT = dr.GetString("TenDT");
            if (dr.GetString("MaBV") != null) _maBV = dr.GetString("MaBV");
            if (dr.GetSmartDate("GiaTriDN", true) != null) _giaTriDN = dr.GetSmartDate("GiaTriDN", true);
            if (dr.GetString("DiaChi") != null) _diaChi = dr.GetString("DiaChi");
            if (dr.GetString("DiaChiC") != null) _diaChiC = dr.GetString("DiaChiC");
            if (dr.GetString("DienThoai") != null) _dienThoai = dr.GetString("DienThoai");
            if (dr.GetString("DTCQ") != null) _DTCQ = dr.GetString("DTCQ");
            if (dr.GetString("DTDD") != null) _DTDD = dr.GetString("DTDD");
            if (dr.GetString("RHD") != null) _RHD = dr.GetString("RHD");
            if (dr.GetString("MaBAGD") != null) _MaBAGD = dr.GetString("MaBAGD");
            if (dr.GetString("Mail") != null) _mail = dr.GetString("Mail");
            if (dr.GetByte("Tuoi") != null) _tuoi = dr.GetByte("Tuoi");
            if (dr.GetString("mabaql") != null) _maBAQL = dr.GetString("mabaql");
            if (dr.GetString("SoCMT") != null) _SoCMT = dr.GetString("SoCMT");
            if (dr.GetString("MaDonVi") != null) _MaDonVi = dr.GetString("MaDonVi");
            if (_MaDonVi.Length != 0 && _MaDonVi.Length >= 3)

                _MaNhomDV1 = _MaDonVi.Substring(0, 3);
            if (_MaDonVi.Length >= 6)

                _MaNhomDV2 = _MaDonVi.Substring(2, 3);

            //if (dr.GetString("ngayDu5Nam") != null) _ngayDu5Nam = dr.GetString("ngayDu5Nam");
            //if (dr.GetString("MaKV") != null) _maKV = dr.GetString("MaKV");
            //if (dr.GetString("ngayMienCCT") != null) _ngayMienCCT = dr.GetString("ngayMienCCT");

            if (dr.GetString("MaDonVi") != null) _MaDonVi = dr.GetString("MaDonVi");
            if (dr.GetString("MaQuanheqd") != null) _MaQuanHeQD = dr.GetString("MaQuanHeQD");
            if (dr.GetString("MaQuanham") != null) _MaQuanHam = dr.GetString("MaQuanham");

            if (dr.GetSmartDate("GiatritN", true) != null) _giaTriTN = dr.GetSmartDate("GiatritN", true);
            if (dr.GetSmartDate("NgaySinh", true) != null) _ngaySinh = dr.GetSmartDate("NgaySinh", true);
            if (dr.GetBoolean("GT") != null) _gt = dr.GetBoolean("GT");
            if (dr.GetString("BaoTin") != null) _baoTin = dr.GetString("BaoTin");
            if (dr.GetString("MaQG") != null) _maQG = dr.GetString("MaQG");
            if (dr.GetString("MaTinh") != null) _maTinh = dr.GetString("MaTinh");
            if (dr.GetString("MaHuyen") != null) _maHuyen = dr.GetString("MaHuyen");
            if (dr.GetString("MaPXa") != null) _maPXa = dr.GetString("MaPXa");
            if (dr.GetString("MaNN") != null) _maNN = dr.GetString("MaNN");
            if (dr.GetString("TienSu") != null) _tienSu = dr.GetString("TienSu");
            if (dr.GetString("TienSuThuoc") != null) _tienSuThuoc = dr.GetString("TienSuThuoc");
            if (dr.GetString("TienSuGiaDinh") != null) _tienSuGiaDinh = dr.GetString("TienSuGiaDinh");
            if (dr.GetString("NhomMau") != null) _nhomMau = dr.GetString("NhomMau");
            if (dr.GetString("MaBANoiT") != null) _maBANoiT = dr.GetString("MaBANoiT");
            if (dr.GetString("MaKhoaVV") != null) _maKhoaVV = dr.GetString("MaKhoaVV");
            if (dr.GetSmartDate("NgayVV", true) != null) _ngayVV = dr.GetSmartDate("NgayVV", true);
            if (dr.GetString("MaBANgoaiT") != null) _maBANgoaiT = dr.GetString("MaBANgoaiT");
            if (dr.GetSmartDate("NgayKham", true) != null) _ngayKham = dr.GetSmartDate("NgayKham", true);
            if (dr.GetSmartDate("NgayDK", true) != null) _NgayDK = dr.GetSmartDate("NgayDK", true);

            if (dr.GetString("NoiLamViec") != null) _noiLamViec = dr.GetString("NoiLamViec");


            if (dr.GetString("Ghichu") != null) _ghichu = dr.GetString("Ghichu");
            if (dr.GetString("MaMay") != null) _maMay = dr.GetString("MaMay");
            if (dr.GetSmartDate("NgayLap", true) != null) _ngayLap = dr.GetSmartDate("NgayLap", true);
            if (dr.GetString("NguoiLap") != null) _nguoiLap = dr.GetString("NguoiLap");
            if (dr.GetSmartDate("NgayHuy", true) != null) _ngayHuy = dr.GetSmartDate("NgayHuy", true);
            if (dr.GetString("NguoiHuy") != null) _nguoiHuy = dr.GetString("NguoiHuy");
            if (dr.GetSmartDate("NgaySD", true) != null) _ngaySD = dr.GetSmartDate("NgaySD", true);
            if (dr.GetString("NguoiSD") != null) _nguoiSD = dr.GetString("NguoiSD");
            if (dr.GetSmartDate("NgaySD1", true) != null) _ngaySD1 = dr.GetSmartDate("NgaySD1", true);
            if (dr.GetString("NguoiSD1") != null) _nguoiSD1 = dr.GetString("NguoiSD1");
            if (dr.GetBoolean("Huy") != null) _huy = dr.GetBoolean("Huy");
            if (dr.GetSmartDate("NgayBANgoaiT", true) != null) _ngayBANgoaiT = dr.GetSmartDate("NgayBANgoaiT", true);
            if (dr.GetString("mabhxh") != null) _mabhxh = dr.GetString("mabhxh");
            if (dr.GetString("madantoc") != null) _madantoc = dr.GetString("madantoc");
            if (dr.GetString("hotenbome") != null) _hotenbome = dr.GetString("hotenbome");
            if (dr.GetString("tenbv") != null) _tenbv = dr.GetString("tenbv");
            if (dr.GetString("MaDT") != null) _maDT = dr.GetString("MaDT");
        }

        /// <summary>
        /// Insert the new <see cref="ThongtinBN" /> Object to underlying database.
        /// </summary>
        /// 

        protected override void DataPortal_Create()
        {
            //MarkAsChild();
            ValidationRules.CheckRules();
            _maDT = "00001";
            _maQG = "00084";
            _ngayKham.Date = DateTime.Now;
            //MarkOld();
        }
        protected override void DataPortal_Insert()
        {
            // TODO: Kiem tra lai cac tham so truyen vao cho ham InsertThongtinBN
            // Copy & paste ham duoi day vao file DataProvider.cs
            if (_MaNhomDV2 != "" && _MaDonVi == "")
                _MaDonVi = _MaNhomDV2;
            if (_MaNhomDV1 != "" && _MaDonVi == "")
                _MaDonVi = _MaNhomDV1;
            if (HTC.ShareVariables.pub_spC == "PS")
            {
                _MaDonVi = _DTCQ;
                _ngayDu5Nam = DTDD;
            }
            if (HTC.ShareVariables.pub_spC == "YH")
                _maBN = DataProvider.Instance().InsertThongtinBN(_hoten, _sothe, _maBV, _giaTriDN, _diaChi, _dienThoai, _DTDD, _DTCQ, _mail, _tuoi, _ngaySinh, _gt, _baoTin, _maQG, _maTinh, _maHuyen, _maPXa, _maNN, _tienSu, _tienSuThuoc, _tienSuGiaDinh, _nhomMau, _ghichu, _maMay, _nguoiSD, _madantoc, _hotenbome, _giaTriTN, _maBAQL, _MaQuanHeQD, _MaQuanHam, _MaDonVi, _SoCMT, _noiLamViec);

            else
                _maBN = DataProvider.Instance().InsertThongtinBN(_hoten, _sothe, _maBV, _giaTriDN, _diaChi, _dienThoai, _RHD, _MaBAGD, _mail, _tuoi, _ngaySinh, _gt, _baoTin, _maQG, _maTinh, _maHuyen, _maPXa, _maNN, _tienSu, _tienSuThuoc, _tienSuGiaDinh, _nhomMau, _ghichu, _maMay, _nguoiSD, _madantoc, _hotenbome, _giaTriTN, _maBAQL, _MaQuanHeQD, _MaQuanHam, _MaDonVi, _SoCMT, _noiLamViec);
            MarkOld();// public abstract String InsertThongtinBN(String _hoten, String _sothe, String _maBV, SmartDate _giaTriDN, String _diaChi, String _dienThoai, String _RHD, String _MaBAGD, String _mail, Byte _tuoi, SmartDate _ngaySinh, Boolean _gt, String _baoTin, String _maQG, String _maTinh, String _maHuyen, String _maNN, String _tienSu, String _tienSuThuoc, String _tienSuGiaDinh, String _nhomMau, String _ghichu, String _maMay, String _nguoiLap);
                      // public override String InsertThongtinBN(String _hoten, String _sothe, String _maBV, SmartDate _giaTriDN, String _diaChi, String _dienThoai, String _RHD, String _MaBAGD, String _mail, Byte _tuoi, SmartDate _ngaySinh, Boolean _gt, String _baoTin, String _maQG, String _maTinh, String _maHuyen, String _maNN, String _tienSu, String _tienSuThuoc, String _tienSuGiaDinh, String _nhomMau, String _ghichu, String _maMay, String _nguoiLap);
                      // {
                      //		return CType(SqlHelper.ExecuteScalar(ConnectionString, DatabaseOwner + ObjectQualifier + "spTHONGTINBN_CREATE",_hoten, _sothe, _maBV, _giaTriDN.DBValue, _diaChi, _dienThoai, _RHD, _MaBAGD, _mail, _tuoi, _ngaySinh.DBValue, _gt, _baoTin, _maQG, _maTinh, _maHuyen, _maNN, _tienSu, _tienSuThuoc, _tienSuGiaDinh, _nhomMau, _ghichu,_maMay ,   _nguoiLap);
                      // }
                      //_KhamBenh.MaBN = _maBN; 
                      //  KhamBenh  tmp = _KhamBenh.Clone() ;
                      //  if (tmp.IsDirty)
                      //  {
                      //      tmp.ApplyEdit();
                      //      _KhamBenh = tmp.Save();
                      //  };

        }

        /// <summary>
        /// Update all changes made on <see cref="ThongtinBN" /> Object to underlying database.
        /// </summary>
        protected override void DataPortal_Update()
        {
            // TODO: Kiem tra lai cac tham so truyen vao cho ham UpdateThongtinBN
            if (IsDirty)
            {

                //if (base.IsDirty)
                //{
                if (_MaNhomDV2 != "" && _MaDonVi == "")
                    _MaDonVi = _MaNhomDV2;
                if (_MaNhomDV1 != "" && _MaDonVi == "")
                    _MaDonVi = _MaNhomDV1;
                if (HTC.ShareVariables.pub_spC == "PS")
                {
                    _MaDonVi = _DTCQ;
                    _ngayDu5Nam = DTDD;
                }
                if (HTC.ShareVariables.pub_spC == "YH")
                    DataProvider.Instance().UpdateThongtinBN(_maBN, _hoten, _sothe, _maBV, _giaTriDN, _diaChi, _dienThoai, _DTDD, _DTCQ, _mail, _tuoi, _ngaySinh, _gt, _baoTin, _maQG, _maTinh, _maHuyen, _maPXa, _maNN, _tienSu, _tienSuThuoc, _tienSuGiaDinh, _nhomMau, _ghichu, _maMay, _huy, _nguoiSD, _madantoc, _hotenbome, _giaTriTN, _maBAQL, _MaQuanHeQD, _MaQuanHam, _MaDonVi, _SoCMT, _noiLamViec);
                else
                    DataProvider.Instance().UpdateThongtinBN(_maBN, _hoten, _sothe, _maBV, _giaTriDN, _diaChi, _dienThoai, _RHD, _MaBAGD, _mail, _tuoi, _ngaySinh, _gt, _baoTin, _maQG, _maTinh, _maHuyen, _maPXa, _maNN, _tienSu, _tienSuThuoc, _tienSuGiaDinh, _nhomMau, _ghichu, _maMay, _huy, _nguoiSD, _madantoc, _hotenbome, _giaTriTN, _maBAQL, _MaQuanHeQD, _MaQuanHam, _MaDonVi, _SoCMT, _noiLamViec);

                // public abstract void UpdateThongtinBN(String _maBN, String _hoten, String _sothe, String _maBV, SmartDate _giaTriDN, String _diaChi, String _dienThoai, String _RHD, String _MaBAGD, String _mail, Byte _tuoi, SmartDate _ngaySinh, Boolean _gt, String _baoTin, String _maQG, String _maTinh, String _maHuyen, String _maNN, String _tienSu, String _tienSuThuoc, String _tienSuGiaDinh, String _nhomMau, String _ghichu, String _maMay, Boolean _huy, String _nguoiSD);
                // public override void UpdateThongtinBN(String _maBN, String _hoten, String _sothe, String _maBV, SmartDate _giaTriDN, String _diaChi, String _dienThoai, String _RHD, String _MaBAGD, String _mail, Byte _tuoi, SmartDate _ngaySinh, Boolean _gt, String _baoTin, String _maQG, String _maTinh, String _maHuyen, String _maNN, String _tienSu, String _tienSuThuoc, String _tienSuGiaDinh, String _nhomMau, String _ghichu, String _maMay, Boolean _huy, String _nguoiSD);
                // {
                //		SqlHelper.ExecuteNonQuery(ConnectionString, DatabaseOwner + ObjectQualifier + "spTHONGTINBN_UPDATE", _maBN, _hoten, _sothe, _maBV, _giaTriDN.DBValue, _diaChi, _dienThoai, _RHD, _MaBAGD, _mail, _tuoi, _ngaySinh.DBValue, _gt, _baoTin, _maQG, _maTinh, _maHuyen, _maNN, _tienSu, _tienSuThuoc, _tienSuGiaDinh, _nhomMau, _ghichu,_maMay ,   _huy, _nguoiSD );
                // }

                //  _KhamBenh.MaBN = _maBN;
                //}


            }
        }
        protected override void DataPortal_DeleteSelf()
        {
            DataPortal_Delete(new OtherCriteria(_maMay, _nguoiSD, _maBN, 0));
        }

        /// <summary>
        /// Delete the <see cref="ThongtinBN" />.
        /// </summary>
        protected void DataPortal_Delete(OtherCriteria crit)
        {
            // TODO: Kiem tra lai cac tham so truyen vao cho ham UpdateThongtinBN
            DataProvider.Instance().DeleteThongtinBN(crit.MaMay, crit.NguoiSD, crit.maBN);
            // public abstract void DeleteThongtinBN(String _maBN);
            // public override void DeleteThongtinBN(String _maBN);
            // {
            //		SqlHelper.ExecuteNonQuery(ConnectionString, DatabaseOwner + ObjectQualifier + "spTHONGTINBN_DELETED", _maBN);
            // }
        }

        #endregion
    }




    private void WriteLog(string log)
    {
        string logname = "LOG Tra Ra" + DateTime.Now.ToString("ddMMyyyy") + ".txt";
        string fileName = HttpContext.Current.Request.MapPath(logname);
        if (!File.Exists(fileName))
        {
            using (StreamWriter sw = File.CreateText(fileName))
            {
                sw.WriteLine(DateTime.Now.ToString() + " " + log);
                sw.Close();
            }
        }
        else
        {
            using (StreamWriter sw = File.AppendText(fileName))
            {
                sw.WriteLine(DateTime.Now.ToString() + " " + log);
                sw.Close();
            }
        }
    }



    private static string ConnectString
    {
        get
        {
            return ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
        }
    }


    public static List<DMlydovaovienM> GetDMlydovaovienM()
    {
        List<DMlydovaovienM> List = new List<DMlydovaovienM>();
        using (IDataReader dr = ((IDataReader)SqlHelper.ExecuteReader(ConnectString, "dbo.spDMLYDOVAOVIEN_GetAll")))
        {
            int i = 0;
            while (dr.Read())
            {
                i++;
                List.Add(new DMlydovaovienM(dr, i));
            }
        }
        return List;
    }


    public class DMlydovaovienM
    {
        private String _maVV = String.Empty;
        private String _lydoVV = String.Empty;
        private String _maMay = String.Empty;
        private Boolean _huy = false;
        private DateTime _ngaySD;
        private String _nguoiSD = String.Empty;
        private String _maBHXH = String.Empty;
        private int _OrderNumber;

        public String MaVV
        {
            get
            {
                return _maVV;
            }
            set
            {
                if (_maVV != value)
                {
                    _maVV = value;
                }
            }
        }
        public String LydoVV
        {
            get
            {
                return _lydoVV;
            }
            set
            {
                if (_lydoVV != value)
                {
                    _lydoVV = value;
                }
            }
        }
        public String MaMay
        {
            get
            {
                return _maMay;
            }
            set
            {
                if (_maMay != value)
                {
                    _maMay = value;
                }
            }
        }
        public Boolean Huy
        {
            get
            {
                return _huy;
            }
            set
            {
                if (_huy != value)
                {
                    _huy = value;
                }
            }
        }
        public string NgaySD
        {
            get
            {
                return _ngaySD.ToString("dd/MM/yyyy HH:mm");
            }
            set
            {
                DateTime d;

                if (DateTime.TryParseExact(value, "yyyy-MM-dd HH:mm:ss.fff", CultureInfo.InvariantCulture,
                           DateTimeStyles.None, out d))
                {
                    _ngaySD = d;
                }
            }
        }
        public String NguoiSD
        {
            get
            {
                return _nguoiSD;
            }
            set
            {
                if (_nguoiSD != value)
                {
                    _nguoiSD = value;
                }
            }
        }
        public String MaBHXH
        {
            get
            {
                return _maBHXH;
            }
            set
            {
                if (_maBHXH != value)
                {
                    _maBHXH = value;
                }
            }
        }
        public int OrderNumber
        {
            [System.Runtime.CompilerServices.MethodImpl(System.Runtime.CompilerServices.MethodImplOptions.NoInlining)]
            get
            {
                return _OrderNumber;
            }
            [System.Runtime.CompilerServices.MethodImpl(System.Runtime.CompilerServices.MethodImplOptions.NoInlining)]
            set
            {
                //CanWriteProperty(true);
                if (!_OrderNumber.Equals(value))
                {
                    _OrderNumber = value;
                    //PropertyHasChanged();
                }
            }
        }

        public DMlydovaovienM(IDataReader dr, int stt)
        {
            this.OrderNumber = stt;
            // Value properties
            if (dr["MaVV"].GetType().Name != "DBNull" && dr["MaVV"] != null)
            {
                this.MaVV = Convert.ToString(dr["MaVV"]);
            }
            else
            {
                this.MaVV = "";
            }
            if (dr["LydoVV"].GetType().Name != "DBNull" && dr["LydoVV"] != null)
            {
                this.LydoVV = Convert.ToString(dr["LydoVV"]);
            }
            else
            {
                this.LydoVV = "";
            }
            if (dr["MaBHXH"].GetType().Name != "DBNull" && dr["MaBHXH"] != null)
            {
                this.MaBHXH = Convert.ToString(dr["MaBHXH"]);
            }
            else
            {
                this.MaBHXH = "";
            }
            if (dr["MaMay"].GetType().Name != "DBNull" && dr["MaMay"] != null)
            {
                this.MaMay = Convert.ToString(dr["MaMay"]);
            }
            else
            {
                this.MaMay = "";
            }
            if (dr["Huy"].GetType().Name != "DBNull" && dr["Huy"] != null)
            {
                this.Huy = Convert.ToBoolean(dr["Huy"]);
            }
            else
            {
                this.Huy = false;
            }
            if (dr["NgaySD"].GetType().Name != "DBNull" && dr["NgaySD"] != null)
            {
                this.NgaySD = Convert.ToString(dr["NgaySD"]);
            }
            else
            {
                this.NgaySD = "";
            }
            if (dr["NguoiSD"].GetType().Name != "DBNull" && dr["NguoiSD"] != null)
            {
                this.NguoiSD = Convert.ToString(dr["NguoiSD"]);
            }
            else
            {
                this.NguoiSD = "";
            }
        }

    }


    public static List<DMdoituongkhambenhM> GetDMdoituongkhambenhM()
    {
        List<DMdoituongkhambenhM> List = new List<DMdoituongkhambenhM>();
        using (IDataReader dr = ((IDataReader)SqlHelper.ExecuteReader(ConnectString, "dbo.spDMDOITUONGKHAMBENH_GetAll")))
        {
            int i = 0;
            while (dr.Read())
            {
                i++;
                List.Add(new DMdoituongkhambenhM(dr, i));
            }
        }
        return List;
    }

    public class DMdoituongkhambenhM
    {
        private String _maKB = String.Empty;
        private String _tenBN = String.Empty;
        private String _maMay = String.Empty;
        private Boolean _huy = false;
        private DateTime _ngaySD;
        private String _nguoiSD = String.Empty;
        private String _maBHXH = String.Empty;
        private int _OrderNumber;

        public String MaKB
        {
            get
            {
                return _maKB;
            }
            set
            {
                if (_maKB != value)
                {
                    _maKB = value;
                }
            }
        }
        public String TenBN
        {
            get
            {
                return _tenBN;
            }
            set
            {
                if (_tenBN != value)
                {
                    _tenBN = value;
                }
            }
        }
        public String MaMay
        {
            get
            {
                return _maMay;
            }
            set
            {
                if (_maMay != value)
                {
                    _maMay = value;
                }
            }
        }
        public Boolean Huy
        {
            get
            {
                return _huy;
            }
            set
            {
                if (_huy != value)
                {
                    _huy = value;
                }
            }
        }
        public string NgaySD
        {
            get
            {
                return _ngaySD.ToString("dd/MM/yyyy HH:mm");
            }
            set
            {
                DateTime d;

                if (DateTime.TryParseExact(value, "yyyy-MM-dd HH:mm:ss.fff", CultureInfo.InvariantCulture,
                           DateTimeStyles.None, out d))
                {
                    _ngaySD = d;
                }
            }
        }
        public String NguoiSD
        {
            get
            {
                return _nguoiSD;
            }
            set
            {
                if (_nguoiSD != value)
                {
                    _nguoiSD = value;
                }
            }
        }
        public String MaBHXH
        {
            get
            {
                return _maBHXH;
            }
            set
            {
                if (_maBHXH != value)
                {
                    _maBHXH = value;
                }
            }
        }
        public int OrderNumber
        {
            [System.Runtime.CompilerServices.MethodImpl(System.Runtime.CompilerServices.MethodImplOptions.NoInlining)]
            get
            {
                return _OrderNumber;
            }
            [System.Runtime.CompilerServices.MethodImpl(System.Runtime.CompilerServices.MethodImplOptions.NoInlining)]
            set
            {
                //CanWriteProperty(true);
                if (!_OrderNumber.Equals(value))
                {
                    _OrderNumber = value;
                    //PropertyHasChanged();
                }
            }
        }

        public DMdoituongkhambenhM(IDataReader dr, int stt)
        {
            this.OrderNumber = stt;
            // Value properties
            if (dr["MaKB"].GetType().Name != "DBNull" && dr["MaKB"] != null)
            {
                this.MaKB = Convert.ToString(dr["MaKB"]);
            }
            else
            {
                this.MaKB = "";
            }
            if (dr["TenBN"].GetType().Name != "DBNull" && dr["TenBN"] != null)
            {
                this.TenBN = Convert.ToString(dr["TenBN"]);
            }
            else
            {
                this.TenBN = "";
            }
            if (dr["MaBHXH"].GetType().Name != "DBNull" && dr["MaBHXH"] != null)
            {
                this.MaBHXH = Convert.ToString(dr["MaBHXH"]);
            }
            else
            {
                this.MaBHXH = "";
            }
            if (dr["MaMay"].GetType().Name != "DBNull" && dr["MaMay"] != null)
            {
                this.MaMay = Convert.ToString(dr["MaMay"]);
            }
            else
            {
                this.MaMay = "";
            }
            if (dr["Huy"].GetType().Name != "DBNull" && dr["Huy"] != null)
            {
                this.Huy = Convert.ToBoolean(dr["Huy"]);
            }
            else
            {
                this.Huy = false;
            }
            if (dr["NgaySD"].GetType().Name != "DBNull" && dr["NgaySD"] != null)
            {
                this.NgaySD = Convert.ToString(dr["NgaySD"]);
            }
            else
            {
                this.NgaySD = "";
            }
            if (dr["NguoiSD"].GetType().Name != "DBNull" && dr["NguoiSD"] != null)
            {
                this.NguoiSD = Convert.ToString(dr["NguoiSD"]);
            }
            else
            {
                this.NguoiSD = "";
            }
        }
    }

    public DataTable spDMUpdateVV_KB(string mabn) //dòng3104 //11456
    {
        DataTable dr = new DataTable();
        string tenStore = "spDMUpdateVV_KB";
        string StrConection = ConfigurationManager.ConnectionStrings["SqlDataProvider"].ConnectionString + "; connection timeout=600; pooling=true; Max Pool Size=6000;Timeout=600;MultipleActiveResultSets=True";
        using (SqlConnection Conection = new SqlConnection(StrConection))
        {
            Conection.Open();
            using (SqlCommand Command = new SqlCommand(tenStore, Conection))
            {
                Command.CommandType = CommandType.StoredProcedure;
                Command.Parameters.Add(new SqlParameter("@mabn", mabn));
                SqlDataAdapter dp = new SqlDataAdapter(Command);
                dp.Fill(dr);
            }
            return dr;
        }
    }
}

public class LocalDateTime
{
}